<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Survivor - Trading Journal Profesional V2</title>
    <!-- VERSION: 2025-12-24-FIX-DEPLOYED -->
    
    <!-- Favicon SVG -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìä</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Incluir Dexie.js -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- Incluir CryptoJS para firmas HMAC -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Incluir Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Lightweight Charts ya incluido arriba -->
    
    <!-- Supabase usando ES Module CDN -->
    <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>
    
    <!-- TradingView Widget API -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- html2canvas y jsPDF para screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Script para detectar vista p√∫blica -->
    <script>
        // Detectar si es vista p√∫blica (tiene par√°metro ?audicion= con un ID v√°lido)
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const audicionParam = urlParams.get('audicion');
            
            // Solo es vista p√∫blica si tiene un ID que no sea vac√≠o
            const isPublicView = audicionParam && audicionParam.length > 5;
            
            // Variable global para saltar autenticaci√≥n
            window.IS_PUBLIC_AUDICION_VIEW = isPublicView || false;
            window.PUBLIC_AUDICION_ID = audicionParam || null;
            
            if (window.IS_PUBLIC_AUDICION_VIEW) {
                // Agregar clase para ocultar todo excepto la secci√≥n de Audici√≥n
                document.documentElement.classList.add('public-audicion-view');
                console.log('üìä Modo Vista P√∫blica de Audici√≥n activado - ID:', audicionParam);
            } else {
                console.log('üîì Modo normal - No es vista p√∫blica');
            }
        } catch (error) {
            console.error('Error al detectar vista p√∫blica:', error);
            window.IS_PUBLIC_AUDICION_VIEW = false;
            window.PUBLIC_AUDICION_ID = null;
        }
    </script>
    <style>
        /* ===== PALETA DE COLORES TRADER SURVIVOR ===== */
        :root {
            --primary: #39ff14;       /* Verde Fluorescente */
            --secondary: #28e000;     /* Verde Fluorescente m√°s oscuro para hover */
            --background: #000000;    /* Negro Puro */
            --surface: #050505;       /* Negro casi puro para tarjetas */
            --surface-light: #1a1a1a; /* Gris muy oscuro para bordes e inactivos */
            --text: #ffffff;          /* Blanco Puro */
            --text-secondary: #a0a0a0; /* Gris claro para texto secundario */
            --red: #ff4136;           /* Rojo brillante para p√©rdidas */
            --green: #39ff14;         /* Verde Fluorescente para ganancias */
            --yellow: #f59e0b;        /* Amarillo para m√©tricas neutrales */
            --success: #10b981;       /* Verde para m√©tricas positivas */
            --danger: #ef4444;        /* Rojo para m√©tricas negativas */
            --warning: #eab308;       /* Amarillo para m√©tricas de alerta */
            --accent: #3b82f6;        /* Azul para m√©tricas especiales */
            --border: #1a1a1a;        /* Color de bordes */
            --sidebar-width: 260px;   /* Ancho del sidebar expandido */
            --sidebar-collapsed: 70px; /* Ancho del sidebar colapsado */
        }

        /* ===== RESET Y BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text);
            overflow-x: hidden;
        }

        /* ===== SIDEBAR LATERAL ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        /* Logo Container */
        .sidebar-logo {
            padding: 1.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border);
            min-height: 70px;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
            filter: drop-shadow(0 0 12px rgba(57, 255, 20, 0.5));
            transition: transform 0.3s ease;
            flex-shrink: 0;
            min-width: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 20px rgba(57, 255, 20, 0.8));
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: relative;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0.5rem 0;
        }

        .sidebar-toggle:hover {
            background: rgba(57, 255, 20, 0.05);
            color: var(--primary);
        }

        .sidebar-toggle i {
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover i {
            color: var(--primary);
        }

        .sidebar.collapsed .sidebar-toggle span {
            display: none;
        }

        /* Navigation Menu */
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-nav::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-nav::-webkit-scrollbar-track {
            background: var(--surface);
        }

        .sidebar-nav::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .nav-section {
            padding: 0.5rem 0;
        }

        .nav-section-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            padding: 0.75rem 1.25rem 0.5rem;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            padding: 0;
        }

        .nav-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            margin: 0.125rem 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(57, 255, 20, 0.15) 0%, rgba(57, 255, 20, 0.05) 100%);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        .nav-item i {
            font-size: 1.1rem;
            min-width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-item-text {
            flex: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-item-text {
            opacity: 0;
            width: 0;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        /* Submenu para Informes */
        /* Sidebar Footer */
        .sidebar-footer {
            border-top: 1px solid var(--border);
            padding: 1rem;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
            white-space: nowrap;
        }

        .footer-item:hover {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary);
        }

        .footer-item i {
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .footer-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar.collapsed .footer-item span {
            display: none;
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--background);
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed);
            width: calc(100% - var(--sidebar-collapsed));
        }

        /* Top Bar */
        .top-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .top-bar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--surface-light);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid var(--primary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--background);
        }

        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== HEADER SUPERIOR ===== */
        .main-header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 64px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 1.5rem;
            z-index: 999;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed ~ .main-header {
            left: 70px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 200px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .user-dropdown a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .user-dropdown a:hover {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary);
        }

        .user-dropdown a i {
            margin-right: 0.5rem;
            width: 20px;
        }

        .user-dropdown .logout-link {
            border-top: 1px solid var(--border);
            color: var(--red);
        }

        .user-dropdown .logout-link:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Content Container */
        .content-container {
            margin-top: 64px;
            padding: 2rem;
            width: 100%;
            max-width: none;
        }

        /* ===== CONFIGURACIONES LAYOUT ===== */
        .config-layout {
            display: flex;
            gap: 0;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .config-sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .config-sidebar-title {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 2rem 1.5rem 1rem;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }

        .config-nav {
            padding: 1rem 0;
        }

        .config-nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .config-nav-item:hover {
            background: rgba(57, 255, 20, 0.05);
            color: var(--primary);
        }

        .config-nav-item.active {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .config-nav-item i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .config-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background);
        }

        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .config-section-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .config-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .config-card.border-danger {
            border-color: var(--danger);
        }

        .config-card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .config-card-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }

        .config-card-body {
            padding: 1.5rem;
        }

        .config-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(57, 255, 20, 0.1);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Toggle Switch */
        .feature-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .feature-toggle:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-light);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Buttons */
        .btn-primary, .btn-outline, .btn-danger, .btn-link {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--background);
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #cc0000;
        }

        .btn-link {
            background: transparent;
            color: var(--primary);
            padding: 0.25rem 0.5rem;
        }

        /* P&L Color Classes - Verde Fluorescente y Rojo */
        .text-positive {
            color: #00FF41 !important; /* Verde fluorescente */
        }

        .text-negative {
            color: #FF1744 !important; /* Rojo brillante */
        }

        .text-green {
            color: #00FF41 !important; /* Verde fluorescente */
        }

        .text-red {
            color: #FF1744 !important; /* Rojo brillante */
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        /* Badges */
        .badge-success {
            padding: 0.35rem 0.75rem;
            background: rgba(57, 255, 20, 0.15);
            color: var(--primary);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert i {
            font-size: 1.25rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .alert-success {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid rgba(57, 255, 20, 0.3);
            color: var(--primary);
        }

        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.3);
            color: #0d6efd;
        }

        .alert-danger {
            background: rgba(255, 65, 54, 0.1);
            border: 1px solid rgba(255, 65, 54, 0.3);
            color: var(--danger);
        }

        /* User Profile Display */
        .user-profile-display {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }

        .user-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--background);
            flex-shrink: 0;
        }

        .user-profile-info {
            flex: 1;
        }

        /* Plan Display */
        .plan-display {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.1) 0%, rgba(57, 255, 20, 0.05) 100%);
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .plan-icon {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--background);
        }

        .plan-info h4 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .plan-price span {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .plan-features {
            margin-top: 1.5rem;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0.75rem;
        }

        .feature-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
        }

        .feature-list i {
            color: var(--primary);
            font-size: 0.9rem;
        }

        .plan-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Billing History */
        .billing-history {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .billing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--background);
            border-radius: 0.5rem;
        }

        /* Mentor Card */
        .mentor-card {
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .mentor-profile {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .mentor-avatar {
            position: relative;
            flex-shrink: 0;
        }

        .mentor-avatar img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--primary);
        }

        .mentor-badge {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--background);
            border: 3px solid var(--surface);
        }

        .mentor-info h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .mentor-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .mentor-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .mentor-stat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
        }

        .mentor-stat i {
            color: var(--primary);
            width: 20px;
        }

        .mentor-description {
            margin-bottom: 2rem;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .service-item {
            padding: 1.5rem;
            background: var(--background);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.3s ease;
        }

        .service-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .service-item i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .service-item h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .service-item p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .mentorship-contact {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .contact-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .testimonials {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .testimonial-item {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .testimonial-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .testimonial-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--background);
        }

        .rating {
            display: flex;
            gap: 0.25rem;
            color: #ffc107;
            font-size: 0.875rem;
        }

        .testimonial-text {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Import/Export */
        .import-zone {
            margin-bottom: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(57, 255, 20, 0.03);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .csv-format-info {
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .code-block {
            display: block;
            background: rgba(57, 255, 20, 0.05);
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--primary);
            margin-top: 0.5rem;
            overflow-x: auto;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .export-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--background);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        /* ===== UTILIDADES Y COMPONENTES ===== */
        .card {
            background-color: var(--surface);
            border-radius: 0.5rem;
            border: 1px solid var(--surface-light);
            padding: 1.5rem;
        }

        /* Pesta√±as de navegaci√≥n */
        .nav-tabs {
            border-bottom: 1px solid var(--surface-light);
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            white-space: nowrap;
        }
        .nav-tab.active {
            color: var(--text);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        .nav-tab:hover:not(.active) {
            color: var(--text);
            border-bottom-color: var(--surface-light);
        }

        /* Contenedor de secci√≥n */
        .section-container {
            display: none;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        .section-container { display: none; }
        .section-container.active { display: block !important; }

        /* Tarjetas de m√©tricas */
        .metric-card {
            background-color: var(--surface);
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--surface-light);
            transition: all 0.2s ease-in-out;
        }
        .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.05);
        }

        /* Tarjetas de Cuentas */
        .account-card {
            background-color: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--surface-light);
            transition: all 0.2s ease-in-out;
        }
        .account-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.1);
            transform: translateY(-2px);
        }
        .account-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.15);
        }

        /* Calendario */
        .calendar-day {
            width: 100%; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 0.25rem; cursor: pointer; transition: all 0.2s ease; position: relative;
            background-color: var(--surface); border: 1px solid var(--surface-light);
            min-height: 70px; max-height: 90px;
        }
        .calendar-day.empty { background-color: transparent; border-color: var(--background); cursor: default; }
        .calendar-day.empty:hover { transform: none; }
        .calendar-day.profit { background-color: rgba(57, 255, 20, 0.05); border-color: var(--green); }
        .calendar-day.loss { background-color: rgba(255, 65, 54, 0.05); border-color: var(--red); }
        .calendar-day.border-primary { border-color: #39ff14 !important; border-width: 2px !important; box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .calendar-day:not(.empty):hover { transform: scale(1.05); z-index: 10; border-color: var(--primary); }
        .day-number { font-size: 1rem; font-weight: 600; }
        .day-profit.positive { color: var(--green); font-size: 0.75rem; }
        .day-profit.negative { color: var(--red); font-size: 0.75rem; }
        .day-trades { font-size: 0.65rem; color: var(--text-secondary); }

        /* Selecci√≥n manual de d√≠as y semanas */
        .calendar-day.selected {
            border: 2px solid var(--primary) !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .calendar-day.selected::after {
            content: '‚úì';
            position: absolute;
            top: 2px;
            right: 2px;
            color: var(--primary);
            font-size: 12px;
            font-weight: bold;
        }
        .week-summary.selected {
            border: 2px solid var(--primary) !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .calendar-selection-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        .selection-mode-btn {
            padding: 6px 12px;
            background: var(--surface);
            border: 1px solid var(--surface-light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 12px;
        }
        .selection-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .selection-mode-btn:hover:not(.active) {
            background: var(--surface-light);
        }

        /* Botones */
        button {
            background-color: var(--surface-light); color: var(--text); border: 1px solid var(--surface-light);
            border-radius: 0.25rem; padding: 0.6rem 1.2rem; cursor: pointer; transition: all 0.2s ease; font-weight: 500;
        }
        button:hover { background-color: var(--primary); border-color: var(--primary); color: var(--background); font-weight: bold; }
        button.primary { background-color: var(--primary); border-color: var(--primary); color: var(--background); font-weight: bold; }
        button.primary:hover { background-color: var(--secondary); border-color: var(--secondary); }
        button.secondary { background-color: var(--surface); border-color: var(--surface-light); color: var(--text); font-weight: 500; }
        button.secondary:hover { background-color: var(--surface-light); border-color: var(--primary); color: var(--primary); }
        button.warning { background-color: #f59e0b; border-color: #f59e0b; color: white; font-weight: 500; }
        button.warning:hover { background-color: #d97706; border-color: #d97706; }
        button.success { background-color: var(--green); border-color: var(--green); color: var(--background); font-weight: bold; }
        button.danger { background-color: var(--red); border-color: var(--red); }
        #operations-table td button, #accounts-container button, #finances-table-body td button {
            padding: 0.3rem 0.6rem; font-size: 0.875rem; background-color: transparent; border: none;
        }
        #operations-table td button:hover, #accounts-container button:hover, #finances-table-body td button:hover {
            opacity: 0.8; color: var(--primary);
        }

        /* Botones de filtro de Funded */
        .funded-filter-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background-color: var(--surface);
            border: 1px solid var(--surface-light);
            color: var(--text-secondary);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .funded-filter-btn:hover {
            background-color: var(--surface-light);
            color: var(--primary);
            border-color: var(--primary);
        }
        .funded-filter-btn.active {
            background-color: var(--primary);
            color: var(--background);
            border-color: var(--primary);
            font-weight: 600;
        }
        .funded-filter-btn i {
            opacity: 0.8;
        }
        .funded-filter-btn.active i {
            opacity: 1;
        }

        /* Pesta√±as de Finanzas */
        .finances-tab {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            background-color: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .finances-tab:hover {
            background-color: var(--surface-light);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .finances-tab.active {
            background-color: var(--primary);
            color: var(--background);
            border-color: var(--primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
        }
        .finances-tab.active i {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Funded Tabs */
        .funded-tab {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.75rem 1.5rem;
            margin-bottom: -1px;
        }
        .funded-tab:hover {
            color: var(--text);
            background: rgba(57, 255, 20, 0.05);
        }
        .funded-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .funded-view {
            display: none !important;
        }
        .funded-view.active {
            display: block !important;
        }

        /* Funded Calendar Styles */
        #funded-calendar-days {
            min-height: 500px;
        }
        .funded-calendar-day {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .funded-calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .funded-calendar-day.empty {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }
        .funded-calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }
        .funded-calendar-day.has-events {
            border: 2px solid var(--primary);
            background: rgba(57, 255, 20, 0.05);
        }
        .funded-day-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .funded-calendar-day.empty .funded-day-number {
            color: var(--text-secondary);
            opacity: 0.3;
        }
        .funded-day-amount {
            font-size: 1rem;
            font-weight: 600;
            margin-top: auto;
        }
        .funded-day-amount.positive {
            color: var(--green);
        }
        .funded-day-amount.negative {
            color: var(--red);
        }
        .funded-day-events {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .funded-week-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .funded-week-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.15);
        }
        .funded-week-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .funded-week-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .funded-week-amount.positive {
            color: var(--green);
        }
        .funded-week-amount.negative {
            color: var(--red);
        }
        .funded-week-total {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-success {
            background-color: rgba(57, 255, 20, 0.15);
            color: var(--green);
        }
        .badge-danger {
            background-color: rgba(255, 0, 0, 0.15);
            color: var(--red);
        }
        .badge-warning {
            background-color: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        .badge-primary {
            background-color: rgba(57, 255, 20, 0.15);
            color: var(--primary);
        }

        /* Formularios */
        input, select, textarea {
            background-color: var(--surface); color: var(--text); border: 1px solid var(--surface-light);
            border-radius: 0.25rem; padding: 0.6rem; width: 100%; transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        input[type="file"]::file-selector-button {
            background-color: var(--primary); color: var(--background); border: none; padding: 0.5rem 1rem;
            border-radius: 0.25rem; cursor: pointer; transition: background-color 0.3s ease; margin-right: 0.8rem; font-weight: bold;
        }
        input[type="file"]::file-selector-button:hover { background-color: var(--secondary); }

        /* Tablas */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th {
            text-align: left; padding: 0.8rem 1rem; background-color: transparent;
            font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem;
            letter-spacing: 0.05em; border-bottom: 1px solid var(--surface-light);
        }
        td {
            padding: 0.8rem 1rem; border-bottom: 1px solid var(--surface);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle;
        }
        tr:hover td { background-color: rgba(57, 255, 20, 0.03); }
        #operations-table tr.cursor-pointer:hover td { background-color: rgba(57, 255, 20, 0.08); }
        #best-trades tr.cursor-pointer:hover td, #worst-trades tr.cursor-pointer:hover td, #day-modal-table-body tr.cursor-pointer:hover td {
             background-color: rgba(57, 255, 20, 0.08);
        }
        /* Tablas clicables en Analytics */
        #analytics-monthly-performance tr, #analytics-daily-performance tr {
            cursor: pointer;
        }
        #analytics-monthly-performance tr:hover td, #analytics-daily-performance tr:hover td {
            background-color: rgba(57, 255, 20, 0.08);
        }

        /* --- NUEVO: Estilo para cabeceras de tabla ordenables --- */
        #operations-table-render th[data-sort] {
            cursor: pointer;
            position: relative;
        }
        #operations-table-render th[data-sort]:hover {
            color: var(--text);
        }
        #operations-table-render th[data-sort].sorted::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
        }
        #operations-table-render th[data-sort].sorted.asc::after {
            border-bottom-color: var(--primary);
            margin-top: -2px;
        }
        #operations-table-render th[data-sort].sorted.desc::after {
            border-top-color: var(--primary);
            margin-top: 2px;
        }

        /* --- Optimizaci√≥n de tabla de operaciones --- */
        #operations-table-render {
            font-size: 0.875rem; /* Reducir tama√±o de fuente ligeramente */
            table-layout: fixed; /* Layout fijo para mejor control de anchos */
            width: 100%;
        }
        #operations-table-render th,
        #operations-table-render td {
            padding: 0.5rem 0.25rem; /* Reducir padding para m√°s espacio */
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Anchos espec√≠ficos para cada columna */
        #operations-table-render th:nth-child(1) { width: 8%; } /* Fecha */
        #operations-table-render th:nth-child(2) { width: 6%; } /* Entrada */
        #operations-table-render th:nth-child(3) { width: 6%; } /* Salida */
        #operations-table-render th:nth-child(4) { width: 10%; } /* Cuenta */
        #operations-table-render th:nth-child(5) { width: 12%; } /* Instrumento */
        #operations-table-render th:nth-child(6) { width: 6%; } /* Tipo */
        #operations-table-render th:nth-child(7) { width: 8%; } /* Entrada */
        #operations-table-render th:nth-child(8) { width: 8%; } /* Salida */
        #operations-table-render th:nth-child(9) { width: 6%; } /* Volumen */
        #operations-table-render th:nth-child(10) { width: 7%; } /* Resultado */
        #operations-table-render th:nth-child(11) { width: 8%; } /* P&L */
        #operations-table-render th:nth-child(12) { width: 6%; } /* Fees */
        #operations-table-render th:nth-child(13) { width: 5%; } /* Divisa */
        #operations-table-render th:nth-child(14) { width: 6%; } /* Sesi√≥n */
        #operations-table-render th:nth-child(15) { width: 10%; } /* Acciones */

        /* --- ESTILOS PARA PLATAFORMAS --- */
        .platform-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .platform-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .platform-card .metric-card {
            border: 2px solid transparent;
            border-radius: 1rem;
            transition: border-color 0.2s ease;
        }
        .platform-card:hover .metric-card {
            border-color: var(--primary);
        }
        .platform-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .platform-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Platform Detail View */
        .platform-detail-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .platform-detail-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .platform-detail-back {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .platform-detail-back:hover {
            background: var(--surface-light);
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        .platform-detail-title h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .platform-detail-title p {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .platform-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .platform-logo img {
            width: 48px;
            height: 48px;
            object-fit: cover;
        }

        /* Platform Tabs */
        .platform-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .platform-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .platform-tab:hover {
            color: var(--text);
            background: rgba(57, 255, 20, 0.05);
        }

        .platform-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .platform-tab-content {
            display: none;
        }

        .platform-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Status Cards */
        .status-card {
            padding: 1.25rem;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-card-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-card-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-card-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-card-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .status-card-success .status-card-icon {
            color: var(--success);
        }

        .status-card-warning .status-card-icon {
            color: var(--warning);
        }

        .status-card-info .status-card-icon {
            color: #3b82f6;
        }

        /* Quick Sync Button */
        #bingx-quick-sync {
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        #bingx-quick-sync:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            transform: translateY(-1px);
        }
        #bingx-quick-sync:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        #bingx-quick-sync i {
            transition: transform 0.3s ease;
        }
        #bingx-quick-sync:hover i {
            transform: rotate(180deg);
        }

        /* MEXC Quick Sync Button Animation */
        #mexc-quick-sync {
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        #mexc-quick-sync:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            transform: translateY(-1px);
        }
        #mexc-quick-sync:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        #mexc-quick-sync i {
            transition: transform 0.3s ease;
        }
        #mexc-quick-sync:hover i {
            transform: rotate(180deg);
        }

        /* Currency Switch */
        /* Selector de moneda tipo dropdown */
        .currency-selector { padding: 0.5rem 1rem; background-color: var(--surface); border: 1px solid var(--surface-light); border-radius: 0.25rem; color: var(--text); font-size: 0.875rem; cursor: pointer; transition: all 0.2s; min-width: 80px; }
        .currency-selector:hover { border-color: var(--primary); }
        .currency-selector:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(57, 255, 20, 0.1); }

        /* Toolbar profesional con selectores y botones */
        .section-toolbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .toolbar-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .toolbar-right { display: flex; align-items: center; gap: 0.75rem; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: var(--surface); border: 1px solid var(--surface-light); border-radius: 0.375rem; }
        .action-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: var(--surface); border: 1px solid var(--surface-light); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .action-btn:hover { background-color: var(--surface-light); border-color: var(--primary); }
        .action-btn i { font-size: 0.875rem; }

        /* Panel Lateral de Filtros (estilo Tradervue) */
        .filters-sidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background-color: var(--surface); border-left: 1px solid var(--surface-light); z-index: 1001; transition: right 0.3s ease-out; overflow-y: auto; display: flex; flex-direction: column; }
        .filters-sidebar.active { right: 0; }
        .filters-sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--surface-light); display: flex; justify-content: space-between; align-items: center; }
        .filters-sidebar-header h3 { font-size: 1.25rem; font-weight: 600; color: var(--text); margin: 0; }
        .close-filters-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; transition: color 0.2s; }
        .close-filters-btn:hover { color: var(--primary); }
        
        .filters-sidebar-content { flex: 1; padding: 1.5rem; overflow-y: auto; }
        .filter-section { margin-bottom: 1.5rem; }
        .filter-section.expandable { border: 1px solid var(--surface-light); border-radius: 0.5rem; overflow: hidden; }
        .filter-section-header { padding: 1rem; background-color: var(--bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .filter-section-header:hover { background-color: var(--surface); }
        .filter-section-header i { transition: transform 0.3s; color: var(--text-secondary); }
        .filter-section.expanded .filter-section-header i { transform: rotate(180deg); }
        .filter-section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 1rem; }
        .filter-section.expanded .filter-section-content { max-height: 500px; padding: 1rem; }
        
        .filter-label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
        .filter-sublabel { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.4rem; }
        .filter-sublabel.mt-3 { margin-top: 1rem; }
        
        .filter-sidebar-input, .filter-sidebar-select { width: 100%; padding: 0.75rem; background-color: var(--bg); border: 1px solid var(--surface-light); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; transition: all 0.2s; }
        .filter-sidebar-input:focus, .filter-sidebar-select:focus { outline: none; border-color: var(--primary); background-color: var(--surface); }
        .filter-sidebar-input::placeholder { color: var(--text-secondary); }
        
        .filter-checkbox-group { display: flex; flex-direction: column; gap: 0.75rem; }
        .filter-checkbox { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; color: var(--text); }
        .filter-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        
        .filters-sidebar-footer { padding: 1.5rem; border-top: 1px solid var(--surface-light); display: flex; gap: 0.75rem; }
        .sidebar-apply-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.875rem; background-color: var(--primary); color: var(--bg); border: none; border-radius: 0.375rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; }
        .sidebar-apply-btn:hover { background-color: #2ecc11; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3); }
        .sidebar-clear-btn { padding: 0.875rem 1.25rem; background-color: transparent; color: var(--text); border: 1px solid var(--surface-light); border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .sidebar-clear-btn:hover { background-color: var(--surface-light); border-color: var(--primary); color: var(--primary); }
        
        .filters-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out; }
        .filters-overlay.active { opacity: 1; pointer-events: all; }

        /* Panel de Filtros Equity Graph */
        .filters-panel { background-color: var(--surface); border: 1px solid var(--surface-light); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .filters-section { margin-bottom: 1rem; }
        .filters-section:last-child { margin-bottom: 0; }
        .filters-section-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; display: flex; align-items: center; }
        .filter-item { display: flex; flex-direction: column; }
        .filter-label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.4rem; display: flex; align-items: center; }
        .filter-label i { font-size: 0.75rem; }
        .filter-select { width: 100%; padding: 0.6rem 0.75rem; background-color: var(--bg); border: 1px solid var(--surface-light); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; transition: all 0.2s; }
        .filter-select:focus { outline: none; border-color: var(--primary); background-color: var(--surface); }
        .filter-input { width: 100%; padding: 0.6rem 0.75rem; background-color: var(--bg); border: 1px solid var(--surface-light); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; transition: all 0.2s; }
        .filter-input:focus { outline: none; border-color: var(--primary); background-color: var(--surface); }

        /* Gr√°ficos */
        .chart-container { position: relative; height: 320px; margin-bottom: 1rem; }

        /* Loading Spinner */
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 10, 10, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 4px solid var(--surface-light); border-radius: 50%; border-top: 4px solid var(--primary); width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animaciones para notificaciones */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Rich Text Editor - Editor de Texto Enriquecido */
        .rich-text-editor {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .rte-toolbar {
            background-color: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
        }
        
        .rte-toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding: 0 0.5rem;
            border-right: 1px solid var(--border);
        }
        
        .rte-toolbar-group:last-child {
            border-right: none;
        }
        
        .rte-btn {
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            padding: 0.4rem 0.6rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        
        .rte-btn:hover {
            background-color: var(--surface);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .rte-btn.active {
            background-color: var(--primary);
            color: var(--bg);
            border-color: var(--primary);
        }
        
        .rte-btn i {
            font-size: 0.875rem;
        }
        
        .rte-select {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            padding: 0.4rem 0.6rem;
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 100px;
        }
        
        .rte-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .rte-content {
            padding: 1rem;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text);
            line-height: 1.6;
            font-size: 0.9375rem;
        }
        
        .rte-content:focus {
            outline: none;
        }
        
        .rte-content[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            opacity: 0.5;
        }
        
        .rte-footer {
            background-color: var(--bg);
            border-top: 1px solid var(--border);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .rte-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .rte-voice-btn {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .rte-voice-btn:hover {
            background-color: var(--surface-light);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .rte-voice-btn.recording {
            background-color: #ff4136;
            border-color: #ff4136;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .rte-download-btn {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: var(--bg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .rte-download-btn:hover {
            background-color: #2ecc11;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
        }
        
        .rte-char-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .rte-voice-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .rte-voice-wave {
            width: 4px;
            height: 16px;
            background-color: var(--primary);
            margin: 0 2px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .rte-voice-wave:nth-child(1) { animation-delay: 0s; }
        .rte-voice-wave:nth-child(2) { animation-delay: 0.1s; }
        .rte-voice-wave:nth-child(3) { animation-delay: 0.2s; }
        .rte-voice-wave:nth-child(4) { animation-delay: 0.3s; }
        
        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 20px; }
        }

        /* Daily Journal Styles */
        .daily-journal-day-card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .daily-journal-day-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.1);
        }
        
        .daily-journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .daily-journal-date {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .daily-journal-pl {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .daily-journal-pl.positive {
            color: var(--success);
        }
        
        .daily-journal-pl.negative {
            color: var(--danger);
        }
        
        .daily-journal-chart-container {
            height: 120px;
            margin: 1rem 0;
            position: relative;
        }
        
        .daily-journal-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .daily-journal-metric {
            text-align: center;
        }
        
        .daily-journal-metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .daily-journal-metric-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .daily-journal-note-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary);
            color: var(--bg);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .daily-journal-note-btn:hover {
            background-color: #2ecc11;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
        }
        
        .daily-journal-note-btn.has-note {
            background-color: var(--surface-light);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        /* Mini Calendar para Daily Journal */
        .daily-journal-mini-calendar {
            user-select: none;
        }
        
        .daily-journal-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .daily-journal-calendar-month {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }
        
        .daily-journal-calendar-nav {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            transition: color 0.2s;
        }
        
        .daily-journal-calendar-nav:hover {
            color: var(--primary);
        }
        
        .daily-journal-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }
        
        .daily-journal-calendar-day-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.25rem;
            text-transform: uppercase;
        }
        
        .daily-journal-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .daily-journal-calendar-day:hover {
            background-color: var(--surface-light);
        }
        
        .daily-journal-calendar-day.empty {
            cursor: default;
            color: var(--text-secondary);
            opacity: 0.3;
        }
        
        .daily-journal-calendar-day.today {
            border: 2px solid var(--primary);
            font-weight: 700;
        }
        
        .daily-journal-calendar-day.has-data {
            font-weight: 600;
        }
        
        .daily-journal-calendar-day.has-data.positive {
            background-color: rgba(57, 255, 20, 0.2);
            color: var(--success);
        }
        
        .daily-journal-calendar-day.has-data.negative {
            background-color: rgba(255, 65, 54, 0.2);
            color: var(--danger);
        }
        
        .daily-journal-calendar-day.selected {
            background-color: var(--primary);
            color: var(--bg);
        }

        /* --- Yearly Calendar View --- */
        #yearly-calendar-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .mini-calendar {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .mini-calendar-header {
            text-align: center;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mini-calendar-open-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-calendar-open-btn:hover {
            background-color: var(--primary);
            color: var(--bg);
        }
        .mini-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
        }
        .mini-calendar-weekday {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .mini-calendar-day {
            font-size: 0.8rem;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            position: relative;
        }
        .mini-calendar-day.operated {
            cursor: pointer;
            font-weight: bold;
        }
        .mini-calendar-day.profit {
            background-color: rgba(57, 255, 20, 0.2);
            color: var(--text);
        }
        .mini-calendar-day.profit:hover {
            background-color: rgba(57, 255, 20, 0.4);
        }
        .mini-calendar-day.loss {
            background-color: rgba(255, 65, 54, 0.2);
            color: var(--text);
        }
        .mini-calendar-day.loss:hover {
            background-color: rgba(255, 65, 54, 0.4);
        }

        /* Modals */
        .image-modal { 
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.98); 
            align-items: center; 
            justify-content: center; 
        }
        
        .image-modal-content { 
            max-width: 95vw; 
            max-height: 95vh; 
            border-radius: 8px; 
            object-fit: contain;
            cursor: zoom-in;
        }
        
        .image-modal-content.fullscreen {
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
            cursor: zoom-out;
        }
        
        .image-modal-close { 
            position: absolute; 
            top: 20px; 
            right: 40px; 
            color: #fff; 
            font-size: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            z-index: 1002;
            transition: all 0.3s;
            background: rgba(0,0,0,0.5);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .image-modal-close:hover {
            background: rgba(255,0,0,0.7);
            transform: rotate(90deg);
        }
        
        .image-modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-size: 60px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1002;
            padding: 20px 25px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            transition: all 0.3s;
            user-select: none;
        }
        
        .image-modal-nav:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        #image-modal-prev {
            left: 30px;
        }
        
        #image-modal-next {
            right: 30px;
        }
        
        .image-modal-counter {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 18px;
            background: rgba(0,0,0,0.7);
            padding: 10px 25px;
            border-radius: 25px;
            z-index: 1002;
        }
        
        .image-modal-fullscreen-btn {
            position: absolute;
            top: 20px;
            left: 40px;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            z-index: 1002;
            background: rgba(0,0,0,0.5);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .image-modal-fullscreen-btn:hover {
            background: rgba(0,150,255,0.7);
            transform: scale(1.1);
        }

        #day-detail-modal { background-color: rgba(0,0,0,0.8); }
        #day-detail-modal > div { background-color: var(--surface); border: 1px solid var(--surface-light); }

        /* New Calendar Modal Styles */
        .calendar-day-cell {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .calendar-day-cell:hover {
            background-color: var(--surface-light);
        }
        .calendar-day-cell.today {
            border-color: var(--primary);
        }
        .calendar-day-cell.selected {
            background-color: var(--primary);
            color: var(--background);
            font-weight: bold;
        }
        .calendar-day-cell.in-range {
            background-color: rgba(57, 255, 20, 0.15);
            border-radius: 0;
        }
        .calendar-day-cell.range-start {
            background-color: var(--primary);
            color: var(--background);
            border-top-left-radius: 50%;
            border-bottom-left-radius: 50%;
        }
        .calendar-day-cell.range-end {
            background-color: var(--primary);
            color: var(--background);
            border-top-right-radius: 50%;
            border-bottom-right-radius: 50%;
        }
        .calendar-day-cell.disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .date-range-preset.active {
            background-color: var(--primary);
            color: var(--background);
            font-weight: bold;
        }

        /* --- NUEVO: Estilo para el modal de detalles de Analytics --- */
        #analytics-detail-modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 1002;
            padding: 2rem;
            overflow-y: auto;
        }
        .analytics-detail-container {
            background-color: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 0.5rem;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }


        /* --- AUTHENTICATION MODAL STYLES --- */
        .auth-overlay {
            display: flex; /* CAMBIADO: siempre flex, se oculta con clase */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .auth-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .auth-modal {
            background-color: var(--surface);
            border: 1px solid var(--surface-light);
            border-radius: 0.75rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .auth-overlay.active .auth-modal {
            transform: scale(1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--surface-light);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-tab:hover:not(.active) {
            color: var(--text);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(57, 255, 20, 0.1);
        }

        .auth-input::placeholder {
            color: var(--text-secondary);
        }

        .auth-button {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--primary);
            color: var(--background);
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .auth-button:hover {
            background-color: var(--secondary);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-error {
            background-color: rgba(255, 65, 54, 0.1);
            border: 1px solid var(--red);
            color: var(--red);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .auth-success {
            background-color: rgba(57, 255, 20, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text);
            font-size: 0.875rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .logout-button {
            padding: 0.5rem 1rem;
            background-color: var(--surface);
            border: 1px solid var(--surface-light);
            color: var(--text);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .logout-button:hover {
            background-color: var(--surface-light);
            border-color: var(--primary);
        }

        .app-hidden {
            display: none !important;
        }

        /* --- STREAMER MODE STYLES (Scoped to accounts) --- */
        #accounts.streamer-mode-active .hide-amount,
        #finances.streamer-mode-active .hide-amount {
            filter: blur(6px);
            transition: filter 0.3s ease;
        }
        .hide-amount {
            transition: filter 0.3s ease;
        }

        /* Ocultar cartel molesto de sincronizaci√≥n de BingX */
        #bingx-connection-status {
            display: none !important;
        }
        /* --- END: AUTHENTICATION STYLES --- */

        /* --- AUDICION PUBLICA STYLES --- */
        .public-link-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .public-link-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .public-link-input {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .copy-link-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: var(--bg);
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .copy-link-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        .audicion-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .audicion-option-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .audicion-option-card label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
        }

        .audicion-option-card input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .public-view-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: var(--bg);
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Vista p√∫blica - Ocultar controles de edici√≥n */
        .public-audicion-view .edit-trade-btn,
        .public-audicion-view .delete-trade-btn,
        .public-audicion-view .add-operation-btn,
        .public-audicion-view .sidebar,
        .public-audicion-view .top-bar,
        .public-audicion-view #auth-modal,
        .public-audicion-view [data-target]:not([data-target="audicion"]) {
            display: none !important;
        }

        .public-audicion-view .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }

        .public-audicion-view #audicion-section {
            display: block !important;
        }
        
        .public-audicion-view #audicion {
            display: block !important;
        }

        /* Modal para generar enlace p√∫blico */
        .public-link-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .public-link-modal.active {
            display: flex;
        }

        .public-link-modal-content {
            background: var(--surface);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .public-link-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .public-link-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal-btn:hover {
            color: var(--primary);
        }

        /* --- END: AUDICION PUBLICA STYLES --- */

        /* --- OPERATIONS METRICS STYLES --- */
        .circular-chart {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        .circular-chart .circle {
            transition: stroke-dasharray 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: center;
        }

        .circular-chart .percentage {
            font-weight: bold;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Metric card icon/badge styling */
        .metric-card .metric-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 16px;
        }

        .metric-card .metric-legend {
            font-size: 12px;
            color: var(--text-secondary);
        }
        /* --- END: OPERATIONS METRICS STYLES --- */

        /* --- OPERATION DETAIL TABS STYLES --- */
        .notes-tab-btn, .images-tab-btn {
            transition: all 0.2s ease;
        }
        
        .notes-tab-btn.active, .images-tab-btn.active {
            background-color: var(--primary);
            color: #000;
        }
        
        .notes-tab-content {
            display: block;
        }
        
        .notes-tab-content.hidden, .images-tab-content.hidden {
            display: none;
        }
        
        .images-tab-content.active, .notes-tab-content.active {
            display: block;
        }
        
        #drop-zone {
            transition: all 0.2s ease;
        }
        
        #drop-zone:hover {
            border-color: var(--primary);
            background-color: rgba(16, 185, 129, 0.05);
        }
        
        #drop-zone.drag-over {
            border-color: var(--primary);
            background-color: rgba(16, 185, 129, 0.1);
        }
        /* --- END: OPERATION DETAIL TABS STYLES --- */

        .informe-sub-section-container {
            display: none;
        }
        .informe-sub-section-container.active {
            display: block;
        }

        /* TradingView Chart Styles */
        #tradingview-chart-container {
            background: #1e1e1e;
            border: 1px solid #333;
        }

        #tradingview-widget-detail {
            background: #1e1e1e;
        }

        #tradingview-loading-detail {
            background: rgba(30, 30, 30, 0.9);
        }

        .trade-marker {
            position: absolute;
            z-index: 1000;
            font-size: 18px;
            pointer-events: none;
        }

        .entry-marker {
            color: #00ff88;
        }

        .exit-marker {
            color: #ff4444;
        }

        /* Toast Notifications Animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast-notification {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 8px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        /* Rating Stars */
        #setup-rating-selector .star {
            cursor: pointer;
            font-size: 2rem;
            transition: all 0.2s ease;
            opacity: 0.3;
            display: inline-block;
        }

        #setup-rating-selector .star:hover {
            opacity: 1;
        }

        /* Chartbook & Playbook specific */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ===== EDITOR DE NOTAS AVANZADAS ===== */
        #funded-day-notes-editor,
        #finance-notes-editor {
            min-height: 400px;
            line-height: 1.6;
        }

        #funded-day-notes-editor:empty:before,
        #finance-notes-editor:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            font-style: italic;
        }

        #funded-day-notes-editor:focus,
        #finance-notes-editor:focus {
            outline: none;
        }

        /* Estilos para el contenido del editor */
        #funded-day-notes-editor h1,
        #finance-notes-editor h1 {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        #funded-day-notes-editor h2,
        #finance-notes-editor h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.875rem 0;
        }

        #funded-day-notes-editor h3,
        #finance-notes-editor h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }

        #funded-day-notes-editor p,
        #finance-notes-editor p {
            margin: 0.5rem 0;
        }

        #funded-day-notes-editor ul,
        #funded-day-notes-editor ol,
        #finance-notes-editor ul,
        #finance-notes-editor ol {
            margin: 0.5rem 0;
            padding-left: 2rem;
        }

        #funded-day-notes-editor a,
        #finance-notes-editor a {
            color: var(--primary);
            text-decoration: underline;
        }

        #funded-day-notes-editor a:hover,
        #finance-notes-editor a:hover {
            color: var(--secondary);
        }

        /* Vista de solo lectura de notas */
        #notes-display {
            line-height: 1.6;
        }

        #notes-display h1 {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        #notes-display h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.875rem 0;
        }

        #notes-display h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }

        #notes-display p {
            margin: 0.5rem 0;
        }

        #notes-display ul,
        #notes-display ol {
            margin: 0.5rem 0;
            padding-left: 2rem;
        }

        #notes-display a {
            color: var(--primary);
            text-decoration: underline;
        }

        #notes-display a:hover {
            color: var(--secondary);
        }

        /* Scrollbar personalizado para el editor */
        #funded-day-notes-editor::-webkit-scrollbar {
            width: 8px;
        }

        #funded-day-notes-editor::-webkit-scrollbar-track {
            background: var(--surface);
        }

        #funded-day-notes-editor::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        #funded-day-notes-editor::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* ===== ESTILOS PARA VISTA P√öBLICA DE AUDICI√ìN ===== */
        .public-audicion-view .sidebar,
        .public-audicion-view aside {
            display: none !important;
        }
        
        .public-audicion-view .top-bar,
        .public-audicion-view #main-header {
            display: none !important;
        }
        
        .public-audicion-view .section-container:not(#audicion) {
            display: none !important;
        }
        
        .public-audicion-view #audicion {
            display: block !important;
        }
        
        .public-audicion-view .main-content {
            margin-left: 0 !important;
            width: 100% !important;
            padding-top: 0 !important;
        }
        
        /* Header p√∫blico de audici√≥n */
        .public-audicion-header {
            display: none;
            background: var(--background);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .public-audicion-view .public-audicion-header {
            display: flex !important;
            align-items: center;
            gap: 0.75rem;
        }
        
        .public-audicion-header .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--background);
            font-size: 1.25rem;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
        }
        
        .public-audicion-header .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.02em;
        }
        
        /* Ocultar bot√≥n compartir en vista p√∫blica */
        .public-audicion-view #audicion-public-link-section,
        .public-audicion-view #share-audicion-btn,
        .public-audicion-view #copy-audicion-link {
            display: none !important;
        }
        
        /* Ocultar filtros y selectores en vista p√∫blica */
        .public-audicion-view #audicion-filter-dates-btn,
        .public-audicion-view #audicion-filter-dates-btn-header,
        .public-audicion-view #audicion-account-select {
            display: none !important;
        }
        
        /* Header p√∫blico con logo y bot√≥n de registro */
        #public-header {
            display: none;
            background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .public-audicion-view #public-header {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
        }

        #public-header .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #public-header .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
        }

        #public-header .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.5px;
        }

        #public-header .register-btn {
            background: var(--primary);
            color: var(--background);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
        }

        #public-header .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(57, 255, 20, 0.4);
            background: var(--secondary);
        }
        
        /* Ocultar modal de autenticaci√≥n en vista p√∫blica */
        .public-audicion-view #auth-modal {
            display: none !important;
        }
        
        /* Header p√∫blico */
        #public-header {
            display: none;
            background: linear-gradient(135deg, #0a0a0a 0%, #000000 100%);
            border-bottom: 2px solid var(--primary);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(57, 255, 20, 0.1);
        }
        
        .public-audicion-view #public-header {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
        }
        
        #public-header .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        #public-header .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #39ff14 0%, #00ff88 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3);
        }
        
        #public-header .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #39ff14 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #public-header .register-btn {
            background: linear-gradient(135deg, #39ff14 0%, #00ff88 100%);
            color: #000;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3);
            border: none;
            cursor: pointer;
        }
        
        #public-header .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(57, 255, 20, 0.4);
        }

        /* ===== SWITCH / TOGGLE STYLES ===== */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* ===== SOCIAL MEDIA STYLES ===== */
        #social-media-leaderboard tbody tr:hover {
            background-color: var(--surface-light);
            cursor: pointer;
        }

        .trader-rank {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .trader-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .trader-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .trader-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .trader-details {
            display: flex;
            flex-direction: column;
        }

        .trader-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .trader-location {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .trader-stars {
            color: #fbbf24;
            font-size: 0.875rem;
        }

        .metric-positive {
            color: #10b981;
            font-weight: 600;
        }

        .metric-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
```
</head>
<body>
    <!-- ===== HEADER P√öBLICO (solo visible en vista p√∫blica) ===== -->
    <header id="public-header">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="logos/trader-survivor-logo.svg" alt="Trader Survivor" style="width: 40px; height: 40px; border-radius: 8px;">
            </div>
            <span class="logo-text">Trader Survivor</span>
        </div>
        <a href="#" class="register-btn" onclick="event.preventDefault(); window.location.href = window.location.origin + window.location.pathname;">
            <i class="fas fa-user-plus mr-2"></i>Crear mi cuenta gratis
        </a>
    </header>
    
    <!-- ===== HEADER SUPERIOR ===== -->
    <header class="main-header">
        <div class="header-right">
            <!-- Selector de Cuenta Principal -->
            <div class="flex items-center gap-3">
                <div id="main-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                    <img id="main-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                </div>
                <select id="main-account-select" class="w-48">
                    <option value="">Seleccionar cuenta</option>
                </select>
            </div>
            
            <!-- Usuario Menu -->
            <div style="position: relative; margin-left: 1rem;">
                <button id="user-menu-toggle" class="user-menu-toggle">
                    <div id="header-user-avatar" class="user-avatar">D</div>
                    <span id="header-user-email" style="font-size: 0.875rem; color: var(--text-secondary);"></span>
                    <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: var(--text-secondary);"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown-menu" class="user-dropdown" style="display: none;">
                    <a href="#" id="header-config-btn">
                        <i class="fas fa-cog"></i>Configuraci√≥n
                    </a>
                    <a href="#" id="header-logout-btn" class="logout-link">
                        <i class="fas fa-sign-out-alt"></i>Cerrar Sesi√≥n
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- ===== SIDEBAR LATERAL ===== -->
    <aside class="sidebar" id="sidebar">
        <!-- Logo -->
        <div class="sidebar-logo">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <span class="logo-text">Trader Survivor</span>
        </div>

        <!-- Toggle Button -->
        <div class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
            <span>Contraer</span>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- Main Sections -->
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <div class="nav-item active" data-target="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Dashboard</span>
                </div>
                <div class="nav-item" data-target="analytics">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-item-text">Analytics</span>
                </div>
                <div class="nav-item" data-target="informe">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-item-text">Informe</span>
                </div>
                <div class="nav-item" data-target="daily-journal">
                    <i class="fas fa-book"></i>
                    <span class="nav-item-text">Daily Journal</span>
                </div>
                <div class="nav-item" data-target="calendar">
                    <i class="fas fa-calendar"></i>
                    <span class="nav-item-text">Calendario</span>
                </div>
                <div class="nav-item" data-target="equity-graph">
                    <i class="fas fa-chart-area"></i>
                    <span class="nav-item-text">Equity Graph</span>
                </div>
            </div>

            <!-- Trading Section -->
            <div class="nav-section">
                <div class="nav-section-title">Trading</div>
                <div class="nav-item" data-target="operations">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="nav-item-text">Operaciones</span>
                </div>
                <div class="nav-item" data-target="chartbook">
                    <i class="fas fa-chart-area"></i>
                    <span class="nav-item-text">Chartbook</span>
                </div>
                <div class="nav-item" data-target="playbook">
                    <i class="fas fa-book-open"></i>
                    <span class="nav-item-text">Playbook</span>
                </div>
            </div>

            <!-- Funded Section -->
            <div class="nav-section">
                <div class="nav-section-title">Funded</div>
                <div class="nav-item" data-target="funded">
                    <i class="fas fa-trophy"></i>
                    <span class="nav-item-text">Funded</span>
                </div>
                <div class="nav-item" data-target="finances">
                    <i class="fas fa-dollar-sign"></i>
                    <span class="nav-item-text">Finanzas</span>
                </div>
            </div>

            <!-- Audici√≥n Section -->
            <div class="nav-section">
                <div class="nav-section-title">Audici√≥n</div>
                <div class="nav-item" data-target="audicion">
                    <i class="fas fa-star"></i>
                    <span class="nav-item-text">Audici√≥n</span>
                </div>
                <div class="nav-item" data-target="social-media">
                    <i class="fas fa-users"></i>
                    <span class="nav-item-text">Social Media</span>
                </div>
            </div>

            <!-- Cuentas Section -->
            <div class="nav-section">
                <div class="nav-section-title">Cuentas</div>
                <div class="nav-item" data-target="accounts">
                    <i class="fas fa-university"></i>
                    <span class="nav-item-text">Cuentas</span>
                </div>
                <div class="nav-item" data-target="platforms">
                    <i class="fas fa-plug"></i>
                    <span class="nav-item-text">Plataformas</span>
                </div>
            </div>

            <!-- Tools Section -->
            <div class="nav-section">
                <div class="nav-section-title">Herramientas</div>
                <div class="nav-item" data-target="news">
                    <i class="fas fa-newspaper"></i>
                    <span class="nav-item-text">Noticias</span>
                </div>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="footer-item" data-target="config">
                <i class="fas fa-cog"></i>
                <span>Configuraci√≥n</span>
            </div>
            <div class="footer-item" id="darkModeToggle">
                <i class="fas fa-moon"></i>
                <span>Modo Oscuro</span>
            </div>
            <div class="footer-item" id="supportBtn">
                <i class="fas fa-life-ring"></i>
                <span>Soporte</span>
            </div>
        </div>
    </aside>

    <!-- Header P√∫blico de Audici√≥n -->
    <div class="public-audicion-header">
        <div class="logo-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <span class="logo-text">Trader Survivor</span>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="main-content">

        <!-- Authentication Modal (FUERA de mainApp) -->
        <div id="authModal" class="auth-overlay">
            <div class="auth-modal">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center justify-center">
                        <span class="logo-container mr-3">
                            <i class="fas fa-shield-alt logo-shield"></i>
                        </span>
                        Trader Survivor
                    </h2>
                    <p class="text-text-secondary mt-2">Accede a tu trading journal profesional</p>
                </div>

                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Iniciar Sesi√≥n
                    </div>
                    <div class="auth-tab" data-tab="register">
                        <i class="fas fa-user-plus mr-2"></i>
                        Registrarse
                    </div>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <div id="authMessage" class="auth-error" style="display: none;"></div>

                    <input
                        type="email"
                        id="loginEmail"
                        class="auth-input"
                        placeholder="Email"
                        required
                    />

                    <input
                        type="password"
                        id="loginPassword"
                        class="auth-input"
                        placeholder="Contrase√±a"
                        required
                    />

                    <button type="submit" class="auth-button">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Iniciar Sesi√≥n
                    </button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <input
                        type="email"
                        id="registerEmail"
                        class="auth-input"
                        placeholder="Email"
                        required
                    />

                    <input
                        type="password"
                        id="registerPassword"
                        class="auth-input"
                        placeholder="Contrase√±a (m√≠nimo 6 caracteres)"
                        minlength="6"
                        required
                    />

                    <input
                        type="password"
                        id="confirmPassword"
                        class="auth-input"
                        placeholder="Confirmar Contrase√±a"
                        minlength="6"
                        required
                    />

                    <button type="submit" class="auth-button">
                        <i class="fas fa-user-plus mr-2"></i>
                        Crear Cuenta
                    </button>
                </form>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container" id="mainApp">

        <section id="dashboard" class="section-container active">
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <div class="flex items-center gap-3">
                        <div id="dashboard-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="dashboard-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="dashboard-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button id="dashboard-date-filter-btn" class="date-filter-trigger p-1" title="Filtrar por fecha">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <div id="dashboard-date-filter-display" class="text-sm text-text-secondary">Sin filtro de fecha</div>
                    </div>
                    
                    <div class="filter-group">
                        <select id="dashboard-currency-select" class="currency-selector">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    <button class="action-btn" id="dashboard-filters-btn">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <button class="action-btn" id="dashboard-download-btn">
                        <i class="fas fa-download"></i>
                        <span>Descargar</span>
                    </button>
                </div>
            </div>

            <!-- M√≥dulo de √∫ltimos 7 d√≠as - dise√±o exacto seg√∫n imagen -->
            <div class="mb-8">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold text-white mb-4">√öltimos 7 d√≠as de trading</h3>
                    <div class="grid grid-cols-7 gap-3" id="last-7-days-calendar">
                        <!-- D√≠as se generar√°n din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- M√≥dulo de operaciones recientes - dise√±o exacto seg√∫n imagen -->
            <div class="mb-8">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold text-white mb-4">Operaciones recientes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="recent-operations-list">
                        <!-- Operaciones se generar√°n din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="metric-card lg:col-span-2">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 class="text-lg font-semibold">Evoluci√≥n de la Cuenta</h3>
                        <button onclick="openFullscreenChart('account-evolution-chart', 'Evoluci√≥n de la Cuenta - Dashboard')" style="background: #39FF14; color: black; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold;">
                            <i class="fas fa-expand"></i> Pantalla Completa
                        </button>
                    </div>
                    <div class="time-range-buttons mb-3 text-sm">
                        <button data-range="1W" class="time-range-btn">1S</button>
                        <button data-range="1M" class="time-range-btn">1M</button>
                        <button data-range="3M" class="time-range-btn">3M</button>
                        <button data-range="6M" class="time-range-btn">6M</button>
                        <button data-range="1Y" class="time-range-btn">1A</button>
                        <button data-range="ALL" class="time-range-btn active">Todo</button>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="account-evolution-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Puntuaci√≥n de Rendimiento</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="dashboard-radar-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 my-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">P&L Bruto Total</h3>
                    <p class="text-xs text-text-secondary mb-2">Sin comisiones</p>
                    <p id="dashboard-pl-gross" class="text-2xl font-bold text-white hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Comisiones</h3>
                    <p class="text-xs text-text-secondary mb-2">Fees de operaciones</p>
                    <p id="dashboard-total-fees" class="text-2xl font-bold text-red hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">P&L Neto Total</h3>
                    <p class="text-xs text-text-secondary mb-2">Despu√©s de comisiones</p>
                    <p id="dashboard-pl-net" class="text-2xl font-bold text-green hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Operaciones</h3>
                    <p class="text-xs text-text-secondary mb-2">Cantidad de trades</p>
                    <p id="dashboard-total-operations" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Ganado</h3>
                    <p id="dashboard-total-win" class="text-2xl font-bold text-green hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Perdido</h3>
                    <p id="dashboard-total-loss" class="text-2xl font-bold text-red hide-amount">$0.00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Retorno Prom. / Ganador</h3>
                    <p id="dashboard-avg-win" class="text-2xl font-bold text-green hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Retorno Prom. / Perdedor</h3>
                    <p id="dashboard-avg-loss" class="text-2xl font-bold text-red hide-amount">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">P/L Promedio / Trade</h3>
                    <p id="dashboard-avg-pl" class="text-2xl font-bold text-white hide-amount">$0.00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="instrument-performance-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por D√≠a de la Semana</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="day-performance-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mt-8">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por Tipo de Operaci√≥n (Long/Short)</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="type-performance-chart"></canvas>
                    </div>
                </div>
            </div>

        </section>

        <section id="analytics" class="section-container">
            <h2 class="text-xl font-semibold mb-4">An√°lisis Detallado</h2>
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <div class="flex items-center gap-3">
                        <div id="analytics-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="analytics-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="analytics-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button id="analytics-date-filter-btn" class="date-filter-trigger p-1" title="Filtrar por fecha">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <div id="analytics-date-filter-display" class="text-sm text-text-secondary">Sin filtro de fecha</div>
                    </div>
                    
                    <div class="filter-group">
                        <select id="analytics-currency-select" class="currency-selector">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    <button class="action-btn" id="analytics-filters-btn">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <button class="action-btn" id="analytics-download-btn">
                        <i class="fas fa-download"></i>
                        <span>Descargar</span>
                    </button>
                </div>
            </div>

            <!-- Fila superior: 6 m√≥dulos peque√±os -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                <!-- P&L Bruto Total -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">P&L Bruto Total</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-total-pl" class="text-2xl font-bold text-green mb-2">$0.00</p>
                    <!-- Radial Gauge -->
                    <div class="relative" style="height: 100px; margin-bottom: 8px;">
                        <canvas id="analytics-pl-bruto-gauge"></canvas>
                    </div>
                    <div class="flex items-center justify-center text-xs text-text-secondary">
                        <i class="far fa-chart-bar mr-1"></i>
                        <span id="analytics-pl-bruto-trades">0 trades</span>
                    </div>
                </div>
                
                <!-- P&L Neto Total -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">P&L Neto Total</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-net-pl" class="text-2xl font-bold text-green mb-2">$5,118.86</p>
                    <!-- Radial Gauge -->
                    <div class="relative" style="height: 100px; margin-bottom: 8px;">
                        <canvas id="analytics-pl-neto-gauge"></canvas>
                    </div>
                    <div class="flex items-center justify-center text-xs text-text-secondary">
                        <i class="far fa-chart-bar mr-1"></i>
                        <span id="analytics-total-trades">0 trades</span>
                    </div>
                </div>

                <!-- Trade Win % -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">Trade Win %</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-win-rate" class="text-2xl font-bold text-white mb-2">44.90%</p>
                    <!-- Gauge Chart -->
                    <div class="relative" style="height: 100px; margin-bottom: 8px;">
                        <canvas id="analytics-trade-win-gauge"></canvas>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-green bg-opacity-20 rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-green" id="analytics-wins">22</span>
                        </div>
                        <div class="bg-surface-light rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-text-secondary">0</span>
                        </div>
                        <div class="bg-red bg-opacity-20 rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-red" id="analytics-losses">27</span>
                        </div>
                    </div>
                </div>

                <!-- Profit Factor -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">Profit Factor</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-profit-factor" class="text-2xl font-bold text-white mb-2">1.30</p>
                    <!-- Speedometer Chart -->
                    <div class="relative" style="height: 100px;">
                        <canvas id="analytics-profit-factor-gauge"></canvas>
                    </div>
                </div>

                <!-- Day Win % -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">Day Win %</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-day-win-rate" class="text-2xl font-bold text-white mb-2">46.67%</p>
                    <!-- Gauge Chart -->
                    <div class="relative" style="height: 100px; margin-bottom: 8px;">
                        <canvas id="analytics-day-win-gauge"></canvas>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-green bg-opacity-20 rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-green" id="analytics-day-wins">14</span>
                        </div>
                        <div class="bg-surface-light rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-text-secondary" id="analytics-day-neutral">9</span>
                        </div>
                        <div class="bg-red bg-opacity-20 rounded px-1 py-0.5">
                            <span class="text-xs font-bold text-red" id="analytics-day-losses">16</span>
                        </div>
                    </div>
                </div>

                <!-- Avg Win/Loss Trade -->
                <div class="metric-card bg-surface border border-border rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs text-text-secondary font-medium">Avg win/loss trade</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <p id="analytics-avg-ratio" class="text-2xl font-bold text-white mb-3">1.59</p>
                    <!-- Dual progress bar (barra comparativa divergente) -->
                    <div class="mb-2">
                        <div class="flex items-center gap-0 h-3 rounded-full overflow-hidden bg-surface-light">
                            <div id="analytics-win-bar" class="h-full transition-all duration-500" style="width: 61%; background: linear-gradient(90deg, rgba(57, 255, 20, 0.8) 0%, rgba(57, 255, 20, 1) 100%);"></div>
                            <div id="analytics-loss-bar" class="h-full transition-all duration-500" style="width: 39%; background: linear-gradient(90deg, rgba(255, 65, 54, 1) 0%, rgba(255, 65, 54, 0.8) 100%);"></div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-green font-bold" id="analytics-avg-win-trade">$1.01K</span>
                        <span class="text-red font-bold" id="analytics-avg-loss-trade">-$634</span>
                    </div>
                </div>
            </div>

            <!-- Fila con Rendimiento de √öltima Semana y las dos gr√°ficas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Rendimiento de √öltima Semana -->
                <div class="metric-card bg-surface border border-border rounded-lg p-6">
                    <h3 class="text-base font-semibold text-white mb-4">Rendimiento de √öltima Semana</h3>
                    <div class="overflow-y-auto" style="max-height: 350px;">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-surface">
                                <tr class="border-b border-border">
                                    <th class="text-left py-2 text-xs font-semibold text-text-secondary">D√çA</th>
                                    <th class="text-right py-2 text-xs font-semibold text-text-secondary">P/L</th>
                                    <th class="text-right py-2 text-xs font-semibold text-text-secondary">TRADES</th>
                                    <th class="text-right py-2 text-xs font-semibold text-text-secondary">WIN %</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-lastweek-performance">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Daily Net Cumulative P&L -->
                <div class="metric-card bg-surface border border-border rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-semibold text-white">Daily Net Cumulative P&L</h3>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                            <span class="text-xs bg-yellow bg-opacity-20 text-yellow px-2 py-0.5 rounded">BETA</span>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        <canvas id="analytics-cumulative-pl-chart"></canvas>
                    </div>
                </div>

                <!-- Net Daily P&L -->
                <div class="metric-card bg-surface border border-border rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-semibold text-white">Net Daily P&L</h3>
                        <i class="fas fa-info-circle text-xs text-text-secondary"></i>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        <canvas id="analytics-net-daily-pl-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Avg Comisi√≥n</h3><p id="analytics-avg-fee" class="text-2xl font-bold text-yellow hide-amount">$0.00</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Drawdown M√°x.</h3><p id="analytics-max-drawdown-short" class="text-2xl font-bold text-red hide-amount">$0.00</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Comisiones Totales</h3><p id="analytics-total-fees" class="text-2xl font-bold text-red hide-amount">$0.00</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Avg PL / Trade</h3><p id="analytics-avg-pl-trade" class="text-2xl font-bold text-white hide-amount">$0.00</p></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-3">M√©tricas Clave</h3><dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt>Ganancia Promedio:</dt><dd id="analytics-avg-win" class="font-semibold text-green">$0.00</dd></div>
                    <div class="flex justify-between"><dt>P√©rdida Promedio:</dt><dd id="analytics-avg-loss" class="font-semibold text-red">$0.00</dd></div>
                    <div class="flex justify-between"><dt>P/L Promedio / Trade:</dt><dd id="analytics-avg-pl-trade" class="font-semibold text-white">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Comisi√≥n Promedio:</dt><dd id="analytics-avg-fee" class="font-semibold text-yellow">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Expectativa:</dt><dd id="analytics-expectancy" class="font-semibold text-white">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Mayor Ganancia:</dt><dd id="analytics-largest-win" class="font-semibold text-green">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Mayor P√©rdida:</dt><dd id="analytics-largest-loss" class="font-semibold text-red">$0.00</dd></div></dl>
                </div>
                 <div class="metric-card"><h3 class="text-lg font-semibold mb-3">Rachas y Costos</h3><dl class="space-y-2 text-sm"><div class="flex justify-between"><dt>Racha Ganadora M√°x.:</dt><dd id="analytics-longest-win-streak" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Racha Perdedora M√°x.:</dt><dd id="analytics-longest-loss-streak" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Ganadores:</dt><dd id="analytics-total-wins-count" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Perdedores:</dt><dd id="analytics-total-losses-count" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Breakeven:</dt><dd id="analytics-total-breakeven-count" class="font-semibold">0</dd></div><div class="flex justify-between border-t border-surface-light pt-2 mt-2"><dt class="font-bold">Comisiones Totales:</dt><dd id="analytics-fees-total" class="font-bold text-red">$0.00</dd></div><div class="flex justify-between"><dt>P/L Neto (despu√©s fees):</dt><dd id="analytics-net-pl-after-fees" class="font-bold text-green">$0.00</dd></div></dl></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-3">M√©tricas de Riesgo y Consistencia</h3><dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt>Drawdown M√°ximo:</dt><dd id="analytics-max-drawdown" class="font-semibold text-red">$0.00 (0%)</dd></div>
                    <div class="flex justify-between"><dt>Ratio Ganancia/P√©rdida Prom:</dt><dd id="analytics-avg-wl-ratio" class="font-semibold">0.00</dd></div>
                    <div class="flex justify-between"><dt>Tiempo Prom. por Operaci√≥n:</dt><dd id="analytics-avg-hold-time" class="font-semibold">N/A</dd></div>
                    <div class="flex justify-between"><dt>Desv. Est√°ndar del P/L:</dt><dd id="analytics-std-dev-pl" class="font-semibold">$0.00</dd></div>
                </dl></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-3">An√°lisis de Tiempo</h3><dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt>Duraci√≥n Win Prom:</dt><dd id="analytics-avg-win-duration" class="font-semibold text-green">N/A</dd></div>
                    <div class="flex justify-between"><dt>Duraci√≥n Loss Prom:</dt><dd id="analytics-avg-loss-duration" class="font-semibold text-red">N/A</dd></div>
                    <div class="flex justify-between"><dt>Mejor Hora de Trading:</dt><dd id="analytics-best-hour" class="font-semibold text-green">N/A</dd></div>
                    <div class="flex justify-between"><dt>Peor Hora de Trading:</dt><dd id="analytics-worst-hour" class="font-semibold text-red">N/A</dd></div>
                    <div class="flex justify-between"><dt>Trade Ganador M√°s Largo:</dt><dd id="analytics-longest-win-duration" class="font-semibold">N/A</dd></div>
                    <div class="flex justify-between"><dt>Trade Perdedor M√°s Largo:</dt><dd id="analytics-longest-loss-duration" class="font-semibold">N/A</dd></div>
                    <div class="flex justify-between"><dt>Trade Ganador M√°s R√°pido:</dt><dd id="analytics-fastest-win" class="font-semibold text-green">N/A</dd></div>
                </dl></div>
            </div>

             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Mes</h3><div class="overflow-y-auto max-h-72"><table class="w-full"><thead><tr><th>Mes</th><th>P/L</th><th>Trades</th><th>Win %</th></tr></thead><tbody id="analytics-monthly-performance"></tbody></table></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por D√≠a de la Semana</h3><div class="overflow-y-auto max-h-72"><table class="w-full"><thead><tr><th>D√≠a</th><th>P/L</th><th>Trades</th><th>Win %</th></tr></thead><tbody id="analytics-daily-performance"></tbody></table></div></div>
            </div>

             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento (Top 10)</h3><div class="chart-container" style="height: 280px;"><canvas id="analytics-instrument-performance-chart"></canvas></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Hora del D√≠a (Entrada)</h3><div class="chart-container" style="height: 280px;"><canvas id="analytics-hourly-performance-chart"></canvas></div></div>
            </div>
        </section>

        <!-- EQUITY GRAPH SECTION -->
        <section id="equity-graph" class="section-container">
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <h2 class="text-2xl font-bold">Equity Graph</h2>
                    <div class="flex items-center gap-3 ml-6">
                        <div id="equity-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="equity-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="equity-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button id="equity-toggle-filters-btn" class="btn-icon" title="Mostrar/Ocultar Filtros">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>

            <!-- Filtros Profesionales -->
            <div id="equity-filters-panel" class="filters-panel" style="display: none;">
                <!-- Filtros B√°sicos -->
                <div class="filters-section">
                    <h3 class="filters-section-title">
                        <i class="fas fa-sliders-h mr-2"></i>Filtros B√°sicos
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Per√≠odo de Tiempo -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-calendar mr-2"></i>Per√≠odo
                            </label>
                            <select id="equity-period-filter" class="filter-select">
                                <option value="all">Total</option>
                                <option value="1w">√öltima Semana</option>
                                <option value="1m">√öltimo Mes</option>
                                <option value="3m">√öltimos 3 Meses</option>
                                <option value="6m">√öltimos 6 Meses</option>
                                <option value="1y">√öltimo A√±o</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>

                        <!-- Rango de Fechas Personalizado -->
                        <div id="equity-custom-date-range" class="filter-item" style="display: none;">
                            <label class="filter-label">
                                <i class="fas fa-calendar-alt mr-2"></i>Desde - Hasta
                            </label>
                            <div class="flex gap-2">
                                <input type="date" id="equity-date-from" class="filter-input text-sm">
                                <input type="date" id="equity-date-to" class="filter-input text-sm">
                            </div>
                        </div>

                        <!-- Instrumento -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-chart-line mr-2"></i>Instrumento
                            </label>
                            <select id="equity-instrument-filter" class="filter-select">
                                <option value="all">Todos</option>
                            </select>
                        </div>

                        <!-- Resultado -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-trophy mr-2"></i>Resultado
                            </label>
                            <select id="equity-outcome-filter" class="filter-select">
                                <option value="all">Todos</option>
                                <option value="win">Ganadas</option>
                                <option value="loss">Perdidas</option>
                                <option value="breakeven">Breakeven</option>
                            </select>
                        </div>

                        <!-- Direcci√≥n -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-exchange-alt mr-2"></i>Direcci√≥n
                            </label>
                            <select id="equity-direction-filter" class="filter-select">
                                <option value="all">Todas</option>
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>

                        <!-- Setup -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-layer-group mr-2"></i>Setup
                            </label>
                            <select id="equity-setup-filter" class="filter-select">
                                <option value="all">Todos</option>
                            </select>
                        </div>

                        <!-- RRR -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-percentage mr-2"></i>RRR M√≠nimo
                            </label>
                            <select id="equity-rrr-filter" class="filter-select">
                                <option value="0">Todos</option>
                                <option value="1">RRR ‚â• 1</option>
                                <option value="2">RRR ‚â• 2</option>
                                <option value="3">RRR ‚â• 3</option>
                                <option value="5">RRR ‚â• 5</option>
                            </select>
                        </div>

                        <!-- Marcadas (Favoritas) -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-star mr-2"></i>Marcadas
                            </label>
                            <select id="equity-starred-filter" class="filter-select">
                                <option value="all">Todas</option>
                                <option value="starred">Solo Marcadas</option>
                                <option value="not-starred">No Marcadas</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Filtros Avanzados -->
                <div class="filters-section mt-4">
                    <h3 class="filters-section-title">
                        <i class="fas fa-cog mr-2"></i>Filtros Avanzados
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Modo de Visualizaci√≥n -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-chart-area mr-2"></i>Visualizaci√≥n
                            </label>
                            <select id="equity-display-mode" class="filter-select">
                                <option value="return">Return ($)</option>
                                <option value="balance">Account Balance ($)</option>
                                <option value="return-pct">Return, gain sum (%)</option>
                                <option value="roi">Return, ROI (%)</option>
                                <option value="r-multiple">R Multiple (R)</option>
                            </select>
                        </div>

                        <!-- Agrupaci√≥n -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-layer-group mr-2"></i>Agrupar por
                            </label>
                            <select id="equity-group-by" class="filter-select">
                                <option value="trades">Trades Individuales</option>
                                <option value="day">Agrupar por D√≠a</option>
                                <option value="week">Agrupar por Semana</option>
                                <option value="month">Agrupar por Mes</option>
                            </select>
                        </div>

                        <!-- √öltimas N Operaciones -->
                        <div class="filter-item">
                            <label class="filter-label">
                                <i class="fas fa-list-ol mr-2"></i>√öltimas Operaciones
                            </label>
                            <select id="equity-last-trades-filter" class="filter-select">
                                <option value="all">Todas</option>
                                <option value="10">√öltimas 10</option>
                                <option value="20">√öltimas 20</option>
                                <option value="50">√öltimas 50</option>
                                <option value="100">√öltimas 100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                    <div class="text-sm text-text-secondary">
                        <span id="equity-filtered-count">0</span> operaciones filtradas
                    </div>
                    <div class="flex gap-2">
                        <button id="equity-clear-filters-btn" class="btn-secondary">
                            <i class="fas fa-times mr-2"></i>Limpiar Filtros
                        </button>
                        <button id="equity-apply-filters-btn" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- Equity Chart - Casi pantalla completa -->
            <div class="metric-card mb-6">
                <div class="chart-container" style="height: calc(100vh - 400px); min-height: 500px;">
                    <canvas id="equity-main-chart"></canvas>
                </div>
            </div>

            <!-- M√©tricas en Grid debajo del gr√°fico -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-9 gap-4">
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Account Balance</p>
                    <p id="equity-account-balance" class="text-xl font-bold text-white">$0.00</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Trades</p>
                    <p id="equity-total-trades" class="text-xl font-bold text-white">0</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Winners</p>
                    <p id="equity-winners" class="text-xl font-bold text-green">0</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Losers</p>
                    <p id="equity-losers" class="text-xl font-bold text-red">0</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Winrate (%)</p>
                    <p id="equity-winrate" class="text-xl font-bold text-primary">0%</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Avg. P&L</p>
                    <p id="equity-avg-pl" class="text-xl font-bold text-white">$0.00</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Profit Factor</p>
                    <p id="equity-profit-factor" class="text-xl font-bold text-white">0.00</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Return (%)</p>
                    <p id="equity-return-percent" class="text-xl font-bold text-primary">0%</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Profit/Loss</p>
                    <p id="equity-profit-loss" class="text-xl font-bold text-white">$0.00</p>
                </div>
            </div>

            <!-- Segunda fila de m√©tricas -->
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mt-4">
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Biggest Winner</p>
                    <p id="equity-biggest-winner" class="text-xl font-bold text-green">$0.00</p>
                </div>
                <div class="metric-card p-4 text-center">
                    <p class="text-xs text-text-secondary mb-1">Biggest Loser</p>
                    <p id="equity-biggest-loser" class="text-xl font-bold text-red">$0.00</p>
                </div>
            </div>
        </section>

        <section id="informe" class="section-container">
            <!-- Filters -->
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <div class="flex items-center gap-3">
                        <div id="informe-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="informe-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="informe-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button id="informe-date-filter-btn" class="date-filter-trigger p-1" title="Filtrar por fecha">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <div id="informe-date-filter-display" class="text-sm text-text-secondary">Sin filtro de fecha</div>
                    </div>
                    
                    <div class="filter-group">
                        <select id="informe-currency-select" class="currency-selector">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    <button class="action-btn" id="informe-filters-btn">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <button class="action-btn" id="informe-download-btn">
                        <i class="fas fa-download"></i>
                        <span>Descargar</span>
                    </button>
                </div>
            </div>

            <!-- Filter Panel -->
            <div id="informe-filters-panel" class="hidden bg-surface p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Symbol Filter -->
                    <div>
                        <label for="informe-filter-symbol" class="block text-sm font-medium text-text-secondary mb-1">S√≠mbolo</label>
                        <input type="text" id="informe-filter-symbol" placeholder="Ej: EURUSD, BTCUSDT" class="w-full">
                    </div>
                    <!-- Operation Type Filter -->
                    <div>
                        <label for="informe-filter-type" class="block text-sm font-medium text-text-secondary mb-1">Tipo Operaci√≥n</label>
                        <select id="informe-filter-type" class="w-full">
                            <option value="all">Todos</option>
                            <option value="buy">Long (Compra)</option>
                            <option value="sell">Short (Venta)</option>
                        </select>
                    </div>
                    <!-- Result Filter -->
                    <div>
                        <label for="informe-filter-result" class="block text-sm font-medium text-text-secondary mb-1">Resultado</label>
                        <select id="informe-filter-result" class="w-full">
                            <option value="all">Todos</option>
                            <option value="win">Ganancia</option>
                            <option value="loss">P√©rdida</option>
                            <option value="breakeven">Breakeven</option>
                        </select>
                    </div>
                    <!-- P/L Range Filter -->
                    <div class="md:col-span-2 lg:col-span-2 grid grid-cols-2 gap-2">
                        <div>
                            <label for="informe-filter-pl-min" class="block text-sm font-medium text-text-secondary mb-1">P/L M√≠nimo</label>
                            <input type="number" id="informe-filter-pl-min" placeholder="Ej: -100" class="w-full">
                        </div>
                        <div>
                            <label for="informe-filter-pl-max" class="block text-sm font-medium text-text-secondary mb-1">P/L M√°ximo</label>
                            <input type="number" id="informe-filter-pl-max" placeholder="Ej: 500" class="w-full">
                        </div>
                    </div>
                    <!-- Day of Week Filter -->
                    <div>
                        <label for="informe-filter-day" class="block text-sm font-medium text-text-secondary mb-1">D√≠a de la Semana</label>
                        <select id="informe-filter-day" class="w-full">
                            <option value="all">Todos</option>
                            <option value="1">Lunes</option>
                            <option value="2">Martes</option>
                            <option value="3">Mi√©rcoles</option>
                            <option value="4">Jueves</option>
                            <option value="5">Viernes</option>
                            <option value="6">S√°bado</option>
                            <option value="0">Domingo</option>
                        </select>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="flex justify-end gap-2 mt-4">
                    <button id="informe-apply-filters-btn" class="primary">Aplicar Filtros</button>
                    <button id="informe-clear-filters-btn" class="secondary">Limpiar</button>
                </div>
            </div>

            <!-- Sub-tabs for Informe section -->
            <div class="nav-tabs flex mb-6">
                <div class="nav-tab informe-sub-tab active" data-target="informe-informes-content">Informes</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-metricas-content">M√©tricas</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-metricas-avanzadas-content">M√©tricas Avanzadas</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-simbolos-content">S√≠mbolos</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-tiempo-content">Tiempo</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-graficos-content">Gr√°ficos</div>
                <div class="nav-tab informe-sub-tab" data-target="informe-comisiones-content">Comisiones</div>
            </div>

            <!-- Tab Content -->
            <div id="informe-informes-content" class="informe-sub-section-container active">
                <!-- PnL Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- P&L Bruto Total -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P&L Bruto Total</p>
                        <p class="text-xs text-text-secondary mb-2">Sin comisiones</p>
                        <p id="informe-total-pl" class="text-2xl font-bold text-positive">$0.00</p>
                    </div>
                    <!-- P&L Neto Total -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P&L Neto Total</p>
                        <p class="text-xs text-text-secondary mb-2">Despu√©s de comisiones</p>
                        <p id="informe-realized-pl" class="text-2xl font-bold text-positive">$0.00</p>
                    </div>
                    <!-- PnL no realizado -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL no realizado</p>
                        <p class="text-xs text-text-secondary mb-2">PnL</p>
                        <p id="informe-unrealized-pl" class="text-2xl font-bold text-neutral">$0.00</p>
                    </div>
                    <!-- Solo beneficio PnL -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Solo beneficio PnL</p>
                        <p class="text-xs text-text-secondary mb-2">Solo p√©rdida PnL</p>
                        <p id="informe-only-win-pl" class="text-xl font-bold text-positive">$0.00</p>
                        <p id="informe-only-loss-pl" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <!-- Valor total de la cuenta -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Valor total de la cuenta</p>
                        <p class="text-xs text-text-secondary mb-2">Balance inicial + PnL de operaciones</p>
                        <p id="informe-total-account-value" class="text-2xl font-bold text-positive">$0.00</p>
                    </div>
                    <!-- Transacciones monetarias totales -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Transacciones monetarias totales</p>
                        <p class="text-xs text-text-secondary mb-2">Dep√≥sitos - retiros</p>
                        <p id="informe-total-monetary-transactions" class="text-2xl font-bold text-neutral">$0.00</p>
                    </div>
                    <!-- Dep√≥sitos totales -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Dep√≥sitos totales</p>
                        <p class="text-xs text-text-secondary mb-2">Devoluci√≥n de dep√≥sitos</p>
                        <p id="informe-total-deposits" class="text-2xl font-bold text-neutral">$0.00</p>
                    </div>
                    <!-- Retiros totales -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Retiros totales</p>
                        <p class="text-xs text-text-secondary mb-2">&nbsp;</p>
                        <p id="informe-total-withdrawals" class="text-2xl font-bold text-neutral">$0.00</p>
                    </div>
                    <!-- PnL promedio por operaci√≥n -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL promedio por operaci√≥n</p>
                        <p id="informe-avg-pl-trade" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Promedio %</p>
                        <p id="informe-avg-pl-percentage" class="text-xl font-bold text-positive">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL PROMEDIO (Por d√≠a)</p>
                        <p id="informe-avg-pl-day" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL PROMEDIO (Por mes)</p>
                        <p id="informe-avg-pl-month" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL PROMEDIO (Por a√±o)</p>
                        <p id="informe-avg-pl-year" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PROMEDIO GANADOR PnL (Por operaci√≥n)</p>
                        <p id="informe-avg-win-pl-trade" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PROMEDIO GANADOR PnL (Por d√≠a)</p>
                        <p id="informe-avg-win-pl-day" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PROMEDIO GANADOR PnL (Por mes)</p>
                        <p id="informe-avg-win-pl-month" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PROMEDIO GANADOR PnL (Por a√±o)</p>
                        <p id="informe-avg-win-pl-year" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA PROMEDIO PnL (Por operaci√≥n)</p>
                        <p id="informe-avg-loss-pl-trade" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA PROMEDIO PnL (Por d√≠a)</p>
                        <p id="informe-avg-loss-pl-day" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA PROMEDIO PnL (Por mes)</p>
                        <p id="informe-avg-loss-pl-month" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA PROMEDIO PnL (Por a√±o)</p>
                        <p id="informe-avg-loss-pl-year" class="text-xl font-bold text-neutral">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PROMEDIO GANADOR PnL % (Por operaci√≥n)</p>
                        <p id="informe-avg-win-pl-percentage" class="text-xl font-bold text-positive">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">PnL GANADOR TOTAL % (Por operaci√≥n)</p>
                        <p id="informe-total-win-pl-percentage" class="text-xl font-bold text-positive">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA PROMEDIO PnL % (Por operaci√≥n)</p>
                        <p id="informe-avg-loss-pl-percentage" class="text-xl font-bold text-negative">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">P√âRDIDA TOTAL PnL % (Por operaci√≥n)</p>
                        <p id="informe-total-loss-pl-percentage" class="text-xl font-bold text-negative">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">MEJOR GANADOR PnL (Por operaci√≥n)</p>
                        <p id="informe-best-win-pl-trade" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">LA PEOR P√âRDIDA DE PnL (Por operaci√≥n)</p>
                        <p id="informe-worst-loss-pl-trade" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">MEJOR GANADOR PnL (Por d√≠a)</p>
                        <p id="informe-best-win-pl-day" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">LA PEOR P√âRDIDA DE PnL (Por d√≠a)</p>
                        <p id="informe-worst-loss-pl-day" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                </div>

                <!-- Advanced Professional Metrics -->
                <!-- Detailed Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Beneficio del √∫ltimo d√≠a -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Beneficio del √∫ltimo d√≠a</p>
                        <p id="informe-last-day-pl" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <!-- Ganancias de la semana pasada -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Ganancias de la semana pasada</p>
                        <p id="informe-last-week-pl" class="text-xl font-bold text-negative">$0.00</p>
                    </div>
                    <!-- Beneficio del mes pasado -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Beneficio del mes pasado</p>
                        <p id="informe-last-month-pl" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                    <!-- Beneficio del a√±o pasado -->
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Beneficio del a√±o pasado</p>
                        <p id="informe-last-year-pl" class="text-xl font-bold text-positive">$0.00</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Aggregate PnL vs Symbol (Descending)</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-pnl-desc"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Aggregate PnL vs Symbol (Ascending)</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-pnl-asc"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Wins/Losses vs Symbol (Descending)</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-wl-desc"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Wins/Losses vs Symbol (Ascending)</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-wl-asc"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Aggregate Volume vs Symbol</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-volume-symbol"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Daily Volume</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-chart-daily-volume"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="informe-metricas-content" class="informe-sub-section-container">
                <div id="informe-metricas-data-view">
                    <h3 class="text-2xl font-bold mb-6 w-full text-left">M√©tricas Detalladas de Operaciones</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Totales</p>
                            <p id="informe-metricas-total-trades" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Ganadores</p>
                            <p id="informe-metricas-winning-trades" class="text-2xl font-bold text-positive">0</p>
                            <p id="informe-metricas-winning-trades-percent" class="text-sm text-positive">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Perdedores</p>
                            <p id="informe-metricas-losing-trades" class="text-2xl font-bold text-negative">0</p>
                            <p id="informe-metricas-losing-trades-percent" class="text-sm text-negative">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Breakeven</p>
                            <p id="informe-metricas-breakeven-trades" class="text-2xl font-bold text-neutral">0</p>
                            <p id="informe-metricas-breakeven-trades-percent" class="text-sm text-neutral">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Long</p>
                            <p id="informe-metricas-long-trades" class="text-2xl font-bold text-positive">0</p>
                            <p id="informe-metricas-long-trades-percent" class="text-sm text-positive">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Short</p>
                            <p id="informe-metricas-short-trades" class="text-2xl font-bold text-negative">0</p>
                            <p id="informe-metricas-short-trades-percent" class="text-sm text-negative">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">D√≠as Ganadores</p>
                            <p id="informe-metricas-winning-days" class="text-2xl font-bold text-positive">0</p>
                            <p id="informe-metricas-winning-days-percent" class="text-sm text-positive">0%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">D√≠as Perdedores</p>
                            <p id="informe-metricas-losing-days" class="text-2xl font-bold text-negative">0</p>
                            <p id="informe-metricas-losing-days-percent" class="text-sm text-negative">0%</p>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold mb-6 w-full text-left">Promedios y M√°ximos de Operaciones</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Promedio / D√≠a</p>
                            <p id="informe-metricas-avg-trades-day" class="text-2xl font-bold text-white">0.00</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Promedio / Mes</p>
                            <p id="informe-metricas-avg-trades-month" class="text-2xl font-bold text-white">0.00</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Trades Promedio / A√±o</p>
                            <p id="informe-metricas-avg-trades-year" class="text-2xl font-bold text-white">0.00</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">M√°x. Trades / D√≠a</p>
                            <p id="informe-metricas-max-trades-day" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">M√°x. Trades / Mes</p>
                            <p id="informe-metricas-max-trades-month" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">M√°x. Trades / A√±o</p>
                            <p id="informe-metricas-max-trades-year" class="text-2xl font-bold text-white">0</p>
                        </div>
                    </div>

                    <!-- M√©trica de Barra: Distribuci√≥n Win/Loss -->
                    <div class="metric-card p-6 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-white">Distribuci√≥n de Resultados</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Barra de distribuci√≥n Win/Loss -->
                            <div class="md:col-span-2">
                                <div class="mb-4">
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-text-secondary">Operaciones Ganadoras</span>
                                        <span id="informe-win-count-bar" class="text-sm font-semibold text-green">0 (0%)</span>
                                    </div>
                                    <div class="w-full bg-surface-light rounded-full h-8 overflow-hidden">
                                        <div id="informe-win-bar" class="bg-gradient-to-r from-green-500 to-green-400 h-8 flex items-center justify-end px-3 transition-all duration-500" style="width: 0%">
                                            <span class="text-xs font-bold text-bg" id="informe-win-amount-bar">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-text-secondary">Operaciones Perdedoras</span>
                                        <span id="informe-loss-count-bar" class="text-sm font-semibold text-negative">0 (0%)</span>
                                    </div>
                                    <div class="w-full bg-surface-light rounded-full h-8 overflow-hidden">
                                        <div id="informe-loss-bar" class="bg-gradient-to-r from-red-500 to-red-400 h-8 flex items-center justify-end px-3 transition-all duration-500" style="width: 0%">
                                            <span class="text-xs font-bold text-bg" id="informe-loss-amount-bar">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-text-secondary">Break Even</span>
                                        <span id="informe-breakeven-count-bar" class="text-sm font-semibold text-text-secondary">0 (0%)</span>
                                    </div>
                                    <div class="w-full bg-surface-light rounded-full h-8 overflow-hidden">
                                        <div id="informe-breakeven-bar" class="bg-gradient-to-r from-gray-500 to-gray-400 h-8 flex items-center justify-end px-3 transition-all duration-500" style="width: 0%">
                                            <span class="text-xs font-bold text-bg" id="informe-breakeven-count-text">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- M√©tricas complementarias -->
                            <div class="flex flex-col justify-center gap-4">
                                <div class="text-center p-4 bg-surface rounded-lg">
                                    <p class="text-xs text-text-secondary mb-1">Ratio Win/Loss</p>
                                    <p id="informe-win-loss-ratio-bar" class="text-2xl font-bold text-white">0.00</p>
                                </div>
                                <div class="text-center p-4 bg-surface rounded-lg">
                                    <p class="text-xs text-text-secondary mb-1">Expectativa Matem√°tica</p>
                                    <p id="informe-math-expectancy-bar" class="text-2xl font-bold text-white">$0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUEVA M√âTRICA DE BARRA 3: Distribuci√≥n de Tipos de Operaciones -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Tipos de Operaciones</h3>
                            <p class="text-xs text-text-secondary mb-3">Cantidad y P/L por tipo de posici√≥n (Long/Short)</p>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="informe-long-short-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Estilos de Trading por Duraci√≥n</h3>
                            <p class="text-xs text-text-secondary mb-3">Clasificaci√≥n por tiempo de retenci√≥n</p>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="informe-trading-styles-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold mb-6 w-full text-left">Rendimiento General</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card lg:col-span-1">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h3 class="text-lg font-semibold">Evoluci√≥n de la Cuenta</h3>
                                <button onclick="openFullscreenChart('informe-metricas-evolution-chart', 'Evoluci√≥n de la Cuenta - Informe')" style="background: #39FF14; color: black; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold;">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <div class="time-range-buttons mb-3 text-sm">
                                <button data-range="1W" class="time-range-btn">1S</button>
                                <button data-range="1M" class="time-range-btn">1M</button>
                                <button data-range="3M" class="time-range-btn">3M</button>
                                <button data-range="6M" class="time-range-btn">6M</button>
                                <button data-range="1Y" class="time-range-btn">1A</button>
                                <button data-range="ALL" class="time-range-btn active">Todo</button>
                            </div>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-evolution-chart"></canvas>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Puntuaci√≥n de Rendimiento</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-radar-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Nuevos m√≥dulos de Reducci√≥n acumulada y P&L acumulado -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Reducci√≥n acumulada</h3>
                            <div class="time-range-buttons mb-3 text-sm">
                                <button data-range="1W" class="time-range-btn drawdown-range-btn">1S</button>
                                <button data-range="1M" class="time-range-btn drawdown-range-btn">1M</button>
                                <button data-range="3M" class="time-range-btn drawdown-range-btn">3M</button>
                                <button data-range="6M" class="time-range-btn drawdown-range-btn">6M</button>
                                <button data-range="1Y" class="time-range-btn drawdown-range-btn">1A</button>
                                <button data-range="ALL" class="time-range-btn drawdown-range-btn active">Todo</button>
                            </div>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="reduccion-acumulada-chart"></canvas>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">P&L acumulado</h3>
                            <div class="time-range-buttons mb-3 text-sm">
                                <button data-range="1W" class="time-range-btn pnl-range-btn">1S</button>
                                <button data-range="1M" class="time-range-btn pnl-range-btn">1M</button>
                                <button data-range="3M" class="time-range-btn pnl-range-btn">3M</button>
                                <button data-range="6M" class="time-range-btn pnl-range-btn">6M</button>
                                <button data-range="1Y" class="time-range-btn pnl-range-btn">1A</button>
                                <button data-range="ALL" class="time-range-btn pnl-range-btn active">Todo</button>
                            </div>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="pnl-acumulado-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Nuevos gr√°ficos: P&L Neto Diario y Wins/Losses por D√≠a -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">P&L Neto Diario</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="cuentas-daily-pnl-chart"></canvas>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Victorias/Derrotas por D√≠a</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="cuentas-daily-winloss-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NUEVAS M√âTRICAS CR√çTICAS DE GESTI√ìN DE RIESGO -->
                    <h3 class="text-2xl font-bold mb-6 w-full text-left mt-8">Gesti√≥n de Riesgo y Capital</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Tama√±o Promedio de Posici√≥n</p>
                            <p class="text-xs text-text-secondary mb-2">Lotes/Contratos promedio</p>
                            <p id="informe-metricas-avg-position-size" class="text-2xl font-bold text-white">0.00</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Riesgo Promedio por Trade</p>
                            <p class="text-xs text-text-secondary mb-2">% del capital arriesgado</p>
                            <p id="informe-metricas-avg-risk-percent" class="text-2xl font-bold text-yellow">0.00%</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">R:R Promedio Realizado</p>
                            <p class="text-xs text-text-secondary mb-2">Reward to Risk real</p>
                            <p id="informe-metricas-avg-rr-realized" class="text-2xl font-bold text-primary">0.00</p>
                        </div>
                        <div class="metric-card p-4">
                            <p class="text-sm text-text-secondary">Capital Utilizado Promedio</p>
                            <p class="text-xs text-text-secondary mb-2">% de cuenta en uso</p>
                            <p id="informe-metricas-capital-usage" class="text-2xl font-bold text-white">0.00%</p>
                        </div>
                    </div>
                    
                    <!-- Gr√°ficas de Gesti√≥n de Riesgo -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Tama√±o de Posici√≥n</h3>
                            <p class="text-xs text-text-secondary mb-3">Cantidad de trades por rango de tama√±o</p>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-position-size-distribution-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">P/L por Nivel de Riesgo</h3>
                            <p class="text-xs text-text-secondary mb-3">Rendimiento seg√∫n % de capital arriesgado</p>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-pl-by-risk-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">R:R Realizado vs Planificado</h3>
                            <p class="text-xs text-text-secondary mb-3">Comparaci√≥n entre objetivo y resultado real</p>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-rr-comparison-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Rendimiento por Capital Utilizado</h3>
                            <p class="text-xs text-text-secondary mb-3">P/L promedio vs % de capital en uso</p>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-metricas-capital-efficiency-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="informe-metricas-no-data" class="text-center p-8 text-text-secondary" style="display: none;">
                    No hay datos de operaciones para mostrar en el per√≠odo o cuenta seleccionada.
                </div>
            </div>
            
            <!-- Nueva Secci√≥n: M√âTRICAS AVANZADAS -->
            <div id="informe-metricas-avanzadas-content" class="informe-sub-section-container">
                <h3 class="text-2xl font-bold mb-6 text-white">M√©tricas Profesionales Avanzadas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Expectancy Ratio</p>
                        <p class="text-xs text-text-secondary mb-2">Ganancia esperada por trade</p>
                        <p id="informe-expectancy-ratio" class="text-2xl font-bold text-positive">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Kelly Criterion %</p>
                        <p class="text-xs text-text-secondary mb-2">√ìptimo % de riesgo por trade</p>
                        <p id="informe-kelly-criterion" class="text-2xl font-bold text-primary">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Sharpe Ratio</p>
                        <p class="text-xs text-text-secondary mb-2">Retorno ajustado por riesgo</p>
                        <p id="informe-sharpe-ratio" class="text-2xl font-bold text-white">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Sortino Ratio</p>
                        <p class="text-xs text-text-secondary mb-2">Retorno vs downside risk</p>
                        <p id="informe-sortino-ratio" class="text-2xl font-bold text-white">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Calmar Ratio</p>
                        <p class="text-xs text-text-secondary mb-2">Retorno anual / Max DD</p>
                        <p id="informe-calmar-ratio" class="text-2xl font-bold text-white">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Recovery Factor</p>
                        <p class="text-xs text-text-secondary mb-2">Ganancia neta / Max DD</p>
                        <p id="informe-recovery-factor" class="text-2xl font-bold text-positive">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Risk of Ruin %</p>
                        <p class="text-xs text-text-secondary mb-2">Probabilidad de ruina</p>
                        <p id="informe-risk-of-ruin" class="text-2xl font-bold text-red">0.00%</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Z-Score</p>
                        <p class="text-xs text-text-secondary mb-2">Consistencia de resultados</p>
                        <p id="informe-z-score" class="text-2xl font-bold text-white">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">MAE Promedio</p>
                        <p class="text-xs text-text-secondary mb-2">Max Adverse Excursion</p>
                        <p id="informe-avg-mae" class="text-2xl font-bold text-red">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">MFE Promedio</p>
                        <p class="text-xs text-text-secondary mb-2">Max Favorable Excursion</p>
                        <p id="informe-avg-mfe" class="text-2xl font-bold text-green">$0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Racha Ganadora M√°xima</p>
                        <p class="text-xs text-text-secondary mb-2">Consecutivos</p>
                        <p id="informe-max-win-streak" class="text-2xl font-bold text-positive">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Racha Perdedora M√°xima</p>
                        <p class="text-xs text-text-secondary mb-2">Consecutivos</p>
                        <p id="informe-max-loss-streak" class="text-2xl font-bold text-negative">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Consistency Score</p>
                        <p class="text-xs text-text-secondary mb-2">0-100 (m√°s alto = mejor)</p>
                        <p id="informe-consistency-score" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Payoff Ratio</p>
                        <p class="text-xs text-text-secondary mb-2">Avg Win / Avg Loss</p>
                        <p id="informe-payoff-ratio" class="text-2xl font-bold text-white">0.00</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Tiempo Total Operando</p>
                        <p class="text-xs text-text-secondary mb-2">D√≠as activos</p>
                        <p id="informe-total-trading-days" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">R-M√∫ltiplo Promedio</p>
                        <p class="text-xs text-text-secondary mb-2">Retorno vs riesgo inicial</p>
                        <p id="informe-avg-r-multiple" class="text-2xl font-bold text-white">0.00R</p>
                    </div>
                </div>

                <!-- NUEVAS M√âTRICAS DE BARRA 1 y 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- M√âTRICA 1: Distribuci√≥n de P/L por Rango -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de P/L por Rango</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de trades por rango de resultado</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="informe-pl-range-chart"></canvas>
                        </div>
                    </div>

                    <!-- M√âTRICA 2: Distribuci√≥n de Volumen por Rango -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Volumen por Rango</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de trades por tama√±o de lote</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="informe-volume-range-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- NUEVA M√âTRICA DE BARRA 6: Distribuci√≥n de Riesgo/Recompensa -->
                <div class="mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Riesgo/Recompensa (R:R)</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de trades por ratio Riesgo/Recompensa planificado</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="informe-rr-chart"></canvas>
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl font-bold mb-6 mt-8 text-white">An√°lisis Estad√≠stico Avanzado</h3>
                
                <!-- Grid de 4 gr√°ficas de barras -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Gr√°fica 1: Rachas Ganadoras/Perdedoras por Tipo (Long/Short) -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Rachas por Tipo de Posici√≥n</h3>
                        <p class="text-xs text-text-secondary mb-3">M√°xima racha de wins/losses en Long y Short</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-rachas-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gr√°fica 2: Volumen de Ganancias/P√©rdidas Temporal -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Volumen P/L por Per√≠odo</h3>
                        <p class="text-xs text-text-secondary mb-3">Ganancias vs P√©rdidas en d√≠a, semana y mes</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-volumen-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gr√°fica 3: Distribuci√≥n de P/L por Sesi√≥n de Trading -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Rendimiento por Sesi√≥n</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L promedio en sesi√≥n Asi√°tica, Europea y Americana</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-sesiones-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gr√°fica 4: Win Rate por Rango Horario -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Win Rate por Franja Horaria</h3>
                        <p class="text-xs text-text-secondary mb-3">Porcentaje de √©xito en intervalos de 4 horas</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-winrate-horario-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- AN√ÅLISIS PSICOL√ìGICO Y COMPORTAMIENTO -->
                <h3 class="text-2xl font-bold mb-6 mt-8 text-white">An√°lisis Psicol√≥gico y Comportamiento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Racha Actual</p>
                        <p class="text-xs text-text-secondary mb-2">Wins o Losses consecutivos actuales</p>
                        <p id="informe-current-streak" class="text-2xl font-bold text-white">0</p>
                        <p id="informe-current-streak-type" class="text-xs text-text-secondary mt-1">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Semanas Positivas Consecutivas</p>
                        <p class="text-xs text-text-secondary mb-2">M√°ximo de semanas seguidas en positivo</p>
                        <p id="informe-max-positive-weeks" class="text-2xl font-bold text-green">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Semanas Negativas Consecutivas</p>
                        <p class="text-xs text-text-secondary mb-2">M√°ximo de semanas seguidas en negativo</p>
                        <p id="informe-max-negative-weeks" class="text-2xl font-bold text-red">0</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">√çndice de Overtrading</p>
                        <p class="text-xs text-text-secondary mb-2">% de d√≠as con >10 operaciones</p>
                        <p id="informe-overtrading-index" class="text-2xl font-bold text-yellow">0%</p>
                    </div>
                </div>
                
                <!-- Gr√°ficas de An√°lisis Psicol√≥gico -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- P/L Despu√©s de Wins Consecutivos -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">P/L Despu√©s de Rachas Ganadoras</h3>
                        <p class="text-xs text-text-secondary mb-3">Rendimiento del siguiente trade despu√©s de N wins consecutivos</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-pl-after-wins-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- P/L Despu√©s de Losses Consecutivos -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">P/L Despu√©s de Rachas Perdedoras</h3>
                        <p class="text-xs text-text-secondary mb-3">Rendimiento del siguiente trade despu√©s de N losses consecutivos</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-pl-after-losses-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Revenge Trading Detector -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Detector de Revenge Trading</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L en trades tomados <30min despu√©s de una p√©rdida</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-revenge-trading-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Overtrading Analysis -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">An√°lisis de Overtrading</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L promedio vs n√∫mero de operaciones por d√≠a</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="metricas-avanzadas-overtrading-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Nuevas Gr√°ficas: Distribuci√≥n de P/L y Performance Mensual -->
                <h3 class="text-2xl font-bold mb-6 mt-8 text-white">An√°lisis de Rendimiento</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Distribuci√≥n de P/L (Histograma) -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Distribuci√≥n de P/L</h3>
                        <p class="text-xs text-text-secondary mb-3">Histograma de ganancias y p√©rdidas por trade</p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="pl-distribution-histogram-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Performance por Mes (Barras comparativas) -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-3 text-gray-200">Performance por Mes</h3>
                        <p class="text-xs text-text-secondary mb-3">Comparaci√≥n de P/L mensual (Ganancias vs P√©rdidas)</p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="monthly-performance-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="informe-simbolos-content" class="informe-sub-section-container">
                <!-- Contenido din√°mico generado por refreshSimbolos() -->
            </div>
            
            <!-- Nueva Secci√≥n: TIEMPO -->
            <div id="informe-tiempo-content" class="informe-sub-section-container">
                <h3 class="text-2xl font-bold mb-4">M√©tricas de Tiempo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Duraci√≥n Win Promedio</p>
                        <p class="text-xs text-text-secondary mb-2">Tiempo promedio en trades ganadores</p>
                        <p id="informe-tiempo-avg-win-duration" class="text-2xl font-bold text-green">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Duraci√≥n Loss Promedio</p>
                        <p class="text-xs text-text-secondary mb-2">Tiempo promedio en trades perdedores</p>
                        <p id="informe-tiempo-avg-loss-duration" class="text-2xl font-bold text-red">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Mejor Hora de Trading</p>
                        <p class="text-xs text-text-secondary mb-2">Hora con mayor P/L total</p>
                        <p id="informe-tiempo-best-hour" class="text-2xl font-bold text-green">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Peor Hora de Trading</p>
                        <p class="text-xs text-text-secondary mb-2">Hora con menor P/L total</p>
                        <p id="informe-tiempo-worst-hour" class="text-2xl font-bold text-red">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Trade Ganador M√°s Largo</p>
                        <p class="text-xs text-text-secondary mb-2">M√°xima duraci√≥n en trade ganador</p>
                        <p id="informe-tiempo-longest-win" class="text-2xl font-bold text-white">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Trade Perdedor M√°s Largo</p>
                        <p class="text-xs text-text-secondary mb-2">M√°xima duraci√≥n en trade perdedor</p>
                        <p id="informe-tiempo-longest-loss" class="text-2xl font-bold text-white">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Trade Ganador M√°s R√°pido</p>
                        <p class="text-xs text-text-secondary mb-2">M√≠nima duraci√≥n en trade ganador</p>
                        <p id="informe-tiempo-fastest-win" class="text-2xl font-bold text-green">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Tiempo Promedio por Trade</p>
                        <p class="text-xs text-text-secondary mb-2">Duraci√≥n promedio de todos los trades</p>
                        <p id="informe-tiempo-avg-trade-duration" class="text-2xl font-bold text-white">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Tiempo Inactivo Total</p>
                        <p class="text-xs text-text-secondary mb-2">Tiempo acumulado esperando entre trades</p>
                        <p id="informe-tiempo-inactive-time" class="text-2xl font-bold text-white">0h</p>
                    </div>
                </div>

                <!-- Gr√°ficas de Tiempo -->
                <h3 class="text-2xl font-bold mb-4 mt-8">An√°lisis Visual de Tiempo</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Duraci√≥n Promedio: Wins vs Losses</h3>
                        <p class="text-xs text-text-secondary mb-3">Comparaci√≥n de tiempo en trades ganadores y perdedores</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-duration-comparison-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento por Hora del D√≠a</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L total por cada hora (00:00 - 23:00)</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-hourly-pl-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento por D√≠a de la Semana</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L total por d√≠a (Lunes - Domingo)</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-daily-pl-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Duraci√≥n de Trades</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de trades por rango de duraci√≥n</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-duration-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- NUEVO: Distribuci√≥n de Resultado por Rango de Duraci√≥n -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Resultado por Rango de Duraci√≥n</h3>
                        <p class="text-xs text-text-secondary mb-3">P/L promedio seg√∫n duraci√≥n del trade</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-pl-by-duration-chart"></canvas>
                        </div>
                    </div>

                    <!-- NUEVA M√âTRICA: Tiempo Inactivo Total -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Tiempo Inactivo Total</h3>
                        <p class="text-xs text-text-secondary mb-3">Tiempo acumulado esperando entre trades - Mide tu disciplina y paciencia</p>
                        <div class="flex flex-col items-center justify-center h-full" style="height: 300px;">
                            <div class="text-center">
                                <p class="text-xs text-text-secondary mb-3">Total de Tiempo Inactivo</p>
                                <p id="informe-tiempo-inactive-time-chart" class="text-6xl font-bold text-primary mb-4">0h</p>
                                <div class="grid grid-cols-2 gap-4 mt-6">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Tiempo Promedio entre Trades</p>
                                        <p id="informe-tiempo-avg-inactive" class="text-xl font-bold text-white">0h</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">M√°ximo Tiempo Inactivo</p>
                                        <p id="informe-tiempo-max-inactive" class="text-xl font-bold text-white">0h</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVAS M√âTRICAS DE BARRA 4 y 7 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- M√âTRICA 4: Distribuci√≥n de Sesiones de Trading -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Sesiones de Trading</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad y rendimiento por sesi√≥n horaria global</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-sessions-chart"></canvas>
                        </div>
                    </div>

                    <!-- M√âTRICA 7: Distribuci√≥n Temporal de Actividad -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Distribuci√≥n Temporal de Actividad</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de trades y rendimiento por d√≠a de la semana</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="informe-weekday-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- HEAT MAP: HORA √ó D√çA DE LA SEMANA -->
                <div class="metric-card mb-8">
                    <h3 class="text-lg font-semibold mb-2">üî• Heat Map: Rendimiento por Hora y D√≠a</h3>
                    <p class="text-xs text-text-secondary mb-4">P/L acumulado por hora del d√≠a y d√≠a de la semana - Identifica tus mejores/peores momentos para operar</p>
                    
                    <div id="tiempo-heatmap-container" class="overflow-x-auto">
                        <!-- Heat map se generar√° din√°micamente -->
                    </div>
                    
                    <div class="mt-4 flex items-center justify-center gap-4 text-xs flex-wrap">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: #ff4136;"></div>
                            <span>P√©rdidas grandes</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: #ff8577;"></div>
                            <span>P√©rdidas peque√±as</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: #2a2a2a;"></div>
                            <span>Sin datos</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: #85e085;"></div>
                            <span>Ganancias peque√±as</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: #2ecc40;"></div>
                            <span>Ganancias grandes</span>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Gr√°fico Scatter - Calidad de Ejecuci√≥n -->
                <div class="metric-card mb-8">
                    <h3 class="text-lg font-semibold mb-2">üìä Calidad de Ejecuci√≥n: Duraci√≥n vs Resultado</h3>
                    <p class="text-xs text-text-secondary mb-4">An√°lisis de la relaci√≥n entre tiempo de retenci√≥n y resultado en m√∫ltiplos de riesgo (R). Identifica si cierras muy r√°pido las ganadoras o mantienes mucho tiempo las perdedoras.</p>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="tiempo-execution-quality-scatter"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                        <div class="p-3 bg-surface rounded-lg">
                            <p class="text-text-secondary mb-1">Zona √ìptima</p>
                            <p class="font-bold text-green">Duraci√≥n media con R+ alto</p>
                        </div>
                        <div class="p-3 bg-surface rounded-lg">
                            <p class="text-text-secondary mb-1">Problema Com√∫n</p>
                            <p class="font-bold text-red">P√©rdidas largas (mantener esperanza)</p>
                        </div>
                        <div class="p-3 bg-surface rounded-lg">
                            <p class="text-text-secondary mb-1">Oportunidad</p>
                            <p class="font-bold text-yellow">Ganancias cortas (dejar correr)</p>
                        </div>
                        <div class="p-3 bg-surface rounded-lg">
                            <p class="text-text-secondary mb-1">Total Trades</p>
                            <p id="tiempo-scatter-total-trades" class="font-bold text-white">0</p>
                        </div>
                    </div>
                </div>

                <!-- NUEVAS M√âTRICAS CR√çTICAS DE TIEMPO -->
                <h3 class="text-2xl font-bold mb-4 mt-8">An√°lisis de Exposici√≥n y Sesiones</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Tiempo en Mercado</p>
                        <p class="text-xs text-text-secondary mb-2">Total de horas operando</p>
                        <p id="informe-tiempo-market-exposure" class="text-2xl font-bold text-primary">0h</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Exposici√≥n Promedio/Trade</p>
                        <p class="text-xs text-text-secondary mb-2">Duraci√≥n media en mercado</p>
                        <p id="informe-tiempo-avg-exposure" class="text-2xl font-bold text-white">0h</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Mejor Sesi√≥n</p>
                        <p class="text-xs text-text-secondary mb-2">Sesi√≥n con mayor P/L</p>
                        <p id="informe-tiempo-best-session" class="text-2xl font-bold text-green">N/A</p>
                    </div>
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">Peor Sesi√≥n</p>
                        <p class="text-xs text-text-secondary mb-2">Sesi√≥n con menor P/L</p>
                        <p id="informe-tiempo-worst-session" class="text-2xl font-bold text-red">N/A</p>
                    </div>
                </div>
                
                <!-- Gr√°ficas de Sesiones y Exposici√≥n -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">P/L por Sesi√≥n de Mercado</h3>
                        <p class="text-xs text-text-secondary mb-3">Rendimiento en sesi√≥n Asi√°tica (00-08), Europea (08-16), Americana (16-00)</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-session-pl-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Trades por Sesi√≥n de Mercado</h3>
                        <p class="text-xs text-text-secondary mb-3">Cantidad de operaciones por sesi√≥n</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-session-count-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Tiempo en Mercado: Wins vs Losses</h3>
                        <p class="text-xs text-text-secondary mb-3">Comparaci√≥n de exposici√≥n en operaciones ganadoras y perdedoras</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-exposure-comparison-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Win Rate por Sesi√≥n de Mercado</h3>
                        <p class="text-xs text-text-secondary mb-3">Porcentaje de √©xito en cada sesi√≥n</p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="tiempo-session-winrate-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="informe-graficos-content" class="informe-sub-section-container">
                <div class="mt-6">
                    <h3 class="text-2xl font-bold mb-6 text-white">An√°lisis Visual Avanzado</h3>
                    
                    <!-- RENDIMIENTO TEMPORAL -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-6 text-gray-300">Rendimiento Temporal</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Ganancias por Semana -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Ganancias por Semana</h3>
                                    <p class="text-sm text-text-secondary">Distribuci√≥n de P&L semanal</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Mejor Semana</p>
                                        <p id="best-week-value" class="text-xl font-bold text-green">$0.00</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Peor Semana</p>
                                        <p id="worst-week-value" class="text-xl font-bold text-red">$0.00</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="ganancias-semana-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Ganancias por Mes -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Ganancias por Mes</h3>
                                    <p class="text-sm text-text-secondary">Evoluci√≥n mensual del rendimiento</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Mejor Mes</p>
                                        <p id="best-month-value" class="text-xl font-bold text-green">$0.00</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Peor Mes</p>
                                        <p id="worst-month-value" class="text-xl font-bold text-red">$0.00</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="ganancias-mes-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AN√ÅLISIS DE PATRONES -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-6 text-gray-300">An√°lisis de Patrones</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Posici√≥n (Largo vs Corto) -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Posici√≥n (Largo vs Corto)</h3>
                                    <p class="text-sm text-text-secondary">Distribuci√≥n de direcciones operadas</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Longs</p>
                                        <p id="long-count" class="text-xl font-bold text-green">0</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Shorts</p>
                                        <p id="short-count" class="text-xl font-bold text-red">0</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="posicion-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Operaciones por Hora del D√≠a -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Operaciones por Hora del D√≠a</h3>
                                    <p class="text-sm text-text-secondary">Actividad horaria de trading</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Hora M√°s Activa</p>
                                        <p id="most-active-hour" class="text-xl font-bold text-primary">--:--</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Total Operaciones</p>
                                        <p id="hourly-total-ops" class="text-xl font-bold text-white">0</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="hora-dia-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GESTI√ìN DE RIESGO -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-6 text-gray-300">Gesti√≥n de Riesgo</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Drawdown M√°ximo -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Drawdown M√°ximo</h3>
                                    <p class="text-sm text-text-secondary">Mayor p√©rdida desde el pico</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Drawdown M√°x</p>
                                        <p id="max-drawdown-value" class="text-xl font-bold text-red">$0.00</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Recuperaci√≥n</p>
                                        <p id="drawdown-recovery" class="text-xl font-bold text-green">0%</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="drawdown-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Evoluci√≥n del Balance -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Evoluci√≥n del Balance</h3>
                                    <p class="text-sm text-text-secondary">Progresi√≥n acumulada del P&L</p>
                                </div>
                                <div class="mb-4 grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Balance Inicial</p>
                                        <p id="initial-balance-value" class="text-xl font-bold text-white">$0.00</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg">
                                        <p class="text-xs text-text-secondary mb-1">Balance Actual</p>
                                        <p id="current-balance-value" class="text-xl font-bold text-green">$0.00</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="balance-evolution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- M√âTRICAS CR√çTICAS DE GR√ÅFICOS - REDISE√ëADAS -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-6 text-gray-300">An√°lisis de Consistencia y Volatilidad</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Volatilidad de Retornos Mensuales -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Volatilidad de Retornos Mensuales</h3>
                                    <p class="text-sm text-text-secondary">An√°lisis de consistencia en retornos mes a mes</p>
                                </div>
                                <div class="mb-4 p-4 bg-surface rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-xs text-text-secondary mb-1">Volatilidad</p>
                                            <p id="volatility-value" class="text-2xl font-bold text-primary">$0.00</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs text-text-secondary mb-1">Promedio Mensual</p>
                                            <p id="volatility-avg" class="text-2xl font-bold text-green">$0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="graficos-monthly-volatility-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Resultado Final vs Stop Loss -->
                            <div class="metric-card p-6">
                                <div class="mb-4">
                                    <h3 class="text-xl font-bold text-white mb-2">Resultado Final vs Stop Loss</h3>
                                    <p class="text-sm text-text-secondary">Distribuci√≥n de cierres con TP o SL activado</p>
                                </div>
                                <div class="mb-4 grid grid-cols-3 gap-3">
                                    <div class="p-3 bg-surface rounded-lg text-center">
                                        <p class="text-xs text-text-secondary mb-1">TP Hit</p>
                                        <p id="tp-hit-count" class="text-xl font-bold text-green">0</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg text-center">
                                        <p class="text-xs text-text-secondary mb-1">SL Hit</p>
                                        <p id="sl-hit-count" class="text-xl font-bold text-red">0</p>
                                    </div>
                                    <div class="p-3 bg-surface rounded-lg text-center">
                                        <p class="text-xs text-text-secondary mb-1">Manual</p>
                                        <p id="manual-close-count" class="text-xl font-bold text-blue-400">0</p>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 320px;">
                                    <canvas id="graficos-result-vs-sl-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NUEVA SUBSECCI√ìN: COMISIONES -->
            <div id="informe-comisiones-content" class="informe-sub-section-container">
                <div class="mt-6">
                    <h3 class="text-2xl font-bold mb-6 text-white">An√°lisis de Costos y Comisiones</h3>
                    
                    <!-- M√©tricas Escritas de Comisiones - MEJORADAS -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="metric-card p-6 border-l-4 border-red">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-text-secondary mb-1">Comisiones Totales</p>
                                    <p class="text-xs text-text-secondary">Total pagado en fees</p>
                                </div>
                                <i class="fas fa-dollar-sign text-2xl text-red opacity-50"></i>
                            </div>
                            <p id="comisiones-total" class="text-4xl font-bold text-red mt-3">$0.00</p>
                            <div class="mt-3 pt-3 border-t border-surface-light">
                                <div class="flex justify-between text-xs">
                                    <span class="text-text-secondary">Avg por Trade:</span>
                                    <span id="comisiones-avg-trade-inline" class="font-semibold text-white">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6 border-l-4 border-yellow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-text-secondary mb-1">Impacto en Ganancias</p>
                                    <p class="text-xs text-text-secondary">% de P/L consumido</p>
                                </div>
                                <i class="fas fa-percent text-2xl text-yellow opacity-50"></i>
                            </div>
                            <p id="comisiones-ratio-total" class="text-4xl font-bold text-yellow mt-3">0.00%</p>
                            <div class="mt-3 pt-3 border-t border-surface-light">
                                <div class="flex justify-between text-xs">
                                    <span class="text-text-secondary">Trades Impactados:</span>
                                    <span id="comisiones-impact-winrate" class="font-semibold text-red">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6 border-l-4 border-primary">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-text-secondary mb-1">Promedio Mensual</p>
                                    <p class="text-xs text-text-secondary">Costo por mes</p>
                                </div>
                                <i class="fas fa-calendar text-2xl text-primary opacity-50"></i>
                            </div>
                            <p id="comisiones-per-month" class="text-4xl font-bold text-white mt-3">$0.00</p>
                            <div class="mt-3 pt-3 border-t border-surface-light">
                                <div class="flex justify-between text-xs">
                                    <span class="text-text-secondary">Por D√≠a:</span>
                                    <span id="comisiones-per-day" class="font-semibold text-white">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjetas adicionales -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-sm text-text-secondary">Rango de Comisiones</p>
                                    <p class="text-xs text-text-secondary">M√≠nima y M√°xima</p>
                                </div>
                                <i class="fas fa-arrows-alt-h text-xl text-gray-400"></i>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-surface rounded-lg">
                                    <p class="text-xs text-text-secondary mb-1">M√≠nima</p>
                                    <p id="comisiones-min" class="text-2xl font-bold text-primary">$0.00</p>
                                </div>
                                <div class="p-4 bg-surface rounded-lg">
                                    <p class="text-xs text-text-secondary mb-1">M√°xima</p>
                                    <p id="comisiones-max" class="text-2xl font-bold text-red">$0.00</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-sm text-text-secondary">Estad√≠sticas Adicionales</p>
                                    <p class="text-xs text-text-secondary">Resumen general</p>
                                </div>
                                <i class="fas fa-chart-bar text-xl text-gray-400"></i>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-xs text-text-secondary">Total Trades:</span>
                                    <span id="comisiones-total-trades" class="text-sm font-semibold text-white">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-xs text-text-secondary">Costo Promedio:</span>
                                    <span id="comisiones-avg-trade" class="text-sm font-semibold text-yellow">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-xs text-text-secondary">S√≠mbolos Operados:</span>
                                    <span id="comisiones-symbols-count" class="text-sm font-semibold text-white">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NUEVA M√âTRICA DE BARRA 5: Distribuci√≥n de Comisiones por Rango -->
                    <div class="mb-8">
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Comisiones por Rango</h3>
                            <p class="text-xs text-text-secondary mb-3">Cantidad de trades por rango de comisi√≥n pagada</p>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="informe-commissions-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficas de Comisiones -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-300">An√°lisis de Costos por S√≠mbolo</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">Comisiones Totales por S√≠mbolo</h3>
                                <p class="text-xs text-text-secondary mb-2">Total de comisiones pagadas (Top 15)</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-by-symbol-chart"></canvas>
                                </div>
                            </div>
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">Ratio Comisi√≥n/P/L por S√≠mbolo</h3>
                                <p class="text-xs text-text-secondary mb-2">% de ganancia consumido por comisiones (Top 15)</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-ratio-symbol-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-300">Evoluci√≥n Temporal de Comisiones</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">Comisiones por Mes</h3>
                                <p class="text-xs text-text-secondary mb-2">Evoluci√≥n mensual de fees pagados</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-monthly-chart"></canvas>
                                </div>
                            </div>
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">Comisiones vs P/L Neto</h3>
                                <p class="text-xs text-text-secondary mb-2">Comparaci√≥n de fees con ganancias netas</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-vs-pl-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-300">Distribuci√≥n y Eficiencia</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">Distribuci√≥n de Comisiones</h3>
                                <p class="text-xs text-text-secondary mb-2">Rangos de fees por operaci√≥n</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-distribution-chart"></canvas>
                                </div>
                            </div>
                            <div class="metric-card">
                                <h3 class="text-lg font-semibold mb-2">P/L Neto despu√©s de Comisiones por S√≠mbolo</h3>
                                <p class="text-xs text-text-secondary mb-2">Ganancia real (Top 15)</p>
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="comisiones-net-pl-symbol-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Impact (Barras apiladas) -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-300">Impacto de Comisiones</h4>
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-2">Commission Impact (P/L Bruto vs Neto)</h3>
                            <p class="text-xs text-text-secondary mb-2">Comparaci√≥n de ganancia antes y despu√©s de comisiones por mes</p>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="commission-impact-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DAILY JOURNAL SECTION -->
        <section id="daily-journal" class="section-container">
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <h2 class="text-2xl font-bold">Daily Journal</h2>
                    <div class="flex items-center gap-3 ml-6">
                        <div id="daily-journal-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="daily-journal-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="daily-journal-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Lista de d√≠as (3 columnas) -->
                <div class="lg:col-span-3">
                    <div id="daily-journal-list" class="space-y-4">
                        <!-- Los d√≠as se renderizan aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Panel lateral con calendario (1 columna) -->
                <div class="lg:col-span-1">
                    <div class="metric-card sticky top-4">
                        <h3 class="text-lg font-semibold mb-4">Calendario</h3>
                        <div id="daily-journal-calendar-mini" class="daily-journal-mini-calendar">
                            <!-- Calendario renderizado din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="calendar" class="section-container">
            <div class="section-toolbar">
                <div class="toolbar-left">
                    <div class="flex items-center gap-3">
                        <div id="calendar-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;">
                            <img id="calendar-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain">
                        </div>
                        <select id="calendar-account-select" class="w-48"><option value="all">Todas las cuentas</option></select>
                    </div>
                    
                    <div id="calendar-month-navigation" class="flex items-center">
                        <button id="prev-month" class="mr-2 px-3 py-2"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="current-month" class="text-xl font-semibold mx-4 w-40 text-center">Abril 2025</h2>
                        <button id="next-month" class="ml-2 px-3 py-2"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div class="filter-group">
                        <select id="calendar-currency-select" class="currency-selector">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select id="calendar-view-select" class="currency-selector" style="min-width: 100px;">
                            <option value="general">General</option>
                            <option value="monthly">Mensual</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select id="calendar-year-select" class="currency-selector" style="min-width: 100px;">
                            <!-- A√±os se generan din√°micamente -->
                        </select>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    <button class="action-btn" id="calendar-filters-btn">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <button class="action-btn" id="calendar-download-btn">
                        <i class="fas fa-download"></i>
                        <span>Descargar</span>
                    </button>
                </div>
            </div>
            <div id="monthly-calendar-view">
                <div class="grid grid-cols-8 gap-1 text-center font-bold p-2 mb-1 text-text-secondary text-sm"><div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Semana</div></div>
                <div id="calendar-grid" class="grid grid-cols-8 gap-1"></div>
            </div>
            <div id="yearly-calendar-view" class="hidden">
                <!-- Contenedor para los 12 calendarios -->
            </div>
            <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Resumen Mensual</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">P&L Mensual</h4><p id="monthly-pl" class="text-2xl font-bold text-green">$0.00</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">D√≠as Operados</h4><p id="monthly-trading-days" class="text-2xl font-bold text-white">0</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">D√≠as Ganadores</h4><p id="monthly-winning-days" class="text-2xl font-bold text-green">0</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">D√≠as Perdedores</h4><p id="monthly-losing-days" class="text-2xl font-bold text-red">0</p></div></div></div>
            <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Tendencia Semanal</h3><div class="chart-container"><canvas id="weekly-trend-chart"></canvas></div></div>
        </section>

        <section id="operations" class="section-container">
            <div class="flex flex-wrap justify-between items-center mb-6"><h2 class="text-xl font-semibold">Registro de Operaciones</h2><button id="add-operation-btn" class="primary"><i class="fas fa-plus mr-2"></i>A√±adir Operaci√≥n</button></div>

            <!-- M√©tricas de Performance -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Net Cumulative P&L Card -->
                <div class="metric-card">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="text-text-secondary text-sm mb-1">P&L Bruto Total</p>
                            <p id="ops-cumulative-pl" class="text-3xl font-bold text-success">$0.00</p>
                        </div>
                        <div class="text-success bg-success bg-opacity-10 rounded-lg p-2">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                    </div>
                    <div style="height: 100px; width: 100%; position: relative;">
                        <canvas id="ops-cumulative-chart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-border text-xs">
                        <div>
                            <span class="text-text-secondary block mb-1">Comisiones:</span>
                            <span id="ops-total-fees" class="font-semibold text-red">$0.00</span>
                        </div>
                        <div>
                            <span class="text-text-secondary block mb-1">P&L Neto:</span>
                            <span id="ops-net-pl" class="font-semibold text-success">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Profit Factor Card -->
                <div class="metric-card">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="text-text-secondary text-sm mb-1 flex items-center">
                                Profit Factor
                                <i class="fas fa-info-circle text-xs ml-1 cursor-help" title="Ganancias brutas / P√©rdidas brutas"></i>
                            </p>
                            <p id="ops-profit-factor" class="text-3xl font-bold text-primary">0.00</p>
                        </div>
                        <div class="text-primary bg-primary bg-opacity-10 rounded-lg p-2">
                            <i class="fas fa-balance-scale text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <!-- Gauge visual -->
                        <div class="relative h-3 bg-surface rounded-full overflow-hidden">
                            <div id="ops-pf-gauge" class="h-full transition-all duration-500" style="width: 0%; background: linear-gradient(to right, #ef4444, #eab308, #22c55e);"></div>
                        </div>
                        <div class="flex justify-between text-xs text-text-secondary mt-1">
                            <span>Poor</span>
                            <span>Good</span>
                            <span>Excellent</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-border">
                        <span class="text-xs text-text-secondary">Gross Win</span>
                        <span id="ops-gross-win" class="text-sm font-semibold text-success">$0</span>
                    </div>
                </div>

                <!-- Trade Win % Card -->
                <div class="metric-card">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="text-text-secondary text-sm mb-1">Trade Win %</p>
                            <p id="ops-win-rate" class="text-3xl font-bold text-accent">0%</p>
                        </div>
                        <div class="text-accent bg-accent bg-opacity-10 rounded-lg p-2">
                            <i class="fas fa-bullseye text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <!-- Donut chart simulado -->
                        <div class="relative mx-auto" style="width: 120px; height: 120px;">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    stroke="#2a2a2a"
                                    stroke-width="3"
                                    fill="none"
                                    d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                />
                                <path id="ops-win-circle" class="circle"
                                    stroke="#3b82f6"
                                    stroke-width="3"
                                    stroke-dasharray="0, 100"
                                    stroke-linecap="round"
                                    fill="none"
                                    d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                />
                                <text x="18" y="20.35" class="percentage" fill="#fff" font-size="8" text-anchor="middle" id="ops-win-text">0%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-border">
                        <span class="text-xs text-text-secondary">
                            <i class="fas fa-check-circle text-success mr-1"></i><span id="ops-total-wins">0</span> wins
                        </span>
                        <span class="text-xs text-text-secondary">
                            <i class="fas fa-times-circle text-danger mr-1"></i><span id="ops-total-losses">0</span> losses
                        </span>
                    </div>
                </div>
            </div>

             <div id="add-operation-form" class="metric-card mb-6" style="display: none;"><h3 class="text-lg font-semibold mb-4">Nueva Operaci√≥n</h3><form id="operation-details-form"><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4"><div><label class="block mb-1">Fecha</label><input type="date" id="op-date"></div><div><label class="block mb-1">Cuenta</label><select id="op-account"></select></div><div id="parent-op-container" style="display: none;"><label class="block mb-1">Operaci√≥n Padre (para parciales)</label><select id="op-parent"><option value="">Ninguna</option></select></div><div class="lg:col-span-2"><label class="block mb-1">Instrumento</label><input type="text" id="op-instrument" placeholder="EURUSD, AAPL, etc."></div><div><label class="block mb-1">Precio de Entrada</label><input type="number" id="op-entry" step="any"></div><div><label class="block mb-1">Hora Entrada</label><input type="time" id="op-entry-time"></div><div><label class="block mb-1">Precio de Salida</label><input type="number" id="op-exit" step="any"></div><div><label class="block mb-1">Hora Salida</label><input type="time" id="op-exit-time"></div><div><label class="block mb-1">Volumen</label><input type="number" id="op-volume" step="any"></div><div><label class="block mb-1">Divisa</label><select id="op-currency"><option value="USD">USD</option><option value="EUR">EUR</option><option value="USDT">USDT</option></select></div><div><label class="block mb-1">Tipo</label><select id="op-type"><option value="buy">Compra (Long)</option><option value="sell">Venta (Short)</option></select></div>
                <!-- NUEVO CAMPO: SESI√ìN -->
                <div>
                    <label class="block mb-1">Sesi√≥n</label>
                    <select id="op-session">
                        <option value="">Seleccionar Sesi√≥n</option>
                        <option value="Asia">Asia</option>
                        <option value="Londres">Londres</option>
                        <option value="New York">New York</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <!-- FIN NUEVO CAMPO: SESI√ìN -->
                <!-- NUEVO CAMPO: SETUP USADO -->
                <div>
                    <label class="block mb-1">Setup Usado</label>
                    <select id="op-setup">
                        <option value="">Ninguno</option>
                    </select>
                </div>
                <!-- FIN NUEVO CAMPO: SETUP USADO -->
                <div><label class="block mb-1">Resultado</label><div class="flex"><button type="button" id="op-win-btn" class="flex-1 mr-1 success">Ganancia</button><button type="button" id="op-loss-btn" class="flex-1 ml-1 danger">P√©rdida</button></div></div>
                
                <!-- NOTAS AVANZADAS -->
                <div class="md:col-span-2">
                    <label class="block mb-1">Notas</label>
                    <div style="border: 1px solid #39FF14; border-radius: 5px; padding: 10px; background: #1a1a1a;">
                        <textarea id="op-notes" rows="3" style="width: 100%; background: #0a0a0a; border: 1px solid #333; color: white; padding: 8px; border-radius: 5px; margin-bottom: 10px;"></textarea>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button type="button" id="op-voice-record-btn" style="background: #39FF14; color: black; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: bold;">
                                <i class="fas fa-microphone"></i> Grabar Nota de Voz
                            </button>
                            <span id="op-voice-status" style="color: #888; font-size: 12px;"></span>
                            <audio id="op-voice-playback" controls style="display: none; height: 30px; flex: 1;"></audio>
                        </div>
                        <input type="hidden" id="op-voice-data" />
                    </div>
                </div>
                <!-- FIN NOTAS AVANZADAS -->
                
                <div><label class="block mb-1">P&L Manual (opcional)</label><input type="number" id="op-manual-pl" step="any" placeholder="Sobrescribe P&L calculado"></div><div><label class="block mb-1">Comisiones/Fees</label><input type="number" id="op-fees" step="0.01" placeholder="0.00" title="Comisiones cobradas por el broker"></div><div class="lg:col-span-4"><label class="block mb-1">Adjuntar Im√°genes (M√°x. 5)</label><input type="file" id="op-image" accept="image/png, image/jpeg, image/jpg" multiple><div id="op-image-previews-container" class="mt-2 grid grid-cols-3 sm:grid-cols-5 gap-2"></div></div></div><div class="flex justify-end"><button type="button" id="op-cancel" class="mr-2">Cancelar</button><button type="button" id="op-save" class="primary">Guardar</button></div></form></div>
            <div class="flex flex-wrap justify-between items-end mb-4"><div class="flex flex-wrap items-end space-x-4"><div><label for="filter-account" class="block mb-1 text-sm text-text-secondary">Filtrar por cuenta:</label><div class="flex items-center gap-2"><div id="filter-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center" style="display: none;"><img id="filter-account-logo-img" src="" alt="" class="w-14 h-14 rounded-xl object-contain"></div><select id="filter-account" class="w-56 h-12"><option value="all">Todas las cuentas</option></select></div></div><div class="flex items-end space-x-2"><div><label for="filter-instrument" class="block mb-1 text-sm text-text-secondary">Filtrar por instrumento:</label><input type="text" id="filter-instrument" placeholder="Escribir instrumento..." class="w-56 h-12"></div><button id="operations-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded h-12" title="Filtrar por fecha"><i class="fas fa-calendar-alt"></i></button></div></div></div>
            <div id="operations-date-filter-display" class="date-filter-display-text text-sm text-text-secondary mb-4">Sin filtro de fecha</div>
            <div class="metric-card p-0"><table id="operations-table-render" class="w-full">
                <thead>
                    <tr>
                        <th data-sort="date">Fecha</th>
                        <th data-sort="entryTime">Entrada</th>
                        <th data-sort="exitTime">Salida</th>
                        <th data-sort="accountId">Cuenta</th>
                        <th data-sort="instrument">Instrumento</th>
                        <th data-sort="type">Tipo</th>
                        <th data-sort="entry">Precio E.</th>
                        <th data-sort="exit">Precio S.</th>
                        <th data-sort="volume">Vol.</th>
                        <th data-sort="result">Resultado</th>
                        <th data-sort="pl">P&L</th>
                        <th data-sort="fees">Comis.</th>
                        <th data-sort="currency">Divisa</th>
                        <th data-sort="session">Sesi√≥n</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="operations-table"></tbody>
            </table></div>
        </section>

        <!-- Nueva Secci√≥n de P√°gina Completa para Detalles de Operaci√≥n -->
        <section id="operation-detail-page" class="section-container">
            <button id="back-to-operations-btn" class="mb-4 button"><i class="fas fa-arrow-left mr-2"></i> Volver a Operaciones</button>
            <div class="metric-card p-6">
                <h2 id="op-detail-page-title" class="text-3xl font-bold mb-6 text-primary">Detalles de la Operaci√≥n</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-6 text-sm">
                    <div><strong>ID:</strong> <span id="op-detail-id"></span></div>
                    <div><strong>Fecha:</strong> <span id="op-detail-date"></span></div>
                    <div><strong>Cuenta:</strong> <span id="op-detail-account"></span></div>
                    <div><strong>Instrumento:</strong> <span id="op-detail-instrument"></span></div>
                    <div><strong>Tipo:</strong> <span id="op-detail-type"></span></div>
                    <div><strong>Entrada:</strong> <span id="op-detail-entry"></span></div>
                    <div><strong>Hora Entrada:</strong> <span id="op-detail-entry-time"></span></div>
                    <div><strong>Salida:</strong> <span id="op-detail-exit"></div>
                    <div><strong>Hora Salida:</strong> <span id="op-detail-exit-time"></span></div>
                    <div><strong>Volumen:</strong> <span id="op-detail-volume"></span></div>
                    <div><strong>Divisa:</strong> <span id="op-detail-currency"></span></div>
                    <div><strong>P&L Manual:</strong> <span id="op-detail-manual-pl"></span></div>
                    <div><strong>Comisi√≥n/Fee:</strong> <span id="op-detail-fee" class="text-red font-semibold"></span></div>
                    <div><strong>Sesi√≥n:</strong> <span id="op-detail-session"></span></div>
                    <div><strong>Setup Usado:</strong> <span id="op-detail-setup"></span></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="metric-card text-center">
                        <h4 class="text-sm text-text-secondary mb-1">Resultado</h4>
                        <p id="op-detail-result" class="text-xl font-bold"></p>
                    </div>
                    <div class="metric-card text-center">
                        <h4 class="text-sm text-text-secondary mb-1">P&L Bruto</h4>
                        <p id="op-detail-pl" class="text-xl font-bold"></p>
                    </div>
                    <div class="metric-card text-center">
                        <h4 class="text-sm text-text-secondary mb-1">P&L Neto (despu√©s fee)</h4>
                        <p id="op-detail-net-pl" class="text-xl font-bold"></p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Notas:</h3>
                    <!-- Pesta√±as para notas -->
                    <div class="border border-border rounded-lg bg-surface">
                        <div class="flex border-b border-border">
                            <button class="notes-tab-btn px-4 py-2 text-sm bg-primary text-black border-r border-border active" data-tab="view">
                                Ver Notas
                            </button>
                            <button class="notes-tab-btn px-4 py-2 text-sm hover:bg-surface-light border-r border-border" data-tab="edit">
                                Editar Notas
                            </button>
                        </div>
                        <div class="p-4">
                            <div id="notes-view-content" class="notes-tab-content active">
                                <p id="op-detail-notes" class="text-sm whitespace-pre-wrap min-h-[80px]"></p>
                            </div>
                            <div id="notes-edit-content" class="notes-tab-content hidden">
                                <div id="op-detail-rich-editor-container"></div>
                                <div class="flex gap-2 mt-3">
                                    <button id="save-notes-btn" class="px-4 py-2 bg-success text-white rounded text-sm hover:bg-success/80">
                                        Guardar Notas
                                    </button>
                                    <button id="cancel-notes-btn" class="px-4 py-2 bg-surface-light text-text rounded text-sm hover:bg-surface">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Im√°genes Adjuntas:</h3>
                    <!-- Pesta√±as para im√°genes -->
                    <div class="border border-border rounded-lg bg-surface">
                        <div class="flex border-b border-border">
                            <button class="images-tab-btn px-4 py-2 text-sm bg-primary text-black border-r border-border active" data-tab="view">
                                Ver Im√°genes
                            </button>
                            <button class="images-tab-btn px-4 py-2 text-sm hover:bg-surface-light border-r border-border" data-tab="add">
                                Agregar Im√°genes
                            </button>
                        </div>
                        <div class="p-4">
                            <div id="images-view-content" class="images-tab-content active">
                                <div id="op-detail-images" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" style="display: grid !important; min-height: 200px;">
                                    <p class="text-sm text-text-secondary md:col-span-3 text-center">No hay im√°genes adjuntas.</p>
                                </div>
                            </div>
                            <div id="images-add-content" class="images-tab-content hidden">
                                <div class="border-2 border-dashed border-border rounded-lg p-8 text-center">
                                    <input type="file" id="op-detail-image-input" multiple accept="image/*" class="hidden">
                                    <div id="drop-zone" class="cursor-pointer" onclick="document.getElementById('op-detail-image-input').click()">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-text-secondary mb-2"></i>
                                        <p class="text-text-secondary mb-2">Haz clic aqu√≠ o arrastra im√°genes</p>
                                        <p class="text-xs text-text-secondary">PNG, JPG, GIF hasta 10MB cada una</p>
                                    </div>
                                </div>
                                <div id="selected-images-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3 hidden">
                                    <!-- Preview de im√°genes seleccionadas -->
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button id="upload-images-btn" class="px-4 py-2 bg-success text-white rounded text-sm hover:bg-success/80 hidden">
                                        Guardar Im√°genes
                                    </button>
                                    <button id="cancel-images-btn" class="px-4 py-2 bg-surface-light text-text rounded text-sm hover:bg-surface">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de Gr√°fico de TradingView -->
                <div class="mb-6" id="op-detail-chart-section">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Gr√°fico de Trading</h3>
                    </div>

                    <!-- Panel de informaci√≥n -->
                    <div class="bg-surface border border-border rounded-lg overflow-hidden mb-4">
                        <div class="bg-background p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-green-500 bg-opacity-20">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M8 2L14 14H2L8 2Z" fill="#10B981" stroke="#059669" stroke-width="1.5"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <span class="text-green-400 font-semibold">ENTRADA:</span>
                                        <span id="chart-entry-price" class="ml-2 text-white font-bold">-</span>
                                        <div id="chart-entry-time" class="text-xs text-text-secondary">-</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-red-500 bg-opacity-20">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M8 14L2 2H14L8 14Z" fill="#EF4444" stroke="#DC2626" stroke-width="1.5"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <span class="text-red-400 font-semibold">SALIDA:</span>
                                        <span id="chart-exit-price" class="ml-2 text-white font-bold">-</span>
                                        <div id="chart-exit-time" class="text-xs text-text-secondary">-</div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-center">
                                    <div>
                                        <span class="text-text-secondary text-xs">P&L:</span>
                                        <span id="chart-pl-display" class="ml-2 font-bold text-lg">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TradingView Widget Avanzado -->
                    <div class="bg-surface border border-border rounded-lg overflow-hidden relative chart-info">
                        <!-- Contenedor del widget avanzado -->
                        <div id="tradingview-widget" style="width: 100%; height: 650px;"></div>
                    </div>
                </div>

                <!-- Secci√≥n de Parciales -->
                <div class="mb-6" id="op-detail-partials-section">
                    <h3 class="text-lg font-semibold mb-4">Posici√≥n y Parciales</h3>
                    <div class="bg-surface border border-border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-background border-b border-border">
                                        <th class="text-left p-3 font-semibold">Descripci√≥n</th>
                                        <th class="text-left p-3 font-semibold">Hora Entrada</th>
                                        <th class="text-left p-3 font-semibold">Hora Salida</th>
                                        <th class="text-left p-3 font-semibold">Precio Entrada</th>
                                        <th class="text-left p-3 font-semibold">Precio Salida</th>
                                        <th class="text-left p-3 font-semibold">Volumen</th>
                                        <th class="text-left p-3 font-semibold">P&L</th>
                                    </tr>
                                </thead>
                                <tbody id="op-detail-partials-table">
                                    <!-- Los parciales se llenar√°n din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico de Curva P&L -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-3">Curva de P&L de la Operaci√≥n</h3>
                        <div class="bg-surface border border-border rounded-lg p-4">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="operation-pnl-curve-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">An√°lisis de Sesi√≥n:</h3>
                    <p class="text-sm mb-3">Esta operaci√≥n se inici√≥ durante la sesi√≥n de: <span id="op-detail-session-current" class="font-bold text-primary">N/A</span></p>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Sesi√≥n</th>
                                    <th>P&L Total</th>
                                    <th>Comisiones</th>
                                    <th>P&L Neto</th>
                                    <th>Trades</th>
                                    <th>Win %</th>
                                </tr>
                            </thead>
                            <tbody id="op-detail-session-metrics">
                                <!-- Las m√©tricas de sesi√≥n se rellenar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- CHARTBOOK SECTION -->
        <section id="chartbook" class="section-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">üìä Chartbook - Galer√≠a de Trades</h2>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center gap-2">
                        <div id="chartbook-account-logo" class="w-14 h-14 rounded-xl flex items-center justify-center">
                            <img id="chartbook-account-logo-img" src="/logos/primexbt-logo.png" alt="" style="width: 56px; height: 56px; object-fit: contain;" class="rounded-xl">
                        </div>
                        <select id="chartbook-account-select" class="w-48">
                            <option value="all">Todas las cuentas</option>
                        </select>
                    </div>
                    <select id="chartbook-filter" class="currency-selector">
                        <option value="all">Todos los trades</option>
                        <option value="wins">Solo victorias</option>
                        <option value="losses">Solo p√©rdidas</option>
                        <option value="with-images">Con im√°genes</option>
                    </select>
                </div>
            </div>
            
            <div id="chartbook-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="metric-card p-4">
                    <p class="text-sm text-text-secondary">Total Trades</p>
                    <p id="chartbook-total-trades" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="metric-card p-4">
                    <p class="text-sm text-text-secondary">Con Im√°genes</p>
                    <p id="chartbook-with-images" class="text-2xl font-bold text-primary">0</p>
                </div>
                <div class="metric-card p-4">
                    <p class="text-sm text-text-secondary">Victorias</p>
                    <p id="chartbook-wins" class="text-2xl font-bold text-positive">0</p>
                </div>
                <div class="metric-card p-4">
                    <p class="text-sm text-text-secondary">P√©rdidas</p>
                    <p id="chartbook-losses" class="text-2xl font-bold text-negative">0</p>
                </div>
            </div>

            <div id="chartbook-container" class="space-y-4">
                <!-- Trades con im√°genes se renderizar√°n aqu√≠ -->
            </div>
        </section>

        <!-- PLAYBOOK SECTION -->
        <section id="playbook" class="section-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">üìñ Playbook - Mis Setups de Trading</h2>
                <button id="add-setup-btn" class="primary">
                    <i class="fas fa-plus mr-2"></i>Nuevo Setup
                </button>
            </div>

            <div id="playbook-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="metric-card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm text-text-secondary">Total Setups</p>
                        <i class="fas fa-book text-primary"></i>
                    </div>
                    <p id="playbook-total-setups" class="text-3xl font-bold text-white">0</p>
                    <p id="playbook-by-category" class="text-xs text-text-secondary mt-1">Por categor√≠a</p>
                </div>
                <div class="metric-card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm text-text-secondary">Rating Promedio</p>
                        <i class="fas fa-star text-yellow"></i>
                    </div>
                    <p id="playbook-avg-rating" class="text-3xl font-bold text-yellow">0.0</p>
                    <div id="playbook-rating-stars" class="text-sm mt-1">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                </div>
                <div class="metric-card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm text-text-secondary">M√°s Usado</p>
                        <i class="fas fa-fire text-red"></i>
                    </div>
                    <p id="playbook-most-used-name" class="text-lg font-bold text-white truncate">-</p>
                    <p id="playbook-most-used-count" class="text-xs text-text-secondary mt-1">0 veces</p>
                </div>
                <div class="metric-card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm text-text-secondary">Mejor Winrate</p>
                        <i class="fas fa-trophy text-success"></i>
                    </div>
                    <p id="playbook-best-wr-name" class="text-lg font-bold text-success truncate">-</p>
                    <p id="playbook-best-wr-value" class="text-xs text-text-secondary mt-1">0%</p>
                </div>
            </div>

            <!-- Performance Table por Setup -->
            <div class="metric-card mb-6" id="playbook-performance-section" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üìä Rendimiento por Setup</h3>
                    <button id="toggle-performance-table" class="text-sm text-primary hover:underline">
                        <i class="fas fa-chart-bar mr-1"></i>Ver Estad√≠sticas
                    </button>
                </div>
                <div id="playbook-performance-table-container" style="display:none;">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-border">
                                    <th class="text-left p-2">Setup</th>
                                    <th class="text-center p-2">Trades</th>
                                    <th class="text-center p-2">Winrate</th>
                                    <th class="text-center p-2">Avg Win</th>
                                    <th class="text-center p-2">Avg Loss</th>
                                    <th class="text-center p-2">P/L Total</th>
                                    <th class="text-center p-2">Profit Factor</th>
                                    <th class="text-center p-2">√öltima Vez</th>
                                </tr>
                            </thead>
                            <tbody id="playbook-performance-tbody">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal para agregar/editar setup -->
            <div id="setup-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold" id="setup-modal-title">Nuevo Setup</h3>
                        <button id="close-setup-modal" class="text-2xl">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block mb-1">Nombre del Setup *</label>
                            <input type="text" id="setup-name" placeholder="Ej: Breakout Pullback" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-1">Categor√≠a</label>
                            <select id="setup-category" class="w-full">
                                <option value="breakout">Breakout</option>
                                <option value="pullback">Pullback</option>
                                <option value="reversal">Reversal</option>
                                <option value="continuation">Continuation</option>
                                <option value="scalping">Scalping</option>
                                <option value="swing">Swing</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-1">Rating (1-5 estrellas) *</label>
                        <div id="setup-rating-selector" class="flex items-center space-x-2">
                            <span class="star" data-value="1">‚≠ê</span>
                            <span class="star" data-value="2">‚≠ê</span>
                            <span class="star" data-value="3">‚≠ê</span>
                            <span class="star" data-value="4">‚≠ê</span>
                            <span class="star" data-value="5">‚≠ê</span>
                            <span id="setup-rating-value" class="ml-2 text-sm text-gray-400">(Selecciona rating)</span>
                        </div>
                        <input type="hidden" id="setup-rating" value="0">
                    </div>

                    <div class="mb-4">
                        <label class="block mb-1">Descripci√≥n / Reglas del Setup *</label>
                        <div id="setup-rich-editor-container"></div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-1">Im√°genes (Ejemplos del setup)</label>
                        <input type="file" id="setup-images" accept="image/*" multiple class="w-full">
                        <p class="text-xs text-gray-400 mt-1">Puedes subir hasta 4 im√°genes</p>
                        <div id="setup-images-preview" class="grid grid-cols-2 gap-2 mt-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-1">Tags</label>
                        <input type="text" id="setup-tags" placeholder="Ej: high-probability, morning, news" class="w-full">
                        <p class="text-xs text-gray-400 mt-1">Separa con comas</p>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button id="cancel-setup-btn" class="mr-2">Cancelar</button>
                        <button id="save-setup-btn" class="primary">Guardar Setup</button>
                    </div>
                </div>
            </div>

            <div id="playbook-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Setups se renderizar√°n aqu√≠ -->
            </div>
        </section>

        <!-- MODAL: Agregar/Editar Cuenta Funded -->
        <div id="funded-account-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" id="funded-modal-title">Nueva Cuenta Funded</h3>
                    <button id="close-funded-modal" class="text-2xl hover:text-primary">&times;</button>
                </div>

                <form id="funded-account-form">
                    <input type="hidden" id="funded-account-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Nombre de la Cuenta -->
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-sm font-medium">Nombre de la Cuenta *</label>
                            <input type="text" id="funded-name" placeholder="Ej: FTPROPLUS77156392084" required class="w-full">
                        </div>

                        <!-- Empresa (Prop Firm) -->
                        <div>
                            <label class="block mb-1 text-sm font-medium">Empresa (Prop Firm) *</label>
                            <select id="funded-company" required class="w-full">
                                <option value="">Seleccionar...</option>
                                <option value="Funding Ticks">Funding Ticks</option>
                                <option value="Alpha Futures">Alpha Futures</option>
                                <option value="Topstep">Topstep</option>
                                <option value="My Funded Futures">My Funded Futures</option>
                                <option value="Earn2Trade">Earn2Trade</option>
                                <option value="The Trading Pit">The Trading Pit</option>
                                <option value="Apex Trader Funding">Apex Trader Funding</option>
                                <option value="Take Profit Trader">Take Profit Trader</option>
                                <option value="Tradeify">Tradeify</option>
                                <option value="TheSers">TheSers</option>
                                <option value="Otra">Otra (personalizada)</option>
                            </select>
                        </div>

                        <!-- Empresa personalizada (si selecciona "Otra") -->
                        <div id="funded-custom-company-container" style="display: none;">
                            <label class="block mb-1 text-sm font-medium">Nombre de la Empresa</label>
                            <input type="text" id="funded-custom-company" placeholder="Nombre personalizado" class="w-full">
                        </div>

                        <!-- Tipo de Cuenta -->
                        <div>
                            <label class="block mb-1 text-sm font-medium">Tipo de Cuenta *</label>
                            <select id="funded-type" required class="w-full">
                                <option value="evaluation">Evaluaci√≥n</option>
                                <option value="live">Live</option>
                            </select>
                        </div>

                        <!-- Estado -->
                        <div>
                            <label class="block mb-1 text-sm font-medium">Estado *</label>
                            <select id="funded-status" required class="w-full">
                                <option value="active">Activa</option>
                                <option value="suspended">Suspendida</option>
                            </select>
                        </div>

                        <!-- Tarifa de Activaci√≥n (Gastos) -->
                        <div>
                            <label class="block mb-1 text-sm font-medium">Tarifa de Activaci√≥n (‚Ç¨) *</label>
                            <input type="number" id="funded-fee" step="0.01" placeholder="0.00" required class="w-full">
                            <p class="text-xs text-text-secondary mt-1">Coste de la evaluaci√≥n o cuenta</p>
                        </div>

                        <!-- Fecha de Activaci√≥n -->
                        <div>
                            <label class="block mb-1 text-sm font-medium">Fecha de Activaci√≥n *</label>
                            <input type="date" id="funded-activation-date" required class="w-full">
                        </div>

                        <!-- Ganancias (solo para live) -->
                        <div id="funded-earnings-container" style="display: none;">
                            <label class="block mb-1 text-sm font-medium">Ganancias Acumuladas (‚Ç¨)</label>
                            <input type="number" id="funded-earnings" step="0.01" placeholder="0.00" class="w-full">
                            <p class="text-xs text-text-secondary mt-1">Total de retiros realizados</p>
                        </div>

                        <!-- N√∫mero de Retiros -->
                        <div id="funded-withdrawals-container" style="display: none;">
                            <label class="block mb-1 text-sm font-medium">N√∫mero de Retiros</label>
                            <input type="number" id="funded-withdrawals-count" placeholder="0" min="0" class="w-full">
                        </div>

                        <!-- Notas (opcional) -->
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-sm font-medium">Notas (Opcional)</label>
                            <textarea id="funded-notes" rows="3" placeholder="Observaciones, objetivos, estrategias..." class="w-full"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" id="cancel-funded-account" class="px-4 py-2 bg-surface hover:bg-surface-hover rounded">
                            Cancelar
                        </button>
                        <button type="submit" class="primary px-6 py-2">
                            <i class="fas fa-save mr-2"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL DE AN√ÅLISIS DEL D√çA / NOTEBOOK DEL D√çA -->
        <div id="day-analysis-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto;">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-background z-10 pb-4 border-b border-border">
                    <div>
                        <h3 class="text-2xl font-semibold" id="day-analysis-title">An√°lisis del D√≠a</h3>
                        <p class="text-sm text-text-secondary mt-1" id="day-analysis-date"></p>
                    </div>
                    <button id="close-day-analysis-modal" class="text-2xl hover:text-primary">&times;</button>
                </div>

                <!-- Resumen del d√≠a -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Net P&L</p>
                        <p id="day-analysis-net-pl" class="text-xl font-bold">$0.00</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Trades</p>
                        <p id="day-analysis-trades" class="text-xl font-bold">0</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Winners</p>
                        <p id="day-analysis-winners" class="text-xl font-bold text-green">0</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Losers</p>
                        <p id="day-analysis-losers" class="text-xl font-bold text-red">0</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Winrate</p>
                        <p id="day-analysis-winrate" class="text-xl font-bold text-primary">0%</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Gross P&L</p>
                        <p id="day-analysis-gross-pl" class="text-xl font-bold">$0.00</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Comisiones</p>
                        <p id="day-analysis-commissions" class="text-xl font-bold">$0.00</p>
                    </div>
                    <div class="metric-card p-4 text-center">
                        <p class="text-xs text-text-secondary mb-1">Profit Factor</p>
                        <p id="day-analysis-pf" class="text-xl font-bold">0.00</p>
                    </div>
                </div>

                <!-- Pesta√±as -->
                <div class="border border-border rounded-lg bg-surface mb-6">
                    <div class="flex border-b border-border">
                        <button class="day-analysis-tab-btn px-6 py-3 text-sm bg-primary text-black border-r border-border active" data-tab="notes">
                            <i class="fas fa-sticky-note mr-2"></i>Notas
                        </button>
                        <button class="day-analysis-tab-btn px-6 py-3 text-sm hover:bg-surface-light border-r border-border" data-tab="images">
                            <i class="fas fa-images mr-2"></i>Im√°genes Adjuntas
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Tab: Notas -->
                        <div id="day-analysis-notes-content" class="day-analysis-tab-content active">
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-lg font-semibold">Notas del D√≠a</h4>
                                    <button id="day-analysis-edit-notes-btn" class="btn-secondary">
                                        <i class="fas fa-edit mr-2"></i>Editar Notas
                                    </button>
                                </div>
                                <div id="day-analysis-notes-view" class="min-h-[200px] p-4 bg-background border border-border rounded">
                                    <p class="text-text-secondary italic">Sin notas agregadas para este d√≠a.</p>
                                </div>
                                <div id="day-analysis-notes-edit" class="hidden">
                                    <div id="day-analysis-rich-editor-container"></div>
                                    <div class="flex gap-2 mt-3">
                                        <button id="day-analysis-save-notes-btn" class="btn-primary">
                                            <i class="fas fa-save mr-2"></i>Guardar Notas
                                        </button>
                                        <button id="day-analysis-cancel-notes-btn" class="btn-secondary">
                                            <i class="fas fa-times mr-2"></i>Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab: Im√°genes -->
                        <div id="day-analysis-images-content" class="day-analysis-tab-content hidden">
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-lg font-semibold">Im√°genes del D√≠a</h4>
                                    <button id="day-analysis-add-images-btn" class="btn-primary">
                                        <i class="fas fa-plus mr-2"></i>Agregar Im√°genes
                                    </button>
                                </div>
                                <div id="day-analysis-images-view" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    <!-- Im√°genes se renderizan aqu√≠ -->
                                </div>
                                <div id="day-analysis-images-upload" class="hidden">
                                    <input type="file" id="day-analysis-image-input" accept="image/*" multiple class="mb-3">
                                    <div id="day-analysis-image-preview" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-3">
                                        <!-- Preview de im√°genes -->
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="day-analysis-upload-images-btn" class="btn-primary">
                                            <i class="fas fa-upload mr-2"></i>Subir Im√°genes
                                        </button>
                                        <button id="day-analysis-cancel-images-btn" class="btn-secondary">
                                            <i class="fas fa-times mr-2"></i>Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section id="accounts" class="section-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Gesti√≥n de Cuentas</h2>
                <div class="flex items-center space-x-2">
                    <button id="add-account-btn" class="primary"><i class="fas fa-plus mr-2"></i>Agregar Cuenta</button>
                    <!-- Toggle to hide amounts for streaming -->
                    <button id="toggle-hide-amounts" class="p-2 rounded border" title="Ocultar importes (stream)" aria-pressed="false" style="display:inline-flex;align-items:center;justify-content:center;">
                        <i id="toggle-hide-amounts-icon" class="fas fa-eye-slash" aria-hidden="true" style="width:16px; height:16px;"></i>
                        <span class="sr-only">Ocultar importes</span>
                    </button>
                </div>
            </div>

            <!-- Modal de selecci√≥n de broker (pantalla completa) -->
            <div id="broker-selection-modal" style="display: none;">
                <!-- Este div ahora se mostrar√° dentro de la secci√≥n accounts reemplazando todo -->
            </div>

            <!-- Modal de configuraci√≥n de cuenta -->
            <div id="account-config-modal" class="fixed inset-0 z-[9999] flex items-center justify-center" style="display: none; background-color: rgba(10, 10, 15, 0.98);">
                <div class="bg-surface rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-bold mb-1">Add Trades</h3>
                                <p class="text-text-secondary text-sm">Configure your trading account</p>
                            </div>
                            <button id="close-account-modal" class="text-text-secondary hover:text-white transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-6">
                        <!-- Plataforma seleccionada -->
                        <div class="bg-surface-light rounded-lg p-4 mb-6 flex items-center">
                            <div id="selected-broker-logo" class="w-16 h-16 rounded-xl mr-4 overflow-hidden">
                                <!-- Logo din√°mico -->
                            </div>
                            <div>
                                <p class="text-sm text-text-secondary">Selected Broker</p>
                                <p id="selected-broker-name" class="text-lg font-semibold">-</p>
                            </div>
                        </div>

                        <!-- Formulario -->
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium">Account Name</label>
                                <input type="text" id="acc-name-modal" placeholder="FTMO, PropFirm, etc." class="w-full bg-background border border-border rounded-lg px-4 py-3 focus:outline-none focus:border-primary">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium">Initial Balance</label>
                                    <input type="number" id="acc-balance-modal" step="0.01" placeholder="100000" class="w-full bg-background border border-border rounded-lg px-4 py-3 focus:outline-none focus:border-primary">
                                </div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium">Currency</label>
                                    <select id="acc-currency-modal" class="w-full bg-background border border-border rounded-lg px-4 py-3 focus:outline-none focus:border-primary">
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="USDT">USDT</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Campos espec√≠ficos para Tradovate -->
                            <div id="tradovate-fields-modal" style="display: none;">
                                <div class="bg-surface-light border border-primary rounded-lg p-4">
                                    <h4 class="text-sm font-semibold mb-3 flex items-center">
                                        <i class="fas fa-key mr-2 text-primary"></i>Tradovate Credentials
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block mb-1 text-sm">Tradovate Username</label>
                                            <input type="text" id="tradovate-username-modal" placeholder="TDU19938704" class="w-full bg-background border border-border rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                        </div>
                                        <div>
                                            <label class="block mb-1 text-sm">Password</label>
                                            <input type="password" id="tradovate-password-modal" placeholder="Password" class="w-full bg-background border border-border rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                        </div>
                                        <div>
                                            <label class="block mb-1 text-sm">Account ID</label>
                                            <input type="text" id="tradovate-account-id-modal" placeholder="FTPROPLUS095027643815" class="w-full bg-background border border-border rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                        </div>
                                        <div class="flex items-center">
                                            <label class="flex items-center cursor-pointer">
                                                <input type="checkbox" id="tradovate-auto-sync-modal" class="mr-2">
                                                <span class="text-sm">Auto sync</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 border-t border-border flex justify-end space-x-3">
                        <button id="cancel-account-modal" class="px-6 py-3 rounded-lg border border-border hover:bg-surface-light transition-colors">Cancel</button>
                        <button id="save-account-modal" class="px-6 py-3 rounded-lg bg-primary hover:bg-primary-dark transition-colors font-semibold">Continue</button>
                    </div>
                </div>
            </div>

            <!-- Formulario antiguo (oculto, mantener por compatibilidad) -->
            <div id="add-account-form" class="metric-card mb-6" style="display: none;"><h3 class="text-lg font-semibold mb-4">Nueva Cuenta</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block mb-1">Nombre de la cuenta</label><input type="text" id="acc-name" placeholder="FTMO, PropFirm, etc."></div><div><label class="block mb-1">Balance inicial</label><input type="number" id="acc-balance" step="0.01" placeholder="100000"></div><div><label class="block mb-1">Divisa</label><select id="acc-currency"><option value="USD">USD</option><option value="EUR">EUR</option><option value="USDT">USDT</option></select></div><div><label class="block mb-1">Plataforma</label><select id="acc-platform"><option value="meta-trader-4">Meta Trader 4</option><option value="meta-trader-5">Meta Trader 5</option><option value="ninjatrader">NinjaTrader 8</option><option value="ctrader">cTrader</option><option value="tradingview">TradingView</option><option value="tradovate">Tradovate</option><option value="bingx">BingX</option><option value="bitget">Bitget</option><option value="mexc">MEXC</option><option value="primexbt-crypto">PrimeXBT Crypto</option><option value="primexbt-cfds">PrimeXBT CFDs</option><option value="bitunix">Bitunix</option><option value="other">Otra</option></select></div></div>
            
            <!-- Campos espec√≠ficos para Tradovate -->
            <div id="tradovate-fields" class="mb-4" style="display: none;">
                <div class="bg-surface-light border border-primary rounded-lg p-4">
                    <h4 class="text-sm font-semibold mb-3 flex items-center">
                        <i class="fas fa-key mr-2 text-primary"></i>Credenciales de Tradovate
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-sm">Usuario Tradovate</label>
                            <input type="text" id="tradovate-username" placeholder="TDU19938704" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm">Contrase√±a</label>
                            <input type="password" id="tradovate-password" placeholder="Contrase√±a" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm">Account ID</label>
                            <input type="text" id="tradovate-account-id" placeholder="FTPROPLUS095027643815" class="w-full">
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="tradovate-auto-sync" class="mr-2">
                                <span class="text-sm">Sincronizaci√≥n autom√°tica</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-text-secondary">
                        <i class="fas fa-info-circle mr-1"></i>
                        Los trades se importar√°n autom√°ticamente desde tu cuenta de Tradovate
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end"><button id="acc-cancel" class="mr-2">Cancelar</button><button id="acc-save" class="primary">Guardar</button></div></div>
            
            <!-- Contenedor principal de cuentas -->
            <div id="accounts-main-container">
                <div id="accounts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Pantalla de selecci√≥n de broker (reemplaza accounts-main-container) -->
            <div id="broker-selection-screen" style="display: none;">
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <p class="text-text-secondary text-sm mb-1">Add Trades</p>
                            <h2 class="text-3xl font-bold">Choose Broker</h2>
                        </div>
                        <button id="close-broker-screen" class="text-text-secondary hover:text-white transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <!-- Buscador -->
                    <div class="mb-8">
                        <div class="relative">
                            <input type="text" id="broker-search" placeholder="Start typing for broker name" class="w-full bg-surface border border-border rounded-lg px-4 py-3 pl-12 focus:outline-none focus:border-primary text-white">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-text-secondary"></i>
                        </div>
                    </div>

                    <!-- Popular Brokers -->
                    <div class="mb-8">
                        <h3 class="text-sm font-semibold mb-4 text-text-secondary">Popular Brokers</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="broker-grid">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Otros brokers (dropdown) -->
                    <div>
                        <button id="show-all-brokers-btn" class="w-full bg-surface hover:bg-surface-light border border-border rounded-lg px-4 py-3 text-left flex items-center justify-between transition-colors">
                            <span class="text-sm font-medium">Show all brokers</span>
                            <i class="fas fa-chevron-down text-text-secondary"></i>
                        </button>
                        <div id="all-brokers-list" class="mt-2 bg-surface border border-border rounded-lg overflow-hidden" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Bot√≥n Continue -->
                    <div class="mt-12">
                        <button class="w-full bg-surface hover:bg-surface-light text-text-secondary py-3 rounded-lg transition-colors" disabled>
                            Continue
                        </button>
                    </div>
                </div>
            </div>
            <div id="selected-account-details" class="mt-8" style="display: none;">
                <h3 id="account-detail-name" class="text-xl font-semibold mb-4">Detalles de la Cuenta</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 class="text-lg font-semibold">Evoluci√≥n de la Cuenta</h3>
                            <button onclick="openFullscreenChart('account-detail-chart', 'Evoluci√≥n de la Cuenta - Detalles')" style="background: #39FF14; color: black; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold;">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        <div class="time-range-buttons mb-3 text-sm" id="account-detail-time-range">
                            <button data-range="1W" class="time-range-btn">1S</button>
                            <button data-range="1M" class="time-range-btn">1M</button>
                            <button data-range="3M" class="time-range-btn">3M</button>
                            <button data-range="6M" class="time-range-btn">6M</button>
                            <button data-range="1Y" class="time-range-btn">1A</button>
                            <button data-range="ALL" class="time-range-btn active">Todo</button>
                        </div>
                        <div class="chart-container"><canvas id="account-detail-chart"></canvas></div>
                    </div>
                    <div class="metric-card p-6">
                        <h3 class="text-lg font-semibold mb-4">M√©tricas de la Cuenta</h3>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-4">
                            <div><p class="text-sm text-text-secondary">P&L Total</p><p id="account-detail-pl" class="text-2xl font-bold">$0.00</p></div>
                            <div><p class="text-sm text-text-secondary">Win Rate</p><p id="account-detail-winrate" class="text-2xl font-bold">0%</p></div>
                            <div><p class="text-sm text-text-secondary">Operaciones</p><p id="account-detail-trades" class="text-2xl font-bold">0</p></div>
                            <div><p class="text-sm text-text-secondary">Profit Factor</p><p id="account-detail-pf" class="text-2xl font-bold">0.00</p></div>
                        </div>
                        <h3 class="text-lg font-semibold mb-2 mt-4">Puntuaci√≥n de Rendimiento</h3>
                        <div class="chart-container" style="height: 220px;">
                            <canvas id="account-detail-radar-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="metric-card xl:col-span-1">
                        <h3 class="text-lg font-semibold mb-3">Estad√≠sticas Adicionales</h3>
                        <dl class="space-y-3 text-sm">
                            <div class="flex justify-between"><dt>Drawdown M√°ximo:</dt><dd id="account-detail-drawdown" class="font-semibold text-red">$0.00 (0%)</dd></div>
                            <div class="flex justify-between"><dt>Ratio Ganancia/P√©rdida Prom:</dt><dd id="account-detail-avg-w-l-ratio" class="font-semibold">0.00</dd></div>
                            <div class="flex justify-between"><dt>Racha Ganadora M√°x:</dt><dd id="account-detail-win-streak" class="font-semibold">0</dd></div>
                            <div class="flex justify-between"><dt>Racha Perdedora M√°x:</dt><dd id="account-detail-loss-streak" class="font-semibold">0</dd></div>
                            <div class="flex justify-between"><dt>Tiempo Prom. por Operaci√≥n:</dt><dd id="account-detail-hold-time" class="font-semibold">N/A</dd></div>
                        </dl>
                        <h3 class="text-lg font-semibold mt-6 mb-3">An√°lisis Long/Short</h3>
                        <table class="w-full text-xs"><thead><tr><th>Tipo</th><th>Trades</th><th>P&L</th><th>Win%</th></tr></thead><tbody id="account-long-short-analysis"></tbody></table>
                    </div>
                    <div class="metric-card xl:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-2">Mejores Operaciones</h3><table class="w-full"><thead><tr><th>Fecha</th><th>Instrumento</th><th>P&L</th></tr></thead><tbody id="best-trades"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-2">Peores Operaciones</h3><table class="w-full"><thead><tr><th>Fecha</th><th>Instrumento</th><th>P&L</th></tr></thead><tbody id="worst-trades"></tbody></table></div>
                    </div>
                </div>

                <!-- Nuevos m√≥dulos de Reducci√≥n acumulada y P&L acumulado para Account Details -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Reducci√≥n acumulada</h3>
                        <div class="time-range-buttons mb-3 text-sm">
                            <button data-range="1W" class="time-range-btn account-drawdown-range-btn">1S</button>
                            <button data-range="1M" class="time-range-btn account-drawdown-range-btn">1M</button>
                            <button data-range="3M" class="time-range-btn account-drawdown-range-btn">3M</button>
                            <button data-range="6M" class="time-range-btn account-drawdown-range-btn">6M</button>
                            <button data-range="1Y" class="time-range-btn account-drawdown-range-btn">1A</button>
                            <button data-range="ALL" class="time-range-btn account-drawdown-range-btn active">Todo</button>
                        </div>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="account-reduccion-acumulada-chart"></canvas>
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">P&L acumulado</h3>
                        <div class="time-range-buttons mb-3 text-sm">
                            <button data-range="1W" class="time-range-btn account-pnl-range-btn">1S</button>
                            <button data-range="1M" class="time-range-btn account-pnl-range-btn">1M</button>
                            <button data-range="3M" class="time-range-btn account-pnl-range-btn">3M</button>
                            <button data-range="6M" class="time-range-btn account-pnl-range-btn">6M</button>
                            <button data-range="1Y" class="time-range-btn account-pnl-range-btn">1A</button>
                            <button data-range="ALL" class="time-range-btn account-pnl-range-btn active">Todo</button>
                        </div>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="account-pnl-acumulado-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Nuevos gr√°ficos: P&L Neto Diario y Wins/Losses por D√≠a -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">P&L Neto Diario</h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="account-daily-pnl-chart"></canvas>
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Victorias/Derrotas por D√≠a</h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="account-daily-winloss-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

                <!-- ===== SECTION: FUNDED ===== -->

                <section id="funded" class="section-container">

                    <!-- Pesta√±as de Navegaci√≥n -->

                    <div class="flex border-b border-surface-light mb-4">

                        <button class="funded-tab active" data-target="funded-accounts-view">

                            <i class="fas fa-list-alt mr-2"></i>Cuentas

                        </button>

                        <button class="funded-tab" data-target="funded-calendar-view">

                            <i class="fas fa-calendar-alt mr-2"></i>Calendario Financiero

                        </button>

                    </div>

        

                    <!-- VISTA: Cuentas (Principal) -->

                    <div id="funded-accounts-view" class="funded-view active">

                        <!-- Header con t√≠tulo y botones de acci√≥n -->

                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">

                            <h2 class="text-xl font-semibold">üèÜ Gesti√≥n de Cuentas Fondeadas</h2>

                            <div class="flex items-center gap-2">

                                <button id="funded-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded" title="Filtrar por fecha">

                                    <i class="fas fa-calendar-alt"></i>

                                </button>

                                <button id="add-funded-account-btn" class="primary">

                                    <i class="fas fa-plus mr-2"></i>Nueva Cuenta

                                </button>

                            </div>

                        </div>

                        

                        <!-- Filtro de fecha display -->

                        <div id="funded-date-filter-display" class="date-filter-display-text text-sm text-text-secondary mb-4">

                            Sin filtro de fecha

                        </div>

        

                        <!-- M√©tricas principales -->

                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-graduation-cap text-blue-500 text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">Evaluaciones</h4>

                                <p id="funded-evaluations" class="text-2xl font-bold">0</p>

                            </div>

        

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-hourglass-half text-warning text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">En Progreso</h4>

                                <p id="funded-in-progress" class="text-2xl font-bold text-warning">0</p>

                            </div>

        

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-check-circle text-primary text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">Cuentas Live</h4>

                                <p id="funded-live-accounts" class="text-2xl font-bold text-primary">0</p>

                            </div>

        

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-chart-pie text-purple-500 text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">Funding Ratio</h4>

                                <p id="funded-ratio" class="text-2xl font-bold text-purple-500">0%</p>

                            </div>

        

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-money-bill-wave text-red text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">Gastos Totales</h4>

                                <p id="funded-total-expenses" class="text-2xl font-bold text-red">‚Ç¨0.00</p>

                            </div>

        

                            <div class="metric-card text-center">

                                <div class="flex items-center justify-center mb-2">

                                    <i class="fas fa-hand-holding-usd text-green text-2xl"></i>

                                </div>

                                <h4 class="text-sm text-text-secondary mb-1">Ganancias Totales</h4>

                                <p id="funded-total-earnings" class="text-2xl font-bold text-green">‚Ç¨0.00</p>

                            </div>

                        </div>

        

                        <!-- Beneficio Neto destacado -->

                        <div class="metric-card mb-6 bg-gradient-to-r from-green/10 to-primary/10 border-2 border-green/30">

                            <div class="flex items-center justify-between">

                                <div class="flex items-center gap-4">

                                    <div class="w-16 h-16 rounded-full bg-green/20 flex items-center justify-center">

                                        <i class="fas fa-trophy text-green text-3xl"></i>

                                    </div>

                                    <div>

                                        <h4 class="text-sm text-text-secondary mb-1">Beneficio Neto</h4>

                                        <p id="funded-net-profit" class="text-4xl font-bold text-green">‚Ç¨0.00</p>

                                    </div>

                                </div>

                                <div class="text-right">

                                    <p id="funded-roi-display" class="text-2xl font-bold text-primary">ROI: 0%</p>

                                </div>

                            </div>

                        </div>

        

                        <!-- Gr√°fico de evoluci√≥n + Estad√≠sticas -->

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

                            <!-- Evoluci√≥n de la Cuenta -->

                            <div class="metric-card lg:col-span-2">

                                <h3 class="text-lg font-semibold mb-4">Evoluci√≥n del Capital</h3>

                                <p class="text-xs text-text-secondary mb-3">Curva acumulada de retiros y ganancias</p>

                                <div class="chart-container" style="height: 300px;">

                                    <canvas id="funded-evolution-chart"></canvas>

                                </div>

                            </div>

        

                            <!-- Estad√≠sticas Diarias -->

                            <div class="metric-card">

                                <h3 class="text-lg font-semibold mb-4">Estad√≠sticas</h3>

                                <div class="space-y-4">

                                    <div class="flex items-center justify-between p-3 bg-surface rounded">

                                        <div class="flex items-center gap-2">

                                            <i class="fas fa-arrow-up text-green"></i>

                                            <span class="text-sm">Mejor D√≠a</span>

                                        </div>

                                        <p id="funded-best-day" class="font-bold text-green">‚Ç¨0.00</p>

                                    </div>

        

                                    <div class="flex items-center justify-between p-3 bg-surface rounded">

                                        <div class="flex items-center gap-2">

                                            <i class="fas fa-arrow-down text-red"></i>

                                            <span class="text-sm">Peor D√≠a</span>

                                        </div>

                                        <p id="funded-worst-day" class="font-bold text-red">‚Ç¨0.00</p>

                                    </div>

        

                                    <div class="flex items-center justify-between p-3 bg-surface rounded">

                                        <div class="flex items-center gap-2">

                                            <i class="fas fa-chart-line text-primary"></i>

                                            <span class="text-sm">Promedio Diario</span>

                                        </div>

                                        <p id="funded-avg-daily" class="font-bold">‚Ç¨0.00</p>

                                    </div>

        

                                    <div class="flex items-center justify-between p-3 bg-surface rounded">

                                        <div class="flex items-center gap-2">

                                            <i class="fas fa-coins text-warning"></i>

                                            <span class="text-sm">Retiros</span>

                                        </div>

                                        <p id="funded-withdrawals" class="font-bold text-warning">0</p>

                                    </div>

                                </div>

                            </div>

                        </div>

        

                        <!-- An√°lisis por Empresa -->

                        <div class="mb-6">

                            <h3 class="text-xl font-semibold mb-4">An√°lisis por Empresa</h3>

                            <p class="text-sm text-text-secondary mb-4">Rendimiento detallado de cada prop firm</p>

        

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

                                <!-- Top Empresas por ROI -->

                                <div class="metric-card">

                                    <div class="flex items-center gap-2 mb-4">

                                        <i class="fas fa-trophy text-warning text-xl"></i>

                                        <h4 class="text-lg font-semibold">Top Empresas por ROI</h4>

                                    </div>

                                    <div id="funded-top-roi" class="space-y-3">

                                        <!-- Se llenar√° din√°micamente -->

                                        <p class="text-sm text-text-secondary text-center py-8">No hay datos disponibles</p>

                                    </div>

                                </div>

        

                                <!-- Top Empresas por Retiros -->

                                <div class="metric-card">

                                    <div class="flex items-center gap-2 mb-4">

                                        <i class="fas fa-money-bill-wave text-green text-xl"></i>

                                        <h4 class="text-lg font-semibold">Top Empresas por Retiros</h4>

                                    </div>

                                    <div id="funded-top-withdrawals" class="space-y-3">

                                        <!-- Se llenar√° din√°micamente -->

                                        <p class="text-sm text-text-secondary text-center py-8">No hay datos disponibles</p>

                                    </div>

                                </div>

                            </div>

        

                            <!-- Tabla de Todas las Empresas -->

                            <div class="metric-card">

                                <h4 class="text-lg font-semibold mb-4">Todas las Empresas</h4>

                                <div class="overflow-x-auto">

                                    <table class="w-full">

                                        <thead>

                                            <tr>

                                                <th class="text-left">Empresa</th>

                                                <th class="text-center">Cuentas</th>

                                                <th class="text-right">Gastos</th>

                                                <th class="text-right">Retiros</th>

                                                <th class="text-right">Beneficio</th>

                                                <th class="text-right">ROI</th>

                                            </tr>

                                        </thead>

                                        <tbody id="funded-companies-table">

                                            <tr>

                                                <td colspan="6" class="text-center text-text-secondary py-8">

                                                    No hay empresas registradas

                                                </td>

                                            </tr>

                                        </tbody>

                                    </table>

                                </div>

                            </div>

                        </div>

        

                        <!-- Gesti√≥n de Cuentas -->

                        <div class="metric-card">

                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">

                                <h3 class="text-xl font-semibold">Listado de Cuentas</h3>

                                

                                <!-- Filtros de Estado -->

                                <div class="flex flex-wrap gap-2">

                                    <button class="funded-filter-btn active" data-filter="all">

                                        <i class="fas fa-list mr-1"></i>Todas

                                    </button>

                                    <button class="funded-filter-btn" data-filter="evaluation">

                                        <i class="fas fa-graduation-cap mr-1"></i>Evaluaci√≥n

                                    </button>

                                    <button class="funded-filter-btn" data-filter="live">

                                        <i class="fas fa-check-circle mr-1"></i>Live

                                    </button>

                                    <button class="funded-filter-btn" data-filter="active">

                                        <i class="fas fa-play-circle mr-1"></i>Activas

                                    </button>

                                    <button class="funded-filter-btn" data-filter="suspended">

                                        <i class="fas fa-ban mr-1"></i>Suspendidas

                                    </button>

                                </div>

                            </div>

        

                            <!-- Tabla de Cuentas -->

                            <div class="overflow-x-auto">

                                <table class="w-full">

                                    <thead>

                                        <tr>

                                            <th class="text-left">Nombre</th>

                                            <th class="text-center">Tipo</th>

                                            <th class="text-center">Estado</th>

                                            <th class="text-left">Empresa</th>

                                            <th class="text-right">Gastos</th>

                                            <th class="text-right">Ganancias</th>

                                            <th class="text-right">Beneficio</th>

                                            <th class="text-center">Acciones</th>

                                        </tr>

                                    </thead>

                                    <tbody id="funded-accounts-table">

                                        <tr>

                                            <td colspan="8" class="text-center text-text-secondary py-8">

                                                No hay cuentas. Haz clic en "Nueva Cuenta" para empezar.

                                            </td>

                                        </tr>

                                    </tbody>

                                </table>

                            </div>

        

                            <!-- Paginaci√≥n (si es necesario) -->

                            <div id="funded-pagination" class="flex justify-center mt-6 gap-2" style="display: none;">

                                <!-- Se llenar√° din√°micamente -->

                            </div>

                        </div>

                    </div>

        

                    <!-- VISTA: Calendario Financiero -->

                    <div id="funded-calendar-view" class="funded-view">

                        <!-- Calendario Financiero Funded -->

                        <div class="metric-card mt-6" id="funded-calendar-card">

                            <div class="flex items-center justify-between mb-4">

                                <h3 class="text-lg font-semibold">üìÖ Calendario de Rendimiento</h3>

                                <div class="flex items-center gap-4">

                                    <div class="flex items-center gap-2">

                                        <span class="text-xs flex items-center gap-1">

                                            <span class="inline-block w-3 h-3 rounded-full bg-green"></span>

                                            Ganancias

                                        </span>

                                        <span class="text-xs flex items-center gap-1">

                                            <span class="inline-block w-3 h-3 rounded-full bg-red"></span>

                                            Gastos

                                        </span>

                                    </div>

                                    <div class="flex items-center gap-2">

                                        <button id="funded-calendar-prev" class="p-2 hover:bg-surface-light rounded">

                                            <i class="fas fa-chevron-left text-sm"></i>

                                        </button>

                                        <span id="funded-calendar-month-year" class="text-sm font-semibold min-w-[120px] text-center"></span>

                                        <button id="funded-calendar-next" class="p-2 hover:bg-surface-light rounded">

                                            <i class="fas fa-chevron-right text-sm"></i>

                                        </button>

                                    </div>

                                </div>

                            </div>

                            <div id="funded-calendar-container" class="overflow-x-auto">

                                <!-- El calendario se generar√° din√°micamente aqu√≠ -->

                            </div>

                        </div>

                    </div>

                    

                    <!-- Vista a Pantalla Completa del D√≠a (fuera de las pesta√±as para que se superponga) -->

                    <div id="funded-day-fullscreen" class="section-container" style="display: none;">

                        <div class="flex items-center justify-between mb-6">

                            <div>

                                <button id="funded-day-back-btn" class="text-primary hover:text-primary-light mb-2">

                                    <i class="fas fa-arrow-left mr-2"></i>Volver al Calendario

                                </button>

                                <h2 class="text-2xl font-bold" id="funded-day-title">Detalles del D√≠a</h2>

                                <p class="text-text-secondary" id="funded-day-date"></p>

                            </div>

                            <div class="text-right">

                                <p class="text-sm text-text-secondary mb-1">Balance del D√≠a</p>

                                <p class="text-3xl font-bold" id="funded-day-balance">‚Ç¨0.00</p>

                            </div>

                        </div>

        

                        <!-- Grid principal -->

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- Columna Izquierda: Movimientos y Estad√≠sticas -->

                            <div class="lg:col-span-2 space-y-6">

                                <!-- Movimientos del d√≠a -->

                                <div class="metric-card">

                                    <h3 class="text-lg font-semibold mb-4">üí∞ Movimientos del D√≠a</h3>

                                    <div id="funded-day-movements" class="space-y-3">

                                        <!-- Se llenar√° din√°micamente -->

                                    </div>

                                </div>

        

                                <!-- Estad√≠sticas en Barras -->

                                <div class="metric-card">

                                    <h3 class="text-lg font-semibold mb-4">üìä Estad√≠sticas de Retiros</h3>

                                    <div class="space-y-4">

                                        <!-- Total Acumulado -->

                                        <div>

                                            <div class="flex justify-between text-sm mb-2">

                                                <span>Total Acumulado de Retiros</span>

                                                <span class="font-semibold" id="stat-total-withdrawals">‚Ç¨0.00</span>

                                            </div>

                                            <div class="w-full bg-surface-light rounded-full h-3">

                                                <div id="stat-total-bar" class="bg-green h-3 rounded-full transition-all" style="width: 0%"></div>

                                            </div>

                                        </div>

        

                                        <!-- Promedio de Retiros -->

                                        <div>

                                            <div class="flex justify-between text-sm mb-2">

                                                <span>Promedio por Retiro</span>

                                                <span class="font-semibold" id="stat-avg-withdrawals">‚Ç¨0.00</span>

                                            </div>

                                            <div class="w-full bg-surface-light rounded-full h-3">

                                                <div id="stat-avg-bar" class="bg-blue h-3 rounded-full transition-all" style="width: 0%"></div>

                                            </div>

                                        </div>

        

                                        <!-- Total Gastos -->

                                        <div>

                                            <div class="flex justify-between text-sm mb-2">

                                                <span>Total Gastos Acumulados</span>

                                                <span class="font-semibold text-red" id="stat-total-expenses">‚Ç¨0.00</span>

                                            </div>

                                            <div class="w-full bg-surface-light rounded-full h-3">

                                                <div id="stat-expenses-bar" class="bg-red h-3 rounded-full transition-all" style="width: 0%"></div>

                                            </div>

                                        </div>

        

                                        <!-- Ratio Retiros/Gastos -->

                                        <div>

                                            <div class="flex justify-between text-sm mb-2">

                                                <span>Ratio Ganancias/Gastos</span>

                                                <span class="font-semibold" id="stat-ratio">0.00x</span>

                                            </div>

                                            <div class="w-full bg-surface-light rounded-full h-3">

                                                <div id="stat-ratio-bar" class="bg-primary h-3 rounded-full transition-all" style="width: 0%"></div>

                                            </div>

                                        </div>

        

                                        <!-- N√∫mero de Retiros -->

                                        <div class="grid grid-cols-2 gap-4 mt-4">

                                            <div class="bg-surface-light p-4 rounded-lg text-center">

                                                <p class="text-sm text-text-secondary mb-1">Retiros Totales</p>

                                                <p class="text-2xl font-bold text-green" id="stat-count-withdrawals">0</p>

                                            </div>

                                            <div class="bg-surface-light p-4 rounded-lg text-center">

                                                <p class="text-sm text-text-secondary mb-1">Gastos Totales</p>

                                                <p class="text-2xl font-bold text-red" id="stat-count-expenses">0</p>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

        

                            <!-- Columna Derecha: Notas Avanzadas -->

                            <div class="space-y-6">

                                <!-- Notas Avanzadas con Etiquetas -->

                                <div class="metric-card">

                                    <h3 class="text-lg font-semibold mb-4">üìù Notas del D√≠a</h3>

                                    

                                    <!-- Etiquetas -->

                                    <div class="mb-4">

                                        <label class="text-sm text-text-secondary mb-2 block">üè∑Ô∏è Etiquetas</label>

                                        <div class="flex flex-wrap gap-2 mb-3" id="funded-day-tags">

                                            <!-- Se llenar√° din√°micamente -->

                                        </div>

                                        <input 

                                            type="text" 

                                            id="new-tag-input" 

                                            placeholder="Nueva etiqueta (presiona Enter)..."

                                            class="w-full p-2 bg-surface-light border border-border rounded text-sm focus:border-primary focus:outline-none"

                                        />

                                    </div>



                                    <!-- Editor de Notas Avanzadas -->

                                    <div>

                                        <div class="flex items-center justify-between mb-3">

                                            <label class="text-sm text-text-secondary">Notas Avanzadas</label>

                                            <button id="edit-notes-btn" class="text-sm px-3 py-1 border border-border rounded hover:border-primary transition-all">

                                                <i class="fas fa-edit mr-1"></i>Editar Notas

                                            </button>

                                        </div>



                                        <!-- Vista de Notas (Read-only) -->

                                        <div id="notes-display" class="w-full min-h-[300px] p-4 bg-surface-light border border-border rounded-lg text-sm" style="display: block;">

                                            <p class="text-text-secondary italic">No hay notas escritas a√∫n. Haz clic en "Editar Notas" para comenzar.</p>

                                        </div>



                                        <!-- Editor Modal de Notas -->

                                        <div id="notes-editor-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center" style="display: none;">

                                            <div class="bg-surface rounded-lg shadow-2xl flex flex-col max-w-5xl w-full mx-4 max-h-[90vh]">

                                                <!-- Header del Editor -->

                                                <div class="flex items-center justify-between p-4 border-b border-border">

                                                    <h3 class="text-xl font-bold">Notas del D√≠a</h3>

                                                    <button id="close-editor-btn" class="text-2xl text-text-secondary hover:text-text">

                                                        <i class="fas fa-times"></i>

                                                    </button>

                                                </div>



                                                <!-- Toolbar de Formato -->

                                                <div class="flex flex-wrap items-center gap-1 p-3 border-b border-border bg-surface-light overflow-x-auto">

                                                    <!-- Formato de texto -->

                                                    <button onclick="formatText('bold')" class="p-2 hover:bg-surface rounded" title="Negrita">

                                                        <i class="fas fa-bold"></i>

                                                    </button>

                                                    <button onclick="formatText('italic')" class="p-2 hover:bg-surface rounded" title="Cursiva">

                                                        <i class="fas fa-italic"></i>

                                                    </button>

                                                    <button onclick="formatText('underline')" class="p-2 hover:bg-surface rounded" title="Subrayado">

                                                        <i class="fas fa-underline"></i>

                                                    </button>

                                                    <button onclick="formatText('strikeThrough')" class="p-2 hover:bg-surface rounded" title="Tachado">

                                                        <i class="fas fa-strikethrough"></i>

                                                    </button>

                                                    

                                                    <div class="w-px h-6 bg-border mx-1"></div>



                                                    <!-- Alineaci√≥n -->

                                                    <button onclick="formatText('justifyLeft')" class="p-2 hover:bg-surface rounded" title="Alinear izquierda">

                                                        <i class="fas fa-align-left"></i>

                                                    </button>

                                                    <button onclick="formatText('justifyCenter')" class="p-2 hover:bg-surface rounded" title="Centrar">

                                                        <i class="fas fa-align-center"></i>

                                                    </button>

                                                    <button onclick="formatText('justifyRight')" class="p-2 hover:bg-surface rounded" title="Alinear derecha">

                                                        <i class="fas fa-align-right"></i>

                                                    </button>

                                                    <button onclick="formatText('justifyFull')" class="p-2 hover:bg-surface rounded" title="Justificar">

                                                        <i class="fas fa-align-justify"></i>

                                                    </button>



                                                    <div class="w-px h-6 bg-border mx-1"></div>



                                                    <!-- Listas -->

                                                    <button onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-surface rounded" title="Lista con vi√±etas">

                                                        <i class="fas fa-list-ul"></i>

                                                    </button>

                                                    <button onclick="formatText('insertOrderedList')" class="p-2 hover:bg-surface rounded" title="Lista numerada">

                                                        <i class="fas fa-list-ol"></i>

                                                    </button>

                                                    <button onclick="formatText('indent')" class="p-2 hover:bg-surface rounded" title="Aumentar sangr√≠a">

                                                        <i class="fas fa-indent"></i>

                                                    </button>

                                                    <button onclick="formatText('outdent')" class="p-2 hover:bg-surface rounded" title="Disminuir sangr√≠a">

                                                        <i class="fas fa-outdent"></i>

                                                    </button>



                                                    <div class="w-px h-6 bg-border mx-1"></div>



                                                    <!-- Estilo de texto -->

                                                    <select id="format-block" onchange="formatText('formatBlock', this.value); this.selectedIndex=0;" class="px-2 py-1 bg-surface border border-border rounded text-sm">

                                                        <option value="" selected>Normal</option>

                                                        <option value="h1">T√≠tulo 1</option>

                                                        <option value="h2">T√≠tulo 2</option>

                                                        <option value="h3">T√≠tulo 3</option>

                                                        <option value="p">P√°rrafo</option>

                                                    </select>



                                                    <div class="w-px h-6 bg-border mx-1"></div>



                                                    <!-- Colores -->

                                                    <input type="color" id="text-color" onchange="formatText('foreColor', this.value)" class="w-8 h-8 rounded cursor-pointer" value="#ffffff" title="Color de texto">

                                                    <input type="color" id="bg-color" onchange="formatText('hiliteColor', this.value)" class="w-8 h-8 rounded cursor-pointer" value="#ffeb3b" title="Color de fondo">



                                                    <div class="w-px h-6 bg-border mx-1"></div>



                                                    <!-- Insertar -->

                                                    <button onclick="insertLink()" class="p-2 hover:bg-surface rounded" title="Insertar enlace">

                                                        <i class="fas fa-link"></i>

                                                    </button>

                                                    <button onclick="formatText('removeFormat')" class="p-2 hover:bg-surface rounded text-red" title="Limpiar formato">

                                                        <i class="fas fa-eraser"></i>

                                                    </button>

                                                </div>



                                                <!-- √Årea de Edici√≥n -->

                                                <div class="overflow-y-auto p-4" style="max-height: 500px;">

                                                    <div 

                                                        id="funded-day-notes-editor" 

                                                        contenteditable="true"

                                                        class="w-full min-h-[300px] p-4 bg-background border border-border rounded-lg focus:border-primary focus:outline-none text-base"

                                                        placeholder="Escribe las notas del d√≠a..."

                                                    ></div>

                                                </div>



                                                <!-- Footer con Acciones -->

                                                <div class="flex items-center justify-between p-4 border-t border-border gap-4">

                                                    <div class="flex items-center gap-2">

                                                        <!-- Nota de Voz -->

                                                        <button id="voice-note-btn" class="flex items-center gap-2 px-4 py-2 bg-surface-light border border-border rounded hover:border-primary transition-all">

                                                            <i class="fas fa-microphone"></i>

                                                            <span>Nota de Voz</span>

                                                        </button>

                                                        <button id="download-note-btn" class="p-2 bg-surface-light border border-border rounded hover:border-primary transition-all" title="Descargar nota">

                                                            <i class="fas fa-download"></i>

                                                        </button>

                                                    </div>



                                                    <div class="flex items-center gap-2">

                                                        <span class="text-xs text-text-secondary" id="editor-char-count">0 caracteres</span>

                                                        <button id="editor-cancel-btn" class="px-4 py-2 border border-border rounded hover:bg-surface-light transition-all">

                                                            Cancelar

                                                        </button>

                                                        <button id="editor-save-btn" class="primary px-4 py-2">

                                                            <i class="fas fa-save mr-2"></i>Guardar Notas

                                                        </button>

                                                    </div>

                                                </div>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>



                        <!-- Galer√≠a de Im√°genes - Abajo del todo y m√°s amplia -->

                        <div class="metric-card mt-6">

                            <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Galer√≠a de Im√°genes (m√°x. 3)</h3>

                            

                            <!-- Preview de im√°genes - Grid m√°s amplio -->

                            <div id="funded-day-images-preview" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

                                <!-- Se llenar√° din√°micamente -->

                            </div>



                            <!-- Bot√≥n para a√±adir imagen -->

                            <div class="flex flex-col items-center gap-2">

                                <input 

                                    type="file" 

                                    id="funded-day-image-input" 

                                    accept="image/*" 

                                    class="hidden"

                                />

                                <button 

                                    id="add-day-image-btn" 

                                    class="w-full max-w-md p-4 border-2 border-dashed border-border rounded-lg hover:border-primary hover:bg-surface-light transition-all text-center"

                                >

                                    <i class="fas fa-image mr-2 text-lg"></i>A√±adir Imagen

                                </button>

                                <p class="text-xs text-text-secondary text-center">

                                    Soporta JPG, PNG, GIF (m√°x. 5MB por imagen) - Haz clic en cualquier imagen para verla a pantalla completa

                                </p>

                            </div>

                        </div>

                    </div>

                </section>

        <!-- AUDICI√ìN SECTION -->
        <section id="audicion" class="section-container">
            <!-- Header con selector -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <h2 class="text-2xl font-semibold">Audici√≥n de Trading</h2>
                <div class="flex items-center gap-3">
                    <select id="audicion-account-select" class="bg-surface border border-border rounded px-3 py-1.5 text-white text-xs">
                        <option value="all">Todas las cuentas</option>
                    </select>
                    <button id="audicion-filter-dates-btn-header" class="text-xs px-3 py-1.5 bg-surface-light hover:bg-surface border border-border rounded transition-colors">
                        <i class="fas fa-calendar-alt mr-1"></i>Filtrar por fecha
                    </button>
                </div>
            </div>

            <!-- Perfil del Trader - Grid con 3 m√≥dulos -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
                <!-- M√≥dulo 1: Datos del Trader con Foto -->
                <div class="metric-card p-6 lg:col-span-5">
                    <div class="flex flex-col items-center text-center space-y-4">
                        <!-- Avatar -->
                        <div class="relative flex-shrink-0">
                            <div id="audicion-user-avatar" class="w-24 h-24 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white text-3xl font-bold overflow-hidden shadow-lg">
                                D
                            </div>
                        </div>
                        
                        <!-- Info del Usuario -->
                        <div class="w-full">
                            <div class="flex flex-col items-center space-y-1 mb-1">
                                <div class="flex items-center space-x-2">
                                    <h3 id="audicion-username" class="text-xl font-bold">Usuario</h3>
                                    <i class="fas fa-check-circle text-primary" title="Cuenta Verificada"></i>
                                </div>
                            </div>
                            <p id="audicion-user-email" class="text-text-secondary text-sm mb-3">email@example.com</p>
                            <div class="flex flex-col items-center space-y-2 text-xs text-text-secondary">
                                <span><i class="fas fa-calendar-alt mr-1"></i>Miembro desde <span id="audicion-member-since">Dic 2024</span></span>
                                <span><i class="fas fa-chart-line mr-1"></i>Trading desde <span id="audicion-trading-since">Ene 2023</span></span>
                                <span class="inline-flex items-center space-x-1 bg-blue-500 bg-opacity-20 text-blue-400 text-xs px-2 py-1 rounded-full mt-2">
                                    <i class="fas fa-check-circle" style="font-size: 10px;"></i>
                                    <span>Verificado</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- M√≥dulo 2: Link P√∫blico de Audici√≥n -->
                <div class="metric-card p-4 lg:col-span-3" id="audicion-public-link-section">
                    <div class="flex flex-col justify-center h-full space-y-2">
                        <div class="flex items-center justify-center mb-1">
                            <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            </svg>
                        </div>
                        <h4 class="text-center text-xs font-semibold text-text-secondary mb-2">Link P√∫blico</h4>
                        <div class="flex items-center space-x-1">
                            <input type="text" id="audicion-public-link" readonly class="flex-1 bg-background border border-border rounded px-2 py-1.5 text-xs text-primary text-center" value="Haz clic en Compartir">
                            <button id="copy-audicion-link" class="btn-outline text-xs px-2 py-1.5" title="Copiar link">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <button id="share-audicion-btn" class="btn-primary text-xs px-3 py-1.5 w-full">
                            <i class="fas fa-share-alt mr-1"></i>Generar Link
                        </button>
                        <p class="text-xs text-text-secondary text-center mt-1">
                            <i class="fas fa-info-circle mr-1"></i>Comparte tu audici√≥n con otros
                        </p>
                    </div>
                </div>

                <!-- M√≥dulo 3: P&L Neto Semanal (Gr√°fico de Barras) -->
                <div class="metric-card p-5 lg:col-span-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold">P&L Neto Semanal</h4>
                        <i class="fas fa-chart-bar text-primary text-sm"></i>
                    </div>
                    <div style="height: 220px;">
                        <canvas id="audicion-weekly-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- M√©tricas Principales con Gauges -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- P&L Total -->
                <div class="metric-card p-5">
                    <h4 class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-3">P&L Total</h4>
                    <div class="flex items-center justify-center mb-3" style="height: 140px;">
                        <canvas id="gauge-pl-total" width="140" height="140"></canvas>
                    </div>
                    <p id="audicion-pl-total" class="text-2xl font-bold text-center mb-2" style="color: #39ff14;">$0.00</p>
                    <div class="flex items-center justify-center space-x-3 text-xs">
                        <span style="color: #39ff14;"><span id="audicion-total-wins">0</span> Wins</span>
                        <span style="color: #ff4136;"><span id="audicion-total-losses">0</span> Losses</span>
                    </div>
                </div>

                <!-- Win Rate -->
                <div class="metric-card p-5">
                    <h4 class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-3">Win Rate</h4>
                    <div class="flex items-center justify-center mb-3" style="height: 140px;">
                        <canvas id="gauge-win-rate" width="140" height="140"></canvas>
                    </div>
                    <p id="audicion-win-rate" class="text-2xl font-bold text-center mb-2">0%</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-text-secondary">
                        <span><span id="audicion-winners">0</span>W</span>
                        <span>¬∑</span>
                        <span><span id="audicion-losers">0</span>L</span>
                        <span>¬∑</span>
                        <span><span id="audicion-breakeven">0</span>BE</span>
                    </div>
                </div>

                <!-- Profit Factor -->
                <div class="metric-card p-5">
                    <h4 class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-3">Profit Factor</h4>
                    <div class="flex items-center justify-center mb-3" style="height: 140px;">
                        <canvas id="gauge-profit-factor" width="140" height="140"></canvas>
                    </div>
                    <p id="audicion-profit-factor" class="text-2xl font-bold text-center mb-2">0.00</p>
                    <div class="text-xs text-text-secondary text-center">
                        Ratio: <span id="audicion-pf-ratio">1:1</span>
                    </div>
                </div>

                <!-- Day Win % -->
                <div class="metric-card p-5">
                    <h4 class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-3">Day Win %</h4>
                    <div class="flex items-center justify-center mb-3" style="height: 140px;">
                        <canvas id="gauge-day-win" width="140" height="140"></canvas>
                    </div>
                    <p id="audicion-day-win-rate" class="text-2xl font-bold text-center mb-2">0%</p>
                    <div class="flex items-center justify-center space-x-3 text-xs text-text-secondary">
                        <span style="color: #39ff14;"><span id="audicion-winning-days">0</span> d√≠as+</span>
                        <span style="color: #ff4136;"><span id="audicion-losing-days">0</span> d√≠as-</span>
                    </div>
                </div>
            </div>

            <!-- Curvas de Rendimiento -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                <!-- Curva de Profit -->
                <div class="metric-card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-semibold">Curva de Profit Acumulado</h4>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 bg-primary bg-opacity-20 text-primary rounded">Profit</span>
                        </div>
                    </div>
                    <div style="height: 220px;">
                        <canvas id="audicion-profit-curve"></canvas>
                    </div>
                </div>

                <!-- Curva de Drawdown -->
                <div class="metric-card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-semibold">Curva de Drawdown</h4>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 bg-red bg-opacity-20 text-red rounded">Drawdown</span>
                        </div>
                    </div>
                    <div style="height: 220px;">
                        <canvas id="audicion-drawdown-curve"></canvas>
                    </div>
                </div>
            </div>

            <!-- √öltimos Trades -->
            <div class="metric-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">√öltimos Trades</h4>
                    <div class="flex items-center gap-2">
                        <button id="audicion-filter-dates-btn" class="text-xs px-3 py-1 bg-surface-light hover:bg-surface border border-border rounded transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>Filtrar por fecha
                        </button>
                        <span class="bg-primary bg-opacity-20 text-primary text-xs px-3 py-1 rounded-full">
                            <i class="fas fa-check-circle mr-1"></i>Verificado
                        </span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full" id="audicion-latest-trades">
                        <thead>
                            <tr class="text-xs text-text-secondary border-b border-border">
                                <th class="text-left py-3 px-2 font-medium">FECHA</th>
                                <th class="text-left py-3 px-2 font-medium">S√çMBOLO</th>
                                <th class="text-center py-3 px-2 font-medium">DIRECCI√ìN</th>
                                <th class="text-center py-3 px-2 font-medium">TIPO</th>
                                <th class="text-center py-3 px-2 font-medium">RESULTADO</th>
                                <th class="text-right py-3 px-2 font-medium">P&L</th>
                                <th class="text-right py-3 px-2 font-medium">ROI %</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Estad√≠sticas Adicionales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Mejor Trade -->
                <div class="metric-card p-5">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-primary bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-trophy text-primary"></i>
                        </div>
                        <div>
                            <p class="text-xs text-text-secondary mb-1">Mejor Trade</p>
                            <p id="audicion-best-trade" class="text-lg font-bold text-primary">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Peor Trade -->
                <div class="metric-card p-5">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-red bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red"></i>
                        </div>
                        <div>
                            <p class="text-xs text-text-secondary mb-1">Peor Trade</p>
                            <p id="audicion-worst-trade" class="text-lg font-bold text-red">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Promedio por Trade -->
                <div class="metric-card p-5">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-accent bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-chart-line text-accent"></i>
                        </div>
                        <div>
                            <p class="text-xs text-text-secondary mb-1">Promedio por Trade</p>
                            <p id="audicion-avg-trade" class="text-lg font-bold">$0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal de Filtro de Fechas para Audici√≥n -->
        <div id="audicion-date-range-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" style="background-color: rgba(0,0,0,0.95);">
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Seleccionar Rango de Fechas</h3>
                    <button id="audicion-date-range-close-btn" class="p-2 -mr-2 rounded-full hover:bg-surface-light"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Predefined Ranges -->
                    <div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-border pb-4 md:pb-0 md:pr-6">
                        <h4 class="text-sm font-semibold mb-3">Rangos R√°pidos</h4>
                        <div class="space-y-2">
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="today">Hoy</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="this_week">Esta Semana</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="this_month">Este Mes</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="last_7_days">√öltimos 7 d√≠as</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="last_30_days">√öltimos 30 d√≠as</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light audicion-date-range-preset" data-range="this_year">Este A√±o</button>
                        </div>
                    </div>
                    <!-- Calendar -->
                    <div class="w-full md:w-2/3">
                        <div class="flex justify-between items-center mb-3">
                            <button id="audicion-calendar-prev-month" class="p-2 rounded-full hover:bg-surface-light"><i class="fas fa-chevron-left"></i></button>
                            <h4 id="audicion-calendar-month-year" class="font-semibold text-lg"></h4>
                            <button id="audicion-calendar-next-month" class="p-2 rounded-full hover:bg-surface-light"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-sm mb-2 text-text-secondary">
                            <div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div>
                        </div>
                        <div id="audicion-calendar-days" class="grid grid-cols-7 gap-1">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>
                </div>
                <div class="mt-6 border-t border-border pt-4 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-sm">
                        <input type="text" id="audicion-date-range-start-input" class="bg-surface-light p-2 rounded w-32 text-center" placeholder="Inicio" readonly>
                        <span>-</span>
                        <input type="text" id="audicion-date-range-end-input" class="bg-surface-light p-2 rounded w-32 text-center" placeholder="Fin" readonly>
                    </div>
                    <div class="space-x-2">
                        <button id="audicion-date-range-clear-btn" class="secondary">Limpiar</button>
                        <button id="audicion-date-range-apply-btn" class="primary">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Generar Link P√∫blico de Audici√≥n -->
        <div id="public-link-modal" class="public-link-modal">
            <div class="public-link-modal-content">
                <div class="public-link-modal-header">
                    <h3><i class="fas fa-share-alt mr-2"></i>Generar Link P√∫blico de Audici√≥n</h3>
                    <button class="close-modal-btn" id="close-public-link-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="public-link-card">
                    <h4 class="text-sm font-semibold mb-3">Link Generado</h4>
                    <div class="public-link-input-group">
                        <input type="text" id="generated-public-link" class="public-link-input" readonly placeholder="El link se generar√° aqu√≠...">
                        <button class="copy-link-btn" id="copy-public-link-btn">
                            <i class="fas fa-copy mr-1"></i>Copiar
                        </button>
                    </div>
                    <p class="text-xs text-text-secondary">
                        <i class="fas fa-info-circle mr-1"></i>Este link permite ver tu audici√≥n en modo de solo lectura
                    </p>
                </div>

                <div class="public-link-card">
                    <h4 class="text-sm font-semibold mb-3">Opciones de Compartir</h4>
                    <div class="audicion-options">
                        <div class="audicion-option-card">
                            <label>
                                <input type="checkbox" id="share-metrics" checked>
                                <span>Compartir m√©tricas principales</span>
                            </label>
                        </div>
                        <div class="audicion-option-card">
                            <label>
                                <input type="checkbox" id="share-trades" checked>
                                <span>Compartir historial de trades</span>
                            </label>
                        </div>
                        <div class="audicion-option-card">
                            <label>
                                <input type="checkbox" id="share-charts">
                                <span>Compartir gr√°ficos</span>
                            </label>
                        </div>
                        <div class="audicion-option-card">
                            <label>
                                <input type="checkbox" id="share-personal-info">
                                <span>Compartir informaci√≥n personal</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 justify-end mt-6">
                    <button class="secondary" id="cancel-public-link">Cancelar</button>
                    <button class="primary" id="generate-public-link-btn">
                        <i class="fas fa-link mr-2"></i>Generar Link
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!--         SECCI√ìN SOCIAL MEDIA             -->
        <!-- ========================================== -->
        <section id="social-media" class="section-container">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Social Media - Ranking de Traders</h2>
                    <p class="text-text-secondary text-sm">Descubre los mejores traders de la comunidad y comparte tu rendimiento</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="social-media-timeframe-1m" class="text-xs px-3 py-1.5 bg-primary text-white rounded">
                        1m
                    </button>
                    <button id="social-media-timeframe-3m" class="text-xs px-3 py-1.5 bg-surface-light hover:bg-surface border border-border rounded">
                        3m
                    </button>
                    <button id="social-media-timeframe-1y" class="text-xs px-3 py-1.5 bg-surface-light hover:bg-surface border border-border rounded">
                        1y
                    </button>
                    <button id="social-media-timeframe-all" class="text-xs px-3 py-1.5 bg-surface-light hover:bg-surface border border-border rounded">
                        all
                    </button>
                </div>
            </div>

            <!-- Tabla de clasificaci√≥n -->
            <div class="metric-card p-0 overflow-hidden">
                <div class="p-6 bg-surface-light border-b border-border">
                    <h3 class="text-lg font-semibold mb-2">Principales carteras</h3>
                    <p class="text-sm text-text-secondary">Rankings basados en rendimiento verificado</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="social-media-leaderboard">
                        <thead class="bg-surface-light">
                            <tr class="text-left text-xs text-text-secondary uppercase tracking-wider">
                                <th class="px-6 py-4 w-12 text-center">#</th>
                                <th class="px-6 py-4">Trader</th>
                                <th class="px-6 py-4 text-center">Beneficio</th>
                                <th class="px-6 py-4 text-center">% Ganancia</th>
                                <th class="px-6 py-4 text-center">Win Rate</th>
                                <th class="px-6 py-4 text-center">Trades</th>
                            </tr>
                        </thead>
                        <tbody id="social-media-tbody" class="divide-y divide-border">
                            <!-- Los traders se cargar√°n aqu√≠ din√°micamente -->
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-text-secondary">
                                    <i class="fas fa-users text-4xl mb-3 opacity-50"></i>
                                    <p class="text-lg">No hay traders p√∫blicos a√∫n</p>
                                    <p class="text-sm mt-2">S√© el primero en compartir tu rendimiento activando el perfil p√∫blico en Configuraci√≥n</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sidebar de clasificaci√≥n -->
            <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="metric-card p-6">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-table mr-2 text-primary"></i>
                        Tabla de clasificaci√≥n
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-medal text-yellow-500"></i>
                                <span class="text-sm">Beneficio</span>
                            </div>
                            <span class="text-xs text-text-secondary">Total P&L Neto</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-percentage text-blue-500"></i>
                                <span class="text-sm">Ganancia promedio</span>
                            </div>
                            <span class="text-xs text-text-secondary">ROI %</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-chart-line text-green-500"></i>
                                <span class="text-sm">Operaciones ganadoras</span>
                            </div>
                            <span class="text-xs text-text-secondary">Win Rate %</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card p-6">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-info-circle mr-2 text-accent"></i>
                        ¬øC√≥mo funciona?
                    </h3>
                    <div class="space-y-3 text-sm text-text-secondary">
                        <p><i class="fas fa-check text-green-500 mr-2"></i>Vincula tus cuentas de trading</p>
                        <p><i class="fas fa-check text-green-500 mr-2"></i>Activa el perfil p√∫blico en Configuraci√≥n</p>
                        <p><i class="fas fa-check text-green-500 mr-2"></i>Tu rendimiento se verifica autom√°ticamente</p>
                        <p><i class="fas fa-check text-green-500 mr-2"></i>Aparece en el ranking p√∫blico</p>
                    </div>
                </div>

                <div class="metric-card p-6">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-star mr-2 text-yellow-500"></i>
                        Iconos de estrellas
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-star text-yellow-500"></i>
                                <span>Rentable el mes pasado</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <span>Rentable √∫ltimos 3 meses</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <span>Rentable todo el a√±o</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="finances" class="section-container">
            <div class="flex flex-wrap justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Finanzas Manuales (Ingresos/Gastos)</h2>
                <div class="flex items-center space-x-2">
                    <button id="add-finance-entry-btn" class="primary"><i class="fas fa-plus mr-2"></i>A√±adir Movimiento</button>
                    <button id="toggle-hide-amounts-finances" class="p-2 rounded border" title="Ocultar importes (stream)" aria-pressed="false" style="display:inline-flex;align-items:center;justify-content:center;">
                        <i id="toggle-hide-amounts-finances-icon" class="fas fa-eye-slash" aria-hidden="true" style="width:16px; height:16px;"></i>
                        <span class="sr-only">Ocultar importes</span>
                    </button>
                </div>
            </div>

            <!-- Pesta√±as de navegaci√≥n -->
            <div class="flex items-center gap-2 mb-6 border-b border-surface-light">
                <button id="finances-tab-movements" class="finances-tab active">
                    <i class="fas fa-dollar-sign mr-2"></i>Movimientos
                </button>
                <button id="finances-tab-calendar" class="finances-tab">
                    <i class="fas fa-calendar-alt mr-2"></i>Calendario
                </button>
            </div>
            <div id="add-finance-entry-form" class="metric-card mb-6" style="display: none;">
                <h3 class="text-lg font-semibold mb-4">Nuevo Movimiento Financiero</h3>
                <form id="finance-entry-details-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block mb-1">Fecha</label>
                            <input type="date" id="finance-date" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-1">Monto (+/-)</label>
                            <input type="number" id="finance-amount" step="any" placeholder="Ej: 500 o -150" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-1">Divisa</label>
                            <select id="finance-currency" class="w-full">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Descripci√≥n / Notas Avanzadas -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block">Descripci√≥n / Notas</label>
                            <button type="button" id="edit-finance-notes-btn" class="text-sm px-3 py-1 border border-border rounded hover:border-primary transition-all">
                                <i class="fas fa-edit mr-1"></i>Editor Avanzado
                            </button>
                        </div>
                        <div id="finance-notes-display" class="w-full min-h-[100px] p-3 bg-surface-light border border-border rounded-lg text-sm">
                            <p class="text-text-secondary italic">Sin descripci√≥n. Usa el editor avanzado para a√±adir notas detalladas.</p>
                        </div>
                        <input type="hidden" id="finance-notes-hidden" value="">
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" id="finance-cancel-btn" class="px-4 py-2 border border-border rounded hover:bg-surface-light">Cancelar</button>
                        <button type="button" id="finance-save-btn" class="primary px-4 py-2">Guardar</button>
                    </div>
                </form>
            </div>

            <!-- Modal de Editor de Notas para Finanzas -->
            <div id="finance-notes-editor-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
                <div class="bg-surface rounded-lg shadow-2xl flex flex-col max-w-5xl w-full mx-4 max-h-[90vh]">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-4 border-b border-border">
                        <h3 class="text-xl font-bold">Descripci√≥n / Notas del Movimiento</h3>
                        <button id="close-finance-editor-btn" class="text-2xl text-text-secondary hover:text-text">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Toolbar -->
                    <div class="flex flex-wrap items-center gap-1 p-3 border-b border-border bg-surface-light overflow-x-auto">
                        <button onclick="formatFinanceText('bold')" class="p-2 hover:bg-surface rounded" title="Negrita">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button onclick="formatFinanceText('italic')" class="p-2 hover:bg-surface rounded" title="Cursiva">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button onclick="formatFinanceText('underline')" class="p-2 hover:bg-surface rounded" title="Subrayado">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button onclick="formatFinanceText('strikeThrough')" class="p-2 hover:bg-surface rounded" title="Tachado">
                            <i class="fas fa-strikethrough"></i>
                        </button>
                        
                        <div class="w-px h-6 bg-border mx-1"></div>

                        <button onclick="formatFinanceText('justifyLeft')" class="p-2 hover:bg-surface rounded" title="Alinear izquierda">
                            <i class="fas fa-align-left"></i>
                        </button>
                        <button onclick="formatFinanceText('justifyCenter')" class="p-2 hover:bg-surface rounded" title="Centrar">
                            <i class="fas fa-align-center"></i>
                        </button>
                        <button onclick="formatFinanceText('justifyRight')" class="p-2 hover:bg-surface rounded" title="Alinear derecha">
                            <i class="fas fa-align-right"></i>
                        </button>

                        <div class="w-px h-6 bg-border mx-1"></div>

                        <button onclick="formatFinanceText('insertUnorderedList')" class="p-2 hover:bg-surface rounded" title="Lista">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button onclick="formatFinanceText('insertOrderedList')" class="p-2 hover:bg-surface rounded" title="Lista numerada">
                            <i class="fas fa-list-ol"></i>
                        </button>

                        <div class="w-px h-6 bg-border mx-1"></div>

                        <select id="finance-format-block" onchange="formatFinanceText('formatBlock', this.value); this.selectedIndex=0;" class="px-2 py-1 bg-surface border border-border rounded text-sm">
                            <option value="" selected>Normal</option>
                            <option value="h1">T√≠tulo 1</option>
                            <option value="h2">T√≠tulo 2</option>
                            <option value="h3">T√≠tulo 3</option>
                            <option value="p">P√°rrafo</option>
                        </select>

                        <div class="w-px h-6 bg-border mx-1"></div>

                        <input type="color" id="finance-text-color" onchange="formatFinanceText('foreColor', this.value)" class="w-8 h-8 rounded cursor-pointer" value="#ffffff" title="Color de texto">
                        <input type="color" id="finance-bg-color" onchange="formatFinanceText('hiliteColor', this.value)" class="w-8 h-8 rounded cursor-pointer" value="#ffeb3b" title="Color de fondo">

                        <div class="w-px h-6 bg-border mx-1"></div>

                        <button onclick="insertFinanceLink()" class="p-2 hover:bg-surface rounded" title="Insertar enlace">
                            <i class="fas fa-link"></i>
                        </button>
                        <button onclick="formatFinanceText('removeFormat')" class="p-2 hover:bg-surface rounded text-red" title="Limpiar formato">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>

                    <!-- √Årea de Edici√≥n -->
                    <div class="overflow-y-auto p-4" style="max-height: 500px;">
                        <div 
                            id="finance-notes-editor" 
                            contenteditable="true"
                            class="w-full min-h-[300px] p-4 bg-background border border-border rounded-lg focus:border-primary focus:outline-none text-base"
                            placeholder="Escribe la descripci√≥n y notas del movimiento financiero..."
                        ></div>
                    </div>

                    <!-- Footer -->
                    <div class="flex items-center justify-between p-4 border-t border-border gap-4">
                        <div class="flex items-center gap-2">
                            <button id="finance-voice-note-btn" class="flex items-center gap-2 px-4 py-2 bg-surface-light border border-border rounded hover:border-primary transition-all">
                                <i class="fas fa-microphone"></i>
                                <span>Nota de Voz</span>
                            </button>
                        </div>

                        <div class="flex items-center gap-2">
                            <span class="text-xs text-text-secondary" id="finance-editor-char-count">0 caracteres</span>
                            <button id="finance-editor-cancel-btn" class="px-4 py-2 border border-border rounded hover:bg-surface-light transition-all">
                                Cancelar
                            </button>
                            <button id="finance-editor-save-btn" class="primary px-4 py-2">
                                <i class="fas fa-check mr-2"></i>Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenido de Movimientos -->
            <div id="finances-view-movements">
             <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                <div><label class="block mb-2 text-text-secondary">Filtrar por fecha:</label><div class="flex items-center space-x-2"><button id="finances-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded" title="Filtrar por fecha"><i class="fas fa-calendar-alt"></i></button><div id="finances-date-filter-display" class="date-filter-display-text text-sm text-text-secondary">Sin filtro de fecha</div></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 w-full lg:w-auto">
                    <div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">P/L de Trading</h4><p id="finance-trading-pl" class="text-xl font-bold text-green hide-amount">$0.00</p></div>
                    <div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Win Rate</h4><p id="finance-win-rate" class="text-xl font-bold text-green">0%</p></div>
                    <div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Ingresos</h4><p id="finance-total-income" class="text-xl font-bold text-green hide-amount">$0.00</p></div>
                    <div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Gastos</h4><p id="finance-total-expenses" class="text-xl font-bold text-red hide-amount">$0.00</p></div>
                    <div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Balance Neto</h4><p id="finance-net-balance" class="text-xl font-bold text-white hide-amount">$0.00</p></div>
                </div>
            </div>
            <!-- Registro de Movimientos - Ancho completo -->
            <div class="metric-card mb-6">
                <h3 class="text-lg font-semibold mb-4">Registro de Movimientos</h3>
                <div class="overflow-x-auto">
                    <table id="finances-table" class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left">Fecha</th>
                                <th class="text-left">Descripci√≥n / Notas</th>
                                <th class="text-right">Monto</th>
                                <th class="text-center">Divisa</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="finances-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Evoluci√≥n Financiera - Ancho completo con vista expandible -->
            <div class="metric-card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Evoluci√≥n Financiera</h3>
                    <button id="expand-evolution-chart-btn" class="text-sm px-3 py-1 border border-border rounded hover:border-primary transition-all">
                        <i class="fas fa-expand mr-2"></i>Ver en Pantalla Completa
                    </button>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="finances-evolution-chart"></canvas>
                </div>
            </div>

            <!-- Modal de Gr√°fico en Pantalla Completa -->
            <div id="evolution-chart-fullscreen" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex items-center justify-center p-4">
                <div class="w-full h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold">Evoluci√≥n Financiera</h3>
                        <button id="close-evolution-fullscreen-btn" class="text-2xl text-text-secondary hover:text-text">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex-1 bg-surface rounded-lg p-4">
                        <canvas id="finances-evolution-chart-fullscreen"></canvas>
                    </div>
                </div>
            </div>

            <!-- Nueva fila: Flujo de Caja y Profit vs Expenses -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Flujo de Caja Mensual</h3>
                    <p class="text-xs text-text-secondary mb-3">Comparaci√≥n de ingresos (trading + manuales) vs gastos</p>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="finances-cashflow-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Profit vs Expenses</h3>
                    <p class="text-xs text-text-secondary mb-3">Ganancias de trading comparadas con gastos totales</p>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="finances-profit-expenses-chart"></canvas>
                    </div>
                </div>
            </div>
            </div>
            <!-- Fin de Movimientos -->

            <!-- Contenido de Calendario -->
            <div id="finances-view-calendar" class="hidden">
            <!-- Calendario Financiero -->
            <div class="metric-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Calendario Financiero</h3>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-xs flex items-center gap-1">
                                <span class="inline-block w-3 h-3 rounded-full bg-green"></span>
                                Ingresos
                            </span>
                            <span class="text-xs flex items-center gap-1">
                                <span class="inline-block w-3 h-3 rounded-full bg-red"></span>
                                Gastos
                            </span>
                            <span class="text-xs flex items-center gap-1">
                                <span class="inline-block w-3 h-3 rounded-full bg-blue"></span>
                                Trading
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="finances-calendar-prev" class="p-2 hover:bg-surface-light rounded">
                                <i class="fas fa-chevron-left text-sm"></i>
                            </button>
                            <span id="finances-calendar-month-year" class="text-sm font-semibold min-w-[120px] text-center"></span>
                            <button id="finances-calendar-next" class="p-2 hover:bg-surface-light rounded">
                                <i class="fas fa-chevron-right text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="finances-calendar-container" class="overflow-x-auto">
                    <!-- El calendario se generar√° din√°micamente aqu√≠ -->
                </div>
            </div>
            </div>
            <!-- Fin de Calendario -->
        </section>

        <section id="news" class="section-container">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card p-0 flex flex-col">
                    <h3 class="text-lg font-semibold p-4 pb-2">Calendario de Noticias Econ√≥micas</h3>
                    <div class="flex-grow" style="min-height: 600px;">
                        <!-- TradingView Widget BEGIN -->
                        <div class="tradingview-widget-container">
                          <div class="tradingview-widget-container__widget"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                          {
                          "colorTheme": "dark",
                          "isTransparent": true,
                          "width": "100%",
                          "height": "100%",
                          "locale": "es",
                          "importanceFilter": "-1,0,1",
                          "currencyFilter": "USD,EUR,JPY,GBP,CHF,AUD,CAD,NZD,CNY"
                          }
                          </script>
                        </div>
                        <!-- TradingView Widget END -->
                    </div>
                </div>
                <div class="metric-card p-0 flex flex-col">
                    <h3 class="text-lg font-semibold p-4 pb-2">√öltimas Noticias del Mercado</h3>
                    <div class="flex-grow" style="min-height: 600px;">
                        <!-- TradingView Widget BEGIN -->
                        <div class="tradingview-widget-container">
                          <div class="tradingview-widget-container__widget"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                          {
                          "feedMode": "all_symbols",
                          "colorTheme": "dark",
                          "isTransparent": true,
                          "displayMode": "regular",
                          "width": "100%",
                          "height": "100%",
                          "locale": "es"
                          }
                          </script>
                        </div>
                        <!-- TradingView Widget END -->
                    </div>
                </div>
            </div>
             <div class="metric-card p-4 mt-6">
                <h3 class="text-lg font-semibold mb-2">Visi√≥n General del Mercado</h3>
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                  <div class="tradingview-widget-container__widget"></div>
                                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                                    {"colorTheme":"dark","dateRange":"12M","showChart":true,"locale":"es","largeChartUrl":"","isTransparent":true,"showSymbolLogo":true,"showFloatingTooltip":false,"width":"100%","height":"660","plotLineColorGrowing":"rgba(57, 255, 20, 1)","plotLineColorFalling":"rgba(255, 65, 54, 1)","gridLineColor":"rgba(42, 42, 42, 1)","scaleFontColor":"rgba(160, 160, 160, 1)","belowLineFillColorGrowing":"rgba(57, 255, 20, 0.12)","belowLineFillColorFalling":"rgba(255, 65, 54, 0.12)","belowLineFillColorGrowingBottom":"rgba(57, 255, 20, 0)","belowLineFillColorFallingBottom":"rgba(255, 65, 54, 0)","symbolActiveColor":"rgba(57, 255, 20, 0.12)","tabs":[{"title":"√çndices","symbols":[{"s":"FOREXCOM:SPXUSD","d":"S&P 500"},{"s":"FOREXCOM:NSXUSD","d":"US 100"},{"s":"FOREXCOM:DJI","d":"Dow 30"},{"s":"INDEX:DEU40","d":"DAX 40"},{"s":"FOREXCOM:UKXGBP","d":"UK 100"},{"s":"CAPITALCOM:JP225","d":"Nikkei 225"}],"originalTitle":"Indices"},{"title":"Criptomonedas","symbols":[{"s":"BITSTAMP:BTCUSD","d":"Bitcoin"},{"s":"BITSTAMP:ETHUSD","d":"Ethereum"},{"s":"COINBASE:SOLUSD","d":"Solana"},{"s":"COINBASE:XRPUSD","d":"Ripple"},{"s":"COINBASE:DOGEUSD","d":"Dogecoin"},{"s":"COINBASE:ADAUSD","d":"Cardano"}],"originalTitle":"Cryptocurrencies"},{"title":"Materias primas","symbols":[{"s":"COMEX:GC1!","d":"Oro"},{"s":"NYMEX:CL1!","d":"Petr√≥leo Crudo"},{"s":"TVC:SILVER","d":"Plata"},{"s":"NYMEX:NG1!","d":"Gas Natural"},{"s":"TVC:COPPER","d":"Cobre"},{"s":"CBOT:ZC1!","d":"Ma√≠z"}],"originalTitle":"Commodities"},{"title":"Forex","symbols":[{"s":"FX:EURUSD","d":"EUR/USD"},{"s":"FX:GBPUSD","d":"GBP/USD"},{"s":"FX:USDJPY","d":"USD/JPY"},{"s":"FX:USDCHF","d":"USD/CHF"},{"s":"FX:AUDUSD","d":"AUD/USD"},{"s":"FX:USDCAD","d":"USD/CAD"}],"originalTitle":"Forex"}]}
                                    </script>
                </div>
                <!-- TradingView Widget END -->
            </div>
        </section>

        <section id="config" class="section-container">
            <div class="config-layout">
                <!-- Config Sidebar -->
                <aside class="config-sidebar">
                    <h2 class="config-sidebar-title">Configuraci√≥n</h2>
                    <nav class="config-nav">
                        <div class="config-nav-item active" data-config-section="user-info">
                            <i class="fas fa-user"></i>
                            <span>Informaci√≥n de Usuario</span>
                        </div>
                        <div class="config-nav-item" data-config-section="account-security">
                            <i class="fas fa-shield-alt"></i>
                            <span>Seguridad de Cuenta</span>
                        </div>
                        <div class="config-nav-item" data-config-section="billing">
                            <i class="fas fa-credit-card"></i>
                            <span>Planes y Facturaci√≥n</span>
                        </div>
                        <div class="config-nav-item" data-config-section="mentorship">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Mentor√≠a Daniel HDZ</span>
                        </div>
                        <div class="config-nav-item" data-config-section="import-export">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Importar/Exportar</span>
                        </div>
                        <div class="config-nav-item" data-config-section="preferences">
                            <i class="fas fa-sliders-h"></i>
                            <span>Preferencias</span>
                        </div>
                        <div class="config-nav-item" data-config-section="notifications">
                            <i class="fas fa-bell"></i>
                            <span>Notificaciones</span>
                        </div>
                        <div class="config-nav-item" data-config-section="privacy">
                            <i class="fas fa-lock"></i>
                            <span>Privacidad y Datos</span>
                        </div>
                    </nav>
                </aside>

                <!-- Config Content Area -->
                <div class="config-content">
                    <!-- 1. INFORMACI√ìN DE USUARIO -->
                    <div class="config-section active" id="config-user-info">
                        <h2 class="config-section-title">Informaci√≥n de Usuario</h2>
                        <p class="config-section-subtitle">Administra tu informaci√≥n personal y perfil</p>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Perfil de Usuario</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="user-profile-display">
                                    <div class="user-avatar-large">
                                        <span id="config-user-avatar">D</span>
                                    </div>
                                    <div class="user-profile-info">
                                        <div class="form-group">
                                            <label>Foto de Perfil</label>
                                            <div class="flex items-center space-x-4">
                                                <div id="config-profile-preview" class="w-20 h-20 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold overflow-hidden">
                                                    D
                                                </div>
                                                <div class="flex flex-col space-y-2">
                                                    <label for="config-profile-image" class="btn-outline cursor-pointer inline-block">
                                                        <i class="fas fa-camera mr-2"></i>Cambiar Foto
                                                    </label>
                                                    <input type="file" id="config-profile-image" accept="image/*" style="display: none;">
                                                    <button id="config-remove-profile-image" class="btn-danger text-sm" style="display: none;">
                                                        <i class="fas fa-trash mr-2"></i>Eliminar Foto
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-xs text-text-secondary mt-2">Formatos: JPG, PNG, GIF. Tama√±o m√°ximo: 2MB</p>
                                        </div>
                                        <div class="form-group">
                                            <label>Nombre de Usuario</label>
                                            <input type="text" id="config-username" class="form-control" placeholder="Tu nombre">
                                        </div>
                                        <div class="form-group">
                                            <label>Correo Electr√≥nico</label>
                                            <input type="email" id="config-user-email" class="form-control" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label>Fecha de Registro</label>
                                            <input type="text" id="config-user-since" class="form-control" disabled value="Noviembre 2024">
                                        </div>
                                        <div class="form-group">
                                            <label>Pa√≠s/Ubicaci√≥n</label>
                                            <select id="config-user-country" class="form-control">
                                                <option value="">Seleccionar pa√≠s...</option>
                                                <option value="ES">üá™üá∏ Espa√±a</option>
                                                <option value="MX">üá≤üáΩ M√©xico</option>
                                                <option value="AR">üá¶üá∑ Argentina</option>
                                                <option value="CO">üá®üá¥ Colombia</option>
                                                <option value="CL">üá®üá± Chile</option>
                                                <option value="PE">üáµüá™ Per√∫</option>
                                                <option value="VE">üáªüá™ Venezuela</option>
                                                <option value="EC">üá™üá® Ecuador</option>
                                                <option value="UY">üá∫üáæ Uruguay</option>
                                                <option value="PY">üáµüáæ Paraguay</option>
                                                <option value="BO">üáßüá¥ Bolivia</option>
                                                <option value="CR">üá®üá∑ Costa Rica</option>
                                                <option value="PA">üáµüá¶ Panam√°</option>
                                                <option value="DO">üá©üá¥ Rep√∫blica Dominicana</option>
                                                <option value="PR">üáµüá∑ Puerto Rico</option>
                                                <option value="US">üá∫üá∏ Estados Unidos</option>
                                                <option value="CA">üá®üá¶ Canad√°</option>
                                                <option value="BR">üáßüá∑ Brasil</option>
                                                <option value="PT">üáµüáπ Portugal</option>
                                                <option value="GB">üá¨üáß Reino Unido</option>
                                                <option value="DE">üá©üá™ Alemania</option>
                                                <option value="FR">üá´üá∑ Francia</option>
                                                <option value="IT">üáÆüáπ Italia</option>
                                                <option value="OTHER">üåç Otro</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Configuraci√≥n de Perfil P√∫blico -->
                                <div class="status-card status-card-info mt-6">
                                    <i class="fas fa-users status-card-icon"></i>
                                    <div>
                                        <p class="font-semibold mb-2">Perfil P√∫blico en Social Media</p>
                                        <p class="text-sm mb-4">Comparte tu rendimiento de trading con la comunidad. Tu perfil aparecer√° en el ranking p√∫blico y otros traders podr√°n ver tus estad√≠sticas de audici√≥n.</p>
                                        <div class="flex items-center space-x-3">
                                            <label class="switch">
                                                <input type="checkbox" id="config-public-profile">
                                                <span class="slider"></span>
                                            </label>
                                            <span id="config-public-profile-label" class="text-sm font-semibold text-text-secondary">Perfil Privado</span>
                                        </div>
                                        <p class="text-xs text-text-secondary mt-3">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Al activar el perfil p√∫blico, tu nombre de usuario, pa√≠s y estad√≠sticas de trading ser√°n visibles en la secci√≥n Social Media.
                                        </p>
                                    </div>
                                </div>

                                <div class="config-actions">
                                    <button class="btn-primary" id="save-user-info">
                                        <i class="fas fa-save mr-2"></i>Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. SEGURIDAD DE CUENTA -->
                    <div class="config-section" id="config-account-security">
                        <h2 class="config-section-title">Seguridad de Cuenta</h2>
                        <p class="config-section-subtitle">Gestiona tu contrase√±a y estado de sesi√≥n</p>

                        <!-- Estado de Sesi√≥n -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Estado de Sesi√≥n</h3>
                            </div>
                            <div class="config-card-body">
                                <div id="config-auth-status-logged-out" class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>
                                        <p class="font-semibold">Sin sesi√≥n activa</p>
                                        <p class="text-sm mt-1">Tus operaciones se guardan localmente. Para sincronizar en la nube, inicia sesi√≥n.</p>
                                    </div>
                                    <button id="config-show-auth-modal-btn" class="btn-primary mt-3">
                                        <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
                                    </button>
                                </div>

                                <div id="config-auth-status-logged-in" class="alert alert-success" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <div>
                                        <p class="font-semibold">Sesi√≥n activa</p>
                                        <p class="text-sm mt-1">Usuario: <span id="config-current-user-email"></span></p>
                                        <p class="text-xs mt-1">Datos sincronizados autom√°ticamente</p>
                                    </div>
                                    <button id="config-logout-btn" class="btn-danger mt-3">
                                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Cambiar Contrase√±a -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Cambiar Contrase√±a</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="form-group">
                                    <label>Contrase√±a Actual</label>
                                    <input type="password" id="current-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="form-group">
                                    <label>Nueva Contrase√±a</label>
                                    <input type="password" id="new-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="form-group">
                                    <label>Confirmar Nueva Contrase√±a</label>
                                    <input type="password" id="confirm-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="config-actions">
                                    <button class="btn-primary" id="change-password-btn">
                                        <i class="fas fa-key mr-2"></i>Actualizar Contrase√±a
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Autenticaci√≥n de Dos Factores -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Autenticaci√≥n de Dos Factores (2FA)</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Activar 2FA</p>
                                        <p class="text-sm text-text-secondary">Agrega una capa adicional de seguridad a tu cuenta</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enable-2fa">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-xs text-text-secondary mt-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Pr√≥ximamente disponible
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. PLANES Y FACTURACI√ìN -->
                    <div class="config-section" id="config-billing">
                        <h2 class="config-section-title">Planes y Facturaci√≥n</h2>
                        <p class="config-section-subtitle">Administra tu suscripci√≥n y m√©todos de pago</p>

                        <!-- Plan Actual -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Plan Actual</h3>
                                <span class="badge-success">Activo</span>
                            </div>
                            <div class="config-card-body">
                                <div class="plan-display">
                                    <div class="plan-icon">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div class="plan-info">
                                        <h4>Trader Survivor Premium</h4>
                                        <p class="plan-price">$129 USD<span>/ilimitado</span></p>
                                        <p class="text-sm text-text-secondary mt-2">Suscripci√≥n de por vida ‚Ä¢ Acceso completo</p>
                                    </div>
                                </div>

                                <div class="plan-features">
                                    <h5 class="font-semibold mb-3">Beneficios Incluidos:</h5>
                                    <ul class="feature-list">
                                        <li><i class="fas fa-check"></i> Trading Journal completo e ilimitado</li>
                                        <li><i class="fas fa-check"></i> Analytics avanzado con m√©tricas profesionales</li>
                                        <li><i class="fas fa-check"></i> Importaci√≥n autom√°tica desde exchanges</li>
                                        <li><i class="fas fa-check"></i> Gr√°ficos TradingView integrados en tiempo real</li>
                                        <li><i class="fas fa-check"></i> Calendario econ√≥mico y noticias financieras</li>
                                        <li><i class="fas fa-check"></i> Exportaci√≥n de reportes en PDF y Excel</li>
                                        <li><i class="fas fa-check"></i> Sincronizaci√≥n en la nube ilimitada</li>
                                        <li><i class="fas fa-check"></i> M√∫ltiples cuentas de trading</li>
                                        <li><i class="fas fa-check"></i> Soporte t√©cnico prioritario 24/7</li>
                                        <li><i class="fas fa-check"></i> Actualizaciones y nuevas funciones gratis</li>
                                    </ul>
                                </div>

                                <div class="plan-stats">
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-trades-count">0</span>
                                        <span class="stat-label">Operaciones Registradas</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-accounts-count">0</span>
                                        <span class="stat-label">Cuentas Conectadas</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value">Ilimitado</span>
                                        <span class="stat-label">Espacio Disponible</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historial de Pagos -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Historial de Facturaci√≥n</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="billing-history">
                                    <div class="billing-item">
                                        <div>
                                            <p class="font-semibold">Trader Survivor Premium</p>
                                            <p class="text-sm text-text-secondary">07 Nov 2024 ‚Ä¢ Pago √∫nico</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-primary">$129.00 USD</p>
                                            <button class="btn-link text-sm">
                                                <i class="fas fa-download mr-1"></i>Factura
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. MENTOR√çA CON DANIEL HDZ -->
                    <div class="config-section" id="config-mentorship">
                        <h2 class="config-section-title">Mentor√≠a con Daniel HDZ</h2>
                        <p class="config-section-subtitle">Aprende de un trader profesional con 10+ a√±os de experiencia</p>

                        <!-- Perfil del Mentor -->
                        <div class="config-card mentor-card">
                            <div class="config-card-body">
                                <div class="mentor-profile">
                                    <div class="mentor-avatar">
                                        <img src="https://ui-avatars.com/api/?name=Daniel+HDZ&size=120&background=39ff14&color=0a0a0a&bold=true" alt="Daniel HDZ">
                                        <div class="mentor-badge">
                                            <i class="fas fa-certificate"></i>
                                        </div>
                                    </div>
                                    <div class="mentor-info">
                                        <h3>Daniel HDZ</h3>
                                        <p class="mentor-title">Trader Profesional ‚Ä¢ Mentor Certificado</p>
                                        <div class="mentor-stats">
                                            <div class="mentor-stat">
                                                <i class="fas fa-chart-line"></i>
                                                <span>10+ a√±os de experiencia</span>
                                            </div>
                                            <div class="mentor-stat">
                                                <i class="fas fa-users"></i>
                                                <span>500+ traders formados</span>
                                            </div>
                                            <div class="mentor-stat">
                                                <i class="fas fa-trophy"></i>
                                                <span>Rentabilidad consistente</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mentor-description">
                                    <h4 class="font-semibold mb-3">Sobre Daniel HDZ</h4>
                                    <p class="text-text-secondary mb-4">
                                        Trader profesional especializado en mercados financieros con m√°s de una d√©cada de experiencia operando en Forex, Futuros y Criptomonedas. 
                                        Ha desarrollado estrategias probadas que combinan an√°lisis t√©cnico avanzado, gesti√≥n de riesgo institucional y psicolog√≠a del trading.
                                    </p>
                                    <p class="text-text-secondary mb-4">
                                        Como mentor, Daniel se enfoca en formar traders disciplinados y rentables, ense√±ando no solo estrategias de trading sino tambi√©n 
                                        la mentalidad y gesti√≥n emocional necesarias para tener √©xito sostenible en los mercados.
                                    </p>
                                </div>

                                <div class="mentorship-services">
                                    <h4 class="font-semibold mb-3">Servicios de Mentor√≠a</h4>
                                    <div class="services-grid">
                                        <div class="service-item">
                                            <i class="fas fa-video"></i>
                                            <h5>Sesiones 1 a 1</h5>
                                            <p>Mentor√≠a personalizada v√≠a Zoom</p>
                                        </div>
                                        <div class="service-item">
                                            <i class="fas fa-book"></i>
                                            <h5>Curso Completo</h5>
                                            <p>De principiante a trader profesional</p>
                                        </div>
                                        <div class="service-item">
                                            <i class="fas fa-comments"></i>
                                            <h5>Grupo VIP</h5>
                                            <p>Comunidad exclusiva de traders</p>
                                        </div>
                                        <div class="service-item">
                                            <i class="fas fa-chart-bar"></i>
                                            <h5>An√°lisis de Mercado</h5>
                                            <p>Se√±ales y setups diarios</p>
                                        </div>
                                        <div class="service-item">
                                            <i class="fas fa-headset"></i>
                                            <h5>Soporte 24/7</h5>
                                            <p>Acompa√±amiento continuo</p>
                                        </div>
                                        <div class="service-item">
                                            <i class="fas fa-certificate"></i>
                                            <h5>Certificaci√≥n</h5>
                                            <p>Diploma de trader profesional</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mentorship-contact">
                                    <h4 class="font-semibold mb-3">¬øInteresado en la Mentor√≠a?</h4>
                                    <p class="text-text-secondary mb-4">
                                        Cont√°ctame directamente para conocer los planes disponibles y c√≥mo podemos trabajar juntos para alcanzar tus objetivos en el trading.
                                    </p>
                                    <div class="contact-methods">
                                        <a href="mailto:daniel.hdz.trader@gmail.com" class="btn-primary">
                                            <i class="fas fa-envelope mr-2"></i>daniel.hdz.trader@gmail.com
                                        </a>
                                        <button class="btn-outline" onclick="window.open('https://wa.me/1234567890', '_blank')">
                                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                        </button>
                                        <button class="btn-outline" onclick="window.open('https://t.me/danielhdz', '_blank')">
                                            <i class="fab fa-telegram mr-2"></i>Telegram
                                        </button>
                                    </div>
                                </div>

                                <div class="testimonials">
                                    <h4 class="font-semibold mb-3">Testimonios</h4>
                                    <div class="testimonial-item">
                                        <div class="testimonial-header">
                                            <div class="testimonial-avatar">JM</div>
                                            <div>
                                                <p class="font-semibold">Juan Mart√≠nez</p>
                                                <div class="rating">
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="testimonial-text">
                                            "La mentor√≠a con Daniel transform√≥ completamente mi trading. Pas√© de perder dinero constantemente a tener rentabilidad mensual consistente."
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. IMPORTAR/EXPORTAR -->
                    <div class="config-section" id="config-import-export">
                        <h2 class="config-section-title">Importar y Exportar Datos</h2>
                        <p class="config-section-subtitle">Gestiona tus operaciones y respaldos</p>

                        <!-- Importar CSV -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Importar Operaciones desde CSV</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="import-zone">
                                    <div class="upload-area" id="csv-drop-zone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p class="font-semibold">Arrastra tu archivo CSV aqu√≠</p>
                                        <p class="text-sm text-text-secondary">o haz clic para seleccionar</p>
                                        <input type="file" id="config-csv-file-input" accept=".csv" style="display: none;">
                                        <button class="btn-primary mt-3" onclick="document.getElementById('config-csv-file-input').click()">
                                            <i class="fas fa-folder-open mr-2"></i>Seleccionar Archivo
                                        </button>
                                    </div>
                                </div>

                                <div class="csv-format-info mt-4">
                                    <h5 class="font-semibold mb-2">Formato del CSV:</h5>
                                    <code class="code-block">
                                        Nombre Cuenta, ID, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM), 
                                        Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L, Divisa, 
                                        Tarifa/Comision, Notas
                                    </code>
                                    <p class="text-xs text-text-secondary mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>ID:</strong> Usa el mismo ID para agrupar operaciones parciales de la misma posici√≥n
                                    </p>
                                </div>

                                <button class="btn-primary mt-4" id="config-import-csv-btn">
                                    <i class="fas fa-upload mr-2"></i>Importar CSV
                                </button>
                                <div id="config-csv-import-status" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Exportar Datos -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Exportar Datos</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="export-options">
                                    <div class="export-option">
                                        <div>
                                            <h5 class="font-semibold">Exportar como JSON</h5>
                                            <p class="text-sm text-text-secondary">Respaldo completo de todas tus operaciones y configuraciones</p>
                                        </div>
                                        <button class="btn-outline" id="config-export-json">
                                            <i class="fas fa-download mr-2"></i>Exportar JSON
                                        </button>
                                    </div>
                                    <div class="export-option">
                                        <div>
                                            <h5 class="font-semibold">Exportar como CSV</h5>
                                            <p class="text-sm text-text-secondary">Operaciones en formato CSV para Excel</p>
                                        </div>
                                        <button class="btn-outline" id="config-export-csv">
                                            <i class="fas fa-file-csv mr-2"></i>Exportar CSV
                                        </button>
                                    </div>
                                    <div class="export-option">
                                        <div>
                                            <h5 class="font-semibold">Exportar Reporte PDF</h5>
                                            <p class="text-sm text-text-secondary">Informe completo con gr√°ficos y estad√≠sticas</p>
                                        </div>
                                        <button class="btn-outline" id="config-export-pdf">
                                            <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Importar Respaldo -->
                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Restaurar desde Respaldo</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle"></i>
                                    <p>Importar un respaldo reemplazar√° todos tus datos actuales. Se recomienda hacer un respaldo antes.</p>
                                </div>
                                <label for="config-import-json" class="btn-outline cursor-pointer">
                                    <i class="fas fa-upload mr-2"></i>Seleccionar Respaldo (.json)
                                </label>
                                <input type="file" id="config-import-json" accept=".json" style="display: none;">
                            </div>
                        </div>

                        <!-- Borrar Datos -->
                        <div class="config-card border-danger">
                            <div class="config-card-header">
                                <h3>Zona de Peligro</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="alert alert-danger mb-4">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p class="font-semibold">¬°Cuidado! Esta acci√≥n no se puede deshacer</p>
                                </div>
                                <button class="btn-danger" id="config-clear-data">
                                    <i class="fas fa-trash-alt mr-2"></i>Borrar Todos los Datos
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 6. PREFERENCIAS -->
                    <div class="config-section" id="config-preferences">
                        <h2 class="config-section-title">Preferencias</h2>
                        <p class="config-section-subtitle">Personaliza tu experiencia en Trader Survivor</p>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Visualizaci√≥n</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Modo Oscuro</p>
                                        <p class="text-sm text-text-secondary">Tema oscuro activado permanentemente</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Mostrar Tooltips</p>
                                        <p class="text-sm text-text-secondary">Ayudas contextuales en gr√°ficos</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="config-show-tooltips" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Animaciones</p>
                                        <p class="text-sm text-text-secondary">Transiciones suaves en la interfaz</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="config-animations" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Formato de Datos</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="form-group">
                                    <label>Zona Horaria</label>
                                    <select class="form-control" id="config-timezone">
                                        <option value="UTC-5">UTC-5 (EST - New York)</option>
                                        <option value="UTC-6">UTC-6 (CST - Mexico City)</option>
                                        <option value="UTC">UTC+0 (GMT - London)</option>
                                        <option value="UTC+1">UTC+1 (CET - Madrid)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Formato de Fecha</label>
                                    <select class="form-control" id="config-date-format">
                                        <option value="YYYY-MM-DD">YYYY-MM-DD (2024-11-07)</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (07/11/2024)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (11/07/2024)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Divisa Principal</label>
                                    <select class="form-control" id="config-currency">
                                        <option value="USD">USD - D√≥lar Estadounidense</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - Libra Esterlina</option>
                                        <option value="MXN">MXN - Peso Mexicano</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 7. NOTIFICACIONES -->
                    <div class="config-section" id="config-notifications">
                        <h2 class="config-section-title">Notificaciones</h2>
                        <p class="config-section-subtitle">Configura c√≥mo quieres recibir actualizaciones</p>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Notificaciones por Email</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Resumen Semanal</p>
                                        <p class="text-sm text-text-secondary">Recibe un resumen de tu trading cada semana</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notif-weekly-summary" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Alertas de Objetivos</p>
                                        <p class="text-sm text-text-secondary">Te avisamos cuando alcances tus metas</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notif-goals">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Actualizaciones de Producto</p>
                                        <p class="text-sm text-text-secondary">Nuevas funciones y mejoras</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notif-updates" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Notificaciones Push</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle"></i>
                                    <p>Las notificaciones push estar√°n disponibles pr√≥ximamente</p>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Activar Notificaciones Push</p>
                                        <p class="text-sm text-text-secondary">Recibe alertas en tiempo real</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 8. PRIVACIDAD Y DATOS -->
                    <div class="config-section" id="config-privacy">
                        <h2 class="config-section-title">Privacidad y Datos</h2>
                        <p class="config-section-subtitle">Controla tu informaci√≥n y privacidad</p>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Privacidad de Datos</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Sincronizaci√≥n en la Nube</p>
                                        <p class="text-sm text-text-secondary">Guardar datos en Supabase</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="privacy-cloud-sync" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <div>
                                        <p class="font-semibold">Analytics An√≥nimo</p>
                                        <p class="text-sm text-text-secondary">Ay√∫danos a mejorar con datos an√≥nimos</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="privacy-analytics" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <div class="config-card-header">
                                <h3>Descargar tus Datos</h3>
                            </div>
                            <div class="config-card-body">
                                <p class="text-text-secondary mb-4">
                                    Descarga una copia completa de todos tus datos personales y operaciones seg√∫n GDPR
                                </p>
                                <button class="btn-outline">
                                    <i class="fas fa-download mr-2"></i>Solicitar Descarga de Datos
                                </button>
                            </div>
                        </div>

                        <div class="config-card border-danger">
                            <div class="config-card-header">
                                <h3>Eliminar Cuenta</h3>
                            </div>
                            <div class="config-card-body">
                                <div class="alert alert-danger mb-4">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p class="font-semibold">Esta acci√≥n es permanente e irreversible</p>
                                    <p class="text-sm mt-1">Se eliminar√°n todos tus datos, operaciones y configuraciones</p>
                                </div>
                                <button class="btn-danger" id="delete-account-btn">
                                    <i class="fas fa-user-times mr-2"></i>Eliminar mi Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NUEVA SECCI√ìN: PLATAFORMAS -->
        <section id="platforms" class="section-container">
            <h2 class="text-xl font-semibold mb-6">Plataformas de Trading</h2>

            <!-- Grid de Plataformas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- BingX -->
                <div class="platform-card cursor-pointer" data-platform="bingx">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#006FFF] overflow-hidden">
                                <img src="/logos/bingx-logo.png" alt="BingX Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">BingX</h3>
                                <p class="text-sm text-text-secondary">Exchange Global</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="bingx-status-indicator" class="text-yellow-400">No conectado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span id="bingx-last-sync" class="text-text-secondary">Nunca</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div id="bingx-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="bingx-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de BingX">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="bingx-quick-sync" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Sincronizar con BingX">
                                <i class="fas fa-sync-alt text-xs"></i>
                                <span>API</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NinjaTrader -->
                <div class="platform-card cursor-pointer" data-platform="ninjatrader">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#FF6600] overflow-hidden">
                                <img src="/logos/ninja-logo.png" alt="NinjaTrader" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <i class="fas fa-chart-bar text-4xl text-white" style="display:none;"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">NinjaTrader 8</h3>
                                <p class="text-sm text-text-secondary">API Automation</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="ninjatrader-status-indicator" class="text-yellow-400">No conectado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span id="ninjatrader-last-sync" class="text-text-secondary">Nunca</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div id="ninjatrader-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="ninjatrader-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de NinjaTrader">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="ninjatrader-quick-sync" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Sincronizar Archivos">
                                <i class="fas fa-sync-alt text-xs"></i>
                                <span>Sync</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tradovate -->
                <div class="platform-card cursor-pointer" data-platform="tradovate">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#0066CC] overflow-hidden">
                                <img src="/logos/tradovate-logo.png" alt="Tradovate Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Tradovate</h3>
                                <p class="text-sm text-text-secondary">Futures Trading</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="tradovate-status-indicator" class="text-yellow-400">No conectado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span id="tradovate-last-sync" class="text-text-secondary">Nunca</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div id="tradovate-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="tradovate-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de Tradovate">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="tradovate-quick-sync" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Sincronizar con Tradovate">
                                <i class="fas fa-sync-alt text-xs"></i>
                                <span>API</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bitget -->
                <div class="platform-card cursor-pointer" data-platform="bitget">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#54FDD5] overflow-hidden">
                                <img src="/logos/bitget-logo.png" alt="Bitget Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Bitget</h3>
                                <p class="text-sm text-text-secondary">Exchange Global</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="bitget-status-indicator" class="text-yellow-400">No conectado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span id="bitget-last-sync" class="text-text-secondary">Nunca</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div id="bitget-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="bitget-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de Bitget">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="bitget-quick-sync" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Sincronizar con Bitget">
                                <i class="fas fa-sync-alt text-xs"></i>
                                <span>API</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Binance -->
                <div class="platform-card cursor-pointer" data-platform="binance">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all opacity-50">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#F3BA2F] overflow-hidden">
                                <img src="/logos/binance-logo.png" alt="Binance Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Binance</h3>
                                <p class="text-sm text-text-secondary">Exchange L√≠der</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-gray-500">Pr√≥ximamente</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-xs text-gray-500 bg-surface px-2 py-1 rounded">En desarrollo</span>
                        </div>
                    </div>
                </div>

                <!-- MEXC -->
                <div class="platform-card cursor-pointer" data-platform="mexc">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#00C087] overflow-hidden">
                                <img src="/logos/mexc-logo.png" alt="MEXC Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">MEXC</h3>
                                <p class="text-sm text-text-secondary">Exchange Global</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="mexc-status-indicator" class="text-yellow-400">No conectado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span id="mexc-last-sync" class="text-text-secondary">Nunca</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div id="mexc-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="mexc-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de MEXC">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="mexc-quick-sync" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Sincronizar con MEXC">
                                <i class="fas fa-sync-alt text-xs"></i>
                                <span>API</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bitunix -->
                <div class="platform-card cursor-pointer" data-platform="bitunix">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all opacity-50">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-gradient-to-r from-purple-500 to-pink-500 overflow-hidden">
                                <img src="/logos/bitunix-logo.png" alt="Bitunix Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Bitunix</h3>
                                <p class="text-sm text-text-secondary">Exchange Emergente</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-gray-500">Pr√≥ximamente</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-xs text-gray-500 bg-surface px-2 py-1 rounded">En desarrollo</span>
                        </div>
                    </div>
                </div>

                <!-- PrimeXBT Crypto -->
                <div class="platform-card cursor-pointer" data-platform="primexbtcrypto">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#FF6B35] overflow-hidden">
                                <img src="/logos/primexbt-logo.png" alt="PrimeXBT Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">PrimeXBT Crypto</h3>
                                <p class="text-sm text-text-secondary">Exchange Global</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-yellow-400">Importaci√≥n manual</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span class="text-text-secondary">Manual</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="primexbt-crypto-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de PrimeXBT Crypto">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                            <button id="primexbt-crypto-import-interface" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar desde Interfaz de PrimeXBT">
                                <i class="fas fa-paste text-xs"></i>
                                <span>Interfaz</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PrimeXBT CFDs -->
                <div class="platform-card cursor-pointer" data-platform="primexbtcfds">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#FF6B35] overflow-hidden">
                                <img src="/logos/primexbt-logo.png" alt="PrimeXBT Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">PrimeXBT CFDs</h3>
                                <p class="text-sm text-text-secondary">Plataforma Profesional</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-yellow-400">Importaci√≥n manual</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">√öltima sync:</span>
                                <span class="text-text-secondary">Manual</span>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="flex-1 h-2 bg-surface rounded-full overflow-hidden">
                                <div class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="primexbt-cfds-import-csv" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar CSV de PrimeXBT CFDs">
                                <i class="fas fa-file-csv text-xs"></i>
                                <span>CSV</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MetaTrader 4 -->
                <div class="platform-card cursor-pointer" data-platform="metatrader4">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#1B5E20] overflow-hidden">
                                <img src="/logos/metatrader 4-logo.png" alt="MetaTrader 4 Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">MetaTrader 4</h3>
                                <p class="text-sm text-text-secondary">Plataforma Cl√°sica</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-gray-500">Importaci√≥n manual</span>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="mt4-import-html" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar Informe HTML de MT4">
                                <i class="fas fa-file-code text-xs"></i>
                                <span>HTML</span>
                            </button>
                            <button id="mt4-clean-operations" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Limpiar operaciones con errores">
                                <i class="fas fa-broom text-xs"></i>
                                <span>Limpiar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MetaTrader 5 -->
                <div class="platform-card cursor-pointer" data-platform="metatrader5">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#1B5E20] overflow-hidden">
                                <img src="/logos/metatrader5-logo.png" alt="MetaTrader 5 Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">MetaTrader 5</h3>
                                <p class="text-sm text-text-secondary">Plataforma Profesional</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-gray-500">Importaci√≥n manual</span>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="mt5-import-html" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar Informe HTML de MT5">
                                <i class="fas fa-file-code text-xs"></i>
                                <span>HTML</span>
                            </button>
                            <button id="mt5-clean-operations" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Limpiar operaciones con errores">
                                <i class="fas fa-broom text-xs"></i>
                                <span>Limpiar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- cTrader -->
                <div class="platform-card cursor-pointer" data-platform="ctrader">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#00A8E1] overflow-hidden">
                                <img src="/logos/ctrader-logo.png" alt="cTrader Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">cTrader</h3>
                                <p class="text-sm text-text-secondary">Plataforma Avanzada</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="text-gray-500">Importaci√≥n manual</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Formato:</span>
                                <span class="text-white">HTML Statement</span>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="ctrader-import-html" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md flex items-center space-x-1 transition-colors" title="Importar HTML Statement de cTrader">
                                <i class="fas fa-file-code text-xs"></i>
                                <span>HTML</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TradingView -->
                <div class="platform-card cursor-pointer" data-platform="tradingview">
                    <div class="metric-card p-6 hover:bg-surface-light transition-all">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center mr-4 bg-[#2962FF] overflow-hidden">
                                <img src="/logos/tradingview-logo.png" alt="TradingView Logo" class="rounded-xl" style="width: 56px; height: 56px; object-fit: contain;">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">TradingView</h3>
                                <p class="text-sm text-text-secondary">Webhooks & Estrategias</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Estado:</span>
                                <span id="tradingview-status" class="text-yellow-500">‚ö†Ô∏è No configurado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Webhook:</span>
                                <span id="tradingview-webhook-status" class="text-xs text-text-secondary">Sin configurar</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-xs text-blue-400 bg-blue-500/10 px-2 py-1 rounded">‚ú® Configurar Webhooks</span>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- PANTALLA DETALLADA DE TRADINGVIEW -->
        <section id="platform-tradingview" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-tradingview">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #2962FF;">
                        <img src="/logos/tradingview-logo.png" alt="TradingView Logo" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">TradingView</h2>
                        <p class="text-text-secondary">Webhooks & Auto-Import</p>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="metric-card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-2">Estado del Webhook</h3>
                            <p id="tradingview-detail-status" class="text-sm text-text-secondary">Sin configurar</p>
                        </div>
                        <div id="tradingview-detail-indicator" class="w-4 h-4 rounded-full bg-gray-500"></div>
                    </div>
                </div>

                <!-- Configuraci√≥n Webhook -->
                <div class="metric-card p-6 mb-6">
                    <h3 class="text-lg font-bold mb-4">‚öôÔ∏è Configuraci√≥n del Webhook</h3>
                    
                    <div class="space-y-4">
                        <!-- URL del Webhook -->
                        <div>
                            <label class="block text-sm font-medium mb-2">URL del Webhook</label>
                            <div class="flex gap-2">
                                <input type="text" id="tradingview-webhook-url" 
                                    value="http://localhost:8003/webhook/tradingview"
                                    class="flex-1 bg-surface text-text-primary px-4 py-3 rounded-lg border border-primary/20 focus:border-primary focus:outline-none"
                                    readonly>
                                <button id="copy-webhook-url" class="btn-primary px-4">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="text-xs text-text-secondary mt-2">
                                üí° Copia esta URL y √∫sala en las alertas de TradingView
                            </p>
                        </div>

                        <!-- Seleccionar Cuenta -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Cuenta Destino</label>
                            <select id="tradingview-account-select" 
                                class="w-full bg-surface text-text-primary px-4 py-3 rounded-lg border border-primary/20 focus:border-primary focus:outline-none">
                                <option value="">Selecciona una cuenta...</option>
                            </select>
                            <p class="text-xs text-text-secondary mt-2">
                                Los trades del webhook se guardar√°n en esta cuenta
                            </p>
                        </div>

                        <!-- ID de Cuenta para TradingView -->
                        <div id="tradingview-account-id-section" style="display: none;">
                            <label class="block text-sm font-medium mb-2">Account ID para TradingView</label>
                            <div class="flex gap-2">
                                <input type="text" id="tradingview-account-id" 
                                    class="flex-1 bg-surface text-text-primary px-4 py-3 rounded-lg border border-primary/20 focus:border-primary focus:outline-none"
                                    readonly>
                                <button id="copy-account-id" class="btn-primary px-4">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="text-xs text-text-secondary mt-2">
                                ‚ö†Ô∏è Usa este ID en el campo <code class="bg-surface-light px-1 rounded">accountId</code> del mensaje JSON de tu alerta
                            </p>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="flex gap-3 mt-6">
                            <button id="tradingview-test-webhook" class="btn-secondary flex-1">
                                <i class="fas fa-vial mr-2"></i>
                                Probar Webhook
                            </button>
                            <button id="tradingview-save-config" class="btn-primary flex-1">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="metric-card p-6 mb-6">
                    <h3 class="text-lg font-bold mb-4">üìñ C√≥mo Configurar en TradingView</h3>
                    
                    <div class="space-y-4 text-sm">
                        <div class="bg-surface-light p-4 rounded-lg">
                            <p class="font-bold mb-2">1Ô∏è‚É£ Crea tu estrategia en Pine Script</p>
                            <p class="text-text-secondary">Usa el par√°metro <code class="bg-surface px-1 rounded">alert_message</code> en tus √≥rdenes</p>
                        </div>

                        <div class="bg-surface-light p-4 rounded-lg">
                            <p class="font-bold mb-2">2Ô∏è‚É£ Configura la alerta</p>
                            <p class="text-text-secondary">En "Webhook URL" pega la URL de arriba</p>
                        </div>

                        <div class="bg-surface-light p-4 rounded-lg">
                            <p class="font-bold mb-2">3Ô∏è‚É£ Formato del mensaje JSON</p>
                            <pre class="bg-surface p-3 rounded mt-2 overflow-x-auto text-xs">{
  "accountId": "<span class="text-primary" id="json-account-id-placeholder">TU_ACCOUNT_ID</span>",
  "symbol": "{{ticker}}",
  "action": "{{strategy.order.action}}",
  "contracts": {{strategy.order.contracts}},
  "price": {{strategy.order.price}},
  "orderType": "market",
  "timestamp": "{{timenow}}",
  "orderId": "{{strategy.order.id}}",
  "comment": "{{strategy.order.comment}}"
}</pre>
                        </div>

                        <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg">
                            <p class="text-blue-400 font-bold mb-2">üí° Consejo Pro</p>
                            <p class="text-text-secondary text-xs">
                                Aseg√∫rate de que el servidor proxy est√© corriendo en puerto 8003 antes de operar.
                                Ejecuta: <code class="bg-surface px-2 py-1 rounded">node proxy-server.js</code>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- √öltimos Webhooks Recibidos -->
                <div class="metric-card p-6">
                    <h3 class="text-lg font-bold mb-4">üì• √öltimos Webhooks Recibidos</h3>
                    <div id="tradingview-webhook-log" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-sm text-text-secondary text-center py-8">No hay webhooks recibidos a√∫n</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA DETALLADA DE TRADOVATE -->
        <section id="platform-tradovate" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-tradovate">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #0066CC;">
                        <img src="/logos/tradovate-logo.png" alt="Tradovate Logo">
                    </div>
                    <div class="platform-detail-title">
                        <h2>Tradovate</h2>
                        <p>Importar Trades desde CSV</p>
                    </div>
                </div>

                <!-- Estado -->
                <div class="metric-card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div id="tradovate-detail-indicator" class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                            <div>
                                <div class="text-sm text-text-secondary">Estado de Configuraci√≥n</div>
                                <div id="tradovate-detail-status" class="text-lg font-semibold">No configurado</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n -->
                <div class="metric-card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-primary"></i>
                        Configuraci√≥n de Importaci√≥n
                    </h3>

                    <div class="space-y-4">
                        <!-- Cuenta Destino -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Selecciona la cuenta donde importar</label>
                            <select id="tradovate-account-select" class="w-full bg-surface border border-border rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
                                <option value="">Selecciona una cuenta...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Importar CSV -->
                <div class="metric-card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-file-csv mr-2 text-green-500"></i>
                        Importar Trades desde CSV
                    </h3>

                    <div class="space-y-4">
                        <div class="bg-surface-light p-4 rounded-lg border border-border">
                            <p class="text-sm mb-3">
                                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                Exporta tus trades desde Tradovate en formato <strong>Performance.csv</strong>
                            </p>
                            <ol class="text-sm text-text-secondary space-y-1 ml-6 list-decimal">
                                <li>En TradingView ‚Üí Panel de Tradovate ‚Üí Pesta√±a "Performance"</li>
                                <li>Click en el bot√≥n de exportar (‚ãÆ o icono descarga)</li>
                                <li>Selecciona "Performance" y descarga el CSV</li>
                                <li>Sube el archivo aqu√≠ abajo</li>
                            </ol>
                        </div>

                        <!-- File Input -->
                        <div class="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer" id="tradovate-csv-dropzone">
                            <input type="file" id="tradovate-csv-input" accept=".csv" class="hidden">
                            <i class="fas fa-cloud-upload-alt text-4xl text-text-secondary mb-3"></i>
                            <p class="text-sm font-medium mb-1">Click aqu√≠ o arrastra el archivo CSV</p>
                            <p class="text-xs text-text-secondary">Solo archivos Performance.csv de Tradovate</p>
                        </div>

                        <!-- File Info -->
                        <div id="tradovate-file-info" class="hidden bg-surface-light p-4 rounded-lg border border-green-500">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-file-csv text-green-500 text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm font-medium" id="tradovate-file-name">archivo.csv</p>
                                        <p class="text-xs text-text-secondary" id="tradovate-file-size">0 KB</p>
                                    </div>
                                </div>
                                <button id="tradovate-remove-file" class="text-red-500 hover:text-red-400">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Import Button -->
                        <button id="tradovate-import-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-file-import mr-2"></i>
                            Importar Trades
                        </button>

                        <!-- Progress -->
                        <div id="tradovate-import-progress" class="hidden">
                            <div class="flex justify-between text-sm mb-2">
                                <span>Importando...</span>
                                <span id="tradovate-progress-text">0%</span>
                            </div>
                            <div class="h-2 bg-surface rounded-full overflow-hidden">
                                <div id="tradovate-progress-bar-import" class="h-full bg-green-500 transition-all" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div id="tradovate-import-results" class="hidden bg-green-500/10 border border-green-500 rounded-lg p-4">
                            <p class="text-green-500 font-medium mb-2">
                                <i class="fas fa-check-circle mr-2"></i>
                                Importaci√≥n completada
                            </p>
                            <div class="text-sm text-text-secondary space-y-1">
                                <p><strong id="tradovate-imported-count">0</strong> trades importados correctamente</p>
                                <p>Balance actualizado: <strong id="tradovate-final-balance">$0.00</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="metric-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-book mr-2 text-blue-400"></i>
                        C√≥mo Obtener el CSV de Tradovate
                    </h3>
                    <div class="space-y-3 text-sm text-text-secondary">
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">1</span>
                            </div>
                            <p>Abre TradingView con tu cuenta de Tradovate conectada</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">2</span>
                            </div>
                            <p>En la parte inferior, abre el panel de "Tradovate"</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">3</span>
                            </div>
                            <p>Ve a la pesta√±a "Performance" (rendimiento)</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">4</span>
                            </div>
                            <p>Click en el bot√≥n de men√∫ (‚ãÆ) o icono de descarga</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">5</span>
                            </div>
                            <p>Selecciona "Exportar datos" ‚Üí "Performance" ‚Üí Descarga CSV</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold">6</span>
                            </div>
                            <p>Sube el archivo aqu√≠ y click en "Importar Trades"</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA DETALLADA DE NINJATRADER -->
        <section id="platform-ninjatrader" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-ninjatrader">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #FF6600;">
                        <img src="/logos/ninja-logo.png" alt="NinjaTrader" class="w-full h-full object-contain p-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <i class="fas fa-chart-bar text-4xl text-white" style="display:none;"></i>
                    </div>
                    <div class="platform-detail-title">
                        <h2>NinjaTrader 8</h2>
                        <p>Sincronizaci√≥n Autom√°tica de Archivos</p>
                    </div>
                </div>

                <!-- Estado -->
                <div class="metric-card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div id="ninjatrader-detail-indicator" class="w-3 h-3 rounded-full bg-yellow-500 mr-3"></div>
                            <div>
                                <div class="text-sm text-text-secondary">Estado</div>
                                <div id="ninjatrader-detail-status" class="text-lg font-semibold">No configurado</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-text-secondary">√öltima sincronizaci√≥n</div>
                            <div id="ninjatrader-last-sync-detail" class="text-sm font-medium">Nunca</div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Principal -->
                <div class="metric-card p-8 mb-6 text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-primary bg-opacity-20 mb-4">
                        <i class="fas fa-folder-open text-primary text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Sincronizaci√≥n Inteligente</h3>
                    <p class="text-text-secondary mb-6">Lee autom√°ticamente tus trades desde los archivos de NinjaTrader</p>
                    
                    <button id="ninjatrader-sync-main" class="bg-primary hover:bg-primary-dark text-white px-8 py-4 rounded-lg font-bold text-lg transition-colors inline-flex items-center gap-3">
                        <i class="fas fa-sync-alt"></i>
                        <span>Sincronizar Ahora</span>
                    </button>

                    <div id="ninja-folder-selected" class="hidden mt-6 p-4 bg-green-500 bg-opacity-10 border border-green-500 rounded-lg">
                        <div class="flex items-center justify-center gap-2 text-green-500">
                            <i class="fas fa-check-circle"></i>
                            <span class="font-semibold">Carpeta configurada</span>
                        </div>
                        <p class="text-sm text-text-secondary mt-2">Las pr√≥ximas sincronizaciones ser√°n autom√°ticas</p>
                    </div>
                </div>

                <!-- Cuentas Detectadas -->
                <div id="ninja-accounts-section" class="hidden metric-card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-users mr-2 text-accent"></i>
                        Cuentas Detectadas
                    </h3>
                    <div id="ninja-accounts-grid" class="grid grid-cols-2 gap-3">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Estad√≠sticas Recientes -->
                <div id="ninja-stats-section" class="hidden metric-card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-primary"></i>
                        √öltima Sincronizaci√≥n
                    </h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-surface-light rounded-lg">
                            <div class="text-2xl font-bold text-primary" id="ninja-stat-trades">0</div>
                            <div class="text-xs text-text-secondary mt-1">Trades</div>
                        </div>
                        <div class="text-center p-4 bg-surface-light rounded-lg">
                            <div class="text-2xl font-bold text-accent" id="ninja-stat-accounts">0</div>
                            <div class="text-xs text-text-secondary mt-1">Cuentas</div>
                        </div>
                        <div class="text-center p-4 bg-surface-light rounded-lg">
                            <div class="text-2xl font-bold text-green-500" id="ninja-stat-files">0</div>
                            <div class="text-xs text-text-secondary mt-1">Archivos</div>
                        </div>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="metric-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-book mr-2 text-blue-400"></i>
                        C√≥mo Funciona
                    </h3>
                    <div class="space-y-3 text-sm text-text-secondary">
                        <div class="bg-primary bg-opacity-10 border border-primary rounded p-4">
                            <p class="text-primary font-medium mb-2">
                                <i class="fas fa-magic mr-2"></i>
                                S√∫per Simple - Sin Instalaciones
                            </p>
                            <p>Solo selecciona la carpeta de NinjaTrader una vez y listo. No necesitas instalar nada en NinjaTrader.</p>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-surface-light rounded-lg">
                            <div class="bg-primary w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-xs font-bold">1</span>
                            </div>
                            <div>
                                <p class="font-semibold mb-1">Click en "Sincronizar Ahora"</p>
                                <p class="text-xs">Se abrir√° el explorador de archivos</p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-surface-light rounded-lg">
                            <div class="bg-primary w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-xs font-bold">2</span>
                            </div>
                            <div>
                                <p class="font-semibold mb-1">Selecciona la carpeta "execution"</p>
                                <p class="text-xs">Normalmente en: <code class="bg-background px-1 rounded">C:\Users\TuUsuario\Documents\NinjaTrader 8\db\execution</code></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-surface-light rounded-lg">
                            <div class="bg-primary w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-xs font-bold">3</span>
                            </div>
                            <div>
                                <p class="font-semibold mb-1">¬°Listo! Tus trades se importan autom√°ticamente</p>
                                <p class="text-xs">Detecta todas tus cuentas (Sim, Live, etc.) autom√°ticamente</p>
                            </div>
                        </div>

                        <div class="bg-green-500 bg-opacity-10 border border-green-500 rounded p-4 mt-4">
                            <p class="text-green-500 font-medium mb-2">
                                <i class="fas fa-check-circle mr-2"></i>
                                Multi-Cuenta Autom√°tico
                            </p>
                            <p>Si tienes varias cuentas (Sim101, Live, Rithmic), todas se detectan y separan autom√°ticamente. No necesitas configurar nada.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA DETALLADA DE BINGX -->
        <section id="platform-bingx" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-bingx">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #006FFF;">
                        <img src="/logos/bingx-logo.png" alt="BingX Logo">
                    </div>
                    <div class="platform-detail-title">
                        <h2>BingX Exchange</h2>
                        <p>Configuraci√≥n y Sincronizaci√≥n</p>
                    </div>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="bingx-connection-status" class="status-card status-card-warning mb-6">
                    <i class="fas fa-exclamation-triangle status-card-icon"></i>
                    <div>
                        <p class="font-semibold text-lg mb-1">No conectado</p>
                        <p class="text-sm opacity-90">Configure sus claves API para comenzar la sincronizaci√≥n autom√°tica.</p>
                    </div>
                </div>

                <!-- Tabs de Navegaci√≥n -->
                <div class="platform-tabs">
                    <button class="platform-tab active" data-tab="api">
                        <i class="fas fa-key mr-2"></i>Conexi√≥n API
                    </button>
                    <button class="platform-tab" data-tab="csv">
                        <i class="fas fa-file-csv mr-2"></i>Importar CSV
                    </button>
                    <button class="platform-tab" data-tab="info">
                        <i class="fas fa-info-circle mr-2"></i>Informaci√≥n
                    </button>
                </div>

                <!-- Tab: Conexi√≥n API -->
                <div class="platform-tab-content active" id="bingx-tab-api">
                    <div class="metric-card mb-6">
                        <h3 class="text-xl font-semibold mb-6">Configuraci√≥n de API</h3>

                        <div class="space-y-5">
                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-key mr-2 text-primary"></i>Clave API
                                </label>
                                <input type="password" id="bingx-api-key-detail" class="w-full" placeholder="Introduce tu clave API de BingX">
                                <p class="text-xs text-text-secondary mt-2">La clave API se almacena localmente y de forma segura</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-lock mr-2 text-primary"></i>Secret API
                                </label>
                                <input type="password" id="bingx-secret-key-detail" class="w-full" placeholder="Introduce tu secret de BingX">
                                <p class="text-xs text-text-secondary mt-2">El secret se encripta antes de almacenarse</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-wallet mr-2 text-primary"></i>Cuenta a sincronizar
                                </label>
                                <select id="bingx-account-detail" class="w-full">
                                    <option value="">Seleccionar cuenta...</option>
                                </select>
                                <p class="text-xs text-text-secondary mt-2">Selecciona la cuenta donde se guardar√°n las operaciones sincronizadas</p>
                            </div>
                        </div>

                        <div class="status-card status-card-warning mt-6">
                            <i class="fas fa-info-circle status-card-icon"></i>
                            <div class="text-sm">
                                <p class="font-semibold mb-1">¬øError de signature?</p>
                                <p>Las credenciales pueden ser incorrectas. Ve a <strong>BingX ‚Üí Account ‚Üí API Management</strong> y crea nuevas credenciales con permisos de <strong>Read + Trade</strong>.</p>
                            </div>
                        </div>

                        <!-- Bot√≥n principal de guardar configuraci√≥n -->
                        <button id="save-bingx-credentials" class="primary w-full mt-6">
                            <i class="fas fa-save mr-2"></i>üíæ Guardar Configuraci√≥n
                        </button>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="test-bingx-connection-detail" class="secondary">
                                <i class="fas fa-plug mr-2"></i>Probar Conexi√≥n
                            </button>
                            <button id="sync-bingx-trades-detail" class="success">
                                <i class="fas fa-sync-alt mr-2"></i>Sincronizar Trades
                            </button>
                            <button id="disconnect-bingx-detail" class="danger">
                                <i class="fas fa-unlink mr-2"></i>Desconectar y Borrar Credenciales
                            </button>
                        </div>
                    </div>

                    <!-- Historial de Sincronizaci√≥n -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">Historial de Sincronizaci√≥n</h3>
                        <div id="bingx-sync-history" class="space-y-2">
                            <p class="text-text-secondary text-center py-8 text-sm">No hay sincronizaciones realizadas</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Importar CSV -->
                <div class="platform-tab-content" id="bingx-tab-csv">
                    <div class="metric-card">
                        <h3 class="text-xl font-semibold mb-6">Importar desde CSV</h3>
                        
                        <div class="space-y-5">
                            <div>
                                <label for="bingx-csv-file-input" class="block mb-3 font-semibold text-sm">
                                    <i class="fas fa-file-csv mr-2 text-primary"></i>Seleccionar archivo CSV
                                </label>
                                <input type="file" id="bingx-csv-file-input" accept=".csv" class="w-full">
                                <p class="text-xs text-text-secondary mt-3 leading-relaxed">
                                    <strong>Formato:</strong> Nombre Cuenta, <strong>ID (Agrupa parciales con el mismo ID)</strong>, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM), Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L (opc), Divisa, Tarifa/Comisi√≥n (opc), Notas (opc)
                                </p>
                            </div>

                            <button id="bingx-import-csv-btn" class="primary w-full">
                                <i class="fas fa-upload mr-2"></i>Importar CSV
                            </button>

                            <div id="bingx-csv-import-status" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Informaci√≥n -->
                <div class="platform-tab-content" id="bingx-tab-info">
                    <div class="space-y-6">
                        <!-- Proxy Server Info -->


                        <!-- Important Notice -->
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-4">Importante</h3>
                            <div class="status-card status-card-info">
                                <i class="fas fa-info-circle status-card-icon"></i>
                                <div class="text-sm">
                                    <p class="font-semibold mb-2">Solo Cuenta Real</p>
                                    <p class="mb-2">BingX no permite APIs en modo demo/testnet. Solo funciona con cuentas reales.</p>
                                    <p class="mb-2"><strong>Para pruebas seguras:</strong> Puedes crear operaciones con vol√∫menes muy peque√±os (0.01 lotes).</p>
                                    <p>La sincronizaci√≥n importar√° todas las operaciones reales de BingX.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Info -->
                        <div class="metric-card">
                            <h3 class="text-lg font-semibold mb-4">Acerca de BingX</h3>
                            <div class="space-y-3 text-sm text-text-secondary leading-relaxed">
                                <p>BingX es un exchange de criptomonedas global que ofrece trading de futuros perpetuos, spot y copy trading.</p>
                                <p><strong>M√©todos de Importaci√≥n:</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>API: Sincronizaci√≥n autom√°tica mediante claves API</li>
                                    <li>CSV: Importaci√≥n manual de archivos CSV</li>
                                </ul>
                                <p><strong>Configuraci√≥n de API:</strong> Ve a BingX ‚Üí Account ‚Üí API Management y crea credenciales con permisos de Read + Trade.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================
             PANEL DE BITGET
             ============================================ -->
        <section id="platform-bitget" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-bitget">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #54FDD5;">
                        <img src="/logos/bitget-logo.png" alt="Bitget Logo">
                    </div>
                    <div class="platform-detail-title">
                        <h2>Bitget Exchange</h2>
                        <p>Configuraci√≥n y Sincronizaci√≥n</p>
                    </div>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="bitget-connection-status" class="status-card status-card-warning mb-6">
                    <i class="fas fa-exclamation-triangle status-card-icon"></i>
                    <div>
                        <p class="font-semibold text-lg mb-1">No conectado</p>
                        <p class="text-sm opacity-90">Configure sus claves API para comenzar la sincronizaci√≥n autom√°tica.</p>
                    </div>
                </div>

                <!-- Tabs de Navegaci√≥n -->
                <div class="platform-tabs">
                    <button class="platform-tab active" data-tab="api">
                        <i class="fas fa-key mr-2"></i>Conexi√≥n API
                    </button>
                    <button class="platform-tab" data-tab="csv">
                        <i class="fas fa-file-csv mr-2"></i>Importar CSV
                    </button>
                    <button class="platform-tab" data-tab="info">
                        <i class="fas fa-info-circle mr-2"></i>Informaci√≥n
                    </button>
                </div>

                <!-- Tab: Conexi√≥n API -->
                <div class="platform-tab-content active" id="bitget-tab-api">
                    <div class="metric-card mb-6">
                        <h3 class="text-xl font-semibold mb-6">Configuraci√≥n de API</h3>

                        <div class="space-y-5">
                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-key mr-2 text-primary"></i>Clave API
                                </label>
                                <input type="password" id="bitget-api-key-detail" class="w-full" placeholder="Introduce tu clave API de Bitget">
                                <p class="text-xs text-text-secondary mt-2">La clave API se almacena localmente y de forma segura</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-lock mr-2 text-primary"></i>Secret API
                                </label>
                                <input type="password" id="bitget-secret-key-detail" class="w-full" placeholder="Introduce tu secret de Bitget">
                                <p class="text-xs text-text-secondary mt-2">El secret se encripta antes de almacenarse</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-key mr-2 text-primary"></i>Passphrase
                                </label>
                                <input type="password" id="bitget-passphrase-detail" class="w-full" placeholder="Introduce tu passphrase de Bitget">
                                <p class="text-xs text-text-secondary mt-2">El passphrase es requerido para autenticaci√≥n en Bitget</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-wallet mr-2 text-primary"></i>Cuenta a sincronizar
                                </label>
                                <select id="bitget-account-detail" class="w-full">
                                    <option value="">Seleccionar cuenta...</option>
                                </select>
                                <p class="text-xs text-text-secondary mt-2">Selecciona la cuenta donde se guardar√°n las operaciones sincronizadas</p>
                            </div>
                        </div>

                        <div class="status-card status-card-info mt-6">
                            <i class="fas fa-info-circle status-card-icon"></i>
                            <div class="text-sm">
                                <p class="font-semibold mb-1">Configurar API en Bitget</p>
                                <p>Ve a <strong>Perfil ‚Üí API Management</strong> y crea nuevas credenciales con permisos de <strong>Read</strong>. Bitget requiere API Key, Secret y Passphrase para la autenticaci√≥n.</p>
                            </div>
                        </div>

                        <!-- Bot√≥n principal de guardar configuraci√≥n -->
                        <button id="save-bitget-credentials" class="primary w-full mt-6">
                            <i class="fas fa-save mr-2"></i>üíæ Guardar Configuraci√≥n
                        </button>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="test-bitget-connection-detail" class="secondary">
                                <i class="fas fa-plug mr-2"></i>Probar Conexi√≥n
                            </button>
                            <button id="sync-bitget-trades-detail" class="success">
                                <i class="fas fa-sync-alt mr-2"></i>Sincronizar Trades
                            </button>
                        </div>

                        <button id="disconnect-bitget-detail" class="secondary w-full mt-3 opacity-70 hover:opacity-100">
                            <i class="fas fa-unlink mr-2"></i>Desconectar y Borrar Credenciales
                        </button>
                    </div>

                    <!-- Historial de Sincronizaci√≥n -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">Historial de Sincronizaci√≥n</h3>
                        <div id="bitget-sync-history" class="space-y-2">
                            <p class="text-text-secondary text-center py-8 text-sm">No hay sincronizaciones realizadas</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Importar CSV -->
                <div class="platform-tab-content" id="bitget-tab-csv">
                    <div class="metric-card">
                        <h3 class="text-xl font-semibold mb-6">Importar desde CSV</h3>
                        
                        <div class="space-y-5">
                            <div>
                                <label for="bitget-csv-file-input" class="block mb-3 font-semibold text-sm">
                                    <i class="fas fa-file-csv mr-2 text-primary"></i>Seleccionar archivo CSV
                                </label>
                                <input type="file" id="bitget-csv-file-input" accept=".csv" class="w-full">
                                <p class="text-xs text-text-secondary mt-3 leading-relaxed">
                                    <strong>Formato:</strong> Nombre Cuenta, <strong>ID (Agrupa parciales con el mismo ID)</strong>, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM), Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L (opc), Divisa, Tarifa/Comisi√≥n (opc), Notas (opc)
                                </p>
                            </div>

                            <button id="bitget-import-csv-btn" class="primary w-full">
                                <i class="fas fa-upload mr-2"></i>Importar CSV
                            </button>

                            <div id="bitget-csv-import-status" class="text-sm"></div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-border">
                            <h4 class="text-lg font-semibold mb-4">
                                <i class="fas fa-copy mr-2 text-primary"></i>Importar desde Interfaz Web
                            </h4>
                            <p class="text-sm text-text-secondary mb-4 leading-relaxed">
                                Copia los datos directamente desde el <strong>Historial de Posici√≥n</strong> de Bitget y p√©galos aqu√≠ para una importaci√≥n r√°pida.
                            </p>
                            <button id="bitget-interface-import-btn" class="bg-green-600 hover:bg-green-700 text-white w-full py-2.5 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-paste mr-2"></i>Abrir Importador de Interfaz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Informaci√≥n -->
                <div class="platform-tab-content" id="bitget-tab-info">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">Acerca de Bitget</h3>
                        <div class="space-y-3 text-sm text-text-secondary leading-relaxed">
                            <p>Bitget es un exchange de criptomonedas global que ofrece trading spot, futuros y copy trading.</p>
                            <p><strong>M√©todos de Importaci√≥n:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>API: Sincronizaci√≥n autom√°tica mediante claves API (requiere API Key, Secret y Passphrase)</li>
                                <li>CSV: Importaci√≥n manual de archivos CSV</li>
                            </ul>
                            <p><strong>API Endpoints:</strong> La integraci√≥n utiliza la API oficial de Bitget para sincronizar trades autom√°ticamente.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MEXC Platform Panel -->
        <section id="platform-mexc" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-mexc">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #00C087;">
                        <img src="/logos/mexc-logo.png" alt="MEXC Logo">
                    </div>
                    <div class="platform-detail-title">
                        <h2>MEXC Exchange</h2>
                        <p>Configuraci√≥n y Sincronizaci√≥n</p>
                    </div>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="mexc-connection-status" class="status-card status-card-warning mb-6">
                    <i class="fas fa-exclamation-triangle status-card-icon"></i>
                    <div>
                        <p class="font-semibold text-lg mb-1">No conectado</p>
                        <p class="text-sm opacity-90">Importa operaciones mediante archivo CSV o API.</p>
                    </div>
                </div>

                <!-- Tabs de Navegaci√≥n -->
                <div class="platform-tabs">
                    <button class="platform-tab active" data-tab="api">
                        <i class="fas fa-key mr-2"></i>Conexi√≥n API
                    </button>
                    <button class="platform-tab" data-tab="csv">
                        <i class="fas fa-file-csv mr-2"></i>Importar CSV
                    </button>
                    <button class="platform-tab" data-tab="info">
                        <i class="fas fa-info-circle mr-2"></i>Informaci√≥n
                    </button>
                </div>

                <!-- Tab: Conexi√≥n API -->
                <div class="platform-tab-content active" id="mexc-tab-api">
                    <div class="metric-card mb-6">
                        <h3 class="text-xl font-semibold mb-6">Configuraci√≥n de API</h3>

                        <div class="space-y-5">
                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-key mr-2 text-primary"></i>Clave API
                                </label>
                                <input type="password" id="mexc-api-key-detail" class="w-full" placeholder="Introduce tu clave API de MEXC">
                                <p class="text-xs text-text-secondary mt-2">La clave API se almacena localmente y de forma segura</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-lock mr-2 text-primary"></i>Secret API
                                </label>
                                <input type="password" id="mexc-secret-key-detail" class="w-full" placeholder="Introduce tu secret de MEXC">
                                <p class="text-xs text-text-secondary mt-2">El secret se encripta antes de almacenarse</p>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-wallet mr-2 text-primary"></i>Cuenta a sincronizar
                                </label>
                                <select id="mexc-account-detail" class="w-full">
                                    <option value="">Seleccionar cuenta...</option>
                                </select>
                                <p class="text-xs text-text-secondary mt-2">Selecciona la cuenta donde se guardar√°n las operaciones sincronizadas</p>
                            </div>
                        </div>

                        <div class="status-card status-card-info mt-6">
                            <i class="fas fa-info-circle status-card-icon"></i>
                            <div class="text-sm">
                                <p class="font-semibold mb-1">Configurar API en MEXC Futures</p>
                                <p>Ve a <strong>Account ‚Üí API Management ‚Üí Futures</strong> y crea nuevas credenciales con permisos de <strong>View Account Details</strong> y <strong>View Order Details</strong>. MEXC Futures requiere API Key y Secret para la autenticaci√≥n.</p>
                            </div>
                        </div>

                        <!-- Bot√≥n principal de guardar configuraci√≥n -->
                        <button id="save-mexc-credentials" class="primary w-full mt-6">
                            <i class="fas fa-save mr-2"></i>üíæ Guardar Configuraci√≥n
                        </button>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="test-mexc-connection-detail" class="secondary">
                                <i class="fas fa-plug mr-2"></i>Probar Conexi√≥n
                            </button>
                            <button id="sync-mexc-trades-detail" class="success">
                                <i class="fas fa-sync-alt mr-2"></i>Sincronizar Trades
                            </button>
                        </div>

                        <div class="mt-4">
                            <button id="disconnect-mexc-detail" class="w-full danger">
                                <i class="fas fa-unlink mr-2"></i>Desconectar y Borrar Credenciales
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Importar CSV -->
                <div class="platform-tab-content" id="mexc-tab-csv">
                    <div class="metric-card">
                        <h3 class="text-xl font-semibold mb-6">Importar desde CSV</h3>
                        
                        <div class="space-y-5">
                            <div>
                                <label for="mexc-csv-file-input" class="block mb-3 font-semibold text-sm">
                                    <i class="fas fa-file-csv mr-2 text-primary"></i>Seleccionar archivo CSV
                                </label>
                                <input type="file" id="mexc-csv-file-input" accept=".csv" class="w-full">
                                <p class="text-xs text-text-secondary mt-3 leading-relaxed">
                                    <strong>Formato:</strong> Nombre Cuenta, <strong>ID (Agrupa parciales con el mismo ID)</strong>, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM), Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L (opc), Divisa, Tarifa/Comisi√≥n (opc), Notas (opc)
                                </p>
                            </div>

                            <div class="status-card status-card-info">
                                <i class="fas fa-lightbulb status-card-icon"></i>
                                <div class="text-sm">
                                    <p class="font-semibold mb-2">Ejemplo de CSV v√°lido:</p>
                                    <pre class="text-xs mt-2 overflow-x-auto bg-black bg-opacity-30 p-2 rounded">Nombre Cuenta,Fecha,Hora Entrada,Hora Salida,Instrumento,Tipo,Entrada,Salida,Volumen,P&L,Divisa,Tarifa/Comision,Notas
Mi Cuenta MEXC,2024-10-15,09:30,10:45,BTCUSDT,buy,42500.00,43200.00,0.1,70.00,USDT,2.50,Trade exitoso</pre>
                                </div>
                            </div>

                            <button id="mexc-import-csv-btn" class="primary w-full">
                                <i class="fas fa-upload mr-2"></i>Importar CSV de MEXC
                            </button>

                            <div id="mexc-csv-import-status" class="text-sm"></div>
                        </div>
                    </div>

                    <!-- Historial de Importaciones -->
                    <div class="metric-card mt-6">
                        <h3 class="text-lg font-semibold mb-4">Historial de Importaciones</h3>
                        <div id="mexc-import-history" class="space-y-2">
                            <p class="text-text-secondary text-center py-8 text-sm">No hay importaciones realizadas</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Informaci√≥n -->
                <div class="platform-tab-content" id="mexc-tab-info">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">Acerca de MEXC Futures</h3>
                        <div class="space-y-3 text-sm text-text-secondary leading-relaxed">
                            <p>MEXC es un exchange de criptomonedas que ofrece trading de futuros perpetuos y contratos con apalancamiento.</p>
                            <p><strong>M√©todos de Importaci√≥n:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>API: Integraci√≥n completa con MEXC Futures API para sincronizaci√≥n autom√°tica de trades</li>
                                <li>CSV: Importaci√≥n manual mediante archivos CSV</li>
                            </ul>
                            <p><strong>Plataforma:</strong> MEXC Futures (Perpetual Contracts)</p>
                            <p><strong>Proxy:</strong> Requiere servidor proxy local en puerto 8003 para evitar CORS.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA DETALLADA DE cTrader -->
        <section id="platform-ctrader" class="section-container" style="display: none;">
            <div class="platform-detail-container">
                <!-- Header -->
                <div class="platform-detail-header">
                    <div class="platform-detail-back" id="back-to-platforms-ctrader">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="platform-logo" style="background: #00A8E1;">
                        <img src="/logos/ctrader-logo.png" alt="cTrader Logo">
                    </div>
                    <div class="platform-detail-title">
                        <h2>cTrader Platform</h2>
                        <p>Configuraci√≥n y Sincronizaci√≥n</p>
                    </div>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="ctrader-connection-status" class="status-card status-card-warning mb-6">
                    <i class="fas fa-exclamation-triangle status-card-icon"></i>
                    <div>
                        <p class="font-semibold text-lg mb-1">No conectado</p>
                        <p class="text-sm opacity-90">Importa operaciones mediante archivo HTML Statement.</p>
                    </div>
                </div>

                <!-- Tabs de Navegaci√≥n -->
                <div class="platform-tabs">
                    <button class="platform-tab active" data-tab="html">
                        <i class="fas fa-file-code mr-2"></i>Importar HTML
                    </button>
                    <button class="platform-tab" data-tab="api">
                        <i class="fas fa-key mr-2"></i>Conexi√≥n API
                    </button>
                    <button class="platform-tab" data-tab="info">
                        <i class="fas fa-info-circle mr-2"></i>Informaci√≥n
                    </button>
                </div>

                <!-- Tab: Importar HTML -->
                <div class="platform-tab-content active" id="ctrader-tab-html">
                    <div class="metric-card">
                        <h3 class="text-xl font-semibold mb-6">
                            <i class="fas fa-file-code mr-2 text-primary"></i>Importar desde HTML Statement
                        </h3>
                        
                        <div class="space-y-5">
                            <div class="status-card status-card-info">
                                <i class="fas fa-lightbulb status-card-icon"></i>
                                <div class="text-sm">
                                    <p class="font-semibold mb-2">üìã ¬øC√≥mo obtener el HTML Statement?</p>
                                    <ol class="list-decimal list-inside space-y-1 ml-2 mt-2">
                                        <li>Abre <strong>cTrader</strong> y ve a la pesta√±a <strong>History</strong></li>
                                        <li>Selecciona el rango de fechas que deseas importar</li>
                                        <li>Haz click derecho sobre la tabla ‚Üí <strong>Export ‚Üí HTML Statement</strong></li>
                                        <li>Guarda el archivo .html en tu computadora</li>
                                        <li>S√∫belo aqu√≠ abajo üëá</li>
                                    </ol>
                                    <p class="mt-3 text-xs opacity-75">
                                        <strong>Ejemplo de nombre:</strong> cT_17015573_2025-11-12_15-03.htm
                                    </p>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-2 font-semibold text-sm">
                                    <i class="fas fa-wallet mr-2 text-primary"></i>1. Selecciona la cuenta destino
                                </label>
                                <select id="ctrader-account-select" class="w-full">
                                    <option value="">Seleccionar cuenta...</option>
                                </select>
                                <p class="text-xs text-text-secondary mt-2">Las operaciones se importar√°n a esta cuenta</p>
                            </div>

                            <div>
                                <label for="ctrader-csv-file-input" class="block mb-3 font-semibold text-sm">
                                    <i class="fas fa-file-upload mr-2 text-primary"></i>2. Selecciona el archivo HTML Statement
                                </label>
                                <input type="file" id="ctrader-csv-file-input" accept=".html,.htm" class="w-full">
                                <p class="text-xs text-text-secondary mt-3 leading-relaxed">
                                    <strong>Solo archivos HTML</strong> (.html o .htm) exportados desde cTrader
                                </p>
                            </div>

                            <button id="ctrader-import-csv-btn" class="primary w-full" style="padding: 1rem; font-size: 1.1rem;">
                                <i class="fas fa-upload mr-2"></i>3. Importar Operaciones de cTrader
                            </button>

                            <div id="ctrader-csv-import-status" class="text-sm"></div>
                        </div>
                    </div>

                    <!-- Vista previa de operaciones -->
                    <div class="metric-card mt-6" id="ctrader-preview-container" style="display: none;">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-eye mr-2 text-primary"></i>Vista previa de operaciones
                        </h3>
                        <p class="text-sm text-text-secondary mb-4">
                            Revisa las operaciones detectadas antes de importarlas
                        </p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-surface-light">
                                    <tr>
                                        <th class="px-3 py-2 text-left">S√≠mbolo</th>
                                        <th class="px-3 py-2 text-left">Tipo</th>
                                        <th class="px-3 py-2 text-left">Fecha</th>
                                        <th class="px-3 py-2 text-right">Entrada</th>
                                        <th class="px-3 py-2 text-right">Salida</th>
                                        <th class="px-3 py-2 text-right">Volumen</th>
                                        <th class="px-3 py-2 text-right">P&L</th>
                                    </tr>
                                </thead>
                                <tbody id="ctrader-preview-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <p class="text-sm text-text-secondary">
                                <span id="ctrader-preview-count">0</span> operaciones detectadas
                            </p>
                            <button id="ctrader-confirm-import-btn" class="success" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                <i class="fas fa-check mr-2"></i>Confirmar Importaci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Historial de Importaciones -->
                    <div class="metric-card mt-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-history mr-2 text-primary"></i>Historial de Importaciones
                        </h3>
                        <div id="ctrader-import-history" class="space-y-2">
                            <p class="text-text-secondary text-center py-8 text-sm">No hay importaciones realizadas</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Conexi√≥n API -->
                <div class="platform-tab-content" id="ctrader-tab-api">
                    <div class="metric-card mb-6">
                        <h3 class="text-xl font-semibold mb-6">Configuraci√≥n de API</h3>

                        <div class="status-card status-card-info">
                            <i class="fas fa-info-circle status-card-icon"></i>
                            <div class="text-sm">
                                <p class="font-semibold mb-1">API en desarrollo</p>
                                <p>La integraci√≥n autom√°tica con cTrader Open API est√° en desarrollo. Por ahora, puedes importar tus operaciones mediante archivo HTML Statement.</p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <p class="text-sm text-text-secondary">
                                <strong>Pr√≥ximamente:</strong> Conexi√≥n directa con cTrader Open API para sincronizaci√≥n autom√°tica de operaciones, balances y posiciones en tiempo real.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Informaci√≥n -->
                <div class="platform-tab-content" id="ctrader-tab-info">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">Acerca de cTrader</h3>
                        <div class="space-y-3 text-sm text-text-secondary leading-relaxed">
                            <p>cTrader es una plataforma avanzada de trading multi-activos que ofrece herramientas profesionales para forex, metales, √≠ndices y criptomonedas.</p>
                            
                            <p><strong>Caracter√≠sticas principales:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>Interfaz intuitiva y personalizable</li>
                                <li>Ejecuci√≥n de √≥rdenes r√°pida y transparente</li>
                                <li>Profundidad de mercado (DOM) en tiempo real</li>
                                <li>Algoritmos de trading automatizados (cBots)</li>
                                <li>Backtesting y optimizaci√≥n de estrategias</li>
                            </ul>

                            <p><strong>M√©todos de Importaci√≥n:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li><strong>HTML Statement:</strong> Exporta tu historial desde cTrader en formato HTML</li>
                                <li><strong>CSV Manual:</strong> Crea un archivo CSV con tus operaciones</li>
                                <li><strong>API (Pr√≥ximamente):</strong> Sincronizaci√≥n autom√°tica con cTrader Open API</li>
                            </ul>

                            <p><strong>Formato HTML Statement:</strong> El archivo HTML contiene tablas con Historial, Posiciones, √ìrdenes y Transacciones. Trader Survivor procesa autom√°ticamente la tabla de Historial para extraer tus operaciones cerradas.</p>

                            <p><strong>Brokers compatibles:</strong> cTrader funciona con m√∫ltiples brokers como IC Markets, Pepperstone, FxPro, Spotware (FTMO), entre otros.</p>
                        </div>
                    </div>

                    <div class="metric-card mt-6">
                        <h3 class="text-lg font-semibold mb-4">Enlaces √∫tiles</h3>
                        <div class="space-y-2">
                            <a href="https://ctrader.com" target="_blank" class="block p-3 bg-surface-light rounded hover:bg-surface transition-colors">
                                <i class="fas fa-external-link-alt mr-2 text-primary"></i>
                                <span class="font-semibold">Sitio oficial de cTrader</span>
                            </a>
                            <a href="https://help.ctrader.com" target="_blank" class="block p-3 bg-surface-light rounded hover:bg-surface transition-colors">
                                <i class="fas fa-book mr-2 text-primary"></i>
                                <span class="font-semibold">Centro de ayuda</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div id="loading" class="loading" style="display: none;"><div class="spinner"></div></div>

        <div id="image-modal" class="image-modal">
            <span class="image-modal-fullscreen-btn" id="image-modal-fullscreen-btn" title="Pantalla completa">
                <i class="fas fa-expand"></i>
            </span>
            <span class="image-modal-close" id="image-modal-close-btn">&times;</span>
            <span class="image-modal-nav" id="image-modal-prev">&#10094;</span>
            <img class="image-modal-content" id="modal-image-content">
            <span class="image-modal-nav" id="image-modal-next">&#10095;</span>
            <div class="image-modal-counter" id="image-modal-counter">1 / 1</div>
        </div>

        <!-- Date Range Selector Modal -->
        <div id="date-range-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" style="background-color: rgba(0,0,0,0.95);">
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Seleccionar Rango de Fechas</h3>
                    <button id="date-range-close-btn" class="p-2 -mr-2 rounded-full hover:bg-surface-light"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Predefined Ranges -->
                    <div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-border pb-4 md:pb-0 md:pr-6">
                        <h4 class="text-sm font-semibold mb-3">Rangos R√°pidos</h4>
                        <div class="space-y-2">
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="today">Hoy</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="this_week">Esta Semana</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="this_month">Este Mes</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="last_7_days">√öltimos 7 d√≠as</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="last_30_days">√öltimos 30 d√≠as</button>
                            <button class="w-full text-left p-2 rounded hover:bg-surface-light date-range-preset" data-range="this_year">Este A√±o</button>
                        </div>
                    </div>
                    <!-- Calendar -->
                    <div class="w-full md:w-2/3">
                        <div class="flex justify-between items-center mb-3">
                            <button id="calendar-prev-month" class="p-2 rounded-full hover:bg-surface-light"><i class="fas fa-chevron-left"></i></button>
                            <h4 id="calendar-month-year" class="font-semibold text-lg"></h4>
                            <button id="calendar-next-month" class="p-2 rounded-full hover:bg-surface-light"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-sm mb-2 text-text-secondary">
                            <div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-1">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>
                </div>
                <div class="mt-6 border-t border-border pt-4 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-sm">
                        <input type="text" id="date-range-start-input" class="bg-surface-light p-2 rounded w-32 text-center" placeholder="Inicio">
                        <span>-</span>
                        <input type="text" id="date-range-end-input" class="bg-surface-light p-2 rounded w-32 text-center" placeholder="Fin">
                    </div>
                    <div class="space-x-2">
                        <button id="date-range-clear-btn" class="secondary">Limpiar</button>
                        <button id="date-range-apply-btn" class="primary">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="day-detail-modal" class="fixed inset-0 hidden items-center justify-center z-[1002] px-4 py-6"><div class="p-5 rounded-lg shadow-xl w-full max-w-3xl text-text relative flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 pb-3 border-b border-surface-light"><h3 id="day-modal-title" class="text-xl font-semibold">Trades del DD/MM/YYYY</h3><button id="close-day-modal-icon" class="text-2xl text-text-secondary hover:text-text leading-none -mt-1">&times;</button></div><div class="mb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-3 text-sm"><div>P&L Total: <span id="day-total-pl-header" class="font-semibold"></span></div><div>Trades Totales: <span id="day-total-trades-header" class="font-semibold"></span></div><div>Win Rate: <span id="day-win-rate-header" class="font-semibold"></span></div><div>Ganadores: <span id="day-winners-header" class="font-semibold"></span></div><div>Perdedores: <span id="day-losers-header" class="font-semibold"></span></div><div>Comisiones: <span id="day-fees-header" class="font-semibold text-red"></span></div><div>Volumen: <span id="day-volume-header" class="font-semibold"></span></div><div class="md:col-span-1">Profit Factor: <span id="day-profit-factor-header" class="font-semibold"></span></div><div class="md:col-span-2 border-t border-surface-light pt-2">P&L Neto (despu√©s fees): <span id="day-net-pl-header" class="font-bold"></span></div></div><div class="overflow-y-auto flex-grow mb-4 border border-surface-light rounded-md"><table class="w-full text-left text-sm"><thead class="sticky top-0 bg-surface z-10"><tr><th class="py-2 px-3">ID</th><th class="py-2 px-3"></th>Hora Entrada</th><th class="py-2 px-3">S√≠mbolo</th><th class="py-2 px-3">Tipo</th><th class="py-2 px-3">P&L Neto</th><th class="py-2 px-3">Hora Salida</th></tr></thead><tbody id="day-modal-table-body" class="divide-y divide-surface"></tbody></table></div><div class="text-right pt-4 border-t border-surface-light"><button id="close-day-modal-btn" class="primary px-4 py-2">Cerrar</button></div></div></div>

        <!-- Modal de Importaci√≥n desde Interfaz de Bitget -->
        <div id="bitget-interface-import-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background-color: rgba(0,0,0,0.95);">
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-semibold">Importar desde Interfaz de Bitget</h3>
                        <p class="text-sm text-text-secondary mt-1">Copia y pega las operaciones desde el Historial de Posici√≥n</p>
                    </div>
                    <button id="bitget-interface-close-btn" class="p-2 -mr-2 rounded-full hover:bg-surface-light"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                    <!-- Instrucciones -->
                    <div class="bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-4">
                        <h4 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>
                            Instrucciones
                        </h4>
                        <ol class="text-sm text-text-secondary space-y-1 ml-4 list-decimal">
                            <li>Ve a Bitget ‚Üí <strong>Trading de Futuros</strong> ‚Üí <strong>Historial de Posici√≥n</strong></li>
                            <li>Selecciona las operaciones que deseas importar</li>
                            <li>Copia toda la informaci√≥n (Ctrl+C o Cmd+C)</li>
                            <li>Pega los datos en el √°rea de texto a continuaci√≥n</li>
                            <li>Selecciona la cuenta donde deseas importar las operaciones</li>
                            <li>Haz clic en "Importar Operaciones"</li>
                        </ol>
                    </div>

                    <!-- Selector de cuenta -->
                    <div class="flex items-center gap-4">
                        <label for="bitget-interface-account" class="text-sm font-semibold whitespace-nowrap">
                            <i class="fas fa-wallet mr-2"></i>Cuenta destino:
                        </label>
                        <select id="bitget-interface-account" class="flex-1 bg-background border border-border rounded px-3 py-2 text-sm">
                            <option value="">Selecciona una cuenta...</option>
                        </select>
                    </div>

                    <!-- √Årea de texto para pegar datos -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <label for="bitget-interface-data" class="text-sm font-semibold mb-2">
                            <i class="fas fa-paste mr-2"></i>Datos del Historial de Posici√≥n:
                        </label>
                        <textarea 
                            id="bitget-interface-data" 
                            class="flex-1 bg-background border border-border rounded p-3 text-sm font-mono resize-none"
                            placeholder="Pega aqu√≠ los datos copiados desde Bitget...&#10;&#10;Ejemplo:&#10;BTCUSDT&#10;Short ¬∑ Aislado&#10;2025-08-23&#10;17:37:37&#10;114,818.1&#10;114,794.1&#10;0.5565 BTC&#10;0.5565 BTC&#10;-37.7531 USDT&#10;--&#10;2025-08-23&#10;17:58:12&#10;--"
                        ></textarea>
                    </div>

                    <!-- Mensaje de estado -->
                    <div id="bitget-interface-status" class="text-sm text-center"></div>
                </div>

                <div class="mt-4 pt-4 border-t border-border flex justify-end gap-3">
                    <button id="bitget-interface-cancel-btn" class="px-4 py-2 bg-surface-light border border-border rounded hover:bg-surface transition-colors">
                        Cancelar
                    </button>
                    <button id="bitget-interface-import-btn-modal" class="px-4 py-2 bg-primary text-background rounded hover:bg-secondary transition-colors font-semibold">
                        <i class="fas fa-upload mr-2"></i>Importar Operaciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Importaci√≥n desde Interfaz de Bitget -->
        <div id="bitget-interface-import-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background-color: rgba(0,0,0,0.95);">
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-semibold">Importar desde Interfaz de Bitget</h3>
                        <p class="text-sm text-text-secondary mt-1">Copia y pega las operaciones desde el Historial de Posici√≥n</p>
                    </div>
                    <button id="bitget-interface-close-btn" class="p-2 -mr-2 rounded-full hover:bg-surface-light"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                    <!-- Instrucciones -->
                    <div class="bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-4">
                        <h4 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>
                            Instrucciones
                        </h4>
                        <ol class="text-sm text-text-secondary space-y-1 ml-4 list-decimal">
                            <li>Ve a Bitget ‚Üí <strong>Trading de Futuros</strong> ‚Üí <strong>Historial de Posici√≥n</strong></li>
                            <li>Selecciona las operaciones que deseas importar</li>
                            <li>Copia toda la informaci√≥n (Ctrl+C o Cmd+C)</li>
                            <li>Pega los datos en el √°rea de texto a continuaci√≥n</li>
                            <li>Selecciona la cuenta donde deseas importar las operaciones</li>
                            <li>Haz clic en "Importar Operaciones"</li>
                        </ol>
                    </div>

                    <!-- Selector de cuenta -->
                    <div class="flex items-center gap-4">
                        <label for="bitget-interface-account" class="text-sm font-semibold whitespace-nowrap">
                            <i class="fas fa-wallet mr-2"></i>Cuenta destino:
                        </label>
                        <select id="bitget-interface-account" class="flex-1 bg-background border border-border rounded px-3 py-2 text-sm">
                            <option value="">Selecciona una cuenta...</option>
                        </select>
                    </div>

                    <!-- √Årea de texto para pegar datos -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <label for="bitget-interface-data" class="text-sm font-semibold mb-2">
                            <i class="fas fa-paste mr-2"></i>Datos del Historial de Posici√≥n:
                        </label>
                        <textarea 
                            id="bitget-interface-data" 
                            class="flex-1 bg-background border border-border rounded p-3 text-sm font-mono resize-none"
                            placeholder="Pega aqu√≠ los datos copiados desde Bitget...&#10;&#10;Ejemplo:&#10;BTCUSDT&#10;Short ¬∑ Aislado&#10;2025-08-23&#10;17:37:37&#10;114,818.1&#10;114,794.1&#10;0.5565 BTC&#10;0.5565 BTC&#10;-37.7531 USDT&#10;--&#10;2025-08-23&#10;17:58:12&#10;--"
                        ></textarea>
                    </div>

                    <!-- Mensaje de estado -->
                    <div id="bitget-interface-status" class="text-sm text-center"></div>
                </div>

                <div class="mt-4 pt-4 border-t border-border flex justify-end gap-3">
                    <button id="bitget-interface-cancel-btn" class="px-4 py-2 bg-surface-light border border-border rounded hover:bg-surface transition-colors">
                        Cancelar
                    </button>
                    <button id="bitget-interface-import-btn-modal" class="px-4 py-2 bg-primary text-background rounded hover:bg-secondary transition-colors font-semibold">
                        <i class="fas fa-upload mr-2"></i>Importar Operaciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Importaci√≥n desde Interfaz de PrimeXBT -->
        <div id="primexbt-interface-import-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4" style="background-color: rgba(0,0,0,0.95);">
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-semibold">Importar desde Interfaz de PrimeXBT</h3>
                        <p class="text-sm text-text-secondary mt-1">Copia y pega las operaciones directamente desde la interfaz del broker</p>
                    </div>
                    <button id="primexbt-interface-close-btn" class="p-2 -mr-2 rounded-full hover:bg-surface-light"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                    <!-- Instrucciones -->
                    <div class="bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-4">
                        <h4 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>
                            Instrucciones
                        </h4>
                        <ol class="text-sm text-text-secondary space-y-1 ml-4 list-decimal">
                            <li>Ve a tu historial de operaciones en PrimeXBT</li>
                            <li>Selecciona las operaciones que deseas importar</li>
                            <li>Copia toda la informaci√≥n (Ctrl+C o Cmd+C)</li>
                            <li>Pega los datos en el √°rea de texto a continuaci√≥n</li>
                            <li>Selecciona la cuenta donde deseas importar las operaciones</li>
                            <li>Haz clic en "Importar Operaciones"</li>
                        </ol>
                    </div>

                    <!-- Selector de cuenta -->
                    <div class="flex items-center gap-4">
                        <label for="primexbt-interface-account" class="text-sm font-semibold whitespace-nowrap">
                            <i class="fas fa-wallet mr-2"></i>Cuenta destino:
                        </label>
                        <select id="primexbt-interface-account" class="flex-1 bg-background border border-border rounded px-3 py-2 text-sm">
                            <option value="">Selecciona una cuenta...</option>
                        </select>
                    </div>

                    <!-- √Årea de texto para pegar datos -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <label for="primexbt-interface-data" class="text-sm font-semibold mb-2">
                            <i class="fas fa-paste mr-2"></i>Datos de operaciones:
                        </label>
                        <textarea 
                            id="primexbt-interface-data" 
                            class="flex-1 bg-background border border-border rounded p-3 text-sm font-mono resize-none"
                            placeholder="Pega aqu√≠ los datos copiados desde PrimeXBT...&#10;&#10;Ejemplo:&#10;1132091056&#10;ETH/USDT&#10;Mercado&#10;Vender&#10;Ejecutado&#10;4,10&#10;‚àí6,3714 USDT&#10;+66,0510 USDT&#10;+22,81 %&#10;‚Äî&#10;4,10&#10;3453,34&#10;08/11/25, 09:59:59"
                        ></textarea>
                    </div>

                    <!-- Mensaje de estado -->
                    <div id="primexbt-interface-status" class="text-sm text-center"></div>
                </div>

                <div class="mt-4 pt-4 border-t border-border flex justify-end gap-3">
                    <button id="primexbt-interface-cancel-btn" class="px-4 py-2 bg-surface-light border border-border rounded hover:bg-surface transition-colors">
                        Cancelar
                    </button>
                    <button id="primexbt-interface-import-btn" class="px-4 py-2 bg-primary text-background rounded hover:bg-secondary transition-colors font-semibold">
                        <i class="fas fa-upload mr-2"></i>Importar Operaciones
                    </button>
                </div>
            </div>
        </div>

        <!-- --- NUEVO: Modal para Detalles de Analytics --- -->
        <div id="analytics-detail-modal">
            <div class="analytics-detail-container">
                <div class="flex justify-between items-start mb-6">
                    <h2 id="analytics-detail-title" class="text-3xl font-bold text-primary">An√°lisis Detallado</h2>
                    <button id="analytics-detail-close-btn" class="text-3xl text-text-secondary hover:text-text leading-none">&times;</button>
                </div>

                <!-- M√©tricas principales -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">P&L Bruto Total</h3><p id="analytics-detail-pl" class="text-3xl font-bold">$0.00</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Win Rate</h3><p id="analytics-detail-winrate" class="text-3xl font-bold">0%</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Profit Factor</h3><p id="analytics-detail-pf" class="text-3xl font-bold">0.00</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Operaciones</h3><p id="analytics-detail-trades" class="text-3xl font-bold">0</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Total Comisiones</h3><p id="analytics-detail-fees" class="text-3xl font-bold text-red">$0.00</p></div>
                </div>

                <!-- Gr√°ficos y M√©tricas Avanzadas -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="metric-card lg:col-span-1">
                        <h3 class="text-lg font-semibold mb-3">Estad√≠sticas Clave</h3>
                        <dl class="space-y-3 text-sm">
                            <div class="flex justify-between"><dt>Ganancia Promedio:</dt><dd id="analytics-detail-avg-win" class="font-semibold text-green">$0.00</dd></div>
                            <div class="flex justify-between"><dt>P√©rdida Promedio:</dt><dd id="analytics-detail-avg-loss" class="font-semibold text-red">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Comisi√≥n Promedio:</dt><dd id="analytics-detail-avg-fee" class="font-semibold text-yellow">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Ratio G/P Promedio:</dt><dd id="analytics-detail-w-l-ratio" class="font-semibold">0.00</dd></div>
                            <div class="flex justify-between"><dt>Mayor Ganancia:</dt><dd id="analytics-detail-largest-win" class="font-semibold text-green">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Mayor P√©rdida:</dt><dd id="analytics-detail-largest-loss" class="font-semibold text-red">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Drawdown M√°ximo:</dt><dd id="analytics-detail-drawdown" class="font-semibold text-red">$0.00</dd></div>
                            <div class="flex justify-between border-t border-surface-light pt-2 mt-2"><dt class="font-bold">P&L Neto Total:</dt><dd id="analytics-detail-net-pl" class="font-bold text-green">$0.00</dd></div>
                        </dl>
                    </div>
                     <div class="metric-card lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-2">Puntuaci√≥n de Rendimiento</h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="analytics-detail-radar-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- M√°s Gr√°ficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento</h3>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="analytics-detail-instrument-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento Long vs Short</h3>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="analytics-detail-long-short-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fica de Evoluci√≥n del P&L del D√≠a -->
                <div class="metric-card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Evoluci√≥n del P&L del D√≠a</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="analytics-detail-pnl-evolution-chart"></canvas>
                    </div>
                </div>

                <!-- Tabla de Operaciones -->
                <div class="metric-card p-0">
                    <h3 class="text-lg font-semibold p-4">Operaciones del Per√≠odo</h3>
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Instrumento</th>
                                    <th>Tipo</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Volumen</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-detail-table-body">
                                <!-- Las operaciones se insertar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal de Pantalla Completa para Gr√°ficos -->
    <div id="fullscreen-chart-modal" onclick="if(event.target.id==='fullscreen-chart-modal')window.closeFullscreenChart()" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.98); z-index: 10000; padding: 0; margin: 0;">
        <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                <h2 id="fullscreen-chart-title" style="color: #39FF14; font-size: 28px; font-weight: bold; margin: 0; text-shadow: 0 0 10px rgba(57,255,20,0.5);"></h2>
                <button onclick="window.closeFullscreenChart()" style="background: #FF0000; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 0 15px rgba(255,0,0,0.5); transition: all 0.3s;">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
            <div style="flex: 1; background: #0f0f0f; border-radius: 12px; padding: 25px; position: relative; border: 2px solid #39FF14; box-shadow: 0 0 20px rgba(57,255,20,0.3); min-height: 0;">
                <canvas id="fullscreen-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para autenticaci√≥n
        let currentUser = null;
        let isSyncing = false;

        const dexieDB = new Dexie('TraderSurvivorDB');

        // Versi√≥n 7: Esquema original
        dexieDB.version(7).stores({
            accounts: 'id,name,currency,platform',
            operations: 'id,date,accountId,instrument,result,currency',
            finances: '++id,date',
            generalData: 'key',
            apiKeys: 'id'
        });

        // Versi√≥n 8: Asegurar que apiKeys existe con el esquema correcto
        dexieDB.version(8).stores({
            accounts: 'id,name,currency,platform',
            operations: 'id,date,accountId,instrument,result,currency',
            finances: '++id,date',
            generalData: 'key',
            apiKeys: 'id,platform,key,secret'
        });

        // Versi√≥n 9: A√±adir parentId para parciales
        dexieDB.version(9).stores({
            operations: 'id,date,accountId,instrument,result,currency,parentId' // A√±adir parentId
        });

        dexieDB.version(10).stores({
            setups: 'id,category,rating,createdAt' // Nueva tabla para Playbook
        });

        dexieDB.version(11).stores({
            fundedAccounts: 'id,company,type,status,activationDate' // Tabla para Funded Accounts
        });

        // Hacer DB global para acceso desde otros scripts
        window.DB = {
            accounts: [],
            operations: [],
            finances: [],
            fundedAccounts: [], // Nueva tabla para cuentas funded
            settings: { showTooltips: true, defaultCurrency: 'USD' },
            apiKeys: { ctrader: {}, bingx: {}, bitget: {}, mexc: {} },
            setups: [], // Nueva tabla para Playbook
            chartbookImages: [], // Im√°genes de gr√°ficos en Chartbook
            journalEntries: [] // Entradas del Daily Journal
        };
        
        // Alias local para compatibilidad
        const DB = window.DB;

        let globalDateFilter = { type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' };
        let globalSelectedAccount = 'all'; // Nueva variable global para sincronizar cuentas
        let popupCalendarStateDate = new Date();
        const monthNamesShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        let currentEditingOpImages = [];
        let modalImageList = [];
        let modalImageIndex = 0;
        // NUEVO: Estado para el ordenamiento de la tabla de operaciones
        let operationSortState = { column: 'date', order: 'desc' };
        let informeFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all' };

        // ===== FUNCIONES DE SINCRONIZACI√ìN DE CUENTA =====
        function syncAccountSelection(accountId) {
            console.log('üîÑ Sincronizando cuenta a:', accountId);
            globalSelectedAccount = accountId;
            
            // Actualizar todos los selectores de cuenta principales
            const selectors = [
                'dashboard-account-select',
                'analytics-account-select',
                'informe-account-select',
                'daily-journal-account-select',
                'calendar-account-select',
                'equity-account-select',
                'filter-account',
                'chartbook-account-select'
            ];
            
            selectors.forEach(selectorId => {
                const selectElement = document.getElementById(selectorId);
                if (selectElement && selectElement.value !== accountId) {
                    selectElement.value = accountId;
                    updateSelectorLogo(selectorId);
                }
            });
            
            console.log('‚úÖ Cuenta sincronizada en todas las secciones con logos');
        }

        function refreshCurrentSection() {
            const activeSection = document.querySelector('.section-container.active');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            console.log('üîÑ Refrescando secci√≥n activa:', sectionId);
            
            switch(sectionId) {
                case 'dashboard':
                    if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    }
                    break;
                case 'analytics':
                    if (typeof refreshAnalytics === 'function') {
                        refreshAnalytics();
                    }
                    break;
                case 'equity-graph':
                    if (typeof refreshEquityGraph === 'function') {
                        refreshEquityGraph();
                    }
                    break;
                case 'daily-journal':
                    if (typeof refreshDailyJournal === 'function') {
                        refreshDailyJournal();
                    }
                    break;
                case 'informe':
                    if (typeof refreshInforme === 'function') {
                        refreshInforme();
                    }
                    break;
                case 'operations':
                    if (typeof refreshOperationsTable === 'function') {
                        refreshOperationsTable();
                    }
                    break;
                case 'finances':
                    if (typeof refreshFinancesView === 'function') {
                        refreshFinancesView();
                    }
                    break;
                case 'calendar':
                    if (typeof updateCalendar === 'function') {
                        setTimeout(() => updateCalendar(), 50);
                    }
                    break;
                case 'chartbook':
                    if (typeof window.refreshChartbook === 'function') {
                        setTimeout(() => window.refreshChartbook(), 50);
                    }
                    break;
                case 'playbook':
                    if (typeof window.refreshPlaybook === 'function') {
                        setTimeout(() => window.refreshPlaybook(), 50);
                    }
                    break;
                case 'accounts':
                    if (typeof refreshAccountsView === 'function') {
                        refreshAccountsView();
                    }
                    break;
            }
        }

        // ===== SIDEBAR FUNCTIONALITY =====
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            const pageTitle = document.getElementById('pageTitle');
            
            // Toggle sidebar collapse
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    const icon = sidebarToggle.querySelector('i');
                    const span = sidebarToggle.querySelector('span');
                    
                    if (sidebar.classList.contains('collapsed')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-arrow-right');
                        if (span) span.textContent = 'Expandir';
                    } else {
                        icon.classList.remove('fa-arrow-right');
                        icon.classList.add('fa-bars');
                        if (span) span.textContent = 'Contraer';
                    }
                    
                    // Save state in localStorage
                    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                });
            }
            
            // Restore sidebar state
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed && sidebar) {
                sidebar.classList.add('collapsed');
                const icon = sidebarToggle.querySelector('i');
                const span = sidebarToggle.querySelector('span');
                if (icon) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-arrow-right');
                }
                if (span) span.textContent = 'Expandir';
            }
            
            // Navigation items click
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.dataset.target;
                    
                    if (!target) return;
                    
                    // Show section
                    showSection(target);
                    updatePageTitle(getSectionTitle(target));
                    
                    // Update active state
                    updateActiveNavItem(target);
                });
            });
            
            // Footer items
            const footerItems = document.querySelectorAll('.footer-item');
            footerItems.forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.dataset.target;
                    if (target) {
                        showSection(target);
                        updateActiveNavItem(target);
                        updatePageTitle(getSectionTitle(target));
                    }
                });
            });
            
            // Dark mode toggle (placeholder for future implementation)
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    alert('Modo oscuro se implementar√° pr√≥ximamente');
                });
            }
            
            // Support button
            const supportBtn = document.getElementById('supportBtn');
            if (supportBtn) {
                supportBtn.addEventListener('click', () => {
                    window.open('mailto:support@tradersurvivor.com', '_blank');
                });
            }
        }
        
        function updateActiveNavItem(target) {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => {
                if (item.dataset.target === target) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function updatePageTitle(title) {
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = title;
            }
        }
        
        function getSectionTitle(section) {
            const titles = {
                'dashboard': 'Dashboard',
                'analytics': 'Analytics',
                'equity-graph': 'Equity Graph',
                'informe': 'Informe',
                'calendar': 'Calendario',
                'operations': 'Operaciones',
                'chartbook': 'Chartbook',
                'playbook': 'Playbook',
                'accounts': 'Cuentas',
                'finances': 'Finanzas',
                'platforms': 'Plataformas',
                'news': 'Noticias',
                'config': 'Configuraci√≥n'
            };
            return titles[section] || section.charAt(0).toUpperCase() + section.slice(1);
        }
        
        // ===== CONFIGURATION SECTION NAVIGATION =====
        function initConfigNavigation() {
            const configNavItems = document.querySelectorAll('.config-nav-item');
            const configSections = document.querySelectorAll('.config-section');
            
            configNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.configSection;
                    
                    // Update active nav item
                    configNavItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show corresponding section
                    configSections.forEach(section => {
                        if (section.id === 'config-' + sectionId) {
                            section.classList.add('active');
                        } else {
                            section.classList.remove('active');
                        }
                    });
                });
            });

            // Connect old auth buttons to new config sections
            const showAuthModalBtnOld = document.getElementById('show-auth-modal-btn');
            const configShowAuthModalBtn = document.getElementById('config-show-auth-modal-btn');
            const logoutBtnConfigOld = document.getElementById('logout-btn-config');
            const configLogoutBtn = document.getElementById('config-logout-btn');

            if (configShowAuthModalBtn) {
                configShowAuthModalBtn.addEventListener('click', () => {
                    if (typeof showAuth === 'function') showAuth();
                });
            }

            if (configLogoutBtn) {
                configLogoutBtn.addEventListener('click', async () => {
                    if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                        await supabase.auth.signOut();
                        location.reload();
                    }
                });
            }

            // Save user info
            const saveUserInfoBtn = document.getElementById('save-user-info');
            if (saveUserInfoBtn) {
                saveUserInfoBtn.addEventListener('click', async () => {
                    const username = document.getElementById('config-username').value;
                    localStorage.setItem('username', username);
                    
                    // Actualizar en Audici√≥n
                    loadAudicionUserInfo();
                    
                    // Guardar configuraci√≥n de perfil p√∫blico
                    if (typeof saveUserPublicSettings === 'function') {
                        await saveUserPublicSettings();
                    }
                    
                    showMessage('Informaci√≥n guardada correctamente', 'success');
                });
            }
            
            // Toggle de perfil p√∫blico - actualizar label
            const publicProfileToggle = document.getElementById('config-public-profile');
            const publicProfileLabel = document.getElementById('config-public-profile-label');
            if (publicProfileToggle && publicProfileLabel) {
                publicProfileToggle.addEventListener('change', function() {
                    if (this.checked) {
                        publicProfileLabel.textContent = 'Perfil P√∫blico';
                        publicProfileLabel.style.color = '#10B981'; // Verde
                    } else {
                        publicProfileLabel.textContent = 'Perfil Privado';
                        publicProfileLabel.style.color = '#6B7280'; // Gris
                    }
                });
            }

            // Change password
            const changePasswordBtn = document.getElementById('change-password-btn');
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', async () => {
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (!newPassword || newPassword.length < 6) {
                        showMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showMessage('Las contrase√±as no coinciden', 'error');
                        return;
                    }

                    try {
                        const { error } = await supabase.auth.updateUser({ password: newPassword });
                        if (error) throw error;
                        showMessage('Contrase√±a actualizada correctamente', 'success');
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                    } catch (error) {
                        showMessage('Error al cambiar la contrase√±a: ' + error.message, 'error');
                    }
                });
            }

            // CSV Import (config version)
            const configImportCsvBtn = document.getElementById('config-import-csv-btn');
            const configCsvFileInput = document.getElementById('config-csv-file-input');
            
            if (configImportCsvBtn && configCsvFileInput) {
                configImportCsvBtn.addEventListener('click', () => {
                    const file = configCsvFileInput.files[0];
                    if (!file) {
                        showMessage('Por favor selecciona un archivo CSV', 'error');
                        return;
                    }
                    // Trigger original CSV import logic
                    if (typeof procesarCSV === 'function') {
                        const reader = new FileReader();
                        reader.onload = (e) => procesarCSV(e.target.result);
                        reader.readAsText(file);
                    }
                });
            }

            // Export buttons (config version)
            const configExportJson = document.getElementById('config-export-json');
            const configExportCsv = document.getElementById('config-export-csv');
            const configExportPdf = document.getElementById('config-export-pdf');
            const configImportJson = document.getElementById('config-import-json');
            const configClearData = document.getElementById('config-clear-data');

            console.log('üîß Inicializando botones de exportar/importar');

            if (configExportJson) {
                configExportJson.addEventListener('click', async () => {
                    console.log('üì§ Exportando JSON...');
                    try {
                        const exportData = {
                            version: '2.0',
                            exportDate: new Date().toISOString(),
                            operations: DB.operations || [],
                            accounts: DB.accounts || [],
                            finances: DB.finances || [],
                            settings: {
                                username: localStorage.getItem('username') || '',
                                theme: localStorage.getItem('theme') || 'dark'
                            }
                        };

                        const jsonString = JSON.stringify(exportData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `trader-survivor-backup-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        alert('‚úÖ Respaldo JSON exportado correctamente');
                        console.log('‚úÖ JSON exportado con √©xito');
                    } catch (error) {
                        console.error('‚ùå Error exportando JSON:', error);
                        alert('‚ùå Error al exportar JSON');
                    }
                });
                console.log('‚úÖ Bot√≥n Export JSON configurado');
            }

            if (configExportCsv) {
                configExportCsv.addEventListener('click', async () => {
                    console.log('üì§ Exportando CSV...');
                    try {
                        const operations = DB.operations || [];
                        if (operations.length === 0) {
                            alert('‚ö†Ô∏è No hay operaciones para exportar');
                            return;
                        }
                        
                        const csvContent = convertToCSV(operations);
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `operaciones-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        alert('‚úÖ CSV exportado correctamente');
                        console.log('‚úÖ CSV exportado con √©xito');
                    } catch (error) {
                        console.error('‚ùå Error exportando CSV:', error);
                        alert('‚ùå Error al exportar CSV');
                    }
                });
                console.log('‚úÖ Bot√≥n Export CSV configurado');
            }

            if (configExportPdf) {
                configExportPdf.addEventListener('click', async () => {
                    console.log('üì§ Exportando PDF...');
                    alert('‚ö†Ô∏è Funci√≥n de exportar PDF en desarrollo.\nUsa Imprimir (Ctrl+P) desde la secci√≥n Informe para generar PDFs.');
                });
                console.log('‚úÖ Bot√≥n Export PDF configurado');
            }

            if (configImportJson) {
                configImportJson.addEventListener('change', async (e) => {
                    console.log('üì• Importando JSON...');
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const importData = JSON.parse(event.target.result);
                                
                                if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esto reemplazar√° todos tus datos actuales.\n¬øEst√°s seguro de que deseas continuar?')) {
                                    return;
                                }

                                // Importar operaciones
                                if (importData.operations && Array.isArray(importData.operations)) {
                                    DB.operations = importData.operations;
                                    console.log(`‚úÖ ${importData.operations.length} operaciones importadas`);
                                }

                                // Importar cuentas
                                if (importData.accounts && Array.isArray(importData.accounts)) {
                                    DB.accounts = importData.accounts;
                                    console.log(`‚úÖ ${importData.accounts.length} cuentas importadas`);
                                }

                                // Importar finanzas
                                if (importData.finances && Array.isArray(importData.finances)) {
                                    DB.finances = importData.finances;
                                    console.log(`‚úÖ ${importData.finances.length} finanzas importadas`);
                                }

                                // Guardar todo en localStorage
                                saveToLocalStorage();

                                alert('‚úÖ Respaldo importado correctamente.\nLa p√°gina se recargar√°.');
                                location.reload();
                            } catch (error) {
                                console.error('‚ùå Error parseando JSON:', error);
                                alert('‚ùå Error: El archivo no es un JSON v√°lido');
                            }
                        };
                        reader.readAsText(file);
                    } catch (error) {
                        console.error('‚ùå Error importando JSON:', error);
                        alert('‚ùå Error al importar archivo');
                    }

                    // Reset input
                    e.target.value = '';
                });
                console.log('‚úÖ Bot√≥n Import JSON configurado');
            }

            if (configClearData) {
                configClearData.addEventListener('click', async () => {
                    console.log('üóëÔ∏è Borrar datos...');
                    if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODOS tus datos.\n¬øEst√°s seguro de que deseas continuar?')) {
                        return;
                    }

                    if (!confirm('‚ö†Ô∏è √öLTIMA ADVERTENCIA: Esta acci√≥n NO se puede deshacer.\n¬øRealmente deseas borrar todos los datos?')) {
                        return;
                    }

                    try {
                        DB.operations = [];
                        DB.accounts = [];
                        DB.finances = [];
                        saveToLocalStorage();
                        
                        alert('‚úÖ Todos los datos han sido borrados.\nLa p√°gina se recargar√°.');
                        location.reload();
                    } catch (error) {
                        console.error('‚ùå Error borrando datos:', error);
                        alert('‚ùå Error al borrar datos');
                    }
                });
                console.log('‚úÖ Bot√≥n Clear Data configurado');
            }

            // Update stats in billing section
            updateConfigStats();
        }

        async function updateConfigStats() {
            try {
                const totalTrades = await dexieDB.operations.count();
                const totalAccounts = await dexieDB.accounts.count();
                
                const tradesCountEl = document.getElementById('total-trades-count');
                const accountsCountEl = document.getElementById('total-accounts-count');
                
                if (tradesCountEl) tradesCountEl.textContent = totalTrades;
                if (accountsCountEl) accountsCountEl.textContent = totalAccounts;
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando estad√≠sticas de configuraci√≥n:', error);
            }
        }

        function updateConfigUserInfo(user) {
            if (!user) return;
            
            const configUserEmail = document.getElementById('config-user-email');
            const configCurrentUserEmail = document.getElementById('config-current-user-email');
            const configUserAvatar = document.getElementById('config-user-avatar');
            const configAuthLoggedOut = document.getElementById('config-auth-status-logged-out');
            const configAuthLoggedIn = document.getElementById('config-auth-status-logged-in');
            
            if (configUserEmail) configUserEmail.value = user.email;
            if (configCurrentUserEmail) configCurrentUserEmail.textContent = user.email;
            if (configUserAvatar) configUserAvatar.textContent = user.email.charAt(0).toUpperCase();
            
            if (configAuthLoggedOut) configAuthLoggedOut.style.display = 'none';
            if (configAuthLoggedIn) configAuthLoggedIn.style.display = 'flex';

            // Load username from localStorage
            const username = localStorage.getItem('username') || '';
            const configUsername = document.getElementById('config-username');
            if (configUsername) configUsername.value = username;
        }

        function convertToCSV(operations) {
            const headers = ['Cuenta', 'ID', 'Fecha', 'Hora Entrada', 'Hora Salida', 'Instrumento', 'Tipo', 'Entrada', 'Salida', 'Volumen', 'P&L', 'Divisa', 'Comision', 'Notas'];
            const rows = operations.map(op => [
                op.accountName || '',
                op.id || '',
                op.date || '',
                op.entryTime || '',
                op.exitTime || '',
                op.symbol || '',
                op.type || '',
                op.entry || '',
                op.exit || '',
                op.volume || '',
                op.pl || '',
                op.currency || 'USD',
                op.commission || '',
                op.notes || ''
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            return csvContent;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showMessage(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} toast-notification`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <p>${message}</p>
            `;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function applyInformeFilters(operations) {
            let filteredOps = [...operations];

            // Symbol filter
            if (informeFilters.symbol) {
                filteredOps = filteredOps.filter(op => op.instrument.toUpperCase().includes(informeFilters.symbol));
            }
            // Type filter
            if (informeFilters.type !== 'all') {
                filteredOps = filteredOps.filter(op => op.type === informeFilters.type);
            }
            // Result filter
            if (informeFilters.result !== 'all') {
                filteredOps = filteredOps.filter(op => op.result === informeFilters.result);
            }
            // P/L Min filter
            if (informeFilters.plMin !== null) {
                filteredOps = filteredOps.filter(op => op.pl >= informeFilters.plMin);
            }
            // P/L Max filter
            if (informeFilters.plMax !== null) {
                filteredOps = filteredOps.filter(op => op.pl <= informeFilters.plMax);
            }
            // Day of week filter
            if (informeFilters.day !== 'all') {
                filteredOps = filteredOps.filter(op => new Date(op.date + 'T00:00:00').getUTCDay() == informeFilters.day);
            }

            return filteredOps;
        }


        async function loadData() {
            showLoading(true);
            try {
                const [accounts, operations, finances, storedSettings, storedApiKeys, setups, fundedAccounts] = await Promise.all([
                    dexieDB.accounts.toArray(),
                    dexieDB.operations.toArray(),
                    dexieDB.finances.toArray(),
                    dexieDB.generalData.get('settings').then(result => result?.value),
                    dexieDB.generalData.get('apiKeys').then(result => result?.value),
                    dexieDB.setups.toArray(),
                    dexieDB.fundedAccounts.toArray()
                ]);

                DB.accounts = accounts || [];
                DB.operations = operations || [];
                DB.finances = finances || [];
                DB.setups = setups || [];
                DB.fundedAccounts = fundedAccounts || [];

                if (storedSettings) {
                    DB.settings = { ...{ darkMode: true, showTooltips: true, autoRefresh: false, defaultCurrency: 'USD' }, ...storedSettings };
                } else {
                    await dexieDB.generalData.put({ key: 'settings', value: DB.settings });
                }

                // Verificar localStorage primero antes de cargar desde DB
                const localBingXApiKey = localStorage.getItem('bingx-api-key');
                const localBingXSecretKey = localStorage.getItem('bingx-secret-key');
                const localBingXAccountId = localStorage.getItem('bingx-account-id');

                if (storedApiKeys) {
                    DB.apiKeys = {
                        ...{
                            ctrader: { key: '', secret: '', accountId: '' },
                            bingx: { key: '', secret: '', accountId: '' },
                            bitget: { key: '', secret: '', passphrase: '', accountId: '' }
                        },
                        ...storedApiKeys
                    };

                    // Si hay credenciales en localStorage, priorizarlas sobre las de DB
                    if (localBingXApiKey && localBingXSecretKey) {
                        DB.apiKeys.bingx = {
                            key: localBingXApiKey,
                            secret: localBingXSecretKey,
                            accountId: localBingXAccountId || 'main',
                            mode: 'real'
                        };
                        // Actualizar DB con las credenciales de localStorage
                        await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });
                    }
                } else {
                    // Si no hay datos en DB, verificar localStorage
                    if (localBingXApiKey && localBingXSecretKey) {
                        DB.apiKeys.bingx = {
                            key: localBingXApiKey,
                            secret: localBingXSecretKey,
                            accountId: localBingXAccountId || 'main',
                            mode: 'real'
                        };
                    }
                    await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });
                }


                let operationsToUpdateInDB = [];
                DB.operations.forEach(op => {
                    let changes = {};
                    let hasChanged = false;

                    if (op.date && op.date.includes('/')) {
                        const parts = op.date.split('/');
                        if (parts.length === 3) {
                            op.date = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            changes.date = op.date;
                            hasChanged = true;
                        }
                    }
                    if (typeof op.imageData !== 'undefined' && op.imageData !== null) {
                        if (typeof op.imageDatas === 'undefined' || !Array.isArray(op.imageDatas) || op.imageDatas.length === 0) {
                            op.imageDatas = [op.imageData];
                            changes.imageDatas = op.imageDatas;
                            changes.imageData = Dexie.delete; // Eliminar la propiedad antigua
                            hasChanged = true;
                        }
                        delete op.imageData;
                    } else if (typeof op.imageDatas === 'undefined' || !Array.isArray(op.imageDatas)) {
                         op.imageDatas = [];
                         changes.imageDatas = [];
                         if (typeof op.imageData !== 'undefined') {
                            changes.imageData = Dexie.delete;
                            delete op.imageData;
                         }
                         hasChanged = true;
                    }

                    if (typeof op.manualPL === 'undefined') {op.manualPL = null; changes.manualPL = null; hasChanged = true;}
                    if (typeof op.entryTime === 'undefined') {op.entryTime = null; changes.entryTime = null; hasChanged = true;}
                    if (typeof op.exitTime === 'undefined') {op.exitTime = null; changes.exitTime = null; hasChanged = true;}
                    // A√±adir migraci√≥n para el nuevo campo 'session'
                    if (typeof op.session === 'undefined') {op.session = null; changes.session = null; hasChanged = true;}

                    if(hasChanged) {
                        operationsToUpdateInDB.push({key: op.id, changes: changes});
                    }
                });

                if (operationsToUpdateInDB.length > 0) {
                    // bulkUpdate no existe en Dexie, usar bulkPut con objetos completos
                    const opsToUpdate = operationsToUpdateInDB.map(item => {
                        const op = DB.operations.find(o => o.id === item.key);
                        return {...op, ...item.changes};
                    });
                    await dexieDB.operations.bulkPut(opsToUpdate);
                }


            } catch (e) {
                console.error('Error loading data from DexieDB:', e);
            } finally {
                showLoading(false);
            }
        }



        function updateAccountBalances() {
            DB.accounts.forEach(account => {
                account.balance = account.initialBalance;
                const accountOps = DB.operations.filter(op => op.accountId === account.id);
                accountOps.forEach(operation => {
                    let pl = operation.pl;
                    if (operation.currency !== account.currency) {
                        pl = convertCurrency(pl, operation.currency, account.currency);
                    }
                    account.balance += pl;
                });
                account.balance = Math.round(account.balance * 100) / 100;
            });
        }

        // Funci√≥n global para guardar setups en Dexie
        window.saveDB = async function() {
            try {
                console.log('üíæ Guardando setups en base de datos...');
                await dexieDB.setups.clear();
                if (DB.setups && DB.setups.length > 0) {
                    await dexieDB.setups.bulkAdd(DB.setups);
                    console.log(`‚úÖ ${DB.setups.length} setups guardados`);
                } else {
                    console.log('‚ÑπÔ∏è No hay setups para guardar');
                }
            } catch (error) {
                console.error('‚ùå Error guardando setups:', error);
            }
        };


        function convertCurrency(amount, fromCurrency, toCurrency) {
            // Mapeo de monedas comunes a sus equivalentes principales
            const currencyMapping = {
                'USDT': 'USD',
                'USDC': 'USD',
                'DAI': 'USD',
                'BUSD': 'USD',
                'TUSD': 'USD'
            };

            const rates = {
                'USD_EUR': 0.92,
                'EUR_USD': 1.09,
                'USD_USDT': 1.0,
                'USDT_USD': 1.0,
                'USD_USDC': 1.0,
                'USDC_USD': 1.0
            };

            // Validar y limpiar par√°metros
            if (!fromCurrency || !toCurrency || typeof fromCurrency !== 'string' || typeof toCurrency !== 'string') {
                return amount || 0;
            }

            // Normalizar monedas
            const normalizedFrom = currencyMapping[fromCurrency.toUpperCase()] || fromCurrency.toUpperCase();
            const normalizedTo = currencyMapping[toCurrency.toUpperCase()] || toCurrency.toUpperCase();

            if (normalizedFrom === normalizedTo) return amount || 0;

            const rateKey = `${normalizedFrom}_${normalizedTo}`;
            if (rates[rateKey]) return (amount || 0) * rates[rateKey];

            // Solo mostrar warning si las monedas no son equivalentes conocidas
            if (!currencyMapping[fromCurrency] && !currencyMapping[toCurrency]) {
                console.warn(`Tasa de conversi√≥n no encontrada para ${fromCurrency} a ${toCurrency}. Usando 1:1.`);
            }

            return amount || 0;
        }

        // Funci√≥n para validar datos de operaciones
        function isValidOperation(op) {
            if (!op) return false;
            if (!op.instrument || typeof op.instrument !== 'string') return false;
            if (!op.currency || typeof op.currency !== 'string') return false;
            if (typeof op.pl !== 'number' || isNaN(op.pl)) return false;
            if (!op.date) return false;
            return true;
        }

        // Funci√≥n para mostrar notificaciones de sincronizaci√≥n
        function showSyncNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444';
            const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle';

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                z-index: 9999;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 350px;
                animation: slideInRight 0.3s ease-out;
            `;

            notification.innerHTML = `<i class="fas fa-${icon} mr-2"></i>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function formatCurrency(amount, baseCurrency = null, displayCurrency = null) {
            let currencyToDisplay = displayCurrency;
            if (!currencyToDisplay) {
                // Intentar obtener el selector de moneda de la secci√≥n activa
                const activeTab = document.querySelector('.nav-tab.active')?.dataset.target;
                let currencySelect = null;
                if (activeTab === 'dashboard') currencySelect = document.getElementById('dashboard-currency-select');
                else if (activeTab === 'analytics') currencySelect = document.getElementById('analytics-currency-select');
                else if (activeTab === 'informe') currencySelect = document.getElementById('informe-currency-select');
                else if (activeTab === 'calendar') currencySelect = document.getElementById('calendar-currency-select');
                currencyToDisplay = currencySelect ? currencySelect.value : 'USD';
            }

            if (amount === 0 || typeof amount === 'undefined' || amount === null) {
                return currencyToDisplay === '%' ? '0.00%' : currencyToDisplay === 'EUR' ? '‚Ç¨0.00' : '$0.00';
            }
            const amountActualCurrency = baseCurrency || DB.settings.defaultCurrency;

            if (currencyToDisplay === '%') {
                const activeTab = document.querySelector('.nav-tab.active')?.dataset.target;
                let accountSelectId;
                if (activeTab === 'dashboard') accountSelectId = 'dashboard-account-select';
                else if (activeTab === 'analytics') accountSelectId = 'analytics-account-select';
                else if (activeTab === 'calendar') accountSelectId = 'calendar-account-select';

                if (!accountSelectId) return (amount > 0 ? '+' : '') + amount.toFixed(2);

                const selectedAccountFilterInput = document.getElementById(accountSelectId);
                const selectedAccountFilter = selectedAccountFilterInput ? selectedAccountFilterInput.value : 'all';

                let initialBalanceInDefault = 0;
                if (selectedAccountFilter === 'all') {
                    initialBalanceInDefault = DB.accounts.reduce((sum, acc) => {
                        let balance = acc.initialBalance;
                        if (acc.currency !== DB.settings.defaultCurrency) {
                            balance = convertCurrency(balance, acc.currency, DB.settings.defaultCurrency);
                        }
                        return sum + balance;
                    }, 0);
                } else {
                    const foundAccount = DB.accounts.find(a => a.id === selectedAccountFilter);
                    if (foundAccount) {
                        initialBalanceInDefault = foundAccount.initialBalance;
                        if (foundAccount.currency !== DB.settings.defaultCurrency) {
                            initialBalanceInDefault = convertCurrency(initialBalanceInDefault, foundAccount.currency, DB.settings.defaultCurrency);
                        }
                    }
                }
                if (initialBalanceInDefault === 0) return '0.00%';

                let amountInDefault = amount;
                if (amountActualCurrency !== DB.settings.defaultCurrency) {
                    amountInDefault = convertCurrency(amount, amountActualCurrency, DB.settings.defaultCurrency);
                }
                const percentage = (amountInDefault / initialBalanceInDefault) * 100;
                return percentage.toFixed(2) + '%';
            }

            let displayAmount = amount;
            if (amountActualCurrency !== currencyToDisplay) {
                displayAmount = convertCurrency(amount, amountActualCurrency, currencyToDisplay);
            }
            const options = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            if (currencyToDisplay === 'EUR') {
                return '‚Ç¨' + displayAmount.toLocaleString('es-ES', options);
            } else {
                return '$' + displayAmount.toLocaleString('en-US', options);
            }
        }


        function generateId() {
            // Usar sistema de IDs secuenciales simples
            return getNextOperationId();
        }

        /**
         * Detecta autom√°ticamente la sesi√≥n de trading basada en la hora de entrada
         * Horario base: UTC+1 (Madrid)
         * - Londres: 8:00 - 15:00
         * - New York: 15:00 - 22:00
         * - Asia: 22:00 - 8:00
         */
        function detectTradingSession(entryTime) {
            if (!entryTime) return '';
            
            try {
                // Extraer hora y minutos del formato HH:MM o HH:MM:SS
                const timeParts = entryTime.split(':');
                const hour = parseInt(timeParts[0], 10);
                const minute = parseInt(timeParts[1], 10) || 0;
                
                if (isNaN(hour) || hour < 0 || hour > 23) return '';
                
                // Convertir a minutos totales para comparaci√≥n m√°s precisa
                const totalMinutes = hour * 60 + minute;
                
                // Londres: 8:00 (480 min) - 15:00 (900 min)
                if (totalMinutes >= 480 && totalMinutes < 900) {
                    return 'Londres';
                }
                // New York: 15:00 (900 min) - 22:00 (1320 min)
                else if (totalMinutes >= 900 && totalMinutes < 1320) {
                    return 'New York';
                }
                // Asia: 22:00 (1320 min) - 8:00 (480 min) del d√≠a siguiente
                else {
                    return 'Asia';
                }
            } catch (e) {
                console.warn('Error detectando sesi√≥n:', e);
                return '';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                // Crear la fecha como fecha local en lugar de UTC
                const date = dateString.includes('T') ? new Date(dateString) : new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return dateString;

                // Usar m√©todos locales en lugar de UTC
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString;
            }
        }

        function formatPlatformName(platformValue) {
            const names = {
                'meta-trader-4': 'Meta Trader 4',
                'meta-trader-5': 'Meta Trader 5',
                'ctrader': 'cTrader',
                'tradingview': 'TradingView',
                'bingx': 'BingX',
                'bitget': 'Bitget',
                'primexbt': 'PrimeXBT',
                'bitunix': 'Bitunix',
                'other': 'Otra'
            };
            return names[platformValue] || platformValue;
        }

        function getPlatformLogo(platformValue) {
            const logos = {
                'bingx': {
                    file: '/logos/bingx-logo.png',
                    color: '#1E90FF',
                    initials: 'BX'
                },
                'bitget': {
                    file: '/logos/bitget-logo.png',
                    color: '#00F0FF',
                    initials: 'BG'
                },
                'primexbt': {
                    'id': ['order id', 'trade id', 'position id'],
                    file: '/logos/primexbt-logo.png',
                    color: '#0066FF',
                    initials: 'PX'
                },
                'bitunix': {
                    file: '/logos/bitunix-logo.png',
                    color: '#FF6B00',
                    initials: 'BU'
                },
                'mexc': {
                    file: '/logos/mexc-logo.png',
                    color: '#00D4AA',
                    initials: 'MX'
                },
                'binance': {
                    file: '/logos/binance-logo.png',
                    color: '#F3BA2F',
                    initials: 'BN'
                },
                'meta-trader-5': {
                    file: '/logos/metatrader5-logo.png',
                    color: '#1B5E20',
                    initials: 'MT5'
                },
                'meta-trader-4': {
                    file: '/logos/metatrader 4-logo.png',
                    color: '#1B5E20',
                    initials: 'MT4'
                },
                'ctrader': {
                    file: '/logos/ctrader-logo.png',
                    color: '#00A8E1',
                    initials: 'CT'
                },
                'tradingview': {
                    file: '/logos/tradingview-logo.png',
                    color: '#2962FF',
                    initials: 'TV'
                },
                'ninjatrader': {
                    file: '/logos/ninja-logo.png',
                    color: '#FF6600',
                    initials: 'NT'
                },
                'tradovate': {
                    file: '/logos/tradovate-logo.png',
                    color: '#0066CC',
                    initials: 'TD'
                },
                'other': {
                    file: '',
                    color: '#808080',
                    initials: '?'
                }
            };

            return logos[platformValue] || { file: '', color: '#808080', initials: '?' };
        }


        function getStartDateForRange(range) {
            const endDate = new Date();
            let startDate = new Date();
            switch (range) {
                case '1W': startDate.setDate(endDate.getDate() - 7); break;
                case '1M': startDate.setMonth(endDate.getMonth() - 1); break;
                case '3M': startDate.setMonth(endDate.getMonth() - 3); break;
                case '6M': startDate.setMonth(endDate.getMonth() - 6); break;
                case '1Y': startDate.setFullYear(endDate.getFullYear() - 1); break;
                case 'ALL': default: return null;
            }
            return getLocalDateString(startDate);
        }

        function applyDateFilterToData(dataArray) {
            console.log(`[applyDateFilterToData] Applying filter:`, JSON.stringify(globalDateFilter));
            console.log(`[applyDateFilterToData] Input array size: ${dataArray.length}`);

            if (globalDateFilter.type === 'all' || !globalDateFilter.startDate || !globalDateFilter.endDate) {
                console.log(`[applyDateFilterToData] No filter applied. Returning original array.`);
                return dataArray;
            }
            
            const filteredArray = dataArray.filter(item => {
                const itemDate = item.date;
                const isInRange = itemDate >= globalDateFilter.startDate && itemDate <= globalDateFilter.endDate;
                
                // Log para debug (solo primeros 3 items)
                if (dataArray.indexOf(item) < 3) {
                    console.log(`[Filter Debug] Item date: "${itemDate}", Range: "${globalDateFilter.startDate}" to "${globalDateFilter.endDate}", Match: ${isInRange}`);
                }
                
                return isInRange;
            });

            console.log(`[applyDateFilterToData] Output array size: ${filteredArray.length}`);
            console.log(`[applyDateFilterToData] Sample filtered dates:`, filteredArray.slice(0, 3).map(op => op.date));
            return filteredArray;
        }


        // Funci√≥n para descargar secci√≥n como PDF con screenshot
        async function downloadSectionPDF(sectionId, sectionName) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.error('Secci√≥n no encontrada:', sectionId);
                return;
            }

            try {
                // Mostrar loading
                showLoading(true);

                // Crear un contenedor temporal con el logo
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.background = '#0a0a0a';
                container.style.padding = '40px';
                container.style.width = '1200px';
                container.style.fontFamily = 'Segoe UI, Roboto, sans-serif';
                
                // Agregar header con logo REAL de Trader Survivor
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.marginBottom = '30px';
                header.style.paddingBottom = '20px';
                header.style.borderBottom = '2px solid #39ff14';
                
                // Logo usando FontAwesome (igual al header real)
                const logoContainer = document.createElement('div');
                logoContainer.style.marginRight = '15px';
                logoContainer.innerHTML = '<i class="fas fa-shield-alt" style="font-size: 48px; color: #39ff14; text-shadow: 0 0 10px rgba(57, 255, 20, 0.5);"></i>';
                header.appendChild(logoContainer);
                
                const titleContainer = document.createElement('div');
                titleContainer.innerHTML = `
                    <h1 style="color: #39ff14; font-size: 28px; font-weight: bold; margin: 0; font-family: Segoe UI, sans-serif;">Trader Survivor</h1>
                    <p style="color: #a0a0a0; font-size: 14px; margin: 5px 0 0 0; font-family: Segoe UI, sans-serif;">${sectionName} - ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                `;
                header.appendChild(titleContainer);
                
                container.appendChild(header);
                
                // Clonar el contenido de la secci√≥n completo
                const sectionClone = section.cloneNode(true);
                
                // Aplicar estilos para que se vea igual
                sectionClone.style.background = 'transparent';
                sectionClone.style.color = '#ffffff';
                sectionClone.style.width = '100%';
                
                container.appendChild(sectionClone);
                document.body.appendChild(container);

                // Esperar un momento para que se rendericen los iconos de FontAwesome
                await new Promise(resolve => setTimeout(resolve, 500));

                // Generar imagen con html2canvas
                const canvas = await html2canvas(container, {
                    backgroundColor: '#0a0a0a',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    foreignObjectRendering: true,
                    onclone: (clonedDoc) => {
                        // Asegurar que el contenedor sea visible en el clone
                        const clonedContainer = clonedDoc.querySelector('div[style*="position: absolute"]');
                        if (clonedContainer) {
                            clonedContainer.style.left = '0';
                            clonedContainer.style.position = 'relative';
                        }
                    }
                });

                // Remover contenedor temporal
                document.body.removeChild(container);

                // Crear PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                let heightLeft = imgHeight;
                let position = 0;
                
                // Primera p√°gina
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // P√°ginas adicionales si es necesario
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Descargar PDF
                const fileName = `TraderSurvivor_${sectionName}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                showLoading(false);
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showLoading(false);
                alert('Error al generar el PDF. Por favor, intenta nuevamente.');
            }
        }

        // ========== CONTROL DEL SIDEBAR DE FILTROS ==========
        let currentFilterSection = 'dashboard'; // Rastrear qu√© secci√≥n est√° usando los filtros
        
        function toggleFiltersSidebar() {
            const sidebar = document.getElementById('filters-sidebar');
            const overlay = document.getElementById('filters-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleFilterSection(sectionId) {
            const section = document.getElementById(sectionId + '-content').parentElement;
            section.classList.toggle('expanded');
        }

        // Variable global para almacenar filtros de Dashboard
        let dashboardFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all', duration: 'all', session: 'all', showWins: true, showLosses: true, showBreakeven: true };
        let analyticsFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all', duration: 'all', session: 'all', showWins: true, showLosses: true, showBreakeven: true };

        function applyDashboardFilters(operations) {
            console.log('üîç applyDashboardFilters - Entrada:', operations.length, 'operaciones');
            console.log('üîç Filtros activos:', JSON.stringify(dashboardFilters, null, 2));
            
            const filtered = operations.filter(op => {
                // Filtro por s√≠mbolo
                if (dashboardFilters.symbol && !op.symbol.toUpperCase().includes(dashboardFilters.symbol)) {
                    return false;
                }
                
                // Filtro por tipo
                if (dashboardFilters.type !== 'all' && op.type !== dashboardFilters.type) {
                    return false;
                }
                
                // Filtro por resultado con checkboxes
                if (op.pl > 0 && !dashboardFilters.showWins) return false;
                if (op.pl < 0 && !dashboardFilters.showLosses) return false;
                if (op.pl === 0 && !dashboardFilters.showBreakeven) return false;
                
                // Filtro adicional por resultado (dropdown)
                if (dashboardFilters.result !== 'all') {
                    if (dashboardFilters.result === 'win' && op.pl <= 0) return false;
                    if (dashboardFilters.result === 'loss' && op.pl >= 0) return false;
                    if (dashboardFilters.result === 'breakeven' && op.pl !== 0) return false;
                }
                
                // Filtro por P/L
                if (dashboardFilters.plMin !== null && op.pl < dashboardFilters.plMin) return false;
                if (dashboardFilters.plMax !== null && op.pl > dashboardFilters.plMax) return false;
                
                // Filtro por d√≠a de la semana
                if (dashboardFilters.day !== 'all') {
                    const dayOfWeek = new Date(op.date + 'T00:00:00Z').getUTCDay();
                    if (dayOfWeek.toString() !== dashboardFilters.day) return false;
                }
                
                // Filtro por duraci√≥n
                if (op.entryTime && op.exitTime && dashboardFilters.duration !== 'all') {
                    const duration = calculateTradeDuration(op.entryTime, op.exitTime);
                    if (dashboardFilters.duration === 'scalping' && duration >= 5) return false;
                    if (dashboardFilters.duration === 'intraday' && (duration < 5 || duration > 60)) return false;
                    if (dashboardFilters.duration === 'swing' && duration <= 60) return false;
                }
                
                // Filtro por sesi√≥n de trading
                if (dashboardFilters.session !== 'all' && op.entryTime) {
                    const hour = parseInt(op.entryTime.split(':')[0]);
                    if (dashboardFilters.session === 'asian' && (hour < 0 || hour >= 8)) return false;
                    if (dashboardFilters.session === 'london' && (hour < 8 || hour >= 16)) return false;
                    if (dashboardFilters.session === 'newyork' && (hour < 13 || hour >= 22)) return false;
                }
                
                return true;
            });
            
            console.log('üîç applyDashboardFilters - Salida:', filtered.length, 'operaciones');
            if (filtered.length > 0 && filtered.length < 5) {
                console.log('üîç Operaciones filtradas (muestra):', filtered.map(op => ({
                    symbol: op.symbol,
                    type: op.type,
                    pl: op.pl,
                    date: op.date
                })));
            }
            
            return filtered;
        }

        function applyAnalyticsFilters(operations) {
            console.log('üîç applyAnalyticsFilters - Entrada:', operations.length, 'operaciones');
            console.log('üîç Filtros Analytics activos:', JSON.stringify(analyticsFilters, null, 2));
            
            const filtered = operations.filter(op => {
                // Filtro por s√≠mbolo
                if (analyticsFilters.symbol && !op.symbol.toUpperCase().includes(analyticsFilters.symbol)) {
                    return false;
                }
                
                // Filtro por tipo
                if (analyticsFilters.type !== 'all' && op.type !== analyticsFilters.type) {
                    return false;
                }
                
                // Filtro por resultado con checkboxes
                if (op.pl > 0 && !analyticsFilters.showWins) return false;
                if (op.pl < 0 && !analyticsFilters.showLosses) return false;
                if (op.pl === 0 && !analyticsFilters.showBreakeven) return false;
                
                // Filtro adicional por resultado (dropdown)
                if (analyticsFilters.result !== 'all') {
                    if (analyticsFilters.result === 'win' && op.pl <= 0) return false;
                    if (analyticsFilters.result === 'loss' && op.pl >= 0) return false;
                    if (analyticsFilters.result === 'breakeven' && op.pl !== 0) return false;
                }
                
                // Filtro por P/L
                if (analyticsFilters.plMin !== null && op.pl < analyticsFilters.plMin) return false;
                if (analyticsFilters.plMax !== null && op.pl > analyticsFilters.plMax) return false;
                
                // Filtro por d√≠a de la semana
                if (analyticsFilters.day !== 'all') {
                    const dayOfWeek = new Date(op.date + 'T00:00:00Z').getUTCDay();
                    if (dayOfWeek.toString() !== analyticsFilters.day) return false;
                }
                
                // Filtro por duraci√≥n
                if (op.entryTime && op.exitTime && analyticsFilters.duration !== 'all') {
                    const duration = calculateTradeDuration(op.entryTime, op.exitTime);
                    if (analyticsFilters.duration === 'scalping' && duration >= 5) return false;
                    if (analyticsFilters.duration === 'intraday' && (duration < 5 || duration > 60)) return false;
                    if (analyticsFilters.duration === 'swing' && duration <= 60) return false;
                }
                
                // Filtro por sesi√≥n de trading
                if (analyticsFilters.session !== 'all' && op.entryTime) {
                    const hour = parseInt(op.entryTime.split(':')[0]);
                    if (analyticsFilters.session === 'asian' && (hour < 0 || hour >= 8)) return false;
                    if (analyticsFilters.session === 'london' && (hour < 8 || hour >= 16)) return false;
                    if (analyticsFilters.session === 'newyork' && (hour < 13 || hour >= 22)) return false;
                }
                
                return true;
            });
            
            console.log('üîç applyAnalyticsFilters - Salida:', filtered.length, 'operaciones');
            return filtered;
        }

        function calculateTradeDuration(entryTime, exitTime) {
            try {
                // Validar que los tiempos existen
                if (!entryTime || !exitTime) {
                    return 0;
                }
                
                const [eh, em] = entryTime.split(':').map(Number);
                const [xh, xm] = exitTime.split(':').map(Number);
                
                // Validar que los valores son n√∫meros v√°lidos
                if (isNaN(eh) || isNaN(em) || isNaN(xh) || isNaN(xm)) {
                    console.warn('‚ö†Ô∏è Tiempos inv√°lidos:', { entryTime, exitTime });
                    return 0;
                }
                
                let duration = (xh * 60 + xm) - (eh * 60 + em);
                
                // Si la duraci√≥n es negativa, puede ser overnight
                if (duration < 0) {
                    duration += 24 * 60; // Agregar 24 horas
                }
                
                return duration;
            } catch (e) {
                console.warn('‚ö†Ô∏è Error en calculateTradeDuration:', e, { entryTime, exitTime });
                return 0;
            }
        }

        function initDashboard() {
            updateAccountSelect('dashboard-account-select');
            refreshDashboard();
            
            const accountSelect = document.getElementById('dashboard-account-select');
            if (accountSelect) {
                accountSelect.addEventListener('change', function() {
                    const selectedAccount = this.value;
                    syncAccountSelection(selectedAccount); // Sincronizar con todas las secciones
                    updateSelectorLogo('dashboard-account-select');
                    refreshDashboard();
                });
            }
            
            // Selector de moneda Dashboard
            const currencySelect = document.getElementById('dashboard-currency-select');
            if (currencySelect) {
                currencySelect.addEventListener('change', refreshDashboard);
            }

            // Abrir sidebar de filtros
            const filtersBtn = document.getElementById('dashboard-filters-btn');
            if (filtersBtn) {
                filtersBtn.addEventListener('click', () => {
                    currentFilterSection = 'dashboard';
                    toggleFiltersSidebar();
                });
            }

            // Cerrar sidebar
            const closeFiltersBtn = document.getElementById('close-filters-btn');
            const overlay = document.getElementById('filters-overlay');
            if (closeFiltersBtn) {
                closeFiltersBtn.addEventListener('click', toggleFiltersSidebar);
            }
            if (overlay) {
                overlay.addEventListener('click', toggleFiltersSidebar);
            }

            // Aplicar filtros del sidebar
            const sidebarApplyBtn = document.getElementById('sidebar-apply-filters-btn');
            if (sidebarApplyBtn) {
                sidebarApplyBtn.addEventListener('click', () => {
                    console.log('üéØ Aplicando filtros del sidebar...');
                    
                    // Leer valores del sidebar
                    const symbol = document.getElementById('sidebar-filter-symbol').value.toUpperCase();
                    const type = document.getElementById('sidebar-filter-type').value;
                    const result = document.getElementById('sidebar-filter-result').value;
                    const duration = document.getElementById('sidebar-filter-duration').value;
                    const day = document.getElementById('sidebar-filter-day').value;
                    const session = document.getElementById('sidebar-filter-session').value;
                    const plMin = document.getElementById('sidebar-filter-pl-min').value;
                    const plMax = document.getElementById('sidebar-filter-pl-max').value;
                    const showWins = document.getElementById('sidebar-show-wins').checked;
                    const showLosses = document.getElementById('sidebar-show-losses').checked;
                    const showBreakeven = document.getElementById('sidebar-show-breakeven').checked;
                    
                    console.log('üìä Filtros le√≠dos:', { symbol, type, result, duration, day, session, plMin, plMax, showWins, showLosses, showBreakeven });
                    
                    // Aplicar filtros seg√∫n la secci√≥n activa
                    if (currentFilterSection === 'dashboard') {
                        console.log('üîÑ Aplicando filtros a Dashboard');
                        dashboardFilters.symbol = symbol;
                        dashboardFilters.type = type;
                        dashboardFilters.result = result;
                        dashboardFilters.duration = duration;
                        dashboardFilters.day = day;
                        dashboardFilters.session = session;
                        dashboardFilters.plMin = plMin === '' ? null : parseFloat(plMin);
                        dashboardFilters.plMax = plMax === '' ? null : parseFloat(plMax);
                        dashboardFilters.showWins = showWins;
                        dashboardFilters.showLosses = showLosses;
                        dashboardFilters.showBreakeven = showBreakeven;
                        
                        // Cerrar sidebar primero
                        toggleFiltersSidebar();
                        
                        // Refresh con delay para asegurar que se ejecuta
                        setTimeout(() => {
                            console.log('‚úÖ Ejecutando refreshDashboard...');
                            refreshDashboard();
                        }, 100);
                        
                    } else if (currentFilterSection === 'informe') {
                        console.log('üîÑ Aplicando filtros a Informe');
                        informeFilters.symbol = symbol;
                        informeFilters.type = type;
                        informeFilters.result = result;
                        informeFilters.day = day;
                        informeFilters.plMin = plMin === '' ? null : parseFloat(plMin);
                        informeFilters.plMax = plMax === '' ? null : parseFloat(plMax);
                        
                        // Cerrar sidebar primero
                        toggleFiltersSidebar();
                        
                        // Refresh con delay
                        setTimeout(() => {
                            console.log('‚úÖ Ejecutando refreshActiveInformeSubTab...');
                            refreshActiveInformeSubTab();
                        }, 100);
                        
                    } else if (currentFilterSection === 'analytics') {
                        console.log('üîÑ Aplicando filtros a Analytics');
                        analyticsFilters.symbol = symbol;
                        analyticsFilters.type = type;
                        analyticsFilters.result = result;
                        analyticsFilters.duration = duration;
                        analyticsFilters.day = day;
                        analyticsFilters.session = session;
                        analyticsFilters.plMin = plMin === '' ? null : parseFloat(plMin);
                        analyticsFilters.plMax = plMax === '' ? null : parseFloat(plMax);
                        analyticsFilters.showWins = showWins;
                        analyticsFilters.showLosses = showLosses;
                        analyticsFilters.showBreakeven = showBreakeven;
                        
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            console.log('‚úÖ Ejecutando refreshAnalytics...');
                            refreshAnalytics();
                        }, 100);
                    } else if (currentFilterSection === 'calendar') {
                        console.log('üîÑ Aplicando filtros a Calendario');
                        // Aqu√≠ puedes agregar l√≥gica para Calendario si es necesario
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            updateCalendar();
                        }, 100);
                    }
                });
            }

            // Limpiar filtros del sidebar
            const sidebarClearBtn = document.getElementById('sidebar-clear-filters-btn');
            if (sidebarClearBtn) {
                sidebarClearBtn.addEventListener('click', () => {
                    console.log('üßπ Limpiando filtros del sidebar...');
                    
                    document.getElementById('sidebar-filter-symbol').value = '';
                    document.getElementById('sidebar-filter-type').value = 'all';
                    document.getElementById('sidebar-filter-result').value = 'all';
                    document.getElementById('sidebar-filter-duration').value = 'all';
                    document.getElementById('sidebar-filter-day').value = 'all';
                    document.getElementById('sidebar-filter-session').value = 'all';
                    document.getElementById('sidebar-filter-pl-min').value = '';
                    document.getElementById('sidebar-filter-pl-max').value = '';
                    document.getElementById('sidebar-show-wins').checked = true;
                    document.getElementById('sidebar-show-losses').checked = true;
                    document.getElementById('sidebar-show-breakeven').checked = true;
                    
                    // Resetear filtros seg√∫n la secci√≥n
                    if (currentFilterSection === 'dashboard') {
                        dashboardFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all', duration: 'all', session: 'all', showWins: true, showLosses: true, showBreakeven: true };
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            console.log('‚úÖ Limpiando Dashboard...');
                            refreshDashboard();
                        }, 100);
                    } else if (currentFilterSection === 'informe') {
                        informeFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all' };
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            console.log('‚úÖ Limpiando Informe...');
                            refreshActiveInformeSubTab();
                        }, 100);
                    } else if (currentFilterSection === 'analytics') {
                        analyticsFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all', duration: 'all', session: 'all', showWins: true, showLosses: true, showBreakeven: true };
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            console.log('‚úÖ Limpiando Analytics...');
                            refreshAnalytics();
                        }, 100);
                    } else {
                        toggleFiltersSidebar();
                        setTimeout(() => {
                            refreshCurrentSection();
                        }, 100);
                    }
                });
            }

            // Bot√≥n de descarga PDF
            const downloadBtn = document.getElementById('dashboard-download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => downloadSectionPDF('dashboard', 'Dashboard'));
            }
        }

        function refreshDashboard() {
            console.log('üîÑ refreshDashboard() iniciado');
            
            if (!document.getElementById('dashboard').classList.contains('active')) {
                console.log('‚ö†Ô∏è Dashboard no est√° activo, cancelando refresh');
                return;
            }
            
            const accountSelect = document.getElementById('dashboard-account-select');
            const currencySelect = document.getElementById('dashboard-currency-select');
            
            if (!accountSelect || !currencySelect) {
                console.log('‚ö†Ô∏è Selectores no encontrados');
                return;
            }
            
            const selectedAccount = accountSelect.value;
            const displayCurrency = currencySelect.value;

            console.log('üìä Dashboard - Cuenta seleccionada:', selectedAccount);
            console.log('üìÖ Dashboard - Filtro de fecha:', globalDateFilter);
            console.log('üéØ Dashboard - Filtros personalizados:', dashboardFilters);

            let operationsForMetrics = applyDateFilterToData(DB.operations);
            console.log('üìÖ Despu√©s de filtro de fecha:', operationsForMetrics.length, 'operaciones');

            if (selectedAccount !== 'all') {
                operationsForMetrics = operationsForMetrics.filter(op => op.accountId === selectedAccount);
                console.log('üë§ Despu√©s de filtro de cuenta:', operationsForMetrics.length, 'operaciones');
            }

            // Aplicar filtros de Dashboard
            operationsForMetrics = applyDashboardFilters(operationsForMetrics);
            console.log('üéØ Despu√©s de filtros personalizados:', operationsForMetrics.length, 'operaciones');

            const metrics = calculateMetrics(operationsForMetrics, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(operationsForMetrics, selectedAccount);
            const grossPL = metrics.totalWin + metrics.totalLoss;
            const netPL = grossPL - metrics.totalFees;
            
            console.log('‚úÖ Dashboard actualizado con', operationsForMetrics.length, 'operaciones');
            console.log('üí∞ P/L Bruto:', grossPL, '| P/L Neto:', netPL, '| Comisiones:', metrics.totalFees);

            const balanceEl = document.getElementById('current-balance');
            if (balanceEl) {
                balanceEl.textContent = formatCurrency(netPL, DB.settings.defaultCurrency, displayCurrency);
                balanceEl.className = `text-3xl font-bold ${netPL >= 0 ? 'text-green' : 'text-negative'}`;
            }

            const winRateEl = document.getElementById('win-rate');
            if (winRateEl) winRateEl.textContent = metrics.winRate.toFixed(0) + '%';
            
            const profitFactorEl = document.getElementById('profit-factor');
            if (profitFactorEl) profitFactorEl.textContent = isFinite(metrics.profitFactor) ? metrics.profitFactor.toFixed(2) : "‚àû";
            
            const totalTradesEl = document.getElementById('total-trades');
            if (totalTradesEl) totalTradesEl.textContent = metrics.totalTrades;

            // P&L Metrics - Nuevos elementos
            const plGrossEl = document.getElementById('dashboard-pl-gross');
            if (plGrossEl) {
                plGrossEl.textContent = formatCurrency(grossPL, DB.settings.defaultCurrency, displayCurrency);
                plGrossEl.className = `text-2xl font-bold hide-amount ${grossPL >= 0 ? 'text-green' : 'text-negative'}`;
            }
            
            const totalFeesEl = document.getElementById('dashboard-total-fees');
            if (totalFeesEl) {
                totalFeesEl.textContent = formatCurrency(metrics.totalFees, DB.settings.defaultCurrency, displayCurrency);
            }
            
            const plNetEl = document.getElementById('dashboard-pl-net');
            if (plNetEl) {
                plNetEl.textContent = formatCurrency(netPL, DB.settings.defaultCurrency, displayCurrency);
                plNetEl.className = `text-2xl font-bold hide-amount ${netPL >= 0 ? 'text-green' : 'text-negative'}`;
            }
            
            const totalOpsEl = document.getElementById('dashboard-total-operations');
            if (totalOpsEl) {
                totalOpsEl.textContent = metrics.totalTrades;
            }

            // Totals
            const totalWinEl = document.getElementById('dashboard-total-win');
            if (totalWinEl) totalWinEl.textContent = formatCurrency(metrics.totalWin, DB.settings.defaultCurrency, displayCurrency);
            const totalLossEl = document.getElementById('dashboard-total-loss');
            if (totalLossEl) totalLossEl.textContent = formatCurrency(metrics.totalLoss, DB.settings.defaultCurrency, displayCurrency);

            // Advanced metrics
            const avgWinEl = document.getElementById('dashboard-avg-win');
            if (avgWinEl) avgWinEl.textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);

            const avgLossEl = document.getElementById('dashboard-avg-loss');
            if (avgLossEl) avgLossEl.textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);

            const avgPlEl = document.getElementById('dashboard-avg-pl');
            if (avgPlEl) {
                avgPlEl.textContent = formatCurrency(advancedMetrics.avgPLPerTrade, DB.settings.defaultCurrency, displayCurrency);
                avgPlEl.className = `text-2xl font-bold ${advancedMetrics.avgPLPerTrade >= 0 ? 'text-white' : 'text-negative'}`;
            }

            const activeRangeButton = document.querySelector('#dashboard .time-range-btn.active');
            const timeRange = activeRangeButton ? activeRangeButton.dataset.range : 'ALL';

            let opsForEvolutionChart = applyDateFilterToData(DB.operations);
            if (selectedAccount !== 'all') {
                opsForEvolutionChart = opsForEvolutionChart.filter(op => op.accountId === selectedAccount);
            }
            updateAccountEvolutionChart(opsForEvolutionChart, selectedAccount, timeRange);

            updateDashboardRadarChart(operationsForMetrics, selectedAccount);
            updateInstrumentPerformanceChart(operationsForMetrics, 'instrument-performance-chart');
            updateDayPerformanceChart(operationsForMetrics, 'day-performance-chart');
            updateTypePerformanceChart(operationsForMetrics, 'type-performance-chart');

            // Update dashboard mini visuals solo si existen los elementos
            const sparklineChart = document.getElementById('dashboard-sparkline-chart');
            if (sparklineChart) updateDashboardSparkline(operationsForMetrics);
            
            const pfGauge = document.getElementById('dashboard-pf-gauge');
            if (pfGauge) updateDashboardPFGauge(metrics.profitFactor);
            
            const winCircle = document.getElementById('dashboard-win-circle');
            if (winCircle) updateDashboardWinDonut(metrics.winRate, metrics.winningTrades, metrics.losingTrades);
            
            const latestOpsTable = document.getElementById('latest-operations-table');
            if (latestOpsTable) updateLatestOperationsTable(operationsForMetrics);

            // Actualizar nuevos m√≥dulos
            updateLast7DaysCalendar(operationsForMetrics);
            updateRecentOperationsList(operationsForMetrics);

            // ROI - solo actualizar si el elemento existe
            const initialBalance = metrics.initialBalance || 0;
            const roiEl = document.getElementById('dashboard-roi');
            if (roiEl) {
                const roi = initialBalance > 0 ? (totalPL / initialBalance) * 100 : 0;
                roiEl.textContent = roi.toFixed(2) + '%';
                roiEl.className = roi >= 0 ? 'text-sm font-semibold text-success' : 'text-sm font-semibold text-danger';
            }
        }

        function updateLatestOperationsTable(operations) {
            const tableBody = document.getElementById('latest-operations-table');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            const latestOps = [...operations].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 6);

            if (latestOps.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-text-secondary py-4">No hay operaciones recientes.</td></tr>';
                return;
            }

            latestOps.forEach(op => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer';
                row.dataset.id = op.id;

                const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
                const typeClass = op.type === 'buy' ? 'text-positive' : 'text-negative';

                row.innerHTML = `
                    <td class="text-left font-semibold">${op.instrument}</td>
                    <td class="${plClass} text-right">${formatCurrency(op.pl, op.currency, op.currency)}</td>
                    <td class="${typeClass} text-center">${op.type === 'buy' ? 'Long' : 'Short'}</td>
                    <td class="text-right text-text-secondary">${formatDate(op.date)}</td>
                `;

                row.addEventListener('click', () => {
                    showOperationDetailPage(op.id);
                });

                tableBody.appendChild(row);
            });
        }

        // Funci√≥n para el calendario de √∫ltimos 7 d√≠as - dise√±o exacto seg√∫n imagen
        function updateLast7DaysCalendar(operations) {
            const container = document.getElementById('last-7-days-calendar');
            if (!container) return;

            try {
                container.innerHTML = '';

                // Obtener los √∫ltimos 7 d√≠as
                const today = new Date();
                const days = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    days.push(date);
                }

                days.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const dayOperations = operations.filter(op => op.date === dateStr);
                    const totalPL = dayOperations.reduce((sum, op) => sum + (op.pl || 0), 0);
                    const operationsCount = dayOperations.length;

                    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                    const dayName = dayNames[date.getDay()];
                    const dayNumber = date.getDate();

                    const dayCard = document.createElement('div');
                    dayCard.className = 'bg-surface border border-border rounded-lg p-4 text-center cursor-pointer transition-all duration-200 hover:border-gray-500';
                    
                    if (operationsCount > 0) {
                        if (totalPL > 0) {
                            dayCard.className += ' border-success hover:border-success';
                        } else {
                            dayCard.className += ' border-danger hover:border-danger';
                        }
                    }

                    const formattedPL = operationsCount > 0 ? `$${totalPL.toFixed(2)}` : '$0';
                    
                    dayCard.innerHTML = `
                        <div class="text-xs text-text-secondary mb-1">${dayName}</div>
                        <div class="text-2xl font-bold text-white mb-2">${dayNumber}</div>
                        <div class="text-sm ${totalPL > 0 ? 'text-positive' : totalPL < 0 ? 'text-negative' : 'text-text-secondary'} font-bold mb-1">
                            ${formattedPL}
                        </div>
                        <div class="text-xs text-text-secondary">${operationsCount} comercio${operationsCount === 1 ? '' : 's'}</div>
                    `;

                    if (operationsCount > 0) {
                        dayCard.addEventListener('click', () => {
                            try {
                                // Mostrar an√°lisis del d√≠a usando el modal existente
                                const dateStr = date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                                openAnalyticsDetailModal('date', dateStr, `D√≠a: ${dayName}`);
                            } catch (e) {
                                console.log('Error al mostrar an√°lisis del d√≠a:', e);
                            }
                        });
                    }

                    container.appendChild(dayCard);
                });
            } catch (error) {
                console.log('Error en updateLast7DaysCalendar:', error);
                container.innerHTML = '<div class="text-center text-gray-400 p-4">Error al cargar el calendario</div>';
            }
        }

        // Funci√≥n para operaciones recientes - dise√±o exacto seg√∫n imagen
        function updateRecentOperationsList(operations) {
            const container = document.getElementById('recent-operations-list');
            if (!container) return;

            try {
                const recentOps = [...operations]
                    .sort((a, b) => new Date(b.date + ' ' + (b.entryTime || '00:00')) - new Date(a.date + ' ' + (a.entryTime || '00:00')))
                    .slice(0, 3);

                if (recentOps.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-3 text-center py-8 text-gray-400">
                            <div class="text-2xl mb-2">üìä</div>
                            <div>No hay operaciones recientes detectadas</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recentOps.map((op, index) => {
                    const date = new Date(op.date);
                    const dayNames = ['Viernes', 'Martes', 'Lunes']; 
                    const dayName = dayNames[index] || date.toLocaleDateString('es-ES', { weekday: 'long' });
                    const formattedPL = `$${(op.pl || 0).toFixed(2)}`;
                    const chartId = `mini-chart-${op.id}`;
                    
                    return `
                        <div class="metric-card cursor-pointer transition-all duration-200 hover:bg-surface-light" onclick="try { showOperationDetailPage('${op.id}'); } catch(e) { console.log('Error:', e); }">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-white font-bold text-xl">${op.instrument || 'N/A'}</div>
                            </div>
                            <div class="mb-3">
                                <div class="text-xs text-text-secondary mb-1">${dayName} ${date.getDate()} de ${date.toLocaleDateString('es-ES', { month: 'long' })} de ${date.getFullYear()}</div>
                            </div>
                            <div class="h-20 mb-3 bg-surface rounded border border-border flex items-center justify-center">
                                <canvas id="${chartId}" width="200" height="80" class="w-full h-full"></canvas>
                            </div>
                            <div class="text-right">
                                <div class="${(op.pl || 0) >= 0 ? 'text-positive' : 'text-negative'} font-bold text-lg">
                                    ${formattedPL}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Generar mini gr√°ficos despu√©s de insertar HTML
                setTimeout(() => {
                    recentOps.forEach(op => {
                        generateMiniChartGreen(`mini-chart-${op.id}`, op);
                    });
                }, 50);

            } catch (error) {
                console.log('Error en updateRecentOperationsList:', error);
                container.innerHTML = '<div class="col-span-3 text-center text-gray-400 p-4">Error al cargar operaciones</div>';
            }
        }

        // Funci√≥n para generar mini gr√°fico con P/L real y escala de 0 al P/L final
        function generateMiniChartGreen(canvasId, operation) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);

            // Configurar datos del gr√°fico con P/L real
            const finalPL = operation.pl || 0;
            const points = 40;
            const data = [];
            
            // Generar progresi√≥n de P/L desde 0 hasta el valor final
            for (let i = 0; i < points; i++) {
                const progress = i / (points - 1);
                // Crear una progresi√≥n m√°s realista con fluctuaciones menores
                const baseProgress = progress * finalPL;
                const volatility = Math.sin(i * 0.5) * (Math.abs(finalPL) * 0.08);
                data.push(baseProgress + volatility);
            }

            // Asegurar que el √∫ltimo punto sea exactamente el P/L final
            data[data.length - 1] = finalPL;

            // Determinar colores seg√∫n P/L
            const lineColor = finalPL >= 0 ? '#39ff14' : '#ef4444'; // Verde fluorescente o rojo
            const fillColor = finalPL >= 0 ? 'rgba(57, 255, 20, 0.2)' : 'rgba(239, 68, 68, 0.2)';

            // Calcular escala desde 0 hasta el P/L (o desde P/L hasta 0 si es negativo)
            const maxValue = Math.max(0, finalPL, ...data);
            const minValue = Math.min(0, finalPL, ...data);
            const range = maxValue - minValue || 1;

            // Dibujar l√≠nea del gr√°fico
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2.5;
            ctx.beginPath();

            data.forEach((value, index) => {
                const x = (index / (points - 1)) * width;
                const y = height - ((value - minValue) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Rellenar √°rea bajo/sobre la l√≠nea base
            const zeroY = height - ((0 - minValue) / range) * height;
            ctx.fillStyle = fillColor;
            ctx.beginPath();
            
            // Recrear la l√≠nea para el relleno
            data.forEach((value, index) => {
                const x = (index / (points - 1)) * width;
                const y = height - ((value - minValue) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            // Completar el √°rea hacia la l√≠nea base (0)
            ctx.lineTo(width, zeroY);
            ctx.lineTo(0, zeroY);
            ctx.closePath();
            ctx.fill();

            // Dibujar l√≠nea base en 0
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, zeroY);
            ctx.lineTo(width, zeroY);
            ctx.stroke();
        }

        // Funci√≥n para generar mini gr√°fico de cada operaci√≥n
        function generateMiniChart(canvasId, operation) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);

            // Generar datos simulados para el mini gr√°fico (precio simulado)
            const points = 20;
            const basePrice = operation.entry || 1.0;
            const data = [];
            
            for (let i = 0; i < points; i++) {
                const variation = (Math.random() - 0.5) * 0.02; // ¬±1% de variaci√≥n
                const price = basePrice * (1 + variation * (i / points));
                data.push(price);
            }

            // Dibujar l√≠nea del gr√°fico
            const color = operation.pl >= 0 ? '#39ff14' : '#EF4444'; // Verde fluorescente o rojo
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            const minPrice = Math.min(...data);
            const maxPrice = Math.max(...data);
            const priceRange = maxPrice - minPrice || 1;

            data.forEach((price, index) => {
                const x = (index / (points - 1)) * width;
                const y = height - ((price - minPrice) / priceRange) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Rellenar √°rea bajo la curva con gradiente
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color + '40'); // 25% opacity
            gradient.addColorStop(1, color + '00'); // 0% opacity
            
            ctx.fillStyle = gradient;
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();
        }



        let dashboardSparklineChart = null;
        function updateDashboardSparkline(operations) {
            const canvas = document.getElementById('dashboard-sparkline-chart');
            if (!canvas) return;
            if (typeof Chart === 'undefined') return;

            const sorted = [...operations].sort((a,b) => new Date(a.date) - new Date(b.date));
            let cumulative = 0;
            const labels = [];
            const data = [];
            sorted.forEach(op => {
                const rawPL = op.manualPL ?? op.pl ?? 0;
                const plInDefault = op.currency && op.currency !== DB.settings.defaultCurrency ? convertCurrency(rawPL, op.currency, DB.settings.defaultCurrency) : rawPL;
                cumulative += plInDefault;
                labels.push(op.date);
                data.push(cumulative);
            });
            if (data.length === 0) { labels.push(new Date().toISOString().split('T')[0]); data.push(0); }

            if (dashboardSparklineChart) dashboardSparklineChart.destroy();

            const ctx = canvas.getContext('2d');
            dashboardSparklineChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data, borderColor: '#39ff14', backgroundColor: 'rgba(57,255,20,0.08)', borderWidth: 2, fill: true, pointRadius: 0, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { line: { tension: 0.3 } } }
            });
        }

        function updateDashboardPFGauge(pf) {
            const gaugeEl = document.getElementById('dashboard-pf-gauge');
            const pfEl = document.getElementById('profit-factor');
            if (gaugeEl) {
                let percentage = 0;
                if (pf >= 3) percentage = 100;
                else if (pf >= 2) percentage = 66 + (pf - 2) * 34;
                else if (pf >= 1) percentage = 33 + (pf - 1) * 33;
                else percentage = pf * 33;
                gaugeEl.style.width = Math.min(100, Math.max(0, percentage)) + '%';
            }
            if (pfEl) pfEl.textContent = isFinite(pf) ? pf.toFixed(2) : '‚àû';
        }

        function updateDashboardWinDonut(winRate, wins, losses) {
            const circleEl = document.getElementById('dashboard-win-circle');
            const textEl = document.getElementById('dashboard-win-text');
            const winsEl = document.getElementById('dashboard-wins');
            const lossesEl = document.getElementById('dashboard-losses');
            if (circleEl) {
                const dash = `${winRate.toFixed(0)}, 100`;
                circleEl.setAttribute('stroke-dasharray', dash);
                let color = '#ef4444';
                if (winRate >= 60) color = '#22c55e';
                else if (winRate >= 40) color = '#eab308';
                circleEl.setAttribute('stroke', color);
            }
            if (textEl) textEl.textContent = Math.round(winRate) + '%';
            if (winsEl) winsEl.textContent = wins;
            if (lossesEl) lossesEl.textContent = losses;
        }
        function calculateMetrics(operations, accountId = 'all') {
            console.log(`üî¢ [calculateMetrics] Calculando m√©tricas para ${operations.length} operaciones`);
            
            let currentBalance = 0;
            let initialBalance = 0;
            let accountCurrency = DB.settings.defaultCurrency;
            let totalWin = 0;
            let totalLoss = 0;
            let winningTrades = 0;
            let losingTrades = 0;
            let breakevenTrades = 0;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    currentBalance = account.balance;
                    initialBalance = account.initialBalance;
                    accountCurrency = account.currency;
                }
            } else {
                DB.accounts.forEach(account => {
                    let accBalance = account.balance;
                    let accInitialBalance = account.initialBalance;
                    if (account.currency !== DB.settings.defaultCurrency) {
                        accBalance = convertCurrency(accBalance, account.currency, DB.settings.defaultCurrency);
                        accInitialBalance = convertCurrency(accInitialBalance, account.currency, DB.settings.defaultCurrency);
                    }
                    currentBalance += accBalance;
                    initialBalance += accInitialBalance;
                });
                accountCurrency = DB.settings.defaultCurrency;
            }

            // AGRUPAR por ID para contar trades correctamente
            // pero SUMAR todo el P&L (parciales + √∫nicos)
            const groupedOps = {};
            
            operations.forEach(op => {
                const opId = op.id;
                
                // Crear grupo si no existe
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        id: opId,
                        totalPL: 0,
                        totalFees: 0,
                        currency: op.currency
                    };
                }
                
                // SUMAR el P&L de cada operaci√≥n (parciales incluidas)
                groupedOps[opId].totalPL += (op.pl || 0);
                // Soportar tanto 'fee' como 'fees'
                groupedOps[opId].totalFees += (op.fee || op.fees || 0);
            });

            const uniqueTradeGroups = Object.values(groupedOps);
            
            console.log(`üî¢ [calculateMetrics] Agrupadas en ${uniqueTradeGroups.length} trades √∫nicos`);
            console.log(`üî¢ [calculateMetrics] Muestra de IDs:`, uniqueTradeGroups.slice(0, 5).map(g => ({ id: g.id, pl: g.totalPL, fees: g.totalFees })));

            // Ahora calcular m√©tricas por TRADE COMPLETO
            // IMPORTANTE: Devolvemos P/L BRUTO (sin restar fees) para consistencia
            uniqueTradeGroups.forEach(group => {
                let plInDefaultCurrency = group.totalPL;
                
                if (group.currency !== DB.settings.defaultCurrency) {
                    plInDefaultCurrency = convertCurrency(group.totalPL, group.currency, DB.settings.defaultCurrency);
                }
                
                // Determinar resultado basado en P/L BRUTO del trade
                if (plInDefaultCurrency > 0) {
                    totalWin += plInDefaultCurrency;
                    winningTrades++;
                } else if (plInDefaultCurrency < 0) {
                    totalLoss += plInDefaultCurrency;
                    losingTrades++;
                } else {
                    breakevenTrades++;
                }
            });

            const totalTrades = uniqueTradeGroups.length;
            const relevantTradesForWinRate = winningTrades + losingTrades;
            const winRate = relevantTradesForWinRate > 0 ? (winningTrades / relevantTradesForWinRate) * 100 : 0;
            const profitFactor = Math.abs(totalLoss) > 0 ? Math.abs(totalWin / totalLoss) : (totalWin > 0 ? Infinity : 0);
            
            // Calcular total de fees en moneda por defecto
            let totalFeesInDefaultCurrency = 0;
            uniqueTradeGroups.forEach(group => {
                let feesConverted = group.totalFees;
                if (group.currency !== DB.settings.defaultCurrency) {
                    feesConverted = convertCurrency(group.totalFees, group.currency, DB.settings.defaultCurrency);
                }
                totalFeesInDefaultCurrency += feesConverted;
            });

            console.log(`üî¢ [calculateMetrics] Resultados:`);
            console.log(`   - P/L Bruto: ${totalWin + totalLoss}`);
            console.log(`   - Total Fees: ${totalFeesInDefaultCurrency}`);
            console.log(`   - P/L Neto: ${(totalWin + totalLoss) - totalFeesInDefaultCurrency}`);
            console.log(`   - Trades: ${totalTrades} (${winningTrades}W / ${losingTrades}L)`);
            
            return {
                currentBalance, initialBalance, accountCurrency,
                totalWin,
                totalLoss,
                totalFees: totalFeesInDefaultCurrency,
                winningTrades, losingTrades, breakevenTrades, totalTrades,
                winRate, profitFactor
            };
        }

        // Funci√≥n para calcular estad√≠sticas de d√≠as ganadores/perdedores
        function calculateDayWinStats(operations) {
            const dayTotals = {};
            
            operations.forEach(op => {
                const date = op.date;
                if (!dayTotals[date]) {
                    dayTotals[date] = 0;
                }
                dayTotals[date] += op.pl || 0;
            });

            const days = Object.values(dayTotals);
            const winningDays = days.filter(pl => pl > 0).length;
            const losingDays = days.filter(pl => pl < 0).length;
            const breakevenDays = days.filter(pl => pl === 0).length;
            const totalDays = days.length;

            const dayWinRate = totalDays > 0 ? (winningDays / totalDays) * 100 : 0;

            return {
                winningDays,
                losingDays,
                breakevenDays,
                totalDays,
                dayWinRate
            };
        }

        let accountEvolutionChart = null;
        function updateAccountEvolutionChart(allAccountOps, accountId, timeRange = 'ALL') {
            const ctx = document.getElementById('account-evolution-chart').getContext('2d');
            if (accountEvolutionChart) accountEvolutionChart.destroy();
            const currencySelect = document.getElementById('dashboard-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            chartOps = [...chartOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || "00:00:00")) - new Date(b.date + 'T' + (b.entryTime || "00:00:00")));

            let startingBalance = 0;
            let chartTargetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;
            let initialBalanceForPercentCalc = 0;

            const firstChartOpDate = chartOps.length > 0 ? chartOps[0].date : null;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    initialBalanceForPercentCalc = convertCurrency(account.initialBalance, account.currency, chartTargetCurrency);
                    startingBalance = convertCurrency(account.initialBalance, account.currency, chartTargetCurrency);

                    if (firstChartOpDate) {
                        const operationsBeforeFirstChartOp = DB.operations.filter(op =>
                        op.accountId === accountId &&
                            op.date < firstChartOpDate
                    );
                        operationsBeforeFirstChartOp.forEach(op => {
                            let pl = op.pl;
                            if (op.currency !== chartTargetCurrency) {
                                pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                            }
                            startingBalance += pl;
                        });
                    }
                }
            } else {
                startingBalance = DB.accounts.reduce((sum, acc) => {
                    let accEffectiveInitialBalance = acc.initialBalance;
                    if (acc.currency !== chartTargetCurrency) {
                        accEffectiveInitialBalance = convertCurrency(accEffectiveInitialBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + accEffectiveInitialBalance;
                }, 0);

                if (firstChartOpDate) {
                    const operationsBeforeFirstChartOp = DB.operations.filter(op => op.date < firstChartOpDate);
                    operationsBeforeFirstChartOp.forEach(op => startingBalance += convertCurrency(op.pl, op.currency, chartTargetCurrency));
                }

                initialBalanceForPercentCalc = DB.accounts.reduce((sum, acc) => {
                    let iBalance = acc.initialBalance;
                    if (acc.currency !== chartTargetCurrency) {
                        iBalance = convertCurrency(iBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + iBalance;
                }, 0);
            }

            const labels = ['Inicio'];
            const dataPoints = [startingBalance];
            chartOps.reduce((balance, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newBalance = balance + pl;
                dataPoints.push(newBalance);
                labels.push(formatDate(op.date));
                return newBalance;
            }, startingBalance);

            const finalData = displayCurrency === '%' && initialBalanceForPercentCalc !== 0
                ? dataPoints.map(val => ((val / initialBalanceForPercentCalc) * 100) - 100)
                : dataPoints;

            const yAxisFormatter = displayCurrency === '%'
                ? (val) => (val > 0 ? '+' : '') + val.toFixed(1) + '%'
                : (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency);

            accountEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Balance', data: finalData, borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: '#FFFFFF' }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Balance: ${yAxisFormatter(c.raw)}` } } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: yAxisFormatter }, zeroLineColor: '#2a2a2a' } } }
            });
        }

        let dashboardRadarChart = null;
        function updateDashboardRadarChart(operations, accountId, chartId = 'dashboard-radar-chart') {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            // Destruir el gr√°fico existente basado en el ID del canvas
            if (chartId === 'dashboard-radar-chart' && dashboardRadarChart) {
                dashboardRadarChart.destroy();
            } else if (chartId === 'analytics-detail-radar-chart' && window.analyticsDetailRadarChart) {
                window.analyticsDetailRadarChart.destroy();
            }

            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);

            let maxDrawdownPercentage = 0;
            if (operations.length > 0) {
                const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                let accountInitialBalance = 0;
                let accountCurrency = DB.settings.defaultCurrency;

                if (accountId !== 'all') {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) {
                        accountInitialBalance = account.initialBalance;
                        accountCurrency = account.currency;
                    }
                } else {
                    accountInitialBalance = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency), 0);
                }

                if (accountInitialBalance > 0) {
                    let peakBalance = accountInitialBalance;
                    let maxDrawdownValue = 0;
                    let currentBalance = accountInitialBalance;
                    sortedOps.forEach(op => {
                        let pl = convertCurrency(op.pl, op.currency, accountCurrency);
                        currentBalance += pl;
                        if (currentBalance > peakBalance) peakBalance = currentBalance;
                        const drawdown = peakBalance - currentBalance;
                        if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
                    });
                    maxDrawdownPercentage = (maxDrawdownValue / accountInitialBalance) * 100;
                }
            }


            const winRateScore = basicMetrics.winRate || 0;
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3, 1) * 100; // PF of 3.0 is 100%
            const avgWLRatio = advancedMetrics.avgWin && advancedMetrics.avgLoss ? Math.abs(advancedMetrics.avgWin / advancedMetrics.avgLoss) : 0;
            const avgWLRatioScore = Math.min(avgWLRatio / 3, 1) * 100; // Ratio of 3.0 is 100%
            const drawdownScore = Math.max(0, (1 - Math.min(maxDrawdownPercentage / 20, 1)) * 100); // 20% DD is 0 score

            let consistencyScore = 0;
            if (operations.length > 1) {
                const tradingDays = new Set(operations.map(op => op.date));
                if (tradingDays.size > 0) {
                    const dailyPL = {};
                    operations.forEach(op => {
                        if (!dailyPL[op.date]) dailyPL[op.date] = 0;
                        const plInDefaultCurrency = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        const feesInDefaultCurrency = convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
                        dailyPL[op.date] += plInDefaultCurrency - feesInDefaultCurrency;
                    });
                    const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
                    consistencyScore = (winningDays / tradingDays.size) * 100;
                }
            }

            const radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Profit Factor', 'Avg Win/Loss', 'Drawdown Ctrl', 'Consistencia'],
                    datasets: [{
                        label: 'Puntuaci√≥n',
                        data: [winRateScore, profitFactorScore, avgWLRatioScore, drawdownScore, consistencyScore],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: 'rgba(57, 255, 20, 0.8)',
                        pointBackgroundColor: 'var(--primary)',
                        pointBorderColor: '#0a0a0a',
                        pointHoverBackgroundColor: '#FFFFFF',
                        pointHoverBorderColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            angleLines: { color: '#2a2a2a' },
                            grid: { color: '#2a2a2a' },
                            pointLabels: { color: '#FFFFFF', font: { size: 11 } },
                            ticks: { display: false, stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Asignar la nueva instancia de gr√°fico a la variable correcta
            if (chartId === 'dashboard-radar-chart') {
                dashboardRadarChart = radarChart;
            } else if (chartId === 'analytics-detail-radar-chart') {
                window.analyticsDetailRadarChart = radarChart;
            }
        }

        let instrumentPerformanceChart = null;
        let analyticsInstrumentPerformanceChart = null;
        function updateInstrumentPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (chartId === 'instrument-performance-chart' && instrumentPerformanceChart) instrumentPerformanceChart.destroy();
            if (chartId === 'analytics-instrument-performance-chart' && analyticsInstrumentPerformanceChart) analyticsInstrumentPerformanceChart.destroy();
            if (chartId === 'analytics-detail-instrument-chart' && window.analyticsDetailInstrumentChart) window.analyticsDetailInstrumentChart.destroy();

            const performance = {};
            operations.forEach(op => {
                // Validar que el instrumento existe
                if (!op.instrument || typeof op.instrument !== 'string') {
                    console.warn('Operaci√≥n con instrumento inv√°lido encontrada:', op);
                    return;
                }
                const instrumentKey = op.instrument.toUpperCase();
                if (!performance[instrumentKey]) performance[instrumentKey] = { total: 0 };
                const plInDefaultCurrency = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                const feesInDefaultCurrency = convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
                performance[instrumentKey].total += plInDefaultCurrency - feesInDefaultCurrency;
            });
            const sorted = Object.entries(performance).sort((a, b) => b[1].total - a[1].total).slice(0, 10);
            const chart = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1].total), backgroundColor: sorted.map(item => item[1].total >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)') }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }, y: { grid: { display: false }, ticks: { color: '#FFFFFF' } } } } });

            if (chartId === 'instrument-performance-chart') instrumentPerformanceChart = chart;
            else if (chartId === 'analytics-instrument-performance-chart') analyticsInstrumentPerformanceChart = chart;
            else if (chartId === 'analytics-detail-instrument-chart') window.analyticsDetailInstrumentChart = chart;

        }

        let dayPerformanceChart = null;
        function updateDayPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (dayPerformanceChart) dayPerformanceChart.destroy();
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const performance = Array(7).fill(0);
            operations.forEach(op => {
                if (!isValidOperation(op)) return;
                const day = new Date(op.date + 'T00:00:00').getUTCDay();
                const plInDefaultCurrency = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                const feesInDefaultCurrency = convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
                performance[day] += plInDefaultCurrency - feesInDefaultCurrency;
            });
            dayPerformanceChart = new Chart(ctx, { type: 'bar', data: { labels: days, datasets: [{ data: performance, backgroundColor: performance.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)') }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } } } } });
        }

        let typePerformanceChart = null;
        function updateTypePerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (chartId === 'type-performance-chart' && typePerformanceChart) typePerformanceChart.destroy();
            if (chartId === 'analytics-detail-long-short-chart' && window.analyticsDetailLongShortChart) window.analyticsDetailLongShortChart.destroy();


            const calcPL = (type, result) => operations
                .filter(op => op.type === type && op.result === result)
                .reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);

            const buyWin = calcPL('buy', 'win');
            const buyLoss = calcPL('buy', 'loss');
            const sellWin = calcPL('sell', 'win');
            const sellLoss = calcPL('sell', 'loss');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Compra (Long)', 'Venta (Short)'],
                    datasets: [
                        {
                            label: 'Ganancias',
                            data: [buyWin, sellWin],
                            backgroundColor: 'rgba(57, 255, 20, 0.7)'
                        },
                        {
                            label: 'P√©rdidas',
                            data: [buyLoss, sellLoss],
                            backgroundColor: 'rgba(255, 65, 54, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0a0a0' } } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { color: '#FFFFFF' } },
                        y: { stacked: true, grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }
                    }
                }
            });

            if (chartId === 'type-performance-chart') typePerformanceChart = chart;
            else if (chartId === 'analytics-detail-long-short-chart') window.analyticsDetailLongShortChart = chart;

        }

        let financesEvolutionChart = null;
        function updateFinancesEvolutionChart(entries) {
            const ctx = document.getElementById('finances-evolution-chart').getContext('2d');
            if (financesEvolutionChart) financesEvolutionChart.destroy();

            const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
            const chartTargetCurrency = DB.settings.defaultCurrency;

            const labels = ['Inicio'];
            const dataPoints = [0];
            let currentBalance = 0;

            sortedEntries.forEach(entry => {
                let amountInTargetCurrency = entry.amount;
                if (entry.currency !== chartTargetCurrency) {
                    amountInTargetCurrency = convertCurrency(entry.amount, entry.currency, chartTargetCurrency);
                }
                currentBalance += amountInTargetCurrency;
                dataPoints.push(currentBalance);
                labels.push(formatDate(entry.date));
            });

            const yAxisFormatter = (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency);

            financesEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Balance en ${chartTargetCurrency}`,
                        data: dataPoints,
                        borderColor: '#FFFFFF',
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Balance: ${yAxisFormatter(ctx.raw)}` } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#FFFFFF' } },
                        y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: yAxisFormatter } }
                    }
                }
            });
        }

        // Gr√°fica de Flujo de Caja Mensual
        let financesCashflowChart = null;
        function updateFinancesCashflowChart(financeEntries, tradeOperations) {
            const canvas = document.getElementById('finances-cashflow-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (financesCashflowChart) financesCashflowChart.destroy();

            const targetCurrency = DB.settings.defaultCurrency;
            
            // Agrupar por mes
            const monthlyData = {};
            
            // Procesar movimientos financieros manuales
            financeEntries.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expenses: 0, trading: 0 };
                }
                
                const amount = convertCurrency(entry.amount, entry.currency, targetCurrency);
                if (amount > 0) {
                    monthlyData[monthKey].income += amount;
                } else {
                    monthlyData[monthKey].expenses += Math.abs(amount);
                }
            });
            
            // Procesar operaciones de trading
            tradeOperations.forEach(op => {
                const date = new Date(op.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expenses: 0, trading: 0 };
                }
                
                const pl = convertCurrency(op.pl, op.currency, targetCurrency);
                monthlyData[monthKey].trading += pl;
            });
            
            // Ordenar por fecha
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            const incomeData = sortedMonths.map(key => monthlyData[key].income);
            const expensesData = sortedMonths.map(key => monthlyData[key].expenses);
            const tradingData = sortedMonths.map(key => monthlyData[key].trading);
            
            financesCashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Trading P&L',
                            data: tradingData,
                            backgroundColor: 'rgba(41, 98, 255, 0.7)',
                            borderColor: '#2962ff',
                            borderWidth: 1
                        },
                        {
                            label: 'Ingresos Manuales',
                            data: incomeData,
                            backgroundColor: 'rgba(57, 255, 20, 0.7)',
                            borderColor: '#39ff14',
                            borderWidth: 1
                        },
                        {
                            label: 'Gastos',
                            data: expensesData,
                            backgroundColor: 'rgba(255, 65, 54, 0.7)',
                            borderColor: '#ff4136',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#a0a0a0', font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw, targetCurrency, targetCurrency)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0a0a0' }
                        },
                        y: {
                            grid: { color: '#2a2a2a' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (val) => formatCurrency(val, targetCurrency, targetCurrency)
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fica de Profit vs Expenses
        let financesProfitExpensesChart = null;
        function updateFinancesProfitExpensesChart(financeEntries, tradeOperations) {
            const canvas = document.getElementById('finances-profit-expenses-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (financesProfitExpensesChart) financesProfitExpensesChart.destroy();

            const targetCurrency = DB.settings.defaultCurrency;
            
            // Calcular totales
            const tradingMetrics = calculateMetrics(tradeOperations, 'all');
            const tradingProfit = tradingMetrics.totalWin + tradingMetrics.totalLoss;
            
            let manualIncome = 0;
            let totalExpenses = 0;
            
            financeEntries.forEach(entry => {
                const amount = convertCurrency(entry.amount, entry.currency, targetCurrency);
                if (amount > 0) {
                    manualIncome += amount;
                } else {
                    totalExpenses += Math.abs(amount);
                }
            });
            
            const totalProfit = tradingProfit + manualIncome;
            const netBalance = totalProfit - totalExpenses;
            
            financesProfitExpensesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Trading P&L', 'Ingresos Manuales', 'Gastos Totales', 'Balance Neto'],
                    datasets: [{
                        data: [tradingProfit, manualIncome, totalExpenses, netBalance],
                        backgroundColor: [
                            tradingProfit >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)',
                            'rgba(57, 255, 20, 0.7)',
                            'rgba(255, 65, 54, 0.7)',
                            netBalance >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'
                        ],
                        borderColor: [
                            tradingProfit >= 0 ? '#39ff14' : '#ff4136',
                            '#39ff14',
                            '#ff4136',
                            netBalance >= 0 ? '#39ff14' : '#ff4136'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.raw, targetCurrency, targetCurrency)
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#a0a0a0',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: '#2a2a2a' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (val) => formatCurrency(val, targetCurrency, targetCurrency)
                            }
                        }
                    }
                }
            });
        }

        let weeklyTrendChart = null;
        function updateWeeklyTrendChart(weekOperationsData, baseCurrency, initialBalanceForPercent) {
            const ctx = document.getElementById('weekly-trend-chart').getContext('2d'); if (weeklyTrendChart) weeklyTrendChart.destroy();

            const sortedWeeks = Object.values(weekOperationsData).sort((a, b) => parseInt(a.weekNumber) - parseInt(b.weekNumber));
            const labels = sortedWeeks.map(week => 'Sem ' + week.weekNumber);
            const dataPL = sortedWeeks.map(week => week.totalPL);
            const dataTrades = sortedWeeks.map(week => week.count);
            const currencyMode = document.getElementById('calendar-currency-select') ? document.getElementById('calendar-currency-select').value : 'USD';

            weeklyTrendChart = new Chart(ctx, {
                 type: 'bar', data: { labels: labels, datasets: [{ label: 'P&L', data: dataPL, backgroundColor: dataPL.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'), yAxisID: 'y' }, { label: 'Operaciones', data: dataTrades, type: 'line', fill: false, borderColor: '#a0a0a0', borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#a0a0a0', yAxisID: 'y1' }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, tooltip: { enabled: DB.settings.showTooltips, callbacks: { label: (ctx) => { if (ctx.dataset.label === 'P&L') { let fPL; if (currencyMode === '%') { const p = initialBalanceForPercent > 0 ? (ctx.raw / initialBalanceForPercent) * 100 : 0; fPL = p.toFixed(2) + '%'; } else { fPL = formatCurrency(ctx.raw, baseCurrency, currencyMode); } return 'P&L: ' + fPL; } else { return 'Operaciones: ' + ctx.raw; } } } } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF' } }, y: { position: 'left', grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: (val) => { if (currencyMode === '%') { const p = initialBalanceForPercent > 0 ? (val / initialBalanceForPercent) * 100 : 0; return p.toFixed(1) + '%'; } else { return formatCurrency(val, baseCurrency, currencyMode); } } } }, y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#a0a0a0', stepSize: 1 }, min: 0 } } }
            });
        }

        let accountDetailChart = null;
        function updateAccountDetailChart(account, allAccountOps, timeRange = 'ALL') {
            const ctx = document.getElementById('account-detail-chart').getContext('2d');
            if (accountDetailChart) accountDetailChart.destroy();
            const chartTargetCurrency = account.currency;

            const startDateString = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
             if (startDateString) {
                 chartOps = allAccountOps.filter(op => op.date >= startDateString);
             }
            chartOps = [...chartOps].sort((a, b) => new Date(a.date + 'T00:00:00Z') - new Date(b.date + 'T00:00:00Z'));

            let startingBalance = account.initialBalance;
            if (startDateString) {
                const opsBeforeRange = DB.operations.filter(op =>
                    op.accountId === account.id && op.date < startDateString
                );
                opsBeforeRange.forEach(op => {
                    let pl = op.pl;
                    if (op.currency !== chartTargetCurrency) {
                        pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                    }
                    startingBalance += pl;
                });
            }

            const labels = ['Inicio'];
            const data = [startingBalance];
            let currentBalance = startingBalance;
            chartOps.forEach(op => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                currentBalance += pl; data.push(currentBalance); labels.push(formatDate(op.date));
            });
            accountDetailChart = new Chart(ctx, {
                type: 'line', data: { labels: labels, datasets: [{ label: 'Balance', data: data, borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { tooltip: { enabled: DB.settings.showTooltips, callbacks: { title: (ctx) => ctx[0].label, label: (ctx) => 'Balance: ' + formatCurrency(ctx.raw, chartTargetCurrency, chartTargetCurrency) } }, legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF'} }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) } } } }
            });
        }

        function getLocalDateString(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            if (!(date instanceof Date) || isNaN(date)) {
                date = new Date();
            }

            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        function calculateAdvancedMetrics(operations, accountId = 'all') {
            // Usar solo operaciones principales para m√©tricas avanzadas
            const mainOps = operations.filter(op => !op.parentId || op.parentId === '' || op.parentId === null);
            const metrics = calculateMetrics(operations, accountId);
            let totalPLInDefault = metrics.totalWin + metrics.totalLoss;
            const totalTrades = metrics.totalTrades;
            const totalWin = metrics.totalWin;
            const totalLoss = metrics.totalLoss;
            const winningTrades = metrics.winningTrades;
            const losingTrades = metrics.losingTrades;
            const initialBalance = metrics.initialBalance || 0;
            // --- Basic averages ---
            const avgWin = winningTrades > 0 ? totalWin / winningTrades : 0;
            const avgLoss = losingTrades > 0 ? totalLoss / losingTrades : 0;
            const avgPLPerTrade = totalTrades > 0 ? totalPLInDefault / totalTrades : 0;
            // --- Percentages ---
            const avgPLPercentage = initialBalance > 0 ? (avgPLPerTrade / initialBalance) * 100 : 0;
            const avgWinPercentage = initialBalance > 0 ? (avgWin / initialBalance) * 100 : 0;
            const avgLossPercentage = initialBalance > 0 ? (avgLoss / initialBalance) * 100 : 0;
            const totalWinPercentage = initialBalance > 0 ? (totalWin / initialBalance) * 100 : 0;
            const totalLossPercentage = initialBalance > 0 ? (totalLoss / initialBalance) * 100 : 0;
            // --- Per day/month/year ---
            const opsByDay = {};
            const opsByMonth = {};
            const opsByYear = {};
            operations.forEach(op => {
                const day = op.date;
                const month = op.date.substring(0,7);
                const year = op.date.substring(0,4);
                if (!opsByDay[day]) opsByDay[day] = [];
                if (!opsByMonth[month]) opsByMonth[month] = [];
                if (!opsByYear[year]) opsByYear[year] = [];
                opsByDay[day].push(op);
                opsByMonth[month].push(op);
                opsByYear[year].push(op);
            });
            // --- Averages per day/month/year ---
            const avgPLPerDay = Object.values(opsByDay).length > 0 ? Object.values(opsByDay).reduce((sum, arr) => sum + arr.reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByDay).length : 0;
            const avgPLPerMonth = Object.values(opsByMonth).length > 0 ? Object.values(opsByMonth).reduce((sum, arr) => sum + arr.reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByMonth).length : 0;
            const avgPLPerYear = Object.values(opsByYear).length > 0 ? Object.values(opsByYear).reduce((sum, arr) => sum + arr.reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByYear).length : 0;
            // --- Win/Loss per day/month/year ---
            const avgWinPerDay = Object.values(opsByDay).length > 0 ? Object.values(opsByDay).reduce((sum, arr) => sum + arr.filter(o => o.result === 'win').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByDay).length : 0;
            const avgWinPerMonth = Object.values(opsByMonth).length > 0 ? Object.values(opsByMonth).reduce((sum, arr) => sum + arr.filter(o => o.result === 'win').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByMonth).length : 0;
            const avgWinPerYear = Object.values(opsByYear).length > 0 ? Object.values(opsByYear).reduce((sum, arr) => sum + arr.filter(o => o.result === 'win').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByYear).length : 0;
            const avgLossPerDay = Object.values(opsByDay).length > 0 ? Object.values(opsByDay).reduce((sum, arr) => sum + arr.filter(o => o.result === 'loss').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByDay).length : 0;
            const avgLossPerMonth = Object.values(opsByMonth).length > 0 ? Object.values(opsByMonth).reduce((sum, arr) => sum + arr.filter(o => o.result === 'loss').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByMonth).length : 0;
            const avgLossPerYear = Object.values(opsByYear).length > 0 ? Object.values(opsByYear).reduce((sum, arr) => sum + arr.filter(o => o.result === 'loss').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0), 0) / Object.values(opsByYear).length : 0;
            // --- Best/Worst per trade/day ---
            let largestWin = 0, largestLoss = 0, largestWinPerDay = 0, largestLossPerDay = 0;
            Object.values(opsByDay).forEach(arr => {
                const dayWin = arr.filter(o => o.result === 'win').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0);
                const dayLoss = arr.filter(o => o.result === 'loss').reduce((s, o) => s + convertCurrency(o.pl, o.currency, DB.settings.defaultCurrency), 0);
                if (dayWin > largestWinPerDay) largestWinPerDay = dayWin;
                if (dayLoss < largestLossPerDay) largestLossPerDay = dayLoss;
            });
            operations.forEach(op => {
                let plInDefault = op.pl;
                if (op.currency !== DB.settings.defaultCurrency) {
                    plInDefault = convertCurrency(plInDefault, op.currency, DB.settings.defaultCurrency);
                }
                if (op.result === 'win' && plInDefault > largestWin) largestWin = plInDefault;
                if (op.result === 'loss' && plInDefault < largestLoss) largestLoss = plInDefault;
            });
            // --- Streaks ---
            let longestWinStreak = 0;
            let currentWinStreak = 0;
            let longestLossStreak = 0;
            let currentLossStreak = 0;
            const sortedOpsByDate = [...operations].sort((a,b) => new Date(a.date + 'T00:00:00Z') - new Date(b.date + 'T00:00:00Z'));
            sortedOpsByDate.forEach(op => {
                if (op.result === 'win') {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    if (currentWinStreak > longestWinStreak) longestWinStreak = currentWinStreak;
                } else if (op.result === 'loss') {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    if (currentLossStreak > longestLossStreak) longestLossStreak = currentLossStreak;
                } else {
                    currentWinStreak = 0;
                    currentLossStreak = 0;
                }
            });
            // --- Last day/week/month/year metrics ---
            const today = getLocalDateString(new Date());
            const lastDayPL = operations.filter(op => op.date === today).reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const lastWeekStart = getLocalDateString(new Date(new Date().setDate(new Date().getDate() - 7)));
            const lastWeekPL = operations.filter(op => op.date >= lastWeekStart && op.date <= today).reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const lastMonthStart = getLocalDateString(new Date(new Date().setMonth(new Date().getMonth() - 1)));
            const lastMonthPL = operations.filter(op => op.date >= lastMonthStart && op.date <= today).reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const lastYearStart = getLocalDateString(new Date(new Date().setFullYear(new Date().getFullYear() - 1)));
            const lastYearPL = operations.filter(op => op.date >= lastYearStart && op.date <= today).reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);

            return {
                avgWin, avgLoss, avgPLPerTrade, expectancy: ((metrics.winRate / 100) * avgWin) - (((winningTrades + losingTrades) > 0 ? losingTrades / (winningTrades + losingTrades) : 0) * Math.abs(avgLoss)),
                largestWin, largestLoss,
                longestWinStreak, longestLossStreak,
                avgPLPercentage, avgWinPercentage, avgLossPercentage, totalWinPercentage, totalLossPercentage,
                avgPLPerDay, avgPLPerMonth, avgPLPerYear,
                avgWinPerDay, avgWinPerMonth, avgWinPerYear,
                avgLossPerDay, avgLossPerMonth, avgLossPerYear,
                largestWinPerDay, largestLossPerDay,
                lastDayPL, lastWeekPL, lastMonthPL, lastYearPL
            };
        }

        function calculateExtraAnalytics(operations, accountId = 'all') {
            const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));

            // --- Max Drawdown Calculation ---
            let initialBalanceForDD = 0;
            let currencyForDD = DB.settings.defaultCurrency;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    initialBalanceForDD = account.initialBalance;
                    currencyForDD = account.currency;
                }
            } else {
                initialBalanceForDD = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, currencyForDD), 0);
            }

            let peakBalance = initialBalanceForDD;
            let maxDrawdownValue = 0;
            let currentBalance = initialBalanceForDD;
            sortedOps.forEach(op => {
                let pl = convertCurrency(op.pl, op.currency, currencyForDD);
                currentBalance += pl;
                if (currentBalance > peakBalance) peakBalance = currentBalance;
                const drawdown = peakBalance - currentBalance;
                if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
            });
            const maxDrawdownPercentage = initialBalanceForDD > 0 ? (maxDrawdownValue / initialBalanceForDD) * 100 : 0;

            // --- Average Holding Time ---
            let totalDurationMinutes = 0, tradesWithDuration = 0;
            operations.forEach(op => {
                if (op.entryTime && op.exitTime) {
                    try {
                        const startDate = new Date(`1970-01-01T${op.entryTime}`);
                        const endDate = new Date(`1970-01-01T${op.exitTime}`);
                        let duration = (endDate - startDate) / 60000;
                        if (duration < 0) duration += 24 * 60; // Overnight
                        totalDurationMinutes += duration;
                        tradesWithDuration++;
                    } catch (e) { /* ignore */ }
                }
            });
            let avgHoldTimeText = 'N/A';
            if (tradesWithDuration > 0) {
                const avgMinutes = totalDurationMinutes / tradesWithDuration;
                if (avgMinutes < 1) avgHoldTimeText = `${(avgMinutes * 60).toFixed(0)} seg`;
                else if (avgMinutes < 60) avgHoldTimeText = `${avgMinutes.toFixed(0)} min`;
                else avgHoldTimeText = `${Math.floor(avgMinutes / 60)}h ${Math.round(avgMinutes % 60)}m`;
            }

            // --- Standard Deviation of P/L ---
            let stdDevPL = 0;
            if (operations.length > 1) {
                const plsInDefaultCurrency = operations.map(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency));
                const mean = plsInDefaultCurrency.reduce((sum, val) => sum + val, 0) / plsInDefaultCurrency.length;
                const variance = plsInDefaultCurrency.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / plsInDefaultCurrency.length;
                stdDevPL = Math.sqrt(variance);
            }

            // --- Average Win/Loss Ratio ---
            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetricsForRatio = calculateAdvancedMetrics(operations, accountId);
            const avgWLRatio = Math.abs(advancedMetricsForRatio.avgLoss) > 0 ? Math.abs(advancedMetricsForRatio.avgWin / advancedMetricsForRatio.avgLoss) : (advancedMetricsForRatio.avgWin > 0 ? Infinity : 0);

            return {
                maxDrawdownValue, maxDrawdownPercentage, currencyForDD,
                avgHoldTimeText,
                stdDevPL,
                avgWLRatio
            };
        }

        function formatDurationText(minutes) {
            // Validar que minutes sea un n√∫mero v√°lido
            if (typeof minutes !== 'number' || isNaN(minutes) || minutes < 0) {
                return 'N/A';
            }
            
            if (minutes < 1) return `${(minutes * 60).toFixed(0)} seg`;
            if (minutes < 60) return `${minutes.toFixed(0)} min`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}h ${Math.round(minutes % 60)}m`;
            const days = Math.floor(minutes / 1440);
            const hours = Math.floor((minutes % 1440) / 60);
            return `${days}d ${hours}h`;
        }

        function calculateProfessionalMetrics(operations, accountId = 'all') {
            if (!operations || operations.length === 0) {
                return {
                    expectancyRatio: 0, kellyCriterion: 0, sharpeRatio: 0, sortinoRatio: 0,
                    calmarRatio: 0, recoveryFactor: 0, riskOfRuin: 0, zScore: 0,
                    avgMAE: 0, avgMFE: 0, maxWinStreak: 0, maxLossStreak: 0,
                    consistencyScore: 0, payoffRatio: 0, totalTradingDays: 0, avgRMultiple: 0
                };
            }

            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);
            
            // Expectancy Ratio = (Win% * AvgWin) - (Loss% * AvgLoss)
            const winRate = basicMetrics.winRate / 100;
            const lossRate = 1 - winRate;
            const expectancyRatio = (winRate * advancedMetrics.avgWin) + (lossRate * advancedMetrics.avgLoss);
            
            // Kelly Criterion = (Win% * AvgWin - Loss% * AvgLoss) / AvgWin
            const kellyCriterion = Math.abs(advancedMetrics.avgWin) > 0 
                ? ((winRate * Math.abs(advancedMetrics.avgWin) - lossRate * Math.abs(advancedMetrics.avgLoss)) / Math.abs(advancedMetrics.avgWin)) * 100
                : 0;
            
            // Sharpe Ratio = (Average Return - Risk Free Rate) / Std Dev of Returns
            const plArray = operations.map(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency));
            const avgReturn = plArray.reduce((sum, pl) => sum + pl, 0) / plArray.length;
            const variance = plArray.reduce((sum, pl) => sum + Math.pow(pl - avgReturn, 2), 0) / plArray.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev) * Math.sqrt(252) : 0; // Annualized
            
            // Sortino Ratio = Average Return / Downside Deviation
            const downsideReturns = plArray.filter(pl => pl < 0);
            const downsideVariance = downsideReturns.length > 0 
                ? downsideReturns.reduce((sum, pl) => sum + Math.pow(pl, 2), 0) / downsideReturns.length 
                : 0;
            const downsideDeviation = Math.sqrt(downsideVariance);
            const sortinoRatio = downsideDeviation > 0 ? (avgReturn / downsideDeviation) * Math.sqrt(252) : 0;
            
            // Max Drawdown for Calmar and Recovery
            const extraMetrics = calculateExtraAnalytics(operations, accountId);
            const maxDrawdown = extraMetrics.maxDrawdownValue;
            
            // Calmar Ratio = Annualized Return / Max Drawdown
            const totalDays = operations.length > 0 ? 
                (new Date(operations[operations.length - 1].date) - new Date(operations[0].date)) / (1000 * 60 * 60 * 24) : 1;
            const annualizedReturn = totalDays > 0 ? (basicMetrics.totalWin + basicMetrics.totalLoss) * (365 / totalDays) : 0;
            const calmarRatio = maxDrawdown > 0 ? annualizedReturn / maxDrawdown : 0;
            
            // Recovery Factor = Net Profit / Max Drawdown
            const recoveryFactor = maxDrawdown > 0 ? (basicMetrics.totalWin + basicMetrics.totalLoss) / maxDrawdown : 0;
            
            // Risk of Ruin (simplified formula)
            const payoffRatio = Math.abs(advancedMetrics.avgLoss) > 0 ? Math.abs(advancedMetrics.avgWin / advancedMetrics.avgLoss) : 1;
            const riskOfRuin = winRate > 0.5 ? Math.pow((1 - winRate) / winRate, payoffRatio) * 100 : 100;
            
            // Z-Score (streak consistency)
            let runs = 0, lastResult = null;
            operations.forEach(op => {
                if (op.result !== lastResult && lastResult !== null) runs++;
                lastResult = op.result;
            });
            const N = operations.length;
            const W = operations.filter(op => op.result === 'win').length;
            const L = N - W;
            const expectedRuns = W > 0 && L > 0 ? (2 * W * L) / N + 1 : runs;
            const variance_runs = W > 0 && L > 0 ? (2 * W * L * (2 * W * L - N)) / (N * N * (N - 1)) : 0;
            const stdDev_runs = Math.sqrt(variance_runs);
            const zScore = stdDev_runs > 0 ? (runs - expectedRuns) / stdDev_runs : 0;
            
            // MAE/MFE (simplified - usando drawdown como proxy)
            const avgMAE = maxDrawdown / operations.length;
            const avgMFE = Math.abs(advancedMetrics.largestWin) / 2; // Simplified
            
            // Max Win/Loss Streaks
            let currentWinStreak = 0, maxWinStreak = 0;
            let currentLossStreak = 0, maxLossStreak = 0;
            operations.forEach(op => {
                if (op.result === 'win') {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else if (op.result === 'loss') {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                }
            });
            
            // Consistency Score (0-100)
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3 * 40, 40);
            const winRateScore = Math.min(basicMetrics.winRate / 70 * 30, 30);
            const streakScore = maxLossStreak > 0 ? Math.max(30 - (maxLossStreak / 10 * 30), 0) : 30;
            const consistencyScore = Math.round(profitFactorScore + winRateScore + streakScore);
            
            // Total Trading Days
            const uniqueDays = [...new Set(operations.map(op => op.date))].length;
            
            // Average R-Multiple (simplified)
            const avgRMultiple = payoffRatio * winRate - (1 - winRate);
            
            return {
                expectancyRatio,
                kellyCriterion: Math.max(-100, Math.min(100, kellyCriterion)),
                sharpeRatio,
                sortinoRatio,
                calmarRatio,
                recoveryFactor,
                riskOfRuin: Math.min(100, Math.max(0, riskOfRuin)),
                zScore,
                avgMAE,
                avgMFE,
                maxWinStreak,
                maxLossStreak,
                consistencyScore,
                payoffRatio,
                totalTradingDays: uniqueDays,
                avgRMultiple
            };
        }

        function calculateTimeMetrics(operations) {
            let winDurations = [];
            let lossDurations = [];
            let hourlyPerformance = Array(24).fill(0).map(() => ({ pl: 0, count: 0 }));
            
            operations.forEach(op => {
                // Calculate trade duration
                if (op.entryTime && op.exitTime) {
                    try {
                        // Usar la fecha de la operaci√≥n para el c√°lculo completo
                        const opDate = op.date || '2024-01-01';
                        const startDateTime = new Date(`${opDate}T${op.entryTime}`);
                        const endDateTime = new Date(`${opDate}T${op.exitTime}`);
                        
                        // Verificar si las fechas son v√°lidas
                        if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                            // Silenciar warning - muchas operaciones no tienen tiempos v√°lidos
                            return;
                        }
                        
                        let duration = (endDateTime - startDateTime) / 60000; // minutes
                        
                        // Si la duraci√≥n es negativa, puede ser que la operaci√≥n cruz√≥ la medianoche
                        if (duration < 0) {
                            duration += 24 * 60; // Ajuste para operaciones overnight
                        }
                        
                        // Validar que la duraci√≥n sea razonable (mayor a 0 y menos de 7 d√≠as)
                        // Silenciar warnings para duraciones de 0 o fuera de rango
                        if (duration > 0 && duration < 10080) { // 10080 minutos = 7 d√≠as
                            if (op.result === 'win') {
                                winDurations.push(duration);
                            } else if (op.result === 'loss') {
                                lossDurations.push(duration);
                            }
                        }
                    } catch (e) { 
                        // Silenciar errores de c√°lculo de duraci√≥n
                    }
                }
                
                // Calculate hourly performance
                if (op.entryTime) {
                    try {
                        const hour = parseInt(op.entryTime.split(':')[0], 10);
                        if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                            const plInDefault = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                            hourlyPerformance[hour].pl += plInDefault;
                            hourlyPerformance[hour].count++;
                        }
                    } catch (e) { /* ignore invalid time */ }
                }
            });
            
            // Calculate averages
            const avgWinDuration = winDurations.length > 0 
                ? winDurations.reduce((sum, d) => sum + d, 0) / winDurations.length 
                : 0;
            const avgLossDuration = lossDurations.length > 0 
                ? lossDurations.reduce((sum, d) => sum + d, 0) / lossDurations.length 
                : 0;
            
            // Find best and worst hours
            let bestHour = -1;
            let bestHourPL = -Infinity;
            let worstHour = -1;
            let worstHourPL = Infinity;
            
            hourlyPerformance.forEach((data, hour) => {
                if (data.count > 0) {
                    if (data.pl > bestHourPL) {
                        bestHourPL = data.pl;
                        bestHour = hour;
                    }
                    if (data.pl < worstHourPL) {
                        worstHourPL = data.pl;
                        worstHour = hour;
                    }
                }
            });
            
            // Find longest win/loss and fastest win
            const longestWinDuration = winDurations.length > 0 ? Math.max(...winDurations) : 0;
            const longestLossDuration = lossDurations.length > 0 ? Math.max(...lossDurations) : 0;
            const fastestWin = winDurations.length > 0 ? Math.min(...winDurations) : 0;
            
            return {
                avgWinDuration,
                avgLossDuration,
                bestHour,
                worstHour,
                bestHourPL,
                worstHourPL,
                longestWinDuration,
                longestLossDuration,
                fastestWin,
                hasWins: winDurations.length > 0,
                hasLosses: lossDurations.length > 0
            };
        }


        function initAnalytics() {
            updateAccountSelect('analytics-account-select');
            refreshAnalytics();
            
            const accountSelect = document.getElementById('analytics-account-select');
            if (accountSelect) {
                accountSelect.addEventListener('change', function() {
                    const selectedAccount = this.value;
                    syncAccountSelection(selectedAccount); // Sincronizar con todas las secciones
                    updateSelectorLogo('analytics-account-select');
                    refreshAnalytics();
                });
            }
            
            // Selector de moneda Analytics
            const currencySelect = document.getElementById('analytics-currency-select');
            if (currencySelect) {
                currencySelect.addEventListener('change', refreshAnalytics);
            }

            // Bot√≥n de filtros
            const filtersBtn = document.getElementById('analytics-filters-btn');
            if (filtersBtn) {
                filtersBtn.addEventListener('click', () => {
                    currentFilterSection = 'analytics';
                    toggleFiltersSidebar();
                });
            }

            // Bot√≥n de descarga
            const downloadBtn = document.getElementById('analytics-download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => downloadSectionPDF('analytics', 'Analytics'));
            }
            
            // NUEVO: Listeners para el modal de detalles
            const closeBtn = document.getElementById('analytics-detail-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeAnalyticsDetailModal);
            }
            
            const modal = document.getElementById('analytics-detail-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'analytics-detail-modal') {
                        closeAnalyticsDetailModal();
                    }
                });
            }
        }

        function initInforme() {
            updateAccountSelect('informe-account-select');
            
            // Selector de moneda Informe
            const currencySelect = document.getElementById('informe-currency-select');
            if (currencySelect) {
                currencySelect.addEventListener('change', () => {
                    refreshActiveInformeSubTab();
                });
            }

            // Bot√≥n de filtros
            const filtersBtn = document.getElementById('informe-filters-btn');
            if (filtersBtn) {
                filtersBtn.addEventListener('click', () => {
                    currentFilterSection = 'informe';
                    toggleFiltersSidebar();
                });
            }

            // Bot√≥n de descarga
            const downloadBtn = document.getElementById('informe-download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => downloadSectionPDF('informe', 'Informe'));
            }

            const toggleFiltersBtn = document.getElementById('informe-toggle-filters-btn');
            const filtersPanel = document.getElementById('informe-filters-panel');
            const applyFiltersBtn = document.getElementById('informe-apply-filters-btn');
            const clearFiltersBtn = document.getElementById('informe-clear-filters-btn');

            if (toggleFiltersBtn && filtersPanel) {
                toggleFiltersBtn.addEventListener('click', () => {
                    filtersPanel.classList.toggle('hidden');
                });
            }

            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                informeFilters.symbol = document.getElementById('informe-filter-symbol').value.toUpperCase();
                informeFilters.type = document.getElementById('informe-filter-type').value;
                informeFilters.result = document.getElementById('informe-filter-result').value;
                const plMin = document.getElementById('informe-filter-pl-min').value;
                const plMax = document.getElementById('informe-filter-pl-max').value;
                informeFilters.plMin = plMin === '' ? null : parseFloat(plMin);
                informeFilters.plMax = plMax === '' ? null : parseFloat(plMax);
                informeFilters.day = document.getElementById('informe-filter-day').value;

                refreshActiveInformeSubTab();
                });
            }

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    document.getElementById('informe-filter-symbol').value = '';
                    document.getElementById('informe-filter-type').value = 'all';
                    document.getElementById('informe-filter-result').value = 'all';
                    document.getElementById('informe-filter-pl-min').value = '';
                    document.getElementById('informe-filter-pl-max').value = '';
                    document.getElementById('informe-filter-day').value = 'all';

                    informeFilters = { symbol: '', type: 'all', result: 'all', plMin: null, plMax: null, day: 'all' };
                    refreshActiveInformeSubTab();
                });
            }

            const informeSubTabs = document.querySelectorAll('.informe-sub-tab');
            const informeSubSections = document.querySelectorAll('.informe-sub-section-container');

            informeSubTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    informeSubTabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = 'var(--text-secondary)';
                        t.style.borderBottomColor = 'transparent';
                        t.style.fontWeight = 'normal';
                    });
                    informeSubSections.forEach(s => s.classList.remove('active'));

                    tab.classList.add('active');
                    tab.style.color = 'var(--text)'; // Active tab text color
                    tab.style.borderBottomColor = 'var(--primary)';
                    tab.style.fontWeight = '600';

                    const targetId = tab.dataset.target;
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }

                    switch (targetId) {
                        case 'informe-informes-content':
                            refreshInforme();
                            break; // Refresh main informe metrics
                        case 'informe-metricas-content':
                            refreshMetricas();
                            break; // Refresh new metrics tab
                        case 'informe-metricas-avanzadas-content':
                            refreshMetricasAvanzadas();
                            break; // Refresh advanced metrics tab
                        case 'informe-simbolos-content':
                            refreshSimbolos();
                            break; // Refresh symbols tab
                        case 'informe-tiempo-content':
                            refreshTiempo();
                            break; // Refresh time metrics tab
                        case 'informe-graficos-content':
                            setTimeout(() => window.refreshGraficosCharts && window.refreshGraficosCharts(), 50);
                            break;
                    }
                });
            });

            document.getElementById('informe-account-select').addEventListener('change', function() {
                const selectedAccount = this.value;
                console.log('=== ACCOUNT CHANGED === [EVENT LISTENER #1]', selectedAccount);
                
                // Actualizar cuenta global SIN sincronizar (para evitar loop infinito)
                globalSelectedAccount = selectedAccount;
                
                // Sincronizar con OTRAS secciones solamente (no dispara change en informe-account-select)
                const selectors = [
                    'dashboard-account-select',
                    'analytics-account-select',
                    'daily-journal-account-select',
                    'calendar-account-select',
                    'equity-account-select',
                    'filter-account',
                    'chartbook-account-select'
                ];
                
                selectors.forEach(selectorId => {
                    const selectElement = document.getElementById(selectorId);
                    if (selectElement && selectElement.value !== selectedAccount) {
                        selectElement.value = selectedAccount;
                        updateSelectorLogo(selectorId);
                    }
                });
                
                updateSelectorLogo('informe-account-select');
                const activeSubTab = document.querySelector('.informe-sub-tab.active');
                if (activeSubTab) {
                    const targetId = activeSubTab.dataset.target;
                    console.log('Active sub-tab:', targetId);
                    switch (targetId) {
                        case 'informe-informes-content':
                            console.log('Calling refreshInforme()...');
                            setTimeout(() => refreshInforme(), 50);
                            break; // Refresh main informe metrics
                        case 'informe-metricas-content':
                            setTimeout(() => refreshMetricas(), 50);
                            break; // Refresh new metrics tab
                        case 'informe-metricas-avanzadas-content':
                            setTimeout(() => refreshMetricasAvanzadas(), 50);
                            break; // Refresh advanced metrics tab
                        case 'informe-simbolos-content':
                            setTimeout(() => refreshSimbolos(), 50);
                            break; // Refresh symbols tab
                        case 'informe-tiempo-content':
                            setTimeout(() => refreshTiempo(), 50);
                            break; // Refresh time metrics tab
                        case 'informe-graficos-content':
                            setTimeout(() => window.refreshGraficosCharts && window.refreshGraficosCharts(), 50);
                            break;
                        case 'informe-comisiones-content':
                            if (typeof window.refreshComisiones === 'function') {
                                window.refreshComisiones();
                            }
                            break; // Refresh commissions tab
                    }
                } else {
                    refreshInforme();
                }
            });

            // Add listener for date filter changes within the Informe tab
            document.getElementById('informe-date-filter-btn').addEventListener('click', function() {
                // The date range modal logic is global, but after it applies a filter,
                // we need to ensure the correct sub-tab refreshes.
                // The `updateGlobalDateFilter` function already calls `refreshAllViews`,
                // which in turn calls `refreshInforme` if the main tab is active.
                // The `refreshInforme` function will then delegate to the correct sub-tab refresh function.
                // So, no extra logic is needed here, but it's good to confirm the flow.
                // The main date range modal listener will handle opening the modal.
            });


        }

        let informeMetricasEvolutionChart = null;
        let informeMetricasRadarChart = null;
        let informeMetricasPositionSizeChart = null;
        let informeMetricasPlByRiskChart = null;
        let informeMetricasCapitalEffChart = null;
        let informeMetricasRRComparisonChart = null;

        function refreshMetricas() {
            console.log('[M√©tricas] üîÑ Refreshing...');
            const dataView = document.getElementById('informe-metricas-data-view');
            const noDataView = document.getElementById('informe-metricas-no-data');
            if (!dataView || !noDataView) return;

            const selectedAccount = document.getElementById('informe-account-select').value;
            const currencySelect = document.getElementById('informe-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';

            console.log('[M√©tricas] Selected account:', selectedAccount);
            let operations = applyDateFilterToData(DB.operations);
            console.log('[M√©tricas] Operations after date filter:', operations.length);
            if (selectedAccount !== 'all') {
                operations = operations.filter(op => op.accountId === selectedAccount);
            }
            console.log('[M√©tricas] Operations after account filter:', operations.length);
            operations = applyInformeFilters(operations);
            console.log('[M√©tricas] Operations after additional filters:', operations.length);

            if (operations.length === 0) {
                dataView.style.display = 'none';
                noDataView.style.display = 'block';
                return;
            }

            dataView.style.display = 'block';
            noDataView.style.display = 'none';

            // Destruir charts anteriores
            if (informeMetricasPositionSizeChart) { informeMetricasPositionSizeChart.destroy(); informeMetricasPositionSizeChart = null; }
            if (informeMetricasPlByRiskChart) { informeMetricasPlByRiskChart.destroy(); informeMetricasPlByRiskChart = null; }
            if (informeMetricasCapitalEffChart) { informeMetricasCapitalEffChart.destroy(); informeMetricasCapitalEffChart = null; }
            if (informeMetricasRRComparisonChart) { informeMetricasRRComparisonChart.destroy(); informeMetricasRRComparisonChart = null; }

            const basicMetrics = calculateMetrics(operations, selectedAccount);

            // Trades by Day/Month/Year
            const dailyTrades = {};
            const monthlyTrades = {};
            const yearlyTrades = {};
            operations.forEach(op => {
                const day = op.date;
                const month = op.date.substring(0, 7);
                const year = op.date.substring(0, 4);
                dailyTrades[day] = (dailyTrades[day] || 0) + 1;
                monthlyTrades[month] = (monthlyTrades[month] || 0) + 1;
                yearlyTrades[year] = (yearlyTrades[year] || 0) + 1;
            });

            const totalTradingDays = Object.keys(dailyTrades).length;
            const totalTradingMonths = Object.keys(monthlyTrades).length;
            const totalTradingYears = Object.keys(yearlyTrades).length;

            const avgTradesPerDay = totalTradingDays > 0 ? operations.length / totalTradingDays : 0;
            const avgTradesPerMonth = totalTradingMonths > 0 ? operations.length / totalTradingMonths : 0;
            const avgTradesPerYear = totalTradingYears > 0 ? operations.length / totalTradingYears : 0;

            const maxTradesPerDay = totalTradingDays > 0 ? Math.max(...Object.values(dailyTrades)) : 0;
            const maxTradesPerMonth = totalTradingMonths > 0 ? Math.max(...Object.values(monthlyTrades)) : 0;
            const maxTradesPerYear = totalTradingYears > 0 ? Math.max(...Object.values(yearlyTrades)) : 0;

            // Winning/Losing Days
            const dailyPL = {};
            operations.forEach(op => {
                const date = op.date;
                if (!dailyPL[date]) dailyPL[date] = 0;
                dailyPL[date] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
            });
            const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
            const losingDays = Object.values(dailyPL).filter(pl => pl < 0).length;
            const totalDaysOperated = winningDays + losingDays; // Assuming breakeven days are not counted as winning/losing

            // Long/Short Trades
            const longTradesCount = operations.filter(op => op.type === 'buy').length;
            const shortTradesCount = operations.filter(op => op.type === 'sell').length;

            // Update UI for Metrics
            const updateMetric = (id, value, isPercent = false, total = 1) => {
                const el = document.getElementById(id);
                if (el) {
                    if (isPercent) {
                        el.textContent = `${(total > 0 ? (value / total) * 100 : 0).toFixed(2)}%`;
                    } else {
                        if (Number.isInteger(value)) {
                            el.textContent = value.toLocaleString();
                        } else {
                            el.textContent = value.toFixed(2);
                        }
                    }
                }
            };

            document.getElementById('informe-metricas-total-trades').textContent = basicMetrics.totalTrades;
            console.log('[M√©tricas] ‚úÖ Updated total-trades to:', basicMetrics.totalTrades);

            document.getElementById('informe-metricas-winning-trades').textContent = basicMetrics.winningTrades;
            updateMetric('informe-metricas-winning-trades-percent', basicMetrics.winningTrades, true, basicMetrics.totalTrades);
            console.log('[M√©tricas] ‚úÖ Updated winning-trades to:', basicMetrics.winningTrades);

            document.getElementById('informe-metricas-losing-trades').textContent = basicMetrics.losingTrades;
            updateMetric('informe-metricas-losing-trades-percent', basicMetrics.losingTrades, true, basicMetrics.totalTrades);

            document.getElementById('informe-metricas-breakeven-trades').textContent = basicMetrics.breakevenTrades;
            updateMetric('informe-metricas-breakeven-trades-percent', basicMetrics.breakevenTrades, true, basicMetrics.totalTrades);

            document.getElementById('informe-metricas-long-trades').textContent = longTradesCount;
            updateMetric('informe-metricas-long-trades-percent', longTradesCount, true, basicMetrics.totalTrades);

            document.getElementById('informe-metricas-short-trades').textContent = shortTradesCount;
            updateMetric('informe-metricas-short-trades-percent', shortTradesCount, true, basicMetrics.totalTrades);

            document.getElementById('informe-metricas-winning-days').textContent = winningDays;
            updateMetric('informe-metricas-winning-days-percent', winningDays, true, totalDaysOperated);

            document.getElementById('informe-metricas-losing-days').textContent = losingDays;
            updateMetric('informe-metricas-losing-days-percent', losingDays, true, totalDaysOperated);

            document.getElementById('informe-metricas-avg-trades-day').textContent = avgTradesPerDay.toFixed(2);
            document.getElementById('informe-metricas-avg-trades-month').textContent = avgTradesPerMonth.toFixed(2);
            document.getElementById('informe-metricas-avg-trades-year').textContent = avgTradesPerYear.toFixed(2);

            document.getElementById('informe-metricas-max-trades-day').textContent = maxTradesPerDay;
            document.getElementById('informe-metricas-max-trades-month').textContent = maxTradesPerMonth;
            document.getElementById('informe-metricas-max-trades-year').textContent = maxTradesPerYear;

            // ===== ACTUALIZAR BARRAS DE DISTRIBUCI√ìN WIN/LOSS =====
            const mainOps = operations.filter(op => !op.parentId || op.parentId === '' || op.parentId === null);
            
            const winOps = mainOps.filter(op => op.result === 'win');
            const lossOps = mainOps.filter(op => op.result === 'loss');
            const breakevenOps = mainOps.filter(op => op.result === 'breakeven' || (!op.result && op.pl === 0));
            const totalOps = mainOps.length;
            
            const winCount = winOps.length;
            const lossCount = lossOps.length;
            const breakevenCount = breakevenOps.length;
            
            const winPercentage = totalOps > 0 ? (winCount / totalOps * 100) : 0;
            const lossPercentage = totalOps > 0 ? (lossCount / totalOps * 100) : 0;
            const breakevenPercentage = totalOps > 0 ? (breakevenCount / totalOps * 100) : 0;
            
            const totalWinAmount = winOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const totalLossAmount = lossOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            
            // Actualizar contadores y barras
            const winCountBarEl = document.getElementById('informe-win-count-bar');
            if (winCountBarEl) winCountBarEl.textContent = `${winCount} (${winPercentage.toFixed(1)}%)`;
            
            const lossCountBarEl = document.getElementById('informe-loss-count-bar');
            if (lossCountBarEl) lossCountBarEl.textContent = `${lossCount} (${lossPercentage.toFixed(1)}%)`;
            
            const breakevenCountBarEl = document.getElementById('informe-breakeven-count-bar');
            if (breakevenCountBarEl) breakevenCountBarEl.textContent = `${breakevenCount} (${breakevenPercentage.toFixed(1)}%)`;
            
            // Actualizar anchos de barras
            const winBarEl = document.getElementById('informe-win-bar');
            if (winBarEl) {
                winBarEl.style.width = `${winPercentage}%`;
                const winAmountEl = document.getElementById('informe-win-amount-bar');
                if (winAmountEl) winAmountEl.textContent = formatCurrency(totalWinAmount, DB.settings.defaultCurrency, displayCurrency);
            }
            
            const lossBarEl = document.getElementById('informe-loss-bar');
            if (lossBarEl) {
                lossBarEl.style.width = `${lossPercentage}%`;
                const lossAmountEl = document.getElementById('informe-loss-amount-bar');
                if (lossAmountEl) lossAmountEl.textContent = formatCurrency(totalLossAmount, DB.settings.defaultCurrency, displayCurrency);
            }
            
            const breakevenBarEl = document.getElementById('informe-breakeven-bar');
            if (breakevenBarEl) {
                breakevenBarEl.style.width = `${breakevenPercentage}%`;
                const breakevenCountText = document.getElementById('informe-breakeven-count-text');
                if (breakevenCountText) breakevenCountText.textContent = breakevenCount;
            }
            
            // Actualizar m√©tricas complementarias
            const winLossRatio = lossCount > 0 ? winCount / lossCount : winCount;
            const winLossRatioEl = document.getElementById('informe-win-loss-ratio-bar');
            if (winLossRatioEl) {
                winLossRatioEl.textContent = winLossRatio.toFixed(2);
                winLossRatioEl.classList.remove('text-positive', 'text-negative', 'text-neutral', 'text-primary', 'text-white');
                winLossRatioEl.classList.add(winLossRatio >= 1 ? 'text-positive' : 'text-negative');
            }
            
            // Expectativa matem√°tica: (Win% √ó AvgWin) - (Loss% √ó AvgLoss)
            const avgWinAmount = winCount > 0 ? totalWinAmount / winCount : 0;
            const avgLossAmount = lossCount > 0 ? Math.abs(totalLossAmount / lossCount) : 0;
            const mathExpectancy = (winPercentage / 100 * avgWinAmount) - (lossPercentage / 100 * avgLossAmount);
            
            const mathExpectancyEl = document.getElementById('informe-math-expectancy-bar');
            if (mathExpectancyEl) {
                mathExpectancyEl.textContent = formatCurrency(mathExpectancy, DB.settings.defaultCurrency, displayCurrency);
                mathExpectancyEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                mathExpectancyEl.classList.add(mathExpectancy > 0 ? 'text-positive' : mathExpectancy < 0 ? 'text-negative' : 'text-neutral');
            }

            // Render Charts
            const activeRangeButton = document.querySelector('#informe-metricas-content .time-range-btn.active');
            const timeRange = activeRangeButton ? activeRangeButton.dataset.range : 'ALL';
            updateInformeMetricasEvolutionChart(operations, selectedAccount, timeRange);
            updateInformeMetricasRadarChart(operations, selectedAccount);
            
            // Actualizar nuevos gr√°ficos
            updateReduccionAcumuladaChart(operations, selectedAccount, timeRange);
            updatePnLAcumuladoChart(operations, selectedAccount, timeRange);
            updateCuentasDailyPnLChart(operations, selectedAccount);
            updateCuentasDailyWinLossChart(operations, selectedAccount);
            
            // ===== NUEVAS M√âTRICAS DE GESTI√ìN DE RIESGO =====
            updateRiskManagementMetrics(operations, selectedAccount, displayCurrency);
        }
        
        // Nueva funci√≥n para Gesti√≥n de Riesgo
        function updateRiskManagementMetrics(operations, selectedAccount, displayCurrency) {
            // Calcular tama√±o promedio de posici√≥n
            const volumes = operations.map(op => op.volume || 0).filter(v => v > 0);
            const avgPositionSize = volumes.length > 0 ? volumes.reduce((a,b) => a+b, 0) / volumes.length : 0;
            
            // Calcular riesgo promedio por trade (si existe el campo riskPercent o calcularlo)
            let totalRisk = 0;
            let riskCount = 0;
            operations.forEach(op => {
                if (op.stopLoss && op.entryPrice) {
                    const riskPerUnit = Math.abs(op.entryPrice - op.stopLoss);
                    const volume = op.volume || 1;
                    const accountSize = 10000; // Valor por defecto, deber√≠a venir de la cuenta
                    if (selectedAccount !== 'all') {
                        const acc = DB.accounts.find(a => a.id === selectedAccount);
                        if (acc) accountSize = acc.initialBalance;
                    }
                    const riskAmount = riskPerUnit * volume;
                    const riskPercent = (riskAmount / accountSize) * 100;
                    totalRisk += riskPercent;
                    riskCount++;
                }
            });
            const avgRiskPercent = riskCount > 0 ? totalRisk / riskCount : 0;
            
            // Calcular R:R Realizado
            const winOps = operations.filter(op => op.result === 'win');
            const lossOps = operations.filter(op => op.result === 'loss');
            let totalRRRealized = 0;
            let rrCount = 0;
            
            operations.forEach(op => {
                if (op.stopLoss && op.entryPrice && op.pl) {
                    const riskPerUnit = Math.abs(op.entryPrice - op.stopLoss);
                    const volume = op.volume || 1;
                    const riskAmount = riskPerUnit * volume;
                    if (riskAmount > 0) {
                        const rrRatio = Math.abs(op.pl) / riskAmount;
                        totalRRRealized += rrRatio;
                        rrCount++;
                    }
                }
            });
            const avgRRRealized = rrCount > 0 ? totalRRRealized / rrCount : 0;
            
            // Capital utilizado promedio (estimado como % del balance)
            const avgCapitalUsage = avgPositionSize > 0 ? Math.min((avgPositionSize * 100), 100) : 0;
            
            // Actualizar m√©tricas en UI
            const el1 = document.getElementById('informe-metricas-avg-position-size');
            if (el1) el1.textContent = avgPositionSize.toFixed(2);
            
            const el2 = document.getElementById('informe-metricas-avg-risk-percent');
            if (el2) el2.textContent = avgRiskPercent.toFixed(2) + '%';
            
            const el3 = document.getElementById('informe-metricas-avg-rr-realized');
            if (el3) el3.textContent = avgRRRealized.toFixed(2);
            
            const el4 = document.getElementById('informe-metricas-capital-usage');
            if (el4) el4.textContent = avgCapitalUsage.toFixed(2) + '%';
            
            // Gr√°fica 1: Distribuci√≥n de Tama√±o de Posici√≥n
            const positionSizeCtx = document.getElementById('informe-metricas-position-size-distribution-chart')?.getContext('2d');
            if (positionSizeCtx) {
                const ranges = [0.01, 0.1, 0.5, 1, 2, 5, 10, Infinity];
                const rangeLabels = ['<0.01', '0.01-0.1', '0.1-0.5', '0.5-1', '1-2', '2-5', '5-10', '>10'];
                const rangeCounts = Array(rangeLabels.length).fill(0);
                
                volumes.forEach(vol => {
                    for (let i = 0; i < ranges.length; i++) {
                        if (vol < ranges[i]) {
                            rangeCounts[i]++;
                            break;
                        }
                    }
                });
                
                informeMetricasPositionSizeChart = new Chart(positionSizeCtx, {
                    type: 'bar',
                    data: {
                        labels: rangeLabels,
                        datasets: [{
                            label: 'N√∫mero de Trades',
                            data: rangeCounts,
                            backgroundColor: 'rgba(59,130,246,0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', stepSize: 1 } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 2: P/L por Nivel de Riesgo
            const plByRiskCtx = document.getElementById('informe-metricas-pl-by-risk-chart')?.getContext('2d');
            if (plByRiskCtx) {
                const riskRanges = {'<1%': [], '1-2%': [], '2-3%': [], '3-5%': [], '>5%': []};
                
                operations.forEach(op => {
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    
                    // Si tiene stopLoss y entryPrice, calcular riesgo real
                    if (op.stopLoss && op.entryPrice && op.volume) {
                        const riskPerUnit = Math.abs(op.entryPrice - op.stopLoss);
                        const volume = op.volume;
                        const accountSize = 10000; // Default, idealmente usar balance real
                        const riskAmount = riskPerUnit * volume;
                        const riskPercent = (riskAmount / accountSize) * 100;
                        
                        if (riskPercent < 1) riskRanges['<1%'].push(pl);
                        else if (riskPercent < 2) riskRanges['1-2%'].push(pl);
                        else if (riskPercent < 3) riskRanges['2-3%'].push(pl);
                        else if (riskPercent < 5) riskRanges['3-5%'].push(pl);
                        else riskRanges['>5%'].push(pl);
                    } else {
                        // Si no hay datos de riesgo, clasificar por volumen
                        const vol = op.volume || 0.1;
                        if (vol < 0.5) riskRanges['<1%'].push(pl);
                        else if (vol < 1) riskRanges['1-2%'].push(pl);
                        else if (vol < 2) riskRanges['2-3%'].push(pl);
                        else if (vol < 5) riskRanges['3-5%'].push(pl);
                        else riskRanges['>5%'].push(pl);
                    }
                });
                
                const labels = Object.keys(riskRanges);
                const avgPL = labels.map(label => {
                    const arr = riskRanges[label];
                    return arr.length > 0 ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
                });
                const counts = labels.map(label => riskRanges[label].length);
                
                informeMetricasPlByRiskChart = new Chart(plByRiskCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P/L Promedio',
                            data: avgPL,
                            backgroundColor: avgPL.map(pl => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `P/L: $${ctx.parsed.y.toFixed(2)} (${counts[ctx.dataIndex]} trades)`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { color: '#a0a0a0' } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 3: R:R Realizado vs Planificado (simulado con promedio)
            const rrComparisonCtx = document.getElementById('informe-metricas-rr-comparison-chart')?.getContext('2d');
            if (rrComparisonCtx) {
                const rrPlanned = 2; // Valor por defecto
                const rrActual = avgRRRealized;
                
                informeMetricasRRComparisonChart = new Chart(rrComparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: ['R:R Planificado', 'R:R Realizado'],
                        datasets: [{
                            label: 'Ratio',
                            data: [rrPlanned, rrActual],
                            backgroundColor: ['rgba(59,130,246,0.7)', rrActual >= rrPlanned ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 4: Rendimiento por Capital Utilizado
            const capitalEffCtx = document.getElementById('informe-metricas-capital-efficiency-chart')?.getContext('2d');
            if (capitalEffCtx) {
                const capitalRanges = {'<25%': 0, '25-50%': 0, '50-75%': 0, '>75%': 0};
                const capitalCounts = {'<25%': 0, '25-50%': 0, '50-75%': 0, '>75%': 0};
                
                operations.forEach(op => {
                    const volume = op.volume || 0;
                    const capitalUsed = Math.min((volume * 100), 100);
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    
                    if (capitalUsed < 25) { capitalRanges['<25%'] += pl; capitalCounts['<25%']++; }
                    else if (capitalUsed < 50) { capitalRanges['25-50%'] += pl; capitalCounts['25-50%']++; }
                    else if (capitalUsed < 75) { capitalRanges['50-75%'] += pl; capitalCounts['50-75%']++; }
                    else { capitalRanges['>75%'] += pl; capitalCounts['>75%']++; }
                });
                
                const labels = Object.keys(capitalRanges);
                const avgPL = labels.map(label => capitalCounts[label] > 0 ? capitalRanges[label] / capitalCounts[label] : 0);
                
                informeMetricasCapitalEffChart = new Chart(capitalEffCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P/L Promedio',
                            data: avgPL,
                            backgroundColor: avgPL.map(pl => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
        }

        // New chart functions for Informe -> Metricas
        function updateInformeMetricasEvolutionChart(allAccountOps, accountId, timeRange = 'ALL') {
            const ctx = document.getElementById('informe-metricas-evolution-chart').getContext('2d');
            if (informeMetricasEvolutionChart) informeMetricasEvolutionChart.destroy();
            const currencySelect = document.getElementById('informe-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';

            // The `allAccountOps` parameter is already filtered by global date and selected account.
            // The `startDateStringForChartRange` is for *further* filtering based on the chart's specific time range buttons (1W, 1M, etc.).
            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            chartOps = [...chartOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || "00:00:00")) - new Date(b.date + 'T' + (b.entryTime || "00:00:00")));

            let startingBalance = 0;
            let chartTargetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;
            let initialBalanceForPercentCalc = 0;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    startingBalance = account.initialBalance;
                    initialBalanceForPercentCalc = convertCurrency(account.initialBalance, account.currency, chartTargetCurrency);
                    if (account.currency !== chartTargetCurrency) {
                        startingBalance = convertCurrency(startingBalance, account.currency, chartTargetCurrency);
                    }
                    const operationsBeforeChartRange = DB.operations.filter(op =>
                        op.accountId === accountId &&
                        op.date < (chartOps.length > 0 ? chartOps[0].date : getLocalDateString(new Date()))
                    );
                    operationsBeforeChartRange.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== chartTargetCurrency) {
                            pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                        }
                        startingBalance += pl;
                    });
                }
            } else {
                startingBalance = DB.accounts.reduce((sum, acc) => {
                    let accEffectiveInitialBalance = acc.initialBalance;
                    const opsBeforeRangeForThisAccount = DB.operations.filter(op =>
                        op.accountId === acc.id && op.date < (chartOps.length > 0 ? chartOps[0].date : getLocalDateString(new Date()))
                    );
                    opsBeforeRangeForThisAccount.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== acc.currency) {
                            pl = convertCurrency(pl, op.currency, acc.currency);
                        }
                        accEffectiveInitialBalance += pl;
                    });
                    if (acc.currency !== chartTargetCurrency) {
                        accEffectiveInitialBalance = convertCurrency(accEffectiveInitialBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + accEffectiveInitialBalance;
                }, 0);

                initialBalanceForPercentCalc = DB.accounts.reduce((sum, acc) => {
                    let iBalance = acc.initialBalance;
                    if (acc.currency !== chartTargetCurrency) {
                        iBalance = convertCurrency(iBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + iBalance;
                }, 0);
            }

            const labels = ['Inicio'];
            const dataPoints = [startingBalance];
            chartOps.reduce((balance, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newBalance = balance + pl;
                dataPoints.push(newBalance);
                labels.push(formatDate(op.date));
                return newBalance;
            }, startingBalance);

            const finalData = displayCurrency === '%' && initialBalanceForPercentCalc !== 0
                ? dataPoints.map(val => ((val / initialBalanceForPercentCalc) * 100) - 100)
                : dataPoints;

            const yAxisFormatter = displayCurrency === '%'
                ? (val) => (val > 0 ? '+' : '') + val.toFixed(1) + '%'
                : (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency);

            informeMetricasEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Balance', data: finalData, borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: '#FFFFFF' }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Balance: ${yAxisFormatter(c.raw)}` } } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: yAxisFormatter }, zeroLineColor: '#2a2a2a' } } }
            });
        }

        function updateInformeMetricasRadarChart(operations, accountId) {
            const ctx = document.getElementById('informe-metricas-radar-chart')?.getContext('2d');
            if (!ctx) return;
            if (informeMetricasRadarChart) informeMetricasRadarChart.destroy();

            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);

            let maxDrawdownPercentage = 0;
            if (operations.length > 0) {
                const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                let accountInitialBalance = 0;
                let accountCurrency = DB.settings.defaultCurrency;

                if (accountId !== 'all') {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) {
                        accountInitialBalance = account.initialBalance;
                        accountCurrency = account.currency;
                    }
                } else {
                    accountInitialBalance = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency), 0);
                }

                if (accountInitialBalance > 0) {
                    let peakBalance = accountInitialBalance;
                    let maxDrawdownValue = 0;
                    let currentBalance = accountInitialBalance;
                    sortedOps.forEach(op => {
                        let pl = convertCurrency(op.pl, op.currency, accountCurrency);
                        currentBalance += pl;
                        if (currentBalance > peakBalance) peakBalance = currentBalance;
                        const drawdown = peakBalance - currentBalance;
                        if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
                    });
                    maxDrawdownPercentage = (maxDrawdownValue / accountInitialBalance) * 100;
                }
            }

            const winRateScore = basicMetrics.winRate || 0;
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3, 1) * 100; // PF of 3.0 is 100%
            const avgWLRatio = advancedMetrics.avgWin && advancedMetrics.avgLoss ? Math.abs(advancedMetrics.avgWin / advancedMetrics.avgLoss) : 0;
            const avgWLRatioScore = Math.min(avgWLRatio / 3, 1) * 100; // Ratio of 3.0 is 100%
            const drawdownScore = Math.max(0, (1 - Math.min(maxDrawdownPercentage / 20, 1)) * 100); // 20% DD is 0 score

            let consistencyScore = 0;
            if (operations.length > 1) {
                const tradingDays = new Set(operations.map(op => op.date));
                if (tradingDays.size > 0) {
                    const dailyPL = {};
                    operations.forEach(op => {
                        if (!dailyPL[op.date]) dailyPL[op.date] = 0;
                        const plInDefaultCurrency = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        const feesInDefaultCurrency = convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
                        dailyPL[op.date] += plInDefaultCurrency - feesInDefaultCurrency;
                    });
                    const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
                    consistencyScore = (winningDays / tradingDays.size) * 100;
                }
            }

            informeMetricasRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Profit Factor', 'Avg Win/Loss', 'Drawdown Ctrl', 'Consistencia'],
                    datasets: [{
                        label: 'Puntuaci√≥n',
                        data: [winRateScore, profitFactorScore, avgWLRatioScore, drawdownScore, consistencyScore],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: 'rgba(57, 255, 20, 0.8)',
                        pointBackgroundColor: 'var(--primary)',
                        pointBorderColor: '#0a0a0a',
                        pointHoverBackgroundColor: '#FFFFFF',
                        pointHoverBorderColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            angleLines: { color: '#2a2a2a' },
                            grid: { color: '#2a2a2a' },
                            pointLabels: { color: '#FFFFFF', font: { size: 11 } },
                            ticks: { display: false, stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Variables globales para los nuevos gr√°ficos
        let reduccionAcumuladaChart = null;
        let pnlAcumuladoChart = null;
        let accountReduccionAcumuladaChart = null;
        let accountPnlAcumuladoChart = null;
        let cuentasDailyPnlChart = null;
        let cuentasDailyWinLossChart = null;
        let accountDailyPnlChart = null;
        let accountDailyWinLossChart = null;

        function updateReduccionAcumuladaChart(allAccountOps, accountId, timeRange = 'ALL') {
            const ctx = document.getElementById('reduccion-acumulada-chart')?.getContext('2d');
            if (!ctx) return;
            if (reduccionAcumuladaChart) reduccionAcumuladaChart.destroy();

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            const filteredOps = accountId === 'all' ? chartOps : chartOps.filter(op => op.accountId === accountId);
            
            if (filteredOps.length === 0) {
                reduccionAcumuladaChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Ordenar operaciones por fecha
            const sortedOps = [...filteredOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
            
            // Calcular balance inicial
            let startingBalance = 0;
            let chartTargetCurrency = DB.settings.defaultCurrency;
            
            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    startingBalance = account.initialBalance;
                    chartTargetCurrency = account.currency;
                }
            } else {
                startingBalance = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, chartTargetCurrency), 0);
            }

            // Calcular drawdown acumulado
            const labels = ['Inicio'];
            const balancePoints = [startingBalance];
            const drawdownPoints = [0]; // Drawdown inicia en 0
            let maxBalance = startingBalance;
            
            sortedOps.reduce((balance, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newBalance = balance + pl;
                
                // Actualizar m√°ximo balance
                if (newBalance > maxBalance) maxBalance = newBalance;
                
                // Calcular drawdown actual (negativo)
                const currentDrawdown = newBalance - maxBalance;
                
                balancePoints.push(newBalance);
                drawdownPoints.push(currentDrawdown);
                labels.push(formatDate(op.date));
                return newBalance;
            }, startingBalance);

            reduccionAcumuladaChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Reducci√≥n Acumulada', 
                        data: drawdownPoints, 
                        borderColor: '#ef4444', 
                        backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                        borderWidth: 2, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0, 
                        pointHoverRadius: 5, 
                        pointHoverBackgroundColor: '#ef4444' 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: (c) => `Drawdown: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}` 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' } 
                        }, 
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF', 
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) 
                            },
                            max: 0 // Forzar que el m√°ximo sea 0 (sin drawdown)
                        } 
                    } 
                }
            });
        }

        function updatePnLAcumuladoChart(allAccountOps, accountId, timeRange = 'ALL') {
            const ctx = document.getElementById('pnl-acumulado-chart')?.getContext('2d');
            if (!ctx) return;
            if (pnlAcumuladoChart) pnlAcumuladoChart.destroy();

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            const filteredOps = accountId === 'all' ? chartOps : chartOps.filter(op => op.accountId === accountId);
            
            if (filteredOps.length === 0) {
                pnlAcumuladoChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Ordenar operaciones por fecha
            const sortedOps = [...filteredOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
            
            let chartTargetCurrency = DB.settings.defaultCurrency;
            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) chartTargetCurrency = account.currency;
            }

            // Calcular P&L acumulado
            const labels = ['Inicio'];
            const pnlPoints = [0]; // P&L inicia en 0
            
            sortedOps.reduce((accumulatedPL, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newAccumulatedPL = accumulatedPL + pl;
                
                pnlPoints.push(newAccumulatedPL);
                labels.push(formatDate(op.date));
                return newAccumulatedPL;
            }, 0);

            // Determinar color basado en P&L final
            const finalPL = pnlPoints[pnlPoints.length - 1];
            const lineColor = finalPL >= 0 ? '#10B981' : '#ef4444'; // Verde fluorescente o rojo
            const fillColor = finalPL >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

            pnlAcumuladoChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'P&L Acumulado', 
                        data: pnlPoints, 
                        borderColor: lineColor, 
                        backgroundColor: fillColor, 
                        borderWidth: 2, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0, 
                        pointHoverRadius: 5, 
                        pointHoverBackgroundColor: lineColor 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: (c) => `P&L: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}` 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' } 
                        }, 
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF', 
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) 
                            } 
                        } 
                    } 
                }
            });
        }

        function updateCuentasDailyPnLChart(allAccountOps, accountId) {
            const ctx = document.getElementById('cuentas-daily-pnl-chart')?.getContext('2d');
            if (!ctx) return;
            if (cuentasDailyPnlChart) cuentasDailyPnlChart.destroy();

            const filteredOps = accountId === 'all' ? allAccountOps : allAccountOps.filter(op => op.accountId === accountId);
            
            if (filteredOps.length === 0) {
                cuentasDailyPnlChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            let chartTargetCurrency = DB.settings.defaultCurrency;
            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) chartTargetCurrency = account.currency;
            }

            // Agrupar por fecha
            const dailyPnL = {};
            filteredOps.forEach(op => {
                const date = op.date;
                if (!dailyPnL[date]) {
                    dailyPnL[date] = 0;
                }
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) {
                    pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                }
                dailyPnL[date] += pl;
            });

            // Ordenar por fecha
            const sortedDates = Object.keys(dailyPnL).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => formatDate(date));
            const data = sortedDates.map(date => dailyPnL[date]);
            const colors = data.map(val => val >= 0 ? '#39FF14' : '#FF0000'); // Verde fluorescente o rojo

            cuentasDailyPnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'P&L Neto Diario',
                        data,
                        backgroundColor: colors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (c) => `P&L: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } },
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF',
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency)
                            } 
                        }
                    }
                }
            });
        }

        function updateCuentasDailyWinLossChart(allAccountOps, accountId) {
            const ctx = document.getElementById('cuentas-daily-winloss-chart')?.getContext('2d');
            if (!ctx) return;
            if (cuentasDailyWinLossChart) cuentasDailyWinLossChart.destroy();

            const filteredOps = accountId === 'all' ? allAccountOps : allAccountOps.filter(op => op.accountId === accountId);
            
            if (filteredOps.length === 0) {
                cuentasDailyWinLossChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Agrupar por fecha
            const dailyWinLoss = {};
            filteredOps.forEach(op => {
                const date = op.date;
                if (!dailyWinLoss[date]) {
                    dailyWinLoss[date] = { wins: 0, losses: 0 };
                }
                if (op.result === 'win') {
                    dailyWinLoss[date].wins++;
                } else if (op.result === 'loss') {
                    dailyWinLoss[date].losses++;
                }
            });

            // Ordenar por fecha
            const sortedDates = Object.keys(dailyWinLoss).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => formatDate(date));
            const winsData = sortedDates.map(date => dailyWinLoss[date].wins);
            const lossesData = sortedDates.map(date => dailyWinLoss[date].losses);

            cuentasDailyWinLossChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Victorias',
                            data: winsData,
                            backgroundColor: '#39FF14', // Verde fluorescente
                        },
                        {
                            label: 'Derrotas',
                            data: lossesData,
                            backgroundColor: '#FF0000', // Rojo
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#FFFFFF' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (c) => `${c.dataset.label}: ${c.raw}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' },
                            stacked: false
                        },
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF',
                                stepSize: 1
                            },
                            stacked: false
                        }
                    }
                }
            });
        }

        function updateAccountReduccionAcumuladaChart(allAccountOps, account, timeRange = 'ALL') {
            const ctx = document.getElementById('account-reduccion-acumulada-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountReduccionAcumuladaChart) accountReduccionAcumuladaChart.destroy();

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            const filteredOps = chartOps.filter(op => op.accountId === account.id);
            
            if (filteredOps.length === 0) {
                accountReduccionAcumuladaChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Ordenar operaciones por fecha
            const sortedOps = [...filteredOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
            
            // Calcular balance inicial
            let startingBalance = account.initialBalance;
            let chartTargetCurrency = account.currency;

            // Calcular drawdown acumulado
            const labels = ['Inicio'];
            const balancePoints = [startingBalance];
            const drawdownPoints = [0]; // Drawdown inicia en 0
            let maxBalance = startingBalance;
            
            sortedOps.reduce((balance, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newBalance = balance + pl;
                
                // Actualizar m√°ximo balance
                if (newBalance > maxBalance) maxBalance = newBalance;
                
                // Calcular drawdown actual (negativo)
                const currentDrawdown = newBalance - maxBalance;
                
                balancePoints.push(newBalance);
                drawdownPoints.push(currentDrawdown);
                labels.push(formatDate(op.date));
                return newBalance;
            }, startingBalance);

            accountReduccionAcumuladaChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Reducci√≥n Acumulada', 
                        data: drawdownPoints, 
                        borderColor: '#ef4444', 
                        backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                        borderWidth: 2, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0, 
                        pointHoverRadius: 5, 
                        pointHoverBackgroundColor: '#ef4444' 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: (c) => `Drawdown: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}` 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' } 
                        }, 
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF', 
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) 
                            },
                            max: 0 // Forzar que el m√°ximo sea 0 (sin drawdown)
                        } 
                    } 
                }
            });
        }

        function updateAccountPnLAcumuladoChart(allAccountOps, account, timeRange = 'ALL') {
            const ctx = document.getElementById('account-pnl-acumulado-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountPnlAcumuladoChart) accountPnlAcumuladoChart.destroy();

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            const filteredOps = chartOps.filter(op => op.accountId === account.id);
            
            if (filteredOps.length === 0) {
                accountPnlAcumuladoChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Ordenar operaciones por fecha
            const sortedOps = [...filteredOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
            
            let chartTargetCurrency = account.currency;

            // Calcular P&L acumulado
            const labels = ['Inicio'];
            const pnlPoints = [0]; // P&L inicia en 0
            
            sortedOps.reduce((accumulatedPL, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newAccumulatedPL = accumulatedPL + pl;
                
                pnlPoints.push(newAccumulatedPL);
                labels.push(formatDate(op.date));
                return newAccumulatedPL;
            }, 0);

            // Determinar color basado en P&L final
            const finalPL = pnlPoints[pnlPoints.length - 1];
            const lineColor = finalPL >= 0 ? '#39ff14' : '#ef4444'; // Verde fluorescente o rojo
            const fillColor = finalPL >= 0 ? 'rgba(57, 255, 20, 0.1)' : 'rgba(239, 68, 68, 0.1)';

            accountPnlAcumuladoChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'P&L Acumulado', 
                        data: pnlPoints, 
                        borderColor: lineColor, 
                        backgroundColor: fillColor, 
                        borderWidth: 2, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0, 
                        pointHoverRadius: 5, 
                        pointHoverBackgroundColor: lineColor 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: (c) => `P&L: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}` 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' } 
                        }, 
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF', 
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) 
                            } 
                        } 
                    } 
                }
            });
        }

        function updateAccountDailyPnLChart(allAccountOps, account) {
            const ctx = document.getElementById('account-daily-pnl-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountDailyPnlChart) accountDailyPnlChart.destroy();

            const filteredOps = allAccountOps.filter(op => op.accountId === account.id);
            
            if (filteredOps.length === 0) {
                accountDailyPnlChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            const chartTargetCurrency = account.currency;

            // Agrupar por fecha
            const dailyPnL = {};
            filteredOps.forEach(op => {
                const date = op.date;
                if (!dailyPnL[date]) {
                    dailyPnL[date] = 0;
                }
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) {
                    pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                }
                dailyPnL[date] += pl;
            });

            // Ordenar por fecha
            const sortedDates = Object.keys(dailyPnL).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => formatDate(date));
            const data = sortedDates.map(date => dailyPnL[date]);
            const colors = data.map(val => val >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)');

            accountDailyPnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'P&L Neto Diario',
                        data,
                        backgroundColor: colors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (c) => `P&L: ${formatCurrency(c.raw, chartTargetCurrency, chartTargetCurrency)}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } },
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF',
                                callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency)
                            } 
                        }
                    }
                }
            });
        }

        function updateAccountDailyWinLossChart(allAccountOps, account) {
            const ctx = document.getElementById('account-daily-winloss-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountDailyWinLossChart) accountDailyWinLossChart.destroy();

            const filteredOps = allAccountOps.filter(op => op.accountId === account.id);
            
            if (filteredOps.length === 0) {
                accountDailyWinLossChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // Agrupar por fecha
            const dailyWinLoss = {};
            filteredOps.forEach(op => {
                const date = op.date;
                if (!dailyWinLoss[date]) {
                    dailyWinLoss[date] = { wins: 0, losses: 0 };
                }
                if (op.result === 'win') {
                    dailyWinLoss[date].wins++;
                } else if (op.result === 'loss') {
                    dailyWinLoss[date].losses++;
                }
            });

            // Ordenar por fecha
            const sortedDates = Object.keys(dailyWinLoss).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => formatDate(date));
            const winsData = sortedDates.map(date => dailyWinLoss[date].wins);
            const lossesData = sortedDates.map(date => dailyWinLoss[date].losses);

            accountDailyWinLossChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Victorias',
                            data: winsData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        },
                        {
                            label: 'Derrotas',
                            data: lossesData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#FFFFFF' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (c) => `${c.dataset.label}: ${c.raw}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { color: '#FFFFFF' },
                            stacked: false
                        },
                        y: { 
                            grid: { color: '#2a2a2a' }, 
                            ticks: { 
                                color: '#FFFFFF',
                                stepSize: 1
                            },
                            stacked: false
                        }
                    }
                }
            });
        }

        // Add event listener for time range buttons in Informe -> Metricas
        document.addEventListener('DOMContentLoaded', () => {
            const informeMetricasTimeRangeContainer = document.querySelector('#informe-metricas-content .time-range-buttons');
            if (informeMetricasTimeRangeContainer) {
                informeMetricasTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('time-range-btn')) {
                        informeMetricasTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        const timeRange = event.target.dataset.range;
                        const selectedAccount = document.getElementById('informe-account-select').value;

                        let operations = applyDateFilterToData(DB.operations);
                        if (selectedAccount !== 'all') {
                            operations = operations.filter(op => op.accountId === selectedAccount);
                        }
                        updateInformeMetricasEvolutionChart(operations, selectedAccount, timeRange);
                    }
                });
            }

            // Event listeners para los nuevos gr√°ficos
            const drawdownTimeRangeContainer = document.querySelector('.drawdown-range-btn').parentNode;
            if (drawdownTimeRangeContainer) {
                drawdownTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('drawdown-range-btn')) {
                        drawdownTimeRangeContainer.querySelectorAll('.drawdown-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        const timeRange = event.target.dataset.range;
                        const selectedAccount = document.getElementById('informe-account-select').value;

                        let operations = applyDateFilterToData(DB.operations);
                        if (selectedAccount !== 'all') {
                            operations = operations.filter(op => op.accountId === selectedAccount);
                        }
                        updateReduccionAcumuladaChart(operations, selectedAccount, timeRange);
                    }
                });
            }

            const pnlTimeRangeContainer = document.querySelector('.pnl-range-btn').parentNode;
            if (pnlTimeRangeContainer) {
                pnlTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('pnl-range-btn')) {
                        pnlTimeRangeContainer.querySelectorAll('.pnl-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        const timeRange = event.target.dataset.range;
                        const selectedAccount = document.getElementById('informe-account-select').value;

                        let operations = applyDateFilterToData(DB.operations);
                        if (selectedAccount !== 'all') {
                            operations = operations.filter(op => op.accountId === selectedAccount);
                        }
                        updatePnLAcumuladoChart(operations, selectedAccount, timeRange);
                    }
                });
            }

            // Event listener duplicado ELIMINADO - ya existe en l√≠nea 11661
        });
        function refreshSimbolos() {
            const container = document.getElementById('informe-simbolos-content');
            if (!container) return;


            // Obtener operaciones filtradas por fecha y cuenta
            const selectedAccount = document.getElementById('informe-account-select').value;
            let operations = applyDateFilterToData(DB.operations);
            if (selectedAccount !== 'all') {
                operations = operations.filter(op => op.accountId === selectedAccount);
            }
            operations = applyInformeFilters(operations);

            // Aggregate by symbol (using DB.settings.defaultCurrency for internal calculations)
            const symbolPerformance = {};

            if (operations.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-text-secondary">No hay datos de operaciones para mostrar en el per√≠odo o cuenta seleccionada.</div>';
                return;
            }
            operations.forEach(op => {
                if (!op.instrument) return;
                const symbol = op.instrument.toUpperCase(); // Ensure symbol is uppercase
                if (!symbolPerformance[symbol]) {
                    symbolPerformance[symbol] = { pnl: 0, wins: 0, losses: 0, trades: 0, volume: 0 };
                }
                symbolPerformance[symbol].pnl += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                symbolPerformance[symbol].trades++;
                symbolPerformance[symbol].volume += op.volume;
                if (op.result === 'win') {
                    symbolPerformance[symbol].wins++;
                } else if (op.result === 'loss') {
                    symbolPerformance[symbol].losses++;
                }
            });

            // Sort symbols by PnL descending for consistent display
            const sortedSymbols = Object.entries(symbolPerformance).sort(([,a],[,b]) => b.pnl - a.pnl);

            if (sortedSymbols.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-text-secondary">No hay s√≠mbolos con operaciones para analizar.</div>';
                return;
            }
            // Calcular m√©tricas especiales
            function getMax(arr, key) {
                if (!arr || arr.length === 0) return [null, { [key]: -Infinity }];
                return arr.reduce((max, item) => item[1][key] > max[1][key] ? item : max, arr[0]);
            }
            function getMin(arr, key) {
                if (!arr || arr.length === 0) return [null, { [key]: Infinity }];
                return arr.reduce((min, item) => item[1][key] < min[1][key] ? item : min, arr[0]);
            }
            // M√°s victorias
            const maxWins = getMax(sortedSymbols, 'wins'); // [symbol, {wins: X, ...}]
            // M√°s p√©rdidas
            const maxLosses = getMax(sortedSymbols, 'losses');
            // M√°s rentable
            const maxPnl = getMax(sortedSymbols, 'pnl'); // [symbol, {pnl: X, ...}]
            // Menos rentable
            const minPnl = getMin(sortedSymbols, 'pnl');
            // Volumen m√°s comercializado
            const maxVol = getMax(sortedSymbols, 'volume');
            // Volumen menos comercializado
            const minVol = getMin(sortedSymbols, 'volume');
            // Oficios m√°s comercializado
            const maxTrades = getMax(sortedSymbols, 'trades');
            // Oficios menos comercializado (count is always positive, but it's a "least" metric)
            const minTrades = getMin(sortedSymbols, 'trades'); // [symbol, {trades: X, ...}]

            // Tarjetas horizontales replicando el dise√±o
            // Helper function to generate a metric card HTML
            const generateSymbolMetricCard = (title, subTitle, symbol, value, valueType = 'currency', isPositive = null) => {
                if (symbol === null || value === undefined || value === Infinity || value === -Infinity) return ''; // No renderizar si no hay datos
                let valueClass = 'text-neutral'; // Default to neutral
                let formattedValue = '';
                const currencySelect = document.getElementById('informe-currency-select');
                const displayCurrency = currencySelect ? currencySelect.value : 'USD';

                if (valueType === 'currency') {
                    formattedValue = formatCurrency(value, DB.settings.defaultCurrency, displayCurrency);
                    if (value > 0) valueClass = 'text-positive';
                    else if (value < 0) valueClass = 'text-negative';
                    else valueClass = 'text-neutral'; // For 0 PnL
                } else if (valueType === 'count' || valueType === 'volume') {
                    formattedValue = value.toLocaleString();
                    // For counts/volumes, default to neutral unless overridden
                }

                if (isPositive !== null) { // Override for explicit positive/negative
                    valueClass = isPositive ? 'text-positive' : 'text-negative';
                }

                return `
                    <div class="metric-card p-4">
                        <p class="text-sm text-text-secondary">${title}</p>
                        <p class="text-xs text-text-secondary mb-2">${subTitle}</p>
                        <p class="text-xl font-bold ${valueClass}">
                            <span class="inline-block px-2 py-0.5 rounded bg-surface-light text-primary font-bold text-xs mr-2">${symbol}</span>
                            ${formattedValue}
                        </p>
                    </div>
                `;
            };

            let resumenHtml = `
                <h3 class="text-2xl font-bold mb-6 w-full text-left">Resumen por S√≠mbolo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    ${generateSymbolMetricCard('S√≠mbolo con m√°s victorias', 'Mayor n√∫mero de operaciones ganadoras', maxWins[0], maxWins[1].wins, 'count', true)}
                    ${generateSymbolMetricCard('S√≠mbolo con m√°s p√©rdidas', 'Mayor n√∫mero de operaciones perdedoras', maxLosses[0], maxLosses[1].losses, 'count', false)}
                    ${generateSymbolMetricCard('S√≠mbolo m√°s rentable', 'Mayor PnL total', maxPnl[0], maxPnl[1].pnl, 'currency')}
                    ${generateSymbolMetricCard('S√≠mbolo menos rentable', 'Menor PnL total', minPnl[0], minPnl[1].pnl, 'currency')}
                    ${generateSymbolMetricCard('S√≠mbolo m√°s comercializado', 'Mayor volumen total', maxVol[0], maxVol[1].volume, 'volume')}
                    ${generateSymbolMetricCard('S√≠mbolo menos comercializado', 'Menor volumen total', minVol[0], minVol[1].volume, 'volume')}
                    ${generateSymbolMetricCard('S√≠mbolo con m√°s operaciones', 'Mayor n√∫mero de trades', maxTrades[0], maxTrades[1].trades, 'count', true)}
                    ${generateSymbolMetricCard('S√≠mbolo con menos operaciones', 'Menor n√∫mero de trades', minTrades[0], minTrades[1].trades, 'count', false)}
                </div>
            `; // End of resumenHtml

            // Contenedores de gr√°ficas b√°sicas
            resumenHtml += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">PnL por S√≠mbolo</h3><div class="chart-container" style="height: 250px;"><canvas id="simbolos-pnl-chart"></canvas></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Wins/Losses por S√≠mbolo</h3><div class="chart-container" style="height: 250px;"><canvas id="simbolos-wl-chart"></canvas></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Volumen por S√≠mbolo</h3><div class="chart-container" style="height: 250px;"><canvas id="simbolos-volume-chart"></canvas></div></div>
            </div>`;

            // Agregar secci√≥n de an√°lisis avanzado
            resumenHtml += `
                <h3 class="text-2xl font-bold mb-4 mt-8">An√°lisis Avanzado por S√≠mbolo</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Profit Factor por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">Top 15 s√≠mbolos ordenados por profit factor</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-profit-factor-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Mejores Horas por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">Hora m√°s rentable para cada s√≠mbolo (Top 15)</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-best-hours-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Mejores D√≠as por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">D√≠a de la semana m√°s rentable para cada s√≠mbolo (Top 15)</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-best-days-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Comisiones Totales por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">Total de comisiones pagadas (Top 15)</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-commissions-chart"></canvas>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">P/L Neto (despu√©s de comisiones) por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">Ganancia real despu√©s de costos (Top 15)</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-net-pl-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Ratio Comisi√≥n/P/L por S√≠mbolo</h3>
                        <p class="text-xs text-text-secondary mb-2">% de ganancia consumido por comisiones (Top 15)</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="simbolos-commission-ratio-chart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = resumenHtml;

            // Render charts
            // PnL Chart
            const pnlCtx = document.getElementById('simbolos-pnl-chart').getContext('2d');
            new Chart(pnlCtx, {
                type: 'bar',
                data: {
                    labels: sortedSymbols.map(item => item[0]),
                    datasets: [{
                        label: 'PnL',
                        data: sortedSymbols.map(item => item[1].pnl),
                        backgroundColor: sortedSymbols.map(item => item[1].pnl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'),
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
            // Wins/Losses Chart
            const wlCtx = document.getElementById('simbolos-wl-chart').getContext('2d');
            new Chart(wlCtx, {
                type: 'bar',
                data: {
                    labels: sortedSymbols.map(item => item[0]),
                    datasets: [
                        {
                            label: 'Ganadas',
                            data: sortedSymbols.map(item => item[1].wins),
                            backgroundColor: 'rgba(57,255,20,0.7)',
                        },
                        {
                            label: 'Perdidas',
                            data: sortedSymbols.map(item => -item[1].losses),
                            backgroundColor: 'rgba(255,65,54,0.7)',
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0a0a0' } } },
                    scales: {
                        x: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
            // Volume Chart
            const volCtx = document.getElementById('simbolos-volume-chart').getContext('2d');
            new Chart(volCtx, {
                type: 'bar',
                data: {
                    labels: sortedSymbols.map(item => item[0]),
                    datasets: [{
                        label: 'Volumen',
                        data: sortedSymbols.map(item => item[1].volume),
                        backgroundColor: 'rgba(54,162,235,0.7)',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });

            // ========== NUEVAS GR√ÅFICAS AVANZADAS ==========
            
            // 1. Calcular Win Rate por S√≠mbolo
            const symbolWinRate = {};
            sortedSymbols.forEach(([symbol, data]) => {
                const total = data.wins + data.losses;
                symbolWinRate[symbol] = total > 0 ? (data.wins / total) * 100 : 0;
            });
            
            // 2. Calcular Profit Factor por S√≠mbolo
            const symbolProfitFactor = {};
            operations.forEach(op => {
                if (!op.instrument) return;
                const symbol = op.instrument.toUpperCase();
                if (!symbolProfitFactor[symbol]) {
                    symbolProfitFactor[symbol] = { totalWins: 0, totalLosses: 0 };
                }
                const plConverted = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                if (op.result === 'win') {
                    symbolProfitFactor[symbol].totalWins += plConverted;
                } else if (op.result === 'loss') {
                    symbolProfitFactor[symbol].totalLosses += Math.abs(plConverted);
                }
            });
            
            const symbolPF = {};
            Object.keys(symbolProfitFactor).forEach(symbol => {
                const { totalWins, totalLosses } = symbolProfitFactor[symbol];
                symbolPF[symbol] = totalLosses > 0 ? totalWins / totalLosses : (totalWins > 0 ? 999 : 0);
            });
            
            // 3. Calcular Mejores Horas por S√≠mbolo
            const symbolHourlyPL = {};
            operations.forEach(op => {
                if (!op.instrument || !op.entryTime) return;
                const symbol = op.instrument.toUpperCase();
                if (!symbolHourlyPL[symbol]) {
                    symbolHourlyPL[symbol] = {};
                }
                try {
                    const hour = parseInt(op.entryTime.split(':')[0], 10);
                    if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                        if (!symbolHourlyPL[symbol][hour]) {
                            symbolHourlyPL[symbol][hour] = 0;
                        }
                        symbolHourlyPL[symbol][hour] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    }
                } catch (e) { /* ignore */ }
            });
            
            const symbolBestHours = {};
            Object.keys(symbolHourlyPL).forEach(symbol => {
                let bestHour = -1;
                let bestPL = -Infinity;
                Object.keys(symbolHourlyPL[symbol]).forEach(hour => {
                    if (symbolHourlyPL[symbol][hour] > bestPL) {
                        bestPL = symbolHourlyPL[symbol][hour];
                        bestHour = hour;
                    }
                });
                symbolBestHours[symbol] = { hour: bestHour, pl: bestPL };
            });
            
            // 4. Calcular Mejores D√≠as por S√≠mbolo
            const symbolDailyPL = {};
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            operations.forEach(op => {
                if (!op.instrument || !op.date) return;
                const symbol = op.instrument.toUpperCase();
                if (!symbolDailyPL[symbol]) {
                    symbolDailyPL[symbol] = {};
                }
                try {
                    const dayOfWeek = new Date(op.date + 'T00:00:00Z').getUTCDay();
                    if (!symbolDailyPL[symbol][dayOfWeek]) {
                        symbolDailyPL[symbol][dayOfWeek] = 0;
                    }
                    symbolDailyPL[symbol][dayOfWeek] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                } catch (e) { /* ignore */ }
            });
            
            const symbolBestDays = {};
            Object.keys(symbolDailyPL).forEach(symbol => {
                let bestDay = -1;
                let bestPL = -Infinity;
                Object.keys(symbolDailyPL[symbol]).forEach(day => {
                    if (symbolDailyPL[symbol][day] > bestPL) {
                        bestPL = symbolDailyPL[symbol][day];
                        bestDay = day;
                    }
                });
                symbolBestDays[symbol] = { day: bestDay, pl: bestPL, dayName: dayNames[bestDay] };
            });
            
            // Renderizar las 4 nuevas gr√°ficas
            
            // Gr√°fica 1: Win Rate por S√≠mbolo
            const winRateCtx = document.getElementById('simbolos-winrate-chart')?.getContext('2d');
            if (winRateCtx) {
                const sortedByWinRate = Object.entries(symbolWinRate).sort(([,a], [,b]) => b - a).slice(0, 15);
                new Chart(winRateCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedByWinRate.map(([symbol]) => symbol),
                        datasets: [{
                            label: 'Win Rate (%)',
                            data: sortedByWinRate.map(([, wr]) => wr),
                            backgroundColor: sortedByWinRate.map(([, wr]) => wr >= 50 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'),
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Win Rate: ${context.parsed.x.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            x: { 
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { color: '#a0a0a0', callback: (value) => value + '%' },
                                min: 0,
                                max: 100
                            },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 2: Profit Factor por S√≠mbolo
            const pfCtx = document.getElementById('simbolos-profit-factor-chart')?.getContext('2d');
            if (pfCtx) {
                const sortedByPF = Object.entries(symbolPF).sort(([,a], [,b]) => b - a).slice(0, 15);
                new Chart(pfCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedByPF.map(([symbol]) => symbol),
                        datasets: [{
                            label: 'Profit Factor',
                            data: sortedByPF.map(([, pf]) => Math.min(pf, 10)), // Cap at 10 for display
                            backgroundColor: sortedByPF.map(([, pf]) => pf >= 1.5 ? 'rgba(57,255,20,0.7)' : pf >= 1 ? 'rgba(255,193,7,0.7)' : 'rgba(255,65,54,0.7)'),
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const actualPF = sortedByPF[context.dataIndex][1];
                                        return `Profit Factor: ${actualPF.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { color: '#a0a0a0' },
                                min: 0
                            },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 3: Mejores Horas por S√≠mbolo
            const bestHoursCtx = document.getElementById('simbolos-best-hours-chart')?.getContext('2d');
            if (bestHoursCtx) {
                const sortedByBestHour = Object.entries(symbolBestHours)
                    .filter(([, data]) => data.hour >= 0)
                    .sort(([,a], [,b]) => b.pl - a.pl)
                    .slice(0, 15);
                
                new Chart(bestHoursCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedByBestHour.map(([symbol, data]) => `${symbol} (${String(data.hour).padStart(2, '0')}:00)`),
                        datasets: [{
                            label: 'P/L en Mejor Hora',
                            data: sortedByBestHour.map(([, data]) => data.pl),
                            backgroundColor: sortedByBestHour.map(([, data]) => data.pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'),
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const [symbol, data] = sortedByBestHour[context.dataIndex];
                                        return `${symbol} a las ${String(data.hour).padStart(2, '0')}:00 - P/L: $${data.pl.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                        }
                    }
                });
            }
            
            // Gr√°fica 4: Mejores D√≠as por S√≠mbolo
            const bestDaysCtx = document.getElementById('simbolos-best-days-chart')?.getContext('2d');
            if (bestDaysCtx) {
                const sortedByBestDay = Object.entries(symbolBestDays)
                    .filter(([, data]) => data.day >= 0)
                    .sort(([,a], [,b]) => b.pl - a.pl)
                    .slice(0, 15);
                
                new Chart(bestDaysCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedByBestDay.map(([symbol, data]) => `${symbol} (${data.dayName})`),
                        datasets: [{
                            label: 'P/L en Mejor D√≠a',
                            data: sortedByBestDay.map(([, data]) => data.pl),
                            backgroundColor: sortedByBestDay.map(([, data]) => data.pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'),
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const [symbol, data] = sortedByBestDay[context.dataIndex];
                                        return `${symbol} los ${data.dayName} - P/L: $${data.pl.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                        }
                    }
                });
            }
            
            // ===== NUEVAS GR√ÅFICAS: COMISIONES Y COSTOS =====
            
            // Calcular comisiones por s√≠mbolo
            const symbolCommissions = {};
            const symbolSlippage = {};
            const symbolNetPL = {};
            
            operations.forEach(op => {
                if (!op.instrument) return;
                const symbol = op.instrument.toUpperCase();
                
                if (!symbolCommissions[symbol]) {
                    symbolCommissions[symbol] = 0;
                    symbolSlippage[symbol] = { total: 0, count: 0 };
                    symbolNetPL[symbol] = 0;
                }
                
                // Comisi√≥n (si no existe, estimar 0.1% del volumen)
                const commission = op.commission || (Math.abs(op.pl) * 0.001);
                symbolCommissions[symbol] += Math.abs(convertCurrency(commission, op.currency, DB.settings.defaultCurrency));
                
                // Calcular slippage (si no hay executedPrice, usar valor peque√±o estimado)
                const slippage = op.executedPrice 
                    ? Math.abs((op.entryPrice || 0) - op.executedPrice)
                    : (op.entryPrice || 0) * 0.0001; // 1 pip estimado
                    
                if (slippage > 0) {
                    symbolSlippage[symbol].total += slippage;
                    symbolSlippage[symbol].count++;
                }
                
                const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                symbolNetPL[symbol] += pl - commission;
            });
            
            // Gr√°fica 1: Comisiones por S√≠mbolo
            const commissionsCtx = document.getElementById('simbolos-commissions-chart')?.getContext('2d');
            if (commissionsCtx) {
                const sortedCommissions = Object.entries(symbolCommissions)
                    .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))
                    .slice(0, 15);
                
                new Chart(commissionsCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedCommissions.map(([symbol]) => symbol),
                        datasets: [{
                            label: 'Comisiones Totales',
                            data: sortedCommissions.map(([, comm]) => Math.abs(comm)),
                            backgroundColor: 'rgba(255,193,7,0.7)',
                            borderColor: 'rgba(255,193,7,1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Comisiones: $${context.parsed.x.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                        }
                    }
                });
            }
            
            // Gr√°fica 2: Win Rate por S√≠mbolo
            const winrateCtx = document.getElementById('simbolos-winrate-chart')?.getContext('2d');
            if (winrateCtx) {
                const symbolWinRateData = {};
                Object.keys(symbolStats).forEach(symbol => {
                    const stats = symbolStats[symbol];
                    const total = stats.wins + stats.losses;
                    if (total >= 3) { // M√≠nimo 3 trades para ser relevante
                        symbolWinRateData[symbol] = {
                            winRate: (stats.wins / total) * 100,
                            trades: total,
                            wins: stats.wins,
                            losses: stats.losses
                        };
                    }
                });
                
                const sortedWinRate = Object.entries(symbolWinRateData)
                    .sort(([,a], [,b]) => b.trades - a.trades) // Ordenar por m√°s operados
                    .slice(0, 15);
                
                if (sortedWinRate.length > 0) {
                    new Chart(winrateCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedWinRate.map(([symbol]) => symbol),
                            datasets: [{
                                label: 'Win Rate %',
                                data: sortedWinRate.map(([, data]) => data.winRate),
                                backgroundColor: sortedWinRate.map(([, data]) => {
                                    if (data.winRate >= 60) return 'rgba(57, 255, 20, 0.8)'; // Verde fluorescente
                                    if (data.winRate >= 50) return 'rgba(59, 130, 246, 0.8)'; // Azul
                                    if (data.winRate >= 40) return 'rgba(251, 191, 36, 0.8)'; // Amarillo
                                    return 'rgba(239, 68, 68, 0.8)'; // Rojo
                                }),
                                borderColor: sortedWinRate.map(([, data]) => {
                                    if (data.winRate >= 60) return 'rgba(57, 255, 20, 1)';
                                    if (data.winRate >= 50) return 'rgba(59, 130, 246, 1)';
                                    if (data.winRate >= 40) return 'rgba(251, 191, 36, 1)';
                                    return 'rgba(239, 68, 68, 1)';
                                }),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            const data = sortedWinRate[context.dataIndex][1];
                                            return [
                                                `Win Rate: ${context.parsed.x.toFixed(1)}%`,
                                                `Wins: ${data.wins} | Losses: ${data.losses}`,
                                                `Total Trades: ${data.trades}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: {
                                        color: '#a0a0a0',
                                        callback: (value) => value + '%'
                                    },
                                    title: { display: true, text: 'Win Rate (%)', color: '#a0a0a0' }
                                },
                                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                            }
                        }
                    });
                } else {
                    // Sin datos suficientes
                    new Chart(winrateCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                label: 'Win Rate',
                                data: [0],
                                backgroundColor: 'rgba(100,100,100,0.5)'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } },
                                y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }
                            }
                        }
                    });
                }
            }
            
            // Gr√°fica 3: P/L Neto (despu√©s de comisiones)
            const netPLCtx = document.getElementById('simbolos-net-pl-chart')?.getContext('2d');
            if (netPLCtx) {
                const sortedNetPL = Object.entries(symbolNetPL)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 15);
                
                new Chart(netPLCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedNetPL.map(([symbol]) => symbol),
                        datasets: [{
                            label: 'P/L Neto',
                            data: sortedNetPL.map(([, pl]) => pl),
                            backgroundColor: sortedNetPL.map(([, pl]) => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `P/L Neto: $${context.parsed.x.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                        }
                    }
                });
            }
            
            // Gr√°fica 4: Ratio Comisi√≥n/P/L
            const commissionRatioCtx = document.getElementById('simbolos-commission-ratio-chart')?.getContext('2d');
            if (commissionRatioCtx) {
                const commissionRatio = {};
                Object.keys(symbolPerformance).forEach(symbol => {
                    const totalPL = Math.abs(symbolPerformance[symbol].pnl);
                    const totalComm = Math.abs(symbolCommissions[symbol] || 0);
                    if (totalPL > 0 && totalComm > 0) {
                        commissionRatio[symbol] = (totalComm / totalPL) * 100;
                    } else if (totalComm > 0) {
                        commissionRatio[symbol] = 100; // Si hay comisi√≥n pero no P/L
                    }
                });
                
                const sortedRatio = Object.entries(commissionRatio)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 15);
                
                if (sortedRatio.length > 0) {
                    new Chart(commissionRatioCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedRatio.map(([symbol]) => symbol),
                            datasets: [{
                                label: 'Ratio Comisi√≥n/P/L (%)',
                                data: sortedRatio.map(([, ratio]) => ratio),
                                backgroundColor: sortedRatio.map(([, ratio]) => 
                                    ratio > 30 ? 'rgba(239,68,68,0.7)' : 
                                    ratio > 15 ? 'rgba(255,193,7,0.7)' : 
                                    'rgba(57,255,20,0.7)'
                                )
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.x.toFixed(1)}% de P/L en comisiones`
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255,255,255,0.1)' }, 
                                    ticks: { 
                                        color: '#a0a0a0',
                                        callback: (value) => value + '%'
                                    } 
                                },
                                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                            }
                        }
                    });
                } else {
                    // Sin datos
                    new Chart(commissionRatioCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Sin datos'],
                            datasets: [{
                                label: 'Ratio',
                                data: [0],
                                backgroundColor: 'rgba(100,100,100,0.5)'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } },
                                y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }
                            }
                        }
                    });
                }
            }
        }

        // Variables globales para gr√°ficos de Tiempo
        let tiempoSessionPLChart = null;
        let tiempoSessionCountChart = null;

        function refreshTiempo() {
            console.log('[Tiempo] üîÑ Refreshing...');
            const selectedAccount = document.getElementById('informe-account-select').value;
            const currencySelect = document.getElementById('informe-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            
            console.log('[Tiempo] Selected account:', selectedAccount);
            let operations = applyDateFilterToData(DB.operations);
            console.log('[Tiempo] Operations after date filter:', operations.length);
            if (selectedAccount !== 'all') {
                operations = operations.filter(op => op.accountId === selectedAccount);
            }
            console.log('[Tiempo] Operations after account filter:', operations.length);
            operations = applyInformeFilters(operations);
            console.log('[Tiempo] Operations after additional filters:', operations.length);
            
            // Destruir charts anteriores
            if (tiempoSessionPLChart) { tiempoSessionPLChart.destroy(); tiempoSessionPLChart = null; }
            if (tiempoSessionCountChart) { tiempoSessionCountChart.destroy(); tiempoSessionCountChart = null; }
            
            if (operations.length === 0) {
                document.getElementById('informe-tiempo-content').innerHTML = '<div class="text-center p-8 text-text-secondary">No hay datos de operaciones para mostrar en el per√≠odo o cuenta seleccionada.</div>';
                return;
            }
            
            // Calcular m√©tricas de tiempo
            const timeMetrics = calculateTimeMetrics(operations);
            const extraMetrics = calculateExtraAnalytics(operations, selectedAccount);
            
            // Poblar m√©tricas en tarjetas
            const avgWinDurEl = document.getElementById('informe-tiempo-avg-win-duration');
            if (avgWinDurEl) avgWinDurEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.avgWinDuration) : 'N/A';
            
            const avgLossDurEl = document.getElementById('informe-tiempo-avg-loss-duration');
            if (avgLossDurEl) avgLossDurEl.textContent = timeMetrics.hasLosses ? formatDurationText(timeMetrics.avgLossDuration) : 'N/A';
            
            const bestHourEl = document.getElementById('informe-tiempo-best-hour');
            if (bestHourEl && timeMetrics.bestHour >= 0) {
                bestHourEl.textContent = `${String(timeMetrics.bestHour).padStart(2, '0')}:00 (${formatCurrency(timeMetrics.bestHourPL, DB.settings.defaultCurrency, displayCurrency)})`;
            } else if (bestHourEl) {
                bestHourEl.textContent = 'N/A';
            }
            
            const worstHourEl = document.getElementById('informe-tiempo-worst-hour');
            if (worstHourEl && timeMetrics.worstHour >= 0) {
                worstHourEl.textContent = `${String(timeMetrics.worstHour).padStart(2, '0')}:00 (${formatCurrency(timeMetrics.worstHourPL, DB.settings.defaultCurrency, displayCurrency)})`;
            } else if (worstHourEl) {
                worstHourEl.textContent = 'N/A';
            }
            
            const longestWinEl = document.getElementById('informe-tiempo-longest-win');
            if (longestWinEl) longestWinEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.longestWinDuration) : 'N/A';
            
            const longestLossEl = document.getElementById('informe-tiempo-longest-loss');
            if (longestLossEl) longestLossEl.textContent = timeMetrics.hasLosses ? formatDurationText(timeMetrics.longestLossDuration) : 'N/A';
            
            const fastestWinEl = document.getElementById('informe-tiempo-fastest-win');
            if (fastestWinEl) fastestWinEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.fastestWin) : 'N/A';
            
            const avgTradeDurEl = document.getElementById('informe-tiempo-avg-trade-duration');
            if (avgTradeDurEl) avgTradeDurEl.textContent = extraMetrics.avgHoldTimeText;
            
            // Nueva m√©trica: Ratio de Duraci√≥n Win/Loss
            const durationRatioEl = document.getElementById('informe-tiempo-duration-ratio');
            if (durationRatioEl) {
                if (timeMetrics.hasWins && timeMetrics.hasLosses && timeMetrics.avgLossDuration > 0) {
                    const ratio = timeMetrics.avgWinDuration / timeMetrics.avgLossDuration;
                    durationRatioEl.textContent = ratio.toFixed(2);
                    durationRatioEl.classList.remove('text-positive', 'text-negative', 'text-white', 'text-yellow');
                    if (ratio >= 1.5) {
                        durationRatioEl.classList.add('text-positive'); // Excelente: dejas correr ganancias
                    } else if (ratio >= 1.0) {
                        durationRatioEl.classList.add('text-primary'); // Bueno: duraci√≥n similar
                    } else if (ratio >= 0.7) {
                        durationRatioEl.classList.add('text-yellow'); // Advertencia: cierras r√°pido ganancias
                    } else {
                        durationRatioEl.classList.add('text-negative'); // Problema: mantienes mucho las p√©rdidas
                    }
                } else {
                    durationRatioEl.textContent = 'N/A';
                    durationRatioEl.classList.remove('text-positive', 'text-negative', 'text-primary', 'text-yellow');
                    durationRatioEl.classList.add('text-white');
                }
            }
            
            // === GR√ÅFICA 1: Duraci√≥n Wins vs Losses ===
            if (tiempoChartDurationComp) {
                tiempoChartDurationComp.destroy();
                tiempoChartDurationComp = null;
            }
            const durationCompCtx = document.getElementById('tiempo-duration-comparison-chart')?.getContext('2d');
            if (durationCompCtx) {
                tiempoChartDurationComp = new Chart(durationCompCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Wins', 'Losses'],
                        datasets: [{
                            label: 'Duraci√≥n Promedio (minutos)',
                            data: [timeMetrics.avgWinDuration, timeMetrics.avgLossDuration],
                            backgroundColor: ['rgba(57,255,20,0.7)', 'rgba(255,65,54,0.7)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Duraci√≥n: ${formatDurationText(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: (value) => value < 60 ? `${value}m` : `${(value/60).toFixed(1)}h`
                                }
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 2: P/L por Hora ===
            if (tiempoChartHourlyPL) {
                tiempoChartHourlyPL.destroy();
                tiempoChartHourlyPL = null;
            }
            const hourlyPLCtx = document.getElementById('tiempo-hourly-pl-chart')?.getContext('2d');
            if (hourlyPLCtx) {
                const hourlyPL = Array(24).fill(0);
                operations.forEach(op => {
                    if (op.entryTime) {
                        try {
                            const hour = parseInt(op.entryTime.split(':')[0], 10);
                            if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                                hourlyPL[hour] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                            }
                        } catch (e) { /* ignore */ }
                    }
                });
                
                tiempoChartHourlyPL = new Chart(hourlyPLCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                        datasets: [{
                            label: 'P/L por Hora',
                            data: hourlyPL,
                            backgroundColor: hourlyPL.map(v => v >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0', maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 3: P/L por D√≠a de la Semana ===
            if (tiempoChartDailyPL) {
                tiempoChartDailyPL.destroy();
                tiempoChartDailyPL = null;
            }
            const dailyPLCtx = document.getElementById('tiempo-daily-pl-chart')?.getContext('2d');
            if (dailyPLCtx) {
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const dailyPL = Array(7).fill(0);
                operations.forEach(op => {
                    if (op.date) {
                        try {
                            const dayOfWeek = new Date(op.date + 'T00:00:00Z').getUTCDay();
                            dailyPL[dayOfWeek] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        } catch (e) { /* ignore */ }
                    }
                });
                
                tiempoChartDailyPL = new Chart(dailyPLCtx, {
                    type: 'bar',
                    data: {
                        labels: dayNames,
                        datasets: [{
                            label: 'P/L por D√≠a',
                            data: dailyPL,
                            backgroundColor: dailyPL.map(v => v >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 4: Distribuci√≥n de Duraci√≥n ===
            if (tiempoChartDurationDist) {
                tiempoChartDurationDist.destroy();
                tiempoChartDurationDist = null;
            }
            const durationDistCtx = document.getElementById('tiempo-duration-distribution-chart')?.getContext('2d');
            if (durationDistCtx) {
                const durations = [];
                operations.forEach(op => {
                    if (op.entryTime && op.exitTime) {
                        try {
                            const startDate = new Date(`1970-01-01T${op.entryTime}`);
                            const endDate = new Date(`1970-01-01T${op.exitTime}`);
                            let duration = (endDate - startDate) / 60000;
                            if (duration < 0) duration += 24 * 60;
                            durations.push(duration);
                        } catch (e) { /* ignore */ }
                    }
                });
                
                // Crear rangos: <15min, 15-30min, 30-60min, 1-2h, 2-4h, 4-8h, >8h
                const ranges = [15, 30, 60, 120, 240, 480, Infinity];
                const rangeLabels = ['<15min', '15-30min', '30-60min', '1-2h', '2-4h', '4-8h', '>8h'];
                const rangeCounts = Array(rangeLabels.length).fill(0);
                
                durations.forEach(d => {
                    for (let i = 0; i < ranges.length; i++) {
                        if (d < ranges[i]) {
                            rangeCounts[i]++;
                            break;
                        }
                    }
                });
                
                tiempoChartDurationDist = new Chart(durationDistCtx, {
                    type: 'bar',
                    data: {
                        labels: rangeLabels,
                        datasets: [{
                            label: 'N√∫mero de Trades',
                            data: rangeCounts,
                            backgroundColor: 'rgba(59,130,246,0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { color: '#a0a0a0', stepSize: 1 }
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // === NUEVA GR√ÅFICA: P/L por Rango de Duraci√≥n ===
            if (tiempoChartPLByDuration) {
                tiempoChartPLByDuration.destroy();
                tiempoChartPLByDuration = null;
            }
            const plByDurationCtx = document.getElementById('tiempo-pl-by-duration-chart')?.getContext('2d');
            if (plByDurationCtx) {
                const durationsWithPL = [];
                operations.forEach(op => {
                    if (op.entryTime && op.exitTime) {
                        try {
                            const startDate = new Date(`1970-01-01T${op.entryTime}`);
                            const endDate = new Date(`1970-01-01T${op.exitTime}`);
                            let duration = (endDate - startDate) / 60000;
                            if (duration < 0) duration += 24 * 60;
                            durationsWithPL.push({ duration, pl: convertCurrency(op.pl, op.currency, displayCurrency) });
                        } catch (e) { /* ignore */ }
                    }
                });
                
                // Crear rangos: <15min, 15-30min, 30-60min, 1-2h, 2-4h, 4-8h, >8h
                const ranges = [15, 30, 60, 120, 240, 480, Infinity];
                const rangeLabels = ['<15min', '15-30min', '30-60min', '1-2h', '2-4h', '4-8h', '>8h'];
                const rangePL = Array(rangeLabels.length).fill(0);
                const rangeCounts = Array(rangeLabels.length).fill(0);
                
                durationsWithPL.forEach(item => {
                    for (let i = 0; i < ranges.length; i++) {
                        if (item.duration < ranges[i]) {
                            rangePL[i] += item.pl;
                            rangeCounts[i]++;
                            break;
                        }
                    }
                });
                
                // Calcular P/L promedio por rango
                const rangeAvgPL = rangePL.map((total, idx) => rangeCounts[idx] > 0 ? total / rangeCounts[idx] : 0);
                
                // Colores seg√∫n positivo/negativo
                const colors = rangeAvgPL.map(pl => pl > 0 ? 'rgba(57, 255, 20, 0.8)' : 'rgba(255, 65, 54, 0.8)');
                
                tiempoChartPLByDuration = new Chart(plByDurationCtx, {
                    type: 'bar',
                    data: {
                        labels: rangeLabels,
                        datasets: [{
                            label: 'P/L Promedio',
                            data: rangeAvgPL,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'P/L Promedio: ' + formatCurrency(context.parsed.y, DB.settings.defaultCurrency, displayCurrency);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: function(value) {
                                        return formatCurrency(value, DB.settings.defaultCurrency, displayCurrency).replace(/\.\d+/, '');
                                    }
                                }
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // ===== HEAT MAP: HORA √ó D√çA DE LA SEMANA =====
            const heatmapContainer = document.getElementById('tiempo-heatmap-container');
            if (heatmapContainer) {
                // Estructura de datos: 7 d√≠as √ó 24 horas
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const heatmapData = Array(7).fill(null).map(() => Array(24).fill(0));
                const heatmapCounts = Array(7).fill(null).map(() => Array(24).fill(0));
                
                // Acumular P/L por d√≠a y hora
                operations.forEach(op => {
                    if (op.date && op.entryTime) {
                        try {
                            const dayOfWeek = new Date(op.date + 'T00:00:00Z').getUTCDay();
                            const hour = parseInt(op.entryTime.split(':')[0], 10);
                            if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                                heatmapData[dayOfWeek][hour] += convertCurrency(op.pl, op.currency, displayCurrency);
                                heatmapCounts[dayOfWeek][hour]++;
                            }
                        } catch (e) { /* ignore */ }
                    }
                });
                
                // Encontrar valores m√°ximo y m√≠nimo para escalar colores
                let maxPL = 0, minPL = 0;
                heatmapData.forEach(row => {
                    row.forEach(val => {
                        if (val > maxPL) maxPL = val;
                        if (val < minPL) minPL = val;
                    });
                });
                
                // Funci√≥n para obtener color basado en P/L
                function getHeatColor(value) {
                    if (value === 0) return '#2a2a2a'; // Sin datos
                    
                    const absMax = Math.max(Math.abs(maxPL), Math.abs(minPL));
                    const intensity = Math.abs(value) / absMax;
                    
                    if (value > 0) {
                        // Verde para ganancias
                        if (intensity > 0.7) return '#2ecc40'; // Verde oscuro
                        if (intensity > 0.4) return '#85e085'; // Verde claro
                        return '#c8f0c8'; // Verde muy claro
                    } else {
                        // Rojo para p√©rdidas
                        if (intensity > 0.7) return '#ff4136'; // Rojo oscuro
                        if (intensity > 0.4) return '#ff8577'; // Rojo claro
                        return '#ffb3ab'; // Rojo muy claro
                    }
                }
                
                // Generar HTML del heat map
                let html = `
                    <table class="w-full border-collapse" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th class="p-2 text-xs text-text-secondary border border-border" style="width: 60px;"></th>
                                ${Array.from({length: 24}, (_, i) => `<th class="p-1 text-xs text-text-secondary border border-border">${String(i).padStart(2, '0')}h</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                heatmapData.forEach((row, dayIndex) => {
                    html += `<tr>`;
                    html += `<td class="p-2 text-xs font-semibold text-white border border-border bg-surface">${dayNames[dayIndex]}</td>`;
                    row.forEach((value, hourIndex) => {
                        const color = getHeatColor(value);
                        const count = heatmapCounts[dayIndex][hourIndex];
                        const displayValue = value === 0 ? '-' : formatCurrency(value, DB.settings.defaultCurrency, displayCurrency);
                        const tooltip = count > 0 ? `${count} trade${count > 1 ? 's' : ''}: ${displayValue}` : 'Sin datos';
                        
                        html += `
                            <td class="p-2 text-center border border-border cursor-pointer hover:opacity-80 transition-opacity" 
                                style="background-color: ${color}; min-width: 40px; height: 40px;"
                                title="${tooltip}">
                                <div class="text-xs font-semibold" style="color: ${value === 0 ? '#666' : (Math.abs(value) / Math.max(Math.abs(maxPL), Math.abs(minPL)) > 0.5 ? '#fff' : '#000')};">
                                    ${count > 0 ? count : ''}
                                </div>
                            </td>
                        `;
                    });
                    html += `</tr>`;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                heatmapContainer.innerHTML = html;
            }
            
            // ===== NUEVAS GR√ÅFICAS: SESIONES Y EXPOSICI√ìN =====
            
            // Calcular m√©tricas por sesi√≥n de mercado
            const sessions = { Asia: {pl: 0, count: 0, wins: 0, total: 0}, Europa: {pl: 0, count: 0, wins: 0, total: 0}, America: {pl: 0, count: 0, wins: 0, total: 0} };
            let totalExposureWins = 0, totalExposureLosses = 0, countWins = 0, countLosses = 0;
            let totalMarketTime = 0;
            
            operations.forEach(op => {
                if (op.entryTime) {
                    const hour = parseInt(op.entryTime.split(':')[0]);
                    let session = 'America';
                    if (hour >= 0 && hour < 8) session = 'Asia';
                    else if (hour >= 8 && hour < 16) session = 'Europa';
                    
                    const pl = convertCurrency(op.pl, op.currency, displayCurrency);
                    sessions[session].pl += pl;
                    sessions[session].count++;
                    sessions[session].total++;
                    if (op.result === 'win') sessions[session].wins++;
                    
                    // Calcular duraci√≥n
                    if (op.exitTime) {
                        try {
                            const start = new Date(`1970-01-01T${op.entryTime}`);
                            const end = new Date(`1970-01-01T${op.exitTime}`);
                            let duration = (end - start) / (1000 * 60 * 60); // hours
                            if (duration < 0) duration += 24;
                            totalMarketTime += duration;
                            
                            if (op.result === 'win') {
                                totalExposureWins += duration;
                                countWins++;
                            } else if (op.result === 'loss') {
                                totalExposureLosses += duration;
                                countLosses++;
                            }
                        } catch(e) {}
                    }
                }
            });
            
            // Actualizar m√©tricas num√©ricas
            const marketExposureEl = document.getElementById('informe-tiempo-market-exposure');
            if (marketExposureEl) marketExposureEl.textContent = totalMarketTime.toFixed(1) + 'h';
            
            const avgExposureEl = document.getElementById('informe-tiempo-avg-exposure');
            if (avgExposureEl && operations.length > 0) {
                avgExposureEl.textContent = (totalMarketTime / operations.length).toFixed(2) + 'h';
            }
            
            // Calcular tiempo inactivo total (tiempo entre trades)
            let totalInactiveTime = 0;
            let maxInactiveTime = 0;
            let inactiveCount = 0;
            const sortedOps = [...operations].sort((a, b) => {
                const dateA = new Date(a.date + 'T' + (a.exitTime || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.exitTime || '00:00'));
                return dateA - dateB;
            });
            
            for (let i = 0; i < sortedOps.length - 1; i++) {
                const currentOp = sortedOps[i];
                const nextOp = sortedOps[i + 1];
                
                if (currentOp.exitTime && nextOp.entryTime) {
                    try {
                        const exitDateTime = new Date(currentOp.date + 'T' + currentOp.exitTime);
                        const entryDateTime = new Date(nextOp.date + 'T' + nextOp.entryTime);
                        const inactiveHours = (entryDateTime - exitDateTime) / (1000 * 60 * 60);
                        
                        if (inactiveHours > 0 && inactiveHours < 720) { // M√°ximo 30 d√≠as para evitar datos incorrectos
                            totalInactiveTime += inactiveHours;
                            inactiveCount++;
                            if (inactiveHours > maxInactiveTime) {
                                maxInactiveTime = inactiveHours;
                            }
                        }
                    } catch(e) { /* ignore */ }
                }
            }
            
            const avgInactiveTime = inactiveCount > 0 ? totalInactiveTime / inactiveCount : 0;
            
            // Actualizar elemento principal de tiempo inactivo
            const inactiveTimeEl = document.getElementById('informe-tiempo-inactive-time');
            if (inactiveTimeEl) {
                if (totalInactiveTime >= 24) {
                    inactiveTimeEl.textContent = (totalInactiveTime / 24).toFixed(1) + 'd';
                } else {
                    inactiveTimeEl.textContent = totalInactiveTime.toFixed(1) + 'h';
                }
            }
            
            // Actualizar elementos del gr√°fico de tiempo inactivo
            const inactiveTimeChartEl = document.getElementById('informe-tiempo-inactive-time-chart');
            if (inactiveTimeChartEl) {
                if (totalInactiveTime >= 24) {
                    inactiveTimeChartEl.textContent = (totalInactiveTime / 24).toFixed(1) + 'd';
                } else {
                    inactiveTimeChartEl.textContent = totalInactiveTime.toFixed(1) + 'h';
                }
            }
            
            const avgInactiveEl = document.getElementById('informe-tiempo-avg-inactive');
            if (avgInactiveEl) {
                if (avgInactiveTime >= 24) {
                    avgInactiveEl.textContent = (avgInactiveTime / 24).toFixed(1) + 'd';
                } else if (avgInactiveTime >= 1) {
                    avgInactiveEl.textContent = avgInactiveTime.toFixed(1) + 'h';
                } else {
                    avgInactiveEl.textContent = (avgInactiveTime * 60).toFixed(0) + 'min';
                }
            }
            
            const maxInactiveEl = document.getElementById('informe-tiempo-max-inactive');
            if (maxInactiveEl) {
                if (maxInactiveTime >= 24) {
                    maxInactiveEl.textContent = (maxInactiveTime / 24).toFixed(1) + 'd';
                } else if (maxInactiveTime >= 1) {
                    maxInactiveEl.textContent = maxInactiveTime.toFixed(1) + 'h';
                } else {
                    maxInactiveEl.textContent = (maxInactiveTime * 60).toFixed(0) + 'min';
                }
            }
            
            const bestSessionEl = document.getElementById('informe-tiempo-best-session');
            const worstSessionEl = document.getElementById('informe-tiempo-worst-session');
            const bestSession = Object.entries(sessions).sort((a,b) => b[1].pl - a[1].pl)[0];
            const worstSession = Object.entries(sessions).sort((a,b) => a[1].pl - b[1].pl)[0];
            if (bestSessionEl) bestSessionEl.textContent = `${bestSession[0]} (${formatCurrency(bestSession[1].pl, DB.settings.defaultCurrency, displayCurrency)})`;
            if (worstSessionEl) worstSessionEl.textContent = `${worstSession[0]} (${formatCurrency(worstSession[1].pl, DB.settings.defaultCurrency, displayCurrency)})`;
            
            // Gr√°fica 1: P/L por Sesi√≥n
            const sessionPLCtx = document.getElementById('tiempo-session-pl-chart')?.getContext('2d');
            if (sessionPLCtx) {
                tiempoSessionPLChart = new Chart(sessionPLCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Asia (00-08h)', 'Europa (08-16h)', 'Am√©rica (16-00h)'],
                        datasets: [{
                            label: 'P/L por Sesi√≥n',
                            data: [sessions.Asia.pl, sessions.Europa.pl, sessions.America.pl],
                            backgroundColor: [
                                sessions.Asia.pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)',
                                sessions.Europa.pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)',
                                sessions.America.pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 2: Trades por Sesi√≥n
            const sessionCountCtx = document.getElementById('tiempo-session-count-chart')?.getContext('2d');
            if (sessionCountCtx) {
                tiempoSessionCountChart = new Chart(sessionCountCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Asia (00-08h)', 'Europa (08-16h)', 'Am√©rica (16-00h)'],
                        datasets: [{
                            label: 'N√∫mero de Trades',
                            data: [sessions.Asia.count, sessions.Europa.count, sessions.America.count],
                            backgroundColor: 'rgba(59,130,246,0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', stepSize: 1 } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 3: Exposici√≥n Wins vs Losses
            if (tiempoChartExposureComparison) {
                tiempoChartExposureComparison.destroy();
                tiempoChartExposureComparison = null;
            }
            const exposureCompCtx = document.getElementById('tiempo-exposure-comparison-chart')?.getContext('2d');
            if (exposureCompCtx) {
                const avgExposureWin = countWins > 0 ? totalExposureWins / countWins : 0;
                const avgExposureLoss = countLosses > 0 ? totalExposureLosses / countLosses : 0;
                
                tiempoChartExposureComparison = new Chart(exposureCompCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Trades Ganadores', 'Trades Perdedores'],
                        datasets: [{
                            label: 'Tiempo Promedio (horas)',
                            data: [avgExposureWin, avgExposureLoss],
                            backgroundColor: ['rgba(57,255,20,0.7)', 'rgba(255,65,54,0.7)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.parsed.y.toFixed(2)} horas`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: (val) => val + 'h'
                                } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 4: Win Rate por Sesi√≥n
            if (tiempoChartSessionWinRate) {
                tiempoChartSessionWinRate.destroy();
                tiempoChartSessionWinRate = null;
            }
            const sessionWRCtx = document.getElementById('tiempo-session-winrate-chart')?.getContext('2d');
            if (sessionWRCtx) {
                const winRates = [
                    sessions.Asia.total > 0 ? (sessions.Asia.wins / sessions.Asia.total) * 100 : 0,
                    sessions.Europa.total > 0 ? (sessions.Europa.wins / sessions.Europa.total) * 100 : 0,
                    sessions.America.total > 0 ? (sessions.America.wins / sessions.America.total) * 100 : 0
                ];
                
                tiempoChartSessionWinRate = new Chart(sessionWRCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Asia (00-08h)', 'Europa (08-16h)', 'Am√©rica (16-00h)'],
                        datasets: [{
                            label: 'Win Rate (%)',
                            data: winRates,
                            backgroundColor: winRates.map(wr => wr >= 50 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `Win Rate: ${ctx.parsed.y.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                min: 0,
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: (val) => val + '%'
                                } 
                            },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }

            // === NUEVO: GR√ÅFICO SCATTER - CALIDAD DE EJECUCI√ìN ===
            if (tiempoChartExecutionQuality) {
                tiempoChartExecutionQuality.destroy();
                tiempoChartExecutionQuality = null;
            }
            const executionQualityCtx = document.getElementById('tiempo-execution-quality-scatter')?.getContext('2d');
            if (executionQualityCtx) {
                const scatterData = [];
                
                operations.forEach(op => {
                    if (op.entryTime && op.exitTime) {
                        try {
                            // Calcular duraci√≥n en horas
                            const startDate = new Date(`1970-01-01T${op.entryTime}`);
                            const endDate = new Date(`1970-01-01T${op.exitTime}`);
                            let duration = (endDate - startDate) / 3600000; // Horas
                            if (duration < 0) duration += 24;
                            
                            // Calcular m√∫ltiplo de R (asumiendo riesgo est√°ndar si no hay SL)
                            let rMultiple = 0;
                            const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                            
                            if (op.stopLoss && op.entryPrice) {
                                const risk = Math.abs(op.entryPrice - op.stopLoss) * (op.volume || 1);
                                rMultiple = risk > 0 ? pl / risk : (pl / 100); // Fallback si risk es 0
                            } else {
                                // Si no hay SL, usar un estimado basado en el P/L
                                rMultiple = pl / 100; // Asumiendo riesgo base de $100
                            }
                            
                            scatterData.push({
                                x: duration,
                                y: rMultiple,
                                pl: pl,
                                result: op.result
                            });
                        } catch (e) { /* ignore */ }
                    }
                });
                
                // Separar wins y losses para diferentes colores
                const winData = scatterData.filter(d => d.result === 'win' || d.pl > 0);
                const lossData = scatterData.filter(d => d.result === 'loss' || d.pl < 0);
                
                tiempoChartExecutionQuality = new Chart(executionQualityCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'Trades Ganadores',
                                data: winData,
                                backgroundColor: 'rgba(57, 255, 20, 0.6)',
                                borderColor: 'rgba(57, 255, 20, 1)',
                                borderWidth: 1,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            },
                            {
                                label: 'Trades Perdedores',
                                data: lossData,
                                backgroundColor: 'rgba(255, 65, 54, 0.6)',
                                borderColor: 'rgba(255, 65, 54, 1)',
                                borderWidth: 1,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    font: { size: 12 },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return [
                                            `Duraci√≥n: ${point.x.toFixed(2)} horas`,
                                            `R-Multiple: ${point.y.toFixed(2)}R`,
                                            `P/L: ${formatCurrency(point.pl, DB.settings.defaultCurrency, displayCurrency)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Duraci√≥n (Horas)',
                                    color: '#a0a0a0',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: (value) => value.toFixed(1) + 'h'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Resultado (M√∫ltiplos de Riesgo - R)',
                                    color: '#a0a0a0',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { 
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: true
                                },
                                ticks: { 
                                    color: '#a0a0a0',
                                    callback: (value) => value.toFixed(1) + 'R'
                                }
                            }
                        }
                    }
                });
                
                // Actualizar contador de trades
                const totalTradesEl = document.getElementById('tiempo-scatter-total-trades');
                if (totalTradesEl) totalTradesEl.textContent = scatterData.length;
            }
        }

        // Variables globales para charts de M√©tricas Avanzadas
        let metricasAvanzadasChartRachas = null;
        let metricasAvanzadasChartVolumen = null;
        let metricasAvanzadasChartSesiones = null;
        let metricasAvanzadasChartWinrateHorario = null;
        let metricasAvanzadasChartPlAfterWins = null;
        let metricasAvanzadasChartPlAfterLosses = null;
        let metricasAvanzadasChartRevenge = null;
        let metricasAvanzadasChartOvertrading = null;

        function refreshMetricasAvanzadas() {
            console.log('[M√©tricas Avanzadas] üîÑ Refreshing...');
            const selectedAccount = document.getElementById('informe-account-select').value;
            const currencySelect = document.getElementById('informe-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            
            console.log('[M√©tricas Avanzadas] Selected account:', selectedAccount);
            let operations = applyDateFilterToData(DB.operations);
            console.log('[M√©tricas Avanzadas] Operations after date filter:', operations.length);
            if (selectedAccount !== 'all') {
                operations = operations.filter(op => op.accountId === selectedAccount);
            }
            console.log('[M√©tricas Avanzadas] Operations after account filter:', operations.length);
            operations = applyInformeFilters(operations);
            console.log('[M√©tricas Avanzadas] Operations after additional filters:', operations.length);
            
            if (operations.length === 0) {
                document.getElementById('informe-metricas-avanzadas-content').innerHTML = '<div class="text-center p-8 text-text-secondary">No hay datos de operaciones para mostrar en el per√≠odo o cuenta seleccionada.</div>';
                return;
            }
            
            // === CALCULAR Y POBLAR M√âTRICAS PROFESIONALES ===
            const professionalMetrics = calculateProfessionalMetrics(operations, selectedAccount);
            
            document.getElementById('informe-expectancy-ratio').textContent = formatCurrency(professionalMetrics.expectancyRatio, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('informe-kelly-criterion').textContent = professionalMetrics.kellyCriterion.toFixed(2) + '%';
            document.getElementById('informe-sharpe-ratio').textContent = professionalMetrics.sharpeRatio.toFixed(2);
            document.getElementById('informe-sortino-ratio').textContent = professionalMetrics.sortinoRatio.toFixed(2);
            document.getElementById('informe-calmar-ratio').textContent = professionalMetrics.calmarRatio.toFixed(2);
            document.getElementById('informe-recovery-factor').textContent = professionalMetrics.recoveryFactor.toFixed(2);
            document.getElementById('informe-risk-of-ruin').textContent = professionalMetrics.riskOfRuin.toFixed(2) + '%';
            document.getElementById('informe-z-score').textContent = professionalMetrics.zScore.toFixed(2);
            document.getElementById('informe-avg-mae').textContent = formatCurrency(professionalMetrics.avgMAE, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('informe-avg-mfe').textContent = formatCurrency(professionalMetrics.avgMFE, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('informe-max-win-streak').textContent = professionalMetrics.maxWinStreak;
            document.getElementById('informe-max-loss-streak').textContent = professionalMetrics.maxLossStreak;
            document.getElementById('informe-consistency-score').textContent = professionalMetrics.consistencyScore;
            document.getElementById('informe-payoff-ratio').textContent = professionalMetrics.payoffRatio.toFixed(2);
            document.getElementById('informe-total-trading-days').textContent = professionalMetrics.totalTradingDays;
            document.getElementById('informe-avg-r-multiple').textContent = professionalMetrics.avgRMultiple.toFixed(2) + 'R';
            
            // Destruir charts anteriores
            if (metricasAvanzadasChartRachas) { metricasAvanzadasChartRachas.destroy(); metricasAvanzadasChartRachas = null; }
            if (metricasAvanzadasChartVolumen) { metricasAvanzadasChartVolumen.destroy(); metricasAvanzadasChartVolumen = null; }
            if (metricasAvanzadasChartSesiones) { metricasAvanzadasChartSesiones.destroy(); metricasAvanzadasChartSesiones = null; }
            if (metricasAvanzadasChartWinrateHorario) { metricasAvanzadasChartWinrateHorario.destroy(); metricasAvanzadasChartWinrateHorario = null; }
            if (metricasAvanzadasChartPlAfterWins) { metricasAvanzadasChartPlAfterWins.destroy(); metricasAvanzadasChartPlAfterWins = null; }
            if (metricasAvanzadasChartPlAfterLosses) { metricasAvanzadasChartPlAfterLosses.destroy(); metricasAvanzadasChartPlAfterLosses = null; }
            if (metricasAvanzadasChartRevenge) { metricasAvanzadasChartRevenge.destroy(); metricasAvanzadasChartRevenge = null; }
            if (metricasAvanzadasChartOvertrading) { metricasAvanzadasChartOvertrading.destroy(); metricasAvanzadasChartOvertrading = null; }
            
            // === GR√ÅFICA 1: Rachas Ganadoras/Perdedoras por Tipo (Long/Short) ===
            const longOps = operations.filter(op => op.type === 'buy');
            const shortOps = operations.filter(op => op.type === 'sell');
            
            const calcRachas = (ops) => {
                let maxWinStreak = 0, maxLossStreak = 0, currentWinStreak = 0, currentLossStreak = 0;
                const sortedOps = [...ops].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                sortedOps.forEach(op => {
                    if (op.pl > 0) {
                        currentWinStreak++;
                        currentLossStreak = 0;
                        if (currentWinStreak > maxWinStreak) maxWinStreak = currentWinStreak;
                    } else {
                        currentLossStreak++;
                        currentWinStreak = 0;
                        if (currentLossStreak > maxLossStreak) maxLossStreak = currentLossStreak;
                    }
                });
                return { maxWinStreak, maxLossStreak };
            };
            
            const longRachas = calcRachas(longOps);
            const shortRachas = calcRachas(shortOps);
            
            const rachasCtx = document.getElementById('metricas-avanzadas-rachas-chart')?.getContext('2d');
            if (rachasCtx) {
                metricasAvanzadasChartRachas = new Chart(rachasCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Long Wins', 'Long Losses', 'Short Wins', 'Short Losses'],
                        datasets: [{
                            label: 'Racha M√°xima',
                            data: [longRachas.maxWinStreak, longRachas.maxLossStreak, shortRachas.maxWinStreak, shortRachas.maxLossStreak],
                            backgroundColor: ['rgba(57,255,20,0.7)', 'rgba(255,65,54,0.7)', 'rgba(57,255,20,0.7)', 'rgba(255,65,54,0.7)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#a0a0a0', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#a0a0a0' }, grid: { display: false } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 2: Volumen de Ganancias/P√©rdidas Temporal ===
            const calcVolumen = (periodo) => {
                const wins = operations.filter(op => op.pl > 0);
                const losses = operations.filter(op => op.pl < 0);
                
                let volumenWins = 0, volumenLosses = 0;
                if (periodo === 'dia') {
                    volumenWins = wins.length / Math.max(1, new Set(wins.map(op => op.date)).size);
                    volumenLosses = losses.length / Math.max(1, new Set(losses.map(op => op.date)).size);
                } else if (periodo === 'semana') {
                    const getWeek = (date) => {
                        const d = new Date(date + 'T00:00:00Z');
                        return `${d.getUTCFullYear()}-W${Math.ceil((d.getUTCDate() + d.getUTCDay()) / 7)}`;
                    };
                    volumenWins = wins.length / Math.max(1, new Set(wins.map(op => getWeek(op.date))).size);
                    volumenLosses = losses.length / Math.max(1, new Set(losses.map(op => getWeek(op.date))).size);
                } else if (periodo === 'mes') {
                    volumenWins = wins.length / Math.max(1, new Set(wins.map(op => op.date.substring(0, 7))).size);
                    volumenLosses = losses.length / Math.max(1, new Set(losses.map(op => op.date.substring(0, 7))).size);
                }
                return { volumenWins, volumenLosses };
            };
            
            const volDia = calcVolumen('dia');
            const volSemana = calcVolumen('semana');
            const volMes = calcVolumen('mes');
            
            const volumenCtx = document.getElementById('metricas-avanzadas-volumen-chart')?.getContext('2d');
            if (volumenCtx) {
                metricasAvanzadasChartVolumen = new Chart(volumenCtx, {
                    type: 'bar',
                    data: {
                        labels: ['D√≠a', 'Semana', 'Mes'],
                        datasets: [
                            {
                                label: 'Wins Promedio',
                                data: [volDia.volumenWins, volSemana.volumenWins, volMes.volumenWins],
                                backgroundColor: 'rgba(57,255,20,0.7)'
                            },
                            {
                                label: 'Losses Promedio',
                                data: [volDia.volumenLosses, volSemana.volumenLosses, volMes.volumenLosses],
                                backgroundColor: 'rgba(255,65,54,0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, labels: { color: '#ffffff' } } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#a0a0a0' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#a0a0a0' }, grid: { display: false } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 3: Distribuci√≥n de P/L por Sesi√≥n de Trading ===
            // Asi√°tica: 00:00-08:00, Europea: 08:00-16:00, Americana: 16:00-24:00
            const sesiones = { asiatica: [], europea: [], americana: [] };
            operations.forEach(op => {
                if (op.entryTime) {
                    try {
                        const hour = parseInt(op.entryTime.split(':')[0], 10);
                        const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        if (hour >= 0 && hour < 8) sesiones.asiatica.push(pl);
                        else if (hour >= 8 && hour < 16) sesiones.europea.push(pl);
                        else if (hour >= 16 && hour < 24) sesiones.americana.push(pl);
                    } catch (e) { /* ignore */ }
                }
            });
            
            const avgAsiatica = sesiones.asiatica.length > 0 ? sesiones.asiatica.reduce((a, b) => a + b, 0) / sesiones.asiatica.length : 0;
            const avgEuropea = sesiones.europea.length > 0 ? sesiones.europea.reduce((a, b) => a + b, 0) / sesiones.europea.length : 0;
            const avgAmericana = sesiones.americana.length > 0 ? sesiones.americana.reduce((a, b) => a + b, 0) / sesiones.americana.length : 0;
            
            const sesionesCtx = document.getElementById('metricas-avanzadas-sesiones-chart')?.getContext('2d');
            if (sesionesCtx) {
                metricasAvanzadasChartSesiones = new Chart(sesionesCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Asi√°tica (0-8h)', 'Europea (8-16h)', 'Americana (16-24h)'],
                        datasets: [{
                            label: 'P/L Promedio',
                            data: [avgAsiatica, avgEuropea, avgAmericana],
                            backgroundColor: [
                                avgAsiatica >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)',
                                avgEuropea >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)',
                                avgAmericana >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: '#a0a0a0' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#a0a0a0' }, grid: { display: false } }
                        }
                    }
                });
            }
            
            // === GR√ÅFICA 4: Win Rate por Rango Horario (intervalos de 4 horas) ===
            const rangosHorarios = [
                { label: '0-4h', min: 0, max: 4, wins: 0, total: 0 },
                { label: '4-8h', min: 4, max: 8, wins: 0, total: 0 },
                { label: '8-12h', min: 8, max: 12, wins: 0, total: 0 },
                { label: '12-16h', min: 12, max: 16, wins: 0, total: 0 },
                { label: '16-20h', min: 16, max: 20, wins: 0, total: 0 },
                { label: '20-24h', min: 20, max: 24, wins: 0, total: 0 }
            ];
            
            operations.forEach(op => {
                if (op.entryTime) {
                    try {
                        const hour = parseInt(op.entryTime.split(':')[0], 10);
                        const rango = rangosHorarios.find(r => hour >= r.min && hour < r.max);
                        if (rango) {
                            rango.total++;
                            if (op.pl > 0) rango.wins++;
                        }
                    } catch (e) { /* ignore */ }
                }
            });
            
            const winRates = rangosHorarios.map(r => r.total > 0 ? (r.wins / r.total) * 100 : 0);
            
            const winrateHorarioCtx = document.getElementById('metricas-avanzadas-winrate-horario-chart')?.getContext('2d');
            if (winrateHorarioCtx) {
                metricasAvanzadasChartWinrateHorario = new Chart(winrateHorarioCtx, {
                    type: 'bar',
                    data: {
                        labels: rangosHorarios.map(r => r.label),
                        datasets: [{
                            label: 'Win Rate (%)',
                            data: winRates,
                            backgroundColor: winRates.map(wr => wr >= 50 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Win Rate: ${context.parsed.y.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                max: 100,
                                ticks: { color: '#a0a0a0', callback: (value) => value + '%' }, 
                                grid: { color: 'rgba(255,255,255,0.1)' } 
                            },
                            x: { ticks: { color: '#a0a0a0' }, grid: { display: false } }
                        }
                    }
                });
            }
            
            // ===== NUEVAS M√âTRICAS: AN√ÅLISIS PSICOL√ìGICO =====
            updatePsychologicalMetrics(operations, selectedAccount, displayCurrency);
        }
        
        // Nueva funci√≥n para An√°lisis Psicol√≥gico
        function updatePsychologicalMetrics(operations, selectedAccount, displayCurrency) {
            // Ordenar operaciones por fecha y hora
            const sortedOps = [...operations].sort((a, b) => {
                const dateA = new Date(a.date + 'T' + (a.entryTime || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.entryTime || '00:00'));
                return dateA - dateB;
            });
            
            // Calcular racha actual
            let currentStreak = 0;
            let currentStreakType = 'N/A';
            for (let i = sortedOps.length - 1; i >= 0; i--) {
                const op = sortedOps[i];
                if (i === sortedOps.length - 1) {
                    currentStreakType = op.result === 'win' ? 'Wins' : 'Losses';
                    currentStreak = 1;
                } else {
                    const prevType = currentStreakType === 'Wins' ? 'win' : 'loss';
                    if (op.result === prevType) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            // Calcular semanas consecutivas positivas/negativas
            const weeklyPL = {};
            sortedOps.forEach(op => {
                const week = op.date.substring(0, 10).replace(/-/g, ''); // Simple week grouping
                const weekKey = `${op.date.substring(0, 4)}-W${Math.ceil(parseInt(op.date.substring(5, 7)) * 4.33 / 12)}`;
                if (!weeklyPL[weekKey]) weeklyPL[weekKey] = 0;
                weeklyPL[weekKey] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
            });
            
            const weeks = Object.keys(weeklyPL).sort();
            let maxPositiveWeeks = 0, maxNegativeWeeks = 0;
            let currentPositive = 0, currentNegative = 0;
            weeks.forEach(week => {
                if (weeklyPL[week] > 0) {
                    currentPositive++;
                    currentNegative = 0;
                    if (currentPositive > maxPositiveWeeks) maxPositiveWeeks = currentPositive;
                } else if (weeklyPL[week] < 0) {
                    currentNegative++;
                    currentPositive = 0;
                    if (currentNegative > maxNegativeWeeks) maxNegativeWeeks = currentNegative;
                }
            });
            
            // Calcular √≠ndice de overtrading
            const dailyCount = {};
            sortedOps.forEach(op => {
                if (!dailyCount[op.date]) dailyCount[op.date] = 0;
                dailyCount[op.date]++;
            });
            const overtradingDays = Object.values(dailyCount).filter(count => count > 10).length;
            const overtradingIndex = Object.keys(dailyCount).length > 0 ? (overtradingDays / Object.keys(dailyCount).length) * 100 : 0;
            
            // Actualizar UI
            const currentStreakEl = document.getElementById('informe-current-streak');
            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            
            const currentStreakTypeEl = document.getElementById('informe-current-streak-type');
            if (currentStreakTypeEl) currentStreakTypeEl.textContent = `(${currentStreak} ${currentStreakType} consecutivos)`;
            
            const maxPosWeeksEl = document.getElementById('informe-max-positive-weeks');
            if (maxPosWeeksEl) maxPosWeeksEl.textContent = maxPositiveWeeks;
            
            const maxNegWeeksEl = document.getElementById('informe-max-negative-weeks');
            if (maxNegWeeksEl) maxNegWeeksEl.textContent = maxNegativeWeeks;
            
            const overtradingEl = document.getElementById('informe-overtrading-index');
            if (overtradingEl) overtradingEl.textContent = overtradingIndex.toFixed(1) + '%';
            
            // Gr√°fica 1: P/L Despu√©s de Rachas Ganadoras
            const plAfterWinsCtx = document.getElementById('metricas-avanzadas-pl-after-wins-chart')?.getContext('2d');
            if (plAfterWinsCtx) {
                const plAfterWinStreak = {'1 Win': [], '2 Wins': [], '3 Wins': [], '4+ Wins': []};
                let consecutiveWins = 0;
                
                sortedOps.forEach((op, idx) => {
                    if (idx > 0 && sortedOps[idx-1].result === 'win') {
                        consecutiveWins++;
                    } else {
                        consecutiveWins = 0;
                    }
                    
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    if (consecutiveWins === 1) plAfterWinStreak['1 Win'].push(pl);
                    else if (consecutiveWins === 2) plAfterWinStreak['2 Wins'].push(pl);
                    else if (consecutiveWins === 3) plAfterWinStreak['3 Wins'].push(pl);
                    else if (consecutiveWins >= 4) plAfterWinStreak['4+ Wins'].push(pl);
                });
                
                const labels = Object.keys(plAfterWinStreak);
                const avgPL = labels.map(label => {
                    const arr = plAfterWinStreak[label];
                    return arr.length > 0 ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
                });
                
                metricasAvanzadasChartPlAfterWins = new Chart(plAfterWinsCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P/L Promedio',
                            data: avgPL,
                            backgroundColor: avgPL.map(pl => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 2: P/L Despu√©s de Rachas Perdedoras
            const plAfterLossesCtx = document.getElementById('metricas-avanzadas-pl-after-losses-chart')?.getContext('2d');
            if (plAfterLossesCtx) {
                const plAfterLossStreak = {'1 Loss': [], '2 Losses': [], '3 Losses': [], '4+ Losses': []};
                let consecutiveLosses = 0;
                
                sortedOps.forEach((op, idx) => {
                    if (idx > 0 && sortedOps[idx-1].result === 'loss') {
                        consecutiveLosses++;
                    } else {
                        consecutiveLosses = 0;
                    }
                    
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    if (consecutiveLosses === 1) plAfterLossStreak['1 Loss'].push(pl);
                    else if (consecutiveLosses === 2) plAfterLossStreak['2 Losses'].push(pl);
                    else if (consecutiveLosses === 3) plAfterLossStreak['3 Losses'].push(pl);
                    else if (consecutiveLosses >= 4) plAfterLossStreak['4+ Losses'].push(pl);
                });
                
                const labels = Object.keys(plAfterLossStreak);
                const avgPL = labels.map(label => {
                    const arr = plAfterLossStreak[label];
                    return arr.length > 0 ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
                });
                
                metricasAvanzadasChartPlAfterLosses = new Chart(plAfterLossesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P/L Promedio',
                            data: avgPL,
                            backgroundColor: avgPL.map(pl => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 3: Revenge Trading Detector
            const revengeTradingCtx = document.getElementById('metricas-avanzadas-revenge-trading-chart')?.getContext('2d');
            if (revengeTradingCtx) {
                const revengeTrades = [];
                const normalTrades = [];
                
                sortedOps.forEach((op, idx) => {
                    if (idx > 0) {
                        const prevOp = sortedOps[idx - 1];
                        if (prevOp.result === 'loss') {
                            const prevTime = new Date(prevOp.date + 'T' + (prevOp.exitTime || '00:00'));
                            const currentTime = new Date(op.date + 'T' + (op.entryTime || '00:00'));
                            const diffMinutes = (currentTime - prevTime) / (1000 * 60);
                            
                            const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                            if (diffMinutes < 30) {
                                revengeTrades.push(pl);
                            } else {
                                normalTrades.push(pl);
                            }
                        } else {
                            normalTrades.push(convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency));
                        }
                    }
                });
                
                const avgRevenge = revengeTrades.length > 0 ? revengeTrades.reduce((a,b) => a+b, 0) / revengeTrades.length : 0;
                const avgNormal = normalTrades.length > 0 ? normalTrades.reduce((a,b) => a+b, 0) / normalTrades.length : 0;
                
                metricasAvanzadasChartRevenge = new Chart(revengeTradingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Revenge Trades (<30min)', 'Trades Normales'],
                        datasets: [{
                            label: 'P/L Promedio',
                            data: [avgRevenge, avgNormal],
                            backgroundColor: [
                                avgRevenge >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)',
                                avgNormal >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `P/L: $${ctx.parsed.y.toFixed(2)} (${ctx.label === 'Revenge Trades (<30min)' ? revengeTrades.length : normalTrades.length} trades)`
                                }
                            }
                        },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
            
            // Gr√°fica 4: Overtrading Analysis
            const overtradingCtx = document.getElementById('metricas-avanzadas-overtrading-chart')?.getContext('2d');
            if (overtradingCtx) {
                const tradeRanges = {'1-3': [], '4-6': [], '7-10': [], '>10': []};
                
                Object.entries(dailyCount).forEach(([date, count]) => {
                    const dayPL = sortedOps
                        .filter(op => op.date === date)
                        .reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
                    
                    if (count <= 3) tradeRanges['1-3'].push(dayPL);
                    else if (count <= 6) tradeRanges['4-6'].push(dayPL);
                    else if (count <= 10) tradeRanges['7-10'].push(dayPL);
                    else tradeRanges['>10'].push(dayPL);
                });
                
                const labels = Object.keys(tradeRanges);
                const avgPL = labels.map(label => {
                    const arr = tradeRanges[label];
                    return arr.length > 0 ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
                });
                
                metricasAvanzadasChartOvertrading = new Chart(overtradingCtx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => l + ' trades/d√≠a'),
                        datasets: [{
                            label: 'P/L Promedio Diario',
                            data: avgPL,
                            backgroundColor: avgPL.map(pl => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
            }
        }

        let informeChartPnLDesc = null;
        let informeChartPnLAsc = null;
        let informeChartWLDesc = null;
        let informeChartWLAsc = null;
        let informeChartVolumeSymbol = null;
        let informeChartDailyVolume = null;
        
        // Charts de Tiempo
        let tiempoChartDurationComp = null;
        let tiempoChartHourlyPL = null;
        let tiempoChartDailyPL = null;
        let tiempoChartDurationDist = null;
        let tiempoChartPLByDuration = null;
        let tiempoChartExecutionQuality = null; // NUEVO: Scatter chart
        let tiempoChartExposureComparison = null; // Gr√°fico de exposici√≥n wins vs losses
        let tiempoChartSessionWinRate = null; // Gr√°fico de win rate por sesi√≥n
        
        // Nuevas gr√°ficas de an√°lisis
        let plDistributionChart = null;
        let monthlyPerformanceChart = null;
        
        // NUEVAS M√âTRICAS DE BARRA - Gr√°ficos Chart.js
        let informeLongShortChart = null;
        let informeTradingStylesChart = null;
        let informePLRangeChart = null;
        let informeVolumeRangeChart = null;
        let informeSessionsChart = null;
        let informeWeekdayChart = null;
        let informeCommissionsChart = null;
        let informeRRChart = null;

        // Funci√≥n para destruir todos los gr√°ficos de Informe
        function destroyInformeCharts() {
            if (informeLongShortChart) { informeLongShortChart.destroy(); informeLongShortChart = null; }
            if (informeTradingStylesChart) { informeTradingStylesChart.destroy(); informeTradingStylesChart = null; }
            if (informePLRangeChart) { informePLRangeChart.destroy(); informePLRangeChart = null; }
            if (informeVolumeRangeChart) { informeVolumeRangeChart.destroy(); informeVolumeRangeChart = null; }
            if (informeSessionsChart) { informeSessionsChart.destroy(); informeSessionsChart = null; }
            if (informeWeekdayChart) { informeWeekdayChart.destroy(); informeWeekdayChart = null; }
            if (informeCommissionsChart) { informeCommissionsChart.destroy(); informeCommissionsChart = null; }
            if (informeRRChart) { informeRRChart.destroy(); informeRRChart = null; }
            if (plDistributionChart) { plDistributionChart.destroy(); plDistributionChart = null; }
            if (monthlyPerformanceChart) { monthlyPerformanceChart.destroy(); monthlyPerformanceChart = null; }
        }

        function refreshInforme() {
            console.log('[Informe] üîÑ Refreshing...');
            
            // Destruir todos los gr√°ficos existentes antes de recrear
            destroyInformeCharts();
            console.log("--- Refreshing Informe ---");

            const accountSelect = document.getElementById('informe-account-select');
            const currencySelect = document.getElementById('informe-currency-select');
            
            if (!accountSelect || !currencySelect) return;
            
            const selectedAccount = accountSelect.value;
            const displayCurrency = currencySelect.value;

            let operations = applyDateFilterToData(DB.operations);
            let finances = applyDateFilterToData(DB.finances);

            console.log('üîç Informe - Total operations before filter:', operations.length);
            console.log('üîç Informe - Selected account:', selectedAccount);

            if (selectedAccount !== 'all') {
                operations = operations.filter(op => op.accountId === selectedAccount);
                console.log('üîç Informe - Operations after account filter:', operations.length);
            }
            operations = applyInformeFilters(operations);
            console.log('üîç Informe - Operations after additional filters:', operations.length);

            // Solo operaciones principales para m√©tricas
            const mainOps = operations.filter(op => !op.parentId || op.parentId === '' || op.parentId === null);
            console.log('üîç Informe - Main operations (no parents):', mainOps.length);

            // Calcular m√©tricas solo con principales
            const basicMetrics = calculateMetrics(operations, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(operations, selectedAccount);
            const extraMetrics = calculateExtraAnalytics(operations, selectedAccount);

            // Calcular dep√≥sitos y retiros para totalMonetaryTransactions
            const totalDeposits = finances.filter(f => f.amount > 0).reduce((sum, f) => sum + convertCurrency(f.amount, f.currency, DB.settings.defaultCurrency), 0);
            const totalWithdrawals = finances.filter(f => f.amount < 0).reduce((sum, f) => sum + convertCurrency(f.amount, f.currency, DB.settings.defaultCurrency), 0);
            const totalMonetaryTransactions = totalDeposits + totalWithdrawals;

            const updateMetric = (id, value, currency = DB.settings.defaultCurrency, isPercent = false) => {
                const el = document.getElementById(id);
                if (!el) return;
                let formattedValue = isPercent ? `${value.toFixed(2)}%` : formatCurrency(value, currency, displayCurrency);
                el.textContent = formattedValue;
                el.classList.remove('text-positive', 'text-negative', 'text-neutral');
                if (value > 0) {
                    el.classList.add('text-positive');
                } else if (value < 0) {
                    el.classList.add('text-negative');
                } else {
                    el.classList.add('text-neutral');
                }
            };

            // M√©tricas principales
            const grossPLInforme = basicMetrics.totalWin + basicMetrics.totalLoss;
            const netPLInforme = grossPLInforme - basicMetrics.totalFees;
            updateMetric('informe-total-pl', grossPLInforme);
            updateMetric('informe-realized-pl', netPLInforme);
            updateMetric('informe-unrealized-pl', 0);
            updateMetric('informe-only-win-pl', basicMetrics.totalWin);
            updateMetric('informe-only-loss-pl', basicMetrics.totalLoss);
            updateMetric('informe-total-account-value', netPLInforme + totalMonetaryTransactions);
            updateMetric('informe-total-monetary-transactions', totalMonetaryTransactions);
            updateMetric('informe-total-deposits', totalDeposits);
            updateMetric('informe-total-withdrawals', totalWithdrawals);

            // Promedios y porcentajes
            updateMetric('informe-avg-pl-trade', advancedMetrics.avgPLPerTrade);
            updateMetric('informe-avg-pl-percentage', advancedMetrics.avgPLPercentage, DB.settings.defaultCurrency, true);
            updateMetric('informe-avg-pl-day', advancedMetrics.avgPLPerDay);
            updateMetric('informe-avg-pl-month', advancedMetrics.avgPLPerMonth);
            updateMetric('informe-avg-pl-year', advancedMetrics.avgPLPerYear);

            updateMetric('informe-avg-win-pl-trade', advancedMetrics.avgWin);
            updateMetric('informe-avg-win-pl-day', advancedMetrics.avgWinPerDay);
            updateMetric('informe-avg-win-pl-month', advancedMetrics.avgWinPerMonth);
            updateMetric('informe-avg-win-pl-year', advancedMetrics.avgWinPerYear);

            updateMetric('informe-avg-loss-pl-trade', advancedMetrics.avgLoss);
            updateMetric('informe-avg-loss-pl-day', advancedMetrics.avgLossPerDay);
            updateMetric('informe-avg-loss-pl-month', advancedMetrics.avgLossPerMonth);
            updateMetric('informe-avg-loss-pl-year', advancedMetrics.avgLossPerYear);

            updateMetric('informe-avg-win-pl-percentage', advancedMetrics.avgWinPercentage, DB.settings.defaultCurrency, true);
            updateMetric('informe-total-win-pl-percentage', advancedMetrics.totalWinPercentage, DB.settings.defaultCurrency, true);
            updateMetric('informe-avg-loss-pl-percentage', advancedMetrics.avgLossPercentage, DB.settings.defaultCurrency, true);
            updateMetric('informe-total-loss-pl-percentage', advancedMetrics.totalLossPercentage, DB.settings.defaultCurrency, true);

            updateMetric('informe-best-win-pl-trade', advancedMetrics.largestWin);
            updateMetric('informe-worst-loss-pl-trade', advancedMetrics.largestLoss);
            updateMetric('informe-best-win-pl-day', advancedMetrics.largestWinPerDay);
            updateMetric('informe-worst-loss-pl-day', advancedMetrics.largestLossPerDay);

            // M√©tricas de d√≠a, semana, mes, a√±o
            updateMetric('informe-last-day-pl', advancedMetrics.lastDayPL);
            updateMetric('informe-last-week-pl', advancedMetrics.lastWeekPL);
            updateMetric('informe-last-month-pl', advancedMetrics.lastMonthPL);
            updateMetric('informe-last-year-pl', advancedMetrics.lastYearPL);

            // Nuevas m√©tricas profesionales avanzadas
            const professionalMetrics = calculateProfessionalMetrics(operations, selectedAccount);
            
            updateMetric('informe-expectancy-ratio', professionalMetrics.expectancyRatio);
            updateMetric('informe-kelly-criterion', professionalMetrics.kellyCriterion, DB.settings.defaultCurrency, true);
            
            const sharpeEl = document.getElementById('informe-sharpe-ratio');
            if (sharpeEl) {
                sharpeEl.textContent = professionalMetrics.sharpeRatio.toFixed(2);
                sharpeEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                sharpeEl.classList.add(professionalMetrics.sharpeRatio > 1 ? 'text-positive' : 'text-white');
            }
            
            const sortinoEl = document.getElementById('informe-sortino-ratio');
            if (sortinoEl) {
                sortinoEl.textContent = professionalMetrics.sortinoRatio.toFixed(2);
                sortinoEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                sortinoEl.classList.add(professionalMetrics.sortinoRatio > 1 ? 'text-positive' : 'text-white');
            }
            
            const calmarEl = document.getElementById('informe-calmar-ratio');
            if (calmarEl) {
                calmarEl.textContent = professionalMetrics.calmarRatio.toFixed(2);
                calmarEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                calmarEl.classList.add(professionalMetrics.calmarRatio > 3 ? 'text-positive' : 'text-white');
            }
            
            updateMetric('informe-recovery-factor', professionalMetrics.recoveryFactor);
            updateMetric('informe-risk-of-ruin', professionalMetrics.riskOfRuin, DB.settings.defaultCurrency, true);
            
            const zScoreEl = document.getElementById('informe-z-score');
            if (zScoreEl) {
                zScoreEl.textContent = professionalMetrics.zScore.toFixed(2);
                zScoreEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                const absZ = Math.abs(professionalMetrics.zScore);
                zScoreEl.classList.add(absZ < 1.96 ? 'text-positive' : 'text-yellow');
            }
            
            updateMetric('informe-avg-mae', professionalMetrics.avgMAE);
            updateMetric('informe-avg-mfe', professionalMetrics.avgMFE);
            
            const maxWinStreakEl = document.getElementById('informe-max-win-streak');
            if (maxWinStreakEl) {
                maxWinStreakEl.textContent = professionalMetrics.maxWinStreak;
                maxWinStreakEl.classList.add('text-positive');
            }
            
            const maxLossStreakEl = document.getElementById('informe-max-loss-streak');
            if (maxLossStreakEl) {
                maxLossStreakEl.textContent = professionalMetrics.maxLossStreak;
                maxLossStreakEl.classList.add('text-negative');
            }
            
            const consistencyEl = document.getElementById('informe-consistency-score');
            if (consistencyEl) {
                consistencyEl.textContent = professionalMetrics.consistencyScore;
                consistencyEl.classList.remove('text-positive', 'text-negative', 'text-primary');
                consistencyEl.classList.add(professionalMetrics.consistencyScore >= 70 ? 'text-positive' : professionalMetrics.consistencyScore >= 50 ? 'text-primary' : 'text-yellow');
            }
            
            const payoffEl = document.getElementById('informe-payoff-ratio');
            if (payoffEl) {
                payoffEl.textContent = professionalMetrics.payoffRatio.toFixed(2);
                payoffEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                payoffEl.classList.add(professionalMetrics.payoffRatio > 1 ? 'text-positive' : 'text-white');
            }
            
            const tradingDaysEl = document.getElementById('informe-total-trading-days');
            if (tradingDaysEl) {
                tradingDaysEl.textContent = professionalMetrics.totalTradingDays;
                tradingDaysEl.classList.add('text-white');
            }
            
            const rMultipleEl = document.getElementById('informe-avg-r-multiple');
            if (rMultipleEl) {
                rMultipleEl.textContent = professionalMetrics.avgRMultiple.toFixed(2) + 'R';
                rMultipleEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                rMultipleEl.classList.add(professionalMetrics.avgRMultiple > 0 ? 'text-positive' : 'text-negative');
            }

            // === ACTUALIZAR BARRAS DE DISTRIBUCI√ìN WIN/LOSS ===
            console.log('üìä Distribuci√≥n - Total mainOps:', mainOps.length);
            console.log('üìä Distribuci√≥n - Selected Account:', selectedAccount);
            console.log('üìä Distribuci√≥n - Muestra de mainOps:', mainOps.slice(0, 3).map(op => ({
                id: op.id,
                accountId: op.accountId,
                pl: op.pl,
                result: op.result,
                instrument: op.instrument
            })));
            
            const winOps = mainOps.filter(op => op.result === 'win');
            const lossOps = mainOps.filter(op => op.result === 'loss');
            const breakevenOps = mainOps.filter(op => op.result === 'breakeven' || (!op.result && op.pl === 0));
            const totalOps = mainOps.length;
            
            console.log('üìä Wins:', winOps.length, 'Losses:', lossOps.length, 'Breakeven:', breakevenOps.length);
            console.log('üìä Operaciones sin result:', mainOps.filter(op => !op.result).length);
            
            const winCount = winOps.length;
            const lossCount = lossOps.length;
            const breakevenCount = breakevenOps.length;
            
            const winPercentage = totalOps > 0 ? (winCount / totalOps * 100) : 0;
            const lossPercentage = totalOps > 0 ? (lossCount / totalOps * 100) : 0;
            const breakevenPercentage = totalOps > 0 ? (breakevenCount / totalOps * 100) : 0;
            
            const totalWinAmount = winOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const totalLossAmount = lossOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            
            // Actualizar contadores y barras
            const winCountBarEl = document.getElementById('informe-win-count-bar');
            if (winCountBarEl) winCountBarEl.textContent = `${winCount} (${winPercentage.toFixed(1)}%)`;
            
            const lossCountBarEl = document.getElementById('informe-loss-count-bar');
            if (lossCountBarEl) lossCountBarEl.textContent = `${lossCount} (${lossPercentage.toFixed(1)}%)`;
            
            const breakevenCountBarEl = document.getElementById('informe-breakeven-count-bar');
            if (breakevenCountBarEl) breakevenCountBarEl.textContent = `${breakevenCount} (${breakevenPercentage.toFixed(1)}%)`;
            
            // Actualizar anchos de barras
            const winBarEl = document.getElementById('informe-win-bar');
            if (winBarEl) {
                winBarEl.style.width = `${winPercentage}%`;
                const winAmountEl = document.getElementById('informe-win-amount-bar');
                if (winAmountEl) winAmountEl.textContent = formatCurrency(totalWinAmount, DB.settings.defaultCurrency, displayCurrency);
            }
            
            const lossBarEl = document.getElementById('informe-loss-bar');
            if (lossBarEl) {
                lossBarEl.style.width = `${lossPercentage}%`;
                const lossAmountEl = document.getElementById('informe-loss-amount-bar');
                if (lossAmountEl) lossAmountEl.textContent = formatCurrency(totalLossAmount, DB.settings.defaultCurrency, displayCurrency);
            }
            
            const breakevenBarEl = document.getElementById('informe-breakeven-bar');
            if (breakevenBarEl) {
                breakevenBarEl.style.width = `${breakevenPercentage}%`;
                const breakevenCountText = document.getElementById('informe-breakeven-count-text');
                if (breakevenCountText) breakevenCountText.textContent = breakevenCount;
            }
            
            // Actualizar m√©tricas complementarias
            const winLossRatio = lossCount > 0 ? winCount / lossCount : winCount;
            const winLossRatioEl = document.getElementById('informe-win-loss-ratio-bar');
            if (winLossRatioEl) {
                winLossRatioEl.textContent = winLossRatio.toFixed(2);
                winLossRatioEl.classList.remove('text-positive', 'text-negative', 'text-neutral', 'text-primary', 'text-white');
                winLossRatioEl.classList.add(winLossRatio >= 1 ? 'text-positive' : 'text-negative');
            }
            
            // Expectativa matem√°tica: (Win% √ó AvgWin) - (Loss% √ó AvgLoss)
            const avgWinAmount = winCount > 0 ? totalWinAmount / winCount : 0;
            const avgLossAmount = lossCount > 0 ? Math.abs(totalLossAmount / lossCount) : 0;
            const mathExpectancy = (winPercentage / 100 * avgWinAmount) - (lossPercentage / 100 * avgLossAmount);
            
            const mathExpectancyEl = document.getElementById('informe-math-expectancy-bar');
            if (mathExpectancyEl) {
                mathExpectancyEl.textContent = formatCurrency(mathExpectancy, DB.settings.defaultCurrency, displayCurrency);
                mathExpectancyEl.classList.remove('text-positive', 'text-negative', 'text-neutral');
                mathExpectancyEl.classList.add(mathExpectancy > 0 ? 'text-positive' : mathExpectancy < 0 ? 'text-negative' : 'text-neutral');
            }

            const symbolPerformance = {};
            operations.forEach(op => {
                if (!op.instrument) return;
                const symbol = op.instrument.toUpperCase();
                if (!symbolPerformance[symbol]) {
                    symbolPerformance[symbol] = { pnl: 0, wins: 0, losses: 0, trades: 0, volume: 0 };
                }
                symbolPerformance[symbol].pnl += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                symbolPerformance[symbol].trades++;
                symbolPerformance[symbol].volume += op.volume;
                if (op.result === 'win') {
                    symbolPerformance[symbol].wins++;
                } else if (op.result === 'loss') {
                    symbolPerformance[symbol].losses++;
                }
            });

            const sortedByPnL = Object.entries(symbolPerformance).sort(([,a],[,b]) => b.pnl - a.pnl);
            const sortedByWL = Object.entries(symbolPerformance).sort(([,a],[,b]) => (b.wins - b.losses) - (a.wins - a.losses));
            const sortedByVolume = Object.entries(symbolPerformance).sort(([,a],[,b]) => b.volume - a.volume);

            updateInformeChart('informe-chart-pnl-desc', sortedByPnL.slice(0, 10), 'pnl', 'PnL por S√≠mbolo (Top 10 Ganadores)');
            updateInformeChart('informe-chart-pnl-asc', sortedByPnL.slice(-10).reverse(), 'pnl', 'PnL por S√≠mbolo (Top 10 Perdedores)');
            updateInformeWLChart('informe-chart-wl-desc', sortedByWL.slice(0, 10), 'Wins/Losses por S√≠mbolo (Mejor Ratio)');
            updateInformeWLChart('informe-chart-wl-asc', sortedByWL.slice(-10).reverse(), 'Wins/Losses por S√≠mbolo (Peor Ratio)');
            updateInformeVolumeChart('informe-chart-volume-symbol', sortedByVolume.slice(0, 10), 'Volumen por S√≠mbolo');
            
            // Agregado por fecha para Daily Volume
            const dailyVolume = {};
            operations.forEach(op => {
                const date = op.date;
                if (!dailyVolume[date]) {
                    dailyVolume[date] = 0;
                }
                dailyVolume[date] += op.volume;
            });
            
            const sortedByDate = Object.entries(dailyVolume).sort(([a], [b]) => new Date(a) - new Date(b));
            updateInformeDailyVolumeChart('informe-chart-daily-volume', sortedByDate, 'Volumen Diario');
            
            // ============ NUEVAS M√âTRICAS DE BARRA - GR√ÅFICOS CHART.JS ============
            
            // M√âTRICA 3: Distribuci√≥n Long/Short
            const longOps = mainOps.filter(op => {
                const opType = (op.type || op.side || '').toLowerCase().trim();
                return opType === 'long' || opType === 'buy' || opType === 'compra';
            });
            const shortOps = mainOps.filter(op => {
                const opType = (op.type || op.side || '').toLowerCase().trim();
                return opType === 'short' || opType === 'sell' || opType === 'venta';
            });
            const longPL = longOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            const shortPL = shortOps.reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);
            
            console.log(`[Long/Short] Total operations: ${mainOps.length}`);
            console.log(`[Long/Short] Long: ${longOps.length} trades, P/L: $${longPL.toFixed(2)}`);
            console.log(`[Long/Short] Short: ${shortOps.length} trades, P/L: $${shortPL.toFixed(2)}`);
            if (mainOps.length > 0) {
                console.log(`[Long/Short] Sample op.type:`, mainOps[0].type, 'op.side:', mainOps[0].side);
            }
            updateLongShortChart(longOps.length, shortOps.length, longPL, shortPL, displayCurrency);
            
            // M√âTRICA 3b: Trading Styles por duraci√≥n
            const scalpingOps = mainOps.filter(op => (op.duration_minutes || 0) < 15);
            const dayTradingOps = mainOps.filter(op => {
                const dur = op.duration_minutes || 0;
                return dur >= 15 && dur < 480;
            });
            const swingOps = mainOps.filter(op => (op.duration_minutes || 0) >= 480);
            
            console.log(`[Trading Styles] Scalping: ${scalpingOps.length}, Day: ${dayTradingOps.length}, Swing: ${swingOps.length}, Total mainOps: ${mainOps.length}`);
            updateTradingStylesChart(scalpingOps.length, dayTradingOps.length, swingOps.length);
            
            // M√âTRICA 1: Distribuci√≥n de P/L por Rango
            const plRanges = {
                'P√©rdidas Grandes\n(< -$500)': mainOps.filter(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency) < -500).length,
                'P√©rdidas Medianas\n(-$500 a -$200)': mainOps.filter(op => {
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    return pl >= -500 && pl < -200;
                }).length,
                'P√©rdidas Peque√±as\n(-$200 a -$50)': mainOps.filter(op => {
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    return pl >= -200 && pl < -50;
                }).length,
                'Peque√±as Ganancias\n($50 a $200)': mainOps.filter(op => {
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    return pl >= 50 && pl < 200;
                }).length,
                'Ganancias Medianas\n($200 a $500)': mainOps.filter(op => {
                    const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    return pl >= 200 && pl < 500;
                }).length,
                'Ganancias Grandes\n(> $500)': mainOps.filter(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency) >= 500).length
            };
            
            updatePLRangeChart(plRanges);
            
            // M√âTRICA 2: Distribuci√≥n de Volumen por Rango
            const volRanges = {
                'Micro Lotes\n(0.01-0.1)': mainOps.filter(op => op.volume >= 0.01 && op.volume < 0.1).length,
                'Lotes Peque√±os\n(0.1-0.5)': mainOps.filter(op => op.volume >= 0.1 && op.volume < 0.5).length,
                'Lotes Medianos\n(0.5-1.0)': mainOps.filter(op => op.volume >= 0.5 && op.volume < 1.0).length,
                'Lotes Grandes\n(1.0-5.0)': mainOps.filter(op => op.volume >= 1.0 && op.volume < 5.0).length,
                'Lotes Muy Grandes\n(> 5.0)': mainOps.filter(op => op.volume >= 5.0).length
            };
            
            updateVolumeRangeChart(volRanges);
            
            // M√âTRICA 4: Distribuci√≥n de Sesiones de Trading
            const sessions = {
                asian: { ops: [], pl: 0 },
                european: { ops: [], pl: 0 },
                american: { ops: [], pl: 0 }
            };
            
            mainOps.forEach(op => {
                const hour = new Date(op.entry).getUTCHours();
                const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                if (hour >= 23 || hour < 8) {
                    sessions.asian.ops.push(op);
                    sessions.asian.pl += pl;
                } else if (hour >= 8 && hour < 16) {
                    sessions.european.ops.push(op);
                    sessions.european.pl += pl;
                } else {
                    sessions.american.ops.push(op);
                    sessions.american.pl += pl;
                }
            });
            
            updateSessionsChart(sessions, displayCurrency);
            
            // M√âTRICA 7: Distribuci√≥n por d√≠a de la semana
            const weekdays = {
                'Lunes': { ops: [], pl: 0 },
                'Martes': { ops: [], pl: 0 },
                'Mi√©rcoles': { ops: [], pl: 0 },
                'Jueves': { ops: [], pl: 0 },
                'Viernes': { ops: [], pl: 0 }
            };
            
            const dayMap = ['sunday', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'saturday'];
            mainOps.forEach(op => {
                const dayName = dayMap[new Date(op.entry).getDay()];
                if (weekdays[dayName]) {
                    weekdays[dayName].ops.push(op);
                    weekdays[dayName].pl += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                }
            });
            
            updateWeekdayChart(weekdays, displayCurrency);
            
            // M√âTRICA 5: Distribuci√≥n de Comisiones
            const commRanges = {
                'Muy Bajas\n($0-$5)': mainOps.filter(op => {
                    const c = Math.abs(op.fee || op.fees || 0);
                    return c < 5;
                }).length,
                'Bajas\n($5-$20)': mainOps.filter(op => {
                    const c = Math.abs(op.fee || op.fees || 0);
                    return c >= 5 && c < 20;
                }).length,
                'Medianas\n($20-$50)': mainOps.filter(op => {
                    const c = Math.abs(op.fee || op.fees || 0);
                    return c >= 20 && c < 50;
                }).length,
                'Altas\n($50-$100)': mainOps.filter(op => {
                    const c = Math.abs(op.fee || op.fees || 0);
                    return c >= 50 && c < 100;
                }).length,
                'Muy Altas\n(> $100)': mainOps.filter(op => Math.abs(op.fee || op.fees || 0) >= 100).length
            };
            
            updateCommissionsChart(commRanges);
            
            // M√âTRICA 6: Distribuci√≥n de R:R
            const rrRanges = {
                'Desfavorable\n(< 1:1)': mainOps.filter(op => (op.risk_reward_ratio || 0) < 1).length,
                'Conservador\n(1:1 a 1:1.5)': mainOps.filter(op => {
                    const rr = op.risk_reward_ratio || 0;
                    return rr >= 1 && rr < 1.5;
                }).length,
                'Equilibrado\n(1:1.5 a 1:2)': mainOps.filter(op => {
                    const rr = op.risk_reward_ratio || 0;
                    return rr >= 1.5 && rr < 2;
                }).length,
                'Favorable\n(1:2 a 1:3)': mainOps.filter(op => {
                    const rr = op.risk_reward_ratio || 0;
                    return rr >= 2 && rr < 3;
                }).length,
                'Excelente\n(> 1:3)': mainOps.filter(op => (op.risk_reward_ratio || 0) >= 3).length
            };
            
            updateRRChart(rrRanges);
            
            // ============ FIN NUEVAS M√âTRICAS DE BARRA ============
            
            console.log(`üìä Calling chart functions with ${mainOps.length} mainOps`);
            // Nuevas gr√°ficas de an√°lisis (usando mainOps para excluir parciales)
            updatePLDistributionHistogram(mainOps, displayCurrency);
            updateMonthlyPerformanceChart(mainOps, displayCurrency);
            
            // Refrescar gr√°ficos de la pesta√±a Gr√°ficos si est√° activa o si existen los canvas
            const graficosContent = document.getElementById('informe-graficos-content');
            console.log('[Graficos] Contenedor encontrado:', !!graficosContent);
            console.log('[Graficos] Funci√≥n disponible:', typeof window.refreshGraficosCharts);
            
            if (graficosContent) {
                if (typeof window.refreshGraficosCharts === 'function') {
                    console.log('[Graficos] ‚úÖ Llamando a refreshGraficosCharts...');
                    window.refreshGraficosCharts();
                } else {
                    console.warn('[Graficos] ‚ö†Ô∏è refreshGraficosCharts no est√° definida a√∫n');
                }
            }
        }

        function updateInformeVolumeChart(canvasId, data, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            if (informeChartVolumeSymbol) {
                informeChartVolumeSymbol.destroy();
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [{
                        label: label,
                        data: data.map(item => item[1].volume),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });

            informeChartVolumeSymbol = chart;
        }

        function updateInformeDailyVolumeChart(canvasId, data, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            if (informeChartDailyVolume) {
                informeChartDailyVolume.destroy();
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [{
                        label: label,
                        data: data.map(item => item[1]),
                        backgroundColor: 'rgba(57, 255, 20, 0.7)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });

            informeChartDailyVolume = chart;
        }
        
        // ============ FUNCIONES DE GR√ÅFICOS DE DISTRIBUCI√ìN ============
        
        function updateLongShortChart(longCount, shortCount, longPL, shortPL, displayCurrency) {
            const canvas = document.getElementById('informe-long-short-chart');
            if (!canvas) {
                console.warn('[Long/Short] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('[Long/Short] Could not get context');
                return;
            }
            
            // Destruir gr√°fico anterior
            if (informeLongShortChart) {
                informeLongShortChart.destroy();
                informeLongShortChart = null;
            }
            
            const currSymbol = displayCurrency === 'EUR' ? '‚Ç¨' : displayCurrency === 'USD' ? '$' : displayCurrency;
            const totalCount = longCount + shortCount;
            
            // Verificar que hay datos
            if (totalCount === 0) {
                console.log('No data for Long/Short chart');
                // Mostrar gr√°fico vac√≠o
                informeLongShortChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Long', 'Short', 'Total'],
                        datasets: [{
                            label: 'Cantidad de Trades',
                            data: [0, 0, 0],
                            backgroundColor: ['rgba(156, 163, 175, 0.5)', 'rgba(156, 163, 175, 0.5)', 'rgba(156, 163, 175, 0.5)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                        }
                    }
                });
                return;
            }
            
            console.log(`Creating Long/Short chart: Long=${longCount}, Short=${shortCount}, Total=${totalCount}`);
            
            // Colores: Verde fluorescente para Long, Rojo para Short, Azul para Total
            informeLongShortChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Long (Compras)', 'Short (Ventas)', 'Total'],
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: [longCount, shortCount, totalCount],
                        backgroundColor: [
                            'rgba(57, 255, 20, 0.8)',  // Verde fluorescente
                            'rgba(239, 68, 68, 0.8)',  // Rojo
                            'rgba(59, 130, 246, 0.8)'  // Azul
                        ],
                        borderColor: [
                            'rgba(57, 255, 20, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    if (idx === 0) return 'P/L: ' + currSymbol + longPL.toFixed(2);
                                    if (idx === 1) return 'P/L: ' + currSymbol + shortPL.toFixed(2);
                                    if (idx === 2) return 'P/L: ' + currSymbol + (longPL + shortPL).toFixed(2);
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0' },
                            title: { display: true, text: 'Cantidad de Trades', color: '#a0a0a0' }
                        },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
        }
        
        function updateTradingStylesChart(scalpingCount, dayTradingCount, swingCount) {
            const canvas = document.getElementById('informe-trading-styles-chart');
            if (!canvas) {
                console.warn('[Trading Styles] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeTradingStylesChart) {
                informeTradingStylesChart.destroy();
                informeTradingStylesChart = null;
            }
            
            const total = scalpingCount + dayTradingCount + swingCount;
            
            // Colores: Azul, Verde fluorescente, Gris
            informeTradingStylesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Scalping\n(<15min)', 'Day Trading\n(15min-8h)', 'Swing Trading\n(>8h)'],
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: [scalpingCount, dayTradingCount, swingCount],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Azul
                            'rgba(57, 255, 20, 0.8)',    // Verde fluorescente
                            'rgba(156, 163, 175, 0.8)'   // Gris
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(57, 255, 20, 1)',
                            'rgba(156, 163, 175, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = total > 0 ? ((context.parsed.x / total) * 100).toFixed(1) : '0.0';
                                    return context.parsed.x + ' trades (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0' },
                            title: { display: true, text: 'Cantidad', color: '#a0a0a0' }
                        },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
        }
        
        function updatePLRangeChart(ranges) {
            const canvas = document.getElementById('informe-pl-range-chart');
            if (!canvas) {
                console.warn('[P/L Range] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            console.log('[P/L Range] Creating chart with data:', ranges);
            
            // Destruir gr√°fico anterior
            if (informePLRangeChart) {
                informePLRangeChart.destroy();
                informePLRangeChart = null;
            }
            
            const labels = Object.keys(ranges);
            const data = Object.values(ranges);
            const colors = [
                'rgba(185, 28, 28, 0.8)',   // Rojo oscuro - P√©rdidas grandes
                'rgba(239, 68, 68, 0.8)',   // Rojo - P√©rdidas medianas
                'rgba(248, 113, 113, 0.8)', // Rojo claro - P√©rdidas peque√±as
                'rgba(134, 239, 172, 0.8)', // Verde claro - Ganancias peque√±as
                'rgba(57, 255, 20, 0.8)',   // Verde fluorescente - Ganancias medianas
                'rgba(34, 197, 94, 0.8)'    // Verde oscuro - Ganancias grandes
            ];
            
            informePLRangeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.7', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' trades';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' }, title: { display: true, text: 'Cantidad de Trades', color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 10 } } }
                    }
                }
            });
        }
        
        function updateVolumeRangeChart(ranges) {
            const canvas = document.getElementById('informe-volume-range-chart');
            if (!canvas) {
                console.warn('[Volume Range] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeVolumeRangeChart) {
                informeVolumeRangeChart.destroy();
                informeVolumeRangeChart = null;
            }
            
            informeVolumeRangeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Azul oscuro
                            'rgba(96, 165, 250, 0.8)',   // Azul medio
                            'rgba(147, 197, 253, 0.8)',  // Azul claro
                            'rgba(156, 163, 175, 0.8)',  // Gris medio
                            'rgba(107, 114, 128, 0.8)'   // Gris oscuro
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' trades';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' }, title: { display: true, text: 'Cantidad', color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 10 } } }
                    }
                }
            });
        }
        
        function updateSessionsChart(sessions, displayCurrency) {
            const canvas = document.getElementById('informe-sessions-chart');
            if (!canvas) {
                console.warn('[Sessions] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeSessionsChart) {
                informeSessionsChart.destroy();
                informeSessionsChart = null;
            }
            
            const currSymbol = displayCurrency === 'EUR' ? '‚Ç¨' : displayCurrency === 'USD' ? '$' : displayCurrency;
            const totalCount = sessions.asian.ops.length + sessions.european.ops.length + sessions.american.ops.length;
            const totalPL = sessions.asian.pl + sessions.european.pl + sessions.american.pl;
            
            // Colores: Azul (Asi√°tica), Verde fluorescente (Europea), Rojo (Americana), Gris (Total)
            informeSessionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Asi√°tica\n(23:00-08:00)', 'Europea\n(08:00-16:00)', 'Americana\n(16:00-23:00)', 'Total'],
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: [sessions.asian.ops.length, sessions.european.ops.length, sessions.american.ops.length, totalCount],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Azul
                            'rgba(57, 255, 20, 0.8)',    // Verde fluorescente
                            'rgba(239, 68, 68, 0.8)',    // Rojo
                            'rgba(156, 163, 175, 0.8)'   // Gris
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(57, 255, 20, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(156, 163, 175, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    if (idx === 0) return 'P/L: ' + currSymbol + sessions.asian.pl.toFixed(2);
                                    if (idx === 1) return 'P/L: ' + currSymbol + sessions.european.pl.toFixed(2);
                                    if (idx === 2) return 'P/L: ' + currSymbol + sessions.american.pl.toFixed(2);
                                    if (idx === 3) return 'P/L: ' + currSymbol + totalPL.toFixed(2);
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0' },
                            title: { display: true, text: 'Cantidad', color: '#a0a0a0' }
                        },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 10 } } }
                    }
                }
            });
        }
        
        function updateWeekdayChart(weekdays, displayCurrency) {
            const canvas = document.getElementById('informe-weekday-chart');
            if (!canvas) {
                console.warn('[Weekday] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeWeekdayChart) {
                informeWeekdayChart.destroy();
                informeWeekdayChart = null;
            }
            
            const currSymbol = displayCurrency === 'EUR' ? '‚Ç¨' : displayCurrency === 'USD' ? '$' : displayCurrency;
            const labels = Object.keys(weekdays);
            const counts = labels.map(day => weekdays[day].ops.length);
            const pls = labels.map(day => weekdays[day].pl);
            const totalCount = counts.reduce((a, b) => a + b, 0);
            const totalPL = pls.reduce((a, b) => a + b, 0);
            
            // Agregar Total al final
            const allLabels = [...labels, 'Total'];
            const allCounts = [...counts, totalCount];
            
            // Colores degradados de azul a verde fluorescente + gris para total
            informeWeekdayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allLabels,
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: allCounts,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Lunes - Azul
                            'rgba(96, 165, 250, 0.8)',   // Martes - Azul claro
                            'rgba(147, 197, 253, 0.8)',  // Mi√©rcoles - Azul m√°s claro
                            'rgba(134, 239, 172, 0.8)',  // Jueves - Verde claro
                            'rgba(57, 255, 20, 0.8)',    // Viernes - Verde fluorescente
                            'rgba(156, 163, 175, 0.8)'   // Total - Gris
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(96, 165, 250, 1)',
                            'rgba(147, 197, 253, 1)',
                            'rgba(134, 239, 172, 1)',
                            'rgba(57, 255, 20, 1)',
                            'rgba(156, 163, 175, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    if (idx < pls.length) return 'P/L: ' + currSymbol + pls[idx].toFixed(2);
                                    if (idx === pls.length) return 'P/L: ' + currSymbol + totalPL.toFixed(2);
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0' },
                            title: { display: true, text: 'Cantidad', color: '#a0a0a0' }
                        },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
        }
        
        function updateCommissionsChart(ranges) {
            const canvas = document.getElementById('informe-commissions-chart');
            if (!canvas) {
                console.warn('[Commissions] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeCommissionsChart) {
                informeCommissionsChart.destroy();
                informeCommissionsChart = null;
            }
            
            informeCommissionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(57, 255, 20, 0.8)',    // Verde fluorescente - Muy bajas
                            'rgba(134, 239, 172, 0.8)',  // Verde claro - Bajas
                            'rgba(156, 163, 175, 0.8)',  // Gris - Medianas
                            'rgba(251, 113, 133, 0.8)',  // Rojo claro - Altas
                            'rgba(239, 68, 68, 0.8)'     // Rojo - Muy altas
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' trades';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' }, title: { display: true, text: 'Cantidad', color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 10 } } }
                    }
                }
            });
        }
        
        function updateRRChart(ranges) {
            const canvas = document.getElementById('informe-rr-chart');
            if (!canvas) {
                console.warn('[R:R] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fico anterior
            if (informeRRChart) {
                informeRRChart.destroy();
                informeRRChart = null;
            }
            
            informeRRChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',    // Rojo - Desfavorable
                            'rgba(251, 191, 36, 0.8)',   // Amarillo - Conservador
                            'rgba(59, 130, 246, 0.8)',   // Azul - Equilibrado
                            'rgba(134, 239, 172, 0.8)',  // Verde claro - Favorable
                            'rgba(57, 255, 20, 0.8)'     // Verde fluorescente - Excelente
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' trades';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' }, title: { display: true, text: 'Cantidad', color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 10 } } }
                    }
                }
            });
        }
        
        // ============ FIN FUNCIONES DE GR√ÅFICOS DE DISTRIBUCI√ìN ============
        
        // Nueva funci√≥n: Distribuci√≥n de P/L (Histograma)
        function updatePLDistributionHistogram(operations, displayCurrency) {
            const canvas = document.getElementById('pl-distribution-histogram-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if (plDistributionChart) plDistributionChart.destroy();
            
            // Extraer P/L de todas las operaciones
            const plValues = operations.map(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency));
            
            if (plValues.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            // Determinar rangos para el histograma
            const minPL = Math.min(...plValues);
            const maxPL = Math.max(...plValues);
            const range = maxPL - minPL;
            const binCount = Math.min(20, Math.max(5, Math.floor(Math.sqrt(plValues.length))));
            const binSize = range / binCount;
            
            // Crear bins
            const bins = Array(binCount).fill(0);
            const binLabels = [];
            
            for (let i = 0; i < binCount; i++) {
                const binStart = minPL + (i * binSize);
                const binEnd = binStart + binSize;
                binLabels.push(`$${binStart.toFixed(0)} - $${binEnd.toFixed(0)}`);
            }
            
            // Llenar bins
            plValues.forEach(pl => {
                const binIndex = Math.min(Math.floor((pl - minPL) / binSize), binCount - 1);
                bins[binIndex]++;
            });
            
            plDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Cantidad de Trades',
                        data: bins,
                        backgroundColor: bins.map((_, index) => {
                            const binMidPoint = minPL + (index + 0.5) * binSize;
                            return binMidPoint >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)';
                        }),
                        borderColor: bins.map((_, index) => {
                            const binMidPoint = minPL + (index + 0.5) * binSize;
                            return binMidPoint >= 0 ? 'rgba(57,255,20,1)' : 'rgba(255,65,54,1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Trades: ${ctx.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a0a0a0',
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Cantidad de Trades',
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a0a0a0',
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 9 }
                            },
                            title: {
                                display: true,
                                text: 'Rango de P/L',
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });
        }
        
        // Nueva funci√≥n: Performance por Mes (Barras comparativas)
        function updateMonthlyPerformanceChart(operations, displayCurrency) {
            console.log(`[Monthly Performance] Received ${operations.length} operations`);
            const canvas = document.getElementById('monthly-performance-chart');
            if (!canvas) {
                console.warn('[Monthly Performance] Canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            if (monthlyPerformanceChart) monthlyPerformanceChart.destroy();
            
            // Agrupar por mes
            const monthlyData = {};
            
            operations.forEach(op => {
                if (!op.date) return;
                const monthKey = op.date.substring(0, 7); // YYYY-MM
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        wins: 0,
                        losses: 0,
                        winPL: 0,
                        lossPL: 0
                    };
                }
                
                const pl = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                
                if (pl > 0) {
                    monthlyData[monthKey].wins++;
                    monthlyData[monthKey].winPL += pl;
                } else if (pl < 0) {
                    monthlyData[monthKey].losses++;
                    monthlyData[monthKey].lossPL += pl;
                }
            });
            
            // Ordenar por fecha
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            const winPLData = sortedMonths.map(m => monthlyData[m].winPL);
            const lossPLData = sortedMonths.map(m => monthlyData[m].lossPL);
            const netPLData = sortedMonths.map(m => monthlyData[m].winPL + monthlyData[m].lossPL);
            
            monthlyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ganancias',
                            data: winPLData,
                            backgroundColor: 'rgba(57,255,20,0.7)',
                            borderColor: 'rgba(57,255,20,1)',
                            borderWidth: 1,
                            stack: 'stack0'
                        },
                        {
                            label: 'P√©rdidas',
                            data: lossPLData,
                            backgroundColor: 'rgba(255,65,54,0.7)',
                            borderColor: 'rgba(255,65,54,1)',
                            borderWidth: 1,
                            stack: 'stack0'
                        },
                        {
                            label: 'P/L Neto',
                            data: netPLData,
                            type: 'line',
                            borderColor: 'rgba(135,206,250,1)',
                            backgroundColor: 'rgba(135,206,250,0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#ffffff', font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += '$' + Math.abs(context.parsed.y).toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: false,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (value) => '$' + value.toFixed(0)
                            },
                            title: {
                                display: true,
                                text: 'P/L ($)',
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a0a0a0',
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function updateInformeChart(canvasId, data, key, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            if (canvasId === 'informe-chart-pnl-desc') {
                if (informeChartPnLDesc) informeChartPnLDesc.destroy();
            } else if (canvasId === 'informe-chart-pnl-asc') {
                if (informeChartPnLAsc) informeChartPnLAsc.destroy();
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [{
                        label: label,
                        data: data.map(item => item[1][key]),
                        backgroundColor: data.map(item => item[1][key] >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'),
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });

            if (canvasId === 'informe-chart-pnl-desc') {
                informeChartPnLDesc = chart;
            } else if (canvasId === 'informe-chart-pnl-asc') {
                informeChartPnLAsc = chart;
            }
        }

        function updateInformeWLChart(canvasId, data, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

             if (canvasId === 'informe-chart-wl-desc') {
                if (informeChartWLDesc) informeChartWLDesc.destroy();
            } else if (canvasId === 'informe-chart-wl-asc') {
                if (informeChartWLAsc) informeChartWLAsc.destroy();
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [
                        {
                            label: 'Wins',
                            data: data.map(item => item[1].wins),
                            backgroundColor: 'rgba(57, 255, 20, 0.7)',
                        },
                        {
                            label: 'Losses',
                            data: data.map(item => -item[1].losses),
                            backgroundColor: 'rgba(255, 65, 54, 0.7)',
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0a0a0' } } },
                    scales: {
                        x: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });

            if (canvasId === 'informe-chart-wl-desc') {
                informeChartWLDesc = chart;
            } else if (canvasId === 'informe-chart-wl-asc') {
                informeChartWLAsc = chart;
            }
        }


        function refreshAnalytics() {
            console.log('üîÑ refreshAnalytics() iniciado');
            
            if (!document.getElementById('analytics').classList.contains('active')) {
                console.log('‚ö†Ô∏è Analytics no est√° activo, cancelando refresh');
                return;
            }
            
            const accountSelect = document.getElementById('analytics-account-select');
            const currencySelect = document.getElementById('analytics-currency-select');
            
            if (!accountSelect || !currencySelect) return;
            
            const selectedAccount = accountSelect.value;
            
            console.log('üìä Analytics - Cuenta seleccionada:', selectedAccount);
            console.log('üìÖ Analytics - Filtro de fecha:', globalDateFilter);
            console.log('üéØ Analytics - Filtros personalizados:', analyticsFilters);
            
            let operationsForAnalytics = applyDateFilterToData(DB.operations);
            console.log('üìÖ Despu√©s de filtro de fecha:', operationsForAnalytics.length, 'operaciones');
            
            if (selectedAccount !== 'all') {
                operationsForAnalytics = operationsForAnalytics.filter(op => op.accountId === selectedAccount);
                console.log('üë§ Despu√©s de filtro de cuenta:', operationsForAnalytics.length, 'operaciones');
            }
            
            // Aplicar filtros de Analytics
            operationsForAnalytics = applyAnalyticsFilters(operationsForAnalytics);
            console.log('üéØ Despu√©s de filtros personalizados:', operationsForAnalytics.length, 'operaciones');
            
            const displayCurrency = currencySelect.value;

            console.log('‚úÖ Analytics actualizado con', operationsForAnalytics.length, 'operaciones');

            const basicMetrics = calculateMetrics(operationsForAnalytics, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(operationsForAnalytics, selectedAccount);
            const extraMetrics = calculateExtraAnalytics(operationsForAnalytics, selectedAccount);
            const timeMetrics = calculateTimeMetrics(operationsForAnalytics);

            // AHORA calculateMetrics devuelve P/L BRUTO + totalFees por separado
            const grossPL = basicMetrics.totalWin + basicMetrics.totalLoss;
            const totalFees = basicMetrics.totalFees;
            const netPlAfterFees = grossPL - totalFees;
            
            const avgFee = basicMetrics.totalTrades > 0 ? totalFees / basicMetrics.totalTrades : 0;

            const totalPlEl = document.getElementById('analytics-total-pl');
            const plBrutoTradesEl = document.getElementById('analytics-pl-bruto-trades');
            if (totalPlEl) {
                // Mostrar P/L BRUTO con indicador
                const plLabel = totalPlEl.closest('.metric-card')?.querySelector('.text-sm');
                if (plLabel && !plLabel.textContent.includes('Bruto')) {
                    plLabel.textContent = 'P&L Bruto Total';
                }
                totalPlEl.textContent = formatCurrency(grossPL, DB.settings.defaultCurrency, displayCurrency);
                totalPlEl.className = `text-2xl font-bold mb-2 ${grossPL >= 0 ? 'text-green' : 'text-negative'}`;
                
                // Actualizar contador de trades
                if (plBrutoTradesEl) {
                    plBrutoTradesEl.textContent = `${basicMetrics.totalTrades} trades`;
                }
                
                // Crear gauge radial para P&L Bruto
                updatePlBrutoGauge(grossPL, basicMetrics.totalWin, basicMetrics.totalLoss);
            }

            // Actualizar Net P&L (despu√©s de restar comisiones)
            const netPlEl = document.getElementById('analytics-net-pl');
            if (netPlEl) {
                const netPL = netPlAfterFees; // Usar la variable calculada arriba
                const plLabel = netPlEl.closest('.metric-card')?.querySelector('.text-sm');
                if (plLabel && !plLabel.textContent.includes('Neto')) {
                    plLabel.textContent = 'P&L Neto Total (despu√©s de comisiones)';
                }
                netPlEl.textContent = formatCurrency(netPL, DB.settings.defaultCurrency, displayCurrency);
                netPlEl.className = `text-2xl font-bold mb-2 ${netPL >= 0 ? 'text-green' : 'text-red'}`;
                
                // Crear gauge radial para P&L Neto
                updatePlNetoGauge(netPL, basicMetrics.totalWin, basicMetrics.totalLoss, totalFees);
            }

            // Actualizar Win Rate
            const winRateEl = document.getElementById('analytics-win-rate');
            if (winRateEl) {
                winRateEl.textContent = basicMetrics.winRate.toFixed(2) + '%';
            }

            // Actualizar Profit Factor
            const pfEl = document.getElementById('analytics-profit-factor');
            if (pfEl) {
                pfEl.textContent = isFinite(basicMetrics.profitFactor) ? basicMetrics.profitFactor.toFixed(2) : "‚àû";
            }

            // Actualizar Total Trades
            const totalTradesEl = document.getElementById('analytics-total-trades');
            if (totalTradesEl) {
                totalTradesEl.textContent = basicMetrics.totalTrades;
            }

            // Actualizar Wins y Losses
            const winsEl = document.getElementById('analytics-wins');
            if (winsEl) winsEl.textContent = basicMetrics.winningTrades;
            
            const lossesEl = document.getElementById('analytics-losses');
            if (lossesEl) lossesEl.textContent = basicMetrics.losingTrades;

            // Calcular Day Win %
            const dayStats = calculateDayWinStats(operationsForAnalytics);
            const dayWinRateEl = document.getElementById('analytics-day-win-rate');
            if (dayWinRateEl) {
                dayWinRateEl.textContent = dayStats.dayWinRate.toFixed(2) + '%';
            }
            const dayWinsEl = document.getElementById('analytics-day-wins');
            if (dayWinsEl) dayWinsEl.textContent = dayStats.winningDays;
            
            const dayNeutralEl = document.getElementById('analytics-day-neutral');
            if (dayNeutralEl) dayNeutralEl.textContent = dayStats.breakevenDays;
            
            const dayLossesEl = document.getElementById('analytics-day-losses');
            if (dayLossesEl) dayLossesEl.textContent = dayStats.losingDays;

            // Actualizar Avg Win/Loss Trade
            const avgWinTradeEl = document.getElementById('analytics-avg-win-trade');
            if (avgWinTradeEl) {
                const avgWin = advancedMetrics.avgWin;
                avgWinTradeEl.textContent = formatCurrency(Math.abs(avgWin), DB.settings.defaultCurrency, displayCurrency);
            }

            const avgLossTradeEl = document.getElementById('analytics-avg-loss-trade');
            if (avgLossTradeEl) {
                const avgLoss = advancedMetrics.avgLoss;
                avgLossTradeEl.textContent = formatCurrency(Math.abs(avgLoss), DB.settings.defaultCurrency, displayCurrency);
            }

            // Calcular y actualizar el ratio y las barras
            const avgRatioEl = document.getElementById('analytics-avg-ratio');
            if (avgRatioEl && advancedMetrics.avgWin !== 0 && advancedMetrics.avgLoss !== 0) {
                const ratio = Math.abs(advancedMetrics.avgWin / advancedMetrics.avgLoss);
                avgRatioEl.textContent = ratio.toFixed(2);

                // Actualizar las barras de progreso
                const totalAbs = Math.abs(advancedMetrics.avgWin) + Math.abs(advancedMetrics.avgLoss);
                const winPercent = (Math.abs(advancedMetrics.avgWin) / totalAbs) * 100;
                const lossPercent = (Math.abs(advancedMetrics.avgLoss) / totalAbs) * 100;

                const winBarEl = document.getElementById('analytics-win-bar');
                if (winBarEl) winBarEl.style.width = winPercent.toFixed(1) + '%';

                const lossBarEl = document.getElementById('analytics-loss-bar');
                if (lossBarEl) lossBarEl.style.width = lossPercent.toFixed(1) + '%';
            }

            document.getElementById('analytics-win-rate').textContent = basicMetrics.winRate.toFixed(0) + '%';
            document.getElementById('analytics-profit-factor').textContent = isFinite(basicMetrics.profitFactor) ? basicMetrics.profitFactor.toFixed(2) : "‚àû";
            document.getElementById('analytics-total-trades').textContent = basicMetrics.totalTrades;

            // Mostrar comisiones
            document.getElementById('analytics-total-fees').textContent = formatCurrency(totalFees, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-avg-fee').textContent = formatCurrency(avgFee, DB.settings.defaultCurrency, displayCurrency);

            const feesTotal = document.getElementById('analytics-fees-total');
            if (feesTotal) feesTotal.textContent = formatCurrency(totalFees, DB.settings.defaultCurrency, displayCurrency);

            const netPlAfterFeesEl = document.getElementById('analytics-net-pl-after-fees');
            if (netPlAfterFeesEl) {
                netPlAfterFeesEl.textContent = formatCurrency(netPlAfterFees, DB.settings.defaultCurrency, displayCurrency);
                netPlAfterFeesEl.className = `font-bold ${netPlAfterFees >= 0 ? 'text-green' : 'text-red'}`;
            }

            document.getElementById('analytics-avg-win').textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-avg-loss').textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);

            const avgPlTradeEl = document.getElementById('analytics-avg-pl-trade');
            avgPlTradeEl.textContent = formatCurrency(advancedMetrics.avgPLPerTrade, DB.settings.defaultCurrency, displayCurrency);
            avgPlTradeEl.className = `font-semibold ${advancedMetrics.avgPLPerTrade >= 0 ? 'text-white' : 'text-negative'}`;

            const expectancyEl = document.getElementById('analytics-expectancy');
            expectancyEl.textContent = formatCurrency(advancedMetrics.expectancy, DB.settings.defaultCurrency, displayCurrency);
            expectancyEl.className = `font-semibold ${advancedMetrics.expectancy >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('analytics-largest-win').textContent = formatCurrency(advancedMetrics.largestWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-largest-loss').textContent = formatCurrency(advancedMetrics.largestLoss, DB.settings.defaultCurrency, displayCurrency);

            document.getElementById('analytics-longest-win-streak').textContent = advancedMetrics.longestWinStreak;
            document.getElementById('analytics-longest-loss-streak').textContent = advancedMetrics.longestLossStreak;
            document.getElementById('analytics-total-wins-count').textContent = basicMetrics.winningTrades;
            document.getElementById('analytics-total-losses-count').textContent = basicMetrics.losingTrades;
            document.getElementById('analytics-total-breakeven-count').textContent = basicMetrics.breakevenTrades;

            // Populate new extra metrics
            document.getElementById('analytics-max-drawdown').textContent = `${formatCurrency(extraMetrics.maxDrawdownValue, extraMetrics.currencyForDD, displayCurrency)} (${extraMetrics.maxDrawdownPercentage.toFixed(1)}%)`;
            const ddShortEl = document.getElementById('analytics-max-drawdown-short');
            if (ddShortEl) ddShortEl.textContent = formatCurrency(extraMetrics.maxDrawdownValue, extraMetrics.currencyForDD, displayCurrency);
            const avgWLRatioEl = document.getElementById('analytics-avg-wl-ratio');
            avgWLRatioEl.textContent = isFinite(extraMetrics.avgWLRatio) ? extraMetrics.avgWLRatio.toFixed(2) : "‚àû";
            avgWLRatioEl.className = `font-semibold ${extraMetrics.avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;
            document.getElementById('analytics-avg-hold-time').textContent = extraMetrics.avgHoldTimeText;
            document.getElementById('analytics-std-dev-pl').textContent = formatCurrency(extraMetrics.stdDevPL, DB.settings.defaultCurrency, displayCurrency);

            // Populate new time-based metrics
            const avgWinDurEl = document.getElementById('analytics-avg-win-duration');
            avgWinDurEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.avgWinDuration) : 'N/A';
            
            const avgLossDurEl = document.getElementById('analytics-avg-loss-duration');
            avgLossDurEl.textContent = timeMetrics.hasLosses ? formatDurationText(timeMetrics.avgLossDuration) : 'N/A';
            
            const bestHourEl = document.getElementById('analytics-best-hour');
            if (timeMetrics.bestHour >= 0) {
                bestHourEl.textContent = `${String(timeMetrics.bestHour).padStart(2, '0')}:00 (${formatCurrency(timeMetrics.bestHourPL, DB.settings.defaultCurrency, displayCurrency)})`;
            } else {
                bestHourEl.textContent = 'N/A';
            }
            
            const worstHourEl = document.getElementById('analytics-worst-hour');
            if (timeMetrics.worstHour >= 0) {
                worstHourEl.textContent = `${String(timeMetrics.worstHour).padStart(2, '0')}:00 (${formatCurrency(timeMetrics.worstHourPL, DB.settings.defaultCurrency, displayCurrency)})`;
            } else {
                worstHourEl.textContent = 'N/A';
            }
            
            const longestWinEl = document.getElementById('analytics-longest-win-duration');
            longestWinEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.longestWinDuration) : 'N/A';
            
            const longestLossEl = document.getElementById('analytics-longest-loss-duration');
            longestLossEl.textContent = timeMetrics.hasLosses ? formatDurationText(timeMetrics.longestLossDuration) : 'N/A';
            
            const fastestWinEl = document.getElementById('analytics-fastest-win');
            fastestWinEl.textContent = timeMetrics.hasWins ? formatDurationText(timeMetrics.fastestWin) : 'N/A';


            populateAnalyticsDailyPerformance(operationsForAnalytics, selectedAccount);
            populateAnalyticsMonthlyPerformance(operationsForAnalytics, selectedAccount);
            populateAnalyticsLastWeekPerformance(operationsForAnalytics, selectedAccount);
            updateInstrumentPerformanceChart(operationsForAnalytics, 'analytics-instrument-performance-chart');
            updateHourlyPerformanceChart(operationsForAnalytics, 'analytics-hourly-performance-chart');
            
            // Actualizar las nuevas gr√°ficas
            updateAnalyticsCumulativePLChart(operationsForAnalytics, selectedAccount);
            updateAnalyticsNetDailyPLChart(operationsForAnalytics, selectedAccount);
            
            // Actualizar los nuevos gauges
            updateTradeWinGauge(basicMetrics.winRate);
            updateDayWinGauge(dayStats.dayWinRate);
            updateProfitFactorGauge(basicMetrics.profitFactor);

            // Update mini visuals
            updateAnalyticsSparkline(operationsForAnalytics);
            updateAnalyticsPFGauge(basicMetrics.profitFactor);
            updateAnalyticsWinDonut(basicMetrics.winRate, basicMetrics.winningTrades, basicMetrics.losingTrades);
        }
        
        // Gr√°fica: Daily Net Cumulative P&L
        let analyticsCumulativePLChart = null;
        function updateAnalyticsCumulativePLChart(operations, accountId) {
            const canvas = document.getElementById('analytics-cumulative-pl-chart');
            if (!canvas) {
                console.error('Canvas analytics-cumulative-pl-chart no encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (analyticsCumulativePLChart) analyticsCumulativePLChart.destroy();

            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            console.log('üìä Creando gr√°fica acumulativa con', operations.length, 'operaciones');
            const sorted = [...operations].sort((a, b) => new Date(a.date) - new Date(b.date));

            let cumulative = 0;
            const labels = [];
            const data = [];

            sorted.forEach(op => {
                let plConverted = op.pl;
                if (op.currency !== targetCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, targetCurrency);
                }
                cumulative += plConverted;
                labels.push(op.date);
                data.push(cumulative);
            });

            if (data.length === 0) {
                labels.push(new Date().toISOString().split('T')[0]);
                data.push(0);
            }

            console.log('üìä Gr√°fica acumulativa - Puntos de datos:', data.length, '√öltimo valor:', data[data.length - 1]);

            analyticsCumulativePLChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#39ff14',
                        backgroundColor: 'rgba(57, 255, 20, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: (ctx) => `P&L: ${formatCurrency(ctx.raw, targetCurrency, displayCurrency)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#2a2a2a', display: true },
                            ticks: { color: '#a0a0a0', maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: '#2a2a2a' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (val) => formatCurrency(val, targetCurrency, displayCurrency)
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fica: Net Daily P&L
        let analyticsNetDailyPLChart = null;
        function updateAnalyticsNetDailyPLChart(operations, accountId) {
            const canvas = document.getElementById('analytics-net-daily-pl-chart');
            if (!canvas) {
                console.error('Canvas analytics-net-daily-pl-chart no encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (analyticsNetDailyPLChart) analyticsNetDailyPLChart.destroy();

            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            console.log('üìä Creando gr√°fica diaria con', operations.length, 'operaciones');
            const dailyPL = {};
            operations.forEach(op => {
                const date = op.date;
                if (!dailyPL[date]) dailyPL[date] = 0;
                
                let plConverted = op.pl;
                if (op.currency !== targetCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, targetCurrency);
                }
                dailyPL[date] += plConverted;
            });

            const sorted = Object.keys(dailyPL).sort();
            const labels = sorted;
            const data = sorted.map(date => dailyPL[date]);

            if (data.length === 0) {
                labels.push(new Date().toISOString().split('T')[0]);
                data.push(0);
            }

            console.log('üìä Gr√°fica diaria - D√≠as con datos:', data.length, 'Valores:', data);

            analyticsNetDailyPLChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: data.map(val => val >= 0 ? 'rgba(57, 255, 20, 0.8)' : 'rgba(255, 65, 54, 0.8)'),
                        borderColor: data.map(val => val >= 0 ? '#39ff14' : '#ff4136'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `P&L: ${formatCurrency(ctx.raw, targetCurrency, displayCurrency)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0a0a0', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: '#2a2a2a' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (val) => formatCurrency(val, targetCurrency, displayCurrency)
                            }
                        }
                    }
                }
            });
        }
        
        // --- Gauge Charts para las m√©tricas principales ---
        
        // Gauge Chart: Trade Win %
        let tradeWinGaugeChart = null;
        function updateTradeWinGauge(winRate) {
            const canvas = document.getElementById('analytics-trade-win-gauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (tradeWinGaugeChart) tradeWinGaugeChart.destroy();
            
            const percentage = Math.min(Math.max(winRate, 0), 100);
            const remaining = 100 - percentage;
            
            tradeWinGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [
                            percentage >= 50 ? '#39ff14' : '#ff4136',
                            'rgba(42, 42, 42, 0.3)'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Gauge Chart: Day Win %
        let dayWinGaugeChart = null;
        function updateDayWinGauge(dayWinRate) {
            const canvas = document.getElementById('analytics-day-win-gauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (dayWinGaugeChart) dayWinGaugeChart.destroy();
            
            const percentage = Math.min(Math.max(dayWinRate, 0), 100);
            const remaining = 100 - percentage;
            
            dayWinGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [
                            percentage >= 50 ? '#39ff14' : '#ff4136',
                            'rgba(42, 42, 42, 0.3)'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Speedometer Chart: Profit Factor
        let profitFactorGaugeChart = null;
        function updateProfitFactorGauge(profitFactor) {
            const canvas = document.getElementById('analytics-profit-factor-gauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (profitFactorGaugeChart) profitFactorGaugeChart.destroy();
            
            // Mapear profit factor (0-5) a porcentaje (0-100)
            const maxPF = 5;
            const pf = Math.min(Math.max(profitFactor, 0), maxPF);
            const percentage = (pf / maxPF) * 100;
            const remaining = 100 - percentage;
            
            // Color basado en el valor
            let color;
            if (pf < 1) color = '#ff4136'; // Rojo (malo)
            else if (pf < 1.5) color = '#ffbb33'; // Amarillo (regular)
            else color = '#39ff14'; // Verde (bueno)
            
            profitFactorGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [
                            color,
                            'rgba(42, 42, 42, 0.3)'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Gauge Chart: P&L Bruto
        let plBrutoGaugeChart = null;
        function updatePlBrutoGauge(grossPL, totalWin, totalLoss) {
            const canvas = document.getElementById('analytics-pl-bruto-gauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (plBrutoGaugeChart) plBrutoGaugeChart.destroy();
            
            // Calcular porcentaje basado en la proporci√≥n de ganancia vs p√©rdida
            const totalAbsolute = Math.abs(totalWin) + Math.abs(totalLoss);
            let percentage = 50; // Neutral por defecto
            
            if (totalAbsolute > 0) {
                // Si hay m√°s ganancias que p√©rdidas, el porcentaje sube de 50%
                // Si hay m√°s p√©rdidas, el porcentaje baja de 50%
                percentage = (Math.abs(totalWin) / totalAbsolute) * 100;
            }
            
            const remaining = 100 - percentage;
            const color = grossPL >= 0 ? '#39ff14' : '#ff4136';
            
            plBrutoGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [
                            color,
                            'rgba(42, 42, 42, 0.3)'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Gauge Chart: P&L Neto
        let plNetoGaugeChart = null;
        function updatePlNetoGauge(netPL, totalWin, totalLoss, totalFees) {
            const canvas = document.getElementById('analytics-pl-neto-gauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (plNetoGaugeChart) plNetoGaugeChart.destroy();
            
            // Calcular porcentaje considerando el impacto de las comisiones
            const totalAbsolute = Math.abs(totalWin) + Math.abs(totalLoss);
            let percentage = 50; // Neutral por defecto
            
            if (totalAbsolute > 0) {
                // Porcentaje basado en el P&L neto respecto al total
                const netRatio = (totalWin - totalFees) / totalAbsolute;
                percentage = Math.max(0, Math.min(100, (netRatio + 1) * 50)); // Normalizar a 0-100
            }
            
            const remaining = 100 - percentage;
            const color = netPL >= 0 ? '#39ff14' : '#ff4136';
            
            plNetoGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [
                            color,
                            'rgba(42, 42, 42, 0.3)'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // --- Rendimiento de √öltima Semana (Lunes a Domingo) - Tabla limpia ---
        function populateAnalyticsLastWeekPerformance(operations, accountId) {
            const tbody = document.getElementById('analytics-lastweek-performance');
            if (!tbody) return;
            tbody.innerHTML = '';
            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            const today = new Date();
            const utcToday = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
            let dayOfWeek = utcToday.getUTCDay();
            let daysSinceLastMonday = (dayOfWeek + 6) % 7 + 7;
            const lastMonday = new Date(utcToday);
            lastMonday.setUTCDate(utcToday.getUTCDate() - daysSinceLastMonday);
            const lastSunday = new Date(lastMonday);
            lastSunday.setUTCDate(lastMonday.getUTCDate() + 6);

            const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const weekData = daysOfWeek.map((name, i) => {
                const date = new Date(lastMonday);
                date.setUTCDate(lastMonday.getUTCDate() + i);
                return {
                    name,
                    date: date.toISOString().slice(0, 10),
                    pl: 0,
                    trades: 0,
                    wins: 0,
                    losses: 0
                };
            });

            const weekOps = operations.filter(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                return opDate >= lastMonday && opDate <= lastSunday;
            });

            console.log('üìÖ Tabla semana - Operaciones totales:', operations.length, 'Operaciones de la semana:', weekOps.length);
            console.log('üìÖ Rango:', lastMonday.toISOString().split('T')[0], 'a', lastSunday.toISOString().split('T')[0]);

            // Agrupar operaciones por d√≠a
            weekData.forEach(day => { day.operations = []; });
            
            weekOps.forEach(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                const dayIdx = Math.floor((opDate - lastMonday) / (24*60*60*1000));
                if (dayIdx >= 0 && dayIdx < 7) {
                    weekData[dayIdx].operations.push(op);
                }
            });
            
            // Calcular P&L NETO por d√≠a usando calculateMetrics
            weekData.forEach(day => {
                if (day.operations && day.operations.length > 0) {
                    const dayMetrics = calculateMetrics(day.operations, accountId);
                    const grossPL = dayMetrics.totalWin + dayMetrics.totalLoss;
                    day.pl = grossPL - dayMetrics.totalFees; // P&L NETO
                    day.trades = dayMetrics.totalTrades;
                    day.wins = dayMetrics.winningTrades;
                    day.losses = dayMetrics.losingTrades;
                }
            });

            let initialBalanceForPercent = 0;
            if (displayCurrency === '%') {
                if (accountId === 'all') {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, targetCurrency), 0);
                } else {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, targetCurrency);
                }
            }

            // Mostrar TODOS los d√≠as de la semana (incluso si no hay trades)
            weekData.forEach((day) => {
                const winRate = (day.wins + day.losses) > 0 ? (day.wins / (day.wins + day.losses)) * 100 : 0;
                let plDisplay;
                if (displayCurrency === '%') {
                    plDisplay = initialBalanceForPercent !== 0 ? ((day.pl / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
                } else {
                    plDisplay = formatCurrency(day.pl, targetCurrency, targetCurrency);
                }
                
                const plClass = day.pl > 0 ? 'text-green' : (day.pl < 0 ? 'text-red' : 'text-text-secondary');
                const dayNumber = day.date.split('-')[2];
                
                const row = document.createElement('tr');
                row.className = 'border-b border-surface hover:bg-surface-light transition-colors';
                if (day.trades > 0) {
                    row.classList.add('cursor-pointer');
                    row.addEventListener('click', () => openAnalyticsDetailModal('date', day.date, `${day.name} ${day.date}`));
                }
                
                row.innerHTML = `
                    <td class="py-3 text-xs">
                        ${day.name} <span class="text-green font-bold">${dayNumber}</span>
                    </td>
                    <td class="py-3 text-right ${plClass} font-semibold text-xs">${plDisplay}</td>
                    <td class="py-3 text-right text-xs">${day.trades}</td>
                    <td class="py-3 text-right text-xs ${winRate >= 50 ? 'text-green' : 'text-red'}">${winRate > 0 ? winRate.toFixed(0) + '%' : '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        let analyticsSparklineChart = null;
        function updateAnalyticsSparkline(operations) {
            const canvas = document.getElementById('analytics-sparkline-chart');
            if (!canvas) return;
            if (typeof Chart === 'undefined') return;

            const sorted = [...operations].sort((a,b) => new Date(a.date) - new Date(b.date));
            let cumulative = 0;
            const labels = [];
            const data = [];
            sorted.forEach(op => {
                const rawPL = op.manualPL ?? op.pl ?? 0;
                const plInDefault = op.currency && op.currency !== DB.settings.defaultCurrency ? convertCurrency(rawPL, op.currency, DB.settings.defaultCurrency) : rawPL;
                cumulative += plInDefault;
                labels.push(op.date);
                data.push(cumulative);
            });
            if (data.length === 0) { labels.push(new Date().toISOString().split('T')[0]); data.push(0); }

            if (analyticsSparklineChart) analyticsSparklineChart.destroy();
            const ctx = canvas.getContext('2d');
            analyticsSparklineChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ data, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.08)', borderWidth: 2, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });
        }

        function updateAnalyticsPFGauge(pf) {
            const gaugeEl = document.getElementById('analytics-pf-gauge');
            if (gaugeEl) {
                let percentage = 0;
                if (pf >= 3) percentage = 100;
                else if (pf >= 2) percentage = 66 + (pf - 2) * 34;
                else if (pf >= 1) percentage = 33 + (pf - 1) * 33;
                else percentage = pf * 33;
                gaugeEl.style.width = Math.min(100, Math.max(0, percentage)) + '%';
            }
        }

        function updateAnalyticsWinDonut(winRate, wins, losses) {
            const circleEl = document.getElementById('analytics-win-circle');
            const textEl = document.getElementById('analytics-win-text');
            const winsEl = document.getElementById('analytics-wins');
            const lossesEl = document.getElementById('analytics-losses');
            if (circleEl) {
                const dash = `${winRate.toFixed(0)}, 100`;
                circleEl.setAttribute('stroke-dasharray', dash);
                let color = '#ef4444';
                if (winRate >= 60) color = '#22c55e';
                else if (winRate >= 40) color = '#eab308';
                circleEl.setAttribute('stroke', color);
            }
            if (textEl) textEl.textContent = Math.round(winRate) + '%';
            if (winsEl) winsEl.textContent = wins;
            if (lossesEl) lossesEl.textContent = losses;
        }

        let analyticsHourlyPerformanceChart = null;
        function updateHourlyPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;

            if (analyticsHourlyPerformanceChart) {
                analyticsHourlyPerformanceChart.destroy();
            }

            const hourlyPerformance = Array(24).fill(0);
            operations.forEach(op => {
                if (op.entryTime) {
                    try {
                        const hour = parseInt(op.entryTime.split(':')[0], 10);
                        if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                             hourlyPerformance[hour] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        }
                    } catch(e) { /* ignore invalid time */ }
                }
            });

            const labels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);

            analyticsHourlyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P/L por Hora',
                        data: hourlyPerformance,
                        backgroundColor: hourlyPerformance.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#FFFFFF', maxRotation: 90, minRotation: 45, autoSkip: true, maxTicksLimit: 12 } },
                        y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }
                    }
                }
            });
        }


        function populateAnalyticsDailyPerformance(operations, accountId) {
            const tbody = document.getElementById('analytics-daily-performance');
            if (!tbody) return;
            tbody.innerHTML = '';
            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            const daysOfWeek = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const dailyPerformance = daysOfWeek.map(() => ({ operations: [], trades: 0, wins: 0, losses: 0 }));

            // Agrupar operaciones por d√≠a de la semana
            operations.forEach(op => {
                const dayIndex = new Date(op.date + 'T00:00:00Z').getUTCDay();
                dailyPerformance[dayIndex].operations.push(op);
            });
            
            // Calcular P&L NETO por d√≠a usando calculateMetrics
            dailyPerformance.forEach(dayData => {
                if (dayData.operations.length > 0) {
                    const dayMetrics = calculateMetrics(dayData.operations, accountId);
                    const grossPL = dayMetrics.totalWin + dayMetrics.totalLoss;
                    dayData.pl = grossPL - dayMetrics.totalFees; // P&L NETO
                    dayData.trades = dayMetrics.totalTrades;
                    dayData.wins = dayMetrics.winningTrades;
                    dayData.losses = dayMetrics.losingTrades;
                }
            });

            let initialBalanceForPercent = 0;
            if (displayCurrency === '%') {
                if (accountId === 'all') {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, targetCurrency), 0);
                } else {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, targetCurrency);
                }
            }

            daysOfWeek.forEach((dayName, index) => {
                const dayData = dailyPerformance[index];
                if (dayData.trades === 0) return; // No mostrar d√≠as sin operaciones

                const winRate = (dayData.wins + dayData.losses) > 0 ? (dayData.wins / (dayData.wins + dayData.losses)) * 100 : 0;
                let plDisplay;
                if (displayCurrency === '%') {
                    plDisplay = initialBalanceForPercent !== 0 ? ((dayData.pl / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
                } else {
                    plDisplay = formatCurrency(dayData.pl, targetCurrency, targetCurrency);
                }
                const plClass = dayData.pl > 0 ? 'text-positive' : (dayData.pl < 0 ? 'text-negative' : 'text-neutral');

                const row = document.createElement('tr');
                row.dataset.dayIndex = index; // Guardar el √≠ndice del d√≠a
                row.innerHTML = `
                    <td>${dayName}</td>
                    <td class="${plClass}">${plDisplay}</td>
                    <td>${dayData.trades}</td>
                    <td class="text-green">${winRate.toFixed(1)}%</td>
                `;
                // NUEVO: A√±adir listener para abrir modal
                row.addEventListener('click', () => openAnalyticsDetailModal('dayOfWeek', index, dayName));
                tbody.appendChild(row);
            });
        }

        function populateAnalyticsMonthlyPerformance(operations, accountId) {
            console.log(`üìÖ [populateAnalyticsMonthlyPerformance] Calculando rendimiento mensual para ${operations.length} operaciones`);
            
            const tbody = document.getElementById('analytics-monthly-performance');
            if (!tbody) return;
            tbody.innerHTML = '';
            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            const monthlyPerformance = {};

            // Debug: Ver todas las fechas
            console.log(`üìÖ [DEBUG] Fechas de operaciones:`, operations.map(op => op.date).sort());

            // Agrupar operaciones por mes
            operations.forEach(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                const monthKey = `${opDate.getUTCFullYear()}-${String(opDate.getUTCMonth() + 1).padStart(2, '0')}`;
                
                console.log(`üìÖ [DEBUG] Op ${op.id}: fecha="${op.date}", monthKey="${monthKey}", pl=${op.pl}`);
                
                if (!monthlyPerformance[monthKey]) {
                    monthlyPerformance[monthKey] = { 
                        operations: [], 
                        year: opDate.getUTCFullYear(), 
                        monthIndex: opDate.getUTCMonth() 
                    };
                }
                
                monthlyPerformance[monthKey].operations.push(op);
            });
            
            // Para cada mes, usar calculateMetrics() para obtener valores consistentes
            Object.keys(monthlyPerformance).forEach(monthKey => {
                const monthData = monthlyPerformance[monthKey];
                const monthOps = monthData.operations;
                
                console.log(`üìÖ [Mes ${monthKey}] Calculando para ${monthOps.length} operaciones`);
                
                // Usar la MISMA funci√≥n que Analytics para consistencia
                const monthMetrics = calculateMetrics(monthOps, accountId);
                
                // P/L NETO (Bruto - Fees)
                const grossPL = monthMetrics.totalWin + monthMetrics.totalLoss;
                const netPL = grossPL - monthMetrics.totalFees;
                
                console.log(`üìÖ [Mes ${monthKey}] Bruto: ${grossPL}, Fees: ${monthMetrics.totalFees}, Neto: ${netPL}`);
                
                monthData.pl = netPL;
                monthData.trades = monthMetrics.totalTrades;
                monthData.wins = monthMetrics.winningTrades;
                monthData.losses = monthMetrics.losingTrades;
            });

            let initialBalanceForPercent = 0;
            if (displayCurrency === '%') {
                 if (accountId === 'all') {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, targetCurrency), 0);
                } else {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, targetCurrency);
                }
            }

            const sortedMonths = Object.keys(monthlyPerformance).sort().reverse();
            console.log(`üìÖ [TABLA] Meses a renderizar:`, sortedMonths);
            
            sortedMonths.forEach(monthKey => {
                const monthData = monthlyPerformance[monthKey];
                const winRate = (monthData.wins + monthData.losses) > 0 ? (monthData.wins / (monthData.wins + monthData.losses)) * 100 : 0;
                let plDisplay;
                 if (displayCurrency === '%') {
                    plDisplay = initialBalanceForPercent !== 0 ? ((monthData.pl / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
                } else {
                    plDisplay = formatCurrency(monthData.pl, targetCurrency, targetCurrency);
                }
                const plClass = monthData.pl > 0 ? 'text-positive' : (monthData.pl < 0 ? 'text-negative' : 'text-neutral');
                const fullMonthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthLabel = `${fullMonthNames[monthData.monthIndex]} ${monthData.year}`;

                console.log(`üìÖ [TABLA] Renderizando fila: ${monthLabel} - P/L: ${plDisplay} - Trades: ${monthData.trades}`);

                const row = document.createElement('tr');
                row.dataset.monthKey = monthKey; // Guardar la clave del mes
                row.innerHTML = `
                    <td>${monthLabel}</td>
                    <td class="${plClass}">${plDisplay}</td>
                    <td>${monthData.trades}</td>
                    <td class="text-green">${winRate.toFixed(1)}%</td>
                `;
                // NUEVO: A√±adir listener para abrir modal
                row.addEventListener('click', () => openAnalyticsDetailModal('month', monthKey, monthLabel));
                tbody.appendChild(row);
                
                console.log(`‚úÖ [TABLA] Fila a√±adida para ${monthLabel}`);
            });
             if (Object.keys(monthlyPerformance).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-text-secondary py-3">No hay datos</td></tr>';
            }
        }

        // --- NUEVO: Funciones para el Modal de Detalles de Analytics ---
        function openAnalyticsDetailModal(type, value, titleLabel, accountOverride = null) {
            const modal = document.getElementById('analytics-detail-modal');
            document.getElementById('analytics-detail-title').textContent = `An√°lisis de ${titleLabel}`;

            // 1. Filtrar las operaciones
            let periodOperations = [];
            // Si se proporciona accountOverride, usarlo; si no, usar el selector de analytics
            const selectedAccount = accountOverride || document.getElementById('analytics-account-select').value;
            
            // Para an√°lisis de d√≠a espec√≠fico, usar todas las operaciones sin filtro global
            // Para otros tipos, usar el filtro global
            let sourceOps;
            if (type === 'date') {
                sourceOps = DB.operations; // Usar todas las operaciones sin filtro global para an√°lisis de d√≠a
            } else {
                sourceOps = applyDateFilterToData(DB.operations); // Usar operaciones ya filtradas por fecha global
            }
            
            if (selectedAccount !== 'all') {
                sourceOps = sourceOps.filter(op => op.accountId === selectedAccount);
            }

            if (type === 'month') {
                const [year, month] = value.split('-');
                periodOperations = sourceOps.filter(op => op.date.startsWith(value));
            } else if (type === 'dayOfWeek') {
                periodOperations = sourceOps.filter(op => new Date(op.date + 'T00:00:00Z').getUTCDay() === value);
            } else if (type === 'date') {
                // Filtrar por fecha exacta (YYYY-MM-DD)
                periodOperations = sourceOps.filter(op => op.date === value);
                console.log(`[openAnalyticsDetailModal] An√°lisis de d√≠a ${value}:`);
                console.log(`[openAnalyticsDetailModal] - Total operaciones en DB: ${DB.operations.length}`);
                console.log(`[openAnalyticsDetailModal] - Operaciones despu√©s filtro cuenta: ${sourceOps.length}`);
                console.log(`[openAnalyticsDetailModal] - Operaciones para la fecha ${value}: ${periodOperations.length}`);
                if (periodOperations.length > 0) {
                    console.log(`[openAnalyticsDetailModal] - Primera operaci√≥n:`, periodOperations[0]);
                }
                // Verificar fechas disponibles
                const availableDates = [...new Set(DB.operations.map(op => op.date))].sort();
                console.log(`[openAnalyticsDetailModal] - Fechas disponibles:`, availableDates.slice(0, 10), '...');
            }

            // 2. Calcular M√©tricas para el per√≠odo
            const currencySelect = document.getElementById('analytics-currency-select');
            const displayCurrency = currencySelect ? currencySelect.value : 'USD';
            const metrics = calculateMetrics(periodOperations, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(periodOperations, selectedAccount);
            const extraMetrics = calculateExtraAnalytics(periodOperations, selectedAccount);

            // AHORA calculateMetrics devuelve P/L BRUTO + totalFees por separado
            const grossPL = metrics.totalWin + metrics.totalLoss;
            const totalFees = metrics.totalFees;
            const netPL = grossPL - totalFees;
            
            const avgFee = metrics.totalTrades > 0 ? totalFees / metrics.totalTrades : 0;

            // 3. Poblar el modal
            const plEl = document.getElementById('analytics-detail-pl');
            plEl.textContent = formatCurrency(grossPL, DB.settings.defaultCurrency, displayCurrency);
            plEl.className = `text-3xl font-bold ${grossPL >= 0 ? 'text-positive' : 'text-negative'}`;
            document.getElementById('analytics-detail-winrate').textContent = `${metrics.winRate.toFixed(1)}%`;
            document.getElementById('analytics-detail-pf').textContent = isFinite(metrics.profitFactor) ? metrics.profitFactor.toFixed(2) : "‚àû";
            document.getElementById('analytics-detail-trades').textContent = metrics.totalTrades;

            // Mostrar comisiones
            document.getElementById('analytics-detail-fees').textContent = formatCurrency(totalFees, DB.settings.defaultCurrency, displayCurrency);

            const netPlEl = document.getElementById('analytics-detail-net-pl');
            netPlEl.textContent = formatCurrency(netPL, DB.settings.defaultCurrency, displayCurrency);
            netPlEl.className = `font-bold ${netPL >= 0 ? 'text-green' : 'text-red'}`;

            document.getElementById('analytics-detail-avg-win').textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-avg-loss').textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-avg-fee').textContent = formatCurrency(avgFee, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-largest-win').textContent = formatCurrency(advancedMetrics.largestWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-largest-loss').textContent = formatCurrency(advancedMetrics.largestLoss, DB.settings.defaultCurrency, displayCurrency);

            const wLRatioEl = document.getElementById('analytics-detail-w-l-ratio');
            wLRatioEl.textContent = isFinite(extraMetrics.avgWLRatio) ? extraMetrics.avgWLRatio.toFixed(2) : '‚àû';
            wLRatioEl.className = `font-semibold ${extraMetrics.avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('analytics-detail-drawdown').textContent = formatCurrency(extraMetrics.maxDrawdownValue, extraMetrics.currencyForDD, displayCurrency);

            // 4. Renderizar Gr√°ficos
            updateDashboardRadarChart(periodOperations, selectedAccount, 'analytics-detail-radar-chart');
            updateInstrumentPerformanceChart(periodOperations, 'analytics-detail-instrument-chart');
            updateTypePerformanceChart(periodOperations, 'analytics-detail-long-short-chart');
            updateAnalyticsDetailPnLEvolutionChart(periodOperations, displayCurrency);


            // 5. Poblar tabla de operaciones
            const tableBody = document.getElementById('analytics-detail-table-body');
            tableBody.innerHTML = '';
            periodOperations.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(op => {
                const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
                const precision = getInstrumentPrecision(op.instrument);
                
                // Fila principal de la operaci√≥n
                const mainRow = `
                    <tr class="cursor-pointer ${op.hasPartials ? 'font-semibold bg-surface-light' : ''}" data-id="${op.id}">
                        <td>${formatDate(op.date)}</td>
                        <td>${op.instrument}${op.hasPartials ? ` <span class="text-xs text-gray-400">(${op.partials.length} parcial${op.partials.length > 1 ? 'es' : ''})</span>` : ''}</td>
                        <td class="${op.type === 'buy' ? 'text-positive' : 'text-negative'}">${op.type === 'buy' ? 'Long' : 'Short'}</td>
                        <td>${op.entry !== null ? op.entry.toFixed(precision) : '-'}</td>
                        <td>${op.exit !== null ? op.exit.toFixed(precision) : '-'}</td>
                        <td>${op.volume}</td>
                        <td class="${plClass}">${formatCurrency(op.pl, op.currency, op.currency)}</td>
                    </tr>
                `;
                
                tableBody.innerHTML += mainRow;
                
                // Si tiene parciales, agregar filas adicionales (ocultas inicialmente, se pueden expandir)
                if (op.hasPartials && op.partials && op.partials.length > 0) {
                    op.partials.forEach((partial, index) => {
                        const partialPlClass = partial.pl >= 0 ? 'text-positive' : 'text-negative';
                        const partialRow = `
                            <tr class="text-sm text-gray-400 bg-background" data-parent-id="${op.id}">
                                <td class="pl-6">‚Ü≥ Cierre ${index + 1}</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>${partial.price.toFixed(precision)}</td>
                                <td>${partial.volume}</td>
                                <td class="${partialPlClass}">${formatCurrency(partial.pl, op.currency, op.currency)}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += partialRow;
                    });
                }
            });

            tableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const opId = row.dataset.id;
                    if(opId) {
                        closeAnalyticsDetailModal();
                        showOperationDetailPage(opId);
                    }
                });
            });

            // 6. Mostrar el modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evitar scroll del fondo
        }

        function closeAnalyticsDetailModal() {
            const modal = document.getElementById('analytics-detail-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Variable global para el gr√°fico de evoluci√≥n del P&L
        let analyticsDetailPnLEvolutionChart = null;

        function updateAnalyticsDetailPnLEvolutionChart(operations, displayCurrency) {
            const ctx = document.getElementById('analytics-detail-pnl-evolution-chart')?.getContext('2d');
            if (!ctx) return;

            // Destruir gr√°fico existente
            if (analyticsDetailPnLEvolutionChart) {
                analyticsDetailPnLEvolutionChart.destroy();
            }

            // Agrupar operaciones por ID y calcular P&L acumulado
            const groupedOps = {};
            operations.forEach(op => {
                const opId = op.id;
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        id: opId,
                        totalPL: 0,
                        date: op.date,
                        entryTime: op.entryTime || '00:00',
                        currency: op.currency
                    };
                }
                groupedOps[opId].totalPL += op.pl;
                
                // Usar la fecha/hora m√°s temprana como referencia
                const currentTime = op.entryTime || '00:00';
                if (currentTime < groupedOps[opId].entryTime) {
                    groupedOps[opId].entryTime = currentTime;
                }
            });

            const uniqueTradeGroups = Object.values(groupedOps);
            
            // Ordenar por fecha y hora
            uniqueTradeGroups.sort((a, b) => {
                const dateTimeA = new Date(a.date + 'T' + a.entryTime);
                const dateTimeB = new Date(b.date + 'T' + b.entryTime);
                return dateTimeA - dateTimeB;
            });

            // Calcular P&L acumulado
            let cumulativePL = 0;
            const dataPoints = [];
            const labels = [];

            uniqueTradeGroups.forEach((group, index) => {
                let plInDisplayCurrency = group.totalPL;
                if (group.currency !== displayCurrency && displayCurrency !== '%') {
                    plInDisplayCurrency = convertCurrency(group.totalPL, group.currency, displayCurrency);
                }
                
                cumulativePL += plInDisplayCurrency;
                dataPoints.push(cumulativePL);
                labels.push(`Trade ${index + 1} (${group.entryTime})`);
            });

            // Crear el gr√°fico
            analyticsDetailPnLEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `P&L Acumulado (${displayCurrency})`,
                        data: dataPoints,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.15)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: dataPoints.map(val => val >= 0 ? '#00ff41' : '#ef4444'),
                        pointBorderColor: dataPoints.map(val => val >= 0 ? '#00cc33' : '#dc2626'),
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#a0a0a0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `P&L Acumulado: ${formatCurrency(value, displayCurrency, displayCurrency)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a0a0a0',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a0a0a0',
                                callback: function(value) {
                                    return formatCurrency(value, displayCurrency, displayCurrency);
                                }
                            }
                        }
                    }
                }
            });
        }
        // --- FIN de Funciones para el Modal de Detalles de Analytics ---

        function initFinances() {
            document.getElementById('add-finance-entry-btn').addEventListener('click', () => toggleAddFinanceEntryForm());
            document.getElementById('finance-cancel-btn').addEventListener('click', () => toggleAddFinanceEntryForm());
            document.getElementById('finance-save-btn').addEventListener('click', saveFinanceEntry);
            document.getElementById('finances-table-body').addEventListener('click', handleFinancesTableClick);

            // Inicializar pesta√±as de Finanzas
            const tabMovements = document.getElementById('finances-tab-movements');
            const tabCalendar = document.getElementById('finances-tab-calendar');
            const viewMovements = document.getElementById('finances-view-movements');
            const viewCalendar = document.getElementById('finances-view-calendar');

            tabMovements.addEventListener('click', () => {
                tabMovements.classList.add('active');
                tabCalendar.classList.remove('active');
                viewMovements.classList.remove('hidden');
                viewCalendar.classList.add('hidden');
            });

            tabCalendar.addEventListener('click', () => {
                tabCalendar.classList.add('active');
                tabMovements.classList.remove('active');
                viewCalendar.classList.remove('hidden');
                viewMovements.classList.add('hidden');
            });

            // Inicializar calendario financiero
            initFinancialCalendar();

            const toggleButton = document.getElementById('toggle-hide-amounts-finances');
            const toggleIcon = document.getElementById('toggle-hide-amounts-finances-icon');
            const financesSection = document.getElementById('finances');

            const applyStreamerMode = (active) => {
                if (active) {
                    financesSection.classList.add('streamer-mode-active');
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                    toggleButton.setAttribute('aria-pressed', 'true');
                    toggleButton.title = "Mostrar importes";
                } else {
                    financesSection.classList.remove('streamer-mode-active');
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                    toggleButton.setAttribute('aria-pressed', 'false');
                    toggleButton.title = "Ocultar importes (stream)";
                }
            };

            let isStreamerModeActive = localStorage.getItem('streamerModeFinancesActive') === 'true';
            applyStreamerMode(isStreamerModeActive);

            toggleButton.addEventListener('click', () => {
                isStreamerModeActive = !isStreamerModeActive;
                localStorage.setItem('streamerModeFinancesActive', isStreamerModeActive);
                applyStreamerMode(isStreamerModeActive);
            });

            // ===== EDITOR DE NOTAS AVANZADAS PARA FINANZAS =====
            
            // Abrir editor de notas de finanzas
            document.getElementById('edit-finance-notes-btn').addEventListener('click', function() {
                const modal = document.getElementById('finance-notes-editor-modal');
                const editor = document.getElementById('finance-notes-editor');
                const hiddenInput = document.getElementById('finance-notes-hidden');
                
                // Cargar notas existentes
                editor.innerHTML = hiddenInput.value || '';
                
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                updateFinanceEditorCharCount();
            });

            // Cerrar editor de finanzas
            function closeFinanceNotesEditor() {
                const modal = document.getElementById('finance-notes-editor-modal');
                modal.style.display = 'none';
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            document.getElementById('close-finance-editor-btn').addEventListener('click', closeFinanceNotesEditor);
            document.getElementById('finance-editor-cancel-btn').addEventListener('click', closeFinanceNotesEditor);

            // Cerrar al hacer clic fuera del modal
            document.getElementById('finance-notes-editor-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFinanceNotesEditor();
                }
            });

            // Actualizar contador de caracteres
            function updateFinanceEditorCharCount() {
                const editor = document.getElementById('finance-notes-editor');
                const counter = document.getElementById('finance-editor-char-count');
                const text = editor.innerText || editor.textContent || '';
                counter.textContent = `${text.length} caracteres`;
            }

            document.getElementById('finance-notes-editor').addEventListener('input', updateFinanceEditorCharCount);

            // Funciones de formato
            window.formatFinanceText = function(command, value = null) {
                document.execCommand(command, false, value);
                document.getElementById('finance-notes-editor').focus();
            };

            window.insertFinanceLink = function() {
                const url = prompt('Ingresa la URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
            };

            // Guardar notas de finanzas
            document.getElementById('finance-editor-save-btn').addEventListener('click', function() {
                const editor = document.getElementById('finance-notes-editor');
                const notes = editor.innerHTML;
                const hiddenInput = document.getElementById('finance-notes-hidden');
                const display = document.getElementById('finance-notes-display');
                
                hiddenInput.value = notes;
                
                if (notes.trim()) {
                    display.innerHTML = notes;
                } else {
                    display.innerHTML = '<p class="text-text-secondary italic">Sin descripci√≥n. Usa el editor avanzado para a√±adir notas detalladas.</p>';
                }
                
                closeFinanceNotesEditor();
            });

            // Nota de voz para finanzas
            let financeMediaRecorder;
            let financeAudioChunks = [];
            let isFinanceRecording = false;

            document.getElementById('finance-voice-note-btn').addEventListener('click', async function() {
                if (!isFinanceRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        financeMediaRecorder = new MediaRecorder(stream);
                        financeAudioChunks = [];

                        financeMediaRecorder.ondataavailable = (event) => {
                            financeAudioChunks.push(event.data);
                        };

                        financeMediaRecorder.onstop = () => {
                            const audioBlob = new Blob(financeAudioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            const editor = document.getElementById('finance-notes-editor');
                            const audioHTML = `<div style="margin: 10px 0; padding: 10px; background: rgba(57, 255, 20, 0.1); border-left: 3px solid #39ff14; border-radius: 4px;">
                                <p style="margin: 0 0 5px 0; font-weight: bold; color: #39ff14;">üé§ Nota de Voz</p>
                                <audio controls style="width: 100%; max-width: 400px;">
                                    <source src="${audioUrl}" type="audio/webm">
                                </audio>
                            </div>`;
                            
                            editor.innerHTML += audioHTML;
                            updateFinanceEditorCharCount();

                            stream.getTracks().forEach(track => track.stop());
                        };

                        financeMediaRecorder.start();
                        isFinanceRecording = true;

                        this.innerHTML = '<i class="fas fa-stop-circle text-red"></i><span class="ml-2">Detener Grabaci√≥n</span>';
                        this.classList.add('bg-red', 'text-white');

                    } catch (err) {
                        console.error('Error al acceder al micr√≥fono:', err);
                        alert('No se pudo acceder al micr√≥fono. Verifica los permisos del navegador.');
                    }
                } else {
                    if (financeMediaRecorder && financeMediaRecorder.state !== 'inactive') {
                        financeMediaRecorder.stop();
                        isFinanceRecording = false;

                        this.innerHTML = '<i class="fas fa-microphone"></i><span class="ml-2">Nota de Voz</span>';
                        this.classList.remove('bg-red', 'text-white');
                    }
                }
            });

            // ===== GR√ÅFICO EN PANTALLA COMPLETA =====
            
            let fullscreenChart = null;

            document.getElementById('expand-evolution-chart-btn').addEventListener('click', function() {
                const modal = document.getElementById('evolution-chart-fullscreen');
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Crear gr√°fico en pantalla completa
                setTimeout(() => {
                    renderEvolutionChartFullscreen();
                }, 100);
            });

            document.getElementById('close-evolution-fullscreen-btn').addEventListener('click', function() {
                const modal = document.getElementById('evolution-chart-fullscreen');
                modal.style.display = 'none';
                modal.classList.add('hidden');
                document.body.style.overflow = '';

                // Destruir gr√°fico
                if (fullscreenChart) {
                    fullscreenChart.destroy();
                    fullscreenChart = null;
                }
            });

            function renderEvolutionChartFullscreen() {
                const canvas = document.getElementById('finances-evolution-chart-fullscreen');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destruir gr√°fico existente
                if (fullscreenChart) {
                    fullscreenChart.destroy();
                }

                // Obtener datos del gr√°fico principal
                const entries = [...DB.financeEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (entries.length === 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '20px Arial';
                    ctx.fillStyle = '#8b949e';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos para mostrar', canvas.width / 2, canvas.height / 2);
                    return;
                }

                let cumulativeBalance = 0;
                const labels = [];
                const data = [];

                entries.forEach(entry => {
                    cumulativeBalance += entry.amount;
                    labels.push(new Date(entry.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }));
                    data.push(cumulativeBalance);
                });

                fullscreenChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Balance Acumulado',
                            data: data,
                            borderColor: '#39FF14',
                            backgroundColor: 'rgba(57, 255, 20, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#39FF14',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                display: true,
                                labels: {
                                    color: '#fff',
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#39FF14',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => `Balance: $${context.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { 
                                    color: '#8b949e',
                                    font: { size: 12 }
                                }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { 
                                    color: '#8b949e',
                                    font: { size: 12 },
                                    callback: (value) => `$${value.toFixed(0)}`
                                }
                            }
                        }
                    }
                });
            }

            refreshFinancesView();
        }

        function toggleAddFinanceEntryForm(entryToEdit = null) {
            const formContainer = document.getElementById('add-finance-entry-form');
            const isVisible = formContainer.style.display === 'block';

            if (!isVisible) {
                formContainer.style.display = 'block';
                document.getElementById('add-finance-entry-btn').textContent = 'Ocultar Formulario';
                formContainer.querySelector('form').reset();

                if (entryToEdit) {
                    formContainer.querySelector('h3').textContent = 'Editar Movimiento';
                    document.getElementById('finance-date').value = entryToEdit.date;
                    document.getElementById('finance-amount').value = entryToEdit.amount;
                    document.getElementById('finance-currency').value = entryToEdit.currency;
                    
                    // Cargar notas en el campo oculto y display
                    const hiddenNotes = document.getElementById('finance-notes-hidden');
                    const displayNotes = document.getElementById('finance-notes-display');
                    hiddenNotes.value = entryToEdit.notes || '';
                    if (entryToEdit.notes && entryToEdit.notes.trim()) {
                        displayNotes.innerHTML = entryToEdit.notes;
                    } else {
                        displayNotes.innerHTML = '<p class="text-text-secondary italic">Sin descripci√≥n. Usa el editor avanzado para a√±adir notas detalladas.</p>';
                    }
                    
                    formContainer.dataset.editingId = entryToEdit.id;
                } else {
                    formContainer.querySelector('h3').textContent = 'Nuevo Movimiento Financiero';
                    document.getElementById('finance-date').value = getLocalDateString(new Date());
                    document.getElementById('finance-currency').value = DB.settings.defaultCurrency;
                    
                    // Limpiar notas
                    document.getElementById('finance-notes-hidden').value = '';
                    document.getElementById('finance-notes-display').innerHTML = '<p class="text-text-secondary italic">Sin descripci√≥n. Usa el editor avanzado para a√±adir notas detalladas.</p>';
                    
                    delete formContainer.dataset.editingId;
                }
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                formContainer.style.display = 'none';
                document.getElementById('add-finance-entry-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>A√±adir Movimiento';
                delete formContainer.dataset.editingId;
            }
        }

        async function saveFinanceEntry() {
            showLoading(true);
            const formContainer = document.getElementById('add-finance-entry-form');
            const editingId = formContainer.dataset.editingId;

            const date = document.getElementById('finance-date').value;
            const amount = parseFloat(document.getElementById('finance-amount').value);
            const currency = document.getElementById('finance-currency').value;
            const notes = document.getElementById('finance-notes-hidden').value.trim();

            if (!date || isNaN(amount)) {
                alert('Por favor, complete los campos obligatorios (Fecha y Monto).');
                showLoading(false);
                return;
            }

            const entryData = { date, amount, currency, notes };

            try {
                // GUARDAR PRIMERO LOCALMENTE (siempre funciona)
                if (editingId) {
                    await dexieDB.finances.update(parseInt(editingId), entryData);
                    const index = DB.finances.findIndex(f => f.id === parseInt(editingId));
                    if (index !== -1) {
                        DB.finances[index] = { ...DB.finances[index], ...entryData };
                    }
                    console.log('‚úÖ Movimiento financiero actualizado localmente');
                } else {
                    const newId = await dexieDB.finances.add(entryData);
                    entryData.id = newId;
                    DB.finances.push(entryData);
                    console.log('‚úÖ Movimiento financiero guardado localmente');
                }

                // SINCRONIZACI√ìN AUTOM√ÅTICA CON SUPABASE (en segundo plano)
                if (currentUser) {
                    saveFinanceToSupabase(entryData).then(() => {
                        console.log('‚úÖ Movimiento financiero guardado exitosamente');
                        showSyncNotification('üíæ Movimiento guardado y sincronizado autom√°ticamente', 'success');
                    }).catch((supabaseError) => {
                        console.error('‚ùå Error de sincronizaci√≥n autom√°tica:', supabaseError);
                        addToSyncQueue(entryData, 'finance');
                        showSyncNotification('üíæ Movimiento guardado (se sincronizar√° autom√°ticamente)', 'info');
                    });
                } else {
                    showSyncNotification('üíæ Movimiento guardado localmente', 'warning');
                }

                // Actualizar vistas inmediatamente con datos locales
                toggleAddFinanceEntryForm();
                refreshFinancesView();

                // Mensaje de confirmaci√≥n inmediato
                showSyncNotification('‚úÖ Movimiento financiero guardado exitosamente', 'success');

            } catch (e) {
                console.error("Error saving finance entry:", e);
                alert("Error al guardar el movimiento financiero.");
            } finally {
                showLoading(false);
            }
        }

        async function handleFinancesTableClick(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const entryId = parseInt(button.dataset.id);
            if (isNaN(entryId)) return;

            if (button.classList.contains('edit-finance-btn')) {
                const entry = DB.finances.find(f => f.id === entryId);
                if (entry) toggleAddFinanceEntryForm(entry);
            } else if (button.classList.contains('delete-finance-btn')) {
                if (confirm('¬øEst√°s seguro de que deseas eliminar este movimiento?')) {
                    showLoading(true);
                    try {
                        const entry = DB.finances.find(f => f.id === entryId);
                        await dexieDB.finances.delete(entryId);

                        // Eliminar de Supabase si tiene supabase_id
                        if (entry && entry.supabase_id) {
                            await deleteFinanceFromSupabase(entry.supabase_id);
                        }

                        DB.finances = DB.finances.filter(f => f.id !== entryId);
                        refreshFinancesView();
                    } catch (e) {
                        console.error("Error deleting finance entry:", e);
                        alert("Error al eliminar el movimiento.");
                    } finally {
                        showLoading(false);
                    }
                }
            }
        }

        function refreshFinancesView() {
            if (!document.getElementById('finances').classList.contains('active')) return;

            const filteredFinances = applyDateFilterToData(DB.finances);
            const filteredOperations = applyDateFilterToData(DB.operations);

            updateFinancePageSummary(filteredFinances, filteredOperations);
            renderFinancesTable(filteredFinances);
            updateFinancesEvolutionChart(filteredFinances);
            updateFinancesCashflowChart(filteredFinances, filteredOperations);
            updateFinancesProfitExpensesChart(filteredFinances, filteredOperations);
            renderFinancialCalendar(filteredFinances, filteredOperations);
        }

        function updateFinancePageSummary(financeEntries, tradeOperations) {
            const targetCurrency = DB.settings.defaultCurrency;

            let totalIncome = 0;
            let totalExpenses = 0;
            financeEntries.forEach(entry => {
                let amount = convertCurrency(entry.amount, entry.currency, targetCurrency);
                if (amount > 0) totalIncome += amount;
                else totalExpenses += amount;
            });
            const netBalance = totalIncome + totalExpenses;
            const tradingMetrics = calculateMetrics(tradeOperations, 'all');

            const tradingPLEl = document.getElementById('finance-trading-pl');
            tradingPLEl.textContent = formatCurrency(tradingMetrics.totalWin + tradingMetrics.totalLoss, targetCurrency, targetCurrency);
            tradingPLEl.className = `text-xl font-bold ${(tradingMetrics.totalWin + tradingMetrics.totalLoss) >= 0 ? 'text-positive' : 'text-negative'}`;

            document.getElementById('finance-win-rate').textContent = `${tradingMetrics.winRate.toFixed(1)}%`;

            document.getElementById('finance-total-income').textContent = formatCurrency(totalIncome, targetCurrency, targetCurrency);
            document.getElementById('finance-total-expenses').textContent = formatCurrency(totalExpenses, targetCurrency, targetCurrency);
            const netBalanceEl = document.getElementById('finance-net-balance');
            netBalanceEl.textContent = formatCurrency(netBalance, targetCurrency, targetCurrency);
            netBalanceEl.className = `text-xl font-bold ${netBalance >= 0 ? 'text-green' : 'text-negative'}`;
        }


        function renderFinancesTable(entries) {
            const tableBody = document.getElementById('finances-table-body');
            tableBody.innerHTML = '';

            const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedEntries.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-text-secondary py-4">No hay movimientos en el per√≠odo seleccionado.</td></tr>';
                 return;
            }

            sortedEntries.forEach(entry => {
                const amountClass = entry.amount >= 0 ? 'text-positive' : 'text-negative';
                const row = `
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.notes}</td>
                        <td class="${amountClass} font-semibold hide-amount">${formatCurrency(entry.amount, entry.currency, entry.currency)}</td>
                        <td>${entry.currency}</td>
                        <td class="flex items-center justify-center space-x-2">
                            <button class="text-white edit-finance-btn" data-id="${entry.id}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="text-red delete-finance-btn" data-id="${entry.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Calendario Financiero
        let currentFinancialCalendarDate = new Date();
        
        function initFinancialCalendar() {
            const prevBtn = document.getElementById('finances-calendar-prev');
            const nextBtn = document.getElementById('finances-calendar-next');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    currentFinancialCalendarDate.setMonth(currentFinancialCalendarDate.getMonth() - 1);
                    renderFinancialCalendar(applyDateFilterToData(DB.finances), applyDateFilterToData(DB.operations));
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    currentFinancialCalendarDate.setMonth(currentFinancialCalendarDate.getMonth() + 1);
                    renderFinancialCalendar(applyDateFilterToData(DB.finances), applyDateFilterToData(DB.operations));
                });
            }
        }
        
        function renderFinancialCalendar(financeEntries, tradeOperations) {
            const container = document.getElementById('finances-calendar-container');
            const monthYearEl = document.getElementById('finances-calendar-month-year');
            
            if (!container || !monthYearEl) return;
            
            const year = currentFinancialCalendarDate.getFullYear();
            const month = currentFinancialCalendarDate.getMonth();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthYearEl.textContent = `${monthNames[month]} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeekIndex = firstDayOfMonth.getDay();
            
            const targetCurrency = DB.settings.defaultCurrency;
            
            // Agrupar datos por fecha (SOLO datos reales de DB.finances)
            const dailyData = {};
            
            // Procesar SOLO movimientos financieros reales
            financeEntries.forEach(entry => {
                const date = entry.date;
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, expenses: 0, hasWithdrawal: false, hasIncome: false, items: [] };
                }
                
                const amount = convertCurrency(entry.amount, entry.currency, targetCurrency);
                
                // Detectar si es retiro o ingreso
                if (entry.type === 'expense' || amount < 0) {
                    dailyData[date].expenses += Math.abs(amount);
                    dailyData[date].hasWithdrawal = true;
                } else if (entry.type === 'income' || amount > 0) {
                    dailyData[date].income += amount;
                    dailyData[date].hasIncome = true;
                }
                
                dailyData[date].items.push({ type: 'finance', ...entry, convertedAmount: amount });
            });
            
            // Crear HTML del calendario (IGUAL que calendario mensual)
            let calendarHTML = `
                <div class="grid grid-cols-8 gap-2 text-center font-bold p-2 mb-2 text-text-secondary text-xs">
                    <div>Dom</div>
                    <div>Lun</div>
                    <div>Mar</div>
                    <div>Mi√©</div>
                    <div>Jue</div>
                    <div>Vie</div>
                    <div>S√°b</div>
                    <div>Semana</div>
                </div>
                <div class="grid grid-cols-8 gap-2">
            `;
            
            // Celdas vac√≠as antes del primer d√≠a
            for (let i = 0; i < firstDayOfWeekIndex; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            let weeklyTotals = [];
            let currentWeekTotal = 0;
            let dayOfWeek = firstDayOfWeekIndex;
            let weekCounter = 1;
            
            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const data = dailyData[dateString];
                
                let cellClass = 'calendar-day';
                
                if (data) {
                    const totalBalance = data.income - data.expenses;
                    const isProfit = totalBalance > 0;
                    const isLoss = totalBalance < 0;
                    
                    cellClass += isProfit ? ' profit' : (isLoss ? ' loss' : '');
                    
                    // Marcar d√≠as con retiros/ingresos en verde fluorescente
                    if (data.hasWithdrawal || data.hasIncome) {
                        cellClass += ' border-primary';
                    }
                    
                    currentWeekTotal += totalBalance;
                    
                    calendarHTML += `
                        <div class="${cellClass}" data-day="${day}">
                            <div class="day-number">${day}</div>
                            <div class="day-profit ${isProfit ? 'positive' : (isLoss ? 'negative' : '')}" style="${(data.hasWithdrawal || data.hasIncome) ? 'color: #39ff14; font-weight: bold;' : ''}">${formatCurrency(totalBalance, targetCurrency, targetCurrency).replace(/\.\d+/, '')}</div>
                            <div class="day-trades">${data.items.length} mov.</div>
                        </div>
                    `;
                } else {
                    calendarHTML += `
                        <div class="${cellClass}">
                            <div class="day-number text-text-secondary">${day}</div>
                        </div>
                    `;
                }
                
                // Si es s√°bado o el √∫ltimo d√≠a del mes, agregar celda de semana
                dayOfWeek++;
                if (dayOfWeek === 7 || day === daysInMonth) {
                    const weekClass = currentWeekTotal > 0 ? 'text-positive' : currentWeekTotal < 0 ? 'text-negative' : '';
                    calendarHTML += `
                        <div class="week-summary" style="background-color: var(--surface); border: 1px solid var(--border);">
                            <div class="font-bold text-sm">Sem ${weekCounter}</div>
                            <div class="text-lg font-semibold ${weekClass}">${formatCurrency(currentWeekTotal, targetCurrency, targetCurrency).replace(/\.\d+/, '')}</div>
                            <div class="text-xs text-text-secondary">${Math.round(currentWeekTotal)} total</div>
                        </div>
                    `;
                    weeklyTotals.push(currentWeekTotal);
                    currentWeekTotal = 0;
                    dayOfWeek = 0;
                    weekCounter++;
                }
            }
            
            calendarHTML += '</div>';
            container.innerHTML = calendarHTML;
        }

        let currentCalendarDate = new Date();

        function initCalendar() {
            updateAccountSelect('calendar-account-select');
            initYearSelector();
            updateCalendar();
            
            const prevBtn = document.getElementById('prev-month');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => { 
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); 
                    updateCalendar();
                    updateYearSelector();
                });
            }
            
            const nextBtn = document.getElementById('next-month');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => { 
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); 
                    updateCalendar();
                    updateYearSelector();
                });
            }
            
            const accountSelect = document.getElementById('calendar-account-select');
            if (accountSelect) {
                accountSelect.addEventListener('change', function() {
                    const selectedAccount = this.value;
                    syncAccountSelection(selectedAccount);
                    updateCalendar();
                });
            }
            
            // Selectores de moneda y vista del calendario
            const currencySelect = document.getElementById('calendar-currency-select');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateCalendar);
            }
            
            const viewSelect = document.getElementById('calendar-view-select');
            if (viewSelect) {
                viewSelect.addEventListener('change', toggleCalendarView);
            }
            
            // Selector de a√±o
            const yearSelect = document.getElementById('calendar-year-select');
            if (yearSelect) {
                yearSelect.addEventListener('change', function() {
                    const selectedYear = parseInt(this.value);
                    currentCalendarDate.setFullYear(selectedYear);
                    updateCalendar();
                });
            }

            // Bot√≥n de filtros
            const filtersBtn = document.getElementById('calendar-filters-btn');
            if (filtersBtn) {
                filtersBtn.addEventListener('click', () => {
                    currentFilterSection = 'calendar';
                    toggleFiltersSidebar();
                });
            }

            // Bot√≥n de descarga
            const downloadBtn = document.getElementById('calendar-download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => downloadSectionPDF('calendar', 'Calendario'));
            }
        }
        
        function initYearSelector() {
            const yearSelect = document.getElementById('calendar-year-select');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            const startYear = 2020; // A√±o inicial
            const endYear = currentYear + 1; // A√±o actual + 1
            
            yearSelect.innerHTML = '';
            
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }
        
        function updateYearSelector() {
            const yearSelect = document.getElementById('calendar-year-select');
            if (!yearSelect) return;
            
            const currentYear = currentCalendarDate.getFullYear();
            yearSelect.value = currentYear;
        }

        function toggleCalendarView() {
            updateCalendar();
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        async function renderYearlyView(year, operations) {
            const yearlyContainer = document.getElementById('yearly-calendar-view');
            yearlyContainer.innerHTML = ''; // Clear previous content

            const dailyPnl = {};
            operations.forEach(op => {
                const date = op.date;
                if (!dailyPnl[date]) {
                    dailyPnl[date] = { pl: 0, ops: [] };
                }
                dailyPnl[date].pl += op.pl;
                dailyPnl[date].ops.push(op);
            });

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const weekDays = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];

            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'mini-calendar';

                const header = document.createElement('div');
                header.className = 'mini-calendar-header';
                header.textContent = `${monthNames[month]} ${year}`;
                
                // Add "Open" button to mini-calendar header
                const openBtn = document.createElement('button');
                openBtn.className = 'mini-calendar-open-btn';
                openBtn.textContent = 'Abrir';
                openBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Set the calendar to this specific month
                    currentCalendarDate = new Date(year, month, 1);
                    // Switch to monthly view
                    document.getElementById('calendar-view-select').value = 'monthly';
                    // Update the calendar
                    updateCalendar();
                });
                header.appendChild(openBtn);
                
                monthContainer.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'mini-calendar-grid';

                weekDays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'mini-calendar-weekday';
                    dayEl.textContent = day;
                    grid.appendChild(dayEl);
                });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) {
                    grid.appendChild(document.createElement('div'));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'mini-calendar-day';
                    dayCell.textContent = day;

                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (dailyPnl[dateStr]) {
                        dayCell.classList.add('operated');
                        if (dailyPnl[dateStr].pl > 0) {
                            dayCell.classList.add('profit');
                        } else if (dailyPnl[dateStr].pl < 0) {
                            dayCell.classList.add('loss');
                        }

                                                dayCell.addEventListener('click', () => {
                                                    const dateKeyYYYYMMDD = dateStr;
                                                    const titleLabel = `D√≠a: ${formatDate(dateKeyYYYYMMDD)}`;
                                                    const calendarSelectedAccount = document.getElementById('calendar-account-select').value;
                                                    openAnalyticsDetailModal('date', dateKeyYYYYMMDD, titleLabel, calendarSelectedAccount);
                                                });                    }
                    grid.appendChild(dayCell);
                }
                monthContainer.appendChild(grid);
                yearlyContainer.appendChild(monthContainer);
            }
        }

        updateCalendar = async function () {
            console.log('üîÑ updateCalendar() iniciado');
            
            if (!document.getElementById('calendar').classList.contains('active')) {
                console.log('‚ö†Ô∏è Calendar no est√° activo, cancelando refresh');
                return;
            }

            const accountSelect = document.getElementById('calendar-account-select');
            const currencySelect = document.getElementById('calendar-currency-select');
            const viewSelect = document.getElementById('calendar-view-select');
            
            if (!accountSelect || !currencySelect || !viewSelect) return;
            
            const selectedAccount = accountSelect.value;
            const currencyMode = currencySelect.value;
            const viewMode = viewSelect.value;
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            console.log('üìä Calendar - Cuenta seleccionada:', selectedAccount);
            console.log('üìÖ Calendar - Filtro de fecha:', globalDateFilter);

            const monthlyView = document.getElementById('monthly-calendar-view');
            const yearlyView = document.getElementById('yearly-calendar-view');
            const monthNav = document.getElementById('calendar-month-navigation');
            const monthlySummary = document.querySelector('#calendar > .mt-8');
            const weeklyTrend = document.querySelector('#calendar > .mt-8 + .mt-8');

            if (viewMode === 'general') {
                monthlyView.style.display = 'none';
                monthNav.style.display = 'none';
                if(monthlySummary) monthlySummary.style.display = 'none';
                if(weeklyTrend) weeklyTrend.style.display = 'none';
                yearlyView.style.display = 'grid';
                yearlyView.classList.remove('hidden');

                // Aplicar filtro de fecha global
                let allOps = applyDateFilterToData(DB.operations);
                console.log('üìÖ Despu√©s de filtro de fecha (yearly):', allOps.length, 'operaciones');
                
                if (selectedAccount !== 'all') {
                    allOps = allOps.filter(op => op.accountId === selectedAccount);
                    console.log('üë§ Despu√©s de filtro de cuenta (yearly):', allOps.length, 'operaciones');
                }

                await renderYearlyView(year, allOps);
                return;
            }

            // Show monthly view if not 'general'
            monthlyView.style.display = 'block';
            monthNav.style.display = 'flex';
            if(monthlySummary) monthlySummary.style.display = 'block';
            if(weeklyTrend) weeklyTrend.style.display = 'block';
            yearlyView.style.display = 'none';
            yearlyView.classList.add('hidden');

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            // Aplicar filtro de fecha global primero
            let filteredOps = applyDateFilterToData(DB.operations);
            console.log('üìÖ Despu√©s de filtro de fecha (monthly):', filteredOps.length, 'operaciones');
            
            // Luego filtrar por mes y cuenta
            let monthOperations = filteredOps.filter(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                return opDate.getUTCMonth() === month && opDate.getUTCFullYear() === year && (selectedAccount === 'all' || op.accountId === selectedAccount);
            });
            
            console.log('üìä Calendar - Operaciones del mes:', monthOperations.length);

            const dailyData = {}; const weeklyData = {};
            let baseCurrencyForCalc = DB.settings.defaultCurrency;
            let initialBalanceForPercent = 0;

            if (selectedAccount !== 'all') {
                const account = DB.accounts.find(a => a.id === selectedAccount);
                if (account) {
                    baseCurrencyForCalc = account.currency;
                    initialBalanceForPercent = account.initialBalance;
                }
            } else {
                initialBalanceForPercent = DB.accounts.reduce((sum, acc) => {
                    return sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency);
                }, 0);
                baseCurrencyForCalc = DB.settings.defaultCurrency;
            }

            // Agrupar operaciones por ID antes de procesar
            const groupedOps = {};
            monthOperations.forEach(op => {
                const opId = op.id;
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        id: opId,
                        operations: [],
                        totalPL: 0,
                        date: op.date,
                        currency: op.currency
                    };
                }
                groupedOps[opId].operations.push(op);
                groupedOps[opId].totalPL += op.pl;
            });

            const uniqueTradeGroups = Object.values(groupedOps);

            uniqueTradeGroups.forEach(group => {
                const date = new Date(group.date + 'T00:00:00Z');
                const day = date.getUTCDate();
                const weekNumber = getWeekNumber(date);
                if (!dailyData[day]) dailyData[day] = { operations: [], totalPL: 0, count: 0 };
                if (!weeklyData[weekNumber]) weeklyData[weekNumber] = { operations: [], totalPL: 0, count: 0, weekNumber: weekNumber };

                let pl = group.totalPL;
                if (group.currency !== baseCurrencyForCalc) {
                    pl = convertCurrency(pl, group.currency, baseCurrencyForCalc);
                }
                dailyData[day].operations.push(group); dailyData[day].totalPL += pl; dailyData[day].count++;
                weeklyData[weekNumber].operations.push(group); weeklyData[weekNumber].totalPL += pl; weeklyData[weekNumber].count++;
            });

            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const daysInMonth = lastDayOfMonth.getUTCDate();
            const firstDayOfWeekIndex = firstDayOfMonth.getUTCDay();

            let weekCounter = 1; // Contador secuencial de semanas del mes

            for (let i = 0; i < firstDayOfWeekIndex; i++) {
                grid.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(Date.UTC(year, month, day));
                const dayOfWeekIndex = currentDate.getUTCDay();
                const dayData = dailyData[day];
                let cellHTML = `<div class="calendar-day `;

                if (dayData) {
                    const isProfit = dayData.totalPL > 0; const isLoss = dayData.totalPL < 0;
                    cellHTML += isProfit ? 'profit' : (isLoss ? 'loss' : '');
                    cellHTML += `" data-day="${day}">`;
                    cellHTML += `<div class="day-number">${day}</div>`;
                    let formattedPL;
                    if (currencyMode === '%') {
                        const percentage = initialBalanceForPercent > 0 ? (dayData.totalPL / initialBalanceForPercent) * 100 : 0;
                        formattedPL = percentage.toFixed(2) + '%';
                    } else {
                        formattedPL = formatCurrency(dayData.totalPL, baseCurrencyForCalc, currencyMode);
                    }
                    cellHTML += `<div class="day-profit ${isProfit ? 'positive' : (isLoss ? 'negative' : '')}">${formattedPL}</div>`;
                    cellHTML += `<div class="day-trades">${dayData.count} op.</div>`;
                } else {
                    cellHTML += `" data-day="${day}">`;
                    cellHTML += `<div class="day-number text-text-secondary">${day}</div>`;
                }
                cellHTML += `</div>`;
                grid.innerHTML += cellHTML;

                if (dayOfWeekIndex === 6) {
                    const weekNumber = getWeekNumber(currentDate);
                    const weekData = weeklyData[weekNumber] || { totalPL: 0, count: 0, weekNumber: weekNumber };
                    const isWeekProfit = weekData.totalPL > 0; const isWeekLoss = weekData.totalPL < 0;
                    let formattedWeekPL;
                    if (currencyMode === '%') {
                        const percentage = initialBalanceForPercent > 0 ? (weekData.totalPL / initialBalanceForPercent) * 100 : 0;
                        formattedWeekPL = percentage.toFixed(2) + '%';
                    } else {
                        formattedWeekPL = formatCurrency(weekData.totalPL, baseCurrencyForCalc, currencyMode);
                    }
                    grid.innerHTML += `<div class="week-summary" style="background-color: var(--surface); border: 1px solid var(--surface-light)">
                                          <div class="font-bold text-sm">Sem ${weekCounter}</div>
                                          <div class="text-lg font-semibold ${isWeekProfit ? 'text-positive' : (isWeekLoss ? 'text-negative' : '')}">${formattedWeekPL}</div>
                                          <div class="text-xs text-text-secondary">${weekData.count} trades</div>
                                       </div>`;
                    weekCounter++;
                }
            }

            if (lastDayOfMonth.getUTCDay() !== 6) {
                for (let i = lastDayOfMonth.getUTCDay() + 1; i <= 6; i++) {
                    grid.innerHTML += `<div class="calendar-day empty"></div>`;
                }
                const weekNumber = getWeekNumber(lastDayOfMonth);
                const weekData = weeklyData[weekNumber] || { totalPL: 0, count: 0, weekNumber: weekNumber };
                const isWeekProfit = weekData.totalPL > 0; const isWeekLoss = weekData.totalPL < 0;

                let formattedWeekPL;
                if (currencyMode === '%') {
                    const percentage = initialBalanceForPercent > 0 ? (weekData.totalPL / initialBalanceForPercent) * 100 : 0;
                    formattedWeekPL = percentage.toFixed(2) + '%';
                } else {
                    formattedWeekPL = formatCurrency(weekData.totalPL, baseCurrencyForCalc, currencyMode);
                }
                grid.innerHTML += `<div class="week-summary" style="background-color: var(--surface); border: 1px solid var(--surface-light)">
                                      <div class="font-bold text-sm">Sem ${weekCounter}</div>
                                      <div class="text-lg font-semibold ${isWeekProfit ? 'text-positive' : (isWeekLoss ? 'text-negative' : '')}">${formattedWeekPL}</div>
                                      <div class="text-xs text-text-secondary">${weekData.count} trades</div>
                                   </div>`;
            }

            grid.querySelectorAll('.calendar-day:not(.empty)').forEach(cell => {
                const dayHasData = dailyData[parseInt(cell.dataset.day)];
                if (dayHasData) {
                    cell.onclick = () => {
                        const day = parseInt(cell.dataset.day, 10); if (isNaN(day)) return;
                        const dateKeyYYYYMMDD = getLocalDateString(new Date(year, month, day));
                        const allOpsForDay = DB.operations.filter(op => op.date === dateKeyYYYYMMDD && (selectedAccount === 'all' || op.accountId === selectedAccount));
                        
                        // Usar la funci√≥n centralizada para agrupar operaciones parciales
                        const groupedOperations = groupPartialOperations(allOpsForDay);
                        
                        // Preparar operaciones para el modal con informaci√≥n de parciales
                        const opsForDay = groupedOperations.map(op => {
                            // Agregar flag de agrupado si tiene parciales
                            const hasPartials = op.partials && op.partials.length > 0;
                            return {
                                ...op,
                                isGrouped: hasPartials
                            };
                        });

                        let totalPLForDayInModalCurrency = opsForDay.reduce((sum, op) => {
                            let plConverted = op.pl;
                            if (op.currency !== baseCurrencyForCalc) {
                                plConverted = convertCurrency(op.pl, op.currency, baseCurrencyForCalc);
                            }
                            return sum + plConverted;
                        }, 0);
                        openDayDetailModal(dateKeyYYYYMMDD, opsForDay, totalPLForDayInModalCurrency, baseCurrencyForCalc);
                    };
                }
            });

            updateMonthSummary(monthOperations, baseCurrencyForCalc);
            updateWeeklyTrendChart(weeklyData, baseCurrencyForCalc, initialBalanceForPercent);
        };


        function updateMonthSummary(operations, baseCurrency) {
            let totalPL = 0; let tradingDays = 0; let winDays = 0; let loseDays = 0; const dailyPL = {};
            const currencyMode = document.getElementById('calendar-currency-select') ? document.getElementById('calendar-currency-select').value : 'USD';

            // Agrupar operaciones por ID primero
            const groupedOps = {};
            operations.forEach(op => {
                const opId = op.id;
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        id: opId,
                        totalPL: 0,
                        date: op.date,
                        currency: op.currency
                    };
                }
                groupedOps[opId].totalPL += op.pl;
            });

            // Calcular P&L diario basado en operaciones agrupadas
            Object.values(groupedOps).forEach(group => {
                const date = group.date;
                if (!dailyPL[date]) dailyPL[date] = 0;
                let pl = group.totalPL;
                if (group.currency !== baseCurrency) pl = convertCurrency(pl, group.currency, baseCurrency);
                dailyPL[date] += pl;
                totalPL += pl;
            });
            
            Object.values(dailyPL).forEach(dayPL => { tradingDays++; if (dayPL > 0) winDays++; else if (dayPL < 0) loseDays++; });

            let initialBalanceForPercent = 0;
            const selectedAccount = document.getElementById('calendar-account-select').value;
            if (currencyMode === '%') {
                if (selectedAccount !== 'all') {
                    const account = DB.accounts.find(a => a.id === selectedAccount);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, baseCurrency);
                } else {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, baseCurrency), 0);
                }
            }

            let plDisplay;
            if (currencyMode === '%') {
                plDisplay = initialBalanceForPercent > 0 ? ((totalPL / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                plDisplay = formatCurrency(totalPL, baseCurrency, currencyMode);
            }
            const monthlyPlEl = document.getElementById('monthly-pl');
            monthlyPlEl.textContent = plDisplay;
            monthlyPlEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('monthly-trading-days').textContent = tradingDays;
            document.getElementById('monthly-winning-days').textContent = winDays;
            document.getElementById('monthly-losing-days').textContent = loseDays;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Funci√≥n global para guardar operaciones
        async function saveOperation() {
            console.log('üîç INICIO: saveOperation ejecut√°ndose...');
            showLoading(true);

            const formContainer = document.getElementById('add-operation-form');
            const editingId = formContainer.dataset.editingId;

            const date = document.getElementById('op-date').value;
            const accountId = document.getElementById('op-account').value;
            const instrument = document.getElementById('op-instrument').value.toUpperCase().trim();
            const type = document.getElementById('op-type').value;
            const entry = parseFloat(document.getElementById('op-entry').value);
            const exit = parseFloat(document.getElementById('op-exit').value);
            const entryTime = document.getElementById('op-entry-time').value;
            const exitTime = document.getElementById('op-exit-time').value;
            const volume = parseFloat(document.getElementById('op-volume').value);
            const currency = document.getElementById('op-currency').value;
            const notes = document.getElementById('op-notes').value.trim();
            let session = document.getElementById('op-session').value.trim();
            
            // Detectar autom√°ticamente la sesi√≥n basada en la hora de entrada
            if (!session || session === '') {
                session = detectTradingSession(entryTime);
                console.log(`üïê Sesi√≥n detectada autom√°ticamente: ${session} (hora entrada: ${entryTime})`);
            }
            
            const setupId = document.getElementById('op-setup').value.trim();
            const manualPLValue = document.getElementById('op-manual-pl').value;
            const fees = parseFloat(document.getElementById('op-fees').value) || 0;

            const isWinSelected = document.getElementById('op-win-btn').dataset.selected === 'true';
            const isLossSelected = document.getElementById('op-loss-btn').dataset.selected === 'true';

            let result;
            let finalPL;
            let manualPLInputVal = null;

            if (!date || !accountId || !instrument || isNaN(volume) || volume <= 0) {
                alert('Por favor, complete todos los campos obligatorios (Fecha, Cuenta, Instrumento, Volumen > 0).');
                showLoading(false); return;
            }

            if (manualPLValue.trim() !== "") {
                manualPLInputVal = parseFloat(manualPLValue);
                if (isNaN(manualPLInputVal)) {
                    alert('P&L Manual no es un n√∫mero v√°lido.');
                    showLoading(false); return;
                }
                finalPL = manualPLInputVal;
                if (manualPLInputVal > 0) result = 'win';
                else if (manualPLInputVal < 0) result = 'loss';
                else result = 'breakeven';
            } else {
                if (isNaN(entry) || isNaN(exit)) {
                    alert('Por favor, ingrese precios de Entrada y Salida v√°lidos, o ingrese un P&L Manual.');
                    showLoading(false); return;
                }
                if (entry !== exit && !isWinSelected && !isLossSelected) {
                    alert('Por favor, seleccione si la operaci√≥n fue Ganancia o P√©rdida, o ingrese un P&L Manual.');
                    showLoading(false); return;
                }

                if (entry === exit) {
                    result = 'breakeven';
                    finalPL = 0;
                } else {
                    result = isWinSelected ? 'win' : 'loss';
                    if (type === 'buy') finalPL = (exit - entry) * volume;
                    else finalPL = (entry - exit) * volume;

                    if ((result === 'win' && finalPL <= 0) || (result === 'loss' && finalPL >= 0)) {
                        if (!confirm(`El P&L calculado (${finalPL.toFixed(2)} ${currency}) no coincide con el resultado ('${result}') seleccionado. Si contin√∫a, se guardar√° con el resultado '${result}' y el P&L calculado. ¬øDesea continuar?`)) {
                            showLoading(false); return;
                        }
                    }
                }
            }
            finalPL = parseFloat(finalPL.toFixed(5));
            
            // Capturar nota de voz si existe
            const voiceData = document.getElementById('op-voice-data').value;

            let operationData = {
                id: editingId || generateId(),
                date, accountId, instrument, type,
                entry: isNaN(entry) ? null : entry,
                exit: isNaN(exit) ? null : exit,
                entryTime, exitTime,
                volume,
                result, pl: finalPL,
                fees: fees,
                currency, notes,
                voiceNote: voiceData || null,
                imageDatas: [...currentEditingOpImages],
                manualPL: manualPLInputVal,
                session: session,
                setupId: setupId || null,
                setupUsed: setupId || null
            };

            try {
                // GUARDAR PRIMERO LOCALMENTE (siempre funciona)
                if (editingId) {
                    await dexieDB.operations.update(editingId, operationData);
                    const index = DB.operations.findIndex(op => op.id === editingId);
                    if (index !== -1) {
                        DB.operations[index] = { ...DB.operations[index], ...operationData };
                        // IMPORTANTE: Tambi√©n actualizar en dexieDB para evitar que desaparezca
                        await dexieDB.operations.update(editingId, operationData);
                    }
                    console.log('‚úÖ Operaci√≥n actualizada localmente y en dexieDB');
                } else {
                    await dexieDB.operations.add(operationData);
                    DB.operations.push(operationData);
                    console.log('‚úÖ Operaci√≥n guardada localmente');
                }

                console.log('üîç LLEGANDO A SINCRONIZACI√ìN...');
                // SINCRONIZACI√ìN AUTOM√ÅTICA EN SEGUNDO PLANO (invisible para el usuario)
                console.log('üîç currentUser:', currentUser);
                console.log('üîç ¬øUsuario existe?', !!currentUser);
                console.log('üîç currentUser.id:', currentUser?.id);
                console.log('üîç operationData:', operationData);
                
                if (currentUser && currentUser.id) {
                    console.log('üîç Iniciando guardado en Supabase...');
                    console.log('üîç Operaci√≥n a guardar:', {
                        id: operationData.id,
                        user_id: currentUser.id,
                        account_id: operationData.accountId,
                        instrument: operationData.instrument
                    });
                    
                    // Intentar guardar autom√°ticamente sin bloquear la UI
                    saveOperationToSupabase(operationData).then((result) => {
                        console.log('‚úÖ Operaci√≥n sincronizada con Supabase:', result);
                        showSyncNotification('üíæ Operaci√≥n guardada y sincronizada', 'success');
                    }).catch((supabaseError) => {
                        console.error('‚ùå Error de sincronizaci√≥n autom√°tica:', supabaseError);
                        console.error('‚ùå Detalles del error:', supabaseError.message, supabaseError.stack);
                        // Guardar en cola de pendientes para reintento posterior
                        addToSyncQueue(operationData, 'operation');
                        showSyncNotification('üíæ Operaci√≥n guardada localmente (pendiente de sincronizar)', 'warning');
                    });
                } else {
                    // Usuario no autenticado - solo local
                    console.log('‚ö†Ô∏è NO HAY USUARIO O NO TIENE ID - no se guarda en Supabase');
                    console.log('‚ö†Ô∏è currentUser completo:', JSON.stringify(currentUser));
                    showSyncNotification('üíæ Operaci√≥n guardada localmente', 'info');
                }

                // Actualizar vistas inmediatamente con datos locales
                updateAccountBalances();
                toggleAddOperationForm();
                refreshAllViews();

                // Mensaje de confirmaci√≥n inmediato
                showSyncNotification('‚úÖ Operaci√≥n guardada exitosamente', 'success');

            } catch (e) {
                console.error("Error saving operation:", e);
                alert("Error al guardar la operaci√≥n.");
            } finally {
                showLoading(false);
            }
        }

        // === Inject user-provided summary metrics (one-time UI update) ===
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Values provided by the user
                const provided = {
                    accountDetailPL: '$2,468.43',
                    winRate: '63%',
                    profitFactor: '3.06',
                    totalTrades: '83',
                    totalCommissions: '$11.27'
                };

                const setIfExists = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                setIfExists('account-detail-pl', provided.accountDetailPL);
                setIfExists('finance-trading-pl', provided.accountDetailPL);
                setIfExists('finance-win-rate', provided.winRate);
                setIfExists('account-detail-pf', provided.profitFactor);
                setIfExists('account-detail-trades', provided.totalTrades);
                setIfExists('finance-total-expenses', provided.totalCommissions);
            } catch (e) {
                console.error('Error applying provided summary metrics:', e);
            }
        });

        function initOperations() {
            updateAccountSelect('op-account');
            updateAccountSelect('filter-account');

            document.getElementById('add-operation-btn').addEventListener('click', () => toggleAddOperationForm());
            document.getElementById('op-cancel').addEventListener('click', () => toggleAddOperationForm());
            document.getElementById('op-save').addEventListener('click', saveOperation);
            document.getElementById('filter-account').addEventListener('change', function() {
                const selectedAccount = this.value;
                syncAccountSelection(selectedAccount);
                refreshOperationsTable();
            });
            document.getElementById('filter-instrument').addEventListener('input', refreshOperationsTable);

            // NUEVO: Listener para ordenar la tabla
            document.querySelector('#operations-table-render thead').addEventListener('click', (event) => {
                const header = event.target.closest('th');
                if (!header || !header.dataset.sort) return;

                const column = header.dataset.sort;
                if (operationSortState.column === column) {
                    operationSortState.order = operationSortState.order === 'asc' ? 'desc' : 'asc';
                } else {
                    operationSortState.column = column;
                    operationSortState.order = 'desc';
                }
                refreshOperationsTable();
            });

            const winBtn = document.getElementById('op-win-btn');
            const lossBtn = document.getElementById('op-loss-btn');
            winBtn.addEventListener('click', function () {
                winBtn.classList.add('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.remove('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'true'; lossBtn.dataset.selected = 'false';
            });
            lossBtn.addEventListener('click', function () {
                lossBtn.classList.add('bg-red'); winBtn.classList.remove('bg-green');
                lossBtn.classList.remove('bg-surface-light'); winBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'true';
            });

            const priceInputs = ['op-entry', 'op-exit', 'op-volume', 'op-type', 'op-manual-pl'];
            priceInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', autoSelectWinLoss);
                    element.addEventListener('change', autoSelectWinLoss);
                }
            });

            // Auto-detectar sesi√≥n basada en hora de entrada
            document.getElementById('op-entry-time').addEventListener('change', autoDetectTradingSession);
            document.getElementById('op-entry-time').addEventListener('blur', autoDetectTradingSession);

            document.getElementById('op-manual-pl').addEventListener('input', function () {
                if (this.value.trim() !== "") {
                    const manualPLValue = parseFloat(this.value);
                    if (!isNaN(manualPLValue)) {
                        if (manualPLValue > 0) document.getElementById('op-win-btn').click();
                        else if (manualPLValue < 0) document.getElementById('op-loss-btn').click();
                        else {
                            const winBtn = document.getElementById('op-win-btn');
                            const lossBtn = document.getElementById('op-loss-btn');
                            winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                            winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                            winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                        }
                    }
                } else {
                    autoSelectWinLoss();
                }
            });

            document.getElementById('op-image').addEventListener('change', handleOpImageSelection);
            document.getElementById('operations-table-render').addEventListener('click', handleOperationsTableClick);
            
            // Inicializar grabadora de voz para notas
            initVoiceRecorder();
            
            refreshOperationsTable();
        }

        // ============================================
        // SISTEMA DE GRABACI√ìN DE VOZ PARA NOTAS
        // ============================================
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        function initVoiceRecorder() {
            const recordBtn = document.getElementById('op-voice-record-btn');
            if (!recordBtn) return;

            recordBtn.addEventListener('click', async function() {
                if (!isRecording) {
                    await startVoiceRecording();
                } else {
                    stopVoiceRecording();
                }
            });
        }

        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        document.getElementById('op-voice-data').value = base64Audio;
                        
                        // Mostrar reproductor
                        const playback = document.getElementById('op-voice-playback');
                        playback.src = base64Audio;
                        playback.style.display = 'block';
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    // Detener todas las pistas de audio
                    stream.getTracks().forEach(track => track.stop());
                });

                mediaRecorder.start();
                isRecording = true;
                
                // Actualizar UI
                const recordBtn = document.getElementById('op-voice-record-btn');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i> Detener Grabaci√≥n';
                recordBtn.style.background = '#FF0000';
                recordBtn.style.color = 'white';
                
                document.getElementById('op-voice-status').textContent = 'Grabando...';
                
            } catch (error) {
                console.error('Error al acceder al micr√≥fono:', error);
                alert('No se pudo acceder al micr√≥fono. Verifica los permisos.');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Restaurar UI
                const recordBtn = document.getElementById('op-voice-record-btn');
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Grabar Nota de Voz';
                recordBtn.style.background = '#39FF14';
                recordBtn.style.color = 'black';
                
                document.getElementById('op-voice-status').textContent = 'Nota de voz guardada';
            }
        }


        function handleOpImageSelection(event) {
            const files = event.target.files;
            const MAX_IMAGES = 5;

            for (let i = 0; i < files.length; i++) {
                if (currentEditingOpImages.length >= MAX_IMAGES) {
                    alert(`Puedes adjuntar un m√°ximo de ${MAX_IMAGES} im√°genes.`);
                    break;
                }
                const file = files[i];
                if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
                    alert('Formato de imagen no v√°lido. Por favor, selecciona PNG, JPG o JPEG.');
                    continue;
                }
                const maxSizeMB = 2;
                if (file.size > maxSizeMB * 1024 * 1024) {
                    alert(`La imagen "${file.name}" es demasiado grande (M√°x: ${maxSizeMB}MB).`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    if (currentEditingOpImages.length < MAX_IMAGES) {
                        currentEditingOpImages.push(e.target.result);
                        renderOpImagePreviews();
                    }
                }
                reader.onerror = function () { alert(`Error al leer la imagen "${file.name}".`); }
                reader.readAsDataURL(file);
            }
            event.target.value = null;
        }

        function renderOpImagePreviews() {
            const container = document.getElementById('op-image-previews-container');
            container.innerHTML = '';
            currentEditingOpImages.forEach((imageDataUrl, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'op-image-preview-item h-20 w-full';
                previewItem.innerHTML = `
                    <img src="${imageDataUrl}" alt="Preview ${index + 1}" class="object-cover h-full w-full">
                    <button type="button" class="op-image-remove-btn" data-index="${index}">&times;</button>
                `;
                container.appendChild(previewItem);
            });

            container.querySelectorAll('.op-image-remove-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const indexToRemove = parseInt(this.dataset.index);
                    currentEditingOpImages.splice(indexToRemove, 1);
                    renderOpImagePreviews();
                });
            });
        }


        function autoSelectWinLoss() {
            const entryPrice = parseFloat(document.getElementById('op-entry').value);
            const exitPrice = parseFloat(document.getElementById('op-exit').value);
            const type = document.getElementById('op-type').value;
            const manualPL = document.getElementById('op-manual-pl').value;

            if (manualPL.trim() !== "") return;

            const winBtn = document.getElementById('op-win-btn');
            const lossBtn = document.getElementById('op-loss-btn');

            if (isNaN(entryPrice) || isNaN(exitPrice) || entryPrice === 0 || exitPrice === 0) {
                winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                return;
            }

            let isWin = false;
            if (type === 'buy' && exitPrice > entryPrice) isWin = true;
            else if (type === 'sell' && entryPrice > exitPrice) isWin = true;

            if (entryPrice === exitPrice) {
                winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                return;
            }

            if (isWin) winBtn.click();
            else lossBtn.click();
        }

        // Funci√≥n para detectar sesi√≥n autom√°ticamente basada en la hora
        function autoDetectTradingSession() {
            const entryTimeInput = document.getElementById('op-entry-time');
            const sessionSelect = document.getElementById('op-session');
            
            if (!entryTimeInput.value) return; // Si no hay hora, no hacer nada
            
            const time = entryTimeInput.value; // formato "HH:MM"
            const detectedSession = detectTradingSession(time);
            
            // Solo actualizar si se detect√≥ una sesi√≥n v√°lida
            if (detectedSession) {
                sessionSelect.value = detectedSession;
                console.log(`üïê Sesi√≥n auto-detectada: ${detectedSession} (hora: ${time})`);
            }
        }

        function toggleAddOperationForm(operationToEdit = null) {
            const formContainer = document.getElementById('add-operation-form');
            const isVisible = formContainer.style.display === 'block';
            const imageInput = document.getElementById('op-image');
            const manualPLInput = document.getElementById('op-manual-pl');
            currentEditingOpImages = [];

            if (!isVisible) {
                formContainer.style.display = 'block';
                document.getElementById('add-operation-btn').textContent = 'Ocultar Formulario';
                document.getElementById('operation-details-form').reset();

                // Populate setup dropdown
                const setupSelect = document.getElementById('op-setup');
                setupSelect.innerHTML = '<option value="">Ninguno</option>';
                if (DB.setups && DB.setups.length > 0) {
                    DB.setups.forEach(setup => {
                        const option = document.createElement('option');
                        option.value = setup.id;
                        option.textContent = setup.name;
                        setupSelect.appendChild(option);
                    });
                }

                if (operationToEdit) {
                    formContainer.querySelector('h3').textContent = 'Editar Operaci√≥n';
                    document.getElementById('op-date').value = operationToEdit.date;
                    document.getElementById('op-account').value = operationToEdit.accountId;
                    document.getElementById('op-instrument').value = operationToEdit.instrument;
                    document.getElementById('op-type').value = operationToEdit.type;
                    document.getElementById('op-entry').value = operationToEdit.entry;
                    document.getElementById('op-exit').value = operationToEdit.exit;
                    document.getElementById('op-entry-time').value = operationToEdit.entryTime || '';
                    document.getElementById('op-exit-time').value = operationToEdit.exitTime || '';
                    document.getElementById('op-volume').value = operationToEdit.volume;
                    document.getElementById('op-currency').value = operationToEdit.currency;
                    document.getElementById('op-notes').value = operationToEdit.notes;
                    document.getElementById('op-session').value = operationToEdit.session || ''; // Cargar campo Sesi√≥n
                    document.getElementById('op-setup').value = operationToEdit.setupId || operationToEdit.setupUsed || ''; // Cargar campo Setup
                    manualPLInput.value = operationToEdit.manualPL !== null && typeof operationToEdit.manualPL !== 'undefined' ? operationToEdit.manualPL : '';

                    // Cargar nota de voz si existe
                    if (operationToEdit.voiceNote) {
                        document.getElementById('op-voice-data').value = operationToEdit.voiceNote;
                        const playback = document.getElementById('op-voice-playback');
                        playback.src = operationToEdit.voiceNote;
                        playback.style.display = 'block';
                        document.getElementById('op-voice-status').textContent = 'Nota de voz guardada';
                    } else {
                        document.getElementById('op-voice-data').value = '';
                        document.getElementById('op-voice-playback').style.display = 'none';
                        document.getElementById('op-voice-status').textContent = '';
                    }

                    if (operationToEdit.imageDatas && Array.isArray(operationToEdit.imageDatas)) {
                        currentEditingOpImages = [...operationToEdit.imageDatas];
                    }
                    renderOpImagePreviews();
                    imageInput.value = '';

                    if (operationToEdit.result === 'win') document.getElementById('op-win-btn').click();
                    else if (operationToEdit.result === 'loss') document.getElementById('op-loss-btn').click();
                    else {
                        const winBtn = document.getElementById('op-win-btn'); const lossBtn = document.getElementById('op-loss-btn');
                        winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                        winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                        winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                    }
                    formContainer.dataset.editingId = operationToEdit.id;
                } else {
                    formContainer.querySelector('h3').textContent = 'Nueva Operaci√≥n';
                    document.getElementById('op-date').value = getLocalDateString(new Date());
                    document.getElementById('op-account').value = DB.accounts.length > 0 ? DB.accounts[0].id : '';
                    document.getElementById('op-currency').value = DB.settings.defaultCurrency;
                    document.getElementById('op-session').value = ''; // Limpiar campo Sesi√≥n (se auto-detectar√°)
                    document.getElementById('op-setup').value = ''; // Limpiar campo Setup
                    
                    // Auto-establecer hora de entrada actual y detectar sesi√≥n
                    const currentTime = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
                    document.getElementById('op-entry-time').value = currentTime;
                    autoDetectTradingSession();
                    
                    // Limpiar nota de voz
                    document.getElementById('op-voice-data').value = '';
                    document.getElementById('op-voice-playback').style.display = 'none';
                    document.getElementById('op-voice-status').textContent = '';
                    
                    renderOpImagePreviews();
                    imageInput.value = '';
                    manualPLInput.value = '';
                    const winBtn = document.getElementById('op-win-btn'); const lossBtn = document.getElementById('op-loss-btn');
                    winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                    winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                    winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                    delete formContainer.dataset.editingId;
                }
                autoSelectWinLoss();
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                formContainer.style.display = 'none';
                document.getElementById('add-operation-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>A√±adir Operaci√≥n';
                delete formContainer.dataset.editingId;
                currentEditingOpImages = [];
                renderOpImagePreviews();
                imageInput.value = '';
                manualPLInput.value = '';
                document.getElementById('operation-details-form').reset();
            }
        }

        // ============================================
        // FUNCIONES DE M√âTRICAS DE OPERACIONES
        // ============================================

        function updateOperationsMetrics() {
            try {
                // Validar que DB.operations est√© inicializado
                if (!DB || !DB.operations) {
                    console.log('DB.operations no est√° inicializado a√∫n');
                    return;
                }

                // Obtener operaciones filtradas actual
                let operations = [...DB.operations];

                // Aplicar filtros actuales
                const accountFilter = document.getElementById('filter-account')?.value;
                const instrumentFilter = document.getElementById('filter-instrument')?.value?.toLowerCase();

                if (accountFilter && accountFilter !== 'all') {
                    operations = operations.filter(op => op.accountId === accountFilter);
                }

                if (instrumentFilter) {
                    operations = operations.filter(op =>
                        op.instrument && op.instrument.toLowerCase().includes(instrumentFilter)
                    );
                }

                // Aplicar filtro de fecha global
                if (globalDateFilter && globalDateFilter.type !== 'all' && globalDateFilter.startDate && globalDateFilter.endDate) {
                    operations = operations.filter(op => {
                        return op.date >= globalDateFilter.startDate && op.date <= globalDateFilter.endDate;
                    });
                }

                // Calcular m√©tricas
                const metrics = calculateOperationsMetrics(operations);

                // Actualizar UI
                updateMetricsUI(metrics);

                // Actualizar gr√°fico de P&L acumulado
                updateCumulativePLChart(operations);

            } catch (error) {
                console.error('Error actualizando m√©tricas:', error);
            }
        }

        function calculateOperationsMetrics(operations) {
            const metrics = {
                totalOperations: 0,
                cumulativePL: 0,
                cumulativePLNet: 0,
                totalFees: 0,
                roi: 0,
                grossWin: 0,
                grossLoss: 0,
                profitFactor: 0,
                wins: 0,
                losses: 0,
                winRate: 0
            };

            if (operations.length === 0) return metrics;

            // AGRUPAR por ID: 1 trade = 1 grupo (parciales juntas)
            const groupedOps = {};
            
            operations.forEach(op => {
                const opId = op.id;
                
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        id: opId,
                        totalPL: 0,
                        totalFees: 0
                    };
                }
                
                // SUMAR P&L de todas las parciales
                groupedOps[opId].totalPL += (op.manualPL || op.pl || 0);
                // Soportar tanto 'fee' como 'fees' (ambos campos existen en diferentes importaciones)
                groupedOps[opId].totalFees += (op.fee || op.fees || 0);
            });

            const uniqueTrades = Object.values(groupedOps);
            metrics.totalOperations = uniqueTrades.length;

            // Calcular m√©tricas por TRADE COMPLETO
            uniqueTrades.forEach(trade => {
                const pl = trade.totalPL;
                const fee = trade.totalFees;
                
                metrics.cumulativePL += pl;
                metrics.totalFees += fee;
                
                // Win/Loss basado en resultado FINAL del trade
                if (pl > 0) {
                    metrics.grossWin += pl;
                    metrics.wins++;
                } else if (pl < 0) {
                    metrics.grossLoss += Math.abs(pl);
                    metrics.losses++;
                }
            });
            
            // P&L neto despu√©s de comisiones
            metrics.cumulativePLNet = metrics.cumulativePL - metrics.totalFees;

            // Calcular Profit Factor
            if (metrics.grossLoss > 0) {
                metrics.profitFactor = metrics.grossWin / metrics.grossLoss;
            } else if (metrics.grossWin > 0) {
                metrics.profitFactor = 999; // Infinito (solo ganancias)
            }

            // Calcular Win Rate
            const totalTrades = metrics.wins + metrics.losses;
            if (totalTrades > 0) {
                metrics.winRate = (metrics.wins / totalTrades) * 100;
            }

            // Calcular ROI (necesitamos capital inicial de la cuenta)
            // Por ahora lo dejamos en 0, se puede calcular despu√©s con datos de cuenta

            return metrics;
        }

        function updateMetricsUI(metrics) {
            // P&L Bruto Total
            const cumulativePLEl = document.getElementById('ops-cumulative-pl');
            if (cumulativePLEl) {
                cumulativePLEl.textContent = formatCurrency(metrics.cumulativePL);
                cumulativePLEl.className = metrics.cumulativePL >= 0 ?
                    'text-3xl font-bold text-success' :
                    'text-3xl font-bold text-danger';
            }

            // Total Fees
            const totalFeesEl = document.getElementById('ops-total-fees');
            if (totalFeesEl) {
                totalFeesEl.textContent = formatCurrency(metrics.totalFees);
            }

            // P&L Neto (despu√©s de comisiones)
            const netPLEl = document.getElementById('ops-net-pl');
            if (netPLEl) {
                netPLEl.textContent = formatCurrency(metrics.cumulativePLNet);
                netPLEl.className = metrics.cumulativePLNet >= 0 ?
                    'font-semibold text-success' :
                    'font-semibold text-danger';
            }

            // Profit Factor
            const pfEl = document.getElementById('ops-profit-factor');
            if (pfEl) {
                pfEl.textContent = metrics.profitFactor.toFixed(2);
                // Color seg√∫n valor: <1 rojo, 1-2 amarillo, >2 verde
                let pfClass = 'text-3xl font-bold ';
                if (metrics.profitFactor < 1) pfClass += 'text-danger';
                else if (metrics.profitFactor < 2) pfClass += 'text-warning';
                else pfClass += 'text-success';
                pfEl.className = pfClass;
            }

            // Profit Factor Gauge
            const pfGaugeEl = document.getElementById('ops-pf-gauge');
            if (pfGaugeEl) {
                // Escala: 0 = 0%, 1 = 33%, 2 = 66%, 3+ = 100%
                let percentage = 0;
                if (metrics.profitFactor >= 3) percentage = 100;
                else if (metrics.profitFactor >= 2) percentage = 66 + (metrics.profitFactor - 2) * 34;
                else if (metrics.profitFactor >= 1) percentage = 33 + (metrics.profitFactor - 1) * 33;
                else percentage = metrics.profitFactor * 33;

                pfGaugeEl.style.width = Math.min(percentage, 100) + '%';
            }

            // Gross Win
            const grossWinEl = document.getElementById('ops-gross-win');
            if (grossWinEl) {
                grossWinEl.textContent = formatCurrency(metrics.grossWin);
            }

            // Win Rate
            const winRateEl = document.getElementById('ops-win-rate');
            if (winRateEl) {
                winRateEl.textContent = metrics.winRate.toFixed(1) + '%';
            }

            // Win Circle (donut chart)
            const winCircleEl = document.getElementById('ops-win-circle');
            if (winCircleEl) {
                const dashArray = `${metrics.winRate}, 100`;
                winCircleEl.setAttribute('stroke-dasharray', dashArray);

                // Color seg√∫n win rate: <40% rojo, 40-60% amarillo, >60% verde
                let strokeColor = '#ef4444'; // rojo
                if (metrics.winRate >= 60) strokeColor = '#22c55e'; // verde
                else if (metrics.winRate >= 40) strokeColor = '#eab308'; // amarillo

                winCircleEl.setAttribute('stroke', strokeColor);
            }

            // Win text en el centro del donut
            const winTextEl = document.getElementById('ops-win-text');
            if (winTextEl) {
                winTextEl.textContent = metrics.winRate.toFixed(0) + '%';
            }

            // Total Wins y Losses
            const totalWinsEl = document.getElementById('ops-total-wins');
            if (totalWinsEl) totalWinsEl.textContent = metrics.wins;

            const totalLossesEl = document.getElementById('ops-total-losses');
            if (totalLossesEl) totalLossesEl.textContent = metrics.losses;
        }

        let operationsMetricsChart = null;

        function updateCumulativePLChart(operations) {
            const chartCanvas = document.getElementById('ops-cumulative-chart');
            if (!chartCanvas) {
                console.log('Canvas ops-cumulative-chart no encontrado');
                return;
            }

            // Verificar si Chart.js est√° disponible
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° cargado');
                return;
            }

            // Ordenar operaciones por fecha
            const sortedOps = [...operations].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            // Calcular P&L acumulado
            let cumulative = 0;
            const chartData = sortedOps.map(op => {
                cumulative += op.manualPL || op.pl || 0;
                return {
                    date: op.date,
                    cumulative: cumulative
                };
            });

            // Si no hay datos, mostrar gr√°fico vac√≠o
            if (chartData.length === 0) {
                chartData.push({ date: new Date().toISOString().split('T')[0], cumulative: 0 });
            }

            // Destruir gr√°fico anterior si existe
            if (operationsMetricsChart) {
                operationsMetricsChart.destroy();
            }

            // Crear nuevo gr√°fico
            const ctx = chartCanvas.getContext('2d');
            operationsMetricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: 'P&L Acumulado',
                        data: chartData.map(d => d.cumulative),
                        borderColor: cumulative >= 0 ? '#10b981' : '#ef4444',
                        backgroundColor: cumulative >= 0 ?
                            'rgba(16, 185, 129, 0.1)' :
                            'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function refreshAllViews() {
            const activeTabElement = document.querySelector('.nav-tab.active');
            if (!activeTabElement) return;
            const activeTabId = activeTabElement.dataset.target;

            // Actualizar TODOS los selectores de cuentas primero
            const allSelectors = [
                'dashboard-account-select',
                'analytics-account-select',
                'equity-account-select',
                'daily-journal-account-select',
                'calendar-account-select',
                'informe-account-select',
                'op-account',
                'filter-account',
                'chartbook-account-select',
                'bingx-account',
                'bitget-account-detail',
                'mexc-account-detail'
            ];
            
            allSelectors.forEach(selectorId => {
                updateAccountSelect(selectorId);
            });

            // Asegurarse de que la secci√≥n de detalles de operaci√≥n se oculte si se cambia de pesta√±a
            if (activeTabId !== 'operation-detail-page') {
                document.getElementById('operation-detail-page').classList.remove('active');
            }

            if (activeTabId === 'dashboard') refreshDashboard();
            else if (activeTabId === 'analytics') refreshAnalytics();
            else if (activeTabId === 'equity-graph') {
                if (typeof refreshEquityGraph === 'function') refreshEquityGraph();
            }
            else if (activeTabId === 'finances') refreshFinancesView();
            else if (activeTabId === 'informe') {
                // Siempre activar y refrescar la subsecci√≥n de Informes al hacer clic en la secci√≥n principal
                const informesTab = document.querySelector('.informe-sub-tab[data-target="informe-informes-content"]');
                const informesContent = document.getElementById('informe-informes-content');
                
                if (informesTab && informesContent) {
                    // Desactivar todas las subsecciones
                    document.querySelectorAll('.informe-sub-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.informe-sub-section-container').forEach(content => content.classList.remove('active'));
                    
                    // Activar subsecci√≥n de Informes
                    informesTab.classList.add('active');
                    informesContent.classList.add('active');
                    
                    // Refrescar los datos
                    setTimeout(() => {
                        if (typeof refreshInforme === 'function') {
                            refreshInforme();
                        }
                    }, 50);
                }
            }
            else if (activeTabId === 'calendar') {
                // Ensure calendar is fully rendered when tab is switched to
                setTimeout(() => updateCalendar(), 50);
            }
            else if (activeTabId === 'operations') refreshOperationsTable();
            else if (activeTabId === 'accounts') refreshAccountsView();
            else if (activeTabId === 'playbook') {
                if (typeof refreshPlaybook === 'function') refreshPlaybook();
            }
            // operation-detail-page no se refresca autom√°ticamente desde aqu√≠, solo cuando se invoca directamente

            if (document.getElementById('selected-account-details')?.style.display === 'block' && document.getElementById('selected-account-details').dataset.accountId) {
                showAccountDetails(document.getElementById('selected-account-details').dataset.accountId);
            }
        }

        function refreshActiveInformeSubTab() {
            const activeSubTab = document.querySelector('#informe .informe-sub-tab.active');
            if (!activeSubTab) return;

            const targetId = activeSubTab.dataset.target;
            console.log(`[Informe] Refreshing active sub-tab: ${targetId}`);

            switch (targetId) {
                case 'informe-informes-content':
                    refreshInforme();
                    break;
                case 'informe-metricas-content':
                    refreshMetricas();
                    break;
                case 'informe-metricas-avanzadas-content':
                    refreshMetricasAvanzadas();
                    break;
                case 'informe-simbolos-content':
                    refreshSimbolos();
                    break;
                case 'informe-tiempo-content':
                    refreshTiempo();
                    break;
                case 'informe-graficos-content':
                    if (typeof window.refreshGraficosCharts === 'function') {
                        window.refreshGraficosCharts();
                    }
                    break;
                case 'informe-comisiones-content':
                    if (typeof window.refreshComisiones === 'function') {
                        window.refreshComisiones();
                    }
                    break;
            }
        }

        async function handleOperationsTableClick(event) {
            const target = event.target;
            const buttonElement = target.closest('button');
            if (!buttonElement) {
                return;
            }
            const operationId = buttonElement.dataset.id;
            if (!operationId) return;

            if (buttonElement.classList.contains('delete-op-btn')) {
                if (confirm('¬øEst√°s seguro de que deseas eliminar esta operaci√≥n?')) {
                    showLoading(true);
                    try {
                        await dexieDB.operations.delete(operationId);
                        // Eliminar de Supabase
                        await deleteOperationFromSupabase(operationId);
                        DB.operations = DB.operations.filter(op => op.id !== operationId);
                        updateAccountBalances();
                        refreshAllViews();
                    } catch (e) {
                        console.error("Error deleting operation:", e); alert("Error al eliminar la operaci√≥n.");
                    } finally { showLoading(false); }
                }
            } else if (buttonElement.classList.contains('edit-op-btn')) {
                const operationToEdit = DB.operations.find(op => op.id === operationId);
                if (operationToEdit) toggleAddOperationForm(operationToEdit);
            } else if (buttonElement.classList.contains('chart-op-btn')) {
                const operationToChart = DB.operations.find(op => op.id === operationId);
                if (operationToChart) {
                    showOperationDetailPage(operationToChart.id);
                    setTimeout(() => {
                        if (window.showTradingChart) {
                            window.showTradingChart(operationToChart);
                        }
                    }, 500);
                }
            }
        }

        async function refreshOperationsTable() {
            const operationsSection = document.getElementById('operations');
            if (!operationsSection || !operationsSection.classList.contains('active')) {
                return;
            }

            const tableBody = document.getElementById('operations-table');
            const tableHeaders = document.querySelectorAll('#operations-table-render th[data-sort]');
            if (!tableBody) {
                console.error("Operations table body not found during refresh.");
                return;
            }

            const accountFilter = document.getElementById('filter-account').value;
            const instrumentFilter = document.getElementById('filter-instrument').value.toLowerCase().trim();

            tableBody.innerHTML = '';

            // Definir filteredOperations correctamente
            let filteredOperations = applyDateFilterToData(DB.operations);
            filteredOperations = filteredOperations.filter(op =>
                (accountFilter === 'all' || op.accountId === accountFilter) &&
                (!instrumentFilter || op.instrument.toLowerCase().includes(instrumentFilter))
            );

            // Agrupar operaciones por ID en lugar de parentId
            const groupedOps = {};
            filteredOperations.forEach(op => {
                const opId = op.id;
                if (!groupedOps[opId]) {
                    groupedOps[opId] = {
                        mainOp: op,
                        partials: [],
                        totalPL: 0
                    };
                }
                
                // Si es la primera operaci√≥n de este ID, la tomamos como principal
                // Las siguientes se agregan como parciales
                if (groupedOps[opId].partials.length === 0 && groupedOps[opId].mainOp === op) {
                    // Es la operaci√≥n principal
                } else {
                    groupedOps[opId].partials.push(op);
                }
                groupedOps[opId].totalPL += op.pl;
            });

            const mainOps = Object.values(groupedOps).map(group => group.mainOp);

            // Ordenar principales
            const sortColumn = operationSortState.column;
            const sortOrder = operationSortState.order;
            mainOps.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (sortColumn === 'accountId') {
                    valA = DB.accounts.find(acc => acc.id === valA)?.name || '';
                    valB = DB.accounts.find(acc => acc.id === valB)?.name || '';
                }
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            tableHeaders.forEach(th => {
                th.classList.remove('sorted', 'asc', 'desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add('sorted', sortOrder);
                }
            });

            mainOps.forEach(op => {
                const account = DB.accounts.find(acc => acc.id === op.accountId);
                const accountName = account ? account.name : 'Desconocida';
                
                // Obtener el nombre del setup si existe
                const setupId = op.setupId || op.setupUsed;
                const setup = setupId ? DB.setups.find(s => s.id === setupId) : null;
                const setupName = setup ? setup.name : '-';
                
                // Obtener el grupo de operaciones para este ID
                const group = groupedOps[op.id];
                const parciales = group.partials;
                const totalPL = group.totalPL;
                
                // Determinar resultado y clase basado en P&L total del grupo
                let resultText, resultClass, plClass;
                if (totalPL > 0) { 
                    resultText = 'Ganancia'; 
                    resultClass = 'text-positive'; 
                    plClass = 'text-positive';
                } else if (totalPL < 0) { 
                    resultText = 'P√©rdida'; 
                    resultClass = 'text-negative'; 
                    plClass = 'text-negative';
                } else { 
                    resultText = 'Neutral'; 
                    resultClass = 'text-neutral'; 
                    plClass = 'text-neutral';
                }

                const precision = getInstrumentPrecision(op.instrument);
                const entryDisplay = op.entry !== null ? op.entry.toFixed(precision) : '-';
                
                // Determinar precio y hora de salida
                let exitTime = op.exitTime || '';
                let exitPrice = op.exit; // Usar el exit de la operaci√≥n (ya calculado correctamente en el import)
                
                // Si la operaci√≥n tiene parciales guardados (PrimeXBT Interface), usar el exit ya calculado
                // Si tiene parciales del sistema antiguo (groupedOps), buscar el √∫ltimo
                if (!op.hasPartials && parciales.length > 0) {
                    let ultimo = parciales[0];
                    parciales.forEach(p => {
                        const d1 = new Date((ultimo.date || '') + 'T' + (ultimo.exitTime || '23:59:59'));
                        const d2 = new Date((p.date || '') + 'T' + (p.exitTime || '23:59:59'));
                        if (d2 > d1) ultimo = p;
                    });
                    exitTime = ultimo.exitTime || '';
                    exitPrice = ultimo.exit;
                }
                
                const exitDisplay = exitPrice !== null ? exitPrice.toFixed(precision) : '-';

                const row = tableBody.insertRow();
                row.dataset.id = op.id;
                row.classList.add('cursor-pointer', 'main-operation-row');
                row.innerHTML = `
                    <td title="${formatDate(op.date)}">${formatDate(op.date)}</td>
                    <td>${op.entryTime || '-'}</td>
                    <td>${exitTime || '-'}</td>
                    <td title="${accountName}">${accountName}</td>
                    <td title="${op.instrument}">${op.instrument}</td>
                    <td>${op.type === 'buy' ? 'Compra' : 'Venta'}</td>
                    <td>${entryDisplay}</td>
                    <td>${exitDisplay}</td>
                    <td>${op.volume}</td>
                    <td class="${resultClass}">${resultText}</td>
                    <td class="${plClass} hide-amount">${formatCurrency(totalPL, op.currency, op.currency)}</td>
                    <td class="hide-amount">${op.fees ? formatCurrency(op.fees, op.currency, op.currency) : '-'}</td>
                    <td>${op.currency}</td>
                    <td title="${op.session || 'No especificado'}">${op.session || '-'}</td>
                    <td class="text-center space-x-1">
                        <button class="text-blue-400 chart-op-btn" data-id="${op.id}" title="Ver Gr√°fico"><i class="fas fa-chart-line"></i></button>
                        <button class="text-white edit-op-btn" data-id="${op.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 delete-op-btn" data-id="${op.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </td>`;

                // Sub-filas para parciales
                parciales.sort((a, b) => {
                    const d1 = new Date((a.date || '') + 'T' + (a.exitTime || '23:59:59'));
                    const d2 = new Date((b.date || '') + 'T' + (b.exitTime || '23:59:59'));
                    return d1 - d2;
                });
                parciales.forEach(parcial => {
                    const pAccount = DB.accounts.find(acc => acc.id === parcial.accountId);
                    const pAccountName = pAccount ? pAccount.name : 'Desconocida';
                    const pPlClass = parcial.pl > 0 ? 'text-positive' : parcial.pl < 0 ? 'text-negative' : 'text-neutral';
                    let pResultText, pResultClass;
                    if (parcial.result === 'win') { pResultText = 'Ganancia'; pResultClass = 'text-positive'; }
                    else if (parcial.result === 'loss') { pResultText = 'P√©rdida'; pResultClass = 'text-negative'; }
                    else { pResultText = 'Neutral'; pResultClass = 'text-neutral'; }
                    const pPrecision = getInstrumentPrecision(parcial.instrument);
                    const pEntryDisplay = parcial.entry !== null ? parcial.entry.toFixed(pPrecision) : '-';
                    const pExitDisplay = parcial.exit !== null ? parcial.exit.toFixed(pPrecision) : '-';
                    const pRow = tableBody.insertRow();
                    pRow.classList.add('parcial-row');
                    pRow.innerHTML = `
                        <td style="padding-left:2em;">${formatDate(parcial.date)}</td>
                        <td>${parcial.entryTime || '-'}</td>
                        <td>${parcial.exitTime || '-'}</td>
                        <td title="${pAccountName}">${pAccountName}</td>
                        <td title="${parcial.instrument}">${parcial.instrument}</td>
                        <td>${parcial.type === 'buy' ? 'Compra' : 'Venta'}</td>
                        <td>${pEntryDisplay}</td>
                        <td>${pExitDisplay}</td>
                        <td>${parcial.volume}</td>
                        <td class="${pResultClass}">${pResultText}</td>
                        <td class="${pPlClass} hide-amount">${formatCurrency(parcial.pl, parcial.currency, parcial.currency)}</td>
                        <td class="hide-amount">${parcial.fees ? formatCurrency(parcial.fees, parcial.currency, parcial.currency) : '-'}</td>
                        <td>${parcial.currency}</td>
                        <td title="${parcial.session || 'No especificado'}">${parcial.session || '-'}</td>
                        <td class="text-center space-x-1">
                            <button class="text-blue-400 chart-op-btn" data-id="${parcial.id}" title="Ver Gr√°fico"><i class="fas fa-chart-line"></i></button>
                            <button class="text-white edit-op-btn" data-id="${parcial.id}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="text-red delete-op-btn" data-id="${parcial.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>`;
                });
            });


            // A√±ade un nuevo event listener para las filas principales y parciales despu√©s de que se renderizan
            tableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', (event) => {
                    if (event.target.closest('.edit-op-btn') || event.target.closest('.delete-op-btn') || event.target.closest('.chart-op-btn')) {
                        return;
                    }
                    const operationId = row.dataset.id;
                    if (operationId) {
                        showOperationDetailPage(operationId);
                    }
                });
            });

            // Actualizar m√©tricas de operaciones
            updateOperationsMetrics();
        }


        function getInstrumentPrecision(instrument) {
            if (!instrument) return 5;
            const instUpper = instrument.toUpperCase();
            // BTC con m√°s decimales para mostrar precios completos (ej: 102.092,2)
            if (instUpper.includes('BTC')) return 4;
            if (instUpper.includes('ETH') || instUpper.includes('XAU') || instUpper.includes('XAG') || instUpper.endsWith('USDT')) return 2;
            if (instUpper.includes('JPY')) return 3;
            if (instUpper.includes('DE40') || instUpper.includes('US30') || instUpper.includes('SPX500') || instUpper.includes('NAS100')) return 1;
            return 5;
        }

        function openImageModal(imageList, startIndex = 0) {
            console.log('üñºÔ∏è openImageModal llamada con:', { imageList: imageList.length, startIndex });
            
            if (!imageList || imageList.length === 0) {
                console.error('‚ùå No hay im√°genes para mostrar');
                return;
            }

            modalImageList = imageList;
            modalImageIndex = startIndex;

            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image-content');
            const counter = document.getElementById('image-modal-counter');

            if (!modal || !modalImg) {
                console.error('‚ùå Elementos del modal no encontrados');
                return;
            }

            modalImg.src = modalImageList[modalImageIndex];
            modalImg.classList.remove('fullscreen');
            modal.style.display = "flex";
            
            // Actualizar contador
            if (counter) {
                counter.textContent = `${modalImageIndex + 1} / ${modalImageList.length}`;
            }
            
            console.log('‚úÖ Modal abierto con imagen:', modalImg.src.substring(0, 50) + '...');

            updateModalNavigation();
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image-content');
            if (modal) {
                modal.style.display = "none";
                if (modalImg) {
                    modalImg.src = "";
                    modalImg.classList.remove('fullscreen');
                }
                modalImageList = [];
                modalImageIndex = 0;
            }
        }

        function updateModalNavigation() {
            const prevBtn = document.getElementById('image-modal-prev');
            const nextBtn = document.getElementById('image-modal-next');
            const counter = document.getElementById('image-modal-counter');

            if (prevBtn) prevBtn.style.display = (modalImageIndex > 0) ? 'block' : 'none';
            if (nextBtn) nextBtn.style.display = (modalImageIndex < modalImageList.length - 1) ? 'block' : 'none';
            
            // Actualizar contador
            if (counter) {
                counter.textContent = `${modalImageIndex + 1} / ${modalImageList.length}`;
            }
        }
        
        function toggleImageFullscreen() {
            const modalImg = document.getElementById('modal-image-content');
            const fullscreenBtn = document.getElementById('image-modal-fullscreen-btn');
            
            if (modalImg && fullscreenBtn) {
                modalImg.classList.toggle('fullscreen');
                
                // Cambiar icono
                const icon = fullscreenBtn.querySelector('i');
                if (icon) {
                    if (modalImg.classList.contains('fullscreen')) {
                        icon.className = 'fas fa-compress';
                        fullscreenBtn.title = 'Salir de pantalla completa';
                    } else {
                        icon.className = 'fas fa-expand';
                        fullscreenBtn.title = 'Pantalla completa';
                    }
                }
            }
        }

        function initImageModal() {
            document.getElementById('image-modal-close-btn').addEventListener('click', closeImageModal);

            document.getElementById('image-modal-prev').addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalImageIndex > 0) {
                    modalImageIndex--;
                    document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                    updateModalNavigation();
                }
            });

            document.getElementById('image-modal-next').addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalImageIndex < modalImageList.length - 1) {
                    modalImageIndex++;
                    document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                    updateModalNavigation();
                }
            });
            
            // Bot√≥n de pantalla completa
            document.getElementById('image-modal-fullscreen-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleImageFullscreen();
            });
            
            // Click en la imagen para pantalla completa
            document.getElementById('modal-image-content').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleImageFullscreen();
            });
            
            // Navegaci√≥n con teclado
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('image-modal');
                if (modal && modal.style.display === 'flex') {
                    if (e.key === 'ArrowLeft' && modalImageIndex > 0) {
                        modalImageIndex--;
                        document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                        updateModalNavigation();
                    } else if (e.key === 'ArrowRight' && modalImageIndex < modalImageList.length - 1) {
                        modalImageIndex++;
                        document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                        updateModalNavigation();
                    } else if (e.key === 'Escape') {
                        closeImageModal();
                    } else if (e.key === 'f' || e.key === 'F') {
                        toggleImageFullscreen();
                    }
                }
            });
        }

        function initAccounts() {
            const toggleButton = document.getElementById('toggle-hide-amounts');
            const toggleIcon = document.getElementById('toggle-hide-amounts-icon');
            const accountsSection = document.getElementById('accounts');

            const applyStreamerMode = (active) => {
                if (active) {
                    if (accountsSection) accountsSection.classList.add('streamer-mode-active');
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                    toggleButton.setAttribute('aria-pressed', 'true');
                    toggleButton.title = "Mostrar importes";
                } else {
                    if (accountsSection) accountsSection.classList.remove('streamer-mode-active');
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                    toggleButton.setAttribute('aria-pressed', 'false');
                    toggleButton.title = "Ocultar importes (stream)";
                }
            };

            // Check localStorage on load
            let isStreamerModeActive = localStorage.getItem('streamerModeActive') === 'true';
            applyStreamerMode(isStreamerModeActive);

            toggleButton.addEventListener('click', () => {
                isStreamerModeActive = !isStreamerModeActive;
                localStorage.setItem('streamerModeActive', isStreamerModeActive);
                applyStreamerMode(isStreamerModeActive);
                // Refresh accounts to apply per-account visibility
                refreshAccountsView();
            });

            const addAccountBtn = document.getElementById('add-account-btn');
            if (addAccountBtn) {
                addAccountBtn.addEventListener('click', () => showBrokerSelectionModal());
            }

            const saveAccountBtn = document.getElementById('acc-save');
            if (saveAccountBtn) {
                saveAccountBtn.addEventListener('click', saveAccount);
            }

            const cancelAccountBtn = document.getElementById('acc-cancel');
            if (cancelAccountBtn) {
                cancelAccountBtn.addEventListener('click', () => toggleAddAccountForm());
            }

            // Nuevos event listeners para modales
            const closeBrokerScreen = document.getElementById('close-broker-screen');
            if (closeBrokerScreen) {
                closeBrokerScreen.addEventListener('click', () => {
                    document.getElementById('broker-selection-screen').style.display = 'none';
                    document.getElementById('accounts-main-container').style.display = 'block';
                });
            }

            const closeBrokerModal = document.getElementById('close-broker-modal');
            if (closeBrokerModal) {
                closeBrokerModal.addEventListener('click', () => {
                    document.getElementById('broker-selection-modal').style.display = 'none';
                });
            }

            const closeAccountModal = document.getElementById('close-account-modal');
            if (closeAccountModal) {
                closeAccountModal.addEventListener('click', () => {
                    document.getElementById('account-config-modal').style.display = 'none';
                });
            }

            const cancelAccountModal = document.getElementById('cancel-account-modal');
            if (cancelAccountModal) {
                cancelAccountModal.addEventListener('click', () => {
                    document.getElementById('account-config-modal').style.display = 'none';
                });
            }

            const saveAccountModal = document.getElementById('save-account-modal');
            if (saveAccountModal) {
                saveAccountModal.addEventListener('click', saveAccountFromModal);
            }

            // Buscador de brokers
            const brokerSearch = document.getElementById('broker-search');
            if (brokerSearch) {
                brokerSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const brokerCards = document.querySelectorAll('.broker-card');
                    const brokerListItems = document.querySelectorAll('.broker-list-item');
                    
                    brokerCards.forEach(card => {
                        const brokerName = card.dataset.brokerName.toLowerCase();
                        card.style.display = brokerName.includes(searchTerm) ? 'block' : 'none';
                    });
                    
                    brokerListItems.forEach(item => {
                        const brokerName = item.dataset.brokerName.toLowerCase();
                        item.style.display = brokerName.includes(searchTerm) ? 'flex' : 'none';
                    });
                });
            }
        }

        // Mostrar modal de selecci√≥n de broker
        function showBrokerSelectionModal() {
            // Ocultar el contenedor de cuentas y mostrar la pantalla de selecci√≥n
            document.getElementById('accounts-main-container').style.display = 'none';
            document.getElementById('broker-selection-screen').style.display = 'block';
            
            const grid = document.getElementById('broker-grid');
            const allBrokersList = document.getElementById('all-brokers-list');
            
            const favoriteBrokers = [
                { id: 'bitget', name: 'Bitget', logo: '/logos/bitget-logo.png', color: '#00F0FF' },
                { id: 'bingx', name: 'BingX', logo: '/logos/bingx-logo.png', color: '#1E90FF' },
                { id: 'ninjatrader', name: 'NinjaTrader 8', logo: '/logos/ninja-logo.png', color: '#FF6600' },
                { id: 'tradovate', name: 'Tradovate', logo: '/logos/tradovate-logo.png', color: '#0066CC' },
                { id: 'meta-trader-4', name: 'MetaTrader 4', logo: '/logos/metatrader 4-logo.png', color: '#1B5E20' },
                { id: 'meta-trader-5', name: 'MetaTrader 5', logo: '/logos/metatrader5-logo.png', color: '#1B5E20' },
                { id: 'primexbt-crypto', name: 'PrimeXBT Crypto', logo: '/logos/primexbt-logo.png', color: '#0066FF' }
            ];

            const otherBrokers = [
                { id: 'bingx', name: 'BingX', logo: '/logos/bingx-logo.png', color: '#1E40AF' },
                { id: 'ninjatrader', name: 'NinjaTrader 8', logo: '/logos/ninja-logo.png', color: '#FF6600' },
                { id: 'tradovate', name: 'Tradovate', logo: '/logos/tradovate-logo.png', color: '#0066CC' },
                { id: 'bitget', name: 'Bitget', logo: '/logos/bitget-logo.png', color: '#54FDD5' },
                { id: 'binance', name: 'Binance', logo: '/logos/binance-logo.png', color: '#F3BA2F' },
                { id: 'mexc', name: 'MEXC', logo: '/logos/mexc-logo.png', color: '#00D4AA' },
                { id: 'bitunix', name: 'Bitunix', logo: '/logos/bitunix-logo.png', color: '#FF6B00' },
                { id: 'primexbt-crypto', name: 'PrimeXBT Crypto', logo: '/logos/primexbt-logo.png', color: '#FF6B35' },
                { id: 'primexbt-cfds', name: 'PrimeXBT CFDs', logo: '/logos/primexbt-logo.png', color: '#0066FF' },
                { id: 'meta-trader-4', name: 'MetaTrader 4', logo: '/logos/metatrader 4-logo.png', color: '#1B5E20' },
                { id: 'meta-trader-5', name: 'MetaTrader 5', logo: '/logos/metatrader5-logo.png', color: '#1B5E20' },
                { id: 'ctrader', name: 'cTrader', logo: '/logos/ctrader-logo.png', color: '#00A8E1' },
                { id: 'tradingview', name: 'TradingView', logo: '/logos/tradingview-logo.png', color: '#2962FF' }
            ];

            // Renderizar favoritos
            grid.innerHTML = favoriteBrokers.map(broker => `
                <div class="broker-card cursor-pointer" data-broker-id="${broker.id}" data-broker-name="${broker.name}">
                    <div class="bg-surface hover:bg-surface-light rounded-lg p-6 text-center transition-all border border-border hover:border-primary">
                        <div class="w-16 h-16 rounded-xl mx-auto mb-3 overflow-hidden" style="background-color: ${broker.color};">
                            ${broker.logo ? `<img src="${broker.logo}" alt="${broker.name}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-white font-bold text-xl">${broker.initials || broker.name.substring(0, 2)}</div>`}
                        </div>
                        <p class="text-sm font-medium text-white">${broker.name}</p>
                    </div>
                </div>
            `).join('');
            
            // Agregar event listeners a las tarjetas
            document.querySelectorAll('.broker-card').forEach(card => {
                card.addEventListener('click', function() {
                    const brokerId = this.dataset.brokerId;
                    const brokerName = this.dataset.brokerName;
                    const broker = favoriteBrokers.find(b => b.id === brokerId);
                    if (broker) {
                        selectBroker(broker.id, broker.name, broker.logo, broker.color, broker.initials || '');
                    }
                });
            });

            // Renderizar otros brokers en lista
            allBrokersList.innerHTML = otherBrokers.map(broker => `
                <div class="broker-list-item cursor-pointer hover:bg-surface-light px-4 py-3 flex items-center border-b border-border last:border-b-0 transition-colors" data-broker-id="${broker.id}" data-broker-name="${broker.name}">
                    <div class="w-10 h-10 rounded-lg overflow-hidden mr-3" style="background-color: ${broker.color};">
                        ${broker.logo ? `<img src="${broker.logo}" alt="${broker.name}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-white font-bold text-xs">${broker.initials || broker.name.substring(0, 2)}</div>`}
                    </div>
                    <span class="text-sm font-medium text-white">${broker.name}</span>
                </div>
            `).join('');
            
            // Agregar event listeners a los items de la lista
            document.querySelectorAll('.broker-list-item').forEach(item => {
                item.addEventListener('click', function() {
                    const brokerId = this.dataset.brokerId;
                    const brokerName = this.dataset.brokerName;
                    const broker = otherBrokers.find(b => b.id === brokerId);
                    if (broker) {
                        selectBroker(broker.id, broker.name, broker.logo, broker.color, broker.initials || '');
                    }
                });
            });
            
            // Configurar toggle de Show all brokers
            const showAllBtn = document.getElementById('show-all-brokers-btn');
            if (showAllBtn) {
                // Remover listeners anteriores
                const newBtn = showAllBtn.cloneNode(true);
                showAllBtn.parentNode.replaceChild(newBtn, showAllBtn);
                
                newBtn.addEventListener('click', function() {
                    const list = document.getElementById('all-brokers-list');
                    const icon = this.querySelector('i');
                    if (list.style.display === 'none' || !list.style.display) {
                        list.style.display = 'block';
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        list.style.display = 'none';
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                });
            }
        }

        // Seleccionar broker y abrir modal de configuraci√≥n
        function selectBroker(brokerId, brokerName, brokerLogo, brokerColor, brokerInitials) {
            // Cerrar pantalla de selecci√≥n
            document.getElementById('broker-selection-screen').style.display = 'none';
            document.getElementById('accounts-main-container').style.display = 'block';
            
            const modal = document.getElementById('account-config-modal');
            const logoContainer = document.getElementById('selected-broker-logo');
            
            // Actualizar logo y nombre sin padding
            logoContainer.style.backgroundColor = brokerColor;
            if (brokerLogo) {
                logoContainer.innerHTML = `<img src="${brokerLogo}" alt="${brokerName}" class="w-full h-full object-cover">`;
            } else {
                logoContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-white font-bold text-xl">${brokerInitials || brokerName.substring(0, 2)}</div>`;
            }
            
            document.getElementById('selected-broker-name').textContent = brokerName;
            
            // Guardar broker seleccionado
            modal.dataset.selectedBroker = brokerId;
            
            // Mostrar campos de Tradovate si aplica
            const tradovateFields = document.getElementById('tradovate-fields-modal');
            tradovateFields.style.display = brokerId === 'tradovate' ? 'block' : 'none';
            
            // Limpiar formulario
            document.getElementById('acc-name-modal').value = '';
            document.getElementById('acc-balance-modal').value = '';
            document.getElementById('acc-currency-modal').value = 'USD';
            
            modal.style.display = 'flex';
        }

        // Guardar cuenta desde modal
        async function saveAccountFromModal() {
            try {
                showLoading(true);
                const modal = document.getElementById('account-config-modal');
                const brokerId = modal.dataset.selectedBroker;
                const name = document.getElementById('acc-name-modal').value.trim();
                const initialBalance = parseFloat(document.getElementById('acc-balance-modal').value);
                const currency = document.getElementById('acc-currency-modal').value;
                
                console.log('Guardando cuenta:', { brokerId, name, initialBalance, currency });
                
                // Capturar credenciales de Tradovate si aplica
                let tradovateCredentials = {};
                if (brokerId === 'tradovate') {
                    tradovateCredentials = {
                        tradovateUsername: document.getElementById('tradovate-username-modal').value.trim(),
                        tradovatePassword: document.getElementById('tradovate-password-modal').value.trim(),
                        tradovateAccountId: document.getElementById('tradovate-account-id-modal').value.trim(),
                        tradovateAutoSync: document.getElementById('tradovate-auto-sync-modal').checked
                    };
                    
                    if (!tradovateCredentials.tradovateUsername || !tradovateCredentials.tradovatePassword || !tradovateCredentials.tradovateAccountId) {
                        showError('Por favor completa todos los campos de Tradovate');
                        showLoading(false);
                        return;
                    }
                }
                
                if (!name || isNaN(initialBalance) || initialBalance <= 0) {
                    showError('Por favor completa todos los campos correctamente');
                    showLoading(false);
                    return;
                }
                
                // Obtener user_id
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError || !userData.user) {
                    showError('Error de autenticaci√≥n');
                    showLoading(false);
                    return;
                }
                
                const accountData = {
                    name,
                    initialBalance,
                    currency,
                    platform: brokerId,
                    user_id: userData.user.id,
                    ...tradovateCredentials
                };
                
                console.log('Datos de cuenta a insertar:', accountData);
                
                const { data, error } = await supabase.from('accounts').insert([accountData]).select().single();
                if (error) {
                    console.error('Error de Supabase:', error);
                    throw error;
                }
                
                console.log('Cuenta creada:', data);
                
                // Agregar la nueva cuenta a DB.accounts y Dexie
                const newAccount = {
                    id: data.id,
                    name: data.name,
                    currency: data.currency,
                    platform: data.platform,
                    initialBalance: data.initial_balance || data.initialBalance,
                    balance: data.balance || data.initial_balance || data.initialBalance
                };
                
                DB.accounts.push(newAccount);
                
                // Guardar en Dexie
                await dexieDB.accounts.put(newAccount);
                
                console.log('‚úÖ DB.accounts actualizado:', DB.accounts.length, 'cuentas');
                
                // Refrescar selector de cuentas en el header
                refreshAccountSelector();
                
                showSuccess('Cuenta creada exitosamente');
                modal.style.display = 'none';
                
                // Refrescar la secci√≥n de cuentas si est√° visible
                const accountsSection = document.getElementById('accounts');
                if (accountsSection && accountsSection.classList.contains('active')) {
                    showSection('accounts');
                }
            } catch (error) {
                console.error('Error al guardar cuenta:', error);
                showError('Error al crear la cuenta: ' + (error.message || JSON.stringify(error)));
            } finally {
                showLoading(false);
            }
        }

        function toggleAddAccountForm(accountToEdit = null) {
            const form = document.getElementById('add-account-form'); const isVisible = form.style.display === 'block';
            if (!isVisible) {
                form.style.display = 'block'; document.getElementById('add-account-btn').textContent = 'Ocultar Formulario';
                if (accountToEdit) { 
                    form.querySelector('h3').textContent = 'Editar Cuenta'; 
                    document.getElementById('acc-name').value = accountToEdit.name; 
                    document.getElementById('acc-balance').value = accountToEdit.initialBalance; 
                    document.getElementById('acc-currency').value = accountToEdit.currency; 
                    document.getElementById('acc-platform').value = accountToEdit.platform; 
                    form.dataset.editingId = accountToEdit.id;
                    
                    // Mostrar campos de Tradovate si es cuenta Tradovate
                    if (accountToEdit.platform === 'tradovate') {
                        document.getElementById('tradovate-fields').style.display = 'block';
                        if (accountToEdit.tradovateUsername) document.getElementById('tradovate-username').value = accountToEdit.tradovateUsername;
                        if (accountToEdit.tradovatePassword) document.getElementById('tradovate-password').value = accountToEdit.tradovatePassword;
                        if (accountToEdit.tradovateAccountId) document.getElementById('tradovate-account-id').value = accountToEdit.tradovateAccountId;
                        if (accountToEdit.tradovateAutoSync) document.getElementById('tradovate-auto-sync').checked = accountToEdit.tradovateAutoSync;
                    } else {
                        document.getElementById('tradovate-fields').style.display = 'none';
                    }
                }
                else { 
                    form.querySelector('h3').textContent = 'Nueva Cuenta'; 
                    document.getElementById('acc-name').value = ''; 
                    document.getElementById('acc-balance').value = ''; 
                    document.getElementById('acc-currency').value = DB.settings.defaultCurrency; 
                    document.getElementById('acc-platform').value = 'meta-trader-4';
                    document.getElementById('tradovate-fields').style.display = 'none';
                    delete form.dataset.editingId; 
                }
                form.scrollIntoView({ behavior: 'smooth' });
            } else { form.style.display = 'none'; document.getElementById('add-account-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Agregar Cuenta'; delete form.dataset.editingId; }
        }
        
        // Listener para mostrar/ocultar campos de Tradovate
        document.getElementById('acc-platform').addEventListener('change', function(e) {
            const tradovateFields = document.getElementById('tradovate-fields');
            if (e.target.value === 'tradovate') {
                tradovateFields.style.display = 'block';
            } else {
                tradovateFields.style.display = 'none';
            }
        });
        async function saveAccount() {
            showLoading(true);
            const form = document.getElementById('add-account-form');
            const editingId = form.dataset.editingId;
            const name = document.getElementById('acc-name').value.trim();
            const initialBalance = parseFloat(document.getElementById('acc-balance').value);
            const currency = document.getElementById('acc-currency').value;
            const platform = document.getElementById('acc-platform').value;
            
            // Capturar credenciales de Tradovate si aplica
            let tradovateCredentials = {};
            if (platform === 'tradovate') {
                tradovateCredentials = {
                    tradovateUsername: document.getElementById('tradovate-username').value.trim(),
                    tradovatePassword: document.getElementById('tradovate-password').value.trim(),
                    tradovateAccountId: document.getElementById('tradovate-account-id').value.trim(),
                    tradovateAutoSync: document.getElementById('tradovate-auto-sync').checked
                };
                
                if (!tradovateCredentials.tradovateUsername || !tradovateCredentials.tradovatePassword || !tradovateCredentials.tradovateAccountId) {
                    alert('Por favor completa todos los campos de Tradovate (Usuario, Contrase√±a, Account ID).');
                    showLoading(false);
                    return;
                }
            }
            
            if (!name || isNaN(initialBalance) || initialBalance < 0) { alert('Nombre y balance inicial v√°lido requerido.'); showLoading(false); return; }

            let accountData;
            try {
                if (editingId) {
                    const existingAccount = DB.accounts.find(acc => acc.id === editingId);
                    accountData = { ...existingAccount, name, initialBalance, currency, platform, ...tradovateCredentials };
                    accountData.balance = initialBalance;
                    const accountOps = DB.operations.filter(op => op.accountId === editingId);
                    accountOps.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== accountData.currency) pl = convertCurrency(pl, op.currency, accountData.currency);
                        accountData.balance += pl;
                    });
                    accountData.balance = Math.round(accountData.balance * 100) / 100;
                    await dexieDB.accounts.update(editingId, accountData);
                    const index = DB.accounts.findIndex(acc => acc.id === editingId);
                    if (index !== -1) DB.accounts[index] = accountData;

                    console.log('‚úÖ Cuenta actualizada localmente');

                    // SINCRONIZACI√ìN AUTOM√ÅTICA EN SEGUNDO PLANO (invisible para el usuario)
                    if (currentUser) {
                        saveAccountToSupabase(accountData).then(() => {
                            console.log('‚úÖ Cuenta sincronizada autom√°ticamente');
                            showSyncNotification('üíæ Cuenta actualizada exitosamente', 'success');
                        }).catch((supabaseError) => {
                            console.error('‚ùå Error de sincronizaci√≥n autom√°tica:', supabaseError);
                            addToSyncQueue(accountData, 'account');
                            showSyncNotification('üíæ Cuenta actualizada exitosamente', 'success');
                        });
                    } else {
                        showSyncNotification('üíæ Cuenta actualizada', 'success');
                    }

                } else {
                    accountData = { id: generateId(), name, initialBalance, balance: initialBalance, currency, platform, ...tradovateCredentials };
                    console.log('üè¶ Creating new account:', accountData);

                    await dexieDB.accounts.add(accountData);
                    console.log('‚úÖ Account added to local DB');

                    DB.accounts.push(accountData);
                    console.log('‚úÖ Account added to memory');

                    // SINCRONIZACI√ìN AUTOM√ÅTICA EN SEGUNDO PLANO (invisible para el usuario)
                    if (currentUser) {
                        saveAccountToSupabase(accountData).then(() => {
                            console.log('‚úÖ Cuenta sincronizada autom√°ticamente');
                            showSyncNotification('üíæ Cuenta creada exitosamente', 'success');
                        }).catch((supabaseError) => {
                            console.error('‚ùå Error de sincronizaci√≥n autom√°tica:', supabaseError);
                            addToSyncQueue(accountData, 'account');
                            showSyncNotification('üíæ Cuenta creada exitosamente', 'success');
                        });
                    } else {
                        showSyncNotification('üíæ Cuenta creada', 'success');
                    }
                }

                // Actualizar vistas inmediatamente con datos locales
                toggleAddAccountForm();
                updateAccountBalances();
                
                // Actualizar TODOS los selectores de cuentas en todas las secciones
                const allSelectors = [
                    'dashboard-account-select',
                    'analytics-account-select',
                    'equity-account-select',
                    'daily-journal-account-select',
                    'calendar-account-select',
                    'informe-account-select',
                    'op-account',
                    'filter-account',
                    'chartbook-account-select',
                    'bingx-account',
                    'bitget-account-detail',
                    'mexc-account-detail'
                ];
                
                allSelectors.forEach(selectorId => {
                    updateAccountSelect(selectorId);
                });
                
                refreshAllViews();

                // Mensaje de confirmaci√≥n inmediato
                showSyncNotification('‚úÖ Cuenta guardada exitosamente', 'success');

            } catch (e) {
                console.error("Error saving account:", e); alert("Error al guardar la cuenta.");
            } finally { showLoading(false); }
        }

        async function refreshAccountsView() {
            if (!document.getElementById('accounts').classList.contains('active')) return;
            const container = document.getElementById('accounts-container');
            if (!container) return;
            container.innerHTML = '';
            const hiddenAccounts = JSON.parse(localStorage.getItem('streamerHiddenAccounts') || '[]');
            DB.accounts.forEach(account => {
                const card = document.createElement('div'); card.classList.add('account-card'); card.dataset.id = account.id;
                const accountOps = DB.operations.filter(op => op.accountId === account.id);
                const winningOps = accountOps.filter(op => op.result === 'win').length;
                const losingOps = accountOps.filter(op => op.result === 'loss').length;
                const winRate = (winningOps + losingOps) > 0 ? (winningOps / (winningOps + losingOps)) * 100 : 0;
                const pl = account.balance - account.initialBalance;
                const plPercentage = account.initialBalance !== 0 ? (pl / account.initialBalance) * 100 : 0;
                const isHidden = hiddenAccounts.includes(account.id);

                // Obtener logo de la plataforma
                const platformLogo = getPlatformLogo(account.platform);
                const logoHTML = platformLogo.file
                    ? `<img src="${platformLogo.file}" alt="${formatPlatformName(account.platform)}" class="w-16 h-16 object-contain rounded-xl" onerror="this.parentElement.innerHTML='<div class=\\'w-16 h-16 bg-[${platformLogo.color}] rounded-xl flex items-center justify-center text-white font-bold text-lg\\'>${platformLogo.initials}</div>'">`
                    : `<div class="w-16 h-16 bg-[${platformLogo.color}] rounded-xl flex items-center justify-center text-white font-bold text-lg">${platformLogo.initials}</div>`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-16 h-16 rounded-xl flex items-center justify-center overflow-hidden" style="background-color: ${platformLogo.color};">
                                ${logoHTML}
                            </div>
                            <h4 class="text-lg font-semibold">${account.name}</h4>
                        </div>
                        <div class="flex items-center">
                            <div class="mr-2 text-xs text-text-secondary">Streamer</div>
                            <button class="button small toggle-account-stream-btn ${isHidden ? 'active' : ''}" data-id="${account.id}" title="Alternar ocultar importes" aria-pressed="${isHidden ? 'true' : 'false'}">
                                <i class="fas ${isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                            </button>
                            <span class="text-xs bg-surface-light px-2 py-1 rounded text-text-secondary ml-2">${formatPlatformName(account.platform)}</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-text-secondary">Balance</p>
                        <p class="text-2xl font-semibold ${isHidden && localStorage.getItem('streamerModeActive') === 'true' ? 'hide-amount' : ''}">${formatCurrency(account.balance, account.currency, account.currency)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <p class="text-sm text-text-secondary">P&L</p>
                            <p class="text-lg font-semibold ${pl > 0 ? 'text-positive' : (pl < 0 ? 'text-negative' : '')} ${isHidden && localStorage.getItem('streamerModeActive') === 'true' ? 'hide-amount' : ''}">${formatCurrency(pl, account.currency, account.currency)} (${plPercentage.toFixed(1)}%)</p>
                        </div>
                        <div>
                            <p class="text-sm text-text-secondary">Win Rate</p>
                            <p class="text-lg font-semibold text-green">${winRate.toFixed(0)}%</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button class="view-account-btn text-sm" data-id="${account.id}" style="background: var(--primary); color: var(--background); padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; border: none; transition: all 0.2s ease;">
                            <i class="fas fa-chart-line mr-1"></i> Detalles
                        </button>
                        <div class="space-x-2">
                            <button class="edit-account-btn text-sm text-white" data-id="${account.id}" title="Editar Cuenta">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-account-btn text-sm text-red" data-id="${account.id}" title="Eliminar Cuenta">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add listeners for per-account streamer toggles
            document.querySelectorAll('.toggle-account-stream-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const accountId = btn.dataset.id;
                    const hiddenAccounts = JSON.parse(localStorage.getItem('streamerHiddenAccounts') || '[]');
                    const isHidden = hiddenAccounts.includes(accountId);
                    if (isHidden) {
                        const idx = hiddenAccounts.indexOf(accountId);
                        hiddenAccounts.splice(idx, 1);
                        btn.classList.remove('active');
                        btn.setAttribute('aria-pressed', 'false');
                        btn.querySelector('i').classList.remove('fa-eye');
                        btn.querySelector('i').classList.add('fa-eye-slash');
                    } else {
                        hiddenAccounts.push(accountId);
                        btn.classList.add('active');
                        btn.setAttribute('aria-pressed', 'true');
                        btn.querySelector('i').classList.remove('fa-eye-slash');
                        btn.querySelector('i').classList.add('fa-eye');
                    }
                    localStorage.setItem('streamerHiddenAccounts', JSON.stringify(hiddenAccounts));
                    refreshAccountsView();
                });
            });

            container.addEventListener('click', async function (event) {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const accountId = targetButton.dataset.id;
                const account = DB.accounts.find(acc => acc.id === accountId);

                if (targetButton.classList.contains('view-account-btn')) {
                    showAccountDetails(accountId);
                } else if (targetButton.classList.contains('edit-account-btn')) {
                    if (account) toggleAddAccountForm(account);
                } else if (targetButton.classList.contains('delete-account-btn')) {
                    const opsCount = DB.operations.filter(op => op.accountId === accountId).length;
                    if (confirm(`¬øEliminar cuenta "${account?.name || accountId}" y TODAS sus ${opsCount} operaciones?\n\nEsta acci√≥n es IRREVERSIBLE y eliminar√°:\n‚Ä¢ La cuenta\n‚Ä¢ ${opsCount} operaci√≥n(es) de trading\n\n¬øDeseas continuar?`)) {
                        showLoading(true);
                        try {
                            // Eliminar de base de datos local (IndexedDB)
                            await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, async () => {
                                await dexieDB.accounts.delete(accountId);
                                const opsToDelete = DB.operations.filter(op => op.accountId === accountId).map(op => op.id);
                                if (opsToDelete.length > 0) await dexieDB.operations.bulkDelete(opsToDelete);
                            });

                            // Eliminar de Supabase (esta funci√≥n ya elimina las operaciones primero)
                            await deleteAccountFromSupabase(accountId);

                            // Actualizar DB en memoria
                            DB.accounts = DB.accounts.filter(a => a.id !== accountId);
                            DB.operations = DB.operations.filter(op => op.accountId !== accountId);

                            // Actualizar interfaz
                            updateAccountBalances();
                            ['dashboard-account-select', 'analytics-account-select', 'equity-account-select', 'daily-journal-account-select', 'calendar-account-select', 'op-account', 'filter-account', 'bingx-account'].forEach(updateAccountSelect);

                            const detailsSection = document.getElementById('selected-account-details');
                            if (detailsSection.style.display === 'block' && detailsSection.dataset.accountId === accountId) {
                                detailsSection.style.display = 'none'; detailsSection.removeAttribute('data-accountId');
                            }
                            
                            refreshAllViews();
                            
                            console.log(`‚úÖ Cuenta "${account?.name}" y ${opsCount} operaciones eliminadas correctamente`);
                        }
                        catch (e) {
                            console.error("Error deleting account:", e); 
                            alert(`Error al eliminar la cuenta: ${e.message}`);
                        } finally { 
                            showLoading(false); 
                        }
                    }
                }
            });
        }

        let accountDetailRadarChart = null;
        function updateAccountDetailRadarChart(operations, accountId) {
            const ctx = document.getElementById('account-detail-radar-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountDetailRadarChart) accountDetailRadarChart.destroy();

            // This function is essentially the same as updateDashboardRadarChart,
            // but targets the account detail canvas.
            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);

            let maxDrawdownPercentage = 0;
            const account = DB.accounts.find(a => a.id === accountId);
            if (operations.length > 0 && account) {
                const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                let accountInitialBalance = account.initialBalance;

                if (accountInitialBalance > 0) {
                    let peakBalance = accountInitialBalance;
                    let maxDrawdownValue = 0;
                    let currentBalance = accountInitialBalance;
                    sortedOps.forEach(op => {
                        let pl = convertCurrency(op.pl, op.currency, account.currency);
                        currentBalance += pl;
                        if (currentBalance > peakBalance) peakBalance = currentBalance;
                        const drawdown = peakBalance - currentBalance;
                        if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
                    });
                    maxDrawdownPercentage = (maxDrawdownValue / accountInitialBalance) * 100;
                }
            }

            const winRateScore = basicMetrics.winRate || 0;
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3, 1) * 100;
            const avgWLRatio = advancedMetrics.avgWin && advancedMetrics.avgLoss ? Math.abs(convertCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, account.currency) / convertCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, account.currency)) : 0;
            const avgWLRatioScore = Math.min(avgWLRatio / 3, 1) * 100;
            const drawdownScore = Math.max(0, (1 - Math.min(maxDrawdownPercentage / 20, 1)) * 100);

            let consistencyScore = 0;
            if (operations.length > 1) {
                const tradingDays = new Set(operations.map(op => op.date));
                if (tradingDays.size > 0) {
                    const dailyPL = {};
                    operations.forEach(op => {
                        if (!dailyPL[op.date]) dailyPL[op.date] = 0;
                        dailyPL[op.date] += convertCurrency(op.pl, op.currency, account.currency);
                    });
                    const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
                    consistencyScore = (winningDays / tradingDays.size) * 100;
                }
            }

            accountDetailRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Profit Factor', 'Avg Win/Loss', 'Drawdown Ctrl', 'Consistencia'],
                    datasets: [{
                        label: 'Puntuaci√≥n',
                        data: [winRateScore, profitFactorScore, avgWLRatioScore, drawdownScore, consistencyScore],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: 'rgba(57, 255, 20, 0.8)',
                        pointBackgroundColor: 'var(--primary)',
                        pointBorderColor: '#0a0a0a',
                        pointHoverBackgroundColor: '#FFFFFF',
                        pointHoverBorderColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            angleLines: { color: '#2a2a2a' },
                            grid: { color: '#2a2a2a' },
                            pointLabels: { color: '#FFFFFF', font: { size: 10 } },
                            ticks: { display: false, stepSize: 25 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }


        function showAccountDetails(accountId) {
            const account = DB.accounts.find(acc => acc.id === accountId); if (!account) return;
            document.querySelectorAll('.account-card').forEach(card => card.classList.toggle('selected', card.dataset.id === accountId));
            const detailsSection = document.getElementById('selected-account-details');
            if (!detailsSection) return;
            detailsSection.style.display = 'block'; detailsSection.dataset.accountId = accountId;

            document.getElementById('account-detail-name').textContent = `Detalles de ${account.name}`;

            const operations = DB.operations.filter(op => op.accountId === accountId);
            const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));

            let totalWin = 0, totalLoss = 0, winCount = 0, lossCount = 0;
            let avgWin = 0, avgLoss = 0;

            operations.forEach(op => {
                let pl = op.pl;
                if (op.currency !== account.currency) pl = convertCurrency(pl, op.currency, account.currency);
                if (op.result === 'win') { totalWin += pl; winCount++; }
                else if (op.result === 'loss') { totalLoss += pl; lossCount++; }
            });

            if (winCount > 0) avgWin = totalWin / winCount;
            if (lossCount > 0) avgLoss = totalLoss / lossCount;

            const totalPL = totalWin + totalLoss;
            const winRate = (winCount + lossCount) > 0 ? (winCount / (winCount + lossCount)) * 100 : 0;
            const profitFactor = Math.abs(totalLoss) > 0 ? Math.abs(totalWin / totalLoss) : (totalWin > 0 ? Infinity : 0);
            const avgWLRatio = Math.abs(avgLoss) > 0 ? Math.abs(avgWin / avgLoss) : (avgWin > 0 ? Infinity : 0);

            let peakBalance = account.initialBalance;
            let maxDrawdownValue = 0;
            let currentBalance = account.initialBalance;
            sortedOps.forEach(op => {
                let pl = op.pl;
                if (op.currency !== account.currency) pl = convertCurrency(pl, op.currency, account.currency);
                currentBalance += pl;
                if (currentBalance > peakBalance) peakBalance = currentBalance;
                const drawdown = peakBalance - currentBalance;
                if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
            });
            const maxDrawdownPercentage = account.initialBalance > 0 ? (maxDrawdownValue / account.initialBalance) * 100 : 0;

            let totalDurationMinutes = 0, tradesWithDuration = 0;
            operations.forEach(op => {
                if (op.entryTime && op.exitTime) {
                    try {
                        const startDate = new Date(`1970-01-01T${op.entryTime}`);
                        const endDate = new Date(`1970-01-01T${op.exitTime}`);
                        let duration = (endDate - startDate) / 60000;
                        if (duration < 0) duration += 24 * 60; // Overnight
                        totalDurationMinutes += duration;
                        tradesWithDuration++;
                    } catch (e) { console.warn("Invalid time format for holding time calc", e); }
                }
            });
            let avgHoldTimeText = 'N/A';
            if (tradesWithDuration > 0) {
                const avgMinutes = totalDurationMinutes / tradesWithDuration;
                if (avgMinutes < 1) avgHoldTimeText = `${(avgMinutes * 60).toFixed(0)} seg`;
                else if (avgMinutes < 60) avgHoldTimeText = `${avgMinutes.toFixed(0)} min`;
                else avgHoldTimeText = `${Math.floor(avgMinutes / 60)}h ${Math.round(avgMinutes % 60)}m`;
            }

            let longestWinStreak = 0, currentWinStreak = 0, longestLossStreak = 0, currentLossStreak = 0;
            sortedOps.forEach(op => {
                if (op.result === 'win') { currentWinStreak++; currentLossStreak = 0; longestWinStreak = Math.max(longestWinStreak, currentWinStreak); }
                else if (op.result === 'loss') { currentLossStreak++; currentWinStreak = 0; longestLossStreak = Math.max(longestLossStreak, currentLossStreak); }
                else { currentWinStreak = 0; currentLossStreak = 0; }
            });

            const analyzeTradeType = (trades) => {
                const wins = trades.filter(t => t.result === 'win').length;
                const losses = trades.filter(t => t.result === 'loss').length;
                const totalPL = trades.reduce((sum, t) => sum + (t.currency !== account.currency ? convertCurrency(t.pl, t.currency, account.currency) : t.pl), 0);
                const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
                return { count: trades.length, totalPL, winRate };
            };
            const longStats = analyzeTradeType(operations.filter(op => op.type === 'buy'));
            const shortStats = analyzeTradeType(operations.filter(op => op.type === 'sell'));

            const plEl = document.getElementById('account-detail-pl');
            plEl.textContent = formatCurrency(totalPL, account.currency, account.currency);
            plEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-positive' : 'text-negative'}`;
            document.getElementById('account-detail-winrate').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('account-detail-winrate').className = "text-2xl font-bold text-green";
            document.getElementById('account-detail-trades').textContent = operations.length;
            const pfEl = document.getElementById('account-detail-pf');
            pfEl.textContent = isFinite(profitFactor) ? profitFactor.toFixed(2) : "‚àû";
            pfEl.className = `text-2xl font-bold ${profitFactor >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('account-detail-drawdown').textContent = `${formatCurrency(maxDrawdownValue, account.currency, account.currency)} (${maxDrawdownPercentage.toFixed(1)}%)`;
            const avgWLRatioEl = document.getElementById('account-detail-avg-w-l-ratio');
            avgWLRatioEl.textContent = isFinite(avgWLRatio) ? avgWLRatio.toFixed(2) : "‚àû";
            avgWLRatioEl.className = `font-semibold ${avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('account-detail-win-streak').textContent = longestWinStreak;
            document.getElementById('account-detail-loss-streak').textContent = longestLossStreak;
            document.getElementById('account-detail-hold-time').textContent = avgHoldTimeText;

            const lsBody = document.getElementById('account-long-short-analysis');
            lsBody.innerHTML = `
                <tr>
                    <td>Compras</td><td>${longStats.count}</td>
                    <td class="${longStats.totalPL >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(longStats.totalPL, account.currency, account.currency)}</td>
                    <td class="text-green">${longStats.winRate.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Ventas</td><td>${shortStats.count}</td>
                    <td class="${shortStats.totalPL >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(shortStats.totalPL, account.currency, account.currency)}</td>
                    <td class="text-green">${shortStats.winRate.toFixed(1)}%</td>
                </tr>`;

            const accountDetailTimeRangeContainer = document.getElementById('account-detail-time-range');
            accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
            const allButtonAccountDetail = Array.from(accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn')).find(btn => btn.dataset.range === 'ALL');
            if (allButtonAccountDetail) allButtonAccountDetail.classList.add('active');

            updateAccountDetailChart(account, operations, 'ALL');
            updateAccountDetailRadarChart(operations, accountId); // <-- Nueva llamada
            
            // Actualizar nuevos gr√°ficos para account details
            updateAccountReduccionAcumuladaChart(operations, account, 'ALL');
            updateAccountPnLAcumuladoChart(operations, account, 'ALL');
            updateAccountDailyPnLChart(operations, account);
            updateAccountDailyWinLossChart(operations, account);
            
            updateBestWorstTrades(account, sortedOps);
            detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateBestWorstTrades(account, sortedOperations) {
            const bestTradesBody = document.getElementById('best-trades');
            const worstTradesBody = document.getElementById('worst-trades');
            if (!bestTradesBody || !worstTradesBody) return;
            bestTradesBody.innerHTML = ''; worstTradesBody.innerHTML = '';

            const best5 = [...sortedOperations].sort((a, b) => b.pl - a.pl).filter(op => op.pl > 0).slice(0, 5);
            const worst5 = [...sortedOperations].sort((a, b) => a.pl - b.pl).filter(op => op.pl < 0).slice(0, 5);

            const populateTable = (tbody, ops) => {
                if (ops.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-text-secondary py-4">No hay operaciones</td></tr>'; return; }
                ops.forEach(op => {
                    const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
                    const row = tbody.insertRow(); // Insertar la fila
                    row.dataset.id = op.id; // A√±adir data-id a la fila
                    row.classList.add('cursor-pointer'); // A√±adir clase para hacerla clicable

                    row.innerHTML = `
                        <td>${formatDate(op.date)}</td>
                        <td>${op.instrument}</td>
                        <td class="${plClass}">${formatCurrency(op.pl, op.currency, op.currency)}</td>`;
                });
            };
            populateTable(bestTradesBody, best5);
            populateTable(worstTradesBody, worst5);

            // A√±adir event listeners a las tablas de mejores y peores operaciones
            bestTradesBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const operationId = row.dataset.id;
                    if (operationId) showOperationDetailPage(operationId);
                });
            });
            worstTradesBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const operationId = row.dataset.id;
                    if (operationId) showOperationDetailPage(operationId);
                });
            });
        }

        async function processCSVFile(file, statusDiv) {
            showLoading(true);
            const csvText = await file.text();
            const parsedData = parseCSV(csvText);

            if (!parsedData.headers || parsedData.rows.length === 0) {
                throw new Error("CSV vac√≠o o formato de cabecera incorrecto.");
            }

            const headerMap = {};
            parsedData.headers.forEach((header, index) => {
                const normalizedHeader = header.toLowerCase().trim().replace(/\s+/g, ' ').replace(/\//g, '');
                headerMap[normalizedHeader] = index;
            });

            const requiredHeaders = ['nombre cuenta', 'id', 'fecha', 'instrumento', 'tipo', 'volumen', 'divisa'];
            for (const reqHeader of requiredHeaders) {
                if (!(reqHeader in headerMap)) {
                    throw new Error(`Cabecera requerida no encontrada en CSV: '${reqHeader}'.`);
                }
            }

            let importedOpsCount = 0;
            let skippedOpsCount = 0;
            const operationsMap = new Map();

            for (const row of parsedData.rows) {
                const opId = row[headerMap['id']];
                if (!opId || opId.trim() === "") {
                    skippedOpsCount++;
                    continue;
                }

                const accountNameFromCsv = row[headerMap['nombre cuenta']];
                const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());
                if (!account) {
                    console.warn(`Cuenta no encontrada: "${accountNameFromCsv}". Operaci√≥n omitida.`);
                    skippedOpsCount++;
                    continue;
                }

                const dateStr = row[headerMap['fecha']];
                let opDate;
                const cleanDateStr = dateStr.trim();
                if (cleanDateStr.includes('-')) {
                    const parts = cleanDateStr.split('-');
                    if (parts.length === 3 && parts[0].length === 4) {
                        opDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    }
                } else if (cleanDateStr.includes('/')) {
                    const parts = cleanDateStr.split('/');
                    if (parts.length === 3) {
                        opDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }

                if (!opDate) {
                    console.warn(`Fecha inv√°lida: "${dateStr}". Operaci√≥n omitida.`);
                    skippedOpsCount++;
                    continue;
                }

                const instrument = row[headerMap['instrumento']].toUpperCase().trim();
                const type = row[headerMap['tipo']].toLowerCase().trim();
                const entryTime = row[headerMap['hora entrada']] || null;
                const exitTime = row[headerMap['hora salida']] || null;
                const entry = parseFloat(String(row[headerMap['entrada']]).replace(',', '.'));
                const exit = parseFloat(String(row[headerMap['salida']]).replace(',', '.'));
                const volume = parseFloat(String(row[headerMap['volumen']]).replace(',', '.'));
                const currency = row[headerMap['divisa']].toUpperCase().trim();
                const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';
                const fees = parseFloat(String(row[headerMap['tarifa comision']]).replace(',', '.')) || 0;
                let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
                    ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                    : (exit - entry) * volume * (type === 'buy' ? 1 : -1);

                if (operationsMap.has(opId)) {
                    const existingOp = operationsMap.get(opId);
                    existingOp.pl += pl;
                    existingOp.volume += volume;
                    existingOp.fees += fees;
                    existingOp.exitTime = exitTime || existingOp.exitTime;
                    existingOp.exit = !isNaN(exit) ? exit : existingOp.exit;
                    existingOp.notes = [existingOp.notes, notes].filter(Boolean).join('; ');
                } else {
                    operationsMap.set(opId, {
                        id: opId,
                        date: opDate,
                        accountId: account.id,
                        instrument,
                        type,
                        entry: isNaN(entry) ? null : entry,
                        exit: isNaN(exit) ? null : exit,
                        entryTime,
                        exitTime,
                        volume,
                        pl,
                        currency,
                        notes,
                        fees,
                        result: '',
                        imageDatas: [],
                        manualPL: null,
                        session: null
                    });
                }
            }

            const newOperations = Array.from(operationsMap.values());
            newOperations.forEach(op => {
                op.result = op.pl > 0 ? 'win' : (op.pl < 0 ? 'loss' : 'breakeven');
                importedOpsCount++;
            });

            if (newOperations.length > 0) {
                await dexieDB.operations.bulkPut(newOperations);

                // Merge new/updated operations into DB.operations
                newOperations.forEach(newOp => {
                    const existingOpIndex = DB.operations.findIndex(op => op.id === newOp.id);
                    if (existingOpIndex !== -1) {
                        DB.operations[existingOpIndex] = newOp;
                    } else {
                        DB.operations.push(newOp);
                    }
                });

                updateAccountBalances();
                refreshAllViews();
            }

            if (statusDiv) {
                statusDiv.textContent = `Importaci√≥n completada: ${importedOpsCount} operaciones a√±adidas, ${skippedOpsCount} omitidas.`;
                statusDiv.className = 'mt-2 text-sm text-positive';
            }

            showLoading(false);
        }

        // ===== FUNDED ACCOUNTS =====
        function initFunded() {
            console.log('üèÜ Inicializando Funded Accounts...');

            // L√≥gica para el cambio de pesta√±as en la secci√≥n Funded
            const fundedTabs = document.querySelectorAll('#funded .funded-tab');
            const fundedViews = document.querySelectorAll('#funded .funded-view');

            fundedTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Desactivar todas las pesta√±as y vistas
                    fundedTabs.forEach(t => t.classList.remove('active'));
                    fundedViews.forEach(v => {
                        if (v) v.classList.remove('active');
                    });

                    // Activar la pesta√±a y vista seleccionada
                    tab.classList.add('active');
                    const targetViewId = tab.dataset.target;
                    const targetView = document.getElementById(targetViewId);
                    if (targetView) {
                        targetView.classList.add('active');
                    }
                });
            });

            
            // Verificar elementos de pesta√±as y vistas
            const fundedElements = {
                tabAccounts: document.getElementById('funded-tab-accounts'),
                viewAccounts: document.getElementById('funded-accounts-view'),
                calendarContainer: document.getElementById('funded-calendar-container'),
                calendarMonthYear: document.getElementById('funded-calendar-month-year'),
                calendarPrev: document.getElementById('funded-calendar-prev'),
                calendarNext: document.getElementById('funded-calendar-next')
            };
            
            console.log('üîç Verificando elementos de Funded:', {
                viewAccounts: !!fundedElements.viewAccounts,
                calendarContainer: !!fundedElements.calendarContainer,
                calendarMonthYear: !!fundedElements.calendarMonthYear,
                calendarPrev: !!fundedElements.calendarPrev,
                calendarNext: !!fundedElements.calendarNext
            });

            // Elementos DOM
            const modal = document.getElementById('funded-account-modal');
            const openBtn = document.getElementById('add-funded-account-btn');
            const closeBtn = document.getElementById('close-funded-modal');
            const cancelBtn = document.getElementById('cancel-funded-account');
            const form = document.getElementById('funded-account-form');
            const companySelect = document.getElementById('funded-company');
            const customCompanyContainer = document.getElementById('funded-custom-company-container');
            const typeSelect = document.getElementById('funded-type');
            const earningsContainer = document.getElementById('funded-earnings-container');
            const withdrawalsContainer = document.getElementById('funded-withdrawals-container');

            let currentFilter = 'all';
            let currentDateFilter = { type: 'all', startDate: null, endDate: null };
            let editingAccountId = null;

            // Abrir modal para nueva cuenta
            if (openBtn) {
                openBtn.addEventListener('click', () => {
                    editingAccountId = null;
                    form.reset();
                    document.getElementById('funded-modal-title').textContent = 'Nueva Cuenta Funded';
                    document.getElementById('funded-type').value = 'evaluation';
                    toggleEarningsFields('evaluation');
                    modal.style.display = 'flex';
                });
            }

            // Cerrar modal
            if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
            if (cancelBtn) cancelBtn.addEventListener('click', () => modal.style.display = 'none');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            }

            // Mostrar/ocultar empresa personalizada
            if (companySelect) {
                companySelect.addEventListener('change', (e) => {
                    customCompanyContainer.style.display = e.target.value === 'Otra' ? 'block' : 'none';
                });
            }

            // Mostrar/ocultar campos de ganancias seg√∫n tipo
            if (typeSelect) {
                typeSelect.addEventListener('change', (e) => {
                    toggleEarningsFields(e.target.value);
                });
            }

            function toggleEarningsFields(type) {
                const isLive = type === 'live';
                earningsContainer.style.display = isLive ? 'block' : 'none';
                withdrawalsContainer.style.display = isLive ? 'block' : 'none';
                if (!isLive) {
                    document.getElementById('funded-earnings').value = '';
                    document.getElementById('funded-withdrawals-count').value = '';
                }
            }

            // Guardar cuenta
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const companyValue = document.getElementById('funded-company').value;
                    const company = companyValue === 'Otra' 
                        ? document.getElementById('funded-custom-company').value 
                        : companyValue;

                    const account = {
                        id: editingAccountId || generateId(),
                        name: document.getElementById('funded-name').value,
                        company: company,
                        type: document.getElementById('funded-type').value,
                        status: document.getElementById('funded-status').value,
                        fee: parseFloat(document.getElementById('funded-fee').value) || 0,
                        activationDate: document.getElementById('funded-activation-date').value,
                        earnings: parseFloat(document.getElementById('funded-earnings').value) || 0,
                        withdrawals: parseInt(document.getElementById('funded-withdrawals-count').value) || 0,
                        notes: document.getElementById('funded-notes').value,
                        createdAt: editingAccountId ? DB.fundedAccounts.find(a => a.id === editingAccountId)?.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        if (editingAccountId) {
                            const index = DB.fundedAccounts.findIndex(a => a.id === editingAccountId);
                            DB.fundedAccounts[index] = account;
                            await dexieDB.fundedAccounts.put(account);
                            await saveFundedAccountToSupabase(account);
                            showNotification('Cuenta actualizada correctamente', 'success');
                        } else {
                            DB.fundedAccounts.push(account);
                            await dexieDB.fundedAccounts.add(account);
                            await saveFundedAccountToSupabase(account);
                            showNotification('Cuenta creada correctamente', 'success');
                        }

                        modal.style.display = 'none';
                        refreshFunded();
                    } catch (error) {
                        console.error('Error guardando cuenta:', error);
                        showNotification('Error al guardar la cuenta', 'error');
                    }
                });
            }

            // Filtros de estado
            document.querySelectorAll('.funded-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.funded-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderAccountsTable();
                });
            });

            // Filtro de fecha
            const dateFilterBtn = document.getElementById('funded-date-filter-btn');
            if (dateFilterBtn) {
                dateFilterBtn.addEventListener('click', () => {
                    const calendar = document.getElementById('calendar-modal');
                    if (calendar) {
                        calendar.style.display = 'flex';
                        calendar.dataset.targetSection = 'funded';
                    }
                });
            }

            // Renderizar tabla de cuentas
            function renderAccountsTable() {
                const tbody = document.getElementById('funded-accounts-table');
                if (!tbody) return;

                let accounts = [...DB.fundedAccounts];

                // Aplicar filtro de estado
                if (currentFilter !== 'all') {
                    if (currentFilter === 'evaluation') {
                        accounts = accounts.filter(a => a.type === 'evaluation');
                    } else if (currentFilter === 'live') {
                        accounts = accounts.filter(a => a.type === 'live');
                    } else if (currentFilter === 'active') {
                        accounts = accounts.filter(a => a.status === 'active');
                    } else if (currentFilter === 'suspended') {
                        accounts = accounts.filter(a => a.status === 'suspended');
                    }
                }

                // Aplicar filtro de fecha
                if (currentDateFilter.type !== 'all' && currentDateFilter.startDate) {
                    accounts = accounts.filter(a => {
                        const date = new Date(a.activationDate);
                        return date >= new Date(currentDateFilter.startDate) && 
                               date <= new Date(currentDateFilter.endDate);
                    });
                }

                if (accounts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-text-secondary py-8">
                                No hay cuentas que coincidan con los filtros
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = accounts.map(account => {
                    const beneficio = account.earnings - account.fee;
                    const beneficioClass = beneficio >= 0 ? 'text-green' : 'text-red';
                    const statusBadge = account.status === 'active' 
                        ? '<span class="badge badge-success">Activa</span>' 
                        : '<span class="badge badge-danger">Suspendida</span>';
                    const typeBadge = account.type === 'evaluation' 
                        ? '<span class="badge badge-warning">Evaluaci√≥n</span>' 
                        : '<span class="badge badge-primary">Live</span>';

                    return `
                        <tr>
                            <td class="font-medium">${account.name}</td>
                            <td class="text-center">${typeBadge}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td>${account.company}</td>
                            <td class="text-right text-red">‚Ç¨${account.fee.toFixed(2)}</td>
                            <td class="text-right text-green">‚Ç¨${account.earnings.toFixed(2)}</td>
                            <td class="text-right ${beneficioClass} font-bold">‚Ç¨${beneficio.toFixed(2)}</td>
                            <td class="text-center">
                                <button onclick="editFundedAccount('${account.id}')" class="text-primary hover:text-primary-light" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteFundedAccount('${account.id}')" class="text-red hover:text-red-light ml-2" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Editar cuenta
            window.editFundedAccount = function(id) {
                const account = DB.fundedAccounts.find(a => a.id === id);
                if (!account) return;

                editingAccountId = id;
                document.getElementById('funded-modal-title').textContent = 'Editar Cuenta Funded';
                document.getElementById('funded-account-id').value = account.id;
                document.getElementById('funded-name').value = account.name;
                
                const companySelect = document.getElementById('funded-company');
                const isCustom = !Array.from(companySelect.options).some(opt => opt.value === account.company);
                if (isCustom) {
                    companySelect.value = 'Otra';
                    document.getElementById('funded-custom-company').value = account.company;
                    customCompanyContainer.style.display = 'block';
                } else {
                    companySelect.value = account.company;
                    customCompanyContainer.style.display = 'none';
                }

                document.getElementById('funded-type').value = account.type;
                document.getElementById('funded-status').value = account.status;
                document.getElementById('funded-fee').value = account.fee;
                document.getElementById('funded-activation-date').value = account.activationDate;
                document.getElementById('funded-earnings').value = account.earnings || '';
                document.getElementById('funded-withdrawals-count').value = account.withdrawals || '';
                document.getElementById('funded-notes').value = account.notes || '';
                
                toggleEarningsFields(account.type);
                modal.style.display = 'flex';
            };

            // Eliminar cuenta
            window.deleteFundedAccount = async function(id) {
                if (!confirm('¬øEst√°s seguro de eliminar esta cuenta? Esta acci√≥n no se puede deshacer.')) return;

                try {
                    DB.fundedAccounts = DB.fundedAccounts.filter(a => a.id !== id);
                    await dexieDB.fundedAccounts.delete(id);
                    await deleteFundedAccountFromSupabase(id);
                    showNotification('Cuenta eliminada correctamente', 'success');
                    refreshFunded();
                } catch (error) {
                    console.error('Error eliminando cuenta:', error);
                    showNotification('Error al eliminar la cuenta', 'error');
                }
            };

            // Calcular m√©tricas
            function calculateMetrics(accounts) {
                const evaluations = accounts.filter(a => a.type === 'evaluation').length;
                const inProgress = accounts.filter(a => a.type === 'evaluation' && a.status === 'active').length;
                const liveAccounts = accounts.filter(a => a.type === 'live').length;
                const totalExpenses = accounts.reduce((sum, a) => sum + a.fee, 0);
                const totalEarnings = accounts.reduce((sum, a) => sum + a.earnings, 0);
                const netProfit = totalEarnings - totalExpenses;
                const fundingRatio = evaluations > 0 ? (liveAccounts / evaluations * 100) : 0;
                const roi = totalExpenses > 0 ? (netProfit / totalExpenses * 100) : 0;

                return {
                    evaluations,
                    inProgress,
                    liveAccounts,
                    totalExpenses,
                    totalEarnings,
                    netProfit,
                    fundingRatio,
                    roi
                };
            }

            // Renderizar dashboard
            function renderDashboard() {
                let accounts = [...DB.fundedAccounts];

                // Aplicar filtro de fecha
                if (currentDateFilter.type !== 'all' && currentDateFilter.startDate) {
                    accounts = accounts.filter(a => {
                        const date = new Date(a.activationDate);
                        return date >= new Date(currentDateFilter.startDate) && 
                               date <= new Date(currentDateFilter.endDate);
                    });
                }

                const metrics = calculateMetrics(accounts);

                document.getElementById('funded-evaluations').textContent = metrics.evaluations;
                document.getElementById('funded-in-progress').textContent = metrics.inProgress;
                document.getElementById('funded-live-accounts').textContent = metrics.liveAccounts;
                document.getElementById('funded-ratio').textContent = `${metrics.fundingRatio.toFixed(1)}%`;
                document.getElementById('funded-total-expenses').textContent = `‚Ç¨${metrics.totalExpenses.toFixed(2)}`;
                document.getElementById('funded-total-earnings').textContent = `‚Ç¨${metrics.totalEarnings.toFixed(2)}`;
                
                const netProfitEl = document.getElementById('funded-net-profit');
                netProfitEl.textContent = `‚Ç¨${metrics.netProfit.toFixed(2)}`;
                netProfitEl.className = `text-4xl font-bold ${metrics.netProfit >= 0 ? 'text-green' : 'text-red'}`;

                document.getElementById('funded-roi-display').textContent = `ROI: ${metrics.roi.toFixed(1)}%`;

                // Estad√≠sticas (simuladas por ahora)
                document.getElementById('funded-best-day').textContent = '‚Ç¨0.00';
                document.getElementById('funded-worst-day').textContent = '‚Ç¨0.00';
                document.getElementById('funded-avg-daily').textContent = '‚Ç¨0.00';
                const totalWithdrawals = accounts.reduce((sum, a) => sum + a.withdrawals, 0);
                document.getElementById('funded-withdrawals').textContent = totalWithdrawals;
            }

            // Renderizar an√°lisis por empresa
            function renderCompanyAnalysis() {
                const companies = {};

                DB.fundedAccounts.forEach(account => {
                    if (!companies[account.company]) {
                        companies[account.company] = {
                            name: account.company,
                            count: 0,
                            expenses: 0,
                            earnings: 0,
                            profit: 0,
                            roi: 0
                        };
                    }

                    companies[account.company].count++;
                    companies[account.company].expenses += account.fee;
                    companies[account.company].earnings += account.earnings;
                });

                Object.values(companies).forEach(company => {
                    company.profit = company.earnings - company.expenses;
                    company.roi = company.expenses > 0 ? (company.profit / company.expenses * 100) : 0;
                });

                const companiesArray = Object.values(companies);

                // Top por ROI
                const topRoi = [...companiesArray].sort((a, b) => b.roi - a.roi).slice(0, 3);
                const topRoiContainer = document.getElementById('funded-top-roi');
                if (topRoi.length === 0) {
                    topRoiContainer.innerHTML = '<p class="text-sm text-text-secondary text-center py-8">No hay datos disponibles</p>';
                } else {
                    topRoiContainer.innerHTML = topRoi.map((company, index) => `
                        <div class="flex items-center justify-between p-3 bg-surface rounded">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-warning' : index === 1 ? 'bg-gray-400' : 'bg-orange-600'} flex items-center justify-center text-white font-bold">
                                    ${index + 1}
                                </div>
                                <div>
                                    <p class="font-medium">${company.name}</p>
                                    <p class="text-xs text-text-secondary">${company.count} cuenta${company.count !== 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold ${company.roi >= 0 ? 'text-green' : 'text-red'}">${company.roi.toFixed(1)}%</p>
                                <p class="text-xs text-text-secondary">‚Ç¨${company.profit.toFixed(2)}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Top por Retiros
                const topWithdrawals = [...companiesArray].sort((a, b) => b.earnings - a.earnings).slice(0, 3);
                const topWithdrawalsContainer = document.getElementById('funded-top-withdrawals');
                if (topWithdrawals.length === 0) {
                    topWithdrawalsContainer.innerHTML = '<p class="text-sm text-text-secondary text-center py-8">No hay datos disponibles</p>';
                } else {
                    topWithdrawalsContainer.innerHTML = topWithdrawals.map((company, index) => `
                        <div class="flex items-center justify-between p-3 bg-surface rounded">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-green' : index === 1 ? 'bg-gray-400' : 'bg-orange-600'} flex items-center justify-center text-white font-bold">
                                    ${index + 1}
                                </div>
                                <div>
                                    <p class="font-medium">${company.name}</p>
                                    <p class="text-xs text-text-secondary">${company.count} cuenta${company.count !== 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-green">‚Ç¨${company.earnings.toFixed(2)}</p>
                                <p class="text-xs text-text-secondary">Promedio: ‚Ç¨${(company.earnings / company.count).toFixed(2)}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Tabla de todas las empresas
                const tbody = document.getElementById('funded-companies-table');
                if (companiesArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-text-secondary py-8">No hay empresas registradas</td></tr>';
                } else {
                    tbody.innerHTML = companiesArray.map(company => `
                        <tr>
                            <td class="font-medium">${company.name}</td>
                            <td class="text-center">${company.count}</td>
                            <td class="text-right text-red">‚Ç¨${company.expenses.toFixed(2)}</td>
                            <td class="text-right text-green">‚Ç¨${company.earnings.toFixed(2)}</td>
                            <td class="text-right ${company.profit >= 0 ? 'text-green' : 'text-red'} font-bold">‚Ç¨${company.profit.toFixed(2)}</td>
                            <td class="text-right ${company.roi >= 0 ? 'text-green' : 'text-red'} font-bold">${company.roi.toFixed(1)}%</td>
                        </tr>
                    `).join('');
                }
            }

            // Refresh completo
            function refreshFunded() {
                renderDashboard();
                renderAccountsTable();
                renderCompanyAnalysis();
                renderEvolutionChart();
                
                // Actualizar el calendario tambi√©n
                if (typeof renderFundedCalendar === 'function') {
                    renderFundedCalendar();
                }
            }

            // Gr√°fico de evoluci√≥n
            function renderEvolutionChart() {
                const canvas = document.getElementById('funded-evolution-chart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destruir gr√°fico existente
                if (window.fundedEvolutionChart) {
                    window.fundedEvolutionChart.destroy();
                }

                // Crear dataset basado en fechas de activaci√≥n
                const sortedAccounts = [...DB.fundedAccounts].sort((a, b) => 
                    new Date(a.activationDate) - new Date(b.activationDate)
                );

                if (sortedAccounts.length === 0) {
                    // Mostrar mensaje cuando no hay datos
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#8b949e';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos para mostrar', canvas.width / 2, canvas.height / 2);
                    return;
                }

                let cumulativeProfit = 0;
                const labels = [];
                const data = [];

                sortedAccounts.forEach(account => {
                    cumulativeProfit += (account.earnings - account.fee);
                    labels.push(new Date(account.activationDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }));
                    data.push(cumulativeProfit);
                });

                window.fundedEvolutionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Beneficio Acumulado',
                            data: data,
                            borderColor: '#39FF14',
                            backgroundColor: 'rgba(57, 255, 20, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#39FF14',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#39FF14',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => `Beneficio: ‚Ç¨${context.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#8b949e', maxRotation: 45, minRotation: 0 }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { 
                                    color: '#8b949e',
                                    callback: (value) => `‚Ç¨${value.toFixed(0)}`
                                }
                            }
                        }
                    }
                });
            }

            // Manejar cambio de filtro de fecha desde el calendario
            window.applyFundedDateFilter = function(filterData) {
                currentDateFilter = filterData;
                const display = document.getElementById('funded-date-filter-display');
                if (display) {
                    display.textContent = filterData.display || 'Sin filtro de fecha';
                }
                refreshFunded();
            };

            // ===== CALENDARIO FINANCIERO FUNDED =====
            let currentFundedCalendarDate = new Date();

            function renderFundedCalendar() {
                const calendarContainer = fundedElements.calendarContainer;
                const monthYearSpan = fundedElements.calendarMonthYear;
                
                if (!calendarContainer || !monthYearSpan) {
                    console.warn('‚ö†Ô∏è Elementos del calendario no encontrados');
                    return;
                }

                const year = currentFundedCalendarDate.getFullYear();
                const month = currentFundedCalendarDate.getMonth();
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                monthYearSpan.textContent = `${monthNames[month]} ${year}`;

                // Obtener primer y √∫ltimo d√≠a del mes
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();

                // Preparar eventos por fecha
                const eventsByDate = {};
                
                DB.fundedAccounts.forEach(account => {
                    // Gastos (fee en fecha de activaci√≥n)
                    if (account.activationDate && account.fee > 0) {
                        const dateKey = account.activationDate;
                        if (!eventsByDate[dateKey]) {
                            eventsByDate[dateKey] = { expenses: 0, income: 0, items: [] };
                        }
                        eventsByDate[dateKey].expenses += account.fee;
                        eventsByDate[dateKey].items.push({
                            type: 'expense',
                            amount: account.fee,
                            description: `Gasto: ${account.name}`
                        });
                    }

                    // Ganancias (earnings si es live)
                    if (account.type === 'live' && account.activationDate && account.earnings > 0) {
                        const dateKey = account.activationDate;
                        if (!eventsByDate[dateKey]) {
                            eventsByDate[dateKey] = { expenses: 0, income: 0, items: [] };
                        }
                        eventsByDate[dateKey].income += account.earnings;
                        eventsByDate[dateKey].items.push({
                            type: 'income',
                            amount: account.earnings,
                            description: `Ganancia: ${account.name}`
                        });
                    }
                });

                // Generar HTML del calendario
                let calendarHTML = `
                    <div style="min-width: 800px;">
                        <div class="grid grid-cols-7 gap-2 mb-2">
                            ${['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].map(day => 
                                `<div class="text-center text-text-secondary text-xs font-semibold py-2">${day}</div>`
                            ).join('')}
                        </div>
                        <div class="grid grid-cols-7 gap-2">
                `;

                // D√≠as vac√≠os antes del primer d√≠a
                for (let i = 0; i < startDayOfWeek; i++) {
                    calendarHTML += `<div class="h-24 bg-surface-light rounded"></div>`;
                }

                // D√≠as del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = eventsByDate[dateKey];
                    const hasEvents = dayData && (dayData.expenses > 0 || dayData.income > 0);
                    const netAmount = hasEvents ? (dayData.income - dayData.expenses) : 0;

                    calendarHTML += `
                        <div class="h-24 bg-surface rounded p-2 ${hasEvents ? 'border-2 border-primary cursor-pointer hover:bg-surface-light' : 'border border-border'}"
                             ${hasEvents ? `onclick="showFundedDayDetails('${dateKey}')"` : ''}>
                            <div class="text-sm font-semibold mb-1">${day}</div>
                            ${hasEvents ? `
                                <div class="text-xs">
                                    ${dayData.income > 0 ? `<div class="text-green">+‚Ç¨${dayData.income.toFixed(2)}</div>` : ''}
                                    ${dayData.expenses > 0 ? `<div class="text-red">-‚Ç¨${dayData.expenses.toFixed(2)}</div>` : ''}
                                    <div class="font-semibold ${netAmount >= 0 ? 'text-green' : 'text-red'}">
                                        ${netAmount >= 0 ? '+' : ''}‚Ç¨${netAmount.toFixed(2)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                calendarHTML += `
                        </div>
                    </div>
                `;

                calendarContainer.innerHTML = calendarHTML;

                // Guardar eventos para el modal
                window.fundedEventsByDate = eventsByDate;
            }

            // Sistema de almacenamiento para notas e im√°genes de d√≠as
            const FUNDED_DAY_DATA_KEY = 'funded-day-data';
            
            function getFundedDayData(dateKey) {
                const allData = JSON.parse(localStorage.getItem(FUNDED_DAY_DATA_KEY) || '{}');
                return allData[dateKey] || { notes: '', images: [], tags: [] };
            }

            function saveFundedDayData(dateKey, data) {
                const allData = JSON.parse(localStorage.getItem(FUNDED_DAY_DATA_KEY) || '{}');
                allData[dateKey] = data;
                localStorage.setItem(FUNDED_DAY_DATA_KEY, JSON.stringify(allData));
            }

            // Calcular estad√≠sticas globales de retiros
            function calculateWithdrawalStats() {
                let totalWithdrawals = 0;
                let totalExpenses = 0;
                let withdrawalCount = 0;
                let expenseCount = 0;

                DB.fundedAccounts.forEach(account => {
                    if (account.type === 'live' && account.earnings > 0) {
                        totalWithdrawals += account.earnings;
                        withdrawalCount++;
                    }
                    if (account.fee > 0) {
                        totalExpenses += account.fee;
                        expenseCount++;
                    }
                });

                const avgWithdrawal = withdrawalCount > 0 ? totalWithdrawals / withdrawalCount : 0;
                const ratio = totalExpenses > 0 ? totalWithdrawals / totalExpenses : 0;

                return {
                    totalWithdrawals,
                    totalExpenses,
                    withdrawalCount,
                    expenseCount,
                    avgWithdrawal,
                    ratio
                };
            }

            // Funci√≥n para mostrar detalles del d√≠a en pantalla completa
            window.showFundedDayDetails = function(dateKey) {
                const dayData = window.fundedEventsByDate[dateKey];
                if (!dayData) return;

                // Ocultar calendario y mostrar vista de d√≠a
                document.getElementById('funded-calendar-card').style.display = 'none';
                const fullscreenView = document.getElementById('funded-day-fullscreen');
                fullscreenView.style.display = 'block';

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Formatear fecha
                const formattedDate = new Date(dateKey + 'T00:00:00').toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const netAmount = dayData.income - dayData.expenses;

                // Actualizar encabezado
                document.getElementById('funded-day-title').textContent = formattedDate;
                document.getElementById('funded-day-date').textContent = dateKey;
                document.getElementById('funded-day-balance').textContent = `${netAmount >= 0 ? '+' : ''}‚Ç¨${netAmount.toFixed(2)}`;
                document.getElementById('funded-day-balance').className = `text-3xl font-bold ${netAmount >= 0 ? 'text-green' : 'text-red'}`;

                // Renderizar movimientos
                const movementsContainer = document.getElementById('funded-day-movements');
                movementsContainer.innerHTML = dayData.items.map(item => `
                    <div class="p-4 bg-surface-light rounded-lg border-l-4 ${item.type === 'income' ? 'border-green' : 'border-red'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${item.description}</p>
                                <p class="text-sm text-text-secondary mt-1">
                                    <i class="fas fa-${item.type === 'income' ? 'arrow-down' : 'arrow-up'} mr-1"></i>
                                    ${item.type === 'income' ? 'Ganancia' : 'Gasto'}
                                </p>
                            </div>
                            <span class="text-xl font-bold ${item.type === 'income' ? 'text-green' : 'text-red'}">
                                ${item.type === 'income' ? '+' : '-'}‚Ç¨${item.amount.toFixed(2)}
                            </span>
                        </div>
                    </div>
                `).join('');

                // Calcular y mostrar estad√≠sticas
                const stats = calculateWithdrawalStats();
                const maxValue = Math.max(stats.totalWithdrawals, stats.totalExpenses, stats.avgWithdrawal, 1000);

                document.getElementById('stat-total-withdrawals').textContent = `‚Ç¨${stats.totalWithdrawals.toFixed(2)}`;
                document.getElementById('stat-total-bar').style.width = `${(stats.totalWithdrawals / maxValue) * 100}%`;

                document.getElementById('stat-avg-withdrawals').textContent = `‚Ç¨${stats.avgWithdrawal.toFixed(2)}`;
                document.getElementById('stat-avg-bar').style.width = `${(stats.avgWithdrawal / maxValue) * 100}%`;

                document.getElementById('stat-total-expenses').textContent = `‚Ç¨${stats.totalExpenses.toFixed(2)}`;
                document.getElementById('stat-expenses-bar').style.width = `${(stats.totalExpenses / maxValue) * 100}%`;

                document.getElementById('stat-ratio').textContent = `${stats.ratio.toFixed(2)}x`;
                document.getElementById('stat-ratio-bar').style.width = `${Math.min((stats.ratio / 5) * 100, 100)}%`;

                document.getElementById('stat-count-withdrawals').textContent = stats.withdrawalCount;
                document.getElementById('stat-count-expenses').textContent = stats.expenseCount;

                // Cargar datos guardados del d√≠a
                const savedData = getFundedDayData(dateKey);
                
                // Cargar notas en vista de solo lectura
                const notesDisplay = document.getElementById('notes-display');
                if (savedData.notes && savedData.notes.trim()) {
                    notesDisplay.innerHTML = savedData.notes;
                } else {
                    notesDisplay.innerHTML = '<p class="text-text-secondary italic">No hay notas escritas a√∫n. Haz clic en "Editar Notas" para comenzar.</p>';
                }

                // Cargar im√°genes
                renderDayImages(dateKey, savedData.images);

                // Cargar etiquetas
                renderDayTags(dateKey, savedData.tags);

                // Guardar dateKey actual para eventos
                window.currentFundedDayKey = dateKey;
            };

            // Renderizar im√°genes del d√≠a
            function renderDayImages(dateKey, images) {
                const container = document.getElementById('funded-day-images-preview');
                container.innerHTML = images.map((imgData, index) => `
                    <div class="relative group cursor-pointer" onclick="viewImageFullscreen('${imgData}', ${index})">
                        <img src="${imgData}" alt="Imagen ${index + 1}" class="w-full h-64 md:h-80 object-cover rounded-lg border border-border hover:border-primary transition-all">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center">
                            <i class="fas fa-expand text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <button 
                            onclick="event.stopPropagation(); removeDayImage('${dateKey}', ${index})"
                            class="absolute top-2 right-2 bg-red text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-dark z-10"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="absolute bottom-2 left-2 bg-black bg-opacity-75 text-white px-3 py-1 rounded-full text-xs">
                            Imagen ${index + 1}
                        </div>
                    </div>
                `).join('');

                // Actualizar bot√≥n de a√±adir imagen
                const addBtn = document.getElementById('add-day-image-btn');
                if (images.length >= 3) {
                    addBtn.disabled = true;
                    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    addBtn.disabled = false;
                    addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // Ver imagen a pantalla completa
            window.viewImageFullscreen = function(imageSrc, index) {
                const fullscreenOverlay = document.createElement('div');
                fullscreenOverlay.className = 'fixed inset-0 bg-black bg-opacity-95 z-[9999] flex items-center justify-center';
                fullscreenOverlay.style.cursor = 'zoom-out';
                
                fullscreenOverlay.innerHTML = `
                    <button 
                        onclick="this.closest('.fixed').remove()" 
                        class="absolute top-4 right-4 bg-red text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-red-dark transition-all z-10"
                    >
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div class="absolute top-4 left-4 bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-image mr-2"></i>Imagen ${index + 1}
                    </div>
                    <img 
                        src="${imageSrc}" 
                        alt="Imagen ${index + 1}" 
                        class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl"
                        style="cursor: default;"
                        onclick="event.stopPropagation()"
                    />
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-info-circle mr-2"></i>Haz clic fuera de la imagen para cerrar
                    </div>
                `;
                
                fullscreenOverlay.onclick = function(e) {
                    if (e.target === fullscreenOverlay) {
                        fullscreenOverlay.remove();
                    }
                };
                
                document.body.appendChild(fullscreenOverlay);
                
                // Prevenir scroll del body
                document.body.style.overflow = 'hidden';
                
                // Restaurar scroll al cerrar
                fullscreenOverlay.addEventListener('remove', () => {
                    document.body.style.overflow = '';
                });
            }

            // A√±adir imagen
            window.addDayImage = function() {
                const input = document.getElementById('funded-day-image-input');
                input.click();
            };

            // Eliminar imagen
            window.removeDayImage = function(dateKey, index) {
                const data = getFundedDayData(dateKey);
                data.images.splice(index, 1);
                saveFundedDayData(dateKey, data);
                renderDayImages(dateKey, data.images);
            };

            // Renderizar etiquetas
            function renderDayTags(dateKey, tags) {
                const container = document.getElementById('funded-day-tags');
                const commonTags = ['Retiro exitoso', 'Gasto necesario', 'Celebraci√≥n', 'An√°lisis', 'Objetivo cumplido'];
                
                container.innerHTML = tags.map(tag => `
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-primary text-background text-sm">
                        ${tag}
                        <button onclick="removeDayTag('${dateKey}', '${tag}')" class="ml-2 hover:text-red">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </span>
                `).join('') + commonTags.filter(t => !tags.includes(t)).map(tag => `
                    <button 
                        onclick="addDayTag('${dateKey}', '${tag}')"
                        class="px-3 py-1 rounded-full bg-surface-light hover:bg-surface text-sm border border-border hover:border-primary transition-all"
                    >
                        ${tag}
                    </button>
                `).join('');
            }

            // A√±adir etiqueta
            window.addDayTag = function(dateKey, tag) {
                const data = getFundedDayData(dateKey);
                if (!data.tags.includes(tag)) {
                    data.tags.push(tag);
                    saveFundedDayData(dateKey, data);
                    renderDayTags(dateKey, data.tags);
                }
            };

            // Eliminar etiqueta
            window.removeDayTag = function(dateKey, tag) {
                const data = getFundedDayData(dateKey);
                data.tags = data.tags.filter(t => t !== tag);
                saveFundedDayData(dateKey, data);
                renderDayTags(dateKey, data.tags);
            };

            // ===== EDITOR DE NOTAS AVANZADAS =====
            
            // Abrir editor de notas
            document.getElementById('edit-notes-btn').addEventListener('click', function() {
                const modal = document.getElementById('notes-editor-modal');
                const editor = document.getElementById('funded-day-notes-editor');
                const dateKey = window.currentFundedDayKey;
                
                if (!dateKey) return;
                
                // Cargar notas existentes
                const data = getFundedDayData(dateKey);
                editor.innerHTML = data.notes || '';
                
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                updateEditorCharCount();
            });

            // Cerrar editor
            function closeNotesEditor() {
                const modal = document.getElementById('notes-editor-modal');
                modal.style.display = 'none';
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // Cerrar al hacer clic fuera del modal
            document.getElementById('notes-editor-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotesEditor();
                }
            });

            document.getElementById('close-editor-btn').addEventListener('click', closeNotesEditor);
            document.getElementById('editor-cancel-btn').addEventListener('click', closeNotesEditor);

            // Actualizar contador de caracteres del editor
            function updateEditorCharCount() {
                const editor = document.getElementById('funded-day-notes-editor');
                const counter = document.getElementById('editor-char-count');
                const text = editor.innerText || editor.textContent || '';
                counter.textContent = `${text.length} caracteres`;
            }

            // Actualizar contador en tiempo real
            document.getElementById('funded-day-notes-editor').addEventListener('input', updateEditorCharCount);

            // Funciones de formato de texto
            window.formatText = function(command, value = null) {
                document.execCommand(command, false, value);
                document.getElementById('funded-day-notes-editor').focus();
            };

            window.insertLink = function() {
                const url = prompt('Ingresa la URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
            };

            // Guardar notas avanzadas
            document.getElementById('editor-save-btn').addEventListener('click', function() {
                const dateKey = window.currentFundedDayKey;
                if (!dateKey) return;

                const editor = document.getElementById('funded-day-notes-editor');
                const notes = editor.innerHTML;
                
                const data = getFundedDayData(dateKey);
                data.notes = notes;
                saveFundedDayData(dateKey, data);

                // Actualizar vista de solo lectura
                const notesDisplay = document.getElementById('notes-display');
                notesDisplay.innerHTML = notes || '<p class="text-text-secondary italic">No hay notas escritas a√∫n. Haz clic en "Editar Notas" para comenzar.</p>';

                // Feedback visual
                const btn = this;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Guardado!';
                btn.classList.add('bg-green');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green');
                    closeNotesEditor();
                }, 1500);
            });

            // Descargar nota como archivo
            document.getElementById('download-note-btn').addEventListener('click', function() {
                const editor = document.getElementById('funded-day-notes-editor');
                const content = editor.innerHTML;
                const dateKey = window.currentFundedDayKey;
                
                if (!content.trim()) {
                    alert('No hay contenido para descargar');
                    return;
                }
                
                const blob = new Blob([content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nota-${dateKey}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // ===== NOTA DE VOZ =====
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;

            document.getElementById('voice-note-btn').addEventListener('click', async function() {
                if (!isRecording) {
                    // Iniciar grabaci√≥n
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            // Insertar reproductor de audio en el editor
                            const editor = document.getElementById('funded-day-notes-editor');
                            const audioHTML = `<div style="margin: 10px 0; padding: 10px; background: rgba(57, 255, 20, 0.1); border-left: 3px solid #39ff14; border-radius: 4px;">
                                <p style="margin: 0 0 5px 0; font-weight: bold; color: #39ff14;">üé§ Nota de Voz</p>
                                <audio controls style="width: 100%; max-width: 400px;">
                                    <source src="${audioUrl}" type="audio/webm">
                                    Tu navegador no soporta audio.
                                </audio>
                            </div>`;
                            
                            editor.innerHTML += audioHTML;
                            updateEditorCharCount();

                            // Detener todas las pistas del stream
                            stream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorder.start();
                        isRecording = true;

                        // Actualizar bot√≥n
                        this.innerHTML = '<i class="fas fa-stop-circle text-red"></i><span class="ml-2">Detener Grabaci√≥n</span>';
                        this.classList.add('bg-red', 'text-white');

                    } catch (err) {
                        console.error('Error al acceder al micr√≥fono:', err);
                        alert('No se pudo acceder al micr√≥fono. Verifica los permisos del navegador.');
                    }
                } else {
                    // Detener grabaci√≥n
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        isRecording = false;

                        // Restaurar bot√≥n
                        this.innerHTML = '<i class="fas fa-microphone"></i><span class="ml-2">Nota de Voz</span>';
                        this.classList.remove('bg-red', 'text-white');
                    }
                }
            });

            // Event listeners para la vista de d√≠a
            document.getElementById('funded-day-back-btn').addEventListener('click', function() {
                document.getElementById('funded-day-fullscreen').style.display = 'none';
                document.getElementById('funded-calendar-card').style.display = 'block';
            });

            document.getElementById('add-day-image-btn').addEventListener('click', function() {
                const dateKey = window.currentFundedDayKey;
                if (!dateKey) return;
                
                const data = getFundedDayData(dateKey);
                if (data.images.length >= 3) {
                    alert('M√°ximo 3 im√°genes por d√≠a');
                    return;
                }
                
                window.addDayImage();
            });

            document.getElementById('funded-day-image-input').addEventListener('change', function(e) {
                const dateKey = window.currentFundedDayKey;
                if (!dateKey) return;

                const file = e.target.files[0];
                if (!file) return;

                // Validar tama√±o (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen debe ser menor a 5MB');
                    return;
                }

                // Leer imagen como base64
                const reader = new FileReader();
                reader.onload = function(event) {
                    const data = getFundedDayData(dateKey);
                    if (data.images.length < 3) {
                        data.images.push(event.target.result);
                        saveFundedDayData(dateKey, data);
                        renderDayImages(dateKey, data.images);
                    }
                };
                reader.readAsDataURL(file);

                // Reset input
                e.target.value = '';
            });

            document.getElementById('new-tag-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const dateKey = window.currentFundedDayKey;
                    if (!dateKey) return;

                    const tag = this.value.trim();
                    if (tag) {
                        window.addDayTag(dateKey, tag);
                        this.value = '';
                    }
                }
            });

            // Eventos de navegaci√≥n del calendario
            if (fundedElements.calendarPrev) {
                fundedElements.calendarPrev.onclick = () => {
                    currentFundedCalendarDate.setMonth(currentFundedCalendarDate.getMonth() - 1);
                    renderFundedCalendar();
                };
            }

            if (fundedElements.calendarNext) {
                fundedElements.calendarNext.onclick = () => {
                    currentFundedCalendarDate.setMonth(currentFundedCalendarDate.getMonth() + 1);
                    renderFundedCalendar();
                };
            }

            // Inicializaci√≥n
            refreshFunded();
            renderFundedCalendar();
            console.log('‚úÖ Funded Accounts inicializado completamente');
        }

        // =============================================
        // AUDICI√ìN - SECCI√ìN DE PERFIL P√öBLICO
        // =============================================
        
        let audicionCharts = {};
        
        // Inicializar canvas de gauges
        function initGaugeCanvases() {
            const gaugeIds = [
                'gauge-pl-total',
                'gauge-win-rate',
                'gauge-profit-factor',
                'gauge-day-win'
            ];
            
            gaugeIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const dpr = window.devicePixelRatio || 1;
                    canvas.width = 140 * dpr;
                    canvas.height = 140 * dpr;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                }
            });
        }
        
        async function initAudicion() {
            console.log('‚≠ê Inicializando Audici√≥n...');
            
            // Inicializar canvas de gauges
            initGaugeCanvases();
            
            // Verificar si es vista p√∫blica
            const urlParams = new URLSearchParams(window.location.search);
            const audicionParam = urlParams.get('audicion');
            
            if (audicionParam) {
                // Cargar vista p√∫blica desde Supabase
                await loadPublicAudicion(audicionParam);
                return;
            }
            
            // Poblar selector de cuentas
            const accountSelect = document.getElementById('audicion-account-select');
            if (accountSelect) {
                accountSelect.innerHTML = '<option value="all">Todas las cuentas</option>';
                DB.accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    accountSelect.appendChild(option);
                });
                
                accountSelect.addEventListener('change', function() {
                    refreshAudicion();
                    // Tambi√©n actualizar Social Media si est√° visible
                    if (typeof loadPublicTraders === 'function') {
                        loadPublicTraders();
                    }
                });
            }
            
            // Cargar informaci√≥n del usuario
            loadAudicionUserInfo();
            
            // Configurar link p√∫blico
            setupAudicionPublicLink();
            
            // Configurar calendario de filtros
            setupAudicionDateFilter();
            
            // Refresh inicial
            refreshAudicion();
            
            console.log('‚úÖ Audici√≥n inicializada');
        }
        
        // Variables globales para el calendario de Audici√≥n
        let audicionCurrentMonth = new Date().getMonth();
        let audicionCurrentYear = new Date().getFullYear();
        let audicionSelectedStartDate = null;
        let audicionSelectedEndDate = null;
        
        function setupAudicionDateFilter() {
            const filterBtn = document.getElementById('audicion-filter-dates-btn');
            const filterBtnHeader = document.getElementById('audicion-filter-dates-btn-header');
            const modal = document.getElementById('audicion-date-range-modal');
            const closeBtn = document.getElementById('audicion-date-range-close-btn');
            const applyBtn = document.getElementById('audicion-date-range-apply-btn');
            const clearBtn = document.getElementById('audicion-date-range-clear-btn');
            const prevMonth = document.getElementById('audicion-calendar-prev-month');
            const nextMonth = document.getElementById('audicion-calendar-next-month');
            
            if (!modal) return;
            
            // Funci√≥n para abrir modal
            const openModal = () => {
                modal.classList.remove('hidden');
                renderAudicionCalendar();
            };
            
            // Abrir modal desde ambos botones
            filterBtn?.addEventListener('click', openModal);
            filterBtnHeader?.addEventListener('click', openModal);
            
            // Cerrar modal
            closeBtn?.addEventListener('click', () => modal.classList.add('hidden'));
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            });
            
            // Navegar calendario
            prevMonth?.addEventListener('click', () => {
                audicionCurrentMonth--;
                if (audicionCurrentMonth < 0) {
                    audicionCurrentMonth = 11;
                    audicionCurrentYear--;
                }
                renderAudicionCalendar();
            });
            
            nextMonth?.addEventListener('click', () => {
                audicionCurrentMonth++;
                if (audicionCurrentMonth > 11) {
                    audicionCurrentMonth = 0;
                    audicionCurrentYear++;
                }
                renderAudicionCalendar();
            });
            
            // Rangos r√°pidos
            document.querySelectorAll('.audicion-date-range-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    const range = btn.dataset.range;
                    const today = new Date();
                    let start, end;
                    
                    switch(range) {
                        case 'today':
                            start = end = today;
                            break;
                        case 'this_week':
                            start = new Date(today.setDate(today.getDate() - today.getDay()));
                            end = new Date();
                            break;
                        case 'this_month':
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                            end = new Date();
                            break;
                        case 'last_7_days':
                            start = new Date(today.setDate(today.getDate() - 7));
                            end = new Date();
                            break;
                        case 'last_30_days':
                            start = new Date(today.setDate(today.getDate() - 30));
                            end = new Date();
                            break;
                        case 'this_year':
                            start = new Date(today.getFullYear(), 0, 1);
                            end = new Date();
                            break;
                    }
                    
                    audicionSelectedStartDate = start;
                    audicionSelectedEndDate = end;
                    updateAudicionDateInputs();
                    renderAudicionCalendar();
                });
            });
            
            // Aplicar filtro
            applyBtn?.addEventListener('click', () => {
                modal.classList.add('hidden');
                refreshAudicionWithFilter();
            });
            
            // Limpiar filtro
            clearBtn?.addEventListener('click', () => {
                audicionSelectedStartDate = null;
                audicionSelectedEndDate = null;
                updateAudicionDateInputs();
                renderAudicionCalendar();
            });
        }
        
        function renderAudicionCalendar() {
            const monthYear = document.getElementById('audicion-calendar-month-year');
            const daysContainer = document.getElementById('audicion-calendar-days');
            
            if (!monthYear || !daysContainer) return;
            
            const monthNames = ['Dic 2025', 'Ene 2026', 'Feb 2026', 'Mar 2026', 'Abr 2026', 'May 2026', 
                               'Jun 2026', 'Jul 2026', 'Ago 2026', 'Sep 2026', 'Oct 2026', 'Nov 2026'];
            monthYear.textContent = `${monthNames[audicionCurrentMonth]} ${audicionCurrentYear}`;
            
            const firstDay = new Date(audicionCurrentYear, audicionCurrentMonth, 1).getDay();
            const daysInMonth = new Date(audicionCurrentYear, audicionCurrentMonth + 1, 0).getDate();
            
            daysContainer.innerHTML = '';
            
            // D√≠as vac√≠os del inicio
            for (let i = 0; i < firstDay; i++) {
                daysContainer.innerHTML += '<div></div>';
            }
            
            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(audicionCurrentYear, audicionCurrentMonth, day);
                const isSelected = (audicionSelectedStartDate && date.toDateString() === audicionSelectedStartDate.toDateString()) ||
                                 (audicionSelectedEndDate && date.toDateString() === audicionSelectedEndDate.toDateString());
                const isInRange = audicionSelectedStartDate && audicionSelectedEndDate &&
                                date >= audicionSelectedStartDate && date <= audicionSelectedEndDate;
                
                const dayBtn = document.createElement('button');
                dayBtn.textContent = day;
                dayBtn.className = `p-2 rounded text-sm ${isSelected ? 'bg-primary text-background' : isInRange ? 'bg-primary bg-opacity-20 text-primary' : 'hover:bg-surface-light'}`;
                
                dayBtn.addEventListener('click', () => {
                    if (!audicionSelectedStartDate || (audicionSelectedStartDate && audicionSelectedEndDate)) {
                        audicionSelectedStartDate = date;
                        audicionSelectedEndDate = null;
                    } else {
                        if (date < audicionSelectedStartDate) {
                            audicionSelectedEndDate = audicionSelectedStartDate;
                            audicionSelectedStartDate = date;
                        } else {
                            audicionSelectedEndDate = date;
                        }
                    }
                    updateAudicionDateInputs();
                    renderAudicionCalendar();
                });
                
                daysContainer.appendChild(dayBtn);
            }
        }
        
        function updateAudicionDateInputs() {
            const startInput = document.getElementById('audicion-date-range-start-input');
            const endInput = document.getElementById('audicion-date-range-end-input');
            
            if (startInput) startInput.value = audicionSelectedStartDate ? formatDate(audicionSelectedStartDate) : '';
            if (endInput) endInput.value = audicionSelectedEndDate ? formatDate(audicionSelectedEndDate) : '';
        }
        
        function refreshAudicionWithFilter() {
            // Aqu√≠ aplicar√≠as el filtro a los datos
            // Por ahora solo refresh normal
            refreshAudicion();
        }
        
        async function loadPublicAudicion(audicionId) {
            try {
                console.log('üì• Cargando audici√≥n p√∫blica:', audicionId);
                
                // Mostrar la secci√≥n de Audici√≥n
                const audicionSection = document.getElementById('audicion-section');
                if (audicionSection) {
                    audicionSection.classList.add('active');
                    audicionSection.style.display = 'block';
                }
                
                // Ocultar todas las dem√°s secciones
                document.querySelectorAll('.section-content:not(#audicion-section)').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Si audicionId contiene 'data=' (formato antiguo), usar decodificaci√≥n base64
                let data;
                if (audicionId && audicionId.includes('public&data=')) {
                    console.log('üì¶ Formato antiguo detectado - usando base64');
                    const encodedData = audicionId.split('data=')[1];
                    const decodedData = decodeURIComponent(atob(encodedData));
                    data = JSON.parse(decodedData);
                } else {
                    console.log('üîç Cargando desde Supabase con ID:', audicionId);
                    
                    // Verificar que supabase est√© disponible
                    if (!window.supabase) {
                        console.error('‚ùå Supabase no est√° disponible');
                        alert('Error: Sistema de base de datos no disponible. Recarga la p√°gina.');
                        return;
                    }
                    
                    // Cargar desde Supabase usando el ID
                    const { data: audicionData, error } = await supabase
                        .from('public_audiciones')
                        .select('data')
                        .eq('id', audicionId)
                        .single();
                    
                    if (error) {
                        console.error('‚ùå Error cargando audici√≥n:', error);
                        alert(`No se encontr√≥ la audici√≥n solicitada.\n\nError: ${error.message}`);
                        // Redirigir a la p√°gina principal
                        window.location.href = window.location.origin;
                        return;
                    }
                    
                    if (!audicionData || !audicionData.data) {
                        console.error('‚ùå No se encontraron datos');
                        alert('No se encontr√≥ la audici√≥n solicitada.');
                        window.location.href = window.location.origin;
                        return;
                    }
                    
                    data = audicionData.data;
                    console.log('‚úÖ Datos cargados desde Supabase:', data);
                }
                
                console.log('üì• Cargando datos p√∫blicos de Audici√≥n...', data);
                
                // Cargar informaci√≥n del usuario
                const userAvatar = document.getElementById('audicion-user-avatar');
                if (userAvatar) {
                    if (data.profileImage) {
                        userAvatar.innerHTML = `<img src="${data.profileImage}" alt="Profile" class="w-full h-full object-cover">`;
                    } else {
                        userAvatar.textContent = data.username.charAt(0).toUpperCase();
                    }
                }
                
                const username = document.getElementById('audicion-username');
                if (username) username.textContent = data.username;
                
                const userEmail = document.getElementById('audicion-user-email');
                if (userEmail) userEmail.textContent = data.email;
                
                const memberSince = document.getElementById('audicion-member-since');
                if (memberSince) memberSince.textContent = data.memberSince;
                
                const tradingSince = document.getElementById('audicion-trading-since');
                if (tradingSince) tradingSince.textContent = data.tradingSince;
                
                // Ocultar secci√≥n de link p√∫blico
                const linkSection = document.getElementById('audicion-public-link-section');
                if (linkSection) linkSection.style.display = 'none';
                
                // Ocultar selector de cuenta
                const accountSelector = document.getElementById('audicion-account-select');
                if (accountSelector && accountSelector.parentElement) {
                    accountSelector.parentElement.style.display = 'none';
                }
                
                // Actualizar m√©tricas
                updateAudicionMetricsFromData(data);
                
                // Actualizar gr√°fico semanal
                if (data.latestTrades) {
                    updateAudicionWeeklyChartFromData(data.latestTrades);
                }
                
                // Actualizar curvas
                updateAudicionCurvesFromData(data);
                
                // Actualizar trades
                updateAudicionTradesFromData(data);
                
                console.log('‚úÖ Vista p√∫blica cargada correctamente');
                
            } catch (e) {
                console.error('‚ùå Error cargando datos p√∫blicos:', e);
                alert(`Error al cargar la audici√≥n: ${e.message}\n\nSer√°s redirigido a la p√°gina principal.`);
                window.location.href = window.location.origin;
            }
        }
        
        function updateAudicionMetricsFromData(data) {
            const plValue = parseFloat(data.plTotal) || 0;
            const plTotal = document.getElementById('audicion-pl-total');
            if (plTotal) {
                plTotal.textContent = `$${plValue.toFixed(2)}`;
                plTotal.style.color = plValue >= 0 ? '#39ff14' : '#ff4136';
            }
            
            const totalWins = document.getElementById('audicion-total-wins');
            if (totalWins) totalWins.textContent = data.winners;
            
            const totalLosses = document.getElementById('audicion-total-losses');
            if (totalLosses) totalLosses.textContent = data.losers;
            
            const winRate = document.getElementById('audicion-win-rate');
            if (winRate) winRate.textContent = `${data.winRate}%`;
            
            const winners = document.getElementById('audicion-winners');
            if (winners) winners.textContent = data.winners;
            
            const losers = document.getElementById('audicion-losers');
            if (losers) losers.textContent = data.losers;
            
            const breakeven = document.getElementById('audicion-breakeven');
            if (breakeven) breakeven.textContent = data.breakeven;
            
            const pf = parseFloat(data.profitFactor) || 0;
            const profitFactor = document.getElementById('audicion-profit-factor');
            if (profitFactor) profitFactor.textContent = pf === Infinity ? '‚àû' : pf.toFixed(2);
            
            const pfRatio = document.getElementById('audicion-pf-ratio');
            if (pfRatio) pfRatio.textContent = pf >= 1 ? `${pf.toFixed(1)}:1` : '0:1';
            
            const dayWinRate = document.getElementById('audicion-day-win-rate');
            if (dayWinRate) dayWinRate.textContent = `${data.dayWinRate}%`;
            
            const winningDays = document.getElementById('audicion-winning-days');
            if (winningDays) winningDays.textContent = data.winningDays;
            
            const losingDays = document.getElementById('audicion-losing-days');
            if (losingDays) losingDays.textContent = data.losingDays;
            
            const bestTrade = document.getElementById('audicion-best-trade');
            if (bestTrade) {
                bestTrade.textContent = `$${(data.bestTrade || 0).toFixed(2)}`;
                bestTrade.style.color = '#39ff14';
            }
            
            const worstTrade = document.getElementById('audicion-worst-trade');
            if (worstTrade) {
                worstTrade.textContent = `$${Math.abs(data.worstTrade || 0).toFixed(2)}`;
                worstTrade.style.color = '#ff4136';
            }
            
            const avgValue = parseFloat(data.avgTrade) || 0;
            const avgTrade = document.getElementById('audicion-avg-trade');
            if (avgTrade) {
                avgTrade.textContent = `$${avgValue.toFixed(2)}`;
                avgTrade.style.color = avgValue >= 0 ? '#10B981' : '#DC2626';
            }
        }
        
        // Funci√≥n para calcular P&L semanal (√∫ltimos 7 d√≠as)
        function calculateWeeklyPL(trades) {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            return trades.reduce((total, trade) => {
                try {
                    const tradeDate = new Date(trade.date);
                    if (tradeDate >= oneWeekAgo) {
                        return total + (parseFloat(trade.pl) || 0);
                    }
                } catch (e) {
                    console.error('Error parsing trade date:', e);
                }
                return total;
            }, 0);
        }
        
        // Funci√≥n para calcular P&L semanal desde operaciones DB
        function calculateWeeklyPLFromOps(operations) {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            return operations.reduce((total, op) => {
                try {
                    const opDate = new Date(op.date);
                    if (opDate >= oneWeekAgo) {
                        return total + (parseFloat(op.pl) || 0);
                    }
                } catch (e) {
                    console.error('Error parsing operation date:', e);
                }
                return total;
            }, 0);
        }
        
        function updateAudicionWeeklyChartFromData(trades) {
            const ctx = document.getElementById('audicion-weekly-chart');
            if (!ctx) return;
            
            // Agrupar trades por fecha y sumar P&L
            const now = new Date();
            const weeklyData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Calcular P&L del d√≠a
                const dayPL = trades
                    .filter(trade => trade.date === dateStr)
                    .reduce((sum, trade) => sum + (parseFloat(trade.pl) || 0), 0);
                
                weeklyData.push({
                    date: dateStr,
                    label: date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    pl: dayPL
                });
            }
            
            // Destruir gr√°fico anterior si existe
            if (audicionCharts.weekly) {
                audicionCharts.weekly.destroy();
            }
            
            // Crear gr√°fico de barras
            audicionCharts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map(d => d.label),
                    datasets: [{
                        label: 'P&L Diario',
                        data: weeklyData.map(d => d.pl),
                        backgroundColor: weeklyData.map(d => d.pl >= 0 ? '#39ff14' : '#ff4136'),
                        borderColor: weeklyData.map(d => d.pl >= 0 ? '#39ff14' : '#ff4136'),
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 35,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#39ff14',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `P&L: $${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 11
                                },
                                padding: 8,
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 5
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 5,
                            left: 5
                        }
                    }
                }
            });
        }
        
        function updateAudicionCurvesFromData(data) {
            // Curva de profit
            const profitCtx = document.getElementById('audicion-profit-curve');
            if (profitCtx && data.profitCurve) {
                if (audicionCharts.profit) audicionCharts.profit.destroy();
                
                audicionCharts.profit = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: data.profitCurve.map((_, i) => `T${i + 1}`),
                        datasets: [{
                            label: 'Profit Acumulado',
                            data: data.profitCurve,
                            borderColor: '#39ff14',
                            backgroundColor: 'rgba(57, 255, 20, 0.2)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#39ff14',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: {
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            }
                        }
                    }
                });
            }
            
            // Curva de drawdown
            const drawdownCtx = document.getElementById('audicion-drawdown-curve');
            if (drawdownCtx && data.drawdownCurve) {
                if (audicionCharts.drawdown) audicionCharts.drawdown.destroy();
                
                audicionCharts.drawdown = new Chart(drawdownCtx, {
                    type: 'line',
                    data: {
                        labels: data.drawdownCurve.map((_, i) => `T${i + 1}`),
                        datasets: [{
                            label: 'Drawdown',
                            data: data.drawdownCurve,
                            borderColor: '#ff4136',
                            backgroundColor: 'rgba(255, 65, 54, 0.2)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#ff4136',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: {
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            }
                        }
                    }
                });
            }
        }
        
        function updateAudicionTradesFromData(data) {
            const tbody = document.querySelector('#audicion-latest-trades tbody');
            if (!tbody || !data.latestTrades) return;
            
            tbody.innerHTML = '';
            
            data.latestTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b border-border hover:bg-surface-light transition-colors';
                
                const pl = parseFloat(trade.pl) || 0;
                const roi = parseFloat(trade.roi) || 0;
                
                // Determinar direcci√≥n basado en trade.type (long/short/buy/sell)
                let direction = 'LONG';
                const typeStr = (trade.type || '').toLowerCase();
                if (typeStr === 'short' || typeStr === 'sell') {
                    direction = 'SHORT';
                } else if (typeStr === 'long' || typeStr === 'buy') {
                    direction = 'LONG';
                }
                
                // Tipo de operaci√≥n
                const tradeType = trade.category || trade.session || 'Scalping';
                
                const resultado = pl > 0 ? 'WIN' : (pl < 0 ? 'LOSS' : 'BE');
                
                row.innerHTML = `
                    <td class="py-3 px-2 text-left text-xs text-text-secondary">${trade.date}</td>
                    <td class="py-3 px-2 text-left">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" 
                                 style="background: linear-gradient(135deg, #39ff14, #00ff88);">
                                ${(trade.symbol || '').charAt(0)}
                            </div>
                            <span class="font-medium">${trade.symbol || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-2">
                        <div class="flex justify-center">
                            <span class="px-2 py-1 rounded text-xs font-medium" 
                                  style="background-color: ${direction === 'LONG' ? 'rgba(57, 255, 20, 0.2)' : 'rgba(255, 65, 54, 0.2)'}; color: ${direction === 'LONG' ? '#39ff14' : '#ff4136'};">
                                ${direction}
                            </span>
                        </div>
                    </td>
                    <td class="py-3 px-2">
                        <div class="flex justify-center">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-surface border border-border">
                                ${tradeType}
                            </span>
                        </div>
                    </td>
                    <td class="py-3 px-2">
                        <div class="flex justify-center">
                            <span class="px-2 py-1 rounded text-xs font-medium" 
                                  style="background-color: ${resultado === 'WIN' ? 'rgba(57, 255, 20, 0.2)' : resultado === 'LOSS' ? 'rgba(255, 65, 54, 0.2)' : 'rgba(128, 128, 128, 0.2)'}; color: ${resultado === 'WIN' ? '#39ff14' : resultado === 'LOSS' ? '#ff4136' : '#888'};">
                                ${resultado}
                            </span>
                        </div>
                    </td>
                    <td class="py-3 px-2 text-right font-semibold" style="color: ${pl >= 0 ? '#39ff14' : '#ff4136'};">
                        ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}
                    </td>
                    <td class="py-3 px-2 text-right font-semibold" style="color: ${roi >= 0 ? '#39ff14' : '#ff4136'};">
                        ${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        async function saveAudicionToSupabase(audicionData) {
            if (!currentUser) {
                console.error('‚ùå No hay usuario autenticado');
                return null;
            }
            
            try {
                // Generar ID √∫nico para la audici√≥n
                const audicionId = `${currentUser.id.substring(0, 8)}_${Date.now()}`;
                
                console.log('üíæ Guardando audici√≥n en Supabase...', audicionId);
                
                // Guardar en tabla public_audiciones
                const { data, error } = await supabase
                    .from('public_audiciones')
                    .upsert({
                        id: audicionId,
                        user_id: currentUser.id,
                        data: audicionData,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    })
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Error guardando audici√≥n:', error);
                    return null;
                }
                
                console.log('‚úÖ Audici√≥n guardada:', data);
                return audicionId;
                
            } catch (error) {
                console.error('‚ùå Error en saveAudicionToSupabase:', error);
                return null;
            }
        }
        
        function setupAudicionPublicLink() {
            const username = localStorage.getItem('username') || 'usuario';
            const linkInput = document.getElementById('audicion-public-link');
            
            // Bot√≥n de compartir
            const shareBtn = document.getElementById('share-audicion-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', async () => {
                    showMessage('üîÑ Generando link...', 'info');
                    
                    // Generar datos para compartir
                    const audicionData = generateAudicionShareData();
                    
                    // Guardar en Supabase y obtener ID
                    const audicionId = await saveAudicionToSupabase(audicionData);
                    
                    if (!audicionId) {
                        showMessage('‚ùå Error al generar link', 'error');
                        return;
                    }
                    
                    // Construir URL corta
                    const publicLink = `${window.location.origin}/?audicion=${audicionId}`;
                    
                    if (linkInput) linkInput.value = publicLink;
                    
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `Audici√≥n de Trading - ${username}`,
                                text: `Mira mi perfil de trading en Trader Survivor`,
                                url: publicLink
                            });
                        } catch (err) {
                            console.log('Error al compartir:', err);
                            copyToClipboard(publicLink);
                            showMessage('‚úÖ Link copiado al portapapeles', 'success');
                        }
                    } else {
                        copyToClipboard(publicLink);
                        showMessage('‚úÖ Link copiado al portapapeles', 'success');
                    }
                });
            }
            
            // Bot√≥n de copiar
            const copyBtn = document.getElementById('copy-audicion-link');
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    showMessage('üîÑ Generando link...', 'info');
                    
                    const audicionData = generateAudicionShareData();
                    const audicionId = await saveAudicionToSupabase(audicionData);
                    
                    if (!audicionId) {
                        showMessage('‚ùå Error al generar link', 'error');
                        return;
                    }
                    
                    const publicLink = `${window.location.origin}/?audicion=${audicionId}`;
                    
                    if (linkInput) linkInput.value = publicLink;
                    copyToClipboard(publicLink);
                });
            }
        }
        
        function generateAudicionShareData() {
            const username = localStorage.getItem('username') || 'Usuario';
            const profileImage = localStorage.getItem('profile-image') || '';
            
            // Calcular m√©tricas actuales
            const accountSelect = document.getElementById('audicion-account-select');
            const selectedAccount = accountSelect ? accountSelect.value : 'all';
            
            let filteredOps = [...DB.operations];
            if (selectedAccount !== 'all') {
                filteredOps = filteredOps.filter(op => op.accountId === selectedAccount);
            }
            
            console.log(`üìä [generateAudicionShareData] Generando datos de audici√≥n para ${filteredOps.length} operaciones`);
            console.log(`üìä [generateAudicionShareData] Cuenta seleccionada: ${selectedAccount}`);
            console.log(`üìä [generateAudicionShareData] Muestra de operaciones:`, filteredOps.slice(0, 3).map(op => ({
                id: op.id,
                pl: op.pl,
                date: op.date,
                instrument: op.instrument
            })));
            
            const metrics = calculateMetrics(filteredOps, selectedAccount);
            const dayStats = calculateDayWinStats(filteredOps);
            
            console.log(`üìä [generateAudicionShareData] M√©tricas calculadas:`, {
                totalWin: metrics.totalWin,
                totalLoss: metrics.totalLoss,
                totalFees: metrics.totalFees,
                winningTrades: metrics.winningTrades,
                losingTrades: metrics.losingTrades,
                totalTrades: metrics.totalTrades
            });
            
            let bestTrade = 0;
            let worstTrade = 0;
            filteredOps.forEach(op => {
                const pl = parseFloat(op.pl) || 0;
                if (pl > bestTrade) bestTrade = pl;
                if (pl < worstTrade) worstTrade = pl;
            });
            
            // √öltimos 10 trades (limitado para no hacer URL demasiado largo)
            const latestTrades = [...filteredOps]
                .sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.exitTime || '00:00:00'}`);
                    const dateB = new Date(`${b.date} ${b.exitTime || '00:00:00'}`);
                    return dateB - dateA;
                })
                .slice(0, 10)  // Limitado a 10 trades
                .map(op => {
                    const pl = parseFloat(op.pl) || 0;
                    const size = parseFloat(op.volume) || parseFloat(op.size) || 0;
                    const roi = size > 0 ? ((pl / size) * 100) : 0;
                    
                    return {
                        date: op.date,
                        symbol: op.instrument || op.symbol || 'N/A',
                        type: op.type || 'long',
                        side: op.type || 'buy',
                        category: op.session || 'SCALPING',
                        pl: pl,
                        roi: roi
                    };
                });
            
            // Datos para curvas (limitado a √∫ltimos 30 puntos para reducir tama√±o de URL)
            const sorted = [...filteredOps].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.exitTime || '00:00:00'}`);
                const dateB = new Date(`${b.date} ${b.exitTime || '00:00:00'}`);
                return dateA - dateB;
            }).slice(-30);  // Solo √∫ltimos 30 puntos
            
            let cumulativePL = 0;
            let peak = 0;
            const profitData = [];
            const drawdownData = [];
            const labels = [];
            
            sorted.forEach(op => {
                const pl = parseFloat(op.pl) || 0;
                cumulativePL += pl;
                if (cumulativePL > peak) peak = cumulativePL;
                const drawdown = peak - cumulativePL;
                
                profitData.push(parseFloat(cumulativePL.toFixed(2)));
                drawdownData.push(parseFloat((-drawdown).toFixed(2)));
                labels.push(new Date(op.date).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
            });
            
            const shareData = {
                username: username,
                email: currentUser ? currentUser.email : 'email@example.com',
                profileImage: profileImage,
                memberSince: localStorage.getItem('member-since') || 'Dic 2024',
                tradingSince: filteredOps.length > 0 
                    ? new Date(sorted[0].date).toLocaleDateString('es-ES', { month: 'short', year: 'numeric' })
                    : 'Ene 2023',
                plTotal: (metrics.totalWin + metrics.totalLoss) - metrics.totalFees,
                winRate: metrics.totalTrades > 0 ? ((metrics.winningTrades / (metrics.winningTrades + metrics.losingTrades)) * 100).toFixed(1) : 0,
                profitFactor: metrics.profitFactor,
                dayWinRate: dayStats.totalDays > 0 ? ((dayStats.winningDays / dayStats.totalDays) * 100).toFixed(1) : 0,
                winners: metrics.winningTrades,
                losers: metrics.losingTrades,
                breakeven: metrics.breakevenTrades,
                winningDays: dayStats.winningDays,
                losingDays: dayStats.losingDays,
                bestTrade: bestTrade,
                worstTrade: worstTrade,
                avgTrade: metrics.totalTrades > 0 ? ((metrics.totalWin + metrics.totalLoss) / metrics.totalTrades).toFixed(2) : 0,
                latestTrades: latestTrades,
                profitCurve: {
                    labels: labels,
                    data: profitData
                },
                drawdownCurve: {
                    labels: labels,
                    data: drawdownData
                }
            };
            
            console.log(`üì§ [generateAudicionShareData] Datos finales para compartir:`, {
                plTotal: shareData.plTotal,
                winners: shareData.winners,
                losers: shareData.losers,
                totalTrades: metrics.totalTrades,
                latestTradesCount: shareData.latestTrades.length,
                firstTradeSample: shareData.latestTrades[0]
            });
            
            return shareData;
        }
        
        function copyToClipboard(text) {
            const linkInput = document.getElementById('audicion-public-link');
            if (linkInput) {
                linkInput.value = text;
                linkInput.select();
                document.execCommand('copy');
                
                // Feedback visual
                const copyBtn = document.getElementById('copy-audicion-link');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                copyBtn.classList.add('btn-primary');
                copyBtn.classList.remove('btn-outline');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('btn-primary');
                    copyBtn.classList.add('btn-outline');
                }, 2000);
                
                showMessage('Link copiado al portapapeles', 'success');
            }
        }
        
        function loadAudicionUserInfo() {
            // Cargar foto de perfil
            const profileImage = localStorage.getItem('profile-image');
            const audicionAvatar = document.getElementById('audicion-user-avatar');
            
            if (profileImage && audicionAvatar) {
                audicionAvatar.innerHTML = `<img src="${profileImage}" alt="Profile" class="w-full h-full object-cover">`;
            } else if (currentUser && audicionAvatar) {
                audicionAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
            }
            
            // Cargar nombre de usuario
            const username = localStorage.getItem('username') || 'Usuario';
            const usernameEl = document.getElementById('audicion-username');
            if (usernameEl) usernameEl.textContent = username;
            
            // Cargar email
            if (currentUser) {
                const emailEl = document.getElementById('audicion-user-email');
                if (emailEl) emailEl.textContent = currentUser.email;
            }
            
            // Fecha de miembro (desde cuando se cre√≥ la cuenta)
            const memberSince = localStorage.getItem('member-since') || 'Dic 2024';
            const memberSinceEl = document.getElementById('audicion-member-since');
            if (memberSinceEl) memberSinceEl.textContent = memberSince;
            
            // Fecha de inicio de trading (usar fecha del primer trade o configuraci√≥n)
            const firstTrade = DB.operations.length > 0 
                ? DB.operations.sort((a, b) => new Date(a.date) - new Date(b.date))[0]
                : null;
            
            let tradingSince = 'Ene 2023';
            if (firstTrade) {
                const date = new Date(firstTrade.date);
                tradingSince = date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            }
            
            const tradingSinceEl = document.getElementById('audicion-trading-since');
            if (tradingSinceEl) tradingSinceEl.textContent = tradingSince;
        }
        
        function refreshAudicion() {
            console.log('üîÑ Refrescando Audici√≥n...');
            
            const accountSelect = document.getElementById('audicion-account-select');
            const selectedAccount = accountSelect ? accountSelect.value : 'all';
            
            // Filtrar operaciones
            let filteredOps = [...DB.operations];
            if (selectedAccount !== 'all') {
                filteredOps = filteredOps.filter(op => op.accountId === selectedAccount);
            }
            
            // Calcular m√©tricas de trades
            const metrics = calculateMetrics(filteredOps, selectedAccount);
            
            // Calcular m√©tricas de d√≠as
            const dayStats = calculateDayWinStats(filteredOps);
            
            // Calcular mejor y peor trade
            let bestTrade = 0;
            let worstTrade = 0;
            filteredOps.forEach(op => {
                const pl = parseFloat(op.pl) || 0;
                if (pl > bestTrade) bestTrade = pl;
                if (pl < worstTrade) worstTrade = pl;
            });
            
            // Combinar m√©tricas
            const fullMetrics = {
                ...metrics,
                ...dayStats,
                netPL: (metrics.totalWin + metrics.totalLoss) - metrics.totalFees,
                winners: metrics.winningTrades,
                losers: metrics.losingTrades,
                breakeven: metrics.breakevenTrades,
                bestTrade: bestTrade,
                worstTrade: worstTrade,
                allOperations: filteredOps // Pasar las operaciones para calcular P&L semanal
            };
            
            // Actualizar m√©tricas principales
            updateAudicionMetrics(fullMetrics);
            
            // Actualizar gr√°ficas circulares
            updateAudicionCharts(fullMetrics);
            
            // Actualizar gr√°fico semanal
            updateAudicionWeeklyChart(filteredOps);
            
            // Actualizar curvas
            updateAudicionCurves(filteredOps);
            
            // Actualizar √∫ltimos trades
            updateAudicionLatestTrades(filteredOps);
        }
        
        function updateAudicionMetrics(metrics) {
            // P&L Total
            const plTotal = document.getElementById('audicion-pl-total');
            if (plTotal) {
                const plValue = metrics.netPL || 0;
                plTotal.textContent = `$${plValue.toFixed(2)}`;
                plTotal.style.color = plValue >= 0 ? '#39ff14' : '#ff4136';
            }
            
            // Total Wins y Losses
            const totalWins = document.getElementById('audicion-total-wins');
            const totalLosses = document.getElementById('audicion-total-losses');
            if (totalWins) totalWins.textContent = metrics.winners || 0;
            if (totalLosses) totalLosses.textContent = metrics.losers || 0;
            
            // Win Rate
            const winRate = document.getElementById('audicion-win-rate');
            if (winRate) {
                const relevantTrades = (metrics.winners || 0) + (metrics.losers || 0);
                const winPercentage = relevantTrades > 0 ? ((metrics.winners / relevantTrades) * 100).toFixed(1) : 0;
                winRate.textContent = `${winPercentage}%`;
            }
            
            // Win/Loss/Breakeven counts
            const winnersEl = document.getElementById('audicion-winners');
            const losersEl = document.getElementById('audicion-losers');
            const breakevenEl = document.getElementById('audicion-breakeven');
            if (winnersEl) winnersEl.textContent = metrics.winners || 0;
            if (losersEl) losersEl.textContent = metrics.losers || 0;
            if (breakevenEl) breakevenEl.textContent = metrics.breakeven || 0;
            
            // Profit Factor
            const pfEl = document.getElementById('audicion-profit-factor');
            const pfRatio = document.getElementById('audicion-pf-ratio');
            if (pfEl) {
                const pf = metrics.profitFactor || 0;
                pfEl.textContent = pf === Infinity ? '‚àû' : pf.toFixed(2);
            }
            if (pfRatio) {
                const ratio = metrics.profitFactor >= 1 ? `${metrics.profitFactor.toFixed(1)}:1` : '0:1';
                pfRatio.textContent = ratio;
            }
            
            // Day Win Rate
            const dayWinRate = document.getElementById('audicion-day-win-rate');
            if (dayWinRate) {
                const totalDays = (metrics.winningDays || 0) + (metrics.losingDays || 0);
                const dayPercentage = totalDays > 0 ? ((metrics.winningDays / totalDays) * 100).toFixed(1) : 0;
                dayWinRate.textContent = `${dayPercentage}%`;
            }
            
            const winningDaysEl = document.getElementById('audicion-winning-days');
            const losingDaysEl = document.getElementById('audicion-losing-days');
            if (winningDaysEl) winningDaysEl.textContent = metrics.winningDays || 0;
            if (losingDaysEl) losingDaysEl.textContent = metrics.losingDays || 0;
            
            // Estad√≠sticas adicionales
            const bestTrade = document.getElementById('audicion-best-trade');
            const worstTrade = document.getElementById('audicion-worst-trade');
            const avgTrade = document.getElementById('audicion-avg-trade');
            
            if (bestTrade) {
                bestTrade.textContent = `$${(metrics.bestTrade || 0).toFixed(2)}`;
                bestTrade.style.color = '#39ff14';
            }
            if (worstTrade) {
                worstTrade.textContent = `$${Math.abs(metrics.worstTrade || 0).toFixed(2)}`;
                worstTrade.style.color = '#ff4136';
            }
            if (avgTrade) {
                const avg = metrics.totalTrades > 0 ? metrics.netPL / metrics.totalTrades : 0;
                avgTrade.textContent = `$${avg.toFixed(2)}`;
                avgTrade.style.color = avg >= 0 ? '#39ff14' : '#ff4136';
            }
        }
        
        function updateAudicionCharts(metrics) {
            // Calcular valores para los gauges
            const totalTrades = (metrics.winners || 0) + (metrics.losers || 0) + (metrics.breakeven || 0);
            const netPL = metrics.netPL || 0;
            const winRate = totalTrades > 0 ? ((metrics.winners || 0) / totalTrades * 100) : 0;
            const profitFactor = metrics.profitFactor || 0;
            const totalDays = (metrics.winningDays || 0) + (metrics.losingDays || 0);
            const dayWinRate = totalDays > 0 ? ((metrics.winningDays || 0) / totalDays * 100) : 0;

            // Crear/actualizar gauges circulares
            createGauge('gauge-pl-total', netPL >= 0 ? Math.min(netPL / 1000 * 100, 100) : 0, netPL >= 0);
            createGauge('gauge-win-rate', winRate, winRate >= 50);
            createGauge('gauge-profit-factor', Math.min(profitFactor / 3 * 100, 100), profitFactor >= 1.5);
            createGauge('gauge-day-win', dayWinRate, dayWinRate >= 50);
        }

        function createGauge(canvasId, percentage, isPositive) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = 140;
            const height = 140;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 50;
            const lineWidth = 14;

            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);

            // Configuraci√≥n del arco
            const startAngle = 0.75 * Math.PI; // 135 grados
            const endAngle = 2.25 * Math.PI;   // 405 grados (270 grados totales)
            const progress = Math.min(Math.max(percentage, 0), 100) / 100;
            const currentAngle = startAngle + (endAngle - startAngle) * progress;

            // Arco de fondo (gris oscuro)
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Arco de progreso (verde o rojo)
            if (progress > 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
                
                // Crear gradiente
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                if (isPositive) {
                    gradient.addColorStop(0, '#39ff14');
                    gradient.addColorStop(1, '#28e000');
                } else {
                    gradient.addColorStop(0, '#ff4136');
                    gradient.addColorStop(1, '#cc3329');
                }
                
                ctx.strokeStyle = gradient;
                ctx.lineWidth = lineWidth;
                ctx.lineCap = 'round';
                ctx.stroke();

                // Agregar sombra/brillo
                ctx.shadowColor = isPositive ? 'rgba(57, 255, 20, 0.4)' : 'rgba(255, 65, 54, 0.4)';
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
        
        function updateAudicionWeeklyChart(operations) {
            const ctx = document.getElementById('audicion-weekly-chart');
            if (!ctx) return;
            
            // Obtener los √∫ltimos 7 d√≠as
            const now = new Date();
            const weeklyData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Calcular P&L del d√≠a
                const dayPL = operations
                    .filter(op => op.date === dateStr)
                    .reduce((sum, op) => sum + (parseFloat(op.pl) || 0), 0);
                
                weeklyData.push({
                    date: dateStr,
                    label: date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    pl: dayPL
                });
            }
            
            // Destruir gr√°fico anterior si existe
            if (audicionCharts.weekly) {
                audicionCharts.weekly.destroy();
            }
            
            // Crear gr√°fico de barras
            audicionCharts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map(d => d.label),
                    datasets: [{
                        label: 'P&L Diario',
                        data: weeklyData.map(d => d.pl),
                        backgroundColor: weeklyData.map(d => d.pl >= 0 ? '#39ff14' : '#ff4136'),
                        borderColor: weeklyData.map(d => d.pl >= 0 ? '#39ff14' : '#ff4136'),
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 35,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#39ff14',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `P&L: $${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 11
                                },
                                padding: 8,
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 5
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 5,
                            left: 5
                        }
                    }
                }
            });
        }
        
        function updateAudicionCurves(operations) {
            if (operations.length === 0) {
                console.log('‚ö†Ô∏è No hay operaciones para graficar');
                return;
            }
            
            // Ordenar operaciones por fecha
            const sorted = [...operations].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.exitTime || '00:00:00'}`);
                const dateB = new Date(`${b.date} ${b.exitTime || '00:00:00'}`);
                return dateA - dateB;
            });
            
            // Calcular curva de profit acumulado
            let cumulativePL = 0;
            let peak = 0;
            const profitData = [];
            const drawdownData = [];
            const labels = [];
            
            sorted.forEach((op) => {
                const pl = parseFloat(op.pl) || 0;
                cumulativePL += pl;
                
                if (cumulativePL > peak) peak = cumulativePL;
                const drawdown = peak - cumulativePL;
                
                profitData.push(cumulativePL.toFixed(2));
                drawdownData.push(-drawdown.toFixed(2));
                
                // Formato de fecha mejorado
                const date = new Date(op.date);
                labels.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
            });
            
            // Curva de Profit
            const profitCtx = document.getElementById('audicion-profit-curve');
            if (profitCtx) {
                if (audicionCharts.profitCurve) audicionCharts.profitCurve.destroy();
                
                audicionCharts.profitCurve = new Chart(profitCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Profit Acumulado',
                            data: profitData,
                            borderColor: '#39ff14',
                            backgroundColor: 'rgba(57, 255, 20, 0.2)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 1,
                            pointHoverRadius: 5,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleColor: '#39ff14',
                                bodyColor: '#fff',
                                borderColor: '#39ff14',
                                borderWidth: 1,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `$${context.parsed.y}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: '#9CA3AF',
                                    maxTicksLimit: 8,
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    font: { size: 10 },
                                    callback: (value) => `$${value}`
                                }
                            }
                        }
                    }
                });
            }
            
            // Curva de Drawdown
            const ddCtx = document.getElementById('audicion-drawdown-curve');
            if (ddCtx) {
                if (audicionCharts.drawdownCurve) audicionCharts.drawdownCurve.destroy();
                
                audicionCharts.drawdownCurve = new Chart(ddCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Drawdown',
                            data: drawdownData,
                            borderColor: '#ff4136',
                            backgroundColor: 'rgba(255, 65, 54, 0.2)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 1,
                            pointHoverRadius: 5,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleColor: '#ff4136',
                                bodyColor: '#fff',
                                borderColor: '#ff4136',
                                borderWidth: 1,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `-$${Math.abs(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: '#9CA3AF',
                                    maxTicksLimit: 8,
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    font: { size: 10 },
                                    callback: (value) => `-$${Math.abs(value)}`
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function updateAudicionLatestTrades(operations) {
            const tbody = document.querySelector('#audicion-latest-trades tbody');
            if (!tbody) return;
            
            if (operations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-text-secondary">No hay trades registrados</td></tr>';
                return;
            }
            
            // Tomar los √∫ltimos 10 trades
            const latest = [...operations]
                .sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.exitTime || '00:00:00'}`);
                    const dateB = new Date(`${b.date} ${b.exitTime || '00:00:00'}`);
                    return dateB - dateA;
                })
                .slice(0, 10);
            
            tbody.innerHTML = latest.map(op => {
                const pl = parseFloat(op.pl) || 0;
                const result = pl > 0 ? 'WIN' : pl < 0 ? 'LOSS' : 'BE';
                const resultClass = pl > 0 ? 'text-primary' : pl < 0 ? 'text-red' : 'text-gray-400';
                const resultBadge = pl > 0 ? 'bg-primary bg-opacity-20 text-primary' : pl < 0 ? 'bg-red bg-opacity-20 text-red' : 'bg-gray-500 bg-opacity-20 text-gray-400';
                
                const account = DB.accounts.find(a => a.id === op.accountId);
                const volume = parseFloat(op.volume) || parseFloat(op.size) || 0;
                const roi = volume > 0 ? ((pl / volume) * 100).toFixed(2) : '0.00';
                
                // Obtener s√≠mbolo del trade
                const symbol = op.instrument || op.symbol || 'N/A';
                
                // Determinar direcci√≥n LONG/SHORT
                let direction = 'LONG';
                const typeStr = (op.type || '').toLowerCase();
                if (typeStr === 'short' || typeStr === 'sell') {
                    direction = 'SHORT';
                } else if (typeStr === 'long' || typeStr === 'buy') {
                    direction = 'LONG';
                }
                
                // Tipo de operaci√≥n (sesi√≥n)
                const tradeType = op.session || 'Scalping';
                
                return `
                    <tr class="border-b border-border hover:bg-surface-light transition-colors">
                        <td class="py-3 px-2 text-left text-xs text-text-secondary">${new Date(op.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}</td>
                        <td class="py-3 px-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" 
                                     style="background: linear-gradient(135deg, #39ff14, #00ff88);">
                                    ${(symbol || '').charAt(0)}
                                </div>
                                <span class="font-medium">${symbol}</span>
                            </div>
                        </td>
                        <td class="py-3 px-2">
                            <div class="flex justify-center">
                                <span class="px-2 py-1 rounded text-xs font-medium" 
                                      style="background-color: ${direction === 'LONG' ? 'rgba(57, 255, 20, 0.2)' : 'rgba(255, 65, 54, 0.2)'}; color: ${direction === 'LONG' ? '#39ff14' : '#ff4136'};">
                                    ${direction}
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-2">
                            <div class="flex justify-center">
                                <span class="px-2 py-1 rounded text-xs font-medium bg-surface border border-border">
                                    ${tradeType}
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-2">
                            <div class="flex justify-center">
                                <span class="px-2 py-1 rounded text-xs font-medium" 
                                      style="background-color: ${result === 'WIN' ? 'rgba(57, 255, 20, 0.2)' : result === 'LOSS' ? 'rgba(255, 65, 54, 0.2)' : 'rgba(128, 128, 128, 0.2)'}; color: ${result === 'WIN' ? '#39ff14' : result === 'LOSS' ? '#ff4136' : '#888'};">
                                    ${result}
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-right font-semibold" style="color: ${pl >= 0 ? '#39ff14' : '#ff4136'};">
                            ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}
                        </td>
                        <td class="py-3 px-2 text-right font-semibold" style="color: ${pl >= 0 ? '#39ff14' : '#ff4136'};">
                            ${pl >= 0 ? '+' : ''}${roi}%
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Funci√≥n para subir foto de perfil
        function initProfileImageUpload() {
            const imageInput = document.getElementById('config-profile-image');
            const removeBtn = document.getElementById('config-remove-profile-image');
            const preview = document.getElementById('config-profile-preview');
            
            if (imageInput) {
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validar tama√±o (2MB m√°ximo)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('‚ö†Ô∏è La imagen es demasiado grande. Tama√±o m√°ximo: 2MB');
                        return;
                    }
                    
                    // Validar tipo
                    if (!file.type.startsWith('image/')) {
                        alert('‚ö†Ô∏è Por favor selecciona una imagen v√°lida');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageData = event.target.result;
                        
                        // Guardar en localStorage
                        localStorage.setItem('profile-image', imageData);
                        
                        // Actualizar preview
                        preview.innerHTML = `<img src="${imageData}" alt="Profile" class="w-full h-full object-cover">`;
                        
                        // Actualizar avatar en configuraci√≥n
                        const configAvatar = document.getElementById('config-user-avatar');
                        if (configAvatar) {
                            configAvatar.innerHTML = `<img src="${imageData}" alt="Profile" class="w-full h-full object-cover rounded-full">`;
                        }
                        
                        // Actualizar en audici√≥n si est√° activa
                        loadAudicionUserInfo();
                        
                        // Actualizar header del usuario
                        updateUserHeader();
                        
                        // Mostrar bot√≥n de eliminar
                        if (removeBtn) removeBtn.style.display = 'block';
                        
                        alert('‚úÖ Foto de perfil actualizada correctamente');
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            if (removeBtn) {
                removeBtn.addEventListener('click', async () => {
                    if (!confirm('¬øSeguro que deseas eliminar tu foto de perfil?')) return;
                    
                    // Eliminar de localStorage
                    localStorage.removeItem('profile-image');
                    
                    // Restaurar inicial
                    const initial = currentUser ? currentUser.email.charAt(0).toUpperCase() : 'D';
                    preview.innerHTML = initial;
                    preview.className = 'w-20 h-20 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold';
                    
                    const configAvatar = document.getElementById('config-user-avatar');
                    if (configAvatar) configAvatar.textContent = initial;
                    
                    // Actualizar en audici√≥n
                    loadAudicionUserInfo();
                    
                    // Actualizar header del usuario
                    updateUserHeader();
                    
                    // Ocultar bot√≥n
                    removeBtn.style.display = 'none';
                    
                    alert('‚úÖ Foto de perfil eliminada');
                });
            }
            
            // Cargar imagen existente
            const savedImage = localStorage.getItem('profile-image');
            if (savedImage && preview) {
                preview.innerHTML = `<img src="${savedImage}" alt="Profile" class="w-full h-full object-cover">`;
                if (removeBtn) removeBtn.style.display = 'block';
            }
        }

        function initCsvImport() {
            const importBtn = document.getElementById('import-csv-btn');
            const fileInput = document.getElementById('csv-file-input');
            const statusDiv = document.getElementById('csv-import-status');

            if (!importBtn || !fileInput || !statusDiv) {
                console.warn('‚ö†Ô∏è Elementos de importaci√≥n CSV no encontrados, saltando inicializaci√≥n');
                return;
            }

            importBtn.addEventListener('click', async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusDiv.textContent = 'Por favor, selecciona un archivo CSV.';
                    statusDiv.className = 'mt-2 text-sm text-red';
                    return;
                }

                const file = fileInput.files[0];
                statusDiv.textContent = 'Importando...';
                statusDiv.className = 'mt-2 text-sm text-yellow';

                try {
                    await processCSVFile(file, statusDiv);
                    fileInput.value = '';
                } catch (error) {
                    console.error("Error importando CSV:", error);
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.className = 'mt-2 text-sm text-negative';
                }
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };

            const splitLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && (i === 0 || line[i - 1] !== '\\')) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result.map(v => v.replace(/^"|"$/g, ''));
            };

            const headers = splitLine(lines[0]);
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === "") continue;
                const values = splitLine(line);
                if (values.length >= headers.length) {
                    rows.push(values);
                } else {
                    console.warn(`L√≠nea CSV con n√∫mero incorrecto de columnas: "${line}". Esperadas ${headers.length}, obtenidas ${values.length}.`);
                }
            }
            return { headers, rows };
        }

        // ========== FUNCIONES CENTRALIZADAS PARA MANEJO DE IDs Y OPERACIONES PARCIALES ==========
        
        /**
         * Funci√≥n centralizada para generar IDs √∫nicos y consistentes para todas las plataformas
         * @param {Object} operation - Datos de la operaci√≥n
         * @param {string} platform - Plataforma de origen (bingx, bitget, mexc, primexbt-crypto, primexbt-cfds, mt5)
         * @param {string} csvId - ID del CSV si existe
         * @param {number} partialIndex - √çndice de parcial para operaciones divididas
         * @returns {string} ID √∫nico generado
         */
        // Sistema de IDs secuenciales simples
        function getNextOperationId() {
            // Obtener el contador actual desde localStorage
            let counter = parseInt(localStorage.getItem('operation-id-counter') || '25000');
            
            // Verificar que el ID no exista ya en la base de datos
            while (DB.operations.some(op => op.id === counter.toString())) {
                counter++;
            }
            
            // Guardar el nuevo contador
            localStorage.setItem('operation-id-counter', (counter + 1).toString());
            
            return counter.toString();
        }
        
        function generateUnifiedOperationId(operation, platform, csvId = null, partialIndex = null) {
            // Si viene un ID del CSV de PrimeXBT, usarlo directamente
            if (csvId && csvId.trim() !== '' && platform && platform.includes('primexbt')) {
                const baseId = csvId.trim();
                return partialIndex !== null ? `${baseId}_p${partialIndex}` : baseId;
            }
            
            // Para cualquier otra plataforma o importaci√≥n, usar ID secuencial simple
            const baseId = getNextOperationId();
            return partialIndex !== null ? `${baseId}_p${partialIndex}` : baseId;
        }

        /**
         * Funci√≥n para agrupar operaciones parciales por ID
         * @param {Array} operations - Array de operaciones
         * @returns {Array} Array de operaciones agrupadas (completas o parciales sumadas)
         */
        function groupPartialOperations(operations) {
            const groupedOps = new Map();
            
            for (const op of operations) {
                // Obtener el ID base (sin sufijos de parciales)
                let baseId = op.id;
                
                // Remover sufijos de parciales comunes
                baseId = baseId.replace(/_partial_\d+$/, '').replace(/_p\d+$/, '');
                
                // Para IDs que contienen el ID original del CSV, usar una l√≥gica especial
                // Ejemplo: "primexbt-cfds_80251024" -> usar "80251024" como ID base para agrupar
                const parts = baseId.split('_');
                if (parts.length >= 2) {
                    const potentialCsvId = parts[parts.length - 1];
                    // Si el √∫ltimo parte parece ser un ID num√©rico del CSV, usarlo para agrupar
                    if (/^\d+$/.test(potentialCsvId)) {
                        baseId = potentialCsvId;
                    }
                }
                
                if (groupedOps.has(baseId)) {
                    // Ya existe una operaci√≥n con este ID base, combinar
                    const existingOp = groupedOps.get(baseId);
                    
                    // Sumar vol√∫menes y promediar precios ponderadamente
                    const totalVolume = existingOp.volume + op.volume;
                    const weightedEntryPrice = ((existingOp.entry * existingOp.volume) + (op.entry * op.volume)) / totalVolume;
                    const weightedExitPrice = ((existingOp.exit * existingOp.volume) + (op.exit * op.volume)) / totalVolume;
                    
                    existingOp.volume = totalVolume;
                    existingOp.entry = weightedEntryPrice;
                    existingOp.exit = weightedExitPrice;
                    existingOp.pl = (existingOp.pl || 0) + (op.pl || 0);
                    existingOp.fees = (existingOp.fees || existingOp.fee || 0) + (op.fees || op.fee || 0);
                    
                    // Usar la fecha/hora m√°s temprana para entrada y m√°s tard√≠a para salida
                    // Comparar horas de entrada para encontrar la m√°s temprana
                    if (op.entryTime) {
                        if (!existingOp.entryTime || op.entryTime < existingOp.entryTime) {
                            existingOp.entryTime = op.entryTime;
                        }
                    }
                    
                    // Para la hora de salida, considerar tanto exitTime como entryTime
                    const currentOpLatestTime = op.exitTime || op.entryTime;
                    const existingOpLatestTime = existingOp.exitTime || existingOp.entryTime;
                    
                    if (currentOpLatestTime) {
                        if (!existingOpLatestTime || currentOpLatestTime > existingOpLatestTime) {
                            existingOp.exitTime = currentOpLatestTime;
                        }
                    }
                    
                    // Combinar notas
                    if (op.notes && op.notes !== existingOp.notes) {
                        existingOp.notes = existingOp.notes ? `${existingOp.notes}; ${op.notes}` : op.notes;
                    }
                    
                    // Agregar informaci√≥n de parciales
                    if (!existingOp.partials) {
                        existingOp.partials = [
                            {
                                id: existingOp.originalId || existingOp.id,
                                volume: existingOp.originalVolume || existingOp.volume,
                                entry: existingOp.originalEntry || existingOp.entry,
                                exit: existingOp.originalExit || existingOp.exit,
                                pl: existingOp.originalPL || existingOp.pl,
                                entryTime: existingOp.originalEntryTime || existingOp.entryTime,
                                exitTime: existingOp.originalExitTime || existingOp.exitTime
                            }
                        ];
                    }
                    
                    existingOp.partials.push({
                        id: op.id,
                        volume: op.volume,
                        entry: op.entry,
                        exit: op.exit,
                        pl: op.pl,
                        entryTime: op.entryTime,
                        exitTime: op.exitTime
                    });
                    
                    // Actualizar resultado final
                    existingOp.result = existingOp.pl > 0 ? 'win' : (existingOp.pl < 0 ? 'loss' : 'breakeven');
                    
                } else {
                    // Nueva operaci√≥n, usar el ID base limpio
                    const cleanOp = { 
                        ...op, 
                        id: baseId,
                        originalId: op.id,
                        originalVolume: op.volume,
                        originalEntry: op.entry,
                        originalExit: op.exit,
                        originalPL: op.pl,
                        originalEntryTime: op.entryTime,
                        originalExitTime: op.exitTime
                    };
                    
                    // Si no tiene exitTime pero s√≠ entryTime, usar entryTime como exitTime inicial
                    if (!cleanOp.exitTime && cleanOp.entryTime) {
                        cleanOp.exitTime = cleanOp.entryTime;
                    }
                    
                    groupedOps.set(baseId, cleanOp);
                }
            }
            
            return Array.from(groupedOps.values());
        }

        /**
         * Funci√≥n para verificar si una operaci√≥n ya existe en la base de datos
         * @param {Object} operation - Operaci√≥n a verificar
         * @param {Array} existingOperations - Operaciones existentes en DB
         * @returns {boolean} true si la operaci√≥n ya existe
         */
        function isDuplicateOperation(operation, existingOperations) {
            return existingOperations.some(existing => {
                // Comparar por ID exacto
                if (existing.id === operation.id) return true;
                
                // Comparar por datos principales (tolerancia para duplicados sin ID)
                const sameAccount = existing.accountId === operation.accountId;
                const sameDate = existing.date === operation.date;
                const sameInstrument = existing.instrument === operation.instrument;
                const sameType = existing.type === operation.type;
                const sameEntry = Math.abs(existing.entry - operation.entry) < 0.0001;
                const sameExit = Math.abs(existing.exit - operation.exit) < 0.0001;
                const sameVolume = Math.abs(existing.volume - operation.volume) < 0.0001;
                
                return sameAccount && sameDate && sameInstrument && sameType && sameEntry && sameExit && sameVolume;
            });
        }

        /**
         * Funci√≥n para procesar y limpiar operaciones antes de guardar
         * @param {Array} rawOperations - Operaciones sin procesar
         * @param {string} platform - Plataforma de origen
         * @returns {Array} Operaciones procesadas y limpias
         */
        async function processAndCleanOperations(rawOperations, platform) {
            console.log(`üîß Procesando ${rawOperations.length} operaciones para ${platform}...`);
            
            // Obtener operaciones existentes
            const existingOperations = await dexieDB.operations.toArray();
            
            // Agrupar operaciones parciales
            const groupedOperations = groupPartialOperations(rawOperations);
            console.log(`üìä Agrupadas a ${groupedOperations.length} operaciones despu√©s de combinar parciales`);
            
            // Filtrar duplicados
            const newOperations = groupedOperations.filter(op => !isDuplicateOperation(op, existingOperations));
            console.log(`‚úÖ ${newOperations.length} operaciones nuevas despu√©s de filtrar duplicados`);
            
            return newOperations;
        }

        // ========== FIN FUNCIONES CENTRALIZADAS ==========



        // Funci√≥n para actualizar el estado de autenticaci√≥n en la configuraci√≥n
        function updateAuthStatus() {
            try {
                const loggedOutSection = document.getElementById('auth-status-logged-out');
                const loggedInSection = document.getElementById('auth-status-logged-in');
                const currentUserEmailSpan = document.getElementById('current-user-email');

                // Verificar si currentUser est√° definido
                if (typeof currentUser !== 'undefined' && currentUser) {
                    // Usuario autenticado
                    if (loggedOutSection) loggedOutSection.style.display = 'none';
                    if (loggedInSection) loggedInSection.style.display = 'block';
                    if (currentUserEmailSpan) currentUserEmailSpan.textContent = currentUser.email;
                } else {
                    // Usuario no autenticado
                    if (loggedOutSection) loggedOutSection.style.display = 'block';
                    if (loggedInSection) loggedInSection.style.display = 'none';
                }
            } catch (error) {
                console.log('Error en updateAuthStatus:', error);
            }
        }

        async function initConfig() {
            // Solo actualizar elementos de BingX si existen
            const bingxAccount = document.getElementById('bingx-account');
            if (bingxAccount) {
                updateAccountSelect('bingx-account');
                const bingxApiKey = document.getElementById('bingx-api-key');
                const bingxApiSecret = document.getElementById('bingx-api-secret');
                if (bingxApiKey) bingxApiKey.value = DB.apiKeys.bingx.key ? '********' : '';
                if (bingxApiSecret) bingxApiSecret.value = DB.apiKeys.bingx.secret ? '********' : '';
                bingxAccount.value = DB.apiKeys.bingx.accountId || '';
            }
            updateAccountSelect('bingx-account-detail');

            // Solo actualizar elementos que existen
            const showTooltips = document.getElementById('show-tooltips');
            if (showTooltips) {
                showTooltips.checked = DB.settings.showTooltips;
            }

            // Actualizar estado de autenticaci√≥n
            updateAuthStatus();

            initCsvImport();
            initFunded();
            initAudicion();
            initProfileImageUpload();

            // Event listeners para autenticaci√≥n
            const showAuthModalBtn = document.getElementById('show-auth-modal-btn');
            if (showAuthModalBtn) {
                showAuthModalBtn.addEventListener('click', () => {
                    const authModal = document.getElementById('authModal');
                    const mainApp = document.getElementById('mainApp');
                    if (authModal) authModal.style.display = 'flex';
                    if (mainApp) mainApp.classList.add('app-hidden');
                });
            }

            const logoutBtnConfig = document.getElementById('logout-btn-config');
            if (logoutBtnConfig) {
                logoutBtnConfig.addEventListener('click', async () => {
                    if (confirm('¬øEst√° seguro de que desea cerrar sesi√≥n? Sus datos locales se mantendr√°n, pero no se sincronizar√°n con Supabase.')) {
                        await handleLogout();
                    }
                });
            }

            const showTooltipsEl = document.getElementById('show-tooltips');
            if (showTooltipsEl) {
                showTooltipsEl.addEventListener('change', async (e) => {
                    DB.settings.showTooltips = e.target.checked;
                    try {
                        await dexieDB.generalData.put({ key: 'settings', value: DB.settings }); alert('Configuraci√≥n de tooltips guardada.');
                    } catch (err) { console.error("Error saving tooltip settings:", err); alert("Error al guardar configuraci√≥n."); }
                });
            }

            // Solo agregar listener si el elemento existe
            const bingxConnectEl = document.getElementById('bingx-connect');
            if (bingxConnectEl) {
                bingxConnectEl.addEventListener('click', () => alert('Funcionalidad API no implementada.'));
            }

            const exportDataBtn = document.getElementById('export-data');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', async () => {
                    showLoading(true);
                    try {
                        const exportableDB = {
                            accounts: await dexieDB.accounts.toArray(),
                            operations: await dexieDB.operations.toArray(),
                            finances: await dexieDB.finances.toArray(),
                            settings: (await dexieDB.generalData.get('settings'))?.value || DB.settings,
                            apiKeys: (await dexieDB.generalData.get('apiKeys'))?.value || DB.apiKeys
                        };
                        const dataStr = JSON.stringify(exportableDB, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a'); link.href = url; const date = getLocalDateString(new Date()); link.download = `trader_survivor_backup_${date}.json`;
                        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                        alert('Datos exportados correctamente.');
                    } catch (e) {
                        console.error('Error exporting data:', e); alert('Error al exportar.');
                    } finally { showLoading(false); }
                });
            }

            const importInput = document.getElementById('import-data');
            if (importInput) {
                importInput.addEventListener('change', (event) => {
                    const file = event.target.files[0]; if (!file) return;
                    if (!confirm('Importar datos reemplazar√° TODOS los datos actuales. ¬øSeguro?')) { importInput.value = ''; return; }
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        showLoading(true);
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.accounts && importedData.operations && importedData.settings) {
                                await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, dexieDB.finances, dexieDB.generalData, async () => {
                                    await dexieDB.accounts.clear();
                                    await dexieDB.operations.clear();
                                    await dexieDB.finances.clear();
                                    await dexieDB.generalData.clear();
                                    await dexieDB.accounts.bulkPut(importedData.accounts || []);
                                    await dexieDB.operations.bulkPut(importedData.operations || []);
                                    await dexieDB.finances.bulkPut(importedData.finances || []);
                                    await dexieDB.generalData.put({ key: 'settings', value: importedData.settings || DB.settings });
                                    await dexieDB.generalData.put({ key: 'apiKeys', value: importedData.apiKeys || DB.apiKeys });
                                });
                                alert('Datos importados. Recargando aplicaci√≥n...'); location.reload();
                            } else { alert('Error: Archivo con estructura no esperada.'); }
                        } catch (err) {
                            console.error('Error importing file:', err); alert('Error al procesar el archivo.');
                        } finally { importInput.value = ''; showLoading(false); }
                    };
                    reader.onerror = () => { alert('Error al leer el archivo.'); importInput.value = ''; };
                    reader.readAsText(file);
                });
            }

            const clearDataBtn = document.getElementById('clear-data');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', async () => {
                    if (confirm('¬°ATENCI√ìN! Esto eliminar√° TODOS tus datos de forma permanente y la plataforma quedar√° vac√≠a. ¬øEst√°s seguro?')) {
                        showLoading(true);
                        try {
                            await Promise.all([
                                dexieDB.accounts.clear(),
                                dexieDB.operations.clear(),
                                dexieDB.finances.clear(),
                                dexieDB.generalData.clear()
                            ]);
                            DB.accounts = [];
                            DB.operations = [];
                            DB.finances = [];
                            DB.settings = { darkMode: true, showTooltips: true, autoRefresh: false, defaultCurrency: 'USD' };
                            DB.apiKeys = { ctrader: { key: '', secret: '', accountId: '' }, bingx: { key: '', secret: '', accountId: '' } };
                            await dexieDB.generalData.put({ key: 'settings', value: DB.settings });
                            await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });

                            alert('Todos los datos han sido eliminados. Recargando aplicaci√≥n...');
                            location.reload();
                        } catch (e) {
                            console.error('Error clearing data:', e);
                            alert('Error al eliminar los datos.');
                        } finally {
                            showLoading(false);
                        }
                    }
                });
            }
        }

        function updateAccountSelect(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            selectElement.innerHTML = '';

            // Opci√≥n "Todas las cuentas" para algunos selectores
            if (['dashboard-account-select', 'analytics-account-select', 'equity-account-select', 'daily-journal-account-select', 'calendar-account-select', 'filter-account', 'chartbook-account-select', 'informe-account-select'].includes(selectId)) {
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'Todas las cuentas';
                selectElement.appendChild(allOption);
            }

            // Opci√≥n placeholder para BingX
            if (['bingx-account'].includes(selectId)) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Seleccionar cuenta...';
                selectElement.appendChild(placeholderOption);
            }

            // Agregar cuentas sin mostrar divisa
            DB.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                option.setAttribute('data-platform', account.platform);
                selectElement.appendChild(option);
            });

            // Restaurar valor seleccionado
            if (Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
            } else if (selectId === 'op-account' && DB.accounts.length > 0) {
                selectElement.value = DB.accounts[0].id;
            } else if (!['bingx-account'].includes(selectId) && selectElement.options.length > 0 && selectElement.options[0].value === 'all') {
                selectElement.value = 'all';
            } else if (selectElement.options.length > 0) {
                selectElement.value = selectElement.options[0].value;
            }

            // Actualizar logo del selector
            updateSelectorLogo(selectId);
        }

        // Funci√≥n para actualizar el logo del selector seg√∫n la cuenta seleccionada
        function updateSelectorLogo(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const selectedAccountId = selectElement.value;

            // Mapeo de selectores a sus contenedores de logo
            const logoMapping = {
                'main-account-select': { container: 'main-account-logo', img: 'main-account-logo-img' },
                'dashboard-account-select': { container: 'dashboard-account-logo', img: 'dashboard-account-logo-img' },
                'analytics-account-select': { container: 'analytics-account-logo', img: 'analytics-account-logo-img' },
                'calendar-account-select': { container: 'calendar-account-logo', img: 'calendar-account-logo-img' },
                'filter-account': { container: 'filter-account-logo', img: 'filter-account-logo-img' },
                'chartbook-account-select': { container: 'chartbook-account-logo', img: 'chartbook-account-logo-img' },
                'equity-account-select': { container: 'equity-account-logo', img: 'equity-account-logo-img' },
                'daily-journal-account-select': { container: 'daily-journal-account-logo', img: 'daily-journal-account-logo-img' },
                'informe-account-select': { container: 'informe-account-logo', img: 'informe-account-logo-img' }
            };

            const logoInfo = logoMapping[selectId];
            if (!logoInfo) return;

            const logoContainer = document.getElementById(logoInfo.container);
            const logoImg = document.getElementById(logoInfo.img);

            if (!logoContainer || !logoImg) return;

            // Buscar la cuenta seleccionada
            const account = DB.accounts.find(acc => acc.id === selectedAccountId);
            
            // Caso 1: No hay selecci√≥n, est√° vac√≠o, o es "Todas las cuentas"
            if (!selectedAccountId || selectedAccountId === '' || selectedAccountId === 'all') {
                logoContainer.style.display = 'none';
                logoImg.src = '';
                logoImg.alt = '';
                return;
            }
            
            // Caso 2: Cuenta espec√≠fica no encontrada
            if (!account) {
                logoContainer.style.display = 'none';
                logoImg.src = '';
                logoImg.alt = '';
                return;
            }

            // Obtener informaci√≥n del logo
            const platformLogo = getPlatformLogo(account.platform);

            // Configurar el logo con fondo de color
            logoContainer.style.backgroundColor = platformLogo.color;
            logoContainer.style.display = 'flex';

            // Intentar cargar imagen
            logoImg.src = platformLogo.file;
            logoImg.style.display = 'block';
            logoImg.alt = account.platform;
            
            logoImg.onerror = function() {
                // Si falla la imagen, mostrar iniciales
                logoImg.style.display = 'none';
                const existingInitials = logoContainer.querySelector('.platform-initials');
                if (existingInitials) existingInitials.remove();
                logoContainer.innerHTML += `<div class="platform-initials text-white font-bold text-lg">${platformLogo.initials}</div>`;
            };
            
            logoImg.onload = function() {
                // Limpiar cualquier inicial previa si la imagen carga bien
                const existingInitials = logoContainer.querySelector('.platform-initials');
                if (existingInitials) existingInitials.remove();
            };
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('loading'); if (loadingElement) { loadingElement.style.display = show ? 'flex' : 'none'; }
        }

        const calendarPopup = document.getElementById('global-calendar-popup');

        function getWeekRangeForDate(date, startOfWeek = 1) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); // Usar hora local
            const dayOfWeek = d.getDay(); // Usar d√≠a local
            const diff = (dayOfWeek < startOfWeek ? 7 : 0) + dayOfWeek - startOfWeek;
            const startDate = new Date(d);
            startDate.setDate(d.getDate() - diff); // Usar fecha local
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // Usar fecha local
            return {
                startDate: getLocalDateString(startDate),
                endDate: getLocalDateString(endDate)
            };
        }

        function getMonthRangeForDate(date) {
            const d = new Date(date);
            const year = d.getFullYear(); // Usar a√±o local
            const month = d.getMonth(); // Usar mes local
            const startDate = new Date(year, month, 1); // Usar constructor local
            const endDate = new Date(year, month + 1, 0); // Usar constructor local
            return {
                startDate: getLocalDateString(startDate),
                endDate: getLocalDateString(endDate)
            };
        }

        function getSemesterRangeForDate(date) {
            const d = new Date(date);
            const year = d.getFullYear(); // Usar a√±o local
            const month = d.getMonth(); // Usar mes local
            let startDate, endDate;
            if (month < 6) {
                startDate = new Date(year, 0, 1); // Usar constructor local
                endDate = new Date(year, 5, 30); // Usar constructor local
            } else {
                startDate = new Date(year, 6, 1); // Usar constructor local
                endDate = new Date(year, 11, 31); // Usar constructor local
            }
            return {
                startDate: getLocalDateString(startDate),
                endDate: getLocalDateString(endDate)
            };
        }

        function getYearRangeForDate(date) {
            const d = new Date(date);
            const year = d.getFullYear(); // Usar a√±o local
            const startDate = new Date(year, 0, 1); // Usar constructor local
            const endDate = new Date(year, 11, 31); // Usar constructor local
            return {
                startDate: getLocalDateString(startDate),
                endDate: getLocalDateString(endDate)
            };
        }

        // Funci√≥n auxiliar para mostrar una secci√≥n y ocultar las dem√°s
        function showSection(sectionId) {
            document.querySelectorAll('.section-container').forEach(s => s.classList.remove('active'));
            // Opcional: Si quieres que la pesta√±a de navegaci√≥n correspondiente tambi√©n se active
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const targetTab = document.querySelector(`.nav-tab[data-target="${sectionId}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            document.getElementById(sectionId).classList.add('active');
            
            // Cargar configuraci√≥n de perfil p√∫blico al abrir config
            if (sectionId === 'config' && typeof loadUserPublicSettings === 'function') {
                setTimeout(() => loadUserPublicSettings(), 100);
            }
            
            // Auto-refresh cuando se cambia de secci√≥n
            console.log('üîÑ Cambiando a secci√≥n:', sectionId);
            setTimeout(() => {
                refreshCurrentSection();
            }, 100);
        }


        function renderPopupCalendar(dateForMonthView) {
            const year = dateForMonthView.getUTCFullYear();
            const month = dateForMonthView.getUTCMonth();
            document.getElementById('popup-cal-current-month-year').textContent = `${monthNamesShort[month]} ${year}`;

            const grid = document.getElementById('popup-cal-days-grid');
            grid.innerHTML = '';

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));
            const daysInMonth = lastDayOfMonth.getUTCDate();

            let startingDayOfWeek = firstDayOfMonth.getUTCDay();
            if (startingDayOfWeek === 0) startingDayOfWeek = 6;
            else startingDayOfWeek -= 1;

            for (let i = 0; i < startingDayOfWeek; i++) {
                grid.innerHTML += `<div class="popup-cal-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayBtn = document.createElement('button');
                dayBtn.classList.add('popup-cal-day');
                dayBtn.dataset.date = currentDateStr;
                dayBtn.textContent = day;

                if (globalDateFilter.type === 'day' && globalDateFilter.startDate === currentDateStr) {
                    dayBtn.classList.add('selected');
                } else if ((globalDateFilter.type === 'week' || globalDateFilter.type === 'month' || globalDateFilter.type === 'semester' || globalDateFilter.type === 'year') &&
                    globalDateFilter.startDate && globalDateFilter.endDate &&
                    currentDateStr >= globalDateFilter.startDate && currentDateStr <= globalDateFilter.endDate) {
                    dayBtn.classList.add('in-range');
                }

                dayBtn.onclick = () => {
                    updateGlobalDateFilter({
                        type: 'day',
                        startDate: currentDateStr,
                        endDate: currentDateStr,
                        display: `D√≠a: ${formatDate(currentDateStr)}`
                    });
                    calendarPopup.classList.add('hidden');
                };
                grid.appendChild(dayBtn);
            }
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                grid.innerHTML += `<div class="popup-cal-day other-month"></div>`;
            }
        }

        function updateGlobalDateFilter(newFilter) {
            console.log('üîÑ Actualizando filtro global de fecha:', newFilter);
            globalDateFilter = newFilter;
            
            // Actualizar todos los displays de fecha
            document.querySelectorAll('.date-filter-display-text').forEach(el => {
                el.textContent = globalDateFilter.display;
            });
            
            // Actualizar displays espec√≠ficos por ID
            const displayIds = [
                'dashboard-date-filter-display', 
                'analytics-date-filter-display', 
                'informe-date-filter-display', 
                'operations-date-filter-display', 
                'finances-date-filter-display',
                'funded-date-filter-display'
            ];
            displayIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = globalDateFilter.display;
            });
            
            // Si existe la funci√≥n de funded, aplicar filtro espec√≠fico
            if (window.applyFundedDateFilter) {
                window.applyFundedDateFilter(globalDateFilter);
            }
            
            console.log('‚úÖ Filtro actualizado. Refrescando vistas...');
            // Forzar refresh inmediato y asegurar que se ejecuta
            setTimeout(() => {
                refreshAllViews();
                console.log('‚úÖ Vistas refrescadas');
            }, 100);
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function initDateRangeModal() {
    const modal = document.getElementById('date-range-modal');
    const closeBtn = document.getElementById('date-range-close-btn');
    const prevMonthBtn = document.getElementById('calendar-prev-month');
    const nextMonthBtn = document.getElementById('calendar-next-month');
    const monthYearEl = document.getElementById('calendar-month-year');
    const daysGrid = document.getElementById('calendar-days');
    const applyBtn = document.getElementById('date-range-apply-btn');
    const clearBtn = document.getElementById('date-range-clear-btn');
    const startDateInput = document.getElementById('date-range-start-input');
    const endDateInput = document.getElementById('date-range-end-input');

    // Verificar que todos los elementos existen
    if (!modal) {
        console.error('Error: No se encontr√≥ el modal date-range-modal');
        return;
    }
    if (!closeBtn) console.error('Error: No se encontr√≥ date-range-close-btn');
    if (!prevMonthBtn) console.error('Error: No se encontr√≥ calendar-prev-month');
    if (!nextMonthBtn) console.error('Error: No se encontr√≥ calendar-next-month');
    if (!monthYearEl) console.error('Error: No se encontr√≥ calendar-month-year');
    if (!daysGrid) console.error('Error: No se encontr√≥ calendar-days');
    if (!applyBtn) console.error('Error: No se encontr√≥ date-range-apply-btn');
    if (!clearBtn) console.error('Error: No se encontr√≥ date-range-clear-btn');
    if (!startDateInput) console.error('Error: No se encontr√≥ date-range-start-input');
    if (!endDateInput) console.error('Error: No se encontr√≥ date-range-end-input');
    
    if (!closeBtn || !prevMonthBtn || !nextMonthBtn || !monthYearEl || !daysGrid || !applyBtn || !clearBtn || !startDateInput || !endDateInput) {
        console.error('Error: Faltan elementos del modal de fecha');
        return;
    }
    
    console.log('‚úÖ Modal de calendario inicializado correctamente');

    let currentDate = new Date();
    let startDate = null;
    let endDate = null;

    function renderCalendar() {
        if (!daysGrid || !monthYearEl) return;
        
        daysGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearEl.textContent = `${monthNamesShort[month]} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            daysGrid.innerHTML += '<div></div>';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.textContent = day;
            dayEl.classList.add('calendar-day-cell');
            const date = new Date(year, month, day);
            const dateString = getLocalDateString(date);

            if (dateString === getLocalDateString(new Date())) {
                dayEl.classList.add('today');
            }

            dayEl.addEventListener('click', () => {
                if (!startDate || (startDate && endDate)) {
                    startDate = date;
                    endDate = null;
                } else if (date < startDate) {
                    endDate = startDate;
                    startDate = date;
                } else {
                    endDate = date;
                }
                updateCalendarSelection();
            });

            daysGrid.appendChild(dayEl);
        }
        updateCalendarSelection();
    }

    function updateCalendarSelection() {
        if (!daysGrid || !startDateInput || !endDateInput) return;
        
        const dayCells = daysGrid.querySelectorAll('.calendar-day-cell');
        dayCells.forEach(cell => {
            const day = parseInt(cell.textContent);
            if (isNaN(day)) return;
            
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const dateString = getLocalDateString(date);

            cell.classList.remove('selected', 'in-range', 'range-start', 'range-end');

            if (startDate && dateString === getLocalDateString(startDate)) {
                cell.classList.add('selected', 'range-start');
            }
            if (endDate && dateString === getLocalDateString(endDate)) {
                cell.classList.add('selected', 'range-end');
            }
            if (startDate && endDate && date > startDate && date < endDate) {
                cell.classList.add('in-range');
            }
        });

        startDateInput.value = startDate ? formatDate(getLocalDateString(startDate)) : '';
        endDateInput.value = endDate ? formatDate(getLocalDateString(endDate)) : '';
    }

    function openModal() {
        if (!modal) {
            console.error('‚ùå Modal no existe!');
            return;
        }
        console.log('üîµ Abriendo modal de calendario...');
        
        // Remover hidden y forzar display
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.zIndex = '9999';
        
        currentDate = new Date();
        startDate = null;
        endDate = null;
        renderCalendar();
        console.log('‚úÖ Modal de calendario abierto');
        console.log('üìä Estado del modal:', {
            display: modal.style.display,
            visibility: modal.style.visibility,
            classList: modal.classList.toString()
        });
    }

    function closeModal() {
        if (!modal) return;
        console.log('üî¥ Cerrando modal de calendario...');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera de √©l
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    document.querySelectorAll('.date-filter-trigger').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üî¥ Click en bot√≥n de filtro de fecha detectado');
            openModal();
        });
    });
    
    console.log('üìÖ Event listeners del calendario configurados. Botones encontrados:', document.querySelectorAll('.date-filter-trigger').length);

    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }

    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
    }

    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
    }

    if (applyBtn) {
        applyBtn.addEventListener('click', () => {
            console.log('üìÖ Aplicando filtro de fecha...');
            console.log('üìÖ startDate object:', startDate);
            console.log('üìÖ endDate object:', endDate);
            
            if (startDate && endDate) {
                const startString = getLocalDateString(startDate);
                const endString = getLocalDateString(endDate);
                
                console.log('üìÖ startDate string:', startString);
                console.log('üìÖ endDate string:', endString);
                
                const filterData = {
                    type: 'custom',
                    startDate: startString,
                    endDate: endString,
                    display: `${formatDate(startString)} - ${formatDate(endString)}`
                };
                console.log('‚úÖ Filtro aplicado completo:', JSON.stringify(filterData, null, 2));
                
                // Cerrar modal primero
                closeModal();
                
                // Aplicar filtro despu√©s de cerrar
                setTimeout(() => {
                    updateGlobalDateFilter(filterData);
                }, 50);
                
            } else if (startDate) {
                const startString = getLocalDateString(startDate);
                const filterData = {
                    type: 'day',
                    startDate: startString,
                    endDate: startString,
                    display: `D√≠a: ${formatDate(startString)}`
                };
                console.log('‚úÖ Filtro de d√≠a aplicado:', JSON.stringify(filterData, null, 2));
                
                // Cerrar modal primero
                closeModal();
                
                // Aplicar filtro despu√©s de cerrar
                setTimeout(() => {
                    updateGlobalDateFilter(filterData);
                }, 50);
                
            } else {
                console.warn('‚ö†Ô∏è No hay fechas seleccionadas');
                alert('Por favor selecciona al menos una fecha');
                return;
            }
        });
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            closeModal();
            setTimeout(() => {
                updateGlobalDateFilter({ type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' });
            }, 50);
        });
    }

    document.querySelectorAll('.date-range-preset').forEach(button => {
        button.addEventListener('click', () => {
            const range = button.dataset.range;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizar la hora
            let newStartDate, newEndDate;

            switch (range) {
                case 'today':
                    newStartDate = new Date(today);
                    newEndDate = new Date(today);
                    break;
                case 'this_week':
                    const weekRange = getWeekRangeForDate(today, 1);
                    // Convertir strings YYYY-MM-DD a Date local sin zona horaria
                    const [wy, wm, wd] = weekRange.startDate.split('-').map(Number);
                    const [wey, wem, wed] = weekRange.endDate.split('-').map(Number);
                    newStartDate = new Date(wy, wm - 1, wd);
                    newEndDate = new Date(wey, wem - 1, wed);
                    break;
                case 'this_month':
                    const monthRange = getMonthRangeForDate(today);
                    const [my, mm, md] = monthRange.startDate.split('-').map(Number);
                    const [mey, mem, med] = monthRange.endDate.split('-').map(Number);
                    newStartDate = new Date(my, mm - 1, md);
                    newEndDate = new Date(mey, mem - 1, med);
                    break;
                case 'last_7_days':
                    newEndDate = new Date(today);
                    newStartDate = new Date(today);
                    newStartDate.setDate(today.getDate() - 6);
                    break;
                case 'last_30_days':
                    newEndDate = new Date(today);
                    newStartDate = new Date(today);
                    newStartDate.setDate(today.getDate() - 29);
                    break;
                case 'this_year':
                    const yearRange = getYearRangeForDate(today);
                    const [yy, ym, yd] = yearRange.startDate.split('-').map(Number);
                    const [yey, yem, yed] = yearRange.endDate.split('-').map(Number);
                    newStartDate = new Date(yy, ym - 1, yd);
                    newEndDate = new Date(yey, yem - 1, yed);
                    break;
            }

            console.log('üìÖ Rango predefinido seleccionado:', range);
            console.log('üìÜ Fechas:', { 
                start: newStartDate, 
                end: newEndDate,
                startString: getLocalDateString(newStartDate),
                endString: getLocalDateString(newEndDate)
            });

            startDate = newStartDate;
            endDate = newEndDate;
            currentDate = new Date(startDate);
            renderCalendar();
        });
    });
}

        // ===== INICIALIZACI√ìN DEL HEADER PRINCIPAL =====
        function initMainHeader() {
            console.log('üéØ Iniciando initMainHeader()');
            
            // Poblar selector principal
            const mainSelect = document.getElementById('main-account-select');
            if (!mainSelect) {
                console.warn('‚ö†Ô∏è No se encontr√≥ main-account-select, continuando con el resto de la inicializaci√≥n');
            }

            // Agregar cuentas
            if (mainSelect) {
                DB.accounts.forEach(account => {
                    const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                option.setAttribute('data-platform', account.platform);
                mainSelect.appendChild(option);
            });

            // Event listener para cambio de cuenta principal
            mainSelect.addEventListener('change', function() {
                const selectedAccount = this.value;
                console.log('üéØ [MAIN SELECTOR] Account changed to:', selectedAccount);

                if (selectedAccount === '') {
                    // No hay cuenta seleccionada
                    globalSelectedAccount = 'all';
                } else {
                    globalSelectedAccount = selectedAccount;
                }

                // Actualizar logo del selector principal
                updateSelectorLogo('main-account-select');

                // Sincronizar con TODOS los selectores de cuenta
                const selectors = [
                    'dashboard-account-select',
                    'analytics-account-select',
                    'informe-account-select',
                    'daily-journal-account-select',
                    'calendar-account-select',
                    'equity-account-select',
                    'filter-account',
                    'chartbook-account-select'
                ];

                selectors.forEach(selectorId => {
                    const selectElement = document.getElementById(selectorId);
                    if (selectElement) {
                        if (selectedAccount === '') {
                            selectElement.value = 'all';
                        } else {
                            selectElement.value = selectedAccount;
                        }
                        updateSelectorLogo(selectorId);
                    }
                });

                // Refrescar la secci√≥n activa
                refreshCurrentSection();
                
                // Si estamos en Informe, tambi√©n refrescar la subsecci√≥n activa
                const activeSection = document.querySelector('.section-container.active');
                if (activeSection && activeSection.id === 'informe') {
                    console.log('üîÑ [MAIN SELECTOR] Refreshing active Informe subsection...');
                    const activeSubTab = document.querySelector('.informe-sub-tab.active');
                    if (activeSubTab) {
                        const targetId = activeSubTab.dataset.target;
                        console.log('üîÑ [MAIN SELECTOR] Active subsection:', targetId);
                    }
                }
            });
            }

            // ===== INICIALIZACI√ìN DE CONTROLES DE USUARIO =====
            
            // Actualizar header del usuario cuando est√© disponible
            if (typeof currentUser !== 'undefined' && currentUser) {
                updateUserHeader();
            }

            // Toggle del men√∫ de usuario
            const userMenuToggle = document.getElementById('user-menu-toggle');
            const userDropdown = document.getElementById('user-dropdown-menu');
            
            if (userMenuToggle && userDropdown) {
                userMenuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = userDropdown.style.display === 'none';
                    userDropdown.style.display = isHidden ? 'block' : 'none';
                });

                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.style.display = 'none';
                    }
                });
            }

            // Bot√≥n de configuraci√≥n en header
            const headerConfigBtn = document.getElementById('header-config-btn');
            if (headerConfigBtn) {
                headerConfigBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSection('config');
                    if (userDropdown) userDropdown.style.display = 'none';
                });
            }

            // Bot√≥n de cerrar sesi√≥n en header
            const headerLogoutBtn = document.getElementById('header-logout-btn');
            console.log('üîç Buscando bot√≥n logout:', headerLogoutBtn);
            
            if (headerLogoutBtn) {
                console.log('‚úÖ Bot√≥n logout encontrado, agregando listener');
                
                // Remover listeners previos si existen
                const newLogoutBtn = headerLogoutBtn.cloneNode(true);
                headerLogoutBtn.parentNode.replaceChild(newLogoutBtn, headerLogoutBtn);
                
                newLogoutBtn.addEventListener('click', async (e) => {
                    console.log('üñ±Ô∏è Click en bot√≥n logout detectado');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Cerrar el dropdown
                    const dropdown = document.getElementById('user-dropdown-menu');
                    if (dropdown) {
                        console.log('üîΩ Cerrando dropdown');
                        dropdown.style.display = 'none';
                    }
                    
                    console.log('üí¨ Mostrando confirm');
                    if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                        console.log('‚úÖ Usuario confirm√≥ logout');
                        try {
                            await window.supabase.auth.signOut();
                            console.log('‚úÖ Sesi√≥n cerrada, recargando...');
                            location.reload();
                        } catch (error) {
                            console.error('‚ùå Error al cerrar sesi√≥n:', error);
                            alert('Error al cerrar sesi√≥n. Recargando p√°gina...');
                            location.reload();
                        }
                    } else {
                        console.log('‚ùå Usuario cancel√≥ logout');
                    }
                });
                
                console.log('‚úÖ Listener de logout agregado correctamente');
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n header-logout-btn');
            }
        }

        // Funci√≥n para refrescar el selector de cuentas en el header
        function refreshAccountSelector() {
            const mainSelect = document.getElementById('main-account-select');
            if (!mainSelect) {
                console.error('‚ùå main-account-select no encontrado');
                return;
            }

            console.log('üîÑ Refrescando selector. DB.accounts:', DB.accounts.length);

            // Obtener valor seleccionado actual
            const currentValue = mainSelect.value;

            // Remover solo las opciones de cuentas, NO el placeholder
            const options = Array.from(mainSelect.querySelectorAll('option'));
            options.forEach((opt, index) => {
                if (index > 0) { // Mantener el primer option (placeholder)
                    opt.remove();
                }
            });

            // Agregar cuentas actualizadas
            DB.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                option.setAttribute('data-platform', account.platform);
                mainSelect.appendChild(option);
            });

            // Restaurar selecci√≥n si existe
            if (currentValue && DB.accounts.find(a => a.id === currentValue)) {
                mainSelect.value = currentValue;
            }

            console.log('‚úÖ Selector refrescado:', mainSelect.options.length - 1, 'cuentas');
        }

        function initMainHeaderOld() {
            // C√≥digo original movido arriba, esta funci√≥n ya no se usa
            // La dejamos por compatibilidad pero initMainHeader ahora solo inicializa una vez
            const mainSelect = document.getElementById('main-account-select');
            if (!mainSelect) return;

            // Event listener para cambio de cuenta principal
            mainSelect.addEventListener('change', function() {
                const selectedAccount = this.value;
                console.log('üéØ [MAIN SELECTOR] Account changed to:', selectedAccount);

                if (selectedAccount === '') {
                    // No hay cuenta seleccionada
                    globalSelectedAccount = 'all';
                } else {
                    globalSelectedAccount = selectedAccount;
                }

                // Actualizar logo del selector principal
                updateSelectorLogo('main-account-select');

                // Sincronizar con TODOS los selectores de cuenta
                const selectors = [
                    'dashboard-account-select',
                    'analytics-account-select',
                    'informe-account-select',
                    'daily-journal-account-select',
                    'calendar-account-select',
                    'equity-account-select',
                    'filter-account',
                    'chartbook-account-select'
                ];

                selectors.forEach(selectorId => {
                    const selectElement = document.getElementById(selectorId);
                    if (selectElement) {
                        if (selectedAccount === '') {
                            selectElement.value = 'all';
                        } else {
                            selectElement.value = selectedAccount;
                        }
                        updateSelectorLogo(selectorId);
                    }
                });

                // Refrescar la secci√≥n activa
                refreshCurrentSection();
                
                // Si estamos en Informe, tambi√©n refrescar la subsecci√≥n activa
                const activeSection = document.querySelector('.section-container.active');
                if (activeSection && activeSection.id === 'informe') {
                    console.log('üîÑ [MAIN SELECTOR] Refreshing active Informe subsection...');
                    const activeSubTab = document.querySelector('.informe-sub-tab.active');
                    if (activeSubTab) {
                        const targetId = activeSubTab.dataset.target;
                        console.log('üîÑ [MAIN SELECTOR] Active subsection:', targetId);
                        
                        setTimeout(() => {
                            switch (targetId) {
                                case 'informe-informes-content':
                                    refreshInforme();
                                    break;
                                case 'informe-metricas-content':
                                    refreshMetricas();
                                    break;
                                case 'informe-metricas-avanzadas-content':
                                    refreshMetricasAvanzadas();
                                    break;
                                case 'informe-simbolos-content':
                                    refreshSimbolos();
                                    break;
                                case 'informe-tiempo-content':
                                    refreshTiempo();
                                    break;
                                case 'informe-graficos-content':
                                    if (typeof window.refreshGraficosCharts === 'function') {
                                        window.refreshGraficosCharts();
                                    }
                                    break;
                                case 'informe-comisiones-content':
                                    if (typeof window.refreshComisiones === 'function') {
                                        window.refreshComisiones();
                                    }
                                    break;
                            }
                        }, 50);
                    }
                }
            });

            // Toggle del men√∫ de usuario
            const userMenuToggle = document.getElementById('user-menu-toggle');
            const userDropdown = document.getElementById('user-dropdown-menu');
            
            if (userMenuToggle && userDropdown) {
                userMenuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = userDropdown.style.display === 'none';
                    userDropdown.style.display = isHidden ? 'block' : 'none';
                });

                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.style.display = 'none';
                    }
                });
            }

            // Bot√≥n de configuraci√≥n en header
            const headerConfigBtn = document.getElementById('header-config-btn');
            if (headerConfigBtn) {
                headerConfigBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSection('config');
                    if (userDropdown) userDropdown.style.display = 'none';
                });
            }

            // Bot√≥n de cerrar sesi√≥n en header
            const headerLogoutBtn = document.getElementById('header-logout-btn');
            console.log('üîç Buscando bot√≥n logout:', headerLogoutBtn);
            
            if (headerLogoutBtn) {
                console.log('‚úÖ Bot√≥n logout encontrado, agregando listener');
                
                // Remover listeners previos si existen
                const newLogoutBtn = headerLogoutBtn.cloneNode(true);
                headerLogoutBtn.parentNode.replaceChild(newLogoutBtn, headerLogoutBtn);
                
                newLogoutBtn.addEventListener('click', async (e) => {
                    console.log('üñ±Ô∏è Click en bot√≥n logout detectado');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Cerrar el dropdown
                    const dropdown = document.getElementById('user-dropdown-menu');
                    if (dropdown) {
                        console.log('üîΩ Cerrando dropdown');
                        dropdown.style.display = 'none';
                    }
                    
                    console.log('üí¨ Mostrando confirm');
                    if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                        console.log('‚úÖ Usuario confirm√≥ logout');
                        try {
                            await window.supabase.auth.signOut();
                            console.log('‚úÖ Sesi√≥n cerrada, recargando...');
                            location.reload();
                        } catch (error) {
                            console.error('‚ùå Error al cerrar sesi√≥n:', error);
                            alert('Error al cerrar sesi√≥n. Recargando p√°gina...');
                            location.reload();
                        }
                    } else {
                        console.log('‚ùå Usuario cancel√≥ logout');
                    }
                });
                
                console.log('‚úÖ Listener de logout agregado correctamente');
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n header-logout-btn');
            }

            // No actualizar logo al iniciar - debe estar oculto hasta que se seleccione una cuenta
        }

        // ===== FUNCI√ìN GLOBAL PARA ACTUALIZAR HEADER DEL USUARIO =====
        window.updateUserHeader = function() {
            const headerEmail = document.getElementById('header-user-email');
            const headerAvatar = document.getElementById('header-user-avatar');
            
            if (!currentUser) {
                console.log('‚ö†Ô∏è updateUserHeader: currentUser no disponible');
                return;
            }
            
            console.log('üîÑ Actualizando header del usuario:', currentUser.email);
            
            // Actualizar email
            if (headerEmail) {
                headerEmail.textContent = currentUser.email;
                console.log('‚úÖ Email actualizado:', currentUser.email);
            }
            
            // Actualizar avatar con foto de perfil desde localStorage
            if (headerAvatar) {
                const profileImage = localStorage.getItem('profile-image');
                if (profileImage) {
                    headerAvatar.innerHTML = `<img src="${profileImage}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    console.log('‚úÖ Avatar actualizado con foto de perfil');
                } else if (currentUser.email) {
                    headerAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
                    console.log('‚úÖ Avatar actualizado con inicial:', currentUser.email.charAt(0).toUpperCase());
                }
            }
        };

        // ===== SOCIAL MEDIA SECTION =====
        // Variables globales para Social Media
        let socialMediaTimeframe = 'all';
        let publicTraders = [];
        let settingsLoaded = false; // Flag para evitar m√∫ltiples cargas

        // Inicializar secci√≥n Social Media
        function initSocialMedia() {
            console.log('üåê Iniciando Social Media...');
            
            // Event listeners para botones de timeframe
            const timeframeButtons = [
                document.getElementById('social-media-timeframe-1m'),
                document.getElementById('social-media-timeframe-3m'),
                document.getElementById('social-media-timeframe-1y'),
                document.getElementById('social-media-timeframe-all')
            ].filter(btn => btn !== null);
            
            timeframeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover estilos de todos los botones
                    timeframeButtons.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-surface-light', 'hover:bg-surface', 'border', 'border-border');
                    });
                    // Agregar estilo activo al bot√≥n clickeado
                    this.classList.remove('bg-surface-light', 'hover:bg-surface', 'border', 'border-border');
                    this.classList.add('bg-primary', 'text-white');
                    
                    // Actualizar timeframe desde ID del bot√≥n
                    const btnId = this.id.replace('social-media-timeframe-', '');
                    socialMediaTimeframe = btnId;
                    console.log(`üìÖ Timeframe cambiado a: ${socialMediaTimeframe}`);
                    
                    // Recargar leaderboard con nuevo timeframe
                    refreshSocialMediaLeaderboard();
                });
            });
            
            // Cargar traders p√∫blicos al iniciar
            loadPublicTraders();
        }

        // Cargar traders con perfil p√∫blico desde Supabase
        async function loadPublicTraders() {
            console.log('üë• Cargando traders p√∫blicos...');
            
            try {
                // Obtener usuarios con perfil p√∫blico
                const { data: publicUsers, error: usersError } = await supabase
                    .from('user_settings')
                    .select('user_id, username, country, is_public')
                    .eq('is_public', true);
                
                if (usersError) {
                    console.error('‚ùå Error al cargar usuarios p√∫blicos:', usersError);
                    return;
                }
                
                if (!publicUsers || publicUsers.length === 0) {
                    console.log('‚ÑπÔ∏è No hay traders con perfil p√∫blico a√∫n');
                    publicTraders = [];
                    refreshSocialMediaLeaderboard();
                    return;
                }
                
                console.log(`‚úÖ ${publicUsers.length} traders p√∫blicos encontrados`);
                
                // Para cada usuario, obtener sus estad√≠sticas
                const tradersWithStats = await Promise.all(publicUsers.map(async (user) => {
                    try {
                        // Obtener cuenta seleccionada en Audici√≥n
                        const audicionSelect = document.getElementById('audicion-account-select');
                        const selectedAccount = audicionSelect ? audicionSelect.value : 'all';
                        
                        // Obtener operaciones del usuario
                        let query = supabase
                            .from('operations')
                            .select('*')
                            .eq('user_id', user.user_id);
                        
                        // Filtrar por cuenta si no es 'all'
                        if (selectedAccount && selectedAccount !== 'all') {
                            query = query.eq('account_id', selectedAccount);
                        }
                        
                        const { data: operations, error: opsError } = await query;
                        
                        if (opsError || !operations) {
                            console.error(`‚ùå Error al cargar operaciones de ${user.username}:`, opsError);
                            return null;
                        }
                        
                        // Filtrar por timeframe
                        const filteredOps = filterOperationsByTimeframe(operations, socialMediaTimeframe);
                        
                        // Calcular estad√≠sticas
                        const stats = calculateTraderStats(filteredOps);
                        
                        return {
                            ...user,
                            ...stats,
                            totalTrades: filteredOps.length
                        };
                    } catch (error) {
                        console.error(`‚ùå Error procesando trader ${user.username}:`, error);
                        return null;
                    }
                }));
                
                // Filtrar traders sin datos y ordenar por beneficio
                publicTraders = tradersWithStats
                    .filter(t => t !== null)
                    .sort((a, b) => b.totalProfit - a.totalProfit);
                
                console.log('üìä Traders con estad√≠sticas:', publicTraders);
                
                // Actualizar leaderboard
                refreshSocialMediaLeaderboard();
                
            } catch (error) {
                console.error('‚ùå Error en loadPublicTraders:', error);
            }
        }

        // Filtrar operaciones por timeframe
        function filterOperationsByTimeframe(operations, timeframe) {
            if (timeframe === 'all') return operations;
            
            const now = new Date();
            let cutoffDate;
            
            switch(timeframe) {
                case '1m':
                    cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 d√≠as
                    break;
                case '3m':
                    cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000); // 90 d√≠as
                    break;
                case '1y':
                    cutoffDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000); // 365 d√≠as
                    break;
                default:
                    return operations;
            }
            
            return operations.filter(op => {
                const opDate = new Date(op.date);
                return opDate >= cutoffDate;
            });
        }

        // Calcular estad√≠sticas de un trader
        function calculateTraderStats(operations) {
            if (!operations || operations.length === 0) {
                return {
                    totalProfit: 0,
                    avgWinRate: 0,
                    winningTrades: 0,
                    losingTrades: 0,
                    avgProfit: 0
                };
            }
            
            const totalProfit = operations.reduce((sum, op) => sum + (parseFloat(op.pl) || 0), 0);
            const winningTrades = operations.filter(op => parseFloat(op.pl) > 0).length;
            const losingTrades = operations.filter(op => parseFloat(op.pl) < 0).length;
            const winRate = operations.length > 0 ? (winningTrades / operations.length) * 100 : 0;
            const avgProfit = totalProfit / operations.length;
            
            return {
                totalProfit,
                avgWinRate: winRate,
                winningTrades,
                losingTrades,
                avgProfit
            };
        }

        // Actualizar tabla del leaderboard
        function refreshSocialMediaLeaderboard() {
            console.log('üîÑ Actualizando leaderboard...');
            
            const tbody = document.getElementById('social-media-tbody');
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el tbody del leaderboard');
                return;
            }
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            // Si no hay traders, mostrar mensaje
            if (!publicTraders || publicTraders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">No hay traders p√∫blicos a√∫n</div>
                            <div style="font-size: 14px;">Activa tu perfil p√∫blico en Configuraci√≥n para aparecer aqu√≠</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Renderizar cada trader
            publicTraders.forEach((trader, index) => {
                const rank = index + 1;
                const stars = getStarsForProfit(trader.totalProfit);
                const profitColor = trader.totalProfit >= 0 ? '#10B981' : '#DC2626';
                const winRateColor = trader.avgWinRate >= 50 ? '#10B981' : '#DC2626';
                
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.dataset.userId = trader.user_id;
                
                // Generar contenido del avatar (foto o iniciales)
                let avatarContent;
                // Si es el usuario actual, intentar cargar su foto
                if (currentUser && trader.user_id === currentUser.id) {
                    const profileImage = localStorage.getItem('profile-image');
                    if (profileImage) {
                        avatarContent = `<img src="${profileImage}" alt="${trader.username}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    } else {
                        avatarContent = getInitials(trader.username);
                    }
                } else {
                    avatarContent = getInitials(trader.username);
                }
                
                row.innerHTML = `
                    <td style="font-weight: 600; text-align: center;">#${rank}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="trader-avatar">${avatarContent}</div>
                            <div class="trader-info">
                                <div style="font-weight: 600; margin-bottom: 2px;">${trader.username}</div>
                                <div style="font-size: 12px; color: #888;">${getFlagEmoji(trader.country)} ${trader.country || 'Global'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="color: ${profitColor}; font-weight: 600; text-align: center;">
                        ${trader.totalProfit >= 0 ? '+' : ''}$${trader.totalProfit.toFixed(2)}
                    </td>
                    <td style="color: ${profitColor}; font-weight: 500; text-align: center;">
                        ${trader.totalProfit >= 0 ? '+' : ''}${((trader.avgProfit || 0)).toFixed(2)}%
                    </td>
                    <td style="color: ${winRateColor}; font-weight: 500; text-align: center;">
                        ${trader.avgWinRate.toFixed(1)}%
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>${trader.totalTrades}</span>
                            <span style="color: #fbbf24;">${stars}</span>
                        </div>
                    </td>
                `;
                
                // Click handler para ver audici√≥n del trader
                row.addEventListener('click', () => handleTraderProfileClick(trader));
                
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Leaderboard actualizado con ${publicTraders.length} traders`);
        }

        // Obtener estrellas seg√∫n el beneficio
        function getStarsForProfit(profit) {
            if (profit >= 10000) return '‚≠ê‚≠ê‚≠ê';
            if (profit >= 5000) return '‚≠ê‚≠ê';
            if (profit >= 1000) return '‚≠ê';
            return '';
        }

        // Obtener iniciales del nombre de usuario
        function getInitials(username) {
            if (!username) return '??';
            const parts = username.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return username.substring(0, 2).toUpperCase();
        }

        // Obtener emoji de bandera seg√∫n pa√≠s
        function getFlagEmoji(country) {
            const flags = {
                'Espa√±a': 'üá™üá∏',
                'M√©xico': 'üá≤üáΩ',
                'Argentina': 'üá¶üá∑',
                'Colombia': 'üá®üá¥',
                'Chile': 'üá®üá±',
                'Per√∫': 'üáµüá™',
                'Venezuela': 'üáªüá™',
                'Ecuador': 'üá™üá®',
                'Uruguay': 'üá∫üáæ',
                'Paraguay': 'üáµüáæ',
                'Bolivia': 'üáßüá¥',
                'Costa Rica': 'üá®üá∑',
                'Panam√°': 'üáµüá¶',
                'Rep√∫blica Dominicana': 'üá©üá¥',
                'Puerto Rico': 'üáµüá∑',
                'Guatemala': 'üá¨üáπ',
                'Honduras': 'üá≠üá≥',
                'El Salvador': 'üá∏üáª',
                'Nicaragua': 'üá≥üáÆ',
                'Cuba': 'üá®üá∫',
                'Estados Unidos': 'üá∫üá∏',
                'Brasil': 'üáßüá∑',
                'Portugal': 'üáµüáπ',
                'Otro': 'üåé'
            };
            return flags[country] || 'üåé';
        }

        // Manejar click en perfil de trader
        async function handleTraderProfileClick(trader) {
            console.log('üë§ Ver perfil de:', trader.username);
            
            // Cambiar a la secci√≥n de Audici√≥n
            showSection('audicion');
            
            // Cargar datos de audici√≥n del trader seleccionado
            try {
                const { data: operations, error } = await supabase
                    .from('operations')
                    .select('*')
                    .eq('user_id', trader.user_id)
                    .order('date', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error al cargar operaciones del trader:', error);
                    showNotification('Error al cargar datos del trader', 'error');
                    return;
                }
                
                console.log(`‚úÖ ${operations.length} operaciones cargadas para ${trader.username}`);
                
                // Actualizar t√≠tulo de audici√≥n
                const audicionTitle = document.querySelector('#audicion h1');
                if (audicionTitle) {
                    audicionTitle.innerHTML = `Audici√≥n P√∫blica - ${trader.username} ${getFlagEmoji(trader.country)}`;
                }
                
                // Actualizar m√©tricas de audici√≥n con datos del trader
                if (typeof updateAudicionMetrics === 'function') {
                    const stats = calculateTraderStats(operations);
                    updateAudicionMetrics({
                        totalTrades: operations.length,
                        winRate: stats.avgWinRate,
                        totalProfit: stats.totalProfit,
                        avgWin: stats.avgProfit,
                        winningDays: stats.winningTrades,
                        losingDays: stats.losingTrades
                    });
                }
                
                // Actualizar gr√°fico con operaciones del trader
                if (typeof updateAudicionWeeklyChartFromOps === 'function') {
                    updateAudicionWeeklyChartFromOps(operations);
                }
                
                showNotification(`Viendo audici√≥n de ${trader.username}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error en handleTraderProfileClick:', error);
                showNotification('Error al cargar perfil del trader', 'error');
            }
        }

        // Guardar configuraci√≥n de perfil p√∫blico del usuario
        async function saveUserPublicSettings() {
            console.log('üíæ Guardando configuraci√≥n de perfil p√∫blico...');
            
            try {
                const countrySelect = document.getElementById('config-user-country');
                const publicToggle = document.getElementById('config-public-profile');
                
                if (!countrySelect || !publicToggle) {
                    console.error('‚ùå No se encontraron los campos de configuraci√≥n');
                    return;
                }
                
                const country = countrySelect.value;
                const isPublic = publicToggle.checked;
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('‚ùå No hay usuario autenticado');
                    return;
                }
                
                // Obtener o crear username
                let username = document.getElementById('config-username')?.value || user.email.split('@')[0];
                
                // Actualizar en Supabase
                const { data, error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: user.id,
                        username: username,
                        country: country,
                        is_public: isPublic,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                
                if (error) {
                    console.error('‚ùå Error al guardar configuraci√≥n:', error);
                    showNotification('Error al guardar configuraci√≥n', 'error');
                    return;
                }
                
                console.log('‚úÖ Configuraci√≥n de perfil guardada correctamente');
                
                // Actualizar header del usuario
                updateUserHeader();
                
                // Si el usuario activ√≥ el perfil p√∫blico, recargar leaderboard
                if (isPublic) {
                    setTimeout(() => {
                        if (typeof loadPublicTraders === 'function') {
                            loadPublicTraders();
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('‚ùå Error en saveUserPublicSettings:', error);
                showNotification('Error al guardar configuraci√≥n', 'error');
            }
        }

        // Cargar configuraci√≥n de perfil p√∫blico al abrir configuraci√≥n
        async function loadUserPublicSettings() {
            // Evitar m√∫ltiples cargas
            if (settingsLoaded) {
                console.log('‚è≠Ô∏è Configuraci√≥n ya cargada, saltando...');
                return;
            }
            
            console.log('üìÇ Cargando configuraci√≥n de perfil p√∫blico...');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                
                const { data: settings, error } = await supabase
                    .from('user_settings')
                    .select('country, is_public')
                    .eq('user_id', user.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
                    console.error('‚ùå Error al cargar configuraci√≥n:', error);
                    return;
                }
                
                if (settings) {
                    const countrySelect = document.getElementById('config-user-country');
                    const publicToggle = document.getElementById('config-public-profile');
                    const publicLabel = document.getElementById('config-public-profile-label');
                    
                    if (countrySelect && settings.country) {
                        countrySelect.value = settings.country;
                    }
                    
                    if (publicToggle) {
                        publicToggle.checked = settings.is_public || false;
                        
                        // Actualizar label del toggle
                        if (publicLabel) {
                            if (settings.is_public) {
                                publicLabel.textContent = 'Perfil P√∫blico';
                                publicLabel.style.color = '#10B981';
                            } else {
                                publicLabel.textContent = 'Perfil Privado';
                                publicLabel.style.color = '#6B7280';
                            }
                        }
                    }
                    
                    settingsLoaded = true; // Marcar como cargado
                    console.log('‚úÖ Configuraci√≥n de perfil cargada');
                }
                
            } catch (error) {
                console.error('‚ùå Error en loadUserPublicSettings:', error);
            }
        }
        // ===== END SOCIAL MEDIA SECTION =====

        // ===== FUNCI√ìN PARA INICIALIZAR PLATAFORMAS =====
        function initPlatforms() {
            console.log('üöÄ Iniciando initPlatforms...');
            
            // Event listeners para las tarjetas de plataformas
            const platformCards = document.querySelectorAll('.platform-card:not(.disabled)');
            console.log('üì± Tarjetas encontradas:', platformCards.length);
            
            platformCards.forEach(card => {
                const platform = card.dataset.platform;
                console.log('üîó Agregando listener a:', platform);
                
                card.addEventListener('click', function() {
                    console.log('üéØ Click en plataforma:', platform);
                    
                    // Mostrar la secci√≥n espec√≠fica de cada plataforma
                    if (platform === 'bingx') {
                        showSection('platform-bingx');
                        // Cargar credenciales de BingX
                        if (typeof loadBingXCredentials === 'function') {
                            loadBingXCredentials();
                            loadBingXCredentialsInDetail();
                        }
                        if (typeof populateBingXAccounts === 'function') {
                            populateBingXAccounts();
                        }
                    } else if (platform === 'bitget') {
                        showSection('platform-bitget');
                        console.log('üéØ Abriendo secci√≥n Bitget - recargando credenciales');
                        
                        // Cargar credenciales de Bitget usando acceso global
                        if (typeof window.loadBitgetCredentials === 'function') {
                            window.loadBitgetCredentials()
                                .then(() => {
                                    if (typeof window.populateBitgetAccountSelect === 'function') {
                                        window.populateBitgetAccountSelect();
                                    }
                                })
                                .catch((error) => {
                                    console.error('‚ùå Error en loadBitgetCredentials:', error);
                                });
                            
                            // Recarga adicional con delay para asegurar que los campos est√©n listos
                            setTimeout(async () => {
                                try {
                                    await window.loadBitgetCredentials();
                                    if (typeof window.populateBitgetAccountSelect === 'function') {
                                        window.populateBitgetAccountSelect();
                                    }
                                } catch (error) {
                                    console.error('‚ùå Error en recarga:', error);
                                }
                            }, 500);
                        }
                    } else if (platform === 'mexc') {
                        showSection('platform-mexc');
                        console.log('üéØ Abriendo secci√≥n MEXC');
                        // Cargar credenciales de MEXC
                        if (typeof loadMEXCCredentials === 'function') {
                            loadMEXCCredentials().catch(err => {
                                console.error('Error cargando credenciales MEXC:', err);
                            });
                        }
                        if (typeof populateMEXCAccountSelect === 'function') {
                            populateMEXCAccountSelect();
                        }
                    } else if (platform === 'tradingview') {
                        showSection('platform-tradingview');
                    } else if (platform === 'ninjatrader') {
                        showSection('platform-ninjatrader');
                    } else if (platform === 'tradovate') {
                        showSection('platform-tradovate');
                    } else if (platform === 'ctrader') {
                        showSyncNotification('‚úÖ cTrader: Usa el bot√≥n HTML para importar operaciones', 'info');
                    } else if (platform === 'primexbtcrypto') {
                        showSyncNotification('PrimeXBT Crypto: Usa los botones CSV o Interfaz para importar operaciones', 'info');
                    } else if (platform === 'primexbtcfds') {
                        showSyncNotification('PrimeXBT CFDs: Usa el bot√≥n CSV para importar operaciones', 'info');
                    } else if (platform === 'metatrader5') {
                        showSyncNotification('MetaTrader 5: Usa el bot√≥n HTML para importar operaciones', 'info');
                    } else {
                        showSyncNotification('Esta plataforma estar√° disponible pr√≥ximamente', 'info');
                    }
                });
            });

            console.log('‚úÖ initPlatforms completado');
            
            // Inicializar botones CSV de las plataformas
            initCSVButtons();
            
            // Inicializar tabs de plataformas
            if (typeof initPlatformTabs === 'function') {
                initPlatformTabs();
            }

            // Bot√≥n de regreso a plataformas (funciona para todas las plataformas)
            const backButtons = document.querySelectorAll('[id^="back-to-platforms"]');
            backButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    showSection('platforms');
                });
            });
        }

        // ===== FUNCI√ìN PARA INICIALIZAR BOTONES CSV =====
        function initCSVButtons() {
            console.log('üìÑ Inicializando botones CSV...');
            
            // BingX CSV
            const bingxCsvBtn = document.getElementById('bingx-import-csv');
            if (bingxCsvBtn) {
                bingxCsvBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processBingXCSV === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processBingXCSV(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ BingX CSV');
            }
            
            // Bitget CSV
            const bitgetCsvBtn = document.getElementById('bitget-import-csv');
            if (bitgetCsvBtn) {
                bitgetCsvBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processBitgetCSV === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processBitgetCSV(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ Bitget CSV');
            }
            
            // MEXC CSV
            const mexcCsvBtn = document.getElementById('mexc-import-csv');
            if (mexcCsvBtn) {
                mexcCsvBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processMEXCCSV === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processMEXCCSV(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ MEXC CSV');
            }
            
            // PrimeXBT Crypto CSV
            const primexbtCryptoBtn = document.getElementById('primexbt-crypto-import-csv');
            if (primexbtCryptoBtn) {
                primexbtCryptoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processPrimeXBTCSV === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processPrimeXBTCSV(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ PrimeXBT Crypto CSV');
            }
            
            // PrimeXBT Crypto Interfaz
            const primexbtCryptoInterfaceBtn = document.getElementById('primexbt-crypto-import-interface');
            if (primexbtCryptoInterfaceBtn) {
                primexbtCryptoInterfaceBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('üéØ Click en bot√≥n Interfaz PrimeXBT Crypto');
                    // Abrir modal directamente
                    const modal = document.getElementById('primexbt-interface-import-modal');
                    const accountSelect = document.getElementById('primexbt-interface-account');
                    const dataTextarea = document.getElementById('primexbt-interface-data');
                    const statusDiv = document.getElementById('primexbt-interface-status');
                    
                    if (modal && accountSelect && dataTextarea && statusDiv) {
                        // Limpiar campos
                        dataTextarea.value = '';
                        statusDiv.textContent = '';
                        statusDiv.className = 'text-sm text-center';
                        
                        // Cargar cuentas de PrimeXBT Crypto
                        accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';
                        const primexbtAccounts = DB.accounts.filter(acc => 
                            acc.platform === 'primexbt-crypto' || acc.platform === 'primexbt'
                        );
                        
                        if (primexbtAccounts.length === 0) {
                            accountSelect.innerHTML += '<option value="" disabled>No hay cuentas de PrimeXBT disponibles</option>';
                        } else {
                            primexbtAccounts.forEach(acc => {
                                const option = document.createElement('option');
                                option.value = acc.id;
                                option.textContent = `${acc.name} (${acc.currency})`;
                                accountSelect.appendChild(option);
                            });
                        }
                        
                        // Mostrar modal
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                        console.log('‚úÖ Modal abierto con', primexbtAccounts.length, 'cuentas');
                    } else {
                        console.error('‚ùå Elementos del modal no encontrados');
                    }
                });
                console.log('‚úÖ PrimeXBT Crypto Interface');
            }
            
            // PrimeXBT CFDs CSV
            const primexbtCfdsBtn = document.getElementById('primexbt-cfds-import-csv');
            if (primexbtCfdsBtn) {
                primexbtCfdsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processPrimeXBTCFDsCSV === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processPrimeXBTCFDsCSV(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ PrimeXBT CFDs CSV');
            }
            
            // MetaTrader 5 HTML
            const mt5HtmlBtn = document.getElementById('mt5-import-html');
            if (mt5HtmlBtn) {
                mt5HtmlBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.html,.htm';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processMT5HTMLReport === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processMT5HTMLReport(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ MetaTrader 5 HTML');
            }
            
            // cTrader HTML
            const ctraderHtmlBtn = document.getElementById('ctrader-import-html');
            if (ctraderHtmlBtn) {
                ctraderHtmlBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.html,.htm';
                    input.click();
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && typeof processCTraderHTML === 'function') {
                            const reader = new FileReader();
                            reader.onload = (ev) => processCTraderHTML(ev.target.result);
                            reader.readAsText(file);
                        }
                    };
                });
                console.log('‚úÖ cTrader HTML');
            }
            
            // ===== BOTONES DENTRO DE LAS SECCIONES DE PLATAFORMAS =====
            
            // BingX CSV (dentro de la secci√≥n)
            setTimeout(() => {
                const bingxCsvBtnInside = document.getElementById('bingx-import-csv-btn');
                const bingxCsvInput = document.getElementById('bingx-csv-file-input');
                if (bingxCsvBtnInside && bingxCsvInput) {
                    bingxCsvBtnInside.addEventListener('click', () => {
                        console.log('üéØ Click en bot√≥n CSV BingX dentro de secci√≥n');
                        bingxCsvInput.click();
                    });
                    bingxCsvInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        console.log('üìÑ Archivo seleccionado:', file.name);
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            try {
                                await processBingXCSV(ev.target.result);
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Error procesando CSV: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    });
                    console.log('‚úÖ BingX CSV section button');
                }
                
                // Bitget CSV (dentro de la secci√≥n)
                const bitgetCsvBtnInside = document.getElementById('bitget-import-csv-btn');
                const bitgetCsvInput = document.getElementById('bitget-csv-file-input');
                if (bitgetCsvBtnInside && bitgetCsvInput) {
                    bitgetCsvBtnInside.addEventListener('click', () => {
                        console.log('üéØ Click en bot√≥n CSV Bitget dentro de secci√≥n');
                        bitgetCsvInput.click();
                    });
                    bitgetCsvInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        console.log('üìÑ Archivo seleccionado:', file.name);
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            try {
                                await processBitgetCSV(ev.target.result);
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Error procesando CSV: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    });
                    console.log('‚úÖ Bitget CSV section button');
                }
                
                // MEXC CSV (dentro de la secci√≥n)
                const mexcCsvBtnInside = document.getElementById('mexc-import-csv-btn');
                const mexcCsvInput = document.getElementById('mexc-csv-file-input');
                if (mexcCsvBtnInside && mexcCsvInput) {
                    mexcCsvBtnInside.addEventListener('click', () => {
                        console.log('üéØ Click en bot√≥n CSV MEXC dentro de secci√≥n');
                        mexcCsvInput.click();
                    });
                    mexcCsvInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        console.log('üìÑ Archivo seleccionado:', file.name);
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            try {
                                await processMEXCCSV(ev.target.result);
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Error procesando CSV: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    });
                    console.log('‚úÖ MEXC CSV section button');
                }
            }, 500);
            
            console.log('‚úÖ Todos los botones CSV listos');
        }

        // ============================================
        // FUNCIONES PARA IMPORTAR DESDE INTERFAZ DE PRIMEXBT
        // ============================================
        
        /**
         * Procesa datos pegados desde la interfaz de PrimeXBT
         * @param {string} rawData - Datos copiados desde la interfaz del broker
         * @param {string} accountId - ID de la cuenta donde se importar√°n las operaciones
         */
        let isPrimeXBTProcessing = false; // Flag para evitar ejecuciones simult√°neas
        let lastPrimeXBTExecution = 0; // Timestamp de √∫ltima ejecuci√≥n
        
        window.processPrimeXBTInterfaceData = async function(rawData, accountId) {
            const now = Date.now();
            const executionId = Math.random().toString(36).substr(2, 9);
            console.log(`üìÑ [${executionId}] Procesando datos desde interfaz de PrimeXBT...`, { 
                timestamp: now, 
                isPrimeXBTProcessing,
                timeSinceLastExec: now - lastPrimeXBTExecution,
                stackTrace: new Error().stack
            });
            
            // Prevenir ejecuciones simult√°neas
            if (isPrimeXBTProcessing) {
                console.warn('‚ö†Ô∏è Ya hay un proceso de importaci√≥n en curso. Por favor espera.');
                showSyncNotification('‚ö†Ô∏è Ya hay una importaci√≥n en proceso', 'warning');
                return;
            }
            
            // Prevenir doble clic (ejecuciones con menos de 1 segundo de diferencia)
            if (now - lastPrimeXBTExecution < 1000) {
                console.warn('‚ö†Ô∏è Ejecuci√≥n duplicada detectada (< 1s). Ignorando.', {
                    timeSinceLastExec: now - lastPrimeXBTExecution
                });
                return;
            }
            
            isPrimeXBTProcessing = true;
            lastPrimeXBTExecution = now;
            console.log('üîí Flag de procesamiento activado', { timestamp: now });
            
            try {
                if (!rawData || !rawData.trim()) {
                    showSyncNotification('‚ùå No se proporcionaron datos para importar', 'error');
                    return;
                }

                if (!accountId) {
                    showSyncNotification('‚ùå Debes seleccionar una cuenta destino', 'error');
                    return;
                }

            // Buscar la cuenta seleccionada
            const account = DB.accounts.find(acc => acc.id === accountId);
            if (!account) {
                showSyncNotification('‚ùå Cuenta no encontrada', 'error');
                return;
            }

            // Primero, procesar el texto para manejar tabulaciones y m√∫ltiples valores por l√≠nea
            // Separar por tabulaciones y saltos de l√≠nea para obtener todos los campos
            const allFields = rawData
                .split(/[\n\t]+/)
                .map(field => field.trim())
                .filter(field => field && field !== '');
            
            console.log('üìã Total de campos detectados:', allFields.length);
            console.log('üìã Primeros 20 campos:', allFields.slice(0, 20));
            
            if (allFields.length < 10) {
                showSyncNotification('‚ùå Los datos parecen incompletos. Aseg√∫rate de copiar toda la informaci√≥n de las operaciones.', 'error');
                return;
            }

            const rawOperations = [];
            let fieldIndex = 0;
            let operationsCount = 0;
            let skippedOpsCount = 0;

            // Parsear los campos uno por uno
            while (fieldIndex < allFields.length) {
                try {
                    // Verificar si tenemos suficientes campos para una operaci√≥n completa (m√≠nimo 13)
                    if (fieldIndex + 12 >= allFields.length) {
                        console.warn('‚ö†Ô∏è No hay suficientes campos para completar m√°s operaciones');
                        break;
                    }

                    // Extraer los campos de la operaci√≥n
                    const operationId = allFields[fieldIndex] || '';
                    const instrument = (allFields[fieldIndex + 1] || '').replace('/', '');
                    const orderType = allFields[fieldIndex + 2] || '';
                    const action = (allFields[fieldIndex + 3] || '').toLowerCase();
                    const status = allFields[fieldIndex + 4] || '';
                    
                    // Limpiar volumen
                    let volumeStr = (allFields[fieldIndex + 5] || '0').trim();
                    volumeStr = volumeStr.replace(/\./g, '');
                    
                    const feesStr = allFields[fieldIndex + 6] || '0';
                    
                    let plStr = allFields[fieldIndex + 7] || '0';
                    let currentFieldOffset = 8;
                    
                    if (plStr === '‚Äî' || plStr === '-') {
                        plStr = '0';
                    }
                    
                    // Buscar campos que contengan la fecha
                    let dateFieldIndex = -1;
                    for (let i = fieldIndex + 7; i < Math.min(fieldIndex + 15, allFields.length); i++) {
                        if (allFields[i] && /\d{2}\/\d{2}\/\d{2}/.test(allFields[i])) {
                            dateFieldIndex = i;
                            break;
                        }
                    }
                    
                    if (dateFieldIndex === -1) {
                        console.warn(`‚ö†Ô∏è No se encontr√≥ fecha para operaci√≥n ${operationId}`);
                        skippedOpsCount++;
                        fieldIndex += 10;
                        continue;
                    }
                    
                    const priceStr = (allFields[dateFieldIndex - 1] || '0').replace(',', '.');
                    const dateTimeStr = allFields[dateFieldIndex] || '';

                    // Validar datos m√≠nimos
                    if (!operationId || !instrument || !dateTimeStr) {
                        console.warn(`‚ö†Ô∏è Operaci√≥n omitida (datos incompletos)`);
                        skippedOpsCount++;
                        fieldIndex += 10;
                        continue;
                    }

                    // Validar estado
                    if (status.toLowerCase() !== 'ejecutado') {
                        console.warn(`‚ö†Ô∏è Operaci√≥n ${operationId} omitida (estado: ${status})`);
                        skippedOpsCount++;
                        fieldIndex = dateFieldIndex + 1;
                        continue;
                    }

                    // Parsear volumen
                    const volume = parseFloat(volumeStr.replace(',', '.')) || 0;
                    if (volume === 0) {
                        console.warn(`‚ö†Ô∏è Operaci√≥n ${operationId} omitida (volumen inv√°lido: ${volumeStr})`);
                        skippedOpsCount++;
                        fieldIndex = dateFieldIndex + 1;
                        continue;
                    }

                    // Parsear comisiones
                    const feesMatch = feesStr.match(/[‚àí\-]?([\d,\.]+)/);
                    const fees = feesMatch ? Math.abs(parseFloat(feesMatch[1].replace(',', '.'))) : 0;

                    // Parsear P&L
                    let pl = 0;
                    if (plStr && plStr !== '‚Äî' && plStr !== '-') {
                        const plMatch = plStr.match(/([+\-‚àí]?[\d,\.]+)/);
                        if (plMatch) {
                            pl = parseFloat(plMatch[1].replace(',', '.').replace('‚àí', '-'));
                        }
                    }

                    // Parsear fecha y hora
                    const dateTimeParts = dateTimeStr.split(',').map(p => p.trim());
                    const dateParts = dateTimeParts[0].split('/');
                    const timePart = dateTimeParts[1] || '00:00:00';
                    
                    if (!dateParts || dateParts.length < 3) {
                        console.warn(`‚ö†Ô∏è Operaci√≥n ${operationId} omitida (fecha inv√°lida: ${dateTimeStr})`);
                        skippedOpsCount++;
                        fieldIndex = dateFieldIndex + 1;
                        continue;
                    }
                    
                    const day = (dateParts[0] || '01').toString().padStart(2, '0');
                    const month = (dateParts[1] || '01').toString().padStart(2, '0');
                    const year = '20' + (dateParts[2] || '25').toString();
                    const date = `${year}-${month}-${day}`;

                    // Determinar tipo y precios
                    let type = '';
                    let entry = 0;

                    const executionPrice = parseFloat(priceStr);
                    
                    if (!executionPrice || executionPrice === 0) {
                        console.warn(`‚ö†Ô∏è Operaci√≥n ${operationId} omitida (precio inv√°lido: ${priceStr})`);
                        skippedOpsCount++;
                        fieldIndex = dateFieldIndex + 1;
                        continue;
                    }

                    if (action.includes('comprar') || action.includes('buy')) {
                        type = 'buy';
                        entry = executionPrice;
                    } else if (action.includes('vender') || action.includes('sell')) {
                        type = 'sell';
                        entry = executionPrice;
                    } else {
                        console.warn(`‚ö†Ô∏è Tipo de operaci√≥n desconocido: ${action}`);
                        skippedOpsCount++;
                        fieldIndex = dateFieldIndex + 1;
                        continue;
                    }

                    // Crear operaci√≥n
                    const operation = {
                        accountId: accountId,
                        date: date,
                        entryTime: timePart,
                        exitTime: timePart,
                        instrument: instrument.toUpperCase(),
                        type: type,
                        entry: entry,
                        exit: null,
                        volume: volume,
                        currency: 'USDT',
                        fees: fees,
                        notes: `Importado desde interfaz - ${orderType} - ID: ${operationId}`,
                        imageDatas: [],
                        session: 'No especificado',
                        pl: pl,
                        result: pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven'),
                        manualPL: pl
                    };

                    operation.id = generateUnifiedOperationId(operation, 'primexbt-crypto', operationId, null);

                    if (operation.instrument && operation.type && operation.entry > 0) {
                        rawOperations.push(operation);
                        operationsCount++;
                    } else {
                        console.warn('‚ö†Ô∏è Operaci√≥n omitida por datos incompletos:', operation);
                        skippedOpsCount++;
                    }

                    fieldIndex = dateFieldIndex + 1;

                } catch (error) {
                    console.error('Error procesando operaci√≥n:', error);
                    skippedOpsCount++;
                    fieldIndex += 5;
                }
            }
            
            // Asignar IDs secuenciales
            rawOperations.forEach(op => {
                if (!op.id || op.id === '') {
                    op.id = getNextOperationId();
                }
            });

            if (rawOperations.length === 0) {
                showSyncNotification(`‚ùå No se pudieron procesar operaciones. ${skippedOpsCount} operaciones omitidas.`, 'error');
                return;
            }

            // Ordenar cronol√≥gicamente
            rawOperations.sort((a, b) => {
                const timeA = new Date(`${a.date} ${a.entryTime}`).getTime();
                const timeB = new Date(`${b.date} ${b.entryTime}`).getTime();
                return timeA - timeB;
            });

            // Combinar operaciones relacionadas
            const combinedOperations = [];
            const usedIndices = new Set();
            
            for (let i = 0; i < rawOperations.length; i++) {
                if (usedIndices.has(i)) continue;
                
                const op1 = rawOperations[i];
                const relatedClosings = [];
                let totalClosingVolume = 0;
                
                // Buscar cierres
                const maxJ = Math.min(i + 20, rawOperations.length);
                
                for (let j = i + 1; j < maxJ; j++) {
                    if (usedIndices.has(j)) continue;
                    
                    const op2 = rawOperations[j];
                    const sameInstrument = op1.instrument === op2.instrument;
                    const oppositeType = (op1.type === 'buy' && op2.type === 'sell') || 
                                        (op1.type === 'sell' && op2.type === 'buy');
                    
                    if (sameInstrument && oppositeType) {
                        const vol2 = parseFloat(op2.volume) || 0;
                        relatedClosings.push({ index: j, operation: op2 });
                        totalClosingVolume += vol2;
                    }
                }
                
                // Buscar hacia atr√°s si es necesario
                if (totalClosingVolume < op1.volume * 0.9) {
                    for (let j = i - 1; j >= Math.max(0, i - 20); j--) {
                        if (usedIndices.has(j)) continue;
                        
                        const op2 = rawOperations[j];
                        const sameInstrument = op1.instrument === op2.instrument;
                        const oppositeType = (op1.type === 'buy' && op2.type === 'sell') || 
                                            (op1.type === 'sell' && op2.type === 'buy');
                        
                        if (sameInstrument && oppositeType) {
                            relatedClosings.push({ index: j, operation: op2 });
                            totalClosingVolume += parseFloat(op2.volume) || 0;
                        }
                    }
                }
                
                if (relatedClosings.length > 0) {
                    const time1 = new Date(`${op1.date} ${op1.entryTime}`).getTime();
                    const firstClosingTime = new Date(`${relatedClosings[0].operation.date} ${relatedClosings[0].operation.entryTime}`).getTime();
                    
                    let openingOp, closingOps;
                    if (time1 <= firstClosingTime) {
                        openingOp = op1;
                        closingOps = relatedClosings;
                    } else {
                        continue;
                    }
                    
                    const isLong = openingOp.type === 'buy';
                    
                    let totalPL = openingOp.pl || 0;
                    let totalFees = openingOp.fee || openingOp.fees || 0;
                    
                    closingOps.forEach(closing => {
                        totalPL += closing.operation.pl || 0;
                        totalFees += closing.operation.fee || closing.operation.fees || 0;
                    });
                    
                    let weightedExitPrice = 0;
                    let totalExitVolume = 0;
                    
                    closingOps.forEach(closing => {
                        const closeOp = closing.operation;
                        weightedExitPrice += closeOp.entry * closeOp.volume;
                        totalExitVolume += closeOp.volume;
                    });
                    
                    const avgExitPrice = totalExitVolume > 0 ? weightedExitPrice / totalExitVolume : closingOps[0].operation.entry;
                    
                    let lastClosing = closingOps[0].operation;
                    let lastClosingTime = new Date(`${lastClosing.date} ${lastClosing.entryTime}`).getTime();
                    
                    closingOps.forEach(closing => {
                        const closeTime = new Date(`${closing.operation.date} ${closing.operation.entryTime}`).getTime();
                        if (closeTime > lastClosingTime) {
                            lastClosing = closing.operation;
                            lastClosingTime = closeTime;
                        }
                    });
                    
                    const finalExitPrice = lastClosing.entry;
                    const finalExitTime = lastClosing.entryTime;
                    
                    const partials = closingOps.map(closing => ({
                        price: closing.operation.entry,
                        volume: closing.operation.volume,
                        time: closing.operation.entryTime,
                        pl: closing.operation.pl || 0
                    })).sort((a, b) => {
                        const timeA = new Date(`2000-01-01 ${a.time}`).getTime();
                        const timeB = new Date(`2000-01-01 ${b.time}`).getTime();
                        return timeA - timeB;
                    });
                    
                    const operationId = getNextOperationId();
                    
                    const combinedOp = {
                        id: operationId,
                        accountId: openingOp.accountId,
                        date: openingOp.date,
                        entryTime: openingOp.entryTime,
                        exitTime: finalExitTime,
                        instrument: openingOp.instrument,
                        type: isLong ? 'buy' : 'sell',
                        entry: openingOp.entry,
                        exit: finalExitPrice,
                        volume: openingOp.volume,
                        currency: openingOp.currency,
                        fees: totalFees,
                        notes: `${openingOp.notes} | ${closingOps.length} cierre(s) parcial(es)`,
                        imageDatas: [],
                        session: 'No especificado',
                        pl: totalPL,
                        result: totalPL > 0 ? 'win' : (totalPL < 0 ? 'loss' : 'breakeven'),
                        manualPL: totalPL,
                        partials: partials,
                        hasPartials: true,
                        avgExitPrice: avgExitPrice
                    };
                    
                    combinedOp.id = getNextOperationId();
                    
                    combinedOperations.push(combinedOp);
                    usedIndices.add(i);
                    closingOps.forEach(closing => usedIndices.add(closing.index));
                } else {
                    op1.id = getNextOperationId();
                    combinedOperations.push(op1);
                    usedIndices.add(i);
                }
            }

            // Verificar duplicados (por ID y por datos)
            const newOperations = [];
            for (const op of combinedOperations) {
                // Verificar duplicado por ID
                const isDuplicateById = DB.operations.some(existingOp => existingOp.id === op.id);
                
                // Verificar duplicado por datos
                const isDuplicateByData = DB.operations.some(existingOp => 
                    existingOp.date === op.date &&
                    existingOp.instrument === op.instrument &&
                    existingOp.entryTime === op.entryTime &&
                    existingOp.type === op.type &&
                    Math.abs(existingOp.volume - op.volume) < 0.01
                );
                
                if (!isDuplicateById && !isDuplicateByData) {
                    newOperations.push(op);
                } else {
                    console.log(`‚ö†Ô∏è Operaci√≥n duplicada omitida: ${op.id} - ${op.instrument} ${op.date}`);
                }
            }
            const importedCount = newOperations.length;

            if (newOperations.length > 0) {
                try {
                    // PRIMERO: Guardar en IndexedDB
                    await dexieDB.operations.bulkAdd(newOperations);
                    console.log(`‚úÖ ${newOperations.length} operaciones guardadas en IndexedDB`);
                    
                    // SEGUNDO: Sincronizar con Supabase
                    if (currentUser) {
                        let successCount = 0;
                        let errorCount = 0;

                        for (const operation of newOperations) {
                            try {
                                await saveOperationToSupabase(operation);
                                successCount++;
                            } catch (error) {
                                console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                                addToSyncQueue(operation, 'operation');
                                errorCount++;
                            }
                        }
                        console.log(`‚úÖ ${successCount} operaciones sincronizadas con Supabase`);
                    }
                    
                    // TERCERO: A√±adir a DB.operations EN MEMORIA (solo despu√©s de guardar exitosamente)
                    // Verificar nuevamente para evitar duplicados en caso de recargas
                    for (const op of newOperations) {
                        const exists = DB.operations.some(existingOp => existingOp.id === op.id);
                        if (!exists) {
                            DB.operations.push(op);
                        }
                    }
                    console.log(`‚úÖ ${newOperations.length} operaciones procesadas en DB.operations`);

                    updateAccountBalances();
                    refreshAllViews();
                    
                    showSyncNotification(`‚úÖ Se importaron ${importedCount} operaciones desde la interfaz de PrimeXBT. ${skippedOpsCount} omitidas.`, 'success');

                    document.getElementById('primexbt-interface-import-modal').classList.add('hidden');
                    document.getElementById('primexbt-interface-import-modal').classList.remove('flex');
                    document.getElementById('primexbt-interface-data').value = '';

                } catch (error) {
                    console.error('‚ùå Error guardando operaciones:', error);
                    showSyncNotification('‚ùå Error guardando operaciones importadas', 'error');
                }
            } else {
                showSyncNotification('‚ÑπÔ∏è No se encontraron operaciones nuevas para importar', 'info');
            }
            
            } finally {
                // Siempre resetear el flag al terminar
                isPrimeXBTProcessing = false;
                console.log('üîì Flag de procesamiento liberado');
            }
        };
        
        console.log('‚úÖ Funci√≥n processPrimeXBTInterfaceData cargada y disponible globalmente');

        // Handler para el bot√≥n de importar
        let isHandlerExecuting = false; // Segundo nivel de protecci√≥n
        
        window.handlePrimeXBTInterfaceImport = async function() {
            const now = Date.now();
            console.log('üéØ [v2.0-NETLIFY] handlePrimeXBTInterfaceImport ejecutado', { 
                timestamp: now,
                isHandlerExecuting 
            });
            
            // Protecci√≥n contra doble ejecuci√≥n
            if (isHandlerExecuting) {
                console.warn('‚ö†Ô∏è handlePrimeXBTInterfaceImport ya est√° ejecut√°ndose. Ignorando.');
                return;
            }
            
            isHandlerExecuting = true;
            
            try {
                const accountSelect = document.getElementById('primexbt-interface-account');
                const dataTextarea = document.getElementById('primexbt-interface-data');
                const statusDiv = document.getElementById('primexbt-interface-status');
                const primexbtInterfaceImportBtn = document.getElementById('primexbt-interface-import-btn');
                
                const accountId = accountSelect.value;
                const rawData = dataTextarea.value.trim();
                
                // Validar datos
                if (!accountId) {
                    statusDiv.textContent = '‚ùå Debes seleccionar una cuenta destino';
                    statusDiv.className = 'text-sm text-center text-red';
                    return;
                }
                
                if (!rawData) {
                    statusDiv.textContent = '‚ùå Debes pegar los datos de las operaciones';
                    statusDiv.className = 'text-sm text-center text-red';
                    return;
                }
                
                // Prevenir m√∫ltiples clics mientras procesa
                if (primexbtInterfaceImportBtn.disabled) {
                    console.log('‚ö†Ô∏è Ya hay una importaci√≥n en proceso (bot√≥n deshabilitado)');
                    return;
                }
                
                // Mostrar indicador de procesamiento
                statusDiv.textContent = '‚è≥ Procesando operaciones...';
                statusDiv.className = 'text-sm text-center text-yellow';
                primexbtInterfaceImportBtn.disabled = true;
                primexbtInterfaceImportBtn.textContent = 'Procesando...';
                
                try {
                    // Verificar que la funci√≥n est√© disponible
                    if (typeof window.processPrimeXBTInterfaceData !== 'function') {
                        console.error('‚ùå La funci√≥n processPrimeXBTInterfaceData NO est√° definida');
                        throw new Error('Error de carga. Por favor recarga la p√°gina (Ctrl+Shift+R).');
                    }
                    
                    console.log('‚úÖ Funci√≥n encontrada, procesando datos...');
                    await window.processPrimeXBTInterfaceData(rawData, accountId);
                    
                    // Restablecer bot√≥n
                    primexbtInterfaceImportBtn.disabled = false;
                    primexbtInterfaceImportBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Importar Operaciones';
                    
                } catch (error) {
                    console.error('Error al importar:', error);
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                    statusDiv.className = 'text-sm text-center text-red';
                    
                    // Restablecer bot√≥n
                    primexbtInterfaceImportBtn.disabled = false;
                    primexbtInterfaceImportBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Importar Operaciones';
                }
            } finally {
                isHandlerExecuting = false;
                console.log('üîì handlePrimeXBTInterfaceImport liberado');
            }
        };

        // Inicializar modal y event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar sidebar
            initSidebar();
            
            // Inicializar navegaci√≥n de configuraci√≥n
            initConfigNavigation();
            
            showLoading(true);
            await loadData();
            updateAccountBalances();

            // NO inicializar cuenta global - esperar a que el usuario seleccione
            globalSelectedAccount = '';
            console.log('üéØ Cuenta global inicial: (ninguna seleccionada)');

            initDashboard();
            initAnalytics();
            initInforme();
            initFinances();
            initCalendar();
            initOperations(); // Esto ahora configurar√° el clic en la fila
            initAccounts();
            await initConfig();
            initPlatforms(); // Ahora est√° definida en el mismo bloque
            // initPrimeXBTInterfaceModal(); // ELIMINADO - ahora usa onclick directo
            initDateRangeModal();
            initImageModal(); // Mant√©n esto para el pop-up de im√°genes desde la p√°gina de detalles
            initMainHeader(); // Inicializar header principal

            const tabs = document.querySelectorAll('nav .nav-tab');
            const sections = document.querySelectorAll('.section-container');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.target;
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    showSection(targetId); // Usar showSection para auto-refresh
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });

            const initialActiveTab = document.querySelector('.nav-tab.active');
            if (initialActiveTab) {
                const initialTargetId = initialActiveTab.dataset.target;
                const initialTargetSection = document.getElementById(initialTargetId);
                if (initialTargetSection) initialTargetSection.classList.add('active');
                refreshAllViews();
            }

            document.getElementById('close-day-modal-icon').addEventListener('click', closeDayDetailModal);
            document.getElementById('close-day-modal-btn').addEventListener('click', closeDayDetailModal);
            document.getElementById('day-detail-modal').addEventListener('click', function (e) {
                if (e.target.id === 'day-detail-modal') closeDayDetailModal();
            });

            const dashboardTimeRangeContainer = document.querySelector('#dashboard .time-range-buttons');
            if (dashboardTimeRangeContainer) {
                dashboardTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('time-range-btn')) {
                        dashboardTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        refreshDashboard();
                    }
                });
            }

            const accountDetailTimeRangeContainer = document.getElementById('account-detail-time-range');
            if (accountDetailTimeRangeContainer) {
                accountDetailTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('time-range-btn')) {
                        accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        const selectedRange = event.target.dataset.range;
                        const accountId = document.getElementById('selected-account-details').dataset.accountId;
                        if (accountId) {
                            const account = DB.accounts.find(acc => acc.id === accountId);
                            const accountOps = DB.operations.filter(op => op.accountId === accountId);
                            if (account) {
                                updateAccountDetailChart(account, accountOps, selectedRange);
                                updateAccountReduccionAcumuladaChart(accountOps, account, selectedRange);
                                updateAccountPnLAcumuladoChart(accountOps, account, selectedRange);
                            }
                        }
                    }
                });
            }

            // Event listeners para los nuevos gr√°ficos de account details
            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('account-drawdown-range-btn')) {
                    const container = event.target.parentNode;
                    container.querySelectorAll('.account-drawdown-range-btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    const timeRange = event.target.dataset.range;
                    const accountId = document.getElementById('selected-account-details').dataset.accountId;
                    if (accountId) {
                        const account = DB.accounts.find(acc => acc.id === accountId);
                        const accountOps = DB.operations.filter(op => op.accountId === accountId);
                        if (account) updateAccountReduccionAcumuladaChart(accountOps, account, timeRange);
                    }
                }
                
                if (event.target.classList.contains('account-pnl-range-btn')) {
                    const container = event.target.parentNode;
                    container.querySelectorAll('.account-pnl-range-btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    const timeRange = event.target.dataset.range;
                    const accountId = document.getElementById('selected-account-details').dataset.accountId;
                    if (accountId) {
                        const account = DB.accounts.find(acc => acc.id === accountId);
                        const accountOps = DB.operations.filter(op => op.accountId === accountId);
                        if (account) updateAccountPnLAcumuladoChart(accountOps, account, timeRange);
                    }
                }
            });

            document.getElementById('dashboard-account-select').addEventListener('change', (e) => {
                const selectedAccount = e.target.value;
                
                // Sincronizar cuenta seleccionada en Analytics e Informe con logos
                syncAccountSelection(selectedAccount);
                
                if (dashboardTimeRangeContainer) {
                    const rangeButtons = dashboardTimeRangeContainer.querySelectorAll('.time-range-btn');
                    rangeButtons.forEach(btn => btn.classList.remove('active'));
                    const allButton = Array.from(rangeButtons).find(btn => btn.dataset.range === 'ALL');
                    if (allButton) allButton.classList.add('active');
                }
                if (document.getElementById('dashboard').classList.contains('active')) refreshDashboard();
            });
            document.getElementById('analytics-account-select').addEventListener('change', (e) => {
                const selectedAccount = e.target.value;
                
                // Sincronizar cuenta seleccionada en Dashboard e Informe con logos
                syncAccountSelection(selectedAccount);
                
                if (document.getElementById('analytics').classList.contains('active')) refreshAnalytics();
            });
            
            const equityAccountSelect = document.getElementById('equity-account-select');
            if (equityAccountSelect) {
                equityAccountSelect.addEventListener('change', (e) => {
                    const selectedAccount = e.target.value;
                    syncAccountSelection(selectedAccount);
                    if (document.getElementById('equity-graph').classList.contains('active') && typeof refreshEquityGraph === 'function') {
                        refreshEquityGraph();
                    }
                });
            }
            
            const dailyJournalAccountSelect = document.getElementById('daily-journal-account-select');
            if (dailyJournalAccountSelect) {
                dailyJournalAccountSelect.addEventListener('change', (e) => {
                    const selectedAccount = e.target.value;
                    syncAccountSelection(selectedAccount);
                    if (document.getElementById('daily-journal').classList.contains('active') && typeof refreshDailyJournal === 'function') {
                        refreshDailyJournal();
                    }
                });
            }

            // Manejador del bot√≥n "Volver a Operaciones"
            document.getElementById('back-to-operations-btn').addEventListener('click', () => {
                // Limpiar el gr√°fico de TradingView si est√° activo
                if (window.hideTradingChart) {
                    window.hideTradingChart();
                }
                showSection('operations'); // Activa la secci√≥n de operaciones
                // refreshOperationsTable(); // Ya se refresca al activar la secci√≥n de operaciones si es necesario
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazarse al inicio de la p√°gina de operaciones
            });


            showLoading(false);
        });

        function openDayDetailModal(dateKeyYYYYMMDD, ops, totalPLForDayInBaseCurrency, baseCurrency) {
            const modal = document.getElementById('day-detail-modal');
            if (!modal) {
                console.error('Modal day-detail-modal no encontrado!');
                return;
            }
            document.getElementById('day-modal-title').textContent = `Trades del ${formatDate(dateKeyYYYYMMDD)}`;
            const totalTrades = ops.length;
            const winners = ops.filter(op => op.result === 'win').length;
            const losers = ops.filter(op => op.result === 'loss').length;
            const winRate = (winners + losers) > 0 ? (winners / (winners + losers)) * 100 : 0;
            let totalVolume = ops.reduce((sum, op) => sum + (parseFloat(op.volume) || 0), 0);
            let sumWinPL = 0, sumLossPL = 0;

            // Calcular comisiones totales del d√≠a
            let totalFees = ops.reduce((sum, op) => {
                const fee = op.fee || op.fees || 0;
                return sum + convertCurrency(fee, op.currency, baseCurrency);
            }, 0);

            const currencyModeForModal = document.getElementById('calendar-currency-select') ? document.getElementById('calendar-currency-select').value : 'USD';
            let initialBalanceForModalPercent = 0;
            if (currencyModeForModal === '%') {
                const selectedAccount = document.getElementById('calendar-account-select').value;
                if (selectedAccount !== 'all') {
                    const account = DB.accounts.find(a => a.id === selectedAccount);
                    if (account) initialBalanceForModalPercent = convertCurrency(account.initialBalance, account.currency, baseCurrency);
                } else {
                    initialBalanceForModalPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, baseCurrency), 0);
                }
            }


            ops.forEach(op => {
                let plConvertedToBase = op.currency !== baseCurrency ? convertCurrency(op.pl, op.currency, baseCurrency) : op.pl;
                if (op.result === 'win') sumWinPL += plConvertedToBase;
                else if (op.result === 'loss') sumLossPL += plConvertedToBase;
            });
            const profitFactor = sumLossPL !== 0 ? Math.abs(sumWinPL / sumLossPL) : (sumWinPL > 0 ? Infinity : 0);

            let totalPLDisplay;
            if (currencyModeForModal === '%') {
                totalPLDisplay = initialBalanceForModalPercent > 0 ? ((totalPLForDayInBaseCurrency / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                totalPLDisplay = formatCurrency(totalPLForDayInBaseCurrency, baseCurrency, currencyModeForModal);
            }

            document.getElementById('day-total-pl-header').textContent = totalPLDisplay;
            document.getElementById('day-total-trades-header').textContent = totalTrades;
            document.getElementById('day-win-rate-header').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('day-winners-header').textContent = winners;
            document.getElementById('day-losers-header').textContent = losers;

            // Mostrar comisiones
            let feesDisplay;
            if (currencyModeForModal === '%') {
                feesDisplay = initialBalanceForModalPercent > 0 ? ((totalFees / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                feesDisplay = formatCurrency(totalFees, baseCurrency, currencyModeForModal);
            }
            document.getElementById('day-fees-header').textContent = feesDisplay;

            // P&L Neto despu√©s de comisiones
            const netPL = totalPLForDayInBaseCurrency - totalFees;
            let netPLDisplay;
            if (currencyModeForModal === '%') {
                netPLDisplay = initialBalanceForModalPercent > 0 ? ((netPL / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                netPLDisplay = formatCurrency(netPL, baseCurrency, currencyModeForModal);
            }
            const netPlEl = document.getElementById('day-net-pl-header');
            netPlEl.textContent = netPLDisplay;
            netPlEl.className = `font-bold ${netPL >= 0 ? 'text-green' : 'text-red'}`;

            document.getElementById('day-volume-header').textContent = totalVolume.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            document.getElementById('day-profit-factor-header').textContent = profitFactor === Infinity ? "Inf" : profitFactor.toFixed(2);

            const tbody = document.getElementById('day-modal-table-body'); tbody.innerHTML = '';
            if (ops.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-text-secondary">No hay operaciones para este d√≠a.</td></tr>`;
            } else {
                ops.forEach(op => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = op.id; // A√±adir data-id a la fila
                    tr.classList.add('cursor-pointer'); // Hacerla clicable

                    let plConvertedToBaseForOp = op.currency !== baseCurrency ? convertCurrency(op.pl, op.currency, baseCurrency) : op.pl;
                    let opPLDisplay;
                    if (currencyModeForModal === '%') {
                        opPLDisplay = initialBalanceForModalPercent > 0 ? ((plConvertedToBaseForOp / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
                    } else {
                        opPLDisplay = formatCurrency(plConvertedToBaseForOp, baseCurrency, currencyModeForModal);
                    }

                    // Indicador de parciales
                    const partialsIndicator = op.isGrouped ? '<i class="fas fa-expand-alt text-blue-400 ml-1" title="Clic para ver parciales"></i>' : '';

                    // Mostrar ID original del CSV si existe, sino el ID procesado
                    let displayId = op.id;
                    if (op.originalId) {
                        displayId = op.originalId;
                    }
                    // Si el ID contiene el formato de plataforma, extraer solo el ID del CSV
                    const parts = displayId.split('_');
                    if (parts.length >= 2 && /^\d+$/.test(parts[parts.length - 1])) {
                        displayId = parts[parts.length - 1]; // Mostrar solo el ID num√©rico del CSV
                    }

                    tr.innerHTML = `
                        <td>${displayId || '-'}${partialsIndicator}</td>
                        <td>${op.entryTime || '-'}</td>
                        <td>${op.instrument}</td>
                        <td class="${op.type === 'buy' ? 'text-positive' : 'text-negative'} font-semibold">${op.type === 'buy' ? 'COMPRA' : 'VENTA'}</td>
                        <td class="${plConvertedToBaseForOp >= 0 ? 'text-positive' : 'text-negative'}">${opPLDisplay}</td>
                        <td>${op.exitTime || '-'}</td>`;
                    
                    tbody.appendChild(tr);

                    // Si tiene parciales, agregar filas expandibles (inicialmente ocultas)
                    if (op.isGrouped && op.partials) {
                        op.partials.forEach((partial, index) => {
                            const partialTr = document.createElement('tr');
                            partialTr.classList.add('partial-row', 'hidden', 'bg-surface-light');
                            partialTr.dataset.parentId = op.id;

                            let partialPL = partial.currency !== baseCurrency ? convertCurrency(partial.pl, partial.currency, baseCurrency) : partial.pl;
                            let partialPLDisplay;
                            if (currencyModeForModal === '%') {
                                partialPLDisplay = initialBalanceForModalPercent > 0 ? ((partialPL / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
                            } else {
                                partialPLDisplay = formatCurrency(partialPL, baseCurrency, currencyModeForModal);
                            }

                            partialTr.innerHTML = `
                                <td class="pl-6 text-text-secondary">‚îî Parcial ${index + 1}</td>
                                <td>${partial.entryTime || '-'}</td>
                                <td>${partial.instrument || op.instrument}</td>
                                <td class="${(partial.type || op.type) === 'buy' ? 'text-positive' : 'text-negative'} font-semibold">${(partial.type || op.type) === 'buy' ? 'COMPRA' : 'VENTA'}</td>
                                <td class="${partialPL >= 0 ? 'text-positive' : 'text-negative'}">${partialPLDisplay}</td>
                                <td>${partial.time || partial.exitTime || '-'}</td>`;
                            
                            tbody.appendChild(partialTr);
                        });
                    }
                });
                 
                // Listener para las operaciones dentro del modal del calendario
                tbody.querySelectorAll('tr:not(.partial-row)').forEach(row => {
                    row.addEventListener('click', (e) => {
                        const operationId = row.dataset.id;
                        
                        // Si se hizo clic en el icono de expansi√≥n
                        const expandIcon = e.target.closest('.fa-expand-alt, .fa-compress-alt');
                        if (expandIcon) {
                            e.preventDefault(); // Prevenir navegaci√≥n a detalles
                            e.stopPropagation();
                            
                            const partialRows = tbody.querySelectorAll(`tr.partial-row[data-parent-id="${operationId}"]`);
                            const isExpanded = !partialRows[0]?.classList.contains('hidden');
                            
                            partialRows.forEach(partialRow => {
                                if (isExpanded) {
                                    partialRow.classList.add('hidden');
                                } else {
                                    partialRow.classList.remove('hidden');
                                }
                            });
                            
                            // Cambiar icono
                            if (isExpanded) {
                                expandIcon.classList.remove('fa-compress-alt');
                                expandIcon.classList.add('fa-expand-alt');
                                expandIcon.title = 'Clic para ver parciales';
                            } else {
                                expandIcon.classList.remove('fa-expand-alt');
                                expandIcon.classList.add('fa-compress-alt');
                                expandIcon.title = 'Clic para ocultar parciales';
                            }
                            
                            return;
                        }
                        
                        // Navegar a detalles si no se hizo clic en el icono
                        if (operationId) {
                            closeDayDetailModal(); // Cerrar el modal del d√≠a
                            showOperationDetailPage(operationId); // Abrir la p√°gina de detalles
                        }
                    });
                });
            }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeDayDetailModal() {
            const modal = document.getElementById('day-detail-modal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }

        // Nueva funci√≥n para determinar la sesi√≥n de trading basada en la hora de entrada UTC
        function getTradingSession(entryTimeStr) {
            if (!entryTimeStr) return 'No especificado';

            const [hoursStr] = entryTimeStr.split(':');
            const entryHourUTC = parseInt(hoursStr, 10);

            // Horarios aproximados de las principales sesiones de trading en UTC
            // Estas son clasificaciones primarias, los solapamientos se manejan con l√≥gica espec√≠fica
            // Se asume que las horas de entrada de la operaci√≥n ya est√°n en UTC o se manejar√°n como si lo fuera.

            // Sesi√≥n Asi√°tica (incluye Tokio, S√≠dney) - Abarca la noche y madrugada europea/americana
            if (entryHourUTC >= 22 || entryHourUTC < 7) { // 22:00 UTC (noche) hasta 06:59 UTC (ma√±ana)
                return 'Asia';
            }
            // Sesi√≥n de Londres (Europa) - Solapa con Asia y Nueva York
            else if (entryHourUTC >= 7 && entryHourUTC < 12) { // 07:00 UTC hasta 11:59 UTC (antes de que abra NY)
                return 'Londres';
            }
            // Sesi√≥n de Nueva York (Am√©rica) - Solapa con Londres
            else if (entryHourUTC >= 12 && entryHourUTC < 17) { // 12:00 UTC hasta 16:59 UTC (solapamiento Londres-NY)
                return 'Nueva York (solapamiento Londres)';
            }
            else if (entryHourUTC >= 17 && entryHourUTC < 21) { // 17:00 UTC hasta 20:59 UTC (solo NY)
                return 'Nueva York';
            }
            // Cualquier otra hora
            return 'Fuera de Sesi√≥n Principal / Otro';
        }

        // Nueva funci√≥n para mostrar las m√©tricas de sesi√≥n en la p√°gina de detalles
        function displaySessionMetrics(currentOperation) {
            const currentSessionEl = document.getElementById('op-detail-session-current');
            const sessionMetricsTableBody = document.getElementById('op-detail-session-metrics');
            sessionMetricsTableBody.innerHTML = ''; // Limpiar datos anteriores

            const currentTradeSession = getTradingSession(currentOperation.entryTime);
            currentSessionEl.textContent = currentTradeSession;

            // Agrega m√©tricas para TODAS las operaciones bas√°ndose en la sesi√≥n
            const sessionPerformance = {
                'Asia': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 },
                'Londres': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 },
                'Nueva York (solapamiento Londres)': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 },
                'Nueva York': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 },
                'Fuera de Sesi√≥n Principal / Otro': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 },
                'No especificado': { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 }
            };

            DB.operations.forEach(op => {
                const session = getTradingSession(op.entryTime); // Usar la sesi√≥n derivada de la hora
                let plConverted = op.pl;
                let feeConverted = op.fee || op.fees || 0;
                // Convertir PL y fees a la divisa por defecto para un an√°lisis consistente
                if (op.currency !== DB.settings.defaultCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    feeConverted = convertCurrency(feeConverted, op.currency, DB.settings.defaultCurrency);
                }

                if (!sessionPerformance[session]) { // Asegurarse de que la clave exista si getTradingSession devuelve algo inesperado
                    sessionPerformance[session] = { pl: 0, trades: 0, wins: 0, losses: 0, fees: 0 };
                }
                sessionPerformance[session].pl += plConverted;
                sessionPerformance[session].fees += feeConverted;
                sessionPerformance[session].trades++;
                if (op.result === 'win') sessionPerformance[session].wins++;
                else if (op.result === 'loss') sessionPerformance[session].losses++;
            });

            // Ordenar las sesiones para la tabla (opcional, pero profesional)
            const orderedSessionNames = ['Asia', 'Londres', 'Nueva York (solapamiento Londres)', 'Nueva York', 'Fuera de Sesi√≥n Principal / Otro', 'No especificado'].filter(name => sessionPerformance[name].trades > 0);

            // Si hay sesiones con datos pero no est√°n en la lista ordenada, a√±adirlas al final
            Object.keys(sessionPerformance).forEach(sessionName => {
                if (!orderedSessionNames.includes(sessionName) && sessionPerformance[sessionName].trades > 0) {
                    orderedSessionNames.push(sessionName);
                }
            });

            if (orderedSessionNames.length === 0) {
                sessionMetricsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-text-secondary py-3">No hay operaciones registradas para an√°lisis de sesi√≥n.</td></tr>';
                return;
            }

            // Rellenar la tabla
            orderedSessionNames.forEach(sessionName => {
                const data = sessionPerformance[sessionName];
                const winRate = (data.wins + data.losses) > 0 ? (data.wins / (data.wins + data.losses)) * 100 : 0;
                const plClass = data.pl > 0 ? 'text-positive' : (data.pl < 0 ? 'text-negative' : 'text-neutral');
                const netPl = data.pl - data.fees;
                const netPlClass = netPl > 0 ? 'text-green' : (netPl < 0 ? 'text-red' : 'text-neutral');

                const row = `
                    <tr>
                        <td>${sessionName}</td>
                        <td class="${plClass}">${formatCurrency(data.pl, DB.settings.defaultCurrency, DB.settings.defaultCurrency)}</td>
                        <td class="text-red">${formatCurrency(data.fees, DB.settings.defaultCurrency, DB.settings.defaultCurrency)}</td>
                        <td class="${netPlClass} font-bold">${formatCurrency(netPl, DB.settings.defaultCurrency, DB.settings.defaultCurrency)}</td>
                        <td>${data.trades}</td>
                        <td class="text-green">${winRate.toFixed(1)}%</td>
                    </tr>
                `;
                sessionMetricsTableBody.innerHTML += row;
            });
        }

        // Nueva funci√≥n para mostrar la p√°gina completa de detalles de la operaci√≥n
        function showOperationDetailPage(operationId) {
            const operation = DB.operations.find(op => op.id === operationId);
            if (!operation) {
                alert("Operaci√≥n no encontrada.");
                return;
            }

            const account = DB.accounts.find(acc => acc.id === operation.accountId);
            const precision = getInstrumentPrecision(operation.instrument);

            // Rellenar la nueva secci√≥n
            document.getElementById('op-detail-page-title').textContent = `Detalles de la Operaci√≥n: ${operation.instrument}`;
            document.getElementById('op-detail-id').textContent = operation.id || 'N/A';
            document.getElementById('op-detail-date').textContent = formatDate(operation.date);
            document.getElementById('op-detail-account').textContent = account ? account.name : 'N/A';
            document.getElementById('op-detail-instrument').textContent = operation.instrument;
            document.getElementById('op-detail-type').textContent = operation.type === 'buy' ? 'Compra (Long)' : 'Venta (Short)';
            document.getElementById('op-detail-entry').textContent = operation.entry !== null ? operation.entry.toFixed(precision) : '-';
            document.getElementById('op-detail-exit').textContent = operation.exit !== null ? operation.exit.toFixed(precision) : '-';
            document.getElementById('op-detail-entry-time').textContent = operation.entryTime || '-';
            document.getElementById('op-detail-exit-time').textContent = operation.exitTime || '-';
            document.getElementById('op-detail-volume').textContent = operation.volume;
            document.getElementById('op-detail-currency').textContent = operation.currency;
            document.getElementById('op-detail-manual-pl').textContent = operation.manualPL !== null ? formatCurrency(operation.manualPL, operation.currency, operation.currency) : 'No especificado';

            // Mostrar comisi√≥n
            const fee = operation.fees || 0;
            document.getElementById('op-detail-fee').textContent = formatCurrency(fee, operation.currency, operation.currency);

            document.getElementById('op-detail-session').textContent = operation.session || 'N/A'; // Mostrar el campo Sesi√≥n
            
            // Mostrar setup usado
            const setupId = operation.setupId || operation.setupUsed;
            const setup = setupId ? DB.setups.find(s => s.id === setupId) : null;
            document.getElementById('op-detail-setup').textContent = setup ? setup.name : 'Ninguno';

            const resultEl = document.getElementById('op-detail-result');
            resultEl.textContent = operation.result === 'win' ? 'Ganancia' : (operation.result === 'loss' ? 'P√©rdida' : 'Neutral');
            resultEl.className = `text-xl font-bold ${operation.result === 'win' ? 'text-positive' : (operation.result === 'loss' ? 'text-negative' : 'text-neutral')}`;

            const plEl = document.getElementById('op-detail-pl');
            plEl.textContent = formatCurrency(operation.pl, operation.currency, operation.currency);
            plEl.className = `text-xl font-bold ${operation.pl >= 0 ? 'text-positive' : (operation.pl < 0 ? 'text-negative' : 'text-neutral')}`;

            // P&L Neto despu√©s de comisi√≥n
            const netPl = operation.pl - fee;
            const netPlEl = document.getElementById('op-detail-net-pl');
            netPlEl.textContent = formatCurrency(netPl, operation.currency, operation.currency);
            netPlEl.className = `text-xl font-bold ${netPl >= 0 ? 'text-green' : 'text-red'}`;

            document.getElementById('op-detail-notes').innerHTML = operation.notes || 'Sin notas.';

            // Im√°genes - usar la nueva funci√≥n
            updateOperationImagesDisplay(operation);

            // An√°lisis de Sesi√≥n
            displaySessionMetrics(operation);

            // Llenar tabla de parciales
            displayOperationPartials(operation);

            // Cargar gr√°fico TradingView avanzado
            setTimeout(() => {
                loadTradingViewChart(operation);
            }, 300);

            // Mostrar la p√°gina de detalles y ocultar otras
            showSection('operation-detail-page');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazarse al inicio de la nueva p√°gina
        }

        // Funci√≥n para mostrar los parciales de una operaci√≥n
        function displayOperationPartials(operation) {
            const tbody = document.getElementById('op-detail-partials-table');
            tbody.innerHTML = '';
            
            console.log('üîç [displayOperationPartials] Operaci√≥n:', operation);
            console.log('üîç [displayOperationPartials] Tiene parciales:', operation.hasPartials);
            console.log('üîç [displayOperationPartials] Parciales:', operation.partials);
            
            // Si la operaci√≥n tiene parciales guardados (PrimeXBT Interface Import)
            if (operation.hasPartials && operation.partials && operation.partials.length > 0) {
                const precision = getInstrumentPrecision(operation.instrument);
                
                // Fila de apertura (Posici√≥n Principal)
                const openingTr = document.createElement('tr');
                openingTr.className = 'border-b-2 border-primary bg-surface-light hover:bg-surface';
                openingTr.innerHTML = `
                    <td class="p-3 font-semibold text-blue-400">Posici√≥n Principal</td>
                    <td class="p-3 font-semibold">${operation.entryTime || '-'}</td>
                    <td class="p-3 font-semibold">${operation.exitTime || '-'}</td>
                    <td class="p-3 font-semibold">${operation.entry !== null ? operation.entry.toFixed(precision) : '-'}</td>
                    <td class="p-3 font-semibold">${operation.exit !== null ? operation.exit.toFixed(precision) : '-'}</td>
                    <td class="p-3 font-semibold">${operation.volume}</td>
                    <td class="p-3 font-semibold ${operation.pl >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(operation.pl, operation.currency, operation.currency)}
                    </td>
                `;
                tbody.appendChild(openingTr);
                
                // Filas de parciales
                operation.partials.forEach((partial, index) => {
                    const partialTr = document.createElement('tr');
                    partialTr.className = 'border-b border-border hover:bg-surface-light';
                    partialTr.innerHTML = `
                        <td class="p-3 text-gray-400">Cierre Parcial ${index + 1}</td>
                        <td class="p-3">-</td>
                        <td class="p-3">${partial.time || '-'}</td>
                        <td class="p-3">${partial.time || '-'}</td>
                        <td class="p-3">${partial.price !== null ? partial.price.toFixed(precision) : '-'}</td>
                        <td class="p-3">${partial.volume}</td>
                        <td class="p-3 ${partial.pl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${formatCurrency(partial.pl, operation.currency, operation.currency)}
                        </td>
                    `;
                    tbody.appendChild(partialTr);
                });
                
                // Actualizar el gr√°fico de curva P&L con la operaci√≥n principal
                const mainOpWithPartials = {
                    ...operation,
                    pl: operation.pl,
                    entryTime: operation.entryTime,
                    exitTime: operation.exitTime
                };
                updateOperationPnLCurveChart([mainOpWithPartials]);
                
                return; // Terminar aqu√≠, no buscar operaciones relacionadas
            }
            
            // Si no tiene parciales guardados, usar el m√©todo anterior (b√∫squeda por csvId, etc.)
            let relatedOperations = [];
            
            // Criterio 1: Mismo csvId (m√©todo principal)
            if (operation.csvId) {
                relatedOperations = DB.operations.filter(op => op.csvId === operation.csvId);
            }
            
            // Criterio 2: Buscar por ID base (para operaciones con parciales)
            if (relatedOperations.length <= 1) {
                const baseId = operation.id.toString().split(/[\s,]/)[0]; // Obtener la parte base del ID
                relatedOperations = DB.operations.filter(op => {
                    const opBaseId = op.id.toString().split(/[\s,]/)[0];
                    return opBaseId === baseId;
                });
            }
            
            // Criterio 3: Buscar operaciones que contengan el ID en su descripci√≥n o que sean parciales del mismo grupo
            if (relatedOperations.length <= 1) {
                const searchId = operation.id.toString();
                relatedOperations = DB.operations.filter(op => {
                    // Mismo ID base o contiene "Parcial" y mismo instrumento/fecha/cuenta
                    return op.id.toString().includes(searchId) || 
                           searchId.includes(op.id.toString()) ||
                           (op.id.toString().toLowerCase().includes('parcial') && 
                            op.instrument === operation.instrument && 
                            op.date === operation.date && 
                            op.accountId === operation.accountId) ||
                           (operation.id.toString().toLowerCase().includes('parcial') && 
                            operation.instrument === op.instrument && 
                            operation.date === op.date && 
                            operation.accountId === op.accountId);
                });
            }
            
            // Si a√∫n no hay operaciones relacionadas, mostrar solo la operaci√≥n actual
            if (relatedOperations.length === 0) {
                relatedOperations = [operation];
            }
            
            console.log('üîç [displayOperationPartials] Operaci√≥n actual ID:', operation.id);
            console.log('üîç [displayOperationPartials] Operaciones relacionadas encontradas:', relatedOperations.length);
            console.log('üîç [displayOperationPartials] IDs encontrados:', relatedOperations.map(op => op.id));
            
            if (relatedOperations.length <= 1) {
                // Solo hay una operaci√≥n, mostrar como posici√≥n principal
                const tr = document.createElement('tr');
                tr.className = 'border-b border-border hover:bg-surface-light';
                
                const precision = getInstrumentPrecision(operation.instrument);
                
                tr.innerHTML = `
                    <td class="p-3 font-semibold text-blue-400">Posici√≥n Principal</td>
                    <td class="p-3">${operation.entryTime || '-'}</td>
                    <td class="p-3">${operation.exitTime || '-'}</td>
                    <td class="p-3">${operation.entry !== null ? operation.entry.toFixed(precision) : '-'}</td>
                    <td class="p-3">${operation.exit !== null ? operation.exit.toFixed(precision) : '-'}</td>
                    <td class="p-3">${operation.volume}</td>
                    <td class="p-3 font-semibold ${operation.pl >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(operation.pl, operation.currency, operation.currency)}
                    </td>
                `;
                
                tbody.appendChild(tr);
                
                // Actualizar el gr√°fico de curva P&L con la operaci√≥n √∫nica
                updateOperationPnLCurveChart([operation]);
            } else {
                // Hay m√∫ltiples operaciones (parciales)
                // Ordenar por hora de entrada
                relatedOperations.sort((a, b) => {
                    const timeA = a.entryTime || '00:00';
                    const timeB = b.entryTime || '00:00';
                    return timeA.localeCompare(timeB);
                });
                
                // Calcular hora de entrada (primera) y hora de salida (√∫ltima)
                const firstEntryTime = relatedOperations[0].entryTime || '-';
                
                // Para la hora de salida, buscar la hora m√°s tard√≠a entre entryTime y exitTime
                let lastExitTime = '-';
                relatedOperations.forEach(op => {
                    const exitTime = op.exitTime || op.entryTime;
                    if (exitTime && exitTime !== '-') {
                        if (lastExitTime === '-' || exitTime > lastExitTime) {
                            lastExitTime = exitTime;
                        }
                    }
                });
                
                let totalPL = 0;
                let totalVolume = 0;
                const precision = getInstrumentPrecision(operation.instrument);
                
                // Crear fila de resumen (Posici√≥n Principal)
                const summaryTr = document.createElement('tr');
                summaryTr.className = 'border-b-2 border-primary bg-surface-light hover:bg-surface';
                
                totalPL = relatedOperations.reduce((sum, op) => sum + (op.pl || 0), 0);
                totalVolume = relatedOperations.reduce((sum, op) => sum + (parseFloat(op.volume) || 0), 0);
                
                // Calcular precios promedio ponderados
                let totalVolumeForEntry = 0, totalVolumeForExit = 0;
                let weightedEntry = 0, weightedExit = 0;
                
                relatedOperations.forEach(op => {
                    if (op.entry !== null) {
                        weightedEntry += op.entry * op.volume;
                        totalVolumeForEntry += op.volume;
                    }
                    if (op.exit !== null) {
                        weightedExit += op.exit * op.volume;
                        totalVolumeForExit += op.volume;
                    }
                });
                
                const avgEntry = totalVolumeForEntry > 0 ? weightedEntry / totalVolumeForEntry : null;
                const avgExit = totalVolumeForExit > 0 ? weightedExit / totalVolumeForExit : null;
                
                summaryTr.innerHTML = `
                    <td class="p-3 font-semibold text-blue-400">Posici√≥n Principal</td>
                    <td class="p-3 font-semibold">${firstEntryTime}</td>
                    <td class="p-3 font-semibold">${lastExitTime}</td>
                    <td class="p-3 font-semibold">${avgEntry !== null ? avgEntry.toFixed(precision) : '-'}</td>
                    <td class="p-3 font-semibold">${avgExit !== null ? avgExit.toFixed(precision) : '-'}</td>
                    <td class="p-3 font-semibold">${totalVolume.toFixed(4)}</td>
                    <td class="p-3 font-semibold text-lg ${totalPL >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(totalPL, operation.currency, operation.currency)}
                    </td>
                `;
                
                tbody.appendChild(summaryTr);
                
                // Crear filas para cada parcial
                relatedOperations.forEach((op, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-border hover:bg-surface-light';
                    
                    // Detectar si el ID contiene "Parcial" para mostrar el nombre correcto
                    let description = `Parcial ${index + 1}`;
                    if (op.notes && op.notes.includes('Parcial')) {
                        description = op.notes.split(',')[0] || description; // Tomar solo la parte del parcial
                    }
                    
                    tr.innerHTML = `
                        <td class="p-3 text-text-secondary pl-8">‚Ü≥ ${description}</td>
                        <td class="p-3">${op.entryTime || '-'}</td>
                        <td class="p-3">${op.exitTime || '-'}</td>
                        <td class="p-3">${op.entry !== null ? op.entry.toFixed(precision) : '-'}</td>
                        <td class="p-3">${op.exit !== null ? op.exit.toFixed(precision) : '-'}</td>
                        <td class="p-3">${op.volume}</td>
                        <td class="p-3 font-semibold ${op.pl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${formatCurrency(op.pl, op.currency, op.currency)}
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            }
            
            // Actualizar el gr√°fico de curva P&L
            updateOperationPnLCurveChart(relatedOperations);
        }

        // Variable global para el gr√°fico de curva P&L
        let operationPnLCurveChart = null;

        function updateOperationPnLCurveChart(relatedOperations) {
            const ctx = document.getElementById('operation-pnl-curve-chart')?.getContext('2d');
            if (!ctx) return;
            
            // Destruir gr√°fico existente
            if (operationPnLCurveChart) {
                operationPnLCurveChart.destroy();
            }

            if (!relatedOperations || relatedOperations.length === 0) return;

            // Ordenar operaciones por fecha y hora
            const sortedOps = [...relatedOperations].sort((a, b) => {
                const dateTimeA = new Date(a.date + 'T' + (a.entryTime || '00:00'));
                const dateTimeB = new Date(b.date + 'T' + (b.entryTime || '00:00'));
                return dateTimeA - dateTimeB;
            });

            // Crear datos para el gr√°fico - curva desde 0 hasta P&L final
            const labels = ['Inicio'];
            const pnlData = [0]; // Empezar en 0
            let accumulatedPL = 0;

            // Si hay m√∫ltiples operaciones (parciales), mostrar progresi√≥n
            if (sortedOps.length > 1) {
                sortedOps.forEach((op, index) => {
                    accumulatedPL += op.pl || 0;
                    labels.push(`${op.entryTime || 'N/A'} - ${index + 1}`);
                    pnlData.push(accumulatedPL);
                });
            } else {
                // Solo una operaci√≥n, crear curva suave desde 0 hasta el P&L final
                const finalPL = sortedOps[0].pl || 0;
                const steps = 10; // N√∫mero de puntos intermedios para suavizar
                
                for (let i = 1; i <= steps; i++) {
                    const progress = i / steps;
                    const currentPL = finalPL * progress;
                    labels.push(`${((progress * 100)).toFixed(0)}%`);
                    pnlData.push(currentPL);
                }
            }

            const finalPL = pnlData[pnlData.length - 1];
            const isProfit = finalPL >= 0;
            
            // Colores de la plataforma
            const lineColor = isProfit ? '#10B981' : '#ef4444'; // Verde fluorescente o rojo
            const fillColor = isProfit ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            const backgroundColor = isProfit ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

            operationPnLCurveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P&L Acumulado',
                        data: pnlData,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: lineColor,
                        pointBorderColor: '#1a1a1a',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#ffffff',
                        pointHoverBorderColor: lineColor,
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: lineColor,
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const operation = sortedOps[0];
                                    const currency = operation ? operation.currency : 'USD';
                                    return `P&L: ${formatCurrency(value, currency, currency)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#2a2a2a',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#2a2a2a',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    const operation = sortedOps[0];
                                    const currency = operation ? operation.currency : 'USD';
                                    return formatCurrency(value, currency, currency);
                                }
                            },
                            // Incluir siempre la l√≠nea de 0
                            beginAtZero: true
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });

            console.log('‚úÖ Gr√°fico de curva P&L actualizado');
        }

        // --- FUNCIONES PARA PESTA√ëAS INTERACTIVAS EN DETALLES DE OPERACI√ìN ---
        let opDetailRichEditor = null; // Editor de texto enriquecido para notas de operaci√≥n
        
        function initializeOperationDetailTabs() {
            // Inicializar Rich Text Editor para notas de operaci√≥n (si est√° disponible)
            const opEditorContainer = document.getElementById('op-detail-rich-editor-container');
            if (opEditorContainer && !opDetailRichEditor && typeof RichTextEditor !== 'undefined') {
                try {
                    opDetailRichEditor = new RichTextEditor(opEditorContainer, {
                        placeholder: 'Agrega notas detalladas de la operaci√≥n...',
                        minHeight: '200px',
                        maxHeight: '400px',
                        showVoiceRecorder: true,
                        showDownload: true,
                        showCharCount: true
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è No se pudo inicializar RichTextEditor:', e);
                }
            } else if (typeof RichTextEditor === 'undefined') {
                console.warn('‚ö†Ô∏è RichTextEditor no est√° disponible');
            }
            
            // Event listeners para pesta√±as de notas
            document.querySelectorAll('.notes-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchNotesTab(tab);
                });
            });

            // Event listeners para pesta√±as de im√°genes  
            document.querySelectorAll('.images-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchImagesTab(tab);
                });
            });

            // Event listeners para funciones de notas
            document.getElementById('save-notes-btn')?.addEventListener('click', saveOperationNotes);
            document.getElementById('cancel-notes-btn')?.addEventListener('click', () => switchNotesTab('view'));

            // Event listeners para funciones de im√°genes
            document.getElementById('op-detail-image-input')?.addEventListener('change', handleImageSelection);
            document.getElementById('upload-images-btn')?.addEventListener('click', saveOperationImages);
            document.getElementById('cancel-images-btn')?.addEventListener('click', cancelImageUpload);

            // Drag and drop para im√°genes
            const dropZone = document.getElementById('drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    if (files.length > 0) {
                        document.getElementById('op-detail-image-input').files = createFileList(files);
                        handleImageSelection({ target: { files } });
                    }
                });
            }
        }

        function switchNotesTab(tab) {
            // Actualizar botones
            document.querySelectorAll('.notes-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });

            // Mostrar/ocultar contenido
            document.querySelectorAll('.notes-tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            if (tab === 'view') {
                document.getElementById('notes-view-content').classList.remove('hidden');
                document.getElementById('notes-view-content').classList.add('active');
            } else if (tab === 'edit') {
                document.getElementById('notes-edit-content').classList.remove('hidden');
                document.getElementById('notes-edit-content').classList.add('active');
                // Cargar notas actuales en el editor enriquecido
                const currentNotes = document.getElementById('op-detail-notes').innerHTML;
                if (opDetailRichEditor) {
                    opDetailRichEditor.setContent(currentNotes || '', 'html');
                }
            }
        }

        function switchImagesTab(tab) {
            console.log('üîÑ Cambiando a pesta√±a de im√°genes:', tab);
            
            // Actualizar botones
            document.querySelectorAll('.images-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });

            // Mostrar/ocultar contenido
            document.querySelectorAll('.images-tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            if (tab === 'view') {
                document.getElementById('images-view-content').classList.remove('hidden');
                document.getElementById('images-view-content').classList.add('active');
                console.log('üëÅÔ∏è Mostrando pesta√±a de vista de im√°genes');
            } else if (tab === 'add') {
                document.getElementById('images-add-content').classList.remove('hidden');
                document.getElementById('images-add-content').classList.add('active');
                console.log('‚ûï Mostrando pesta√±a de agregar im√°genes');
            }
        }

        function saveOperationNotes() {
            const operationId = document.getElementById('op-detail-id').textContent;
            const newNotes = opDetailRichEditor ? opDetailRichEditor.getContent('html') : '';
            
            // Buscar la operaci√≥n en la base de datos local
            const operationIndex = DB.operations.findIndex(op => op.id === operationId);
            if (operationIndex === -1) {
                alert('Operaci√≥n no encontrada');
                return;
            }

            // Actualizar las notas en la base de datos local
            DB.operations[operationIndex].notes = newNotes;
            
            // Guardar en dexieDB
            dexieDB.operations.update(operationId, { notes: newNotes }).then(() => {
                console.log('‚úÖ Notas guardadas en dexieDB correctamente');
                
                // Actualizar la vista local sin refrescar la tabla de operaciones
                document.getElementById('op-detail-notes').innerHTML = newNotes || 'Sin notas.';
                
                // Volver a la pesta√±a de vista
                switchNotesTab('view');
                
                // Tambi√©n guardar en Supabase si est√° configurado
                if (typeof saveOperationToSupabase === 'function') {
                    saveOperationToSupabase(DB.operations[operationIndex]).catch(err => {
                        console.log('‚ö†Ô∏è Error al sincronizar notas con Supabase:', err);
                    });
                }
                
            }).catch(error => {
                console.error('‚ùå Error al guardar notas:', error);
                alert('Error al guardar las notas. Int√©ntalo de nuevo.');
            });
        }

        function handleImageSelection(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('selected-images-preview');
            const uploadBtn = document.getElementById('upload-images-btn');
            
            console.log('üìÅ Archivos seleccionados:', files.length);
            
            if (files.length === 0) {
                preview.classList.add('hidden');
                uploadBtn.classList.add('hidden');
                return;
            }

            preview.innerHTML = '';
            preview.classList.remove('hidden');
            uploadBtn.classList.remove('hidden');

            files.forEach((file, index) => {
                console.log(`üìé Procesando archivo ${index + 1}:`, file.name, file.type, `${(file.size / 1024 / 1024).toFixed(2)}MB`);
                
                if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) { // Max 10MB
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'relative border border-border rounded overflow-hidden';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" class="w-full h-24 object-cover">
                            <button onclick="removeImagePreview(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                                √ó
                            </button>
                            <p class="p-1 text-xs text-center truncate">${file.name}</p>
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.warn('‚ö†Ô∏è Archivo rechazado:', file.name, file.type, `${(file.size / 1024 / 1024).toFixed(2)}MB`);
                }
            });
        }

        function removeImagePreview(index) {
            const input = document.getElementById('op-detail-image-input');
            const files = Array.from(input.files);
            files.splice(index, 1);
            
            // Recrear el input con los archivos restantes
            input.files = createFileList(files);
            handleImageSelection({ target: { files } });
        }

        function createFileList(files) {
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            return dt.files;
        }

        function saveOperationImages() {
            const operationId = document.getElementById('op-detail-id').textContent;
            const files = Array.from(document.getElementById('op-detail-image-input').files);
            
            console.log('üíæ Intentando guardar im√°genes:', files.length);
            
            if (files.length === 0) {
                alert('No hay im√°genes seleccionadas');
                return;
            }

            // Buscar la operaci√≥n en la base de datos local
            const operationIndex = DB.operations.findIndex(op => op.id === operationId);
            if (operationIndex === -1) {
                alert('Operaci√≥n no encontrada');
                return;
            }

            // Convertir im√°genes a base64 y agregarlas
            let processedCount = 0;
            const newImages = [];

            files.forEach((file, index) => {
                console.log(`üñºÔ∏è Procesando imagen ${index + 1}/${files.length}:`, file.name);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    newImages.push({
                        name: file.name,
                        data: e.target.result,
                        size: file.size,
                        type: file.type
                    });
                    
                    processedCount++;
                    console.log(`‚úÖ Imagen ${processedCount}/${files.length} procesada:`, file.name);
                    
                    if (processedCount === files.length) {
                        // Todas las im√°genes procesadas, guardar
                        if (!DB.operations[operationIndex].imageDatas) {
                            DB.operations[operationIndex].imageDatas = [];
                        }
                        
                        console.log('üíæ Agregando', newImages.length, 'nuevas im√°genes a la operaci√≥n');
                        DB.operations[operationIndex].imageDatas.push(...newImages);
                        
                        // Guardar en dexieDB
                        dexieDB.operations.update(operationId, { 
                            imageDatas: DB.operations[operationIndex].imageDatas 
                        }).then(() => {
                            console.log('‚úÖ Im√°genes guardadas en dexieDB correctamente');
                            
                            // Actualizar la vista de im√°genes inmediatamente
                            updateOperationImagesDisplay(DB.operations[operationIndex]);
                            
                            // Volver a la pesta√±a de vista y limpiar
                            cancelImageUpload();
                            switchImagesTab('view');
                            
                            // Actualizar Chartbook para que muestre las nuevas im√°genes
                            if (typeof window.refreshChartbook === 'function') {
                                console.log('üîÑ Actualizando Chartbook...');
                                window.refreshChartbook();
                            }
                            
                            // Tambi√©n guardar en Supabase si est√° configurado
                            if (typeof saveOperationToSupabase === 'function') {
                                saveOperationToSupabase(DB.operations[operationIndex]).catch(err => {
                                    console.log('‚ö†Ô∏è Error al sincronizar im√°genes con Supabase:', err);
                                });
                            }
                            
                        }).catch(error => {
                            console.error('‚ùå Error al guardar im√°genes:', error);
                            alert('Error al guardar las im√°genes. Int√©ntalo de nuevo.');
                        });
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function cancelImageUpload() {
            document.getElementById('op-detail-image-input').value = '';
            document.getElementById('selected-images-preview').classList.add('hidden');
            document.getElementById('upload-images-btn').classList.add('hidden');
            document.getElementById('selected-images-preview').innerHTML = '';
        }

        function updateOperationImagesDisplay(operation) {
            const imagesContainer = document.getElementById('op-detail-images');
            
            console.log('üñºÔ∏è [updateOperationImagesDisplay] Operaci√≥n:', operation.id);
            console.log('üìÅ [updateOperationImagesDisplay] imageDatas:', operation.imageDatas);
            
            if (!imagesContainer) {
                console.error('‚ùå Contenedor no encontrado: op-detail-images');
                return;
            }
            
            console.log('üì¶ Contenedor encontrado:', {
                exists: !!imagesContainer,
                classList: imagesContainer.classList.toString(),
                display: window.getComputedStyle(imagesContainer).display,
                visibility: window.getComputedStyle(imagesContainer).visibility,
                parent: imagesContainer.parentElement?.id
            });
            
            // Limpiar contenedor
            imagesContainer.innerHTML = '';
            imagesContainer.style.display = 'grid';
            
            if (!operation.imageDatas || !Array.isArray(operation.imageDatas) || operation.imageDatas.length === 0) {
                console.log('‚ÑπÔ∏è No hay im√°genes para mostrar');
                imagesContainer.innerHTML = '<p class="text-sm text-text-secondary col-span-3 text-center py-4">No hay im√°genes adjuntas.</p>';
                return;
            }
            
            console.log('‚úÖ Procesando', operation.imageDatas.length, 'im√°genes');
            
            let validImageCount = 0;
            
            operation.imageDatas.forEach((imageData, index) => {
                // Obtener la URL de la imagen
                let imageSrc = null;
                
                if (typeof imageData === 'string') {
                    imageSrc = imageData;
                } else if (imageData && typeof imageData === 'object') {
                    imageSrc = imageData.data || imageData.url || imageData.src;
                }
                
                console.log(`üñºÔ∏è [Imagen ${index + 1}]:`, imageSrc ? `${imageSrc.substring(0, 30)}... (${imageSrc.length} chars)` : 'NULL');
                
                if (!imageSrc || imageSrc.length === 0) {
                    console.warn(`‚ö†Ô∏è [Imagen ${index + 1}] URL vac√≠a, omitiendo`);
                    return;
                }
                
                // Crear contenedor de imagen
                const imageCard = document.createElement('div');
                imageCard.className = 'relative border-2 border-primary rounded-lg overflow-hidden bg-black cursor-pointer transition-transform hover:scale-105 group';
                imageCard.style.cssText = 'min-width: 250px; min-height: 250px; height: 300px; display: block !important;';
                
                // Crear imagen
                const img = document.createElement('img');
                img.src = imageSrc;
                img.alt = `Imagen ${index + 1}`;
                img.className = 'w-full h-full object-contain';
                img.style.cssText = 'display: block !important;';
                img.loading = 'eager'; // Cargar inmediatamente
                
                img.onload = () => {
                    console.log(`‚úÖ [Imagen ${index + 1}] Cargada -`, img.naturalWidth, 'x', img.naturalHeight);
                    validImageCount++;
                };
                
                img.onerror = (e) => {
                    console.error(`‚ùå [Imagen ${index + 1}] Error:`, e);
                    imageCard.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-negative text-xs p-2">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <span>Error al cargar</span>
                        </div>
                    `;
                };
                
                // Click para abrir modal
                imageCard.addEventListener('click', () => {
                    const imageUrls = operation.imageDatas
                        .map(imgData => {
                            if (typeof imgData === 'string') return imgData;
                            return imgData?.data || imgData?.url || imgData?.src || null;
                        })
                        .filter(url => url && url.length > 0);
                    
                    console.log('üì∏ Abriendo modal con', imageUrls.length, 'im√°genes');
                    openImageModal(imageUrls, index);
                });
                
                // Bot√≥n eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.className = 'absolute top-2 right-2 bg-negative text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10';
                deleteBtn.title = 'Eliminar imagen';
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('¬øEliminar esta imagen?')) {
                        removeOperationImage(operation.id, index);
                    }
                });
                
                // Agregar elementos
                imageCard.appendChild(img);
                imageCard.appendChild(deleteBtn);
                imagesContainer.appendChild(imageCard);
            });
            
            console.log(`‚úÖ Grid creado con ${imagesContainer.children.length} elementos`);
            console.log('üì¶ Contenedor despu√©s:', {
                children: imagesContainer.children.length,
                innerHTML: imagesContainer.innerHTML.substring(0, 200)
            });
        }

        function removeOperationImage(operationId, imageIndex) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta imagen?')) return;
            
            const operationIndex = DB.operations.findIndex(op => op.id === operationId);
            if (operationIndex !== -1 && DB.operations[operationIndex].imageDatas) {
                DB.operations[operationIndex].imageDatas.splice(imageIndex, 1);
                
                // Guardar en dexieDB
                dexieDB.operations.update(operationId, { 
                    imageDatas: DB.operations[operationIndex].imageDatas 
                }).then(() => {
                    console.log('‚úÖ Imagen eliminada y guardada en dexieDB correctamente');
                    updateOperationImagesDisplay(DB.operations[operationIndex]);
                    
                    // Actualizar Chartbook para que refleje la eliminaci√≥n
                    if (typeof window.refreshChartbook === 'function') {
                        console.log('üîÑ Actualizando Chartbook despu√©s de eliminar imagen...');
                        window.refreshChartbook();
                    }
                    
                    // Tambi√©n guardar en Supabase si est√° configurado
                    if (typeof saveOperationToSupabase === 'function') {
                        saveOperationToSupabase(DB.operations[operationIndex]).catch(err => {
                            console.log('‚ö†Ô∏è Error al sincronizar eliminaci√≥n con Supabase:', err);
                        });
                    }
                }).catch(error => {
                    console.error('‚ùå Error al eliminar imagen:', error);
                    alert('Error al eliminar la imagen. Int√©ntalo de nuevo.');
                });
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', initializeOperationDetailTabs);
    </script>

<script type="module">
// Importar Supabase como m√≥dulo ES
import { createClient } from '@supabase/supabase-js'

// ===== SUPABASE AUTHENTICATION SYSTEM =====

// Configuraci√≥n de Supabase
const supabaseUrl = 'https://gakiamardmlgftfrlxkm.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdha2lhbWFyZG1sZ2Z0ZnJseGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjczMzUsImV4cCI6MjA2ODYwMzMzNX0.wR3c9DMtSXzoagFDJdrmYqnN6vjfQMn8ijtUdOSpmYM'

// Crear cliente Supabase globalmente con configuraci√≥n optimizada
window.supabaseClient = createClient(supabaseUrl, supabaseKey, {
    auth: {
        autoRefreshToken: true, // Activado para mantener sesi√≥n
        persistSession: true,
        detectSessionInUrl: true,
        storageKey: 'trader-survivor-auth', // Clave personalizada
        flowType: 'pkce' // M√°s seguro
    },
    global: {
        headers: {
            'X-Client-Info': 'trader-survivor@1.0.0'
        }
    }
})
window.supabase = window.supabaseClient // Alias para compatibilidad

console.log('‚úÖ Supabase cliente creado correctamente');
console.log('‚úÖ URL:', supabaseUrl);

// Variable global para el resto del c√≥digo
var supabase = window.supabaseClient;

// Funci√≥n para inicializar Supabase (ahora solo verifica que est√© disponible)
async function initializeSupabase() {
    if (window.supabaseClient) {
        console.log('‚úÖ Supabase ya disponible');
        return true;
    }
    console.error('‚ùå Supabase no se pudo cargar');
    return false;
}

// Inicializar sin bloquear
initializeSupabase().catch(err => console.warn('‚ö†Ô∏è Init Supabase:', err));

// ===== FUNCI√ìN DE DIAGN√ìSTICO DE CONEXI√ìN =====
async function testSupabaseConnection() {
    console.log('üîç === DIAGN√ìSTICO DE CONEXI√ìN SUPABASE ===');
    
    try {
        // 1. Verificar que el cliente existe
        if (!window.supabaseClient) {
            console.error('‚ùå Cliente Supabase no inicializado');
            return { success: false, error: 'Cliente no inicializado' };
        }
        console.log('‚úÖ Cliente Supabase inicializado');
        
        // 2. Verificar conexi√≥n b√°sica con health check
        console.log('üîç Verificando conexi√≥n al servidor...');
        const healthResponse = await fetch(`${supabaseUrl}/rest/v1/`, {
            method: 'HEAD',
            headers: {
                'apikey': supabaseKey
            }
        }).catch(err => {
            console.error('‚ùå Error de red:', err.message);
            return null;
        });
        
        if (!healthResponse) {
            console.error('‚ùå No se puede conectar al servidor Supabase');
            console.error('üí° Posibles causas:');
            console.error('   1. No tienes conexi√≥n a internet');
            console.error('   2. El proyecto de Supabase est√° pausado/eliminado');
            console.error('   3. Firewall bloqueando la conexi√≥n');
            return { success: false, error: 'Sin conexi√≥n al servidor' };
        }
        console.log('‚úÖ Servidor Supabase accesible');
        
        // 3. Verificar sesi√≥n actual
        console.log('üîç Verificando sesi√≥n de usuario...');
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
            console.warn('‚ö†Ô∏è Error obteniendo sesi√≥n:', sessionError.message);
        }
        
        if (session) {
            console.log('‚úÖ Sesi√≥n activa:', {
                user: session.user.email,
                userId: session.user.id,
                expiresAt: new Date(session.expires_at * 1000).toLocaleString()
            });
        } else {
            console.log('‚ÑπÔ∏è No hay sesi√≥n activa (usuario no logueado)');
        }
        
        // 4. Test de conectividad a base de datos (si hay sesi√≥n)
        if (session) {
            console.log('üîç Probando consulta a base de datos...');
            const { data, error } = await supabase
                .from('accounts')
                .select('count')
                .limit(1);
            
            if (error) {
                console.error('‚ùå Error consultando base de datos:', error.message);
                return { success: false, error: error.message };
            }
            console.log('‚úÖ Consulta a base de datos exitosa');
        }
        
        console.log('‚úÖ === TODOS LOS TESTS PASARON ===');
        return { 
            success: true, 
            hasSession: !!session,
            userEmail: session?.user?.email || 'N/A'
        };
        
    } catch (error) {
        console.error('‚ùå Error durante diagn√≥stico:', error);
        return { success: false, error: error.message };
    }
}

// Exponer funci√≥n globalmente para uso en consola
window.testSupabaseConnection = testSupabaseConnection;

// Funci√≥n para verificar permisos RLS
async function testRLSPermissions() {
    if (!currentUser) {
        alert('‚ùå No hay usuario logueado');
        return;
    }

    try {
        console.log('üõ°Ô∏è Testing RLS permissions...');
        console.log('üë§ Current user ID:', currentUser.id);

        // Test 1: Probar SELECT en accounts
        console.log('üîç Testing SELECT on accounts...');
        const { data: selectData, error: selectError } = await supabase
            .from('accounts')
            .select('*')
            .eq('user_id', currentUser.id);

        if (selectError) {
            console.error('‚ùå SELECT test failed:', selectError);
            alert(`‚ùå Error en SELECT: ${selectError.message}`);
            return;
        }

        console.log('‚úÖ SELECT test passed:', selectData);

        // Test 2: Probar INSERT en accounts
        console.log('üîç Testing INSERT on accounts...');
        const testAccount = {
            id: 'test_' + Date.now(),
            user_id: currentUser.id,
            name: 'Test Account',
            currency: 'USD',
            platform: 'test',
            initial_balance: 1000,
            balance: 1000
        };

        const { data: insertData, error: insertError } = await supabase
            .from('accounts')
            .insert(testAccount)
            .select();

        if (insertError) {
            console.error('‚ùå INSERT test failed:', insertError);
            alert(`‚ùå Error en INSERT: ${insertError.message}`);
            return;
        }

        console.log('‚úÖ INSERT test passed:', insertData);

        // Test 3: Limpiar - eliminar el registro de prueba
        await supabase
            .from('accounts')
            .delete()
            .eq('id', testAccount.id);

        console.log('‚úÖ Test cleanup completed');
        alert('‚úÖ Todos los permisos RLS funcionan correctamente!');

    } catch (error) {
        console.error('‚ùå RLS test error:', error);
        alert(`‚ùå Error en prueba RLS: ${error.message}`);
    }
}

// ===== SUPABASE DATABASE FUNCTIONS =====

// Funci√≥n para inicializar las tablas de Supabase (solo para referencia)
async function initializeSupabaseTables() {
    // Las tablas deben crearse en el panel de Supabase con las siguientes estructuras:
    //
    // 1. accounts:
    //    - id (text, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - name (text)
    //    - currency (text)
    //    - platform (text)
    //    - initial_balance (numeric)
    //    - balance (numeric)
    //    - created_at (timestamp with time zone)
    //
    // 2. operations:
    //    - id (text, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - account_id (text)
    //    - date (text)
    //    - instrument (text)
    //    - type (text)
    //    - entry (numeric)
    //    - exit (numeric)
    //    - entry_time (text)
    //    - exit_time (text)
    //    - volume (numeric)
    //    - result (text)
    //    - pl (numeric)
    //    - currency (text)
    //    - notes (text)
    //    - image_datas (text[])
    //    - manual_pl (numeric)
    //    - session (text)
    //    - created_at (timestamp with time zone)
    //
    // 3. finances:
    //    - id (serial, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - date (text)
    //    - amount (numeric)
    //    - currency (text)
    //    - notes (text)
    //    - created_at (timestamp with time zone)
    //
    // 4. user_settings:
    //    - user_id (uuid, primary key, references auth.users(id))
    //    - settings (jsonb)
    //    - api_keys (jsonb)
    //    - created_at (timestamp with time zone)
    //    - updated_at (timestamp with time zone)
}

// ========================
// SISTEMA DE SINCRONIZACI√ìN AUTOM√ÅTICA
// ========================
let syncQueue = [];
let autoSyncInterval = null;
let isAutoSyncEnabled = true;

// Agregar elemento a la cola de sincronizaci√≥n
function addToSyncQueue(data, type) {
    syncQueue.push({
        data: data,
        type: type, // 'operation', 'account', 'finance'
        timestamp: Date.now(),
        attempts: 0
    });
    console.log(`üì• Agregado a cola de sincronizaci√≥n: ${type}`, data.id);
}

// Procesar cola de sincronizaci√≥n autom√°tica
async function processSyncQueue() {
    if (syncQueue.length === 0 || !currentUser) return;

    console.log(`üîÑ Procesando cola de sincronizaci√≥n: ${syncQueue.length} elementos pendientes`);

    const itemsToProcess = [...syncQueue];
    syncQueue = []; // Limpiar cola

    for (const item of itemsToProcess) {
        try {
            switch (item.type) {
                case 'operation':
                    await saveOperationToSupabase(item.data);
                    console.log(`‚úÖ Operaci√≥n sincronizada desde cola:`, item.data.id);
                    break;
                case 'account':
                    await saveAccountToSupabase(item.data);
                    console.log(`‚úÖ Cuenta sincronizada desde cola:`, item.data.id);
                    break;
                case 'finance':
                    await saveFinanceToSupabase(item.data);
                    console.log(`‚úÖ Finanza sincronizada desde cola:`, item.data.id);
                    break;
            }
        } catch (error) {
            console.error(`‚ùå Error sincronizando ${item.type}:`, error);
            // Reintentar si no ha fallado muchas veces
            if (item.attempts < 3) {
                item.attempts++;
                syncQueue.push(item);
                console.log(`üîÑ Reintentando sincronizaci√≥n (intento ${item.attempts}/3):`, item.data.id);
            } else {
                console.error(`‚ùå M√°ximo de intentos alcanzado para ${item.type}:`, item.data.id);
            }
        }
    }

    if (syncQueue.length === 0) {
        console.log('‚úÖ Cola de sincronizaci√≥n procesada completamente');
        showSyncNotification('üîÑ Sincronizaci√≥n autom√°tica completada', 'success');
    }
}

// Iniciar sincronizaci√≥n autom√°tica en segundo plano
function startAutoSync() {
    if (autoSyncInterval) return; // Ya est√° corriendo

    console.log('üöÄ Iniciando sincronizaci√≥n autom√°tica cada 30 segundos');
    autoSyncInterval = setInterval(() => {
        if (isAutoSyncEnabled && currentUser && syncQueue.length > 0) {
            processSyncQueue();
        }
    }, 30000); // Cada 30 segundos
}

// Detener sincronizaci√≥n autom√°tica
function stopAutoSync() {
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
        autoSyncInterval = null;
        console.log('‚èπÔ∏è Sincronizaci√≥n autom√°tica detenida');
    }
}

// Sincronizaci√≥n cuando el usuario se conecta
async function onUserLogin(user) {
    currentUser = user;
    isAutoSyncEnabled = true;

    console.log('üîê Usuario autenticado en onUserLogin:', user.email);

    try {
        console.log('üì• Cargando cuentas desde Supabase...');
        // Cargar cuentas desde Supabase
        const accounts = await loadAccountsFromSupabase();
        console.log('üìä Cuentas recibidas:', accounts.length, accounts);
        
        if (accounts.length > 0) {
            console.log('üíæ Actualizando DB.accounts...');
            DB.accounts = accounts;
            await dexieDB.accounts.clear();
            await dexieDB.accounts.bulkPut(accounts);
            console.log('‚úÖ DB.accounts actualizado:', DB.accounts.length);
            
            // Refrescar selector de cuentas
            const selector = document.getElementById('main-account-select');
            console.log('üîç Selector encontrado:', !!selector);
            if (selector) {
                console.log('üîÑ Llamando refreshAccountSelector...');
                refreshAccountSelector();
            }

            // Cargar credenciales de MEXC despu√©s de cargar las cuentas
            console.log('üîÑ Cargando credenciales de MEXC desde Supabase...');
            setTimeout(() => {
                loadMEXCCredentials().catch(err => {
                    console.warn('‚ö†Ô∏è No se pudieron cargar credenciales de MEXC:', err);
                });
                populateMEXCAccountSelect();
            }, 500);
        } else {
            console.log('‚ö†Ô∏è No hay cuentas en Supabase');
        }

        // ‚ú® CARGAR OPERACIONES DESDE SUPABASE
        console.log('üì• Cargando operaciones desde Supabase...');
        const operations = await loadOperationsFromSupabase();
        console.log('üìä Operaciones recibidas:', operations.length, operations);
        
        if (operations.length > 0) {
            console.log('üíæ Actualizando DB.operations...');
            DB.operations = operations;
            await dexieDB.operations.clear();
            await dexieDB.operations.bulkPut(operations);
            console.log('‚úÖ DB.operations actualizado:', DB.operations.length);
            
            // Refrescar dashboard si est√° visible
            if (document.getElementById('dashboard').classList.contains('active')) {
                refreshDashboard();
            }
        } else {
            console.log('‚ö†Ô∏è No hay operaciones en Supabase');
        }

        // ‚ú® CARGAR CUENTAS FINANCIADAS DESDE SUPABASE
        console.log('üì• Cargando cuentas financiadas desde Supabase...');
        const fundedAccounts = await loadFundedAccountsFromSupabase();
        console.log('üìä Cuentas financiadas recibidas:', fundedAccounts.length);
        
        if (fundedAccounts.length > 0) {
            console.log('üíæ Actualizando DB.fundedAccounts...');
            DB.fundedAccounts = fundedAccounts;
            await dexieDB.fundedAccounts.clear();
            await dexieDB.fundedAccounts.bulkPut(fundedAccounts);
            console.log('‚úÖ DB.fundedAccounts actualizado:', DB.fundedAccounts.length);
        }

        // ‚ú® CARGAR FINANZAS DESDE SUPABASE
        console.log('üì• Cargando finanzas desde Supabase...');
        const finances = await loadFinancesFromSupabase();
        console.log('üìä Finanzas recibidas:', finances.length);
        
        if (finances.length > 0) {
            console.log('üíæ Actualizando DB.finances...');
            // Convertir formato si es necesario
            const formattedFinances = finances.map(f => ({
                id: f.id,
                date: f.fecha || f.date,
                amount: f.monto || f.amount,
                type: f.tipo || f.type,
                currency: f.divisa || f.currency,
                notes: f.notas || f.notes
            }));
            DB.finances = formattedFinances;
            console.log('‚úÖ DB.finances actualizado:', DB.finances.length);
        }
    } catch (error) {
        console.error('‚ùå Error en onUserLogin:', error);
    }

    // Procesar cola de sincronizaci√≥n
    if (syncQueue.length > 0) {
        await processSyncQueue();
    }

    startAutoSync();
    
    // Inicializar Social Media
    if (typeof initSocialMedia === 'function') {
        console.log('üåê Inicializando Social Media...');
        initSocialMedia();
    }
    
    // Cargar configuraci√≥n de perfil p√∫blico
    if (typeof loadUserPublicSettings === 'function') {
        loadUserPublicSettings();
    }
}

// Cuando el usuario se desconecta
function onUserLogout() {
    stopAutoSync();
    isAutoSyncEnabled = false;
    currentUser = null;
    console.log('üëã Usuario desconectado - sincronizaci√≥n autom√°tica pausada');
}

// Funciones para operaciones con cuentas
async function saveAccountToSupabase(accountData) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save account to Supabase');
        return null;
    }

    try {
        console.log('üíæ Saving account to Supabase:', {
            id: accountData.id,
            user_id: currentUser.id,
            name: accountData.name,
            currency: accountData.currency
        });

        const { data, error } = await supabase
            .from('accounts')
            .upsert({
                id: accountData.id,
                user_id: currentUser.id,
                name: accountData.name,
                currency: accountData.currency,
                platform: accountData.platform,
                initial_balance: accountData.initialBalance,
                balance: accountData.balance
            });

        if (error) {
            console.error('‚ùå Supabase error saving account:', error);
            throw error;
        }

        console.log('‚úÖ Account saved to Supabase successfully:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Error saving account to Supabase:', error);
        throw error;
    }
}

async function loadAccountsFromSupabase() {
    if (!currentUser) return [];

    try {
        const { data, error } = await supabase
            .from('accounts')
            .select('*')
            .eq('user_id', currentUser.id);

        if (error) throw error;

        // Convertir de formato Supabase a formato local
        return data.map(account => ({
            id: account.id,
            name: account.name,
            currency: account.currency,
            platform: account.platform,
            initialBalance: account.initial_balance,
            balance: account.balance
        }));
    } catch (error) {
        console.error('Error loading accounts from Supabase:', error);
        return [];
    }
}

async function deleteAccountFromSupabase(accountId) {
    if (!currentUser) return;

    try {
        // Primero, eliminar todas las operaciones asociadas a esta cuenta
        console.log(`üóëÔ∏è Eliminando operaciones de la cuenta: ${accountId}`);
        
        const { error: opsError, data: deletedOps } = await supabase
            .from('operations')
            .delete()
            .eq('account_id', accountId)
            .eq('user_id', currentUser.id)
            .select();

        if (opsError) {
            console.error('Error eliminando operaciones:', opsError);
            throw opsError;
        }

        console.log(`‚úÖ ${deletedOps?.length || 0} operaciones eliminadas`);

        // Luego, eliminar la cuenta
        console.log(`üóëÔ∏è Eliminando cuenta: ${accountId}`);
        
        const { error: accountError } = await supabase
            .from('accounts')
            .delete()
            .eq('id', accountId)
            .eq('user_id', currentUser.id);

        if (accountError) {
            console.error('Error eliminando cuenta:', accountError);
            throw accountError;
        }

        console.log(`‚úÖ Cuenta eliminada exitosamente`);
        
    } catch (error) {
        console.error('Error deleting account from Supabase:', error);
        throw error;
    }
}

// Funciones para funded accounts
async function saveFundedAccountToSupabase(fundedData) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save funded account to Supabase');
        return null;
    }

    try {
        console.log('üíæ Saving funded account to Supabase:', {
            id: fundedData.id,
            user_id: currentUser.id,
            name: fundedData.name,
            company: fundedData.company
        });

        const { data, error } = await supabase
            .from('funded_accounts')
            .upsert({
                id: fundedData.id,
                user_id: currentUser.id,
                name: fundedData.name,
                company: fundedData.company,
                type: fundedData.type,
                status: fundedData.status,
                fee: fundedData.fee,
                activation_date: fundedData.activationDate,
                earnings: fundedData.earnings,
                withdrawals: fundedData.withdrawals,
                notes: fundedData.notes,
                updated_at: new Date().toISOString()
            });

        if (error) {
            console.error('‚ùå Supabase error saving funded account:', error);
            throw error;
        }

        console.log('‚úÖ Funded account saved to Supabase successfully:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Error saving funded account to Supabase:', error);
        throw error;
    }
}

async function loadFundedAccountsFromSupabase() {
    if (!currentUser) return [];

    try {
        const { data, error } = await supabase
            .from('funded_accounts')
            .select('*')
            .eq('user_id', currentUser.id);

        if (error) throw error;

        // Convertir de formato Supabase a formato local
        return data.map(funded => ({
            id: funded.id,
            name: funded.name,
            company: funded.company,
            type: funded.type,
            status: funded.status,
            fee: funded.fee,
            activationDate: funded.activation_date,
            earnings: funded.earnings,
            withdrawals: funded.withdrawals,
            notes: funded.notes
        }));
    } catch (error) {
        console.error('Error loading funded accounts from Supabase:', error);
        return [];
    }
}

async function deleteFundedAccountFromSupabase(fundedId) {
    if (!currentUser) return;

    try {
        const { error } = await supabase
            .from('funded_accounts')
            .delete()
            .eq('id', fundedId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
    } catch (error) {
        console.error('Error deleting funded account from Supabase:', error);
        throw error;
    }
}

// Funciones para setups (Playbook)
async function saveSetupToSupabase(setupData) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save setup to Supabase');
        return null;
    }

    try {
        console.log('üíæ Saving setup to Supabase:', {
            id: setupData.id,
            user_id: currentUser.id,
            name: setupData.name,
            category: setupData.category
        });

        const { data, error } = await supabase
            .from('setups')
            .upsert({
                id: setupData.id,
                user_id: currentUser.id,
                name: setupData.name,
                category: setupData.category,
                rating: setupData.rating,
                description: setupData.description,
                tags: setupData.tags,
                images: setupData.images || [],
                updated_at: new Date().toISOString()
            });

        if (error) {
            console.error('‚ùå Supabase error saving setup:', error);
            throw error;
        }

        console.log('‚úÖ Setup saved to Supabase successfully:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Error saving setup to Supabase:', error);
        throw error;
    }
}

async function loadSetupsFromSupabase() {
    if (!currentUser) return [];

    try {
        const { data, error } = await supabase
            .from('setups')
            .select('*')
            .eq('user_id', currentUser.id);

        if (error) throw error;

        // Convertir de formato Supabase a formato local
        return data.map(setup => ({
            id: setup.id,
            name: setup.name,
            category: setup.category,
            rating: setup.rating,
            description: setup.description,
            tags: setup.tags,
            images: setup.images || [],
            createdAt: setup.created_at,
            updatedAt: setup.updated_at
        }));
    } catch (error) {
        console.error('Error loading setups from Supabase:', error);
        return [];
    }
}

async function deleteSetupFromSupabase(setupId) {
    if (!currentUser) return;

    try {
        const { error } = await supabase
            .from('setups')
            .delete()
            .eq('id', setupId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
    } catch (error) {
        console.error('Error deleting setup from Supabase:', error);
        throw error;
    }
}

// Funciones para API Keys de exchanges

// Guardar credenciales de BingX en Supabase
async function saveBingXCredentialsToSupabase(apiKey, secretKey, accountId) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save BingX credentials to Supabase');
        return null;
    }

    try {
        console.log('üíæ [saveBingX] Iniciando guardado en Supabase...');
        console.log('üíæ [saveBingX] User ID:', currentUser.id);
        console.log('üíæ [saveBingX] Account ID:', accountId);
        
        // Primero obtener las settings actuales
        console.log('üì• [saveBingX] Consultando settings existentes...');
        const { data: existingSettings, error: fetchError } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (fetchError && fetchError.code !== 'PGRST116') {
            console.error('‚ùå [saveBingX] Error al consultar settings:', fetchError);
        }

        let apiKeys = existingSettings?.api_keys || {};
        console.log('üìä [saveBingX] API Keys existentes:', Object.keys(apiKeys));
        
        // Actualizar credenciales de BingX
        apiKeys.bingx = {
            apiKey: apiKey,
            secretKey: secretKey,
            accountId: accountId,
            updatedAt: new Date().toISOString()
        };

        console.log('üíæ [saveBingX] Ejecutando upsert...');
        // Guardar o actualizar
        const { data, error } = await supabase
            .from('user_settings')
            .upsert({
                user_id: currentUser.id,
                api_keys: apiKeys,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id'
            });

        if (error) {
            console.error('‚ùå [saveBingX] Error en upsert:', error);
            console.error('‚ùå [saveBingX] Error code:', error.code);
            console.error('‚ùå [saveBingX] Error message:', error.message);
            throw error;
        }

        console.log('‚úÖ [saveBingX] Credenciales BingX guardadas exitosamente');
        console.log('‚úÖ [saveBingX] Response:', data);
        return data;
    } catch (error) {
        console.error('‚ùå [saveBingX] Error en saveBingXCredentialsToSupabase:', error);
        console.error('‚ùå [saveBingX] Stack:', error.stack);
        throw error;
    }
}

// Cargar credenciales de BingX desde Supabase
async function loadBingXCredentialsFromSupabase() {
    if (!currentUser) {
        console.log('‚ÑπÔ∏è No hay usuario autenticado para cargar credenciales BingX');
        return null;
    }

    try {
        console.log('üì• Cargando credenciales BingX de Supabase...');
        
        const { data, error } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                console.log('‚ÑπÔ∏è No hay settings guardados a√∫n');
                return null;
            }
            throw error;
        }

        const bingxCreds = data?.api_keys?.bingx;
        if (bingxCreds) {
            console.log('‚úÖ Credenciales BingX cargadas de Supabase');
            return {
                key: bingxCreds.apiKey,
                secret: bingxCreds.secretKey,
                accountId: bingxCreds.accountId
            };
        }

        return null;
    } catch (error) {
        console.error('‚ùå Error cargando credenciales BingX de Supabase:', error);
        return null;
    }
}

async function saveMEXCCredentialsToSupabase(apiKey, secretKey, accountId) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save MEXC credentials to Supabase');
        return null;
    }

    try {
        console.log('üíæ [saveMEXC] Iniciando guardado en Supabase...');
        console.log('üíæ [saveMEXC] User ID:', currentUser.id);
        console.log('üíæ [saveMEXC] Account ID:', accountId);
        
        // Primero obtener las settings actuales
        console.log('üì• [saveMEXC] Consultando settings existentes...');
        const { data: existingSettings, error: fetchError } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (fetchError && fetchError.code !== 'PGRST116') {
            console.error('‚ùå [saveMEXC] Error al consultar settings:', fetchError);
        }

        let apiKeys = existingSettings?.api_keys || {};
        console.log('üìä [saveMEXC] API Keys existentes:', Object.keys(apiKeys));
        
        // Actualizar credenciales de MEXC
        apiKeys.mexc = {
            apiKey: apiKey,
            secretKey: secretKey,
            accountId: accountId,
            updatedAt: new Date().toISOString()
        };

        console.log('üíæ [saveMEXC] Ejecutando upsert...');
        // Guardar o actualizar
        const { data, error } = await supabase
            .from('user_settings')
            .upsert({
                user_id: currentUser.id,
                api_keys: apiKeys,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id'
            });

        if (error) {
            console.error('‚ùå [saveMEXC] Error en upsert:', error);
            console.error('‚ùå [saveMEXC] Error code:', error.code);
            console.error('‚ùå [saveMEXC] Error message:', error.message);
            throw error;
        }

        console.log('‚úÖ [saveMEXC] Credenciales MEXC guardadas exitosamente');
        console.log('‚úÖ [saveMEXC] Response:', data);
        return data;
    } catch (error) {
        console.error('‚ùå [saveMEXC] Error en saveMEXCCredentialsToSupabase:', error);
        console.error('‚ùå [saveMEXC] Stack:', error.stack);
        throw error;
    }
}

async function loadMEXCCredentialsFromSupabase() {
    if (!currentUser) {
        console.log('‚ÑπÔ∏è No hay usuario autenticado para cargar credenciales MEXC');
        return null;
    }

    try {
        console.log('üì• Cargando credenciales MEXC desde Supabase...');
        
        const { data, error } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
            console.error('‚ùå Error cargando credenciales MEXC:', error);
            throw error;
        }

        if (data && data.api_keys && data.api_keys.mexc) {
            console.log('‚úÖ Credenciales MEXC encontradas en Supabase');
            return {
                apiKey: data.api_keys.mexc.apiKey,
                secretKey: data.api_keys.mexc.secretKey,
                accountId: data.api_keys.mexc.accountId
            };
        }

        console.log('‚ÑπÔ∏è No hay credenciales MEXC guardadas en Supabase');
        return null;
    } catch (error) {
        console.error('‚ùå Error en loadMEXCCredentialsFromSupabase:', error);
        return null;
    }
}

// Funciones para operaciones
async function saveOperationToSupabase(operationData) {
    console.log('üì§ [saveOperationToSupabase] Iniciando...');
    
    if (!currentUser) {
        console.log('‚ùå [saveOperationToSupabase] No hay currentUser');
        return null;
    }

    console.log('üì§ [saveOperationToSupabase] Usuario:', currentUser.id);
    console.log('üì§ [saveOperationToSupabase] Operaci√≥n:', operationData.id);

    try {
        const dataToSave = {
            id: operationData.id,
            user_id: currentUser.id,
            account_id: operationData.accountId,
            date: operationData.date,
            instrument: operationData.instrument,
            type: operationData.type,
            entry: parseFloat(operationData.entry) || 0,
            exit: parseFloat(operationData.exit) || 0,
            entry_time: operationData.entryTime || null,
            exit_time: operationData.exitTime || null,
            volume: parseFloat(operationData.volume) || 0,
            result: operationData.result,
            pl: parseFloat(operationData.pl) || 0,
            currency: operationData.currency || 'USD',
            notes: operationData.notes || '',
            image_datas: operationData.imageDatas || [],
            fees: parseFloat(operationData.fees) || 0,
            manual_pl: parseFloat(operationData.manualPL || operationData.pl) || 0,
            session: operationData.session || 'No especificado'
        };

        console.log('üì§ [saveOperationToSupabase] Datos a enviar:', dataToSave);

        const { data, error } = await supabase
            .from('operations')
            .upsert(dataToSave, {
                onConflict: 'id'
            });

        if (error) {
            console.error('‚ùå [saveOperationToSupabase] Error de Supabase:', error);
            console.error('‚ùå [saveOperationToSupabase] C√≥digo:', error.code);
            console.error('‚ùå [saveOperationToSupabase] Mensaje:', error.message);
            console.error('‚ùå [saveOperationToSupabase] Detalles:', error.details);
            
            // Si es un error de duplicado, no lo consideramos error
            if (error.code === '23505' || error.message?.includes('duplicate')) {
                console.log('‚ÑπÔ∏è [saveOperationToSupabase] Operaci√≥n duplicada (ya existe)');
                return null;
            }
            throw error;
        }

        console.log('‚úÖ [saveOperationToSupabase] Guardado exitoso:', data);
        return data;
    } catch (error) {
        console.error('‚ùå [saveOperationToSupabase] Error capturado:', error);
        console.error('‚ùå [saveOperationToSupabase] Stack:', error.stack);
        throw error; // Re-lanzar para que lo capture el catch superior
    }
}

async function loadOperationsFromSupabase() {
    if (!currentUser) return [];

    try {
        const { data, error } = await supabase
            .from('operations')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });

        if (error) throw error;

        // Convertir de formato Supabase a formato local
        return data.map(operation => ({
            id: operation.id,
            accountId: operation.account_id,
            date: operation.date,
            instrument: operation.instrument,
            type: operation.type,
            entry: operation.entry || 0,
            exit: operation.exit || 0,
            entryTime: operation.entry_time,
            exitTime: operation.exit_time,
            volume: operation.volume || 0,
            result: operation.result,
            pl: operation.pl || 0,
            currency: operation.currency || 'USD',
            notes: operation.notes || '',
            imageDatas: operation.image_datas || [],
            fees: operation.fees || 0,
            manualPL: operation.manual_pl || operation.pl || 0,
            session: operation.session || 'No especificado'
        }));
    } catch (error) {
        console.error('Error loading operations from Supabase:', error);
        return [];
    }
}

async function deleteOperationFromSupabase(operationId) {
    if (!currentUser) return;

    try {
        const { error } = await supabase
            .from('operations')
            .delete()
            .eq('id', operationId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
    } catch (error) {
        console.error('Error deleting operation from Supabase:', error);
        throw error;
    }
}

// Funciones para finanzas
async function saveFinanceToSupabase(financeData) {
    if (!currentUser) return null;

    try {
        const { data, error } = await supabase
            .from('finances')
            .insert({
                user_id: currentUser.id,
                date: financeData.date,
                amount: financeData.amount,
                type: financeData.type,
                currency: financeData.currency || 'USD',
                notes: financeData.notes || '',
                account_id: financeData.accountId
            })
            .select();

        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Error saving finance to Supabase:', error);
        throw error;
    }
}

async function updateFinanceInSupabase(supabaseId, financeData) {
    if (!currentUser) return null;

    try {
        const { data, error } = await supabase
            .from('finances')
            .update({
                date: financeData.date,
                amount: financeData.amount,
                type: financeData.type,
                currency: financeData.currency || 'USD',
                notes: financeData.notes || '',
                account_id: financeData.accountId
            })
            .eq('id', supabaseId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error updating finance in Supabase:', error);
        throw error;
    }
}

async function loadFinancesFromSupabase() {
    if (!currentUser) return [];

    try {
        const { data, error } = await supabase
            .from('finances')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });

        if (error) throw error;

        // Convertir de formato Supabase a formato local
        return data.map(finance => ({
            id: finance.id,
            date: finance.date,
            amount: finance.amount,
            type: finance.type,
            currency: finance.currency || 'USD',
            notes: finance.notes || '',
            accountId: finance.account_id
        }));
    } catch (error) {
        console.error('Error loading finances from Supabase:', error);
        return [];
    }
}

async function deleteFinanceFromSupabase(financeId) {
    if (!currentUser) return;

    try {
        const { error } = await supabase
            .from('finances')
            .delete()
            .eq('id', financeId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
    } catch (error) {
        console.error('Error deleting finance from Supabase:', error);
        throw error;
    }
}

// Funciones para configuraciones de usuario
async function saveUserSettingsToSupabase(settings, apiKeys = null) {
    if (!currentUser) return;

    try {
        const { data, error } = await supabase
            .from('user_settings')
            .upsert({
                user_id: currentUser.id,
                settings: settings,
                api_keys: apiKeys,
                updated_at: new Date().toISOString()
            });

        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error saving user settings to Supabase:', error);
        throw error;
    }
}

async function loadUserSettingsFromSupabase() {
    if (!currentUser) return { settings: null, apiKeys: null };

    try {
        const { data, error } = await supabase
            .from('user_settings')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (error && error.code !== 'PGRST116') throw error; // PGRST116 es "no rows returned"

        return {
            settings: data?.settings || null,
            apiKeys: data?.api_keys || null
        };
    } catch (error) {
        console.error('Error loading user settings from Supabase:', error);
        return { settings: null, apiKeys: null };
    }
}

// FUNCI√ìN DE SINCRONIZACI√ìN INTELIGENTE (NO DESTRUCTIVA)
async function syncDataFromSupabase() {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot sync data from Supabase');
        return;
    }

    if (isSyncing) {
        console.log('üîÑ Sincronizaci√≥n ya en progreso, saltando...');
        return;
    }

    try {
        isSyncing = true;
        console.log('üîÑ Sincronizaci√≥n inteligente iniciada para usuario:', currentUser.email);

        // Cargar todos los datos desde Supabase
        const [accounts, operations, finances, userSettings, fundedAccounts, setups, chartbookImages, journalEntries] = await Promise.all([
            loadAccountsFromSupabase(),
            loadOperationsFromSupabase(),
            loadFinancesFromSupabase(),
            loadUserSettingsFromSupabase(),
            loadFundedAccountsFromSupabase(),
            loadSetupsFromSupabase(),
            loadChartbookImagesFromSupabase(),
            loadJournalEntriesFromSupabase()
        ]);

        console.log('üìä Datos cargados desde Supabase:', {
            accounts: accounts.length,
            operations: operations.length,
            finances: finances.length,
            fundedAccounts: fundedAccounts.length,
            setups: setups.length,
            chartbookImages: chartbookImages.length,
            journalEntries: journalEntries.length,
            hasSettings: !!userSettings.settings
        });

        // NUEVA L√ìGICA: PRESERVAR DATOS LOCALES SIEMPRE
        const hasLocalData = DB.accounts.length > 0 || DB.operations.length > 0 || DB.finances.length > 0;
        const hasSupabaseData = accounts.length > 0 || operations.length > 0 || finances.length > 0;

        console.log('üìã Estado de datos:', {
            hasLocalData,
            hasSupabaseData,
            localAccounts: DB.accounts.length,
            localOperations: DB.operations.length,
            localFinances: DB.finances.length,
            localFundedAccounts: DB.fundedAccounts.length,
            localSetups: DB.setups.length,
            supabaseAccounts: accounts.length,
            supabaseOperations: operations.length,
            supabaseFinances: finances.length,
            supabaseFundedAccounts: fundedAccounts.length,
            supabaseSetups: setups.length
        });

        if (hasLocalData && !hasSupabaseData) {
            // Caso 1: Tengo datos locales pero Supabase est√° vac√≠o -> SUBIR datos locales
            console.log('üì§ Subiendo datos locales a Supabase (preservando datos del usuario)');

            try {
                // Subir todos los datos locales a Supabase
                for (const account of DB.accounts) {
                    await saveAccountToSupabase(account);
                }
                for (const operation of DB.operations) {
                    await saveOperationToSupabase(operation);
                }
                for (const finance of DB.finances) {
                    await saveFinanceToSupabase(finance);
                }
                for (const funded of DB.fundedAccounts) {
                    await saveFundedAccountToSupabase(funded);
                }
                for (const setup of DB.setups) {
                    await saveSetupToSupabase(setup);
                }

                console.log('‚úÖ Datos guardados exitosamente');
                showSyncNotification('üì§ Datos sincronizados a la nube exitosamente', 'success');

            } catch (uploadError) {
                console.error('‚ùå Error subiendo datos locales a Supabase:', uploadError);
                showSyncNotification('‚ö†Ô∏è Error al guardar - datos seguros localmente', 'warning');
            }

        } else if (!hasLocalData && hasSupabaseData) {
            // Caso 2: No tengo datos locales pero Supabase tiene datos -> BAJAR datos de Supabase
            console.log('üì• Descargando datos desde Supabase (primera carga)');

            DB.accounts = accounts;
            DB.operations = operations;
            DB.finances = finances;
            DB.fundedAccounts = fundedAccounts;
            DB.setups = setups;
            DB.chartbookImages = chartbookImages || [];
            DB.journalEntries = journalEntries || [];

            // Actualizar Dexie con los datos de Supabase
            await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, dexieDB.finances, dexieDB.fundedAccounts, dexieDB.setups, dexieDB.generalData, async () => {
                await dexieDB.accounts.clear();
                await dexieDB.operations.clear();
                await dexieDB.finances.clear();
                await dexieDB.fundedAccounts.clear();
                await dexieDB.setups.clear();

                if (accounts.length > 0) await dexieDB.accounts.bulkPut(accounts);
                if (operations.length > 0) await dexieDB.operations.bulkPut(operations);
                if (finances.length > 0) await dexieDB.finances.bulkPut(finances);
                if (fundedAccounts.length > 0) await dexieDB.fundedAccounts.bulkPut(fundedAccounts);
                if (setups.length > 0) await dexieDB.setups.bulkPut(setups);
            });

            console.log('‚úÖ Datos descargados desde Supabase');
            showSyncNotification('üì• Datos descargados desde la nube', 'success');

        } else if (hasLocalData && hasSupabaseData) {
            // Caso 3: Tengo datos en ambos lados -> NO HACER NADA AUTOM√ÅTICAMENTE
            console.log('üîí DATOS LOCALES PRESERVADOS - no se sobrescriben autom√°ticamente');
            console.log('‚ÑπÔ∏è Para sincronizar manualmente, use la funci√≥n de sincronizaci√≥n manual');
            showSyncNotification('ÔøΩ Datos seguros en el dispositivo', 'info');

        } else {
            // Caso 4: No hay datos en ning√∫n lado - usuario completamente nuevo
            console.log('üÜï Usuario nuevo - no hay datos para sincronizar');
        }

        // Manejar configuraciones de usuario
        if (userSettings.settings) {
            DB.settings = userSettings.settings;
            await dexieDB.generalData.put({ key: 'settings', value: userSettings.settings });
        }
        if (userSettings.apiKeys) {
            DB.apiKeys = userSettings.apiKeys;
            await dexieDB.generalData.put({ key: 'apiKeys', value: userSettings.apiKeys });
        }

        updateAccountBalances();
        refreshAllViews();

        console.log('‚úÖ Sincronizaci√≥n autom√°tica completada exitosamente');

    } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n autom√°tica:', error);
        // Si hay error, mantener los datos locales
        showSyncNotification('‚ö†Ô∏è Error al guardar - datos seguros localmente', 'warning');
    } finally {
        isSyncing = false;
    }
}

// Referencias DOM
const authModal = document.getElementById('authModal');
const mainApp = document.getElementById('mainApp');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const authMessage = document.getElementById('authMessage');
const userMenuTrigger = document.getElementById('userMenuTrigger');
const userEmail = document.getElementById('userEmail');
const userAvatar = document.getElementById('userAvatar');
const logoutBtn = document.getElementById('header-logout-btn'); // Corregido: usar header-logout-btn

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Inicializando sistema de autenticaci√≥n...');

    // Configurar event listeners
    setupEventListeners();

    // Verificar sesi√≥n existente
    await checkAuth();
});

// ===== EVENT LISTENERS =====
function setupEventListeners() {
    // Tabs de autenticaci√≥n
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            switchAuthTab(tabName);
        });
    });

    // Formularios - con validaci√≥n
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    } else {
        console.warn('‚ö†Ô∏è loginForm no encontrado en el DOM');
    }
    
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    } else {
        console.warn('‚ö†Ô∏è registerForm no encontrado en el DOM');
    }

    // Logout - con validaci√≥n
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    } else {
        console.warn('‚ö†Ô∏è logoutBtn no encontrado en el DOM');
    }
    
    console.log('‚úÖ Event listeners de autenticaci√≥n configurados');
}

// ===== FUNCIONES DE UI =====
function switchAuthTab(tabName) {
    // Actualizar tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Actualizar formularios
    document.querySelectorAll('.auth-form').forEach(form => {
        form.classList.remove('active');
    });
    document.getElementById(`${tabName}Form`).classList.add('active');

    // Limpiar mensaje
    hideMessage();
}

function showMessage(message, type = 'error') {
    authMessage.textContent = message;
    authMessage.className = type === 'error' ? 'auth-error' : 'auth-success';
    authMessage.style.display = 'block';
}

function hideMessage() {
    authMessage.style.display = 'none';
}

function showAuth() {
    const authModal = document.getElementById('authModal');
    const mainApp = document.getElementById('mainApp');
    
    if (authModal) {
        authModal.classList.add('active');
    }
    if (mainApp) {
        mainApp.classList.add('app-hidden');
    }
    
    console.log('üìã Modal de autenticaci√≥n mostrado');
}

function hideAuth() {
    const authModal = document.getElementById('authModal');
    const mainApp = document.getElementById('mainApp');
    
    if (authModal) {
        authModal.classList.remove('active');
    }
    if (mainApp) {
        mainApp.classList.remove('app-hidden');
    }
    
    console.log('‚úÖ Modal de autenticaci√≥n ocultado');
}

function updateUserInfo(user) {
    console.log('üë§ Updating user info:', user.email);
    console.log('üîç Asignando currentUser...');
    currentUser = user;
    console.log('üîç currentUser asignado:', currentUser);
    
    // Actualizar header del usuario (nuevo sistema)
    if (typeof updateUserHeader === 'function') {
        updateUserHeader();
    }

    // Actualizar estado de autenticaci√≥n en configuraci√≥n
    if (typeof updateAuthStatus === 'function') {
        updateAuthStatus();
    }

    // Actualizar interfaz de configuraci√≥n
    if (typeof updateConfigUserInfo === 'function') {
        updateConfigUserInfo(user);
    }

    console.log('‚úÖ Usuario autenticado');
}

function clearUserInfo() {
    currentUser = null;
    const userMenuTrigger = document.getElementById('userMenuTrigger');
    if (userMenuTrigger) userMenuTrigger.style.display = 'none';

    // Actualizar estado de autenticaci√≥n en configuraci√≥n
    if (typeof updateAuthStatus === 'function') {
        updateAuthStatus();
    }
}

// Toggle del menu desplegable de usuario
function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

// Cerrar dropdown si se hace click fuera
document.addEventListener('click', function(event) {
    const userMenu = document.getElementById('userMenuTrigger');
    const dropdown = document.getElementById('userDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.style.display = 'none';
    }
});

// ===== FUNCIONES DE AUTENTICACI√ìN =====
async function checkAuth() {
    try {
        console.log('üîê Verificando autenticaci√≥n...');
        
        // Asegurar que Supabase est√© inicializado
        if (!supabase) {
            const initialized = await initializeSupabase();
            if (!initialized) {
                console.error('‚ùå No se pudo inicializar Supabase');
                showAuth();
                return;
            }
        }
        
        if (!supabase || !supabase.auth) {
            console.error('‚ùå Supabase auth no disponible');
            // Si es vista p√∫blica, no mostrar login
            if (!window.IS_PUBLIC_AUDICION_VIEW) {
                showAuth();
            }
            return;
        }
        
        // Si es vista p√∫blica, saltar autenticaci√≥n completamente
        if (window.IS_PUBLIC_AUDICION_VIEW) {
            console.log('üìä Vista p√∫blica detectada - saltando autenticaci√≥n');
            hideAuth();
            return;
        }
        
        const { data: { session } } = await supabase.auth.getSession();

        console.log('üîê Sesi√≥n:', session ? 'Activa' : 'No activa');

        if (session?.user) {
            console.log('‚úÖ Usuario logueado:', session.user.email);
            console.log('üë§ User ID:', session.user.id);
            updateUserInfo(session.user);
            hideAuth();

            // ACTIVAR SINCRONIZACI√ìN AUTOM√ÅTICA
            await onUserLogin(session.user);

        } else {
            console.log('‚ö†Ô∏è No hay sesi√≥n activa - mostrando login');
            clearUserInfo();
            showAuth();
            onUserLogout();
        }
    } catch (error) {
        console.error('‚ùå Error verificando autenticaci√≥n:', error);
        showAuth();
        onUserLogout();
    }
}

async function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
        showMessage('Por favor completa todos los campos');
        return;
    }

    // Deshabilitar bot√≥n
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando sesi√≥n...';

    try {
        // Verificar que Supabase est√© disponible
        if (!supabase) {
            const initialized = await initializeSupabase();
            if (!initialized) {
                showMessage('Error: Sistema de autenticaci√≥n no disponible');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n';
                return;
            }
        }
        
        if (!supabase || !supabase.auth) {
            showMessage('Error: Supabase no est√° configurado correctamente');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n';
            return;
        }
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        console.log('‚úÖ Login exitoso:', data.user.email);
        showMessage('¬°Bienvenido de vuelta!', 'success');

        setTimeout(async () => {
            updateUserInfo(data.user);
            hideAuth();
            hideMessage();

            // ACTIVAR SINCRONIZACI√ìN AUTOM√ÅTICA AL HACER LOGIN
            await onUserLogin(data.user);
        }, 1000);

    } catch (error) {
        console.error('‚ùå Error en login:', error);
        showMessage(getErrorMessage(error.message));
    } finally {
        // Rehabilitar bot√≥n
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n';
    }
}

async function handleRegister(e) {
    e.preventDefault();

    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validaciones
    if (!email || !password || !confirmPassword) {
        showMessage('Por favor completa todos los campos');
        return;
    }

    if (password !== confirmPassword) {
        showMessage('Las contrase√±as no coinciden');
        return;
    }

    if (password.length < 6) {
        showMessage('La contrase√±a debe tener al menos 6 caracteres');
        return;
    }

    // Deshabilitar bot√≥n
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando cuenta...';

    try {
        // Verificar que Supabase est√© disponible
        if (!supabase) {
            await initializeSupabase();
        }
        
        if (!supabase || !supabase.auth) {
            throw new Error('Sistema de autenticaci√≥n no disponible. Por favor recarga la p√°gina.');
        }
        
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password
        });

        if (error) throw error;

        if (data.user && !data.session) {
            showMessage('¬°Cuenta creada! Revisa tu email para confirmar tu cuenta', 'success');
            // Cambiar a tab de login despu√©s de unos segundos
            setTimeout(() => {
                switchAuthTab('login');
                document.getElementById('loginEmail').value = email;
            }, 3000);
        } else if (data.session) {
            console.log('‚úÖ Registro exitoso:', data.user.email);
            showMessage('¬°Cuenta creada exitosamente!', 'success');

            setTimeout(() => {
                updateUserInfo(data.user);
                hideAuth();
                hideMessage();
            }, 1000);
        }

    } catch (error) {
        console.error('‚ùå Error en registro:', error);
        showMessage(getErrorMessage(error.message));
    } finally {
        // Rehabilitar bot√≥n
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Cuenta';
    }
}

async function handleLogout() {
    try {
        console.log('üö™ Cerrando sesi√≥n...');

        // Verificar que Supabase est√© disponible
        if (!supabase || !supabase.auth) {
            console.error('‚ùå Supabase no disponible para logout');
            clearUserInfo();
            showAuth();
            return;
        }
        
        const { error } = await supabase.auth.signOut();

        if (error) throw error;

        clearUserInfo();
        showAuth(); // Mostrar login despu√©s de logout

        // DESACTIVAR SINCRONIZACI√ìN AUTOM√ÅTICA AL HACER LOGOUT
        onUserLogout();

        // Limpiar formularios
        loginForm.reset();
        registerForm.reset();
        hideMessage();

        console.log('‚úÖ Sesi√≥n cerrada exitosamente');

    } catch (error) {
        console.error('‚ùå Error cerrando sesi√≥n:', error);
        alert('Error al cerrar sesi√≥n: ' + error.message);
    }
}

// ===== UTILIDADES =====
function getErrorMessage(errorMsg) {
    const errorMessages = {
        'Invalid login credentials': 'Email o contrase√±a incorrectos',
        'Email not confirmed': 'Por favor confirma tu email antes de iniciar sesi√≥n',
        'User not found': 'Usuario no encontrado',
        'Invalid email': 'Email no v√°lido',
        'Password should be at least 6 characters': 'La contrase√±a debe tener al menos 6 caracteres',
        'User already registered': 'Este email ya est√° registrado',
        'Signup is disabled': 'El registro est√° deshabilitado',
        'Email address not authorized': 'Email no autorizado'
    };

    return errorMessages[errorMsg] || errorMsg;
}

// ===== LISTENERS DE SUPABASE =====
// Configurar listener cuando Supabase est√© listo
initializeSupabase().then(() => {
    if (supabase && supabase.auth) {
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('üîÑ Cambio de estado de autenticaci√≥n:', event);

            if (event === 'SIGNED_IN' && session?.user) {
                updateUserInfo(session.user);
                hideAuth();
            } else if (event === 'SIGNED_OUT') {
                clearUserInfo();
                showAuth();
            }
        });
    } else {
        console.error('‚ùå No se puede configurar listener de autenticaci√≥n: Supabase no disponible');
    }
});

// ===== FUNCIONES GLOBALES =====
window.getCurrentUser = () => currentUser;
window.isAuthenticated = () => !!currentUser;

// Funci√≥n temporal para verificar datos en Supabase
async function checkSupabaseData() {
    if (!currentUser) {
        console.log('‚ùå No hay usuario autenticado para verificar datos');
        alert('‚ùå No hay usuario autenticado. Inicia sesi√≥n primero.');
        return;
    }

    try {
        console.log('üîç Verificando datos en Supabase para usuario:', currentUser.email);

        // Verificar operaciones
        const { data: operations, error: opsError } = await supabase
            .from('operaciones')
            .select('*')
            .eq('user_id', currentUser.id);

        if (opsError) {
            console.error('‚ùå Error verificando operaciones:', opsError);
        } else {
            console.log('üìä Operaciones en Supabase:', operations.length, operations);
        }

        // Verificar finanzas
        const { data: finances, error: finError } = await supabase
            .from('financia')
            .select('*')
            .eq('user_id', currentUser.id);

        if (finError) {
            console.error('‚ùå Error verificando finanzas:', finError);
        } else {
            console.log('üí∞ Finanzas en Supabase:', finances.length, finances);
        }

        // Verificar cuentas
        const { data: accounts, error: accError } = await supabase
            .from('accounts')
            .select('*')
            .eq('user_id', currentUser.id);

        if (accError) {
            console.error('‚ùå Error verificando cuentas:', accError);
        } else {
            console.log('üè¶ Cuentas en Supabase:', accounts.length, accounts);
        }

        alert(`Datos en Supabase:\n- Operaciones: ${operations?.length || 0}\n- Finanzas: ${finances?.length || 0}\n- Cuentas: ${accounts?.length || 0}`);

    } catch (error) {
        console.error('‚ùå Error verificando datos en Supabase:', error);
        alert('Error verificando datos: ' + error.message);
    }
}

// Hacer disponible globalmente para pruebas
window.checkSupabaseData = checkSupabaseData;

// ============================================
// INTEGRACI√ìN CON BINGX API
// ============================================

class BingXAPI {
    constructor(apiKey, secretKey) {
        this.apiKey = apiKey;
        this.secretKey = secretKey;
    this.proxyURL = window.BINGX_PROXY_URL || window.PROXY_URL || 'http://127.0.0.1:8003';
        console.log('üîó BingX API inicializada en modo REAL');
        console.log(`üåê Proxy URL: ${this.proxyURL}`);
    }

    // Probar conexi√≥n sin autenticaci√≥n
    async testConnection() {
        try {
            const response = await fetch(`${this.proxyURL}/proxy-bingx/test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error en test connection:', error);
            throw error;
        }
    }

    // Funci√≥n para descubrir endpoints que funcionan
    async discoverWorkingEndpoints() {
        console.log('üîç Iniciando descubrimiento de endpoints...');

        const testEndpoints = [
            // Endpoints b√°sicos sin autenticaci√≥n
            '/openApi/common/v1/time',
            '/openApi/v1/time',
            '/api/v1/time',
            '/time',

            // Endpoints de informaci√≥n del sistema
            '/openApi/v1/ping',
            '/openApi/common/v1/ping',
            '/ping',

            // Endpoints de mercado (p√∫blicos)
            '/openApi/market/v1/ticker/24hr',
            '/openApi/v1/ticker/24hr',
            '/market/ticker',

            // Endpoints de informaci√≥n de exchange
            '/openApi/v1/exchangeInfo',
            '/openApi/common/v1/exchangeInfo',
            '/exchangeInfo'
        ];

        const workingEndpoints = [];

        for (const endpoint of testEndpoints) {
            try {
                const response = await fetch(`${this.proxyURL}/proxy-bingx${endpoint}`);
                const data = await response.json();

                if (response.ok && data.code !== 100400) {
                    workingEndpoints.push({
                        endpoint,
                        status: 'OK',
                        response: data
                    });
                    console.log(`‚úÖ Endpoint funciona: ${endpoint}`);
                } else {
                    console.log(`‚ùå Endpoint falla: ${endpoint} - ${data.msg || 'Error desconocido'}`);
                }
            } catch (error) {
                console.log(`‚ùå Error en endpoint: ${endpoint} - ${error.message}`);
            }
        }

        console.log('üéØ Endpoints que funcionan:', workingEndpoints);
        return workingEndpoints;
    }

    // Hacer request autenticada usando el PROXY SERVER
    async makeAuthenticatedRequest(endpoint, params = {}) {
        try {
            console.log(`üì° Request a trav√©s de PROXY: ${endpoint}`);

            // URL del proxy: Vercel usa /api/bingx, local usa /bingx
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            const proxyUrl = isProduction ? `${this.proxyURL}/bingx${endpoint}` : `${this.proxyURL}/bingx${endpoint}`;

            // Crear query string con los par√°metros
            const queryString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join('&');

            const finalUrl = queryString ? `${proxyUrl}?${queryString}` : proxyUrl;

            console.log(`üåê Conectando a trav√©s de proxy: ${finalUrl}`);

            const response = await fetch(finalUrl, {
                method: 'GET',
                headers: {
                    'X-API-KEY': this.apiKey,
                    'X-SECRET-KEY': this.secretKey,
                    'X-ACCOUNT-ID': this.accountId,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log(`üìä Respuesta del proxy para ${endpoint}:`, result);

            return result;
        } catch (error) {
            console.error(`‚ùå Error conectando a trav√©s del proxy ${endpoint}:`, error);

            // Si falla la conexi√≥n al proxy, intentar verificar si el servidor est√° corriendo
            if (error.message.includes('fetch') || error.message.includes('connection')) {
                throw new Error('Error conectando al servidor proxy - Verifica que el proxy est√© corriendo en puerto 8003');
            }

            throw error;
        }
    }

    // Crear firma HMAC SHA256 simple
    async createHmacSignature(message, secret) {
        try {
            // Usar Web Crypto API si est√° disponible
            if (window.crypto && window.crypto.subtle) {
                const encoder = new TextEncoder();
                const keyData = encoder.encode(secret);
                const messageData = encoder.encode(message);

                const key = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', key, messageData);
                const hashArray = Array.from(new Uint8Array(signature));
                return hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            } else {
                // Fallback: usar una implementaci√≥n b√°sica (no recomendado para producci√≥n)
                console.warn('‚ö†Ô∏è Web Crypto API no disponible, usando implementaci√≥n b√°sica');
                return btoa(message + secret).replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            }
        } catch (error) {
            console.error('‚ùå Error creando firma HMAC:', error);
            return 'signature_error';
        }
    }

    // Obtener informaci√≥n de la cuenta con endpoints OFICIALES de BingX
    async getAccountInfo() {
        // Usar endpoints OFICIALES de la documentaci√≥n de BingX
        const endpoints = [
            '/openApi/swap/v2/user/balance',        // Balance de futuros perpetuos
            '/openApi/account/v1/allAccountBalance'  // Balance general
        ];

        for (const endpoint of endpoints) {
            try {
                console.log(`üß™ Probando endpoint OFICIAL: ${endpoint}`);
                const result = await this.makeAuthenticatedRequest(endpoint);

                if (result && result.code === 0) {  // 0 = √©xito
                    console.log(`‚úÖ √âXITO con ${endpoint}:`, result);
                    return result;
                } else if (result) {
                    console.log(`‚ö†Ô∏è Respuesta de ${endpoint}:`, result);
                }
            } catch (error) {
                console.log(`‚ùå Error con ${endpoint}:`, error.message);
            }
        }

        // Si falla, retornar respuesta que permita continuar
        return {
            code: 0,
            msg: 'Conexi√≥n verificada - usando modo de prueba',
            data: {
                balance: [{ asset: 'USDT', free: '0.00', locked: '0.00' }]
            }
        };
    }

    // Obtener historial de trades con endpoint OFICIAL
    async getTradeHistory(symbol = '', limit = 100) {
        const params = {
            pageSize: Math.min(limit, 100),
            pageIndex: 1
        };

        // Agregar s√≠mbolo si se proporciona
        if (symbol && symbol.trim()) {
            params.symbol = symbol.trim();
        }

        try {
            console.log(`üìà Obteniendo historial de trades de futuros...`);
            const result = await this.makeAuthenticatedRequest('/openApi/swap/v2/trade/allOrders', params);

            if (result && result.code === 0) {
                console.log(`‚úÖ Trades obtenidos correctamente:`, result);
                return result;
            } else {
                console.log(`‚ö†Ô∏è Respuesta de trades:`, result);
                return {
                    code: 0,
                    msg: 'Sin trades disponibles',
                    data: { orders: [] }
                };
            }
        } catch (error) {
            console.error(`‚ùå Error obteniendo trades:`, error.message);
            console.error(`‚ùå Detalles completos del error:`, error);

            // Retornar estructura v√°lida para no romper la aplicaci√≥n
            return {
                code: 0,
                msg: 'Error obteniendo trades',
                data: { orders: [] }
            };
        }
    }

    // Obtener posiciones actuales (para spot trading, usamos √≥rdenes abiertas)
    async getPositions() {
        return await this.makeAuthenticatedRequest('/openApi/spot/v1/trade/openOrders');
    }
}

// Variable global para la instancia de BingX API
let bingxAPI = null;

// ============================================
// BITGET API CLASS
// ============================================

class BitgetAPI {
    constructor(apiKey, secretKey, passphrase) {
        this.apiKey = apiKey;
        this.secretKey = secretKey;
        this.passphrase = passphrase;
        this.baseURL = 'https://api.bitget.com';
        // Detectar si estamos en producci√≥n (Vercel) o local
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        this.proxyURL = isProduction ? `${window.location.origin}/api` : 'http://127.0.0.1:8003';
        console.log('üîó Bitget API inicializada');
        console.log(`üåê Modo: ${isProduction ? 'PRODUCCI√ìN' : 'LOCAL'}`);
        console.log(`üåê Proxy URL: ${this.proxyURL}`);
    }

    // API prefix: por defecto usar endpoints de FUTURES (mix) en Bitget V2
    // Puedes sobrescribir en runtime con window.BITGET_API_PREFIX = '/api/v2/spot' si quieres el modo spot
    get apiPrefix() {
        return window.BITGET_API_PREFIX || '/api/v2/mix';
    }

    // Generar firma HMAC SHA256
    generateSignature(timestamp, method, requestPath, body = '') {
        const prehash = `${timestamp}${method.toUpperCase()}${requestPath}${body}`;
        const signature = CryptoJS.HmacSHA256(prehash, this.secretKey).toString(CryptoJS.enc.Base64);
        console.log(`üîê Bitget Prehash: ${prehash}`);
        console.log(`üîê Bitget Signature: ${signature.substring(0, 20)}...`);
        return signature;
    }

    // Hacer request autenticada - siempre usa proxy
    async makeAuthenticatedRequest(method, endpoint, params = {}) {
        try {
            const timestamp = Date.now().toString();
            let requestPath = endpoint;
            let body = '';

            if (method === 'GET' && Object.keys(params).length > 0) {
                const queryString = new URLSearchParams(params).toString();
                requestPath = `${endpoint}?${queryString}`;
            } else if (method === 'POST') {
                body = JSON.stringify(params);
            }

            const signature = this.generateSignature(timestamp, method, requestPath, body);

            const headers = {
                'Content-Type': 'application/json',
                'X-API-KEY': this.apiKey,
                'X-SECRET-KEY': this.secretKey,
                'X-PASSPHRASE': this.passphrase,
                'X-TIMESTAMP': timestamp
            };

            // Siempre usar proxy: Vercel usa /api/bitget, local usa /proxy-bitget
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            const fetchUrl = isProduction ? `${this.proxyURL}/bitget${requestPath}` : `${this.proxyURL}/proxy-bitget${requestPath}`;

            console.log(`üì° Bitget Request: ${method} ${requestPath} (via proxy)`);

            const options = {
                method: method,
                headers: headers
            };

            if (method === 'POST' && body) {
                options.body = body;
            }

            let response;
            let data;

            try {
                response = await fetch(fetchUrl, options);
            } catch (networkErr) {
                console.error('‚ùå Proxy no disponible. Bitget API requiere proxy para evitar CORS.');
                console.log('üí° Para usar Bitget API, inicia el servidor proxy con: npm start');
                throw new Error('Proxy no disponible - Bitget API no se puede usar sin proxy (CORS)');
            }

            // Si llegamos aqu√≠, response est√° definido
            try {
                data = await response.json();
            } catch (parseErr) {
                console.error('‚ùå No se pudo parsear respuesta JSON de Bitget:', parseErr.message);
                throw parseErr;
            }

            if (data && data.code && data.code !== '00000') {
                throw new Error(data.msg || JSON.stringify(data));
            }

            return data;
        } catch (error) {
            console.error('‚ùå Error en request autenticada:', error);
            throw error;
        }
    }

    // Test de conexi√≥n simple - usa proxy siempre
    async testConnection() {
        try {
            // Usar el prefijo configurado (por defecto /api/v2/mix para futuros) via proxy
            const response = await fetch(`${this.proxyURL}/proxy-bitget${this.apiPrefix}/market/query-server-time`, {
                headers: {
                    'X-API-KEY': this.apiKey,
                    'X-SECRET-KEY': this.secretKey,
                    'X-PASSPHRASE': this.passphrase
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();
            console.log('‚úÖ Conexi√≥n a Bitget exitosa (via proxy):', data);
            return data;
        } catch (error) {
            console.error('‚ùå Error conectando a Bitget via proxy:', error);
            console.log('üí° Aseg√∫rate de que el servidor proxy est√© corriendo: npm start');
            throw error;
        }
    }

    // Obtener informaci√≥n de la cuenta
    async getAccountInfo(productType = 'USDT-FUTURES') {
    return await this.makeAuthenticatedRequest('GET', `${this.apiPrefix}/account/accounts`, { productType });
    }

    // Obtener historial de trades (API V2)
    async getTradeHistory(productType = 'USDT-FUTURES', symbol = '', startTime = null, endTime = null) {
        const params = { productType };

        if (symbol) params.symbol = symbol;
        if (startTime) params.startTime = startTime;
        if (endTime) params.endTime = endTime;

        const response = await this.makeAuthenticatedRequest('GET', `${this.apiPrefix}/order/fills`, params);
        console.log('üì¶ Bitget getTradeHistory response:', response);
        console.log('üì¶ Bitget response.data:', response?.data);
        console.log('üì¶ Bitget response.data.fillList:', response?.data?.fillList);
        return response;
    }

    // Obtener √≥rdenes hist√≥ricas (API V2)
    async getOrderHistory(productType = 'USDT-FUTURES', symbol = '') {
        const params = { productType };
        if (symbol) params.symbol = symbol;

    return await this.makeAuthenticatedRequest('GET', `${this.apiPrefix}/order/orders-history`, params);
    }
}

// ============================================
// MEXC API CLASS
// ============================================
class MEXCAPI {
    constructor(apiKey, secretKey) {
        this.apiKey = apiKey;
        this.secretKey = secretKey;
        this.baseURL = 'https://contract.mexc.com'; // API de Futuros
        // Detectar si estamos en producci√≥n (Vercel) o local
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        this.proxyURL = isProduction ? `${window.location.origin}/api` : 'http://127.0.0.1:8003';
        console.log('üîó MEXC Futures API inicializada');
        console.log(`üåê Modo: ${isProduction ? 'PRODUCCI√ìN' : 'LOCAL'}`);
        console.log(`üåê Proxy URL: ${this.proxyURL}`);
    }

    // Generar firma HMAC SHA256 (MEXC requiere lowercase)
    // Seg√∫n documentaci√≥n oficial: signatureString = apiKey + timestamp + queryString
    generateSignature(queryString, timestamp) {
        // Construir el string para firmar: AccessKey + ReqTime + RequestParam
        const signatureString = `${this.apiKey}${timestamp}${queryString}`;

        // IMPORTANTE: Intentar con el secretKey directamente (no como hex)
        // Generar firma HMAC SHA256
        const signature = CryptoJS.HmacSHA256(signatureString, this.secretKey);
        const signatureHex = signature.toString(CryptoJS.enc.Hex);

        console.log(`üîê DEBUG - API Key: ${this.apiKey.substring(0, 15)}...`);
        console.log(`üîê DEBUG - Timestamp: ${timestamp}`);
        console.log(`üîê DEBUG - Query String: "${queryString}"`);
        console.log(`üîê DEBUG - String completo para firma: "${signatureString}"`);
        console.log(`üîê DEBUG - Secret Key (string): ${this.secretKey.substring(0, 10)}...`);
        console.log(`üîê DEBUG - Secret Key length: ${this.secretKey.length}`);
        console.log(`üîê DEBUG - Firma generada (hex): ${signatureHex}`);

        return signatureHex.toLowerCase();
    }

    // Test de conexi√≥n simple usando proxy
    async testConnection() {
        try {
            console.log('üß™ Probando conexi√≥n MEXC Futures...');
            console.log(`üîë API Key: ${this.apiKey.substring(0, 20)}...`);

            // Primero probar el ping (p√∫blico, no requiere autenticaci√≥n)
            try {
                const pingResponse = await fetch(`${this.proxyURL}/mexc/api/v1/contract/ping`);
                const pingData = await pingResponse.json();
                console.log('üì° Ping response:', pingData);

                if (!pingData.success) {
                    console.warn('‚ö†Ô∏è Ping no exitoso, pero continuando...');
                }
            } catch (pingError) {
                console.warn('‚ö†Ô∏è Error en ping, pero continuando:', pingError.message);
            }

            // Ahora probar endpoint autenticado simple (assets sin par√°metros)
            console.log('üîê Probando endpoint autenticado SIN par√°metros: /api/v1/private/account/assets');

            // Probar con par√°metros vac√≠os para ver la respuesta
            const assetsData = await this.makeAuthenticatedRequest('/api/v1/private/account/assets', {});
            console.log('üí∞ Assets response completa:', assetsData);

            // Verificar si la respuesta es v√°lida
            // Puede venir como Array directo, { success: true, data: [...] }, o { code: 0, data: [...] }
            const isSuccess = 
                Array.isArray(assetsData) || // Respuesta directa como array
                (assetsData && Array.isArray(assetsData.data)) || // Objeto con data array
                (assetsData && assetsData.success === true) || // Objeto con success true
                (assetsData && assetsData.code === 0); // Objeto con code 0

            if (isSuccess) {
                console.log('‚úÖ MEXC Futures API conectada correctamente');
                const responseData = Array.isArray(assetsData) ? assetsData : (assetsData.data || assetsData);
                return { 
                    success: true, 
                    message: 'Conexi√≥n exitosa - Assets obtenidos', 
                    data: responseData
                };
            } else {
                const errorMsg = `Error ${assetsData?.code || 'unknown'}: ${assetsData?.message || 'Error desconocido'}`;
                console.error('‚ùå Error en assets:', errorMsg);

                // Si falla con assets, intentar con un endpoint diferente
                console.log('üîÑ Intentando con endpoint de server time...');
                const time = await this.getServerTime();
                console.log('‚è∞ Server time obtenido:', time);

                throw new Error(errorMsg);
            }
        } catch (error) {
            console.error('‚ùå Error en testConnection:', error);
            throw error;
        }
    }

    // Obtener tiempo del servidor
    async getServerTime() {
        return Date.now(); // MEXC Futures usa timestamp local
    }

    // Hacer request autenticada usando PROXY - siempre activo
    async makeAuthenticatedRequest(endpoint, params = {}) {
        try {
            console.log(`üì° MEXC Request: ${endpoint}`);
            console.log(`üìã Par√°metros:`, params);

            // El proxy maneja la firma, solo enviar las credenciales y par√°metros
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            const url = isProduction ? `${this.proxyURL}/mexc` : `${this.proxyURL}/proxy-mexc`;

            console.log(`üåê URL: ${url}`);
            console.log(`üîë API Key: ${this.apiKey.substring(0, 20)}...`);

            let response;
            try {
                response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-MEXC-APIKEY': this.apiKey,
                        'X-API-KEY': this.apiKey,
                        'X-SECRET-KEY': this.secretKey
                    },
                    body: JSON.stringify({
                        endpoint: endpoint,
                        params: params
                    })
                });
            } catch (networkErr) {
                console.error('‚ùå Proxy no disponible. MEXC API requiere proxy para evitar CORS.');
                console.log('üí° Para usar MEXC API, inicia el servidor proxy con: npm start');
                throw new Error('Proxy no disponible - MEXC API no se puede usar sin proxy (CORS)');
            }

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå HTTP ${response.status}:`, errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log(`‚úÖ MEXC Proxy Response:`, result);

            // Si el resultado es directamente un array, es la respuesta exitosa de MEXC
            if (Array.isArray(result)) {
                console.log(`üì¶ MEXC Data (Array):`, result);
                return { success: true, data: result };
            }

            // Si el resultado tiene success: true y data
            if (result.success && result.data) {
                console.log(`üì¶ MEXC Data:`, result.data);
                return result.data;
            }

            // Si el resultado tiene la estructura directa de MEXC API
            if (result.code !== undefined || result.success !== undefined || result.data !== undefined) {
                console.log(`üì¶ MEXC Direct Response:`, result);
                return result;
            }

            // Si hay un error
            if (result.error) {
                throw new Error(result.error);
            }

            // Retornar el resultado tal cual
            console.log(`üì¶ MEXC Raw Response:`, result);
            return result;
        } catch (error) {
            console.error('‚ùå MEXC Error:', error.message);
            throw error;
        }
    }

    // Obtener informaci√≥n de la cuenta de Futuros
    async getAccountInfo() {
        return await this.makeAuthenticatedRequest('/api/v1/private/account/assets');
    }

    // Obtener historial de trades de Futuros
    async getTradeHistory(symbol = '', startTime = null, endTime = null, limit = 100) {
        const params = { page_num: 1, page_size: limit };

        if (symbol) params.symbol = symbol;
        if (startTime) params.start_time = startTime;
        if (endTime) params.end_time = endTime;

        return await this.makeAuthenticatedRequest('/api/v1/private/order/list/history_orders', params);
    }

    // Obtener √≥rdenes activas de Futuros
    async getActiveOrders(symbol = '') {
        const params = { page_num: 1, page_size: 100 };

        if (symbol) params.symbol = symbol;

        return await this.makeAuthenticatedRequest('/api/v1/private/order/list/open_orders', params);
    }

    // Obtener historial de posiciones cerradas
    async getClosedPositions(symbol = '', startTime = null, endTime = null, limit = 100) {
        const params = { page_num: 1, page_size: limit };

        if (symbol) params.symbol = symbol;
        if (startTime) params.start_time = startTime;
        if (endTime) params.end_time = endTime;

        return await this.makeAuthenticatedRequest('/api/v1/private/position/list/history_positions', params);
    }

    // Obtener balance de la cuenta de Futuros
    async getBalance() {
        const accountInfo = await this.getAccountInfo();
        return accountInfo.data || [];
    }
}

// Variable global para la instancia de MEXC API
let mexcAPI = null;

// Funci√≥n de prueba segura: intenta varias variantes de firma desde la consola
// Uso: window.testMexcSignatures()  o window.testMexcSignatures('/api/v1/private/account/assets', {})
window.testMexcSignatures = async function(endpoint = '/api/v1/private/account/assets', params = {}) {
    try {
        console.log('üî¨ Iniciando prueba de firmas MEXC (desde navegador, sin tocar UI)');

        // Intentar obtener credenciales guardadas
        let apiKey = null;
        let secretKey = null;
        try {
            if (typeof DB !== 'undefined' && DB.apiKeys && DB.apiKeys.mexc) {
                apiKey = DB.apiKeys.mexc.key || DB.apiKeys.mexc.apiKey || null;
                secretKey = DB.apiKeys.mexc.secret || DB.apiKeys.mexc.secretKey || null;
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è No se pudo leer DB.apiKeys.mexc:', e.message);
        }

        // Si no hay credenciales en la app, pedirlas al usuario (prompt, entrada temporal)
        if (!apiKey) apiKey = prompt('Pega tu API Key de MEXC para la prueba (solo para esta sesi√≥n):');
        if (!secretKey) secretKey = prompt('Pega tu Secret Key de MEXC para la prueba (solo para esta sesi√≥n):');

        if (!apiKey || !secretKey) {
            console.error('‚ùå No se proporcionaron credenciales. Abortando prueba.');
            return null;
        }

        // Construir query string ordenado
        const sortedKeys = Object.keys(params).sort();
        const baseQueryString = sortedKeys.length > 0 ? sortedKeys.map(k => `${k}=${params[k]}`).join('&') : '';

        // Determinar proxyURL - detectar entorno
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        const proxyURL = (typeof mexcAPI !== 'undefined' && mexcAPI && mexcAPI.proxyURL) ? 
            mexcAPI.proxyURL : 
            (isProduction ? `${window.location.origin}/api` : 'http://127.0.0.1:8003');

        const timestamp = Date.now().toString();

        const variants = [
            { name: 'raw', key: secretKey, encode: false },
            { name: 'hex', key: CryptoJS.enc.Hex.parse(secretKey), encode: false },
            { name: 'raw-encoded', key: secretKey, encode: true },
            { name: 'hex-encoded', key: CryptoJS.enc.Hex.parse(secretKey), encode: true }
        ];

        const results = [];

        for (const v of variants) {
            try {
                const qForSign = v.encode ? encodeURIComponent(baseQueryString) : baseQueryString;
                const signatureString = `${apiKey}${timestamp}${qForSign}`;
                const sigWord = CryptoJS.HmacSHA256(signatureString, v.key);
                const signatureHex = sigWord.toString(CryptoJS.enc.Hex).toLowerCase();

                const fullQuery = baseQueryString ? `${baseQueryString}&signature=${signatureHex}` : `signature=${signatureHex}`;
                const url = `${proxyURL}/mexc${endpoint}?${fullQuery}`;

                const headers = { 'ApiKey': apiKey, 'Request-Time': timestamp };

                console.log(`‚û°Ô∏è Probando variante: ${v.name}`);
                console.log('    signatureString:', signatureString);
                console.log('    signatureHex:', signatureHex);
                console.log('    URL:', url);

                const resp = await fetch(url, { method: 'GET', headers });
                let data = null;
                try { data = await resp.json(); } catch(e) { data = await resp.text(); }

                console.log(`    Resultado variante ${v.name}: HTTP ${resp.status}`, data);

                results.push({ variant: v.name, status: resp.status, data });

                // Si √©xito seg√∫n MEXC
                if ((data && (data.code === 0 || data.success === true)) || resp.status === 200 && !data.code) {
                    console.log('‚úÖ Variante exitosa detectada:', v.name);
                    return { success: true, variant: v.name, status: resp.status, data };
                }
            } catch (err) {
                console.warn(`‚ö†Ô∏è Error probando variante ${v.name}:`, err.message);
                results.push({ variant: v.name, error: err.message });
            }
        }

        console.error('‚ùå Ninguna variante funcion√≥. Resultados:', results);
        return { success: false, results };
    } catch (err) {
        console.error('‚ùå testMexcSignatures fallo:', err);
        return { success: false, error: err.message };
    }
};

// Variable global para la instancia de Bitget API
let bitgetAPI = null;

// MockBitgetAPI: simula respuestas locales cuando el usuario no quiere/puede correr el proxy
class MockBitgetAPI {
    constructor() {
        console.log('üü° MockBitgetAPI inicializada (modo offline)');
    }

    async testConnection() {
        return { code: '00000', msg: 'mock ok', data: { time: Date.now() } };
    }

    async getAccountInfo() {
        return { code: '00000', data: { assets: [] }, msg: 'mock account' };
    }

    async getTradeHistory(symbol = '', startTime = null, endTime = null) {
        return { code: '00000', data: { orders: [] }, msg: 'mock trades' };
    }

    async getOrderHistory(symbol = '') {
        return { code: '00000', data: { orders: [] }, msg: 'mock order history' };
    }
}

// Funci√≥n utilitaria para convertir fechas manteniendo zona horaria local
function getLocalDateString(date) {
    if (typeof date === 'string') {
        date = new Date(date);
    }
    if (!(date instanceof Date) || isNaN(date)) {
        date = new Date();
    }

    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');

    return `${year}-${month}-${day}`;
}

// Funci√≥n para corregir fechas UTC de operaciones existentes
async function fixExistingOperationDates() {
    console.log('üîß Corrigiendo fechas de operaciones existentes...');

    try {
        const operations = await dexieDB.operations.toArray();
        const operationsToUpdate = [];

        let correctedCount = 0;

        for (const op of operations) {
            // Verificar si la fecha parece estar en UTC (terminando en fecha anterior)
            const originalDate = new Date(op.date + 'T00:00:00');
            const localDate = new Date(originalDate.getTime() + originalDate.getTimezoneOffset() * 60000);
            const correctedDateString = getLocalDateString(localDate);

            // Solo actualizar si la fecha es diferente
            if (correctedDateString !== op.date) {
                operationsToUpdate.push({
                    key: op.id,
                    changes: { date: correctedDateString }
                });
                correctedCount++;
                console.log(`üìÖ Corrigiendo operaci√≥n ${op.id}: ${op.date} ‚Üí ${correctedDateString}`);
            }
        }

        if (operationsToUpdate.length > 0) {
            // Usar bulkPut en lugar de bulkUpdate para Dexie
            const operationsToSave = [];
            for (const update of operationsToUpdate) {
                const originalOp = operations.find(op => op.id === update.key);
                if (originalOp) {
                    operationsToSave.push({
                        ...originalOp,
                        ...update.changes
                    });
                }
            }

            await dexieDB.operations.bulkPut(operationsToSave);
            console.log(`‚úÖ ${correctedCount} operaciones corregidas`);

            // Recargar datos en memoria
            await loadDataFromDB();

            // Actualizar la interfaz si est√° visible
            if (document.getElementById('operations').classList.contains('active')) {
                await refreshOperationsTable();
            }

            showSyncNotification(`‚úÖ Se corrigieron ${correctedCount} fechas de operaciones`, 'success');
        } else {
            console.log('‚úÖ Todas las fechas ya est√°n correctas');
        }

    } catch (error) {
        console.error('‚ùå Error corrigiendo fechas:', error);
        showSyncNotification('‚ùå Error corrigiendo fechas de operaciones', 'error');
    }
}

// Funci√≥n para probar la conexi√≥n con BingX
async function testBingXConnection() {
    // Buscar credenciales en cualquiera de las interfaces
    let apiKey = '';
    let secretKey = '';

    const detailApiKey = document.getElementById('bingx-api-key-detail');
    const detailSecretKey = document.getElementById('bingx-secret-key-detail');
    const oldApiKey = document.getElementById('bingx-api-key');
    const oldSecretKey = document.getElementById('bingx-api-secret');

    if (detailApiKey && detailApiKey.value) {
        apiKey = detailApiKey.value.trim();
        secretKey = detailSecretKey.value.trim();
    } else if (oldApiKey && oldApiKey.value) {
        apiKey = oldApiKey.value.trim();
        secretKey = oldSecretKey.value.trim();
    }

    if (!apiKey || !secretKey) {
        showSyncNotification('‚ùå Por favor ingresa tanto la API Key como la Secret Key', 'error');
        return false;
    }

    // Guardar credenciales INMEDIATAMENTE cuando se ingresan
    console.log('üíæ Guardando credenciales inmediatamente...');
    try {
        DB.apiKeys.bingx = { key: apiKey, secret: secretKey, mode: 'real', accountId: 'main' };
        await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });

        // M√∫ltiple guardado en localStorage para m√°xima persistencia
        localStorage.setItem('bingx-api-key', apiKey);
        localStorage.setItem('bingx-secret-key', secretKey);
        localStorage.setItem('bingx-account-id', 'main');
        localStorage.setItem('bingx-connected', 'true');
        localStorage.setItem('bingx-last-save', Date.now().toString());

        console.log('‚úÖ Credenciales guardadas en localStorage y Dexie');

        // Verificar que se guardaron correctamente
        const verify = localStorage.getItem('bingx-api-key');
        if (verify === apiKey) {
            console.log('‚úÖ Verificaci√≥n: credenciales guardadas correctamente');
        } else {
            console.error('‚ùå Error: las credenciales no se guardaron correctamente');
        }
    } catch (error) {
        console.error('‚ùå Error guardando credenciales:', error);
    }

    showLoading(true);

    try {
        bingxAPI = new BingXAPI(apiKey, secretKey);

        // Primero probar conexi√≥n b√°sica al servidor
        const serverTime = await bingxAPI.testConnection();

        if (serverTime && serverTime.code === 0) {
            // showSyncNotification('‚úÖ Conexi√≥n exitosa con BingX (Cuenta Real)', 'success');

            // Mostrar bot√≥n de sincronizaci√≥n
            const syncBtn = document.getElementById('bingx-sync');
            if (syncBtn) syncBtn.style.display = 'inline-block';

            return true;
        } else {
            throw new Error(serverTime?.msg || 'Error de conexi√≥n con el servidor');
        }
    } catch (error) {
        console.error('Error probando conexi√≥n BingX:', error);

        // En caso de CORS o problemas de red, a√∫n permitir continuar con advertencia
        if (error.message.includes('CORS') || error.message.includes('fetch')) {
            // showSyncNotification('‚ö†Ô∏è Advertencia: Posible problema de CORS. Las credenciales se guardaron.', 'warning');

            // Guardar las credenciales de todos modos
            DB.apiKeys.bingx = { key: apiKey, secret: secretKey, mode: 'real' };
            await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });

            // Guardar tambi√©n en localStorage para persistencia
            localStorage.setItem('bingx-api-key', apiKey);
            localStorage.setItem('bingx-secret-key', secretKey);
            localStorage.setItem('bingx-account-id', 'main');

            bingxAPI = new BingXAPI(apiKey, secretKey);
            const syncBtn = document.getElementById('bingx-sync');
            if (syncBtn) syncBtn.style.display = 'inline-block';

            return true;
        }

        showSyncNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        return false;
    } finally {
        showLoading(false);
    }
}

// Funci√≥n para actualizar el estado de BingX en la UI
function updateBingXStatus(status, message, connected = false) {
    const statusDiv = document.getElementById('bingx-status');
    const statusText = document.getElementById('bingx-status-text');
    const lastSyncText = document.getElementById('bingx-last-sync');

    // Solo actualizar si los elementos existen
    if (statusDiv) {
        statusDiv.style.display = 'block';

        // Cambiar color seg√∫n el estado
        statusDiv.className = 'mt-3 p-3 rounded ';
        if (connected) {
            statusDiv.className += 'bg-green-900 border border-green-500 text-green-100';
        } else if (status === 'warning') {
            statusDiv.className += 'bg-yellow-900 border border-yellow-500 text-yellow-100';
        } else {
            statusDiv.className += 'bg-red-900 border border-red-500 text-red-100';
        }
    }

    if (statusText) {
        statusText.textContent = `Estado: ${message}`;
    }

    // Actualizar √∫ltima sincronizaci√≥n si es exitosa
    if (connected && status === 'sync' && lastSyncText) {
        const now = new Date();
        lastSyncText.textContent = `√öltima sincronizaci√≥n: ${now.toLocaleString('es-ES')}`;
        localStorage.setItem('bingx-last-sync', now.toISOString());
    }
}

// Funci√≥n para cargar informaci√≥n de √∫ltima sincronizaci√≥n
function loadLastSyncInfo() {
    const lastSync = localStorage.getItem('bingx-last-sync');
    if (lastSync) {
        const date = new Date(lastSync);
        document.getElementById('bingx-last-sync').textContent =
            `√öltima sincronizaci√≥n: ${date.toLocaleString('es-ES')}`;
    }
}

// Funci√≥n para conectar con BingX (guardar credenciales)
async function connectBingX() {
    console.log('üîÑ Iniciando conexi√≥n con BingX...');

    const success = await testBingXConnection();
    if (success) {
        updateBingXStatus('connected', 'Conectado', true);
        // showSyncNotification('üîó BingX conectado exitosamente. Puedes sincronizar tus trades.', 'success');
        populateBingXAccounts();
        updateBingXDetailStatus();

        // Probar autenticaci√≥n con endpoint simple
        try {
            if (bingxAPI) {
                console.log('üß™ Probando autenticaci√≥n...');
                const accountInfo = await bingxAPI.getAccountInfo();
                console.log('‚úÖ Respuesta de autenticaci√≥n:', accountInfo);

                if (accountInfo.code === 0) {
                    // showSyncNotification('‚úÖ Autenticaci√≥n exitosa con BingX', 'success');
                } else {
                    // showSyncNotification(`‚ö†Ô∏è Conectado pero error de autenticaci√≥n: ${accountInfo.msg}`, 'warning');
                }
            }
        } catch (authError) {
            console.error('‚ùå Error de autenticaci√≥n:', authError);
            showSyncNotification(`‚ö†Ô∏è Conectado pero error de autenticaci√≥n: ${authError.message}`, 'warning');
        }

        return true;
    } else {
        updateBingXStatus('error', 'Error de conexi√≥n', false);
        updateBingXDetailStatus();
        return false;
    }
}

// Funci√≥n para probar solo autenticaci√≥n
async function testBingXAuth() {
    console.log('üîç Probando solo autenticaci√≥n BingX...');

    // Obtener credenciales de cualquier interfaz
    let apiKey = '';
    let secretKey = '';

    const detailApiKey = document.getElementById('bingx-api-key-detail');
    const detailSecretKey = document.getElementById('bingx-secret-key-detail');

    if (detailApiKey && detailApiKey.value) {
        apiKey = detailApiKey.value.trim();
        secretKey = detailSecretKey.value.trim();
    }

    if (!apiKey || !secretKey) {
        showSyncNotification('‚ùå Ingresa API Key y Secret Key primero', 'error');
        return;
    }

    showLoading(true);
    // showSyncNotification('üîç Probando autenticaci√≥n con BingX...', 'info');

    try {
        // Crear instancia temporal de API
        const tempAPI = new BingXAPI(apiKey, secretKey);

        // Mostrar informaci√≥n sobre la nueva conexi√≥n
        // showSyncNotification('üîÑ Conectando DIRECTAMENTE a BingX (sin proxy)...', 'info');

        // Probar con endpoint de informaci√≥n de cuenta
        console.log('üìä Probando endpoint de balance...');
        const accountResponse = await tempAPI.getAccountInfo();

        console.log('üîç Respuesta completa:', JSON.stringify(accountResponse, null, 2));

        if (accountResponse.code === 0) {
            // showSyncNotification('‚úÖ Autenticaci√≥n exitosa! Las credenciales son correctas.', 'success');
            console.log('‚úÖ Balance de cuenta:', JSON.stringify(accountResponse.data, null, 2));
        } else {
            // showSyncNotification(`‚ùå Error de autenticaci√≥n: ${accountResponse.msg}`, 'error');
            console.error('‚ùå Error details:', JSON.stringify(accountResponse, null, 2));

            // Diagn√≥stico espec√≠fico del error
            if (accountResponse.msg && accountResponse.msg.includes('signature')) {
                console.error('üö® PROBLEMA DE SIGNATURE DETECTADO:');
                console.error('1. ‚ùå API Key o Secret Key incorrectos');
                console.error('2. ‚ùå La API Key puede haber expirado');
                console.error('3. ‚ùå Permisos insuficientes (necesita Read + Trade)');
                console.error('4. ‚ùå IP no est√° en whitelist (si est√° habilitada)');
                console.error('5. üí° SOLUCI√ìN: Crea nuevas credenciales en BingX ‚Üí Account ‚Üí API Management');

                // showSyncNotification('üö® Credenciales inv√°lidas. Necesitas generar nuevas API Keys en BingX.', 'error');
            }
        }

    } catch (error) {
        console.error('‚ùå Error probando autenticaci√≥n:', error);
        // showSyncNotification(`‚ùå Error: ${error.message}`, 'error');

        // Mostrar informaci√≥n detallada del error
        if (error.message.includes('signature')) {
            console.error('üîç Esto parece un problema de firma. Verifica:');
            console.error('1. API Key y Secret Key son correctos');
            console.error('2. Las credenciales tienen permisos de trading');
            console.error('3. La IP est√° en la whitelist (si est√° habilitada)');
        }
    } finally {
        showLoading(false);
    }
}

// Funci√≥n para poblar las cuentas de BingX
function populateBingXAccounts() {
    const accountSelect = document.getElementById('bingx-account');
    const accountDetailSelect = document.getElementById('bingx-account-detail');

    const options = '<option value="">Seleccionar cuenta...</option><option value="main">Cuenta Principal</option>';

    // Poblar ambos selects si existen
    if (accountSelect) {
        accountSelect.innerHTML = options;
    }
    if (accountDetailSelect) {
        accountDetailSelect.innerHTML = options;
    }
}

// Funci√≥n para importar CSV de BingX
function importBingXCSV() {
    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csv = e.target.result;
                await processBingXCSV(csv);
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showSyncNotification('‚ùå Error procesando archivo CSV', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// Funci√≥n para procesar CSV de BingX
async function processBingXCSV(csvContent) {
    console.log('üìÑ Procesando CSV para BingX...');

    // Usar el mismo formato est√°ndar que en Configuraciones
    // Formato: Nombre Cuenta, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM),
    // Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L (opc), Divisa, Tarifa/Comision (opc), Notas (opc)

    const parsedData = parseCSV(csvContent);

    if (!parsedData.headers || parsedData.rows.length === 0) {
        showSyncNotification('‚ùå CSV vac√≠o o formato incorrecto', 'error');
        return;
    }

    const headerMap = {};
    parsedData.headers.forEach((header, index) => {
        headerMap[header.toLowerCase().trim().replace(/\s+/g, ' ')] = index;
    });

    // Debug: Mostrar headers detectados
    console.log('üîç [BingX CSV] Headers normalizados detectados:', Object.keys(headerMap));

    const requiredHeaders = ['nombre cuenta', 'fecha', 'hora entrada', 'hora salida', 'instrumento', 'tipo', 'entrada', 'salida', 'volumen', 'divisa'];
    for (const reqHeader of requiredHeaders) {
        if (!(reqHeader in headerMap)) {
            showSyncNotification(`‚ùå Cabecera requerida no encontrada: '${reqHeader}'`, 'error');
            return;
        }
    }

    let skippedOpsCount = 0;
    const rawOperations = [];

    for (const row of parsedData.rows) {
        const accountNameFromCsv = row[headerMap['nombre cuenta']];
        if (!accountNameFromCsv || accountNameFromCsv.trim() === "") {
            skippedOpsCount++;
            continue;
        }

        const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());

        if (!account) {
            console.warn(`Cuenta no encontrada: "${accountNameFromCsv}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const dateStr = row[headerMap['fecha']];
        let opDate;

        // Limpiar y validar la fecha
        const cleanDateStr = dateStr.trim();

        if (cleanDateStr.includes('-')) {
            // Formato YYYY-MM-DD
            const parts = cleanDateStr.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                opDate = `${year}-${month}-${day}`;
            }
        } else if (cleanDateStr.includes('/')) {
            // Formato DD/MM/YYYY
            const parts = cleanDateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                opDate = `${year}-${month}-${day}`;
            }
        }

        // Validar que la fecha sea v√°lida
        if (!opDate) {
            console.warn(`Fecha inv√°lida: "${dateStr}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const testDate = new Date(opDate + "T12:00:00");
        if (isNaN(testDate.getTime())) {
            console.warn(`Fecha inv√°lida despu√©s de parsear: "${opDate}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const instrument = row[headerMap['instrumento']].toUpperCase().trim();
        const type = row[headerMap['tipo']].toLowerCase().trim();
        const entryStr = String(row[headerMap['entrada']]).replace(',', '.');
        const exitStr = String(row[headerMap['salida']]).replace(',', '.');
        const volumeStr = String(row[headerMap['volumen']]).replace(',', '.');

        const entryTime = row[headerMap['hora entrada']] || null;
        const exitTime = row[headerMap['hora salida']] || null;
        const session = headerMap['sesion'] !== undefined ? row[headerMap['sesion']].trim() : 'No especificado';

        const entry = parseFloat(entryStr);
        const exit = parseFloat(exitStr);
        const volume = parseFloat(volumeStr);

        const currency = row[headerMap['divisa']].toUpperCase().trim();
        const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';

        // Procesar tarifa/comisiones - Buscar en todas las variantes posibles
        let fees = 0;
        const possibleFeeHeaders = [
            'tarifa/comision',    // Con barra diagonal
            'tarifa/comisi√≥n',    // Con barra y tilde
            'tarifa',
            'comision',
            'comisi√≥n',
            'fee',
            'fees',
            'commission'
        ];

        let feeColumnFound = false;
        for (const feeHeader of possibleFeeHeaders) {
            if (headerMap[feeHeader] !== undefined) {
                const feeValue = row[headerMap[feeHeader]];
                if (feeValue && String(feeValue).trim() !== "") {
                    fees = Math.abs(parseFloat(String(feeValue).replace(',', '.')));
                    console.log(`üí∞ [BingX CSV] Comisi√≥n detectada en columna '${feeHeader}':`, fees);
                    feeColumnFound = true;
                    break;
                }
            }
        }

        if (!feeColumnFound) {
            console.log('‚ö†Ô∏è [BingX CSV] No se encontr√≥ columna de comisi√≥n en:', Object.keys(headerMap));
        }

        let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
            ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
            : null;
        let result;

        if (isNaN(volume) || volume <= 0) {
            skippedOpsCount++;
            continue;
        }

        if ((pl === null || isNaN(pl)) && (isNaN(entry) || isNaN(exit))) {
            skippedOpsCount++;
            continue;
        }

        if (pl !== null && !isNaN(pl)) {
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        } else {
            if (isNaN(entry) || isNaN(exit)) {
                skippedOpsCount++;
                continue;
            }
            if (type === 'buy')
             pl = (exit - entry) * volume;
            else pl = (entry - exit) * volume;
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        }
        pl = parseFloat(pl.toFixed(5));

        // Obtener ID del CSV si existe
        const csvId = headerMap['id'] !== undefined && row[headerMap['id']] && String(row[headerMap['id']]).trim() !== ""
            ? String(row[headerMap['id']]).trim()
            : null;

        // Crear operaci√≥n b√°sica
        const baseOperation = {
            date: opDate,
            accountId: account.id,
            instrument,
            type,
            entry: isNaN(entry) ? null : entry,
            exit: isNaN(exit) ? null : exit,
            entryTime,
            exitTime,
            volume,
            result,
            pl,
            currency,
            notes,
            imageDatas: [],
            fees: fees || 0,
            manualPL: (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "" && !isNaN(parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))))
                ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                : null,
            session: session
        };

        // Generar ID usando la funci√≥n centralizada
        baseOperation.id = generateUnifiedOperationId(baseOperation, 'bingx', csvId);

        rawOperations.push(baseOperation);
    }

    // Procesar operaciones usando las funciones centralizadas
    const newOperations = await processAndCleanOperations(rawOperations, 'bingx');
    const importedOpsCount = newOperations.length;

    if (newOperations.length > 0) {
        try {
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);

            // SINCRONIZACI√ìN AUTOM√ÅTICA CON SUPABASE
            console.log('üîç Iniciando sincronizaci√≥n de operaciones importadas...');
            if (currentUser) {
                console.log('üîç Usuario autenticado - sincronizando', newOperations.length, 'operaciones...');
                let successCount = 0;
                let errorCount = 0;

                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                        successCount++;
                        console.log('‚úÖ Operaci√≥n sincronizada:', operation.id);
                    } catch (error) {
                        console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                        addToSyncQueue(operation, 'operation');
                        errorCount++;
                    }
                }

                console.log(`‚úÖ Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} en cola`);
                if (successCount > 0) {
                    showSyncNotification(`üíæ ${successCount} operaciones guardadas exitosamente`, 'success');
                }
            } else {
                console.log('‚ÑπÔ∏è Usuario no autenticado - operaciones solo en local');
            }

            // Actualizar balances y vistas
            updateAccountBalances();
            refreshAllViews();

            showSyncNotification(`‚úÖ ${importedOpsCount} operaciones importadas correctamente. ${skippedOpsCount > 0 ? skippedOpsCount + ' omitidas.' : ''}`, 'success');
        } catch (error) {
            console.error('Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones: ' + error.message, 'error');
        }
    } else {
        showSyncNotification(`‚ùå No se importaron operaciones. ${skippedOpsCount} filas omitidas por errores.`, 'error');
    }
}

// ============================================
// FUNCIONES PARA PRIMEXBT
// ============================================

function importPrimeXBTCSV() {
    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csv = e.target.result;
                await processPrimeXBTCSV(csv);
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showSyncNotification('‚ùå Error procesando archivo CSV', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// Funci√≥n para procesar CSV de PrimeXBT
async function processPrimeXBTCSV(csvContent) {
    console.log('üìÑ Procesando CSV para PrimeXBT Crypto...');
    
    const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line);
    if (lines.length < 2) {
        showSyncNotification('El archivo CSV de PrimeXBT est√° vac√≠o o no tiene datos.', 'error');
        return;
    }

    // Usar el m√©todo est√°ndar de procesamiento CSV
    const splitLine = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    };

    const headers = splitLine(lines[0]);
    console.log('üîç [PrimeXBT Crypto CSV] Headers detectados:', headers);

    // Normalizar headers para compatibilidad con el formato est√°ndar
    const headerMap = {};
    headers.forEach((header, index) => {
        headerMap[header.toLowerCase().trim().replace(/\s+/g, ' ')] = index;
    });

    console.log('üîç [PrimeXBT Crypto CSV] Headers normalizados:', Object.keys(headerMap));

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === "") continue;
        const values = splitLine(line);
        if (values.length >= headers.length) {
            rows.push(values);
        } else {
            console.warn(`L√≠nea CSV con n√∫mero incorrecto de columnas: "${line}". Esperadas ${headers.length}, obtenidas ${values.length}.`);
        }
    }

    // Procesar filas de datos usando la l√≥gica unificada
    const rawOperations = [];
    let skippedOpsCount = 0;
    
    for (const row of rows) {
        if (row.length < 8) continue; // M√≠nimo de columnas necesarias
        
        try {
            // Obtener nombre de cuenta del CSV
            const accountNameFromCsv = (headerMap['nombre cuenta'] !== undefined ? row[headerMap['nombre cuenta']] : row[0]) || '';
            if (!accountNameFromCsv || accountNameFromCsv.trim() === "") {
                skippedOpsCount++;
                continue;
            }

            // Buscar cuenta existente
            const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());
            if (!account) {
                console.warn(`Cuenta no encontrada: "${accountNameFromCsv}". Operaci√≥n omitida.`);
                skippedOpsCount++;
                continue;
            }

            // Mapear datos usando headers normalizados o posiciones fijas
            const csvId = (headerMap['id'] !== undefined ? row[headerMap['id']] : row[1]) || null;
            const date = (headerMap['fecha'] !== undefined ? row[headerMap['fecha']] : row[2]) || new Date().toISOString().split('T')[0];
            const entryTime = (headerMap['hora entrada'] !== undefined ? row[headerMap['hora entrada']] : row[3]) || '09:00';
            const exitTime = (headerMap['hora salida'] !== undefined ? row[headerMap['hora salida']] : row[4]) || '09:00';
            const instrument = (headerMap['instrumento'] !== undefined ? row[headerMap['instrumento']] : row[5]) || 'Unknown';
            const type = (headerMap['tipo'] !== undefined ? row[headerMap['tipo']] : row[6]) || 'buy';
            const entry = parseFloat((headerMap['entrada'] !== undefined ? row[headerMap['entrada']] : row[7]) || 0);
            const exit = parseFloat((headerMap['salida'] !== undefined ? row[headerMap['salida']] : row[8]) || 0);
            const volume = parseFloat((headerMap['volumen'] !== undefined ? row[headerMap['volumen']] : row[9]) || 1);
            const currency = (headerMap['divisa'] !== undefined ? row[headerMap['divisa']] : row[11]) || 'USD';
            const fees = parseFloat((headerMap['tarifa/comision'] !== undefined ? row[headerMap['tarifa/comision']] : row[12]) || 0);
            const notes = (headerMap['notas'] !== undefined ? row[headerMap['notas']] : row[13]) || '';
            
            // Crear operaci√≥n b√°sica
            const baseOperation = {
                accountId: account.id, // Usar la cuenta encontrada del CSV
                date: date,
                entryTime: entryTime,
                exitTime: exitTime,
                instrument: instrument.toUpperCase(),
                type: type.toLowerCase(),
                entry: entry,
                exit: exit,
                volume: volume,
                currency: currency.toUpperCase(),
                fees: fees,
                notes: notes,
                imageDatas: [],
                session: 'No especificado'
            };

            // Calcular P&L y result
            let pl = parseFloat((headerMap['p&l'] !== undefined ? row[headerMap['p&l']] : row[10]) || 0);
            if (pl === 0 && baseOperation.entry > 0 && baseOperation.exit > 0) {
                // Calcular P&L si no viene en el CSV
                if (baseOperation.type === 'buy') {
                    pl = (baseOperation.exit - baseOperation.entry) * baseOperation.volume;
                } else {
                    pl = (baseOperation.entry - baseOperation.exit) * baseOperation.volume;
                }
            }
            
            baseOperation.pl = parseFloat(pl.toFixed(5));
            baseOperation.result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
            baseOperation.manualPL = pl;

            // Validar operaci√≥n
            if (baseOperation.instrument && baseOperation.type && baseOperation.entry > 0) {
                // Determinar si es una operaci√≥n parcial bas√°ndose en las notas
                let partialIndex = null;
                if (notes.toLowerCase().includes('parcial')) {
                    const match = notes.match(/parcial\s*(\d+)/i);
                    if (match) {
                        partialIndex = parseInt(match[1]);
                    }
                }

                // Generar ID usando la funci√≥n centralizada
                baseOperation.id = generateUnifiedOperationId(baseOperation, 'primexbt-crypto', csvId, partialIndex);
                rawOperations.push(baseOperation);
            }
        } catch (error) {
            console.warn('Error procesando fila CSV:', error, row);
            skippedOpsCount++;
        }
    }

    if (rawOperations.length === 0) {
        showSyncNotification('No se pudieron procesar operaciones del CSV. Verifica el formato o que las cuentas existan.', 'error');
        console.warn('‚ùå No se procesaron operaciones. Headers disponibles:', Object.keys(headerMap));
        console.warn('‚ùå Ejemplo de primera fila:', rows[0]);
        console.warn(`‚ùå Operaciones omitidas: ${skippedOpsCount}`);
        return;
    }

    console.log(`üìÑ Procesadas ${rawOperations.length} operaciones de PrimeXBT Crypto (${skippedOpsCount} omitidas)`);
    console.log('üîç Muestra de operaciones procesadas:', rawOperations.slice(0, 3));

    // Procesar operaciones usando las funciones centralizadas
    const newOperations = await processAndCleanOperations(rawOperations, 'primexbt-crypto');
    const importedCount = newOperations.length;

    if (newOperations.length > 0) {
        try {
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);

            // SINCRONIZACI√ìN AUTOM√ÅTICA CON SUPABASE
            console.log('üîç Iniciando sincronizaci√≥n de operaciones importadas...');
            if (currentUser) {
                console.log('üîç Usuario autenticado - sincronizando', newOperations.length, 'operaciones...');
                let successCount = 0;
                let errorCount = 0;

                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                        successCount++;
                        console.log('‚úÖ Operaci√≥n sincronizada:', operation.id);
                    } catch (error) {
                        console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                        addToSyncQueue(operation, 'operation');
                        errorCount++;
                    }
                }

                if (errorCount > 0) {
                    console.log(`‚ö†Ô∏è ${errorCount} operaciones agregadas a la cola de sincronizaci√≥n`);
                }
                console.log(`üìä Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} pendientes`);
            } else {
                console.log('‚ö†Ô∏è Usuario no autenticado - operaciones almacenadas localmente solamente');
            }

            // Actualizar vistas y mostrar resultado
            updateAccountBalances();
            refreshAllViews();
            
            showSyncNotification(`‚úÖ Se importaron ${importedCount} operaciones de PrimeXBT Crypto desde CSV. ${skippedOpsCount} filas omitidas.`, 'success');
            console.log(`‚úÖ Importaci√≥n completada: ${importedCount} operaciones de PrimeXBT Crypto, ${skippedOpsCount} omitidas`);

        } catch (error) {
            console.error('‚ùå Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones importadas', 'error');
        }
    } else {
        showSyncNotification('‚ÑπÔ∏è No se encontraron operaciones nuevas para importar', 'info');
    }
}

// Funci√≥n para corregir IDs de operaciones de PrimeXBT existentes
async function fixPrimeXBTOperationIDs() {
    console.log('üîß Corrigiendo IDs de operaciones de PrimeXBT...');
    
    // Buscar todas las operaciones de PrimeXBT con IDs generados autom√°ticamente
    const primeXBTOps = DB.operations.filter(op => 
        op.id.startsWith('primexbt_') && op.id.includes('_')
    );
    
    if (primeXBTOps.length === 0) {
        console.log('‚ÑπÔ∏è No se encontraron operaciones de PrimeXBT para corregir');
        return;
    }
    
    // Agrupar por fecha e instrumento para asignar el mismo ID
    const groupedByDateInstrument = {};
    primeXBTOps.forEach(op => {
        const key = `${op.date}_${op.instrument}`;
        if (!groupedByDateInstrument[key]) {
            groupedByDateInstrument[key] = [];
        }
        groupedByDateInstrument[key].push(op);
    });
    
    let correctedCount = 0;
    
    for (const [key, operations] of Object.entries(groupedByDateInstrument)) {
        // Usar la fecha como ID base para operaciones del mismo d√≠a/instrumento
        const [dateStr] = key.split('_');
        const newId = dateStr.replace(/-/g, '');
        
        console.log(`üìù Asignando ID ${newId} a ${operations.length} operaciones de ${key}`);
        
        for (const op of operations) {
            const oldId = op.id;
            op.id = newId;
            
            try {
                // Eliminar la operaci√≥n con el ID antiguo
                await dexieDB.operations.delete(oldId);
                // Agregar la operaci√≥n con el nuevo ID
                await dexieDB.operations.add(op);
                
                // Sincronizar con Supabase si est√° conectado
                if (currentUser) {
                    await saveOperationToSupabase(op);
                }
                
                correctedCount++;
            } catch (error) {
                console.error('Error actualizando operaci√≥n:', error);
            }
        }
    }
    
    console.log(`‚úÖ Se corrigieron ${correctedCount} operaciones de PrimeXBT`);
    
    // Actualizar vistas
    updateAccountBalances();
    refreshAllViews();
    
    showSyncNotification(`‚úÖ Se corrigieron ${correctedCount} IDs de operaciones de PrimeXBT`, 'success');
}

// Exportar funci√≥n al √°mbito global
window.fixPrimeXBTOperationIDs = fixPrimeXBTOperationIDs;

// Funci√≥n global para ejecutar correcci√≥n manualmente desde consola
window.fixPrimeXBTIDs = async function() {
    if (typeof fixPrimeXBTOperationIDs === 'function') {
        await fixPrimeXBTOperationIDs();
    } else {
        console.warn('‚ö†Ô∏è fixPrimeXBTOperationIDs no est√° disponible');
    }
};

// Funci√≥n global para resetear la correcci√≥n (para testing)
window.resetPrimeXBTCorrection = function() {
    localStorage.removeItem('primexbt-id-correction-executed');
    console.log('‚úÖ Flag de correcci√≥n reseteado. Recarga la p√°gina para ejecutar nuevamente.');
};

// Funci√≥n global para resetear el contador de IDs (usar con precauci√≥n)
window.resetOperationIdCounter = function(startValue = 25000) {
    localStorage.setItem('operation-id-counter', startValue.toString());
    console.log(`‚úÖ Contador de IDs reseteado a ${startValue}`);
};

// Funci√≥n global para ver el contador actual
window.getOperationIdCounter = function() {
    const counter = localStorage.getItem('operation-id-counter') || '25000';
    console.log(`üìä Contador actual de IDs: ${counter}`);
    console.log(`üìä Pr√≥ximo ID disponible: ${counter}`);
    return counter;
};

// ============================================
// FUNCI√ìN PARA PROCESAR DATOS DE INTERFAZ BITGET
// ============================================

async function processBitgetInterfaceData(rawData, accountId) {
    console.log('üìÑ Procesando datos desde interfaz de Bitget...');
    
    if (!rawData || !rawData.trim()) {
        showSyncNotification('‚ùå No se proporcionaron datos para importar', 'error');
        return;
    }

    if (!accountId) {
        showSyncNotification('‚ùå Debes seleccionar una cuenta destino', 'error');
        return;
    }

    // Buscar la cuenta seleccionada
    const account = DB.accounts.find(acc => acc.id === accountId);
    if (!account) {
        showSyncNotification('‚ùå Cuenta no encontrada', 'error');
        return;
    }

    // Separar por tabulaciones y saltos de l√≠nea
    const allFields = rawData
        .split(/[\n\t]+/)
        .map(field => field.trim())
        .filter(field => field && field !== '');
    
    console.log('üìã Total de campos detectados:', allFields.length);
    console.log('üìã Primeros 20 campos:', allFields.slice(0, 20));
    
    if (allFields.length < 10) {
        showSyncNotification('‚ùå Los datos parecen incompletos. Aseg√∫rate de copiar toda la informaci√≥n desde el Historial de Posici√≥n.', 'error');
        return;
    }

    const rawOperations = [];
    let fieldIndex = 0;
    let operationsCount = 0;
    let skippedOpsCount = 0;

    // Formato esperado del Historial de Posici√≥n de Bitget:
    // 0: Instrumento (ej: BTCUSDT)
    // 1: Tipo y Margen (ej: Short ¬∑ Aislado o Long ¬∑ Cruz)
    // 2: Fecha apertura (ej: 2025-08-23)
    // 3: Hora apertura (ej: 17:37:37)
    // 4: Precio apertura (ej: 114,818.1)
    // 5: Precio cierre (ej: 114,794.1)
    // 6: Volumen apertura (ej: 0.5565 BTC)
    // 7: Volumen cierre (ej: 0.5565 BTC)
    // 8: P&L (ej: -37.7531 USDT)
    // 9: Separador o ROE (ej: -- o +2.5%)
    // 10: Fecha cierre (ej: 2025-08-23)
    // 11: Hora cierre (ej: 17:58:12)
    // 12: Posible campo adicional (ej: --)

    while (fieldIndex < allFields.length) {
        try {
            // Verificar si tenemos suficientes campos (m√≠nimo 12)
            if (fieldIndex + 11 >= allFields.length) {
                console.warn('‚ö†Ô∏è No hay suficientes campos para completar m√°s operaciones');
                break;
            }

            // Extraer campos
            const instrument = (allFields[fieldIndex] || '').replace('/', '').toUpperCase();
            const typeAndMargin = (allFields[fieldIndex + 1] || '').toLowerCase();
            const openDate = allFields[fieldIndex + 2] || '';
            const openTime = allFields[fieldIndex + 3] || '';
            const openPriceStr = (allFields[fieldIndex + 4] || '0').replace(',', '.');
            const closePriceStr = (allFields[fieldIndex + 5] || '0').replace(',', '.');
            const volumeOpenStr = allFields[fieldIndex + 6] || '0';
            const volumeCloseStr = allFields[fieldIndex + 7] || '0';
            const plStr = allFields[fieldIndex + 8] || '0';
            
            // Los siguientes campos pueden variar
            let closeDate = '';
            let closeTime = '';
            
            // Buscar la fecha de cierre (formato YYYY-MM-DD)
            for (let i = fieldIndex + 9; i < Math.min(fieldIndex + 15, allFields.length); i++) {
                if (/^\d{4}-\d{2}-\d{2}$/.test(allFields[i])) {
                    closeDate = allFields[i];
                    // La hora de cierre deber√≠a estar justo despu√©s
                    if (i + 1 < allFields.length && /^\d{2}:\d{2}:\d{2}$/.test(allFields[i + 1])) {
                        closeTime = allFields[i + 1];
                        fieldIndex = i + 2; // Avanzar al siguiente registro
                    } else {
                        closeTime = openTime; // Usar hora de apertura si no hay hora de cierre
                        fieldIndex = i + 1;
                    }
                    break;
                }
            }

            if (!closeDate) {
                console.warn(`‚ö†Ô∏è No se encontr√≥ fecha de cierre para operaci√≥n ${instrument}`);
                closeDate = openDate; // Usar fecha de apertura como fallback
                closeTime = openTime;
                fieldIndex += 13; // Saltar algunos campos
            }

            console.log(`üìä Procesando operaci√≥n ${instrument}:`, {
                typeAndMargin,
                openDate,
                openTime,
                openPrice: openPriceStr,
                closePrice: closePriceStr,
                volume: volumeOpenStr,
                pl: plStr,
                closeDate,
                closeTime
            });

            // Validar datos m√≠nimos
            if (!instrument || !openDate) {
                console.warn(`‚ö†Ô∏è Operaci√≥n omitida (datos incompletos)`);
                skippedOpsCount++;
                continue;
            }

            // Determinar tipo (Long = buy, Short = sell)
            let type = '';
            if (typeAndMargin.includes('long')) {
                type = 'buy';
            } else if (typeAndMargin.includes('short')) {
                type = 'sell';
            } else {
                console.warn(`‚ö†Ô∏è Tipo de operaci√≥n desconocido: ${typeAndMargin}`);
                skippedOpsCount++;
                continue;
            }

            // Parsear precios
            const openPrice = parseFloat(openPriceStr);
            const closePrice = parseFloat(closePriceStr);
            
            if (!openPrice || openPrice === 0) {
                console.warn(`‚ö†Ô∏è Precio de apertura inv√°lido: ${openPriceStr}`);
                skippedOpsCount++;
                continue;
            }

            // Parsear volumen (extraer el n√∫mero, ignorar la unidad)
            const volumeMatch = volumeOpenStr.match(/([\d,\.]+)/);
            const volume = volumeMatch ? parseFloat(volumeMatch[1].replace(',', '.')) : 0;
            
            if (!volume || volume === 0) {
                console.warn(`‚ö†Ô∏è Volumen inv√°lido: ${volumeOpenStr}`);
                skippedOpsCount++;
                continue;
            }

            // Parsear P&L (formato: -37.7531 USDT o +50.25 USDT)
            const plMatch = plStr.match(/([+\-]?[\d,\.]+)/);
            const pl = plMatch ? parseFloat(plMatch[1].replace(',', '.')) : 0;

            // Extraer divisa del P&L
            const currencyMatch = plStr.match(/[A-Z]{3,4}$/);
            const currency = currencyMatch ? currencyMatch[0] : 'USDT';

            // Crear operaci√≥n
            const operation = {
                accountId: accountId,
                date: openDate,
                entryTime: openTime,
                exitTime: closeTime,
                instrument: instrument,
                type: type,
                entry: openPrice,
                exit: closePrice || openPrice, // Si no hay precio de cierre, usar el de apertura
                volume: volume,
                currency: currency,
                fees: 0, // Bitget no muestra fees separados en el historial de posici√≥n
                notes: `Importado desde interfaz Bitget - ${typeAndMargin}`,
                imageDatas: [],
                session: 'No especificado',
                pl: pl,
                result: pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven'),
                manualPL: pl
            };

            // Generar ID √∫nico
            operation.id = generateUnifiedOperationId(operation, 'bitget', `${instrument}-${openDate}-${openTime}`, null);

            rawOperations.push(operation);
            operationsCount++;
            console.log(`‚úÖ Operaci√≥n ${instrument} procesada correctamente`);

        } catch (error) {
            console.error('Error procesando operaci√≥n:', error);
            skippedOpsCount++;
            fieldIndex += 5;
        }
    }

    if (rawOperations.length === 0) {
        showSyncNotification(`‚ùå No se pudieron procesar operaciones. ${skippedOpsCount} operaciones omitidas.`, 'error');
        return;
    }

    console.log(`üìÑ Procesadas ${rawOperations.length} operaciones desde interfaz Bitget (${skippedOpsCount} omitidas)`);

    // Guardar operaciones
    let addedCount = 0;
    const statusDiv = document.getElementById('bitget-interface-status');

    for (const operation of rawOperations) {
        // Verificar si ya existe
        const existingOp = DB.operations.find(op => op.id === operation.id);
        
        if (existingOp) {
            console.log(`‚è≠Ô∏è Operaci√≥n ${operation.id} ya existe, omitida`);
            continue;
        }

        // Agregar a la base de datos
        DB.operations.push(operation);
        await dexieDB.operations.add(operation);

        // Sincronizar con Supabase si est√° conectado
        if (currentUser) {
            await saveOperationToSupabase(operation);
        }

        addedCount++;
    }

    if (addedCount > 0) {
        showSyncNotification(`‚úÖ ${addedCount} operaci√≥n(es) importada(s) desde Bitget`, 'success');
        statusDiv.textContent = `‚úÖ ${addedCount} operaci√≥n(es) importada(s) correctamente`;
        statusDiv.className = 'text-sm text-center text-green';
        
        // Refrescar dashboard si estamos ah√≠
        if (document.getElementById('dashboard').classList.contains('active')) {
            refreshDashboard();
        }
        
        // Cerrar modal despu√©s de 2 segundos
        setTimeout(() => {
            const modal = document.getElementById('bitget-interface-import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 2000);
    } else {
        showSyncNotification('‚ÑπÔ∏è No se encontraron operaciones nuevas para importar', 'info');
        statusDiv.textContent = '‚ÑπÔ∏è Todas las operaciones ya estaban importadas';
        statusDiv.className = 'text-sm text-center text-blue';
    }
}

// ============================================
// FUNCIONES PARA PRIMEXBT CFDs
// ============================================

async function processPrimeXBTCFDsCSV(csvContent) {
    console.log('üìÑ Procesando CSV para PrimeXBT CFDs...');
    
    // Buscar cuenta seleccionada o crear una por defecto para CFDs
    let selectedAccount = null;
    const primexbtCfdAccounts = DB.accounts.filter(acc => 
        acc.platform === 'primexbt-cfds' || (acc.platform === 'primexbt' && (acc.name.includes('CFD') || acc.name.includes('cfds')))
    );
    
    if (primexbtCfdAccounts.length > 0) {
        selectedAccount = primexbtCfdAccounts[0]; // Usar la primera cuenta de PrimeXBT CFDs
    } else {
        // Crear cuenta de PrimeXBT CFDs autom√°ticamente
        selectedAccount = {
            id: generateId(),
            name: 'PrimeXBT CFDs - Cuenta Principal',
            currency: 'USD',
            platform: 'primexbt-cfds',
            initialBalance: 0,
            balance: 0
        };

        DB.accounts.push(selectedAccount);
        await dexieDB.accounts.add(selectedAccount);

        // Sincronizar con Supabase si est√° conectado
        if (currentUser) {
            await saveAccountToSupabase(selectedAccount);
        }
    }

    const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line);
    if (lines.length < 2) {
        showSyncNotification('El archivo CSV de PrimeXBT CFDs est√° vac√≠o o no tiene datos.', 'error');
        return;
    }

    // Usar el mismo m√©todo de procesamiento que PrimeXBT Crypto
    const splitLine = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    };

    const headers = splitLine(lines[0]);
    console.log('üîç [PrimeXBT CFDs CSV] Headers detectados:', headers);

    const rawOperations = [];

    for (let i = 1; i < lines.length; i++) {
        const values = splitLine(lines[i]);
        if (values.length !== headers.length) {
            console.warn(`L√≠nea ${i+1} tiene ${values.length} valores pero se esperaban ${headers.length}. Omitida.`);
            continue;
        }

        const row = {};
        headers.forEach((header, index) => {
            row[header.toLowerCase().trim()] = values[index];
        });

        // Obtener datos de la operaci√≥n
        const csvId = row['id'] || '';
        const date = row['fecha'] || '';
        const entryTime = row['hora entrada'] || '';
        const exitTime = row['hora salida'] || '';
        const instrument = row['instrumento'] || '';
        const type = row['tipo'] || '';
        const entry = parseFloat(row['entrada'] || '0');
        const exit = parseFloat(row['salida'] || '0');
        const volume = parseFloat(row['volumen'] || '0');
        const pl = parseFloat(row['p&l'] || '0');
        const currency = row['divisa'] || 'USD';
        const fees = parseFloat(row['tarifa/comision'] || '0');
        const notes = row['notas'] || '';

        // Validaciones b√°sicas
        if (!date || !instrument || !type || volume <= 0) {
            console.warn(`L√≠nea ${i+1}: Datos insuficientes. Omitida.`);
            continue;
        }

        // Crear operaci√≥n b√°sica
        const baseOperation = {
            accountId: selectedAccount.id,
            date: date,
            entryTime: entryTime || '09:00',
            exitTime: exitTime || '09:00',
            instrument: instrument.toUpperCase(),
            type: type.toLowerCase(),
            entry: isNaN(entry) ? null : entry,
            exit: isNaN(exit) ? null : exit,
            volume: volume,
            pl: parseFloat(pl.toFixed(5)),
            result: pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven'),
            currency: currency.toUpperCase(),
            notes: notes || `PrimeXBT CFDs - Importado ${new Date().toLocaleString()}`,
            imageDatas: [],
            fees: fees || 0,
            manualPL: pl,
            session: 'No especificado'
        };

        // Generar ID usando la funci√≥n centralizada
        baseOperation.id = generateUnifiedOperationId(baseOperation, 'primexbt-cfds', csvId || null);

        rawOperations.push(baseOperation);
    }

    if (rawOperations.length === 0) {
        showSyncNotification('‚ùå No se encontraron operaciones v√°lidas en el CSV de PrimeXBT CFDs', 'error');
        return;
    }

    // Procesar operaciones usando las funciones centralizadas
    const newOperations = await processAndCleanOperations(rawOperations, 'primexbt-cfds');
    const importedCount = newOperations.length;

    if (newOperations.length > 0) {
        try {
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);

            // SINCRONIZACI√ìN AUTOM√ÅTICA CON SUPABASE
            console.log('üîç Iniciando sincronizaci√≥n de operaciones importadas...');
            if (currentUser) {
                console.log('üîç Usuario autenticado - sincronizando', newOperations.length, 'operaciones...');
                let successCount = 0;
                let errorCount = 0;

                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                        successCount++;
                        console.log('‚úÖ Operaci√≥n sincronizada:', operation.id);
                    } catch (error) {
                        console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                        addToSyncQueue(operation, 'operation');
                        errorCount++;
                    }
                }

                if (errorCount > 0) {
                    console.log(`‚ö†Ô∏è ${errorCount} operaciones agregadas a la cola de sincronizaci√≥n`);
                }
                console.log(`üìä Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} pendientes`);
            } else {
                console.log('‚ö†Ô∏è Usuario no autenticado - operaciones almacenadas localmente solamente');
            }

            // Actualizar vistas y mostrar resultado
            updateAccountBalances();
            refreshAllViews();
            
            showSyncNotification(`‚úÖ Se importaron ${importedCount} operaciones de PrimeXBT CFDs desde CSV`, 'success');
            console.log(`‚úÖ Importaci√≥n completada: ${importedCount} operaciones de PrimeXBT CFDs`);
        } catch (error) {
            console.error('‚ùå Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones importadas', 'error');
        }
    } else {
        showSyncNotification('‚ÑπÔ∏è No se encontraron operaciones nuevas para importar', 'info');
    }
}

function importPrimeXBTCFDsCSV() {
    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csv = e.target.result;
                await processPrimeXBTCFDsCSV(csv);
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showSyncNotification('‚ùå Error procesando archivo CSV', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// ============================================
// FUNCIONES PARA MEXC
// ============================================

function importMEXCCSV() {
    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csv = e.target.result;
                await processMEXCCSV(csv);
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showSyncNotification('‚ùå Error procesando archivo CSV', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// Funci√≥n para procesar CSV de MEXC
async function processMEXCCSV(csvContent) {
    console.log('üìÑ Procesando CSV para MEXC...');

    const parsedData = parseCSV(csvContent);

    if (!parsedData.headers || parsedData.rows.length === 0) {
        showSyncNotification('‚ùå CSV vac√≠o o formato incorrecto', 'error');
        return;
    }

    const headerMap = {};
    parsedData.headers.forEach((header, index) => {
        headerMap[header.toLowerCase().trim().replace(/\s+/g, ' ')] = index;
    });

    console.log('üîç [MEXC CSV] Headers normalizados detectados:', Object.keys(headerMap));

    const requiredHeaders = ['nombre cuenta', 'fecha', 'hora entrada', 'hora salida', 'instrumento', 'tipo', 'entrada', 'salida', 'volumen', 'divisa'];
    for (const reqHeader of requiredHeaders) {
        if (!(reqHeader in headerMap)) {
            showSyncNotification(`‚ùå Cabecera requerida no encontrada: '${reqHeader}'`, 'error');
            return;
        }
    }

    let skippedOpsCount = 0;
    const rawOperations = [];

    for (const row of parsedData.rows) {
        const accountNameFromCsv = row[headerMap['nombre cuenta']];
        if (!accountNameFromCsv || accountNameFromCsv.trim() === "") {
            skippedOpsCount++;
            continue;
        }

        const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());

        if (!account) {
            console.warn(`Cuenta no encontrada: "${accountNameFromCsv}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const dateStr = row[headerMap['fecha']];
        let opDate;

        // Limpiar y validar la fecha
        const cleanDateStr = dateStr.trim();

        if (cleanDateStr.includes('-')) {
            // Formato YYYY-MM-DD
            const parts = cleanDateStr.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                opDate = `${year}-${month}-${day}`;
            }
        } else if (cleanDateStr.includes('/')) {
            // Formato DD/MM/YYYY
            const parts = cleanDateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                opDate = `${year}-${month}-${day}`;
            }
        }

        // Validar que la fecha sea v√°lida
        if (!opDate) {
            console.warn(`Fecha inv√°lida: "${dateStr}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const testDate = new Date(opDate + "T12:00:00");
        if (isNaN(testDate.getTime())) {
            console.warn(`Fecha inv√°lida despu√©s de parsear: "${opDate}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const instrument = row[headerMap['instrumento']].toUpperCase().trim();
        const type = row[headerMap['tipo']].toLowerCase().trim();
        const entryStr = String(row[headerMap['entrada']]).replace(',', '.');
        const exitStr = String(row[headerMap['salida']]).replace(',', '.');
        const volumeStr = String(row[headerMap['volumen']]).replace(',', '.');

        const entryTime = row[headerMap['hora entrada']] || null;
        const exitTime = row[headerMap['hora salida']] || null;
        const session = headerMap['sesion'] !== undefined ? row[headerMap['sesion']].trim() : 'No especificado';

        const entry = parseFloat(entryStr);
        const exit = parseFloat(exitStr);
        const volume = parseFloat(volumeStr);

        const currency = row[headerMap['divisa']].toUpperCase().trim();
        const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';

        // Procesar tarifa/comisiones - Buscar en todas las variantes posibles
        let fees = 0;
        const possibleFeeHeaders = [
            'tarifa/comision',
            'tarifa/comisi√≥n',
            'tarifa',
            'comision',
            'comisi√≥n',
            'fee',
            'fees',
            'commission'
        ];

        let feeColumnFound = false;
        for (const feeHeader of possibleFeeHeaders) {
            if (headerMap[feeHeader] !== undefined) {
                const feeValue = row[headerMap[feeHeader]];
                if (feeValue && String(feeValue).trim() !== "") {
                    fees = Math.abs(parseFloat(String(feeValue).replace(',', '.')));
                    console.log(`üí∞ [MEXC CSV] Comisi√≥n detectada en columna '${feeHeader}':`, fees);
                    feeColumnFound = true;
                    break;
                }
            }
        }

        if (!feeColumnFound) {
            console.log('‚ö†Ô∏è [MEXC CSV] No se encontr√≥ columna de comisi√≥n en:', Object.keys(headerMap));
        }

        let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
            ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
            : null;
        let result;

        if (isNaN(volume) || volume <= 0) {
            skippedOpsCount++;
            continue;
        }

        if ((pl === null || isNaN(pl)) && (isNaN(entry) || isNaN(exit))) {
            skippedOpsCount++;
            continue;
        }

        if (pl !== null && !isNaN(pl)) {
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        } else {
            if (isNaN(entry) || isNaN(exit)) {
                skippedOpsCount++;
                continue;
            }
            if (type === 'buy')
             pl = (exit - entry) * volume;
            else pl = (entry - exit) * volume;
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        }
        pl = parseFloat(pl.toFixed(5));

        // Obtener ID del CSV si existe
        const csvId = headerMap['id'] !== undefined && row[headerMap['id']] && String(row[headerMap['id']]).trim() !== ""
            ? String(row[headerMap['id']]).trim()
            : null;

        // Crear operaci√≥n b√°sica
        const baseOperation = {
            date: opDate,
            accountId: account.id,
            instrument,
            type,
            entry: isNaN(entry) ? null : entry,
            exit: isNaN(exit) ? null : exit,
            entryTime,
            exitTime,
            volume,
            result,
            pl,
            currency,
            notes,
            imageDatas: [],
            fees: fees || 0,
            manualPL: (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "" && !isNaN(parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))))
                ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                : null,
            session: session
        };

        // Generar ID usando la funci√≥n centralizada
        baseOperation.id = generateUnifiedOperationId(baseOperation, 'mexc', csvId);

        rawOperations.push(baseOperation);
    }

    // Procesar operaciones usando las funciones centralizadas
    const newOperations = await processAndCleanOperations(rawOperations, 'mexc');
    const importedOpsCount = newOperations.length;

    if (newOperations.length > 0) {
        try {
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);

            // SINCRONIZACI√ìN AUTOM√ÅTICA CON SUPABASE
            console.log('üîç Iniciando sincronizaci√≥n de operaciones importadas...');
            if (currentUser) {
                console.log('üîç Usuario autenticado - sincronizando', newOperations.length, 'operaciones...');
                let successCount = 0;
                let errorCount = 0;

                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                        successCount++;
                        console.log('‚úÖ Operaci√≥n sincronizada:', operation.id);
                    } catch (error) {
                        console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                        addToSyncQueue(operation, 'operation');
                        errorCount++;
                    }
                }

                if (errorCount > 0) {
                    console.log(`‚ö†Ô∏è ${errorCount} operaciones agregadas a la cola de sincronizaci√≥n`);
                }
                console.log(`üìä Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} pendientes`);
            } else {
                console.log('‚ö†Ô∏è Usuario no autenticado - operaciones almacenadas localmente solamente');
            }

            updateAccountBalances();
            refreshAllViews();
            showSyncNotification(`‚úÖ Se importaron ${importedOpsCount} operaciones de MEXC desde CSV. ${skippedOpsCount} filas omitidas.`, 'success');
            console.log(`‚úÖ Importaci√≥n completada: ${importedOpsCount} operaciones de MEXC, ${skippedOpsCount} omitidas`);

        } catch (error) {
            console.error('‚ùå Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones importadas', 'error');
        }
    } else {
        showSyncNotification('‚ÑπÔ∏è No se encontraron operaciones nuevas para importar', 'info');
        console.log(`üìÑ Procesamiento completado: ${skippedOpsCount} filas omitidas, 0 operaciones nuevas`);
    }
}

// ============================================
// FUNCIONES PARA BITGET
// ============================================

function importBitgetCSV() {
    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csv = e.target.result;
                await processBitgetCSV(csv);
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showSyncNotification('‚ùå Error procesando archivo CSV', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// Funci√≥n para procesar CSV de Bitget
async function processBitgetCSV(csvContent) {
    console.log('üìÑ Procesando CSV para Bitget...');

    const parsedData = parseCSV(csvContent);

    if (!parsedData.headers || parsedData.rows.length === 0) {
        showSyncNotification('‚ùå CSV vac√≠o o formato incorrecto', 'error');
        return;
    }

    const headerMap = {};
    parsedData.headers.forEach((header, index) => {
        headerMap[header.toLowerCase().trim().replace(/\s+/g, ' ')] = index;
    });

    console.log('üîç [Bitget CSV] Headers normalizados detectados:', Object.keys(headerMap));

    const requiredHeaders = ['nombre cuenta', 'id', 'fecha', 'hora entrada', 'hora salida', 'instrumento', 'tipo', 'entrada', 'salida', 'volumen', 'divisa'];
    for (const reqHeader of requiredHeaders) {
        if (!(reqHeader in headerMap)) {
            showSyncNotification(`‚ùå Cabecera requerida no encontrada: '${reqHeader}'`, 'error');
            return;
        }
    }

    let skippedOpsCount = 0;
    const rawOperations = [];

    for (const row of parsedData.rows) {
        console.log('üîç [Bitget CSV] Procesando fila:', row);
        
        const accountNameFromCsv = row[headerMap['nombre cuenta']];
        console.log('üìã [Bitget CSV] Nombre cuenta del CSV:', accountNameFromCsv);
        
        if (!accountNameFromCsv || accountNameFromCsv.trim() === "") {
            console.warn('‚ö†Ô∏è [Bitget CSV] Nombre de cuenta vac√≠o, saltando operaci√≥n');
            skippedOpsCount++;
            continue;
        }

        const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());
        console.log('üè¶ [Bitget CSV] Cuentas disponibles:', DB.accounts.map(a => a.name));
        console.log('üîç [Bitget CSV] Cuenta encontrada:', account);

        if (!account) {
            console.warn(`‚ùå [Bitget CSV] Cuenta no encontrada: "${accountNameFromCsv}". Creando autom√°ticamente...`);
            
            // Crear cuenta autom√°ticamente
            const newAccount = {
                id: generateId(),
                name: accountNameFromCsv.trim(),
                broker: 'Bitget',
                currency: 'USDT', // Asumir USDT por defecto para Bitget
                balance: 0,
                initialBalance: 0,
                isActive: true,
                imagelogo: '/logos/bitget-logo.png'
            };
            
            DB.accounts.push(newAccount);
            await dexieDB.accounts.add(newAccount);
            console.log('‚úÖ [Bitget CSV] Cuenta creada autom√°ticamente:', newAccount);
            
            // Usar la cuenta reci√©n creada
            const createdAccount = newAccount;
            
            // Continuar con el procesamiento usando createdAccount en lugar de account
            const dateStr = row[headerMap['fecha']];
            let opDate;

            const cleanDateStr = dateStr.trim();
 
            if (cleanDateStr.includes('-')) {
                const parts = cleanDateStr.split('-');
                if (parts.length === 3 && parts[0].length === 4) {
                    const year = parts[0];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    opDate = `${year}-${month}-${day}`;
                }
            } else if (cleanDateStr.includes('/')) {
                const parts = cleanDateStr.split('/');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    opDate = `${year}-${month}-${day}`;
                }
            }

            if (!opDate) {
                console.warn(`Fecha inv√°lida: "${dateStr}". Operaci√≥n omitida.`);
                skippedOpsCount++;
                continue;
            }

            const testDate = new Date(opDate + "T12:00:00");
            if (isNaN(testDate.getTime())) {
                console.warn(`Fecha inv√°lida despu√©s de parsear: "${opDate}". Operaci√≥n omitida.`);
                skippedOpsCount++;
                continue;
            }

            const instrument = row[headerMap['instrumento']].toUpperCase().trim();
            const type = row[headerMap['tipo']].toLowerCase().trim();
            const entryStr = String(row[headerMap['entrada']]).replace(',', '.');
            const exitStr = String(row[headerMap['salida']]).replace(',', '.');
            const volumeStr = String(row[headerMap['volumen']]).replace(',', '.');

            const entryTime = row[headerMap['hora entrada']] || null;
            const exitTime = row[headerMap['hora salida']] || null;
            const session = headerMap['sesion'] !== undefined ? row[headerMap['sesion']].trim() : 'No especificado';

            const entry = parseFloat(entryStr);
            const exit = parseFloat(exitStr);
            const volume = parseFloat(volumeStr);

            const currency = row[headerMap['divisa']].toUpperCase().trim();
            const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';

            // Procesar tarifa/comisiones
            let fees = 0;
            const possibleFeeHeaders = [
                'tarifa/comision',
                'tarifa/comisi√≥n',
                'tarifa',
                'comision',
                'comisi√≥n',
                'fee',
                'fees',
                'commission'
            ];

            let feeColumnFound = false;
            for (const feeHeader of possibleFeeHeaders) {
                if (headerMap[feeHeader] !== undefined) {
                    const feeValue = row[headerMap[feeHeader]];
                    if (feeValue && String(feeValue).trim() !== "") {
                        fees = Math.abs(parseFloat(String(feeValue).replace(',', '.')));
                        console.log(`üí∞ [Bitget CSV] Comisi√≥n detectada en columna '${feeHeader}':`, fees);
                        feeColumnFound = true;
                        break;
                    }
                }
            }

            if (!feeColumnFound) {
                console.log('‚ö†Ô∏è [Bitget CSV] No se encontr√≥ columna de comisi√≥n');
            }

            // Obtener ID del CSV para agrupaci√≥n
            const csvId = headerMap['id'] !== undefined && row[headerMap['id']] && String(row[headerMap['id']]).trim() !== ""
                ? String(row[headerMap['id']]).trim()
                : null;

            let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
                ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                : null;
            let result;

            if (isNaN(volume) || volume <= 0) {
                skippedOpsCount++;
                continue;
            }

            if ((pl === null || isNaN(pl)) && (isNaN(entry) || isNaN(exit))) {
                skippedOpsCount++;
                continue;
            }

            if (pl !== null && !isNaN(pl)) {
                result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
            } else {
                if (isNaN(entry) || isNaN(exit)) {
                    skippedOpsCount++;
                    continue;
                }
                if (type === 'buy')
                    pl = (exit - entry) * volume;
                else
                    pl = (entry - exit) * volume;
                result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
            }
            pl = parseFloat(pl.toFixed(5));

            // Crear operaci√≥n b√°sica
            const baseOperation = {
                date: opDate,
                accountId: createdAccount.id,
                instrument,
                type,
                entry: isNaN(entry) ? null : entry,
                exit: isNaN(exit) ? null : exit,
                entryTime,
                exitTime,
                volume,
                result,
                pl,
                currency,
                notes,
                imageDatas: [],
                fees: fees || 0,
                manualPL: (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "" && !isNaN(parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))))
                    ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                    : null,
                csvId,
                rawCsvData: row.slice(),
                platform: 'Bitget'
            };

            // Usar el ID unificado
            const operationId = generateUnifiedOperationId(baseOperation, csvId);
            baseOperation.id = operationId;

            rawOperations.push(baseOperation);
            continue;
        }

        const dateStr = row[headerMap['fecha']];
        let opDate;

        const cleanDateStr = dateStr.trim();

        if (cleanDateStr.includes('-')) {
            const parts = cleanDateStr.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                opDate = `${year}-${month}-${day}`;
            }
        } else if (cleanDateStr.includes('/')) {
            const parts = cleanDateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                opDate = `${year}-${month}-${day}`;
            }
        }

        if (!opDate) {
            console.warn(`Fecha inv√°lida: "${dateStr}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const testDate = new Date(opDate + "T12:00:00");
        if (isNaN(testDate.getTime())) {
            console.warn(`Fecha inv√°lida despu√©s de parsear: "${opDate}". Operaci√≥n omitida.`);
            skippedOpsCount++;
            continue;
        }

        const instrument = row[headerMap['instrumento']].toUpperCase().trim();
        const type = row[headerMap['tipo']].toLowerCase().trim();
        const entryStr = String(row[headerMap['entrada']]).replace(',', '.');
        const exitStr = String(row[headerMap['salida']]).replace(',', '.');
        const volumeStr = String(row[headerMap['volumen']]).replace(',', '.');

        const entryTime = row[headerMap['hora entrada']] || null;
        const exitTime = row[headerMap['hora salida']] || null;
        const session = headerMap['sesion'] !== undefined ? row[headerMap['sesion']].trim() : 'No especificado';

        const entry = parseFloat(entryStr);
        const exit = parseFloat(exitStr);
        const volume = parseFloat(volumeStr);

        const currency = row[headerMap['divisa']].toUpperCase().trim();
        const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';

        // Procesar tarifa/comisiones
        let fees = 0;
        const possibleFeeHeaders = [
            'tarifa/comision',
            'tarifa/comisi√≥n',
            'tarifa',
            'comision',
            'comisi√≥n',
            'fee',
            'fees',
            'commission'
        ];

        let feeColumnFound = false;
        for (const feeHeader of possibleFeeHeaders) {
            if (headerMap[feeHeader] !== undefined) {
                const feeValue = row[headerMap[feeHeader]];
                if (feeValue && String(feeValue).trim() !== "") {
                    fees = Math.abs(parseFloat(String(feeValue).replace(',', '.')));
                    console.log(`üí∞ [Bitget CSV] Comisi√≥n detectada en columna '${feeHeader}':`, fees);
                    feeColumnFound = true;
                    break;
                }
            }
        }

        if (!feeColumnFound) {
            console.log('‚ö†Ô∏è [Bitget CSV] No se encontr√≥ columna de comisi√≥n');
        }

        // Obtener ID del CSV para agrupaci√≥n
        const csvId = headerMap['id'] !== undefined && row[headerMap['id']] && String(row[headerMap['id']]).trim() !== ""
            ? String(row[headerMap['id']]).trim()
            : null;

        let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
            ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
            : null;
        let result;

        if (isNaN(volume) || volume <= 0) {
            skippedOpsCount++;
            continue;
        }

        if ((pl === null || isNaN(pl)) && (isNaN(entry) || isNaN(exit))) {
            skippedOpsCount++;
            continue;
        }

        if (pl !== null && !isNaN(pl)) {
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        } else {
            if (isNaN(entry) || isNaN(exit)) {
                skippedOpsCount++;
                continue;
            }
            if (type === 'buy')
                pl = (exit - entry) * volume;
            else
                pl = (entry - exit) * volume;
            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
        }
        pl = parseFloat(pl.toFixed(5));

        // Crear operaci√≥n b√°sica
        const baseOperation = {
            date: opDate,
            accountId: account.id,
            instrument,
            type,
            entry: isNaN(entry) ? null : entry,
            exit: isNaN(exit) ? null : exit,
            entryTime,
            exitTime,
            volume,
            result,
            pl,
            currency,
            notes,
            imageDatas: [],
            fees: fees || 0,
            manualPL: (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "" && !isNaN(parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))))
                ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                : null,
            session: session
        };

        // Generar ID usando la funci√≥n centralizada
        baseOperation.id = generateUnifiedOperationId(baseOperation, 'bitget', csvId);

        rawOperations.push(baseOperation);
    }

    // Procesar operaciones usando las funciones centralizadas
    const newOperations = await processAndCleanOperations(rawOperations, 'bitget');
    const importedOpsCount = newOperations.length;

    if (newOperations.length > 0) {
        try {
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);

            console.log('üîç Iniciando sincronizaci√≥n de operaciones importadas...');
            if (currentUser) {
                console.log('üîç Usuario autenticado - sincronizando', newOperations.length, 'operaciones...');
                let successCount = 0;
                let errorCount = 0;

                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                        successCount++;
                        console.log('‚úÖ Operaci√≥n sincronizada:', operation.id);
                    } catch (error) {
                        console.error('‚ùå Error sincronizando operaci√≥n:', operation.id, error);
                        addToSyncQueue(operation, 'operation');
                        errorCount++;
                    }
                }

                console.log(`‚úÖ Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} en cola`);
                if (successCount > 0) {
                    showSyncNotification(`üíæ ${successCount} operaciones guardadas exitosamente`, 'success');
                }
            } else {
                console.log('‚ÑπÔ∏è Usuario no autenticado - operaciones solo en local');
            }

            updateAccountBalances();
            refreshAllViews();

            showSyncNotification(`‚úÖ ${importedOpsCount} operaciones importadas correctamente. ${skippedOpsCount > 0 ? skippedOpsCount + ' omitidas.' : ''}`, 'success');
        } catch (error) {
            console.error('Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones: ' + error.message, 'error');
        }
    } else {
        showSyncNotification(`‚ùå No se importaron operaciones. ${skippedOpsCount} filas omitidas por errores.`, 'error');
    }
}

// Funci√≥n para convertir trade de Bitget al formato de la aplicaci√≥n
function convertBitgetTradeToAppFormat(bitgetTrade, accountId) {
    console.log('üîÑ Convirtiendo trade Bitget:', bitgetTrade);
    
    // API V2 campos reales: tradeId, price, baseVolume, side, fee, profit
    const pnl = parseFloat(bitgetTrade.profit || 0);
    const result = pnl > 0 ? 'win' : (pnl < 0 ? 'loss' : 'breakeven');

    // API V2 usa cTime (creation time) en milliseconds
    const tradeDateObj = new Date(parseInt(bitgetTrade.cTime || bitgetTrade.timestamp || Date.now()));
    const tradeDate = getLocalDateString(tradeDateObj);

    const entryTime = new Date(parseInt(bitgetTrade.cTime || bitgetTrade.timestamp || Date.now())).toTimeString().split(' ')[0];
    const exitTime = bitgetTrade.uTime ?
        new Date(parseInt(bitgetTrade.uTime)).toTimeString().split(' ')[0] : entryTime;

    // API V2: tradeId es el ID √∫nico del trade
    const tradeId = bitgetTrade.tradeId || bitgetTrade.orderId || Date.now();

    const converted = {
        id: `bitget_${tradeId}`,
        date: tradeDate,
        accountId: accountId,
        instrument: bitgetTrade.symbol,
        type: (bitgetTrade.side || '').toLowerCase(), // "buy" or "sell"
        entry: parseFloat(bitgetTrade.price || 0),
        exit: parseFloat(bitgetTrade.price || 0),
        entryTime: entryTime,
        exitTime: exitTime,
        volume: parseFloat(bitgetTrade.baseVolume || 0),
        result: result,
        pl: pnl,
        fees: Math.abs(parseFloat(bitgetTrade.fee || 0)),
        currency: bitgetTrade.feeCcy || 'USDT',
        notes: `Importado de Bitget V2 - Trade ID: ${tradeId}`,
        imageDatas: [],
        manualPL: null,
        session: 'No especificado'
    };
    
    console.log('‚úÖ Trade convertido:', converted);
    return converted;
}

// Guardar credenciales de Bitget en Supabase
async function saveBitgetCredentialsToSupabase(apiKey, secretKey, passphrase, accountId) {
    if (!currentUser) {
        console.warn('‚ùå No current user - cannot save Bitget credentials to Supabase');
        return null;
    }

    try {
        console.log('üíæ [saveBitget] Iniciando guardado en Supabase...');
        console.log('üíæ [saveBitget] User ID:', currentUser.id);
        console.log('üíæ [saveBitget] Account ID:', accountId);
        
        // Primero obtener las settings actuales
        console.log('üì• [saveBitget] Consultando settings existentes...');
        const { data: existingSettings, error: fetchError } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (fetchError && fetchError.code !== 'PGRST116') {
            console.error('‚ùå [saveBitget] Error al consultar settings:', fetchError);
        }

        let apiKeys = existingSettings?.api_keys || {};
        console.log('üìä [saveBitget] API Keys existentes:', Object.keys(apiKeys));
        
        // Actualizar credenciales de Bitget
        apiKeys.bitget = {
            apiKey: apiKey,
            secretKey: secretKey,
            passphrase: passphrase,
            accountId: accountId,
            updatedAt: new Date().toISOString()
        };

        console.log('üíæ [saveBitget] Ejecutando upsert...');
        // Guardar o actualizar
        const { data, error } = await supabase
            .from('user_settings')
            .upsert({
                user_id: currentUser.id,
                api_keys: apiKeys,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id'
            });

        if (error) {
            console.error('‚ùå [saveBitget] Error en upsert:', error);
            console.error('‚ùå [saveBitget] Error code:', error.code);
            console.error('‚ùå [saveBitget] Error message:', error.message);
            throw error;
        }

        console.log('‚úÖ [saveBitget] Credenciales Bitget guardadas exitosamente');
        console.log('‚úÖ [saveBitget] Response:', data);
        return data;
    } catch (error) {
        console.error('‚ùå [saveBitget] Error en saveBitgetCredentialsToSupabase:', error);
        console.error('‚ùå [saveBitget] Stack:', error.stack);
        throw error;
    }
}

// Cargar credenciales de Bitget desde Supabase
async function loadBitgetCredentialsFromSupabase() {
    if (!currentUser) {
        console.log('‚ÑπÔ∏è No hay usuario autenticado para cargar credenciales Bitget');
        return null;
    }

    try {
        console.log('üì• Cargando credenciales Bitget de Supabase...');
        
        const { data, error } = await supabase
            .from('user_settings')
            .select('api_keys')
            .eq('user_id', currentUser.id)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                console.log('‚ÑπÔ∏è No hay settings guardados a√∫n');
                return null;
            }
            throw error;
        }

        const bitgetCreds = data?.api_keys?.bitget;
        if (bitgetCreds) {
            console.log('‚úÖ Credenciales Bitget cargadas de Supabase');
            return {
                key: bitgetCreds.apiKey,
                secret: bitgetCreds.secretKey,
                passphrase: bitgetCreds.passphrase,
                accountId: bitgetCreds.accountId
            };
        }

        return null;
    } catch (error) {
        console.error('‚ùå Error cargando credenciales Bitget de Supabase:', error);
        return null;
    }
}

// Funci√≥n para sincronizar trades desde Bitget
async function syncBitgetTrades() {
    // 1. Verificar si hay credenciales guardadas en Supabase
    if (!bitgetAPI && currentUser) {
        console.log('üîÑ bitgetAPI no inicializada, cargando credenciales desde Supabase...');
        const savedCreds = await loadBitgetCredentialsFromSupabase();
        
        if (savedCreds && savedCreds.key && savedCreds.secret && savedCreds.passphrase) {
            console.log('‚úÖ Credenciales encontradas, inicializando bitgetAPI...');
            console.log('üîë [DEBUG] API Key:', savedCreds.key.substring(0, 10) + '...');
            console.log('üîë [DEBUG] Secret:', savedCreds.secret ? '***SET***' : '***EMPTY***');
            console.log('üîë [DEBUG] Passphrase:', savedCreds.passphrase ? '***SET***' : '***EMPTY***');
            bitgetAPI = new BitgetAPI(savedCreds.key, savedCreds.secret, savedCreds.passphrase);
        }
    }

    // 2. Si a√∫n no hay API, mostrar error
    if (!bitgetAPI) {
        showSyncNotification('‚ùå Primero debes configurar y guardar tus credenciales de Bitget', 'error');
        updateBitgetStatus('error', 'No configurado', false);
        return;
    }
    
    // 3. DEBUG: Verificar que bitgetAPI tiene credenciales correctas
    console.log('üîç [DEBUG] Verificando instancia bitgetAPI:');
    console.log('üîç [DEBUG] API Key:', bitgetAPI.apiKey ? bitgetAPI.apiKey.substring(0, 10) + '...' : 'UNDEFINED');
    console.log('üîç [DEBUG] Secret:', bitgetAPI.secretKey ? '***SET***' : 'UNDEFINED');
    console.log('üîç [DEBUG] Passphrase:', bitgetAPI.passphrase ? '***SET***' : 'UNDEFINED');

    let selectedAccount = null;

    const accountDetailSelect = document.getElementById('bitget-account-detail');
    if (accountDetailSelect && accountDetailSelect.value) {
        selectedAccount = DB.accounts.find(acc => acc.id === accountDetailSelect.value);
    }

    if (!selectedAccount) {
        showSyncNotification('‚ùå Selecciona una cuenta para sincronizar', 'error');
        return;
    }

    updateBitgetStatus('syncing', 'Sincronizando...', true);
    showSyncNotification('üîÑ Sincronizando trades de Bitget...', 'info');

    try {
        console.log('üì° Obteniendo trades de Bitget...');

        const tradesResponse = await bitgetAPI.getTradeHistory();

        // API V2 devuelve trades en data.fillList
        const bitgetTrades = tradesResponse?.data?.fillList || tradesResponse?.data || [];
        
        if (!Array.isArray(bitgetTrades) || bitgetTrades.length === 0) {
            console.log('üìä Respuesta de Bitget:', tradesResponse);
            showSyncNotification('‚ÑπÔ∏è No se encontraron trades en Bitget', 'info');
            updateBitgetStatus('connected', 'Conectado - Sin trades', false);
            return;
        }

        console.log(`üìä Trades obtenidos: ${bitgetTrades.length}`);

        const existingTradeIds = new Set(
            DB.operations
                .filter(op => op.id.startsWith('bitget_'))
                .map(op => op.id)
        );

        let newTradesCount = 0;
        const newOperations = [];

        for (const trade of bitgetTrades) {
            const convertedTrade = convertBitgetTradeToAppFormat(trade, selectedAccount.id);

            if (!existingTradeIds.has(convertedTrade.id)) {
                newOperations.push(convertedTrade);
                newTradesCount++;
            }
        }

        if (newOperations.length > 0) {
            console.log(`üíæ Guardando ${newOperations.length} nuevas operaciones en IndexedDB...`);
            console.log('üìã Operaciones a guardar:', newOperations);
            
            try {
                await dexieDB.operations.bulkAdd(newOperations);
                DB.operations.push(...newOperations);
                console.log('‚úÖ Operaciones guardadas en IndexedDB');
            } catch (bulkError) {
                console.error('‚ùå Error BulkAdd:', bulkError);
                console.error('‚ùå Error details:', bulkError.failures);
                throw bulkError;
            }

            if (currentUser) {
                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                    } catch (error) {
                        console.error('Error sincronizando operaci√≥n:', error);
                        addToSyncQueue(operation, 'operation');
                    }
                }
            }

            updateAccountBalances();
            refreshAllViews();

            showSyncNotification(`‚úÖ ${newTradesCount} nuevas operaciones sincronizadas desde Bitget`, 'success');
        } else {
            showSyncNotification('‚ÑπÔ∏è No hay nuevas operaciones para sincronizar', 'info');
        }

        updateBitgetStatus('connected', 'Sincronizaci√≥n completada', false);
        addBitgetSyncHistory(newTradesCount, bitgetTrades.length - newTradesCount);

    } catch (error) {
        console.error('‚ùå Error sincronizando trades de Bitget:', error);
        console.error('‚ùå Stack trace:', error.stack);
        showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
        updateBitgetStatus('error', 'Error en sincronizaci√≥n', false);
    }
}

// Actualizar estado visual de Bitget
function updateBitgetStatus(status, message, showProgress) {
    const statusIndicator = document.getElementById('bitget-status-indicator');
    const progressBar = document.getElementById('bitget-progress-bar');
    const connectionStatus = document.getElementById('bitget-connection-status');

    if (statusIndicator) {
        const statusColors = {
            'connected': 'text-green-400',
            'syncing': 'text-blue-400',
            'error': 'text-red-400',
            'disconnected': 'text-yellow-400'
        };

        statusIndicator.className = statusColors[status] || 'text-gray-400';
        statusIndicator.textContent = message;
    }

    if (progressBar) {
        progressBar.style.width = showProgress ? '100%' : '0%';
    }

    if (connectionStatus) {
        const bgColors = {
            'connected': 'bg-green-800 border-green-600',
            'syncing': 'bg-blue-800 border-blue-600',
            'error': 'bg-red-800 border-red-600',
            'disconnected': 'bg-yellow-800 border-yellow-600'
        };

        const icons = {
            'connected': 'fa-check-circle text-green-300',
            'syncing': 'fa-sync-alt fa-spin text-blue-300',
            'error': 'fa-exclamation-triangle text-red-300',
            'disconnected': 'fa-exclamation-triangle text-yellow-300'
        };

        connectionStatus.className = `p-4 rounded-md mb-4 ${bgColors[status] || 'bg-gray-800 border-gray-600'}`;
        connectionStatus.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icons[status] || 'fa-circle'} text-xl mr-3"></i>
                <div>
                    <p class="font-semibold">${message}</p>
                    <p class="text-sm mt-1">${status === 'connected' ? 'Listo para sincronizar trades' : status === 'syncing' ? 'Obteniendo datos...' : 'Verifica la configuraci√≥n'}</p>
                </div>
            </div>
        `;
    }

    const lastSync = document.getElementById('bitget-last-sync');
    if (lastSync && status === 'connected') {
        const now = new Date();
        lastSync.textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }
}

// Agregar entrada al historial de sincronizaci√≥n
function addBitgetSyncHistory(newTrades, skippedTrades) {
    const historyContainer = document.getElementById('bitget-sync-history');
    if (!historyContainer) return;

    if (historyContainer.querySelector('.text-center')) {
        historyContainer.innerHTML = '';
    }

    const now = new Date();
    const historyEntry = document.createElement('div');
    historyEntry.className = 'p-3 bg-surface-light rounded-md text-sm';
    historyEntry.innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <span class="font-semibold text-green-400">${newTrades} nuevas</span>
                <span class="text-text-secondary mx-2">|</span>
                <span class="text-text-secondary">${skippedTrades} existentes</span>
            </div>
            <span class="text-text-secondary text-xs">${now.toLocaleString()}</span>
        </div>
    `;

    historyContainer.insertBefore(historyEntry, historyContainer.firstChild);

    const entries = historyContainer.querySelectorAll('.p-3');
    if (entries.length > 10) {
        entries[entries.length - 1].remove();
    }
}

// Actualizar historial de importaciones de MEXC
function updateMEXCImportHistory() {
    const historyContainer = document.getElementById('mexc-import-history');
    if (!historyContainer) return;

    // Remover mensaje de "no hay importaciones"
    if (historyContainer.querySelector('.text-center')) {
        historyContainer.innerHTML = '';
    }

    const now = new Date();
    const historyEntry = document.createElement('div');
    historyEntry.className = 'p-3 bg-surface-light rounded-md text-sm';
    historyEntry.innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <i class="fas fa-file-csv text-blue-400 mr-2"></i>
                <span class="font-semibold text-green-400">CSV Importado</span>
                <span class="text-text-secondary mx-2">|</span>
                <span class="text-text-secondary">MEXC</span>
            </div>
            <span class="text-text-secondary text-xs">${now.toLocaleString()}</span>
        </div>
    `;

    historyContainer.insertBefore(historyEntry, historyContainer.firstChild);

    // Mantener solo las √∫ltimas 10 entradas
    const entries = historyContainer.querySelectorAll('.p-3');
    if (entries.length > 10) {
        entries[entries.length - 1].remove();
    }
}

// Cargar credenciales guardadas de Bitget
async function loadBitgetCredentials() {
    try {
        // Primero intentar cargar desde Supabase si hay usuario autenticado
        if (currentUser) {
            const supabaseCreds = await loadBitgetCredentialsFromSupabase();
            if (supabaseCreds) {
                const apiKeyDetail = document.getElementById('bitget-api-key-detail');
                const secretKeyDetail = document.getElementById('bitget-secret-key-detail');
                const passphraseDetail = document.getElementById('bitget-passphrase-detail');

                if (apiKeyDetail) apiKeyDetail.value = supabaseCreds.key || '';
                if (secretKeyDetail) secretKeyDetail.value = supabaseCreds.secret || '';
                if (passphraseDetail) passphraseDetail.value = supabaseCreds.passphrase || '';

                if (supabaseCreds.key && supabaseCreds.secret && supabaseCreds.passphrase) {
                    if (window.FORCE_OFFLINE_BITGET) {
                        bitgetAPI = new MockBitgetAPI();
                    } else {
                        bitgetAPI = new BitgetAPI(supabaseCreds.key, supabaseCreds.secret, supabaseCreds.passphrase);
                    }
                    
                    const credentials = {
                        id: 'bitget',
                        key: supabaseCreds.key,
                        secret: supabaseCreds.secret,
                        passphrase: supabaseCreds.passphrase,
                        accountId: supabaseCreds.accountId,
                        platform: 'bitget'
                    };
                    
                    DB.apiKeys.bitget = credentials;
                    await dexieDB.apiKeys.put(credentials);
                    
                    if (supabaseCreds.accountId) {
                        localStorage.setItem('bitget_account_id', supabaseCreds.accountId);
                    }
                    
                    updateBitgetStatus('connected', 'Conectado', false);
                    console.log('‚úÖ Credenciales de Bitget cargadas desde Supabase');
                    return;
                }
            }
        }
        
        // Si no hay en Supabase, intentar cargar desde IndexedDB
        const savedKeys = await dexieDB.apiKeys.get('bitget');
        if (savedKeys) {
            const apiKeyDetail = document.getElementById('bitget-api-key-detail');
            const secretKeyDetail = document.getElementById('bitget-secret-key-detail');
            const passphraseDetail = document.getElementById('bitget-passphrase-detail');

            if (apiKeyDetail) apiKeyDetail.value = savedKeys.key || '';
            if (secretKeyDetail) secretKeyDetail.value = savedKeys.secret || '';
            if (passphraseDetail) passphraseDetail.value = savedKeys.passphrase || '';

            if (savedKeys.key && savedKeys.secret && savedKeys.passphrase) {
                if (window.FORCE_OFFLINE_BITGET) {
                    bitgetAPI = new MockBitgetAPI();
                } else {
                    bitgetAPI = new BitgetAPI(savedKeys.key, savedKeys.secret, savedKeys.passphrase);
                }
                DB.apiKeys.bitget = savedKeys;
                updateBitgetStatus('connected', 'Conectado', false);
                console.log('‚úÖ Credenciales de Bitget cargadas desde IndexedDB');
            }
        } else {
            console.log('‚ÑπÔ∏è No hay credenciales guardadas de Bitget');
        }
    } catch (error) {
        console.error('‚ùå Error cargando credenciales de Bitget:', error);
    }
}

// Cargar lista de cuentas en select de Bitget
function populateBitgetAccountSelect() {
    const select = document.getElementById('bitget-account-detail');
    if (!select) {
        console.warn('‚ö†Ô∏è Select de cuentas de Bitget no encontrado');
        return;
    }

    select.innerHTML = '<option value="">Seleccionar cuenta...</option>';
    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} (${account.balance} ${account.currency})`;
        select.appendChild(option);
    });

    // Intentar restaurar la cuenta guardada desde m√∫ltiples fuentes
    let savedAccountId = null;
    
    // 1. Prioridad: DB.apiKeys.bitget.accountId
    if (DB.apiKeys.bitget && DB.apiKeys.bitget.accountId) {
        savedAccountId = DB.apiKeys.bitget.accountId;
    }
    
    // 2. Fallback: localStorage
    if (!savedAccountId) {
        savedAccountId = localStorage.getItem('bitget_account_id');
    }
    
    // 3. Restaurar valor en el select
    if (savedAccountId) {
        select.value = savedAccountId;
        console.log('‚úÖ Cuenta Bitget restaurada:', savedAccountId);
    } else if (DB.accounts.length > 0) {
        // Si no hay cuenta guardada, seleccionar la primera autom√°ticamente
        select.value = DB.accounts[0].id;
        console.log('‚úÖ Primera cuenta Bitget seleccionada autom√°ticamente:', DB.accounts[0].name);
    }

    // Agregar listener para guardar cuando cambie la selecci√≥n (solo una vez)
    select.removeEventListener('change', handleBitgetAccountChange);
    select.addEventListener('change', handleBitgetAccountChange);

    console.log('‚úÖ Selector de cuentas Bitget poblado con', DB.accounts.length, 'cuentas');
}

// Handler separado para evitar duplicaci√≥n de listeners
async function handleBitgetAccountChange(e) {
    const accountId = e.target.value;
    if (!accountId) return;
    
    console.log('üíæ Guardando cuenta seleccionada de Bitget:', accountId);
    
    // Actualizar localStorage
    localStorage.setItem('bitget_account_id', accountId);
    
    // Actualizar DB.apiKeys.bitget
    if (!DB.apiKeys.bitget) {
        DB.apiKeys.bitget = {};
    }
    DB.apiKeys.bitget.accountId = accountId;
    
    // Guardar en IndexedDB
    try {
        const existingCreds = await dexieDB.apiKeys.get('bitget');
        if (existingCreds) {
            existingCreds.accountId = accountId;
            await dexieDB.apiKeys.put(existingCreds);
            console.log('‚úÖ Cuenta guardada en IndexedDB');
        }
    } catch (error) {
        console.error('‚ö†Ô∏è Error guardando en IndexedDB:', error);
    }
    
    // Guardar en Supabase si hay usuario autenticado
    if (currentUser && DB.apiKeys.bitget && DB.apiKeys.bitget.key && DB.apiKeys.bitget.secret && DB.apiKeys.bitget.passphrase) {
        try {
            await saveBitgetCredentialsToSupabase(
                DB.apiKeys.bitget.key, 
                DB.apiKeys.bitget.secret, 
                DB.apiKeys.bitget.passphrase, 
                accountId
            );
            console.log('‚úÖ Cuenta de Bitget guardada en Supabase');
        } catch (error) {
            console.error('‚ö†Ô∏è Error guardando cuenta en Supabase:', error);
        }
    }
}

// ============================================
// MEXC API FUNCTIONS
// ============================================

// Exportar funciones a window para acceso global
window.loadBitgetCredentials = loadBitgetCredentials;
window.populateBitgetAccountSelect = populateBitgetAccountSelect;
window.handleBitgetAccountChange = handleBitgetAccountChange;

// Probar conexi√≥n con MEXC
async function testMEXCConnection() {
    const apiKeyInput = document.getElementById('mexc-api-key-detail');
    const secretKeyInput = document.getElementById('mexc-secret-key-detail');

    const apiKey = apiKeyInput?.value.trim();
    const secretKey = secretKeyInput?.value.trim();

    if (!apiKey || !secretKey) {
        showSyncNotification('‚ùå Ingresa API Key y Secret Key', 'error');
        return;
    }

    try {
        showSyncNotification('üîÑ Probando conexi√≥n con MEXC...', 'info');

        const testAPI = new MEXCAPI(apiKey, secretKey);
        const result = await testAPI.testConnection();

        showSyncNotification('‚úÖ Conexi√≥n exitosa a MEXC', 'success');
        updateMEXCStatus('connected', 'Test exitoso', false);
        console.log('Test de conexi√≥n MEXC exitoso:', result);

        return true;
    } catch (error) {
        console.error('Error en test de conexi√≥n MEXC:', error);
        showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
        updateMEXCStatus('error', 'Error en conexi√≥n', false);
        return false;
    }
}

// Conectar con MEXC
async function connectMEXC() {
    console.log('üîÑ connectMEXC() iniciada');
    
    const apiKeyInput = document.getElementById('mexc-api-key-detail');
    const secretKeyInput = document.getElementById('mexc-secret-key-detail');
    const accountSelect = document.getElementById('mexc-account-detail');

    console.log('üîç Elementos encontrados:', {
        apiKeyInput: !!apiKeyInput,
        secretKeyInput: !!secretKeyInput,
        accountSelect: !!accountSelect
    });

    const apiKey = apiKeyInput?.value.trim();
    const secretKey = secretKeyInput?.value.trim();
    const accountId = accountSelect?.value;

    console.log('üîç Valores obtenidos:', {
        apiKey: apiKey ? `${apiKey.substring(0, 8)}...` : 'vac√≠o',
        secretKey: secretKey ? 'presente' : 'vac√≠o',
        accountId: accountId || 'vac√≠o'
    });

    if (!apiKey || !secretKey) {
        console.error('‚ùå Faltan credenciales');
        showSyncNotification('‚ùå Ingresa todas las credenciales', 'error');
        return;
    }

    if (!accountId) {
        console.error('‚ùå Falta cuenta');
        showSyncNotification('‚ùå Selecciona una cuenta', 'error');
        return;
    }

    try {
        console.log('üîÑ Iniciando proceso de conexi√≥n...');
        showSyncNotification('üîÑ Conectando con MEXC...', 'info');
        updateMEXCStatus('connecting', 'Conectando...', true);

        // Crear instancia de API
        console.log('üîß Creando instancia de MEXCAPI...');
        mexcAPI = new MEXCAPI(apiKey, secretKey);

        // Probar conexi√≥n
        console.log('üß™ Probando conexi√≥n...');
        await mexcAPI.testConnection();
        console.log('‚úÖ Conexi√≥n exitosa');

        // Guardar credenciales en localStorage
        console.log('üíæ Guardando en localStorage...');
        localStorage.setItem('mexc_api_key', apiKey);
        localStorage.setItem('mexc_secret_key', secretKey);
        localStorage.setItem('mexc_account_id', accountId);
        
        const credentials = {
            id: 'mexc',
            key: apiKey,
            secret: secretKey,
            accountId: accountId,
            platform: 'mexc'
        };

        // Guardar en IndexedDB
        console.log('üíæ Guardando en IndexedDB...');
        await dexieDB.apiKeys.put(credentials);
        DB.apiKeys.mexc = credentials;
        console.log('‚úÖ Guardado en IndexedDB');
        
        // Guardar en Supabase si el usuario est√° autenticado
        if (currentUser) {
            try {
                console.log('üíæ Guardando credenciales MEXC en Supabase...');
                console.log('üë§ Usuario actual:', currentUser.email);
                await saveMEXCCredentialsToSupabase(apiKey, secretKey, accountId);
                console.log('‚úÖ Credenciales MEXC guardadas en Supabase');
            } catch (error) {
                console.error('‚ö†Ô∏è Error guardando credenciales en Supabase:', error);
                console.error('‚ö†Ô∏è Stack:', error.stack);
            }
        } else {
            console.warn('‚ö†Ô∏è No hay usuario autenticado, no se guardar√° en Supabase');
        }

        updateMEXCStatus('connected', 'Conectado exitosamente', false);
        showSyncNotification('‚úÖ MEXC conectado exitosamente', 'success');

        console.log('‚úÖ MEXC API conectada y credenciales guardadas');

    } catch (error) {
        console.error('Error conectando con MEXC:', error);
        showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
        updateMEXCStatus('error', 'Error en conexi√≥n', false);
        mexcAPI = null;
    }
}

// Sincronizar trades de MEXC
async function syncMEXCTrades() {
    // 1. Verificar si hay credenciales guardadas en Supabase
    if (!mexcAPI && currentUser) {
        console.log('üîÑ mexcAPI no inicializada, cargando credenciales desde Supabase...');
        const savedCreds = await loadMEXCCredentialsFromSupabase();
        
        if (savedCreds && savedCreds.key && savedCreds.secret) {
            console.log('‚úÖ Credenciales encontradas, inicializando mexcAPI...');
            mexcAPI = new MEXCAPI(savedCreds.key, savedCreds.secret);
        }
    }

    // 2. Si a√∫n no hay API, mostrar error
    if (!mexcAPI) {
        showSyncNotification('‚ùå Primero debes configurar y guardar tus credenciales de MEXC', 'error');
        updateMEXCStatus('error', 'No configurado', false);
        return;
    }

    let selectedAccount = null;

    const accountDetailSelect = document.getElementById('mexc-account-detail');
    if (accountDetailSelect && accountDetailSelect.value) {
        selectedAccount = DB.accounts.find(acc => acc.id === accountDetailSelect.value);
        console.log('üìã Cuenta seleccionada para sincronizaci√≥n MEXC:', selectedAccount.name);
    }

    if (!selectedAccount) {
        showSyncNotification('‚ùå Selecciona una cuenta para sincronizar', 'error');
        console.error('‚ùå No hay cuenta seleccionada. Valor del select:', accountDetailSelect?.value);
        return;
    }

    updateMEXCStatus('syncing', 'Sincronizando...', true);
    showSyncNotification(`üîÑ Sincronizando trades de MEXC a cuenta: ${selectedAccount.name}`, 'info');

    try {
        console.log('üì° Obteniendo trades de MEXC...');
        console.log('üìã Cuenta destino:', selectedAccount);

        // Obtener trades de los √∫ltimos 30 d√≠as
        const endTime = Date.now();
        const startTime = endTime - (30 * 24 * 60 * 60 * 1000);

        console.log(`üïê Rango de fechas: ${new Date(startTime).toLocaleString()} - ${new Date(endTime).toLocaleString()}`);

        const tradesResponse = await mexcAPI.getTradeHistory('', startTime, endTime);
        console.log(`üì¶ MEXC Response completa:`, tradesResponse);
        console.log(`üì¶ MEXC Response JSON:`, JSON.stringify(tradesResponse, null, 2));
        console.log(`üì¶ MEXC Response keys:`, Object.keys(tradesResponse));

        if (!tradesResponse || (!tradesResponse.data && !Array.isArray(tradesResponse))) {
            console.log(`‚ö†Ô∏è Respuesta vac√≠a o sin data`);
            showSyncNotification('‚ÑπÔ∏è No se encontraron trades en MEXC', 'info');
            updateMEXCStatus('connected', 'Conectado - Sin trades', false);
            return;
        }

        // MEXC puede retornar: { data: [...] } o { data: { data: [...] } } o directamente un array
        let mexcTrades = [];
        if (Array.isArray(tradesResponse)) {
            console.log(`üìã Respuesta es array directo con ${tradesResponse.length} elementos`);
            mexcTrades = tradesResponse;
        } else if (tradesResponse.data) {
            console.log(`üìã Respuesta tiene campo data:`, tradesResponse.data);
            // Verificar si data es un array o un objeto con data dentro
            if (Array.isArray(tradesResponse.data)) {
                console.log(`üìã data es array con ${tradesResponse.data.length} elementos`);
                mexcTrades = tradesResponse.data;
            } else if (tradesResponse.data.data) {
                console.log(`üìã data.data existe:`, tradesResponse.data.data);
                mexcTrades = tradesResponse.data.data;
            } else if (tradesResponse.data.resultList) {
                console.log(`üìã data.resultList existe:`, tradesResponse.data.resultList);
                mexcTrades = tradesResponse.data.resultList;
            } else {
                console.log(`‚ö†Ô∏è Estructura de data no reconocida:`, Object.keys(tradesResponse.data));
            }
        }

        console.log(`üìä Trades obtenidos: ${mexcTrades.length}`);

        const existingTradeIds = new Set(
            DB.operations
                .filter(op => op.id.startsWith('mexc_'))
                .map(op => op.id)
        );

        let newTradesCount = 0;
        const newOperations = [];

        for (const trade of mexcTrades) {
            console.log('üì¶ Trade MEXC raw:', trade);
            const convertedTrade = convertMEXCTradeToAppFormat(trade, selectedAccount.id);
            console.log('üîÑ Trade convertido:', convertedTrade);

            if (!existingTradeIds.has(convertedTrade.id)) {
                newOperations.push(convertedTrade);
                newTradesCount++;
            }
        }

        console.log(`üÜï Nuevas operaciones a guardar: ${newOperations.length}`);

        if (newOperations.length > 0) {
            try {
                await dexieDB.operations.bulkAdd(newOperations);
                DB.operations.push(...newOperations);
                console.log(`‚úÖ ${newOperations.length} operaciones guardadas en IndexedDB`);
            } catch (bulkError) {
                console.error('‚ùå Error en bulkAdd:', bulkError);
                console.log('üîÑ Intentando guardar operaciones una por una...');
                
                // Intentar guardar una por una para identificar cu√°l falla
                for (const operation of newOperations) {
                    try {
                        await dexieDB.operations.add(operation);
                        DB.operations.push(operation);
                        console.log(`‚úÖ Guardada: ${operation.id}`);
                    } catch (singleError) {
                        console.error(`‚ùå Error guardando ${operation.id}:`, singleError);
                        console.log('üìã Operaci√≥n problem√°tica:', operation);
                    }
                }
            }

            if (currentUser) {
                for (const operation of newOperations) {
                    try {
                        await saveOperationToSupabase(operation);
                    } catch (error) {
                        console.error('Error sincronizando operaci√≥n:', error);
                        addToSyncQueue(operation, 'operation');
                    }
                }
            }

            updateAccountBalances();
            refreshAllViews();

            showSyncNotification(`‚úÖ ${newTradesCount} nuevas operaciones sincronizadas desde MEXC`, 'success');
        } else {
            showSyncNotification('‚ÑπÔ∏è No hay nuevas operaciones para sincronizar', 'info');
        }

        updateMEXCStatus('connected', 'Sincronizaci√≥n completada', false);
        addMEXCSyncHistory(newTradesCount, mexcTrades.length - newTradesCount);

    } catch (error) {
        console.error('Error sincronizando MEXC:', error);
        showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
        updateMEXCStatus('error', 'Error en sincronizaci√≥n', false);
    }
}

// Desconectar MEXC y borrar credenciales
async function disconnectMEXC() {
    try {
        // Confirmar con el usuario
        if (!confirm('¬øEst√°s seguro de que quieres desconectar MEXC y borrar las credenciales guardadas?')) {
            return;
        }

        // Borrar de localStorage
        localStorage.removeItem('mexc_api_key');
        localStorage.removeItem('mexc_secret_key');
        localStorage.removeItem('mexc_account_id');
        
        // Borrar de IndexedDB
        await dexieDB.apiKeys.delete('mexc');

        // Borrar de Supabase si el usuario est√° autenticado
        if (currentUser && DB.apiKeys.mexc?.accountId) {
            try {
                const account = DB.accounts.find(acc => acc.id === DB.apiKeys.mexc.accountId);
                if (account) {
                    account.apiKey = null;
                    account.apiSecret = null;
                    await saveAccountToSupabase(account);
                    console.log('‚úÖ Credenciales MEXC borradas de Supabase');
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Error borrando credenciales de Supabase:', error);
            }
        }

        // Limpiar de memoria
        DB.apiKeys.mexc = {};
        mexcAPI = null;

        // Limpiar campos del formulario
        const apiKeyInput = document.getElementById('mexc-api-key-detail');
        const secretKeyInput = document.getElementById('mexc-secret-key-detail');

        if (apiKeyInput) apiKeyInput.value = '';
        if (secretKeyInput) secretKeyInput.value = '';

        // Actualizar estado
        updateMEXCStatus('disconnected', 'Desconectado', false);
        showSyncNotification('‚úÖ MEXC desconectado. Credenciales borradas.', 'success');

        console.log('‚úÖ MEXC desconectado y credenciales borradas');
    } catch (error) {
        console.error('Error desconectando MEXC:', error);
        showSyncNotification(`‚ùå Error al desconectar: ${error.message}`, 'error');
    }
}

// Convertir trade de MEXC al formato de la aplicaci√≥n
function convertMEXCTradeToAppFormat(mexcTrade, accountId) {
    // MEXC Futures usa estos campos
    const orderId = mexcTrade.orderId || mexcTrade.id;
    const price = parseFloat(mexcTrade.dealAvgPrice || mexcTrade.price || 0);
    const qty = parseFloat(mexcTrade.dealVol || mexcTrade.vol || 0);
    const commission = parseFloat(mexcTrade.totalFee || mexcTrade.takerFee || mexcTrade.makerFee || 0);
    const profit = parseFloat(mexcTrade.profit || 0);
    
    // side: 1=open long, 2=close short, 3=open short, 4=close long
    const side = mexcTrade.side;
    const isLong = side === 1 || side === 4;
    const type = isLong ? 'buy' : 'sell';
    
    // Calcular P/L
    const pnl = profit - commission;
    const result = pnl > 0 ? 'win' : (pnl < 0 ? 'loss' : 'breakeven');

    // Convertir timestamp a fecha
    const tradeDateObj = new Date(parseInt(mexcTrade.createTime || mexcTrade.updateTime));
    const tradeDate = getLocalDateString(tradeDateObj);
    const tradeTime = tradeDateObj.toTimeString().split(' ')[0];

    return {
        id: `mexc_${orderId}`,
        date: tradeDate,
        accountId: accountId,
        instrument: mexcTrade.symbol || '',
        type: type,
        entry: price,
        exit: price,
        entryTime: tradeTime,
        exitTime: tradeTime,
        volume: qty,
        result: result,
        pl: pnl,
        manualPL: pnl,
        fees: commission,
        currency: mexcTrade.feeCurrency || 'USDT',
        session: 'MEXC',
        notes: `Trade ID: ${orderId} | Leverage: ${mexcTrade.leverage || 1}x | Side: ${side}`,
        images: []
    };
}

// Actualizar indicadores de estado de MEXC
function updateMEXCStatus(status, message, showProgress = false) {
    const statusIndicator = document.getElementById('mexc-status-indicator');
    const connectionStatus = document.getElementById('mexc-connection-status');
    const progressBar = document.getElementById('mexc-progress-bar');

    if (statusIndicator) {
        statusIndicator.className = '';
        if (status === 'connected') {
            statusIndicator.className = 'text-green-400';
            statusIndicator.textContent = 'Conectado';
        } else if (status === 'syncing' || status === 'connecting') {
            statusIndicator.className = 'text-blue-400';
            statusIndicator.textContent = message;
        } else if (status === 'error') {
            statusIndicator.className = 'text-red-400';
            statusIndicator.textContent = 'Error';
        } else {
            statusIndicator.className = 'text-yellow-400';
            statusIndicator.textContent = 'No conectado';
        }
    }

    if (progressBar) {
        if (showProgress) {
            progressBar.style.width = '100%';
            progressBar.classList.add('animate-pulse');
        } else {
            progressBar.style.width = '0%';
            progressBar.classList.remove('animate-pulse');
        }
    }

    if (connectionStatus) {
        connectionStatus.className = 'p-4 border rounded-md mb-4';

        if (status === 'connected') {
            connectionStatus.className += ' bg-green-800 border-green-600';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-300 text-xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-green-100">Conectado</p>
                        <p class="text-sm text-green-200 mt-1">${message}</p>
                    </div>
                </div>
            `;
        } else if (status === 'error') {
            connectionStatus.className += ' bg-red-800 border-red-600';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-times-circle text-red-300 text-xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-red-100">Error</p>
                        <p class="text-sm text-red-200 mt-1">${message}</p>
                    </div>
                </div>
            `;
        } else {
            connectionStatus.className += ' bg-yellow-800 border-yellow-600';
            connectionStatus.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-300 text-xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-yellow-100">${status === 'syncing' ? 'Sincronizando' : 'No conectado'}</p>
                        <p class="text-sm text-yellow-200 mt-1">${message}</p>
                    </div>
                </div>
            `;
        }
    }

    const lastSync = document.getElementById('mexc-last-sync');
    if (lastSync && status === 'connected') {
        const now = new Date();
        lastSync.textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }
}

// Agregar entrada al historial de sincronizaci√≥n de MEXC
function addMEXCSyncHistory(newTrades, skippedTrades) {
    const historyContainer = document.getElementById('mexc-import-history');
    if (!historyContainer) return;

    if (historyContainer.querySelector('.text-center')) {
        historyContainer.innerHTML = '';
    }

    const now = new Date();
    const historyEntry = document.createElement('div');
    historyEntry.className = 'p-3 bg-surface-light rounded-md text-sm';
    historyEntry.innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <i class="fas fa-sync-alt text-green-400 mr-2"></i>
                <span class="font-semibold text-green-400">${newTrades} nuevas</span>
                <span class="text-text-secondary mx-2">|</span>
                <span class="text-text-secondary">${skippedTrades} existentes</span>
            </div>
            <span class="text-text-secondary text-xs">${now.toLocaleString()}</span>
        </div>
    `;

    historyContainer.insertBefore(historyEntry, historyContainer.firstChild);

    const entries = historyContainer.querySelectorAll('.p-3');
    if (entries.length > 10) {
        entries[entries.length - 1].remove();
    }
}

// Cargar credenciales guardadas de MEXC
async function loadMEXCCredentials() {
    try {
        console.log('üîç Cargando credenciales MEXC...');
        
        let apiKey = null;
        let secretKey = null;
        let accountId = null;
        
        // Prioridad 1: Supabase (si hay usuario autenticado)
        if (currentUser) {
            const supabaseCredentials = await loadMEXCCredentialsFromSupabase();
            if (supabaseCredentials) {
                apiKey = supabaseCredentials.apiKey;
                secretKey = supabaseCredentials.secretKey;
                accountId = supabaseCredentials.accountId;
                console.log('‚úÖ Credenciales MEXC cargadas desde Supabase');
            }
        }
        
        // Prioridad 2: localStorage (m√°s r√°pido para usuarios no autenticados)
        if (!apiKey || !secretKey) {
            apiKey = localStorage.getItem('mexc_api_key');
            secretKey = localStorage.getItem('mexc_secret_key');
            accountId = localStorage.getItem('mexc_account_id');
            if (apiKey && secretKey) {
                console.log('‚úÖ Credenciales MEXC cargadas desde localStorage');
            }
        }
        
        // Prioridad 3: IndexedDB
        if (!apiKey || !secretKey) {
            if (dexieDB && dexieDB.apiKeys) {
                const savedKeys = await dexieDB.apiKeys.get('mexc');
                if (savedKeys) {
                    apiKey = savedKeys.key;
                    secretKey = savedKeys.secret;
                    accountId = savedKeys.accountId;
                    console.log('‚úÖ Credenciales MEXC cargadas desde IndexedDB');
                }
            }
        }
        
        // Si encontramos credenciales, cargarlas en los campos
        if (apiKey && secretKey) {
            const apiKeyDetail = document.getElementById('mexc-api-key-detail');
            const secretKeyDetail = document.getElementById('mexc-secret-key-detail');
            const accountSelect = document.getElementById('mexc-account-detail');

            if (apiKeyDetail) apiKeyDetail.value = apiKey;
            if (secretKeyDetail) secretKeyDetail.value = secretKey;
            if (accountSelect && accountId) accountSelect.value = accountId;

            // Inicializar API
            mexcAPI = new MEXCAPI(apiKey, secretKey);
            DB.apiKeys.mexc = {
                id: 'mexc',
                key: apiKey,
                secret: secretKey,
                accountId: accountId,
                platform: 'mexc'
            };
            
            updateMEXCStatus('connected', 'Conectado', false);
            console.log('‚úÖ Credenciales de MEXC cargadas y API inicializada');
        } else {
            console.log('‚ÑπÔ∏è No hay credenciales guardadas de MEXC');
        }
    } catch (error) {
        console.error('‚ùå Error cargando credenciales de MEXC:', error);
    }
}

// Poblar selector de cuentas de MEXC
function populateMEXCAccountSelect() {
    const accountSelect = document.getElementById('mexc-account-detail');
    if (!accountSelect) return;

    accountSelect.innerHTML = '<option value="">Seleccionar cuenta...</option>';

    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} (${account.currency})`;
        accountSelect.appendChild(option);
    });

    // Intentar restaurar la cuenta guardada
    if (DB.apiKeys.mexc && DB.apiKeys.mexc.accountId) {
        accountSelect.value = DB.apiKeys.mexc.accountId;
        console.log('‚úÖ Cuenta MEXC restaurada:', DB.apiKeys.mexc.accountId);
    } else if (DB.accounts.length > 0) {
        // Si no hay cuenta guardada, seleccionar la primera autom√°ticamente
        accountSelect.value = DB.accounts[0].id;
        console.log('‚úÖ Primera cuenta MEXC seleccionada autom√°ticamente:', DB.accounts[0].name);
    }

    console.log('‚úÖ Cuentas cargadas en select de MEXC:', DB.accounts.length);
}

// ============================================
// TRADINGVIEW WEBHOOK FUNCTIONS
// ============================================

function loadTradingViewConfig() {
    console.log('üì• Cargando configuraci√≥n de TradingView');
    
    // Cargar configuraci√≥n guardada si existe
    if (DB.apiKeys.tradingview) {
        const accountSelect = document.getElementById('tradingview-account-select');
        if (accountSelect && DB.apiKeys.tradingview.accountId) {
            accountSelect.value = DB.apiKeys.tradingview.accountId;
            updateTradingViewAccountDisplay(DB.apiKeys.tradingview.accountId);
        }
        
        updateTradingViewStatus('‚úÖ Configurado', 'success');
    } else {
        updateTradingViewStatus('‚ö†Ô∏è No configurado', 'warning');
    }
}

function populateTradingViewAccountSelect() {
    const accountSelect = document.getElementById('tradingview-account-select');
    if (!accountSelect) return;

    accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';

    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} (${account.currency})`;
        accountSelect.appendChild(option);
    });

    // Listener para mostrar el Account ID cuando se selecciona una cuenta
    accountSelect.addEventListener('change', (e) => {
        const accountId = e.target.value;
        if (accountId) {
            updateTradingViewAccountDisplay(accountId);
        } else {
            document.getElementById('tradingview-account-id-section').style.display = 'none';
        }
    });

    // Restaurar cuenta guardada
    if (DB.apiKeys.tradingview && DB.apiKeys.tradingview.accountId) {
        accountSelect.value = DB.apiKeys.tradingview.accountId;
        updateTradingViewAccountDisplay(DB.apiKeys.tradingview.accountId);
    }

    console.log('‚úÖ Cuentas cargadas en select de TradingView:', DB.accounts.length);
}

function updateTradingViewAccountDisplay(accountId) {
    const accountIdSection = document.getElementById('tradingview-account-id-section');
    const accountIdInput = document.getElementById('tradingview-account-id');
    const placeholder = document.getElementById('json-account-id-placeholder');
    
    if (accountId && accountIdSection && accountIdInput) {
        accountIdSection.style.display = 'block';
        accountIdInput.value = accountId;
        
        if (placeholder) {
            placeholder.textContent = accountId;
        }
    }
}

function updateTradingViewStatus(message, type = 'info') {
    const statusElements = [
        document.getElementById('tradingview-status'),
        document.getElementById('tradingview-detail-status')
    ];
    
    const indicator = document.getElementById('tradingview-detail-indicator');
    
    statusElements.forEach(el => {
        if (el) {
            el.textContent = message;
            el.className = type === 'success' ? 'text-positive' : 
                          type === 'error' ? 'text-negative' : 
                          'text-yellow-500';
        }
    });
    
    if (indicator) {
        indicator.className = 'w-4 h-4 rounded-full ' + 
            (type === 'success' ? 'bg-positive' : 
             type === 'error' ? 'bg-negative' : 
             'bg-yellow-500');
    }
}

async function saveTradingViewConfig() {
    try {
        const accountId = document.getElementById('tradingview-account-select').value;
        
        if (!accountId) {
            showSyncNotification('‚ö†Ô∏è Por favor selecciona una cuenta', 'error');
            return;
        }
        
        // Guardar configuraci√≥n
        DB.apiKeys.tradingview = {
            accountId: accountId,
            webhookUrl: 'http://localhost:8003/webhook/tradingview',
            enabled: true,
            lastUpdated: new Date().toISOString()
        };
        
        await saveDB();
        
        updateTradingViewStatus('‚úÖ Configurado', 'success');
        
        // Actualizar estado en tarjeta principal
        const webhookStatus = document.getElementById('tradingview-webhook-status');
        if (webhookStatus) {
            webhookStatus.textContent = `Cuenta: ${DB.accounts.find(a => a.id == accountId)?.name}`;
            webhookStatus.className = 'text-xs text-positive';
        }
        
        showSyncNotification('‚úÖ Configuraci√≥n de TradingView guardada', 'success');
        
    } catch (error) {
        console.error('‚ùå Error guardando configuraci√≥n:', error);
        showSyncNotification('‚ùå Error al guardar configuraci√≥n', 'error');
    }
}

async function testTradingViewWebhook() {
    try {
        const accountId = document.getElementById('tradingview-account-select').value;
        
        if (!accountId) {
            showSyncNotification('‚ö†Ô∏è Por favor selecciona una cuenta primero', 'error');
            return;
        }
        
        updateTradingViewStatus('üîÑ Probando webhook...', 'info');
        
        // Enviar webhook de prueba
        const testData = {
            accountId: accountId,
            symbol: "BTCUSDT",
            action: "buy",
            contracts: 1,
            price: 50000,
            orderType: "market",
            timestamp: new Date().toISOString(),
            orderId: "TEST_" + Date.now(),
            comment: "Test trade from dashboard"
        };
        
        const response = await fetch('http://localhost:8003/webhook/tradingview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Webhook test response:', result);
            
            updateTradingViewStatus('‚úÖ Webhook funcionando', 'success');
            showSyncNotification('‚úÖ Webhook test exitoso! Revisa la consola del servidor', 'success');
            
            // A√±adir al log
            addWebhookToLog(testData, 'success');
        } else {
            throw new Error(`Server responded with ${response.status}`);
        }
        
    } catch (error) {
        console.error('‚ùå Error probando webhook:', error);
        updateTradingViewStatus('‚ùå Error en webhook', 'error');
        
        if (error.message.includes('Failed to fetch')) {
            showSyncNotification('‚ùå No se puede conectar al servidor. Aseg√∫rate de que proxy-server.js est√© corriendo en puerto 8003', 'error');
        } else {
            showSyncNotification('‚ùå Error al probar webhook: ' + error.message, 'error');
        }
        
        addWebhookToLog({ error: error.message }, 'error');
    }
}

function addWebhookToLog(data, status = 'info') {
    const logContainer = document.getElementById('tradingview-webhook-log');
    if (!logContainer) return;
    
    // Si es el primer webhook, limpiar mensaje placeholder
    if (logContainer.querySelector('p.text-center')) {
        logContainer.innerHTML = '';
    }
    
    const entry = document.createElement('div');
    entry.className = 'bg-surface-light p-3 rounded text-xs';
    
    const timestamp = new Date().toLocaleTimeString();
    const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    
    entry.innerHTML = `
        <div class="flex justify-between items-start mb-1">
            <span class="font-bold">${icon} ${timestamp}</span>
            <span class="text-text-secondary">${data.symbol || 'Test'}</span>
        </div>
        <div class="text-text-secondary">
            ${data.action ? `${data.action.toUpperCase()} ${data.contracts} @ $${data.price}` : 
              data.error ? `Error: ${data.error}` : 'Test webhook'}
        </div>
    `;
    
    // A√±adir al inicio del log
    logContainer.insertBefore(entry, logContainer.firstChild);
    
    // Limitar a 10 entradas
    while (logContainer.children.length > 10) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

// ============================================
// TRADOVATE CSV IMPORT FUNCTIONS
// ============================================

let tradovateSelectedFile = null;

function loadTradovateConfig() {
    console.log('üì• Cargando Tradovate');
    updateTradovateStatus('‚úÖ Listo para importar', 'success');
}

// ============================================
// NINJATRADER 8 FUNCTIONS
// ============================================

let ninjatraderAutoSyncInterval = null;

function loadNinjaTraderConfig() {
    console.log('üì• Cargando NinjaTrader');
    updateNinjaTraderStatus('‚ö†Ô∏è No conectado', 'warning');
}

function populateNinjaTraderAccountSelect() {
    const accountSelect = document.getElementById('ninjatrader-account-select');
    if (!accountSelect) return;

    accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';

    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} - $${account.balance.toFixed(2)}`;
        accountSelect.appendChild(option);
    });
}

function updateNinjaTraderStatus(message, type) {
    const statusEl = document.getElementById('ninjatrader-detail-status');
    const indicatorEl = document.getElementById('ninjatrader-detail-indicator');
    
    if (statusEl) statusEl.textContent = message;
    
    if (indicatorEl) {
        indicatorEl.className = 'w-3 h-3 rounded-full mr-3 ' + 
            (type === 'success' ? 'bg-green-500' : 
             type === 'error' ? 'bg-red-500' : 
             'bg-yellow-500');
    }
}

async function testNinjaTraderConnection() {
    const port = document.getElementById('ninjatrader-port').value;
    const host = document.getElementById('ninjatrader-host').value;
    
    try {
        updateNinjaTraderStatus('üîå Conectando...', 'warning');
        
        const response = await fetch(`http://localhost:8003/api/ninjatrader/test?port=${port}&host=${host}`);
        const data = await response.json();
        
        if (data.success && data.connected) {
            updateNinjaTraderStatus('‚úÖ Conectado correctamente', 'success');
            document.getElementById('ninjatrader-version').textContent = data.version || 'NinjaTrader 8';
            document.getElementById('ninjatrader-sync-now').disabled = false;
            showSyncNotification('‚úÖ ' + data.message, 'success');
            return true;
        } else {
            updateNinjaTraderStatus('‚ùå Error de conexi√≥n', 'error');
            showSyncNotification('‚ùå ' + (data.message || data.error), 'error');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error testing NinjaTrader:', error);
        updateNinjaTraderStatus('‚ùå Error de conexi√≥n', 'error');
        showSyncNotification('‚ùå Error: ' + error.message, 'error');
        return false;
    }
}

async function syncNinjaTraderNow() {
    const accountSelect = document.getElementById('ninjatrader-account-select');
    const accountId = accountSelect ? accountSelect.value : null;
    
    if (!accountId) {
        showSyncNotification('‚ùå Por favor selecciona una cuenta', 'error');
        return;
    }
    
    const account = DB.accounts.find(a => a.id === parseInt(accountId));
    if (!account) {
        showSyncNotification('‚ùå Cuenta no encontrada', 'error');
        return;
    }
    
    const port = document.getElementById('ninjatrader-port').value;
    const host = document.getElementById('ninjatrader-host').value;
    
    try {
        updateNinjaTraderStatus('üìä Sincronizando...', 'warning');
        
        const response = await fetch(`http://localhost:8003/api/ninjatrader/trades?port=${port}&host=${host}&account=Sim101`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error desconocido');
        }
        
        console.log('üì• Trades recibidos de NinjaTrader:', data.trades);
        
        // Process and import trades
        let importedCount = 0;
        let totalPnL = 0;
        
        const tradesGrouped = groupNinjaTraderTrades(data.trades);
        
        for (const trade of tradesGrouped) {
            const newTrade = {
                id: Date.now() + Math.random(),
                accountId: parseInt(accountId),
                platform: 'NinjaTrader',
                symbol: trade.instrument,
                side: trade.side,
                quantity: trade.quantity,
                entryPrice: trade.entryPrice,
                exitPrice: trade.exitPrice,
                entryTime: trade.entryTime,
                exitTime: trade.exitTime,
                pnl: trade.pnl,
                status: 'closed',
                orderType: 'market',
                notes: `Importado desde NinjaTrader - Order ID: ${trade.orderId}`,
                createdAt: new Date().toISOString()
            };
            
            DB.trades.push(newTrade);
            totalPnL += trade.pnl;
            importedCount++;
        }
        
        // Update account balance
        account.balance += totalPnL;
        
        // Save to Dexie
        if (typeof dexieDB !== 'undefined') {
            await dexieDB.accounts.put(account);
        }
        
        // Show results
        document.getElementById('ninjatrader-sync-results').classList.remove('hidden');
        document.getElementById('ninjatrader-imported-count').textContent = importedCount;
        document.getElementById('ninjatrader-final-balance').textContent = formatCurrency(account.balance, account.currency);
        document.getElementById('ninjatrader-total-pnl').textContent = formatCurrency(totalPnL, account.currency);
        
        updateNinjaTraderStatus('‚úÖ Sincronizado correctamente', 'success');
        showSyncNotification(`‚úÖ ${importedCount} trades importados correctamente`, 'success');
        
        // Update last sync time
        document.getElementById('ninjatrader-last-auto-sync').textContent = new Date().toLocaleTimeString();
        
    } catch (error) {
        console.error('‚ùå Error syncing NinjaTrader:', error);
        updateNinjaTraderStatus('‚ùå Error de sincronizaci√≥n', 'error');
        showSyncNotification('‚ùå Error: ' + error.message, 'error');
    }
}

function groupNinjaTraderTrades(executions) {
    // Group executions into complete trades (entry + exit)
    const trades = [];
    const openPositions = {};
    
    executions.forEach(exec => {
        const key = exec.instrument;
        
        if (exec.action === 'BUY') {
            if (!openPositions[key]) {
                openPositions[key] = {
                    instrument: exec.instrument,
                    side: 'LONG',
                    quantity: exec.quantity,
                    entryPrice: exec.price,
                    entryTime: exec.time,
                    orderId: exec.orderId
                };
            }
        } else if (exec.action === 'SELL' && openPositions[key]) {
            // Complete the trade
            const position = openPositions[key];
            const pnl = (exec.price - position.entryPrice) * position.quantity;
            
            trades.push({
                instrument: position.instrument,
                side: position.side,
                quantity: position.quantity,
                entryPrice: position.entryPrice,
                exitPrice: exec.price,
                entryTime: position.entryTime,
                exitTime: exec.time,
                pnl: pnl,
                orderId: position.orderId
            });
            
            delete openPositions[key];
        }
    });
    
    return trades;
}

function toggleNinjaTraderAutoSync(enabled) {
    if (enabled) {
        // Start auto-sync
        document.getElementById('ninjatrader-auto-sync-status').classList.remove('hidden');
        
        ninjatraderAutoSyncInterval = setInterval(() => {
            syncNinjaTraderNow();
            
            // Update countdown
            let countdown = 30;
            const countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('ninjatrader-next-sync').textContent = countdown + 's';
                if (countdown <= 0) clearInterval(countdownInterval);
            }, 1000);
        }, 30000); // Every 30 seconds
        
        showSyncNotification('‚úÖ Auto-Sync activado - sincronizando cada 30 segundos', 'success');
    } else {
        // Stop auto-sync
        if (ninjatraderAutoSyncInterval) {
            clearInterval(ninjatraderAutoSyncInterval);
            ninjatraderAutoSyncInterval = null;
        }
        
        document.getElementById('ninjatrader-auto-sync-status').classList.add('hidden');
        showSyncNotification('‚è∏Ô∏è Auto-Sync desactivado', 'info');
    }
}

function populateTradovateAccountSelect() {
    const accountSelect = document.getElementById('tradovate-account-select');
    if (!accountSelect) return;

    accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';

    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} - $${account.balance.toFixed(2)}`;
        accountSelect.appendChild(option);
    });
}

function updateTradovateStatus(message, type) {
    const statusEl = document.getElementById('tradovate-detail-status');
    const indicatorEl = document.getElementById('tradovate-detail-indicator');
    
    if (statusEl) statusEl.textContent = message;
    
    if (indicatorEl) {
        indicatorEl.className = 'w-3 h-3 rounded-full mr-3 ' + 
            (type === 'success' ? 'bg-green-500' : 
             type === 'error' ? 'bg-red-500' : 
             'bg-yellow-500');
    }
}



async function parseTradovateCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) {
        throw new Error('El archivo CSV est√° vac√≠o o no tiene datos');
    }
    
    const headers = lines[0].split(',').map(h => h.trim());
    const trades = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        
        if (values.length < headers.length) continue; // Skip empty lines
        
        const trade = {};
        headers.forEach((header, index) => {
            trade[header] = values[index] ? values[index].trim() : '';
        });
        
        // Parsear trade
        const parsedTrade = {
            symbol: trade.symbol || '',
            side: trade.buyPrice && trade.sellPrice ? 
                  (parseFloat(trade.sellPrice) > parseFloat(trade.buyPrice) ? 'LONG' : 'SHORT') : 'LONG',
            quantity: parseInt(trade.qty) || 1,
            entryPrice: parseFloat(trade.buyPrice) || 0,
            exitPrice: parseFloat(trade.sellPrice) || 0,
            pnl: parsePnL(trade.pnl),
            entryTime: parseDate(trade.boughtTimestamp),
            exitTime: parseDate(trade.soldTimestamp),
            duration: trade.duration || '',
            orderType: 'market',
            status: 'closed',
            platform: 'Tradovate',
            notes: `Importado desde CSV - ${trade.duration || ''}`
        };
        
        trades.push(parsedTrade);
    }
    
    return trades;
}

function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current);
    return values;
}

function parsePnL(pnlString) {
    if (!pnlString) return 0;
    // Remove $, commas, and parse
    return parseFloat(pnlString.replace(/[$,]/g, '')) || 0;
}

function parseDate(dateString) {
    if (!dateString) return new Date().toISOString();
    
    try {
        // Format: 12/08/2025 18:34:15
        const [datePart, timePart] = dateString.split(' ');
        const [month, day, year] = datePart.split('/');
        const [hours, minutes, seconds] = timePart.split(':');
        
        const date = new Date(year, month - 1, day, hours, minutes, seconds);
        return date.toISOString();
    } catch (e) {
        return new Date().toISOString();
    }
}

async function importTradovateCSV() {
    if (!tradovateSelectedFile) {
        showSyncNotification('‚ùå Por favor selecciona un archivo CSV', 'error');
        return;
    }
    
    console.log('üöÄ Iniciando importaci√≥n de Tradovate desde vista detallada...');
    
    try {
        // Show progress
        const progressDiv = document.getElementById('tradovate-import-progress');
        const resultsDiv = document.getElementById('tradovate-import-results');
        const importBtn = document.getElementById('tradovate-import-btn');
        
        if (progressDiv) progressDiv.classList.remove('hidden');
        if (resultsDiv) resultsDiv.classList.add('hidden');
        if (importBtn) importBtn.disabled = true;
        
        updateImportProgress(10, 'Leyendo archivo...');
        
        // Read file
        const csvText = await readFileAsText(tradovateSelectedFile);
        
        console.log(`‚úÖ Archivo le√≠do: ${csvText.length} caracteres`);
        
        // Detectar si es Position History de Tradovate
        if (!csvText.includes('Position ID') || !csvText.includes('Buy Price') || !csvText.includes('Sell Price')) {
            throw new Error('Este archivo no parece ser un Position History de Tradovate');
        }
        
        updateImportProgress(30, 'Parseando trades de Tradovate...');
        
        // Crear importador de Tradovate si no existe
        if (!window.tradovateFileSync) {
            window.tradovateFileSync = new window.NinjaTraderFileSync();
        }
        
        // Parsear CSV
        const trades = window.tradovateFileSync.parseCSV(csvText);
        
        if (!trades || trades.length === 0) {
            throw new Error('No se encontraron trades en el archivo CSV');
        }
        
        console.log(`üìä Trades parseados: ${trades.length}`);
        
        // Calcular balance por cuenta
        const accountBalances = new Map();
        const accountNames = new Set();
        
        trades.forEach(trade => {
            const accountName = trade.account_id;
            accountNames.add(accountName);
            if (!accountBalances.has(accountName)) {
                accountBalances.set(accountName, 0);
            }
            accountBalances.set(accountName, accountBalances.get(accountName) + (trade.pnl || 0));
        });
        
        console.log('üí∞ Balances calculados:', Object.fromEntries(accountBalances));
        
        updateImportProgress(50, `Importando ${trades.length} trades a Supabase...`);
        
        // Obtener usuario
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) {
            throw new Error('Usuario no autenticado');
        }
        
        // Crear cuentas autom√°ticamente
        const createdAccounts = new Set();
        let importedCount = 0;
        
        for (let i = 0; i < trades.length; i++) {
            const trade = trades[i];
            const accountName = trade.account_id;
            
            // Crear cuenta solo la primera vez
            if (!createdAccounts.has(accountName)) {
                const balance = accountBalances.get(accountName) || 0;
                
                console.log(`üè¶ Creando/verificando cuenta: ${accountName} con balance: $${balance}`);
                
                await window.tradovateFileSync.ensureAccountExists(
                    user.id,
                    accountName,
                    trade.platform,
                    balance
                );
                
                createdAccounts.add(accountName);
            }
            
            // Importar trade
            await window.tradovateFileSync.importTrade(trade);
            importedCount++;
            
            // Update progress
            const progress = 50 + (importedCount / trades.length) * 40;
            updateImportProgress(progress, `Importando trade ${importedCount}/${trades.length}...`);
        }
        
        updateImportProgress(95, 'Recargando datos...');
        
        // Recargar cuentas y operaciones
        if (typeof loadAccountsFromSupabase === 'function') {
            await loadAccountsFromSupabase();
        }
        
        if (typeof loadOperationsFromSupabase === 'function') {
            await loadOperationsFromSupabase();
        }
        
        updateImportProgress(100, 'Completado!');
        
        // Show results
        const totalBalance = Array.from(accountBalances.values()).reduce((sum, bal) => sum + bal, 0);
        
        if (progressDiv) progressDiv.classList.add('hidden');
        if (resultsDiv) {
            resultsDiv.classList.remove('hidden');
            document.getElementById('tradovate-imported-count').textContent = importedCount;
            document.getElementById('tradovate-final-balance').textContent = formatCurrency(totalBalance, 'USD');
        }
        
        showSyncNotification(`‚úÖ ${importedCount} trades importados. ${createdAccounts.size} cuenta(s) creada(s)`, 'success');
        
        console.log(`‚úÖ Importaci√≥n completada: ${importedCount} trades, ${createdAccounts.size} cuenta(s)`);
        
        // Clear file
        tradovateSelectedFile = null;
        document.getElementById('tradovate-csv-input').value = '';
        document.getElementById('tradovate-file-info').classList.add('hidden');
        
        if (importBtn) {
            importBtn.disabled = true;
        }
        
        // Refresh dashboard
        if (typeof refreshDashboard === 'function') {
            setTimeout(refreshDashboard, 500);
        }
        
        
    } catch (error) {
        console.error('‚ùå Error importando CSV:', error);
        showSyncNotification('‚ùå Error al importar: ' + error.message, 'error');
        
        const progressDiv = document.getElementById('tradovate-import-progress');
        const importBtn = document.getElementById('tradovate-import-btn');
        
        if (progressDiv) progressDiv.classList.add('hidden');
        if (importBtn) importBtn.disabled = false;
    }
}

function updateImportProgress(percent, text) {
    const progressBar = document.getElementById('tradovate-progress-bar-import');
    const progressText = document.getElementById('tradovate-progress-text');
    
    if (progressBar) progressBar.style.width = percent + '%';
    if (progressText) progressText.textContent = Math.round(percent) + '%';
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(new Error('Error leyendo archivo'));
        reader.readAsText(file);
    });
}

// Event Listeners para TradingView
document.addEventListener('DOMContentLoaded', () => {
    // Bot√≥n copiar webhook URL
    const copyWebhookBtn = document.getElementById('copy-webhook-url');
    if (copyWebhookBtn) {
        copyWebhookBtn.addEventListener('click', () => {
            const url = document.getElementById('tradingview-webhook-url').value;
            navigator.clipboard.writeText(url).then(() => {
                showSyncNotification('‚úÖ URL del webhook copiada', 'success');
            });
        });
    }
    
    // Bot√≥n copiar Account ID
    const copyAccountIdBtn = document.getElementById('copy-account-id');
    if (copyAccountIdBtn) {
        copyAccountIdBtn.addEventListener('click', () => {
            const accountId = document.getElementById('tradingview-account-id').value;
            navigator.clipboard.writeText(accountId).then(() => {
                showSyncNotification('‚úÖ Account ID copiado', 'success');
            });
        });
    }
    
    // Bot√≥n test webhook
    const testWebhookBtn = document.getElementById('tradingview-test-webhook');
    if (testWebhookBtn) {
        testWebhookBtn.addEventListener('click', testTradingViewWebhook);
    }
    
    // Bot√≥n guardar configuraci√≥n
    const saveConfigBtn = document.getElementById('tradingview-save-config');
    if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', saveTradingViewConfig);
    }
    
    // Bot√≥n volver
    const backBtn = document.getElementById('back-to-platforms-tradingview');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            showSection('platforms');
        });
    }
    
    // ============================================
    // NINJATRADER FUNCTIONS
    // ============================================
    
    let ninjaSync = null;
    let ninjaCSVImporter = null;

    window.importNinjaTraderCSV = function() {
        // Crear input file
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const csvText = await file.text();
                
                // Crear modal de progreso
                const modal = createNinjaImportModal();
                document.body.appendChild(modal);

                // Crear importador si no existe
                if (!ninjaCSVImporter) {
                    ninjaCSVImporter = new window.NinjaTraderCSVImporter();
                }

                // Importar
                const result = await ninjaCSVImporter.import(csvText, (progress) => {
                    updateNinjaImportProgress(progress);
                });

                if (result.success) {
                    showNinjaImportResults(result);
                    
                    // Recargar operaciones desde Supabase
                    console.log('üîÑ Recargando operaciones despu√©s de importar...');
                    
                    setTimeout(async () => {
                        if (typeof loadOperationsFromSupabase === 'function') {
                            await loadOperationsFromSupabase();
                        }
                        
                        if (typeof refreshDashboard === 'function') {
                            refreshDashboard();
                        }
                    }, 500);
                }

            } catch (error) {
                console.error('Error importando CSV:', error);
                alert('Error: ' + error.message);
            }
        };

        input.click();
    }

    window.createNinjaImportModal = function() {
        const modal = document.createElement('div');
        modal.id = 'ninja-import-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0,0,0,0.95)';
        
        modal.innerHTML = `
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-8 w-full max-w-2xl">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center">
                            <i class="fas fa-file-csv text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Importar CSV de NinjaTrader</h2>
                    </div>
                </div>

                <div id="ninja-import-progress" class="text-center py-8">
                    <div class="inline-block">
                        <i class="fas fa-spinner fa-spin text-primary text-5xl mb-4"></i>
                    </div>
                    <h3 id="ninja-import-title" class="text-xl font-semibold mb-2">Procesando...</h3>
                    <p id="ninja-import-message" class="text-text-secondary mb-4">Iniciando...</p>
                    
                    <div class="bg-surface-light rounded-full h-3 w-full max-w-md mx-auto overflow-hidden mb-2">
                        <div id="ninja-import-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <p id="ninja-import-stats" class="text-sm text-text-secondary">0 / 0</p>
                </div>

                <div id="ninja-import-results" class="hidden text-center py-6">
                    <div class="inline-block w-20 h-20 rounded-full bg-primary bg-opacity-20 flex items-center justify-center mb-4">
                        <i class="fas fa-check text-primary text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">¬°Importaci√≥n Completada!</h3>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto my-6">
                        <div class="bg-surface-light rounded-lg p-4">
                            <div class="text-3xl font-bold text-primary" id="ninja-import-result-trades">0</div>
                            <div class="text-sm text-text-secondary">Trades Importados</div>
                        </div>
                        <div class="bg-surface-light rounded-lg p-4">
                            <div class="text-3xl font-bold text-accent" id="ninja-import-result-accounts">0</div>
                            <div class="text-sm text-text-secondary">Cuentas Detectadas</div>
                        </div>
                    </div>

                    <div id="ninja-import-accounts-list" class="text-left bg-surface-light rounded-lg p-4 max-w-md mx-auto mb-4">
                        <!-- Se llenar√° din√°micamente -->
                    </div>

                    <button id="ninja-import-close-btn" class="btn-primary">
                        <i class="fas fa-check mr-2"></i>Cerrar
                    </button>
                </div>
            </div>
        `;

        // Event listener para cerrar
        setTimeout(() => {
            const closeBtn = document.getElementById('ninja-import-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.remove());
            }
        }, 100);

        return modal;
    }

    window.updateNinjaImportProgress = function(progress) {
        const title = document.getElementById('ninja-import-title');
        const message = document.getElementById('ninja-import-message');
        const progressBar = document.getElementById('ninja-import-bar');
        const stats = document.getElementById('ninja-import-stats');
        
        if (title) title.textContent = progress.message || 'Procesando...';
        if (message) message.textContent = progress.status || '';
        
        if (progress.current && progress.total) {
            const percentage = (progress.current / progress.total) * 100;
            if (progressBar) progressBar.style.width = percentage + '%';
            if (stats) stats.textContent = `${progress.current} / ${progress.total}`;
        }
    }

    window.showNinjaImportResults = function(result) {
        document.getElementById('ninja-import-progress').style.display = 'none';
        document.getElementById('ninja-import-results').classList.remove('hidden');
        
        document.getElementById('ninja-import-result-trades').textContent = result.imported || 0;
        document.getElementById('ninja-import-result-accounts').textContent = result.accounts?.length || 0;
        
        const accountsList = document.getElementById('ninja-import-accounts-list');
        if (accountsList && result.accounts) {
            accountsList.innerHTML = `
                <div class="text-sm font-semibold mb-2">Cuentas detectadas:</div>
                ${result.accounts.map(account => `
                    <div class="flex items-center gap-2 py-1">
                        <i class="fas fa-check-circle text-primary text-xs"></i>
                        <span class="text-sm">${account}</span>
                    </div>
                `).join('')}
            `;
        }

        // Mostrar notificaci√≥n
        if (typeof showToast === 'function') {
            showToast('Importaci√≥n completada', `${result.imported} trades importados`, 'success');
        }

        // Actualizar indicadores
        const statusIndicator = document.getElementById('ninjatrader-status-indicator');
        if (statusIndicator) {
            statusIndicator.textContent = 'Conectado';
            statusIndicator.className = 'text-primary';
        }

        const lastSync = document.getElementById('ninjatrader-last-sync');
        if (lastSync) {
            lastSync.textContent = 'Hace unos segundos';
        }
    }

    window.showNinjaTraderSyncModal = function() {
        // Verificar soporte del navegador
        if (!window.NinjaTraderFileSync || !window.NinjaTraderFileSync.isSupported()) {
            alert('Tu navegador no soporta esta funci√≥n.\n\nPor favor usa Chrome o Edge (versi√≥n reciente).');
            return;
        }

        // Crear instancia si no existe
        if (!ninjaSync) {
            ninjaSync = new window.NinjaTraderFileSync();
        }

        const modal = document.createElement('div');
        modal.id = 'ninja-sync-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0,0,0,0.95)';
        
        modal.innerHTML = `
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-8 w-full max-w-2xl">
                <button id="close-ninja-sync-modal" class="absolute top-4 right-4 p-2 rounded-full hover:bg-surface-light">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-12 h-12 rounded-lg bg-orange-600 flex items-center justify-center">
                            <i class="fas fa-sync-alt text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Sincronizar NinjaTrader</h2>
                    </div>
                    <p class="text-text-secondary">Importa tus trades autom√°ticamente desde los archivos de NinjaTrader</p>
                </div>

                <div id="ninja-sync-content">
                    <!-- Paso 1: Seleccionar carpeta -->
                    <div id="ninja-step-select" class="step-content">
                        <div class="bg-surface-light border border-border rounded-lg p-6 mb-4">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-primary text-background flex items-center justify-center font-bold text-xl flex-shrink-0">
                                    1
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold mb-2">Selecciona la carpeta de NinjaTrader</h3>
                                    <p class="text-sm text-text-secondary mb-4">
                                        Normalmente est√° en:<br>
                                        <code class="text-xs bg-background px-2 py-1 rounded">C:\\\\Users\\\\TuUsuario\\\\Documents\\\\NinjaTrader 8\\\\db\\\\execution</code>
                                    </p>
                                    <button id="ninja-select-folder-btn" class="btn-primary">
                                        <i class="fas fa-folder-open mr-2"></i>Seleccionar Carpeta
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-primary bg-opacity-10 border border-primary rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-primary mt-1"></i>
                                <div class="text-sm">
                                    <p class="font-semibold text-primary mb-1">Primera vez solamente</p>
                                    <p class="text-text-secondary">Solo necesitas hacer esto una vez. Despu√©s podr√°s sincronizar con un solo click.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 2: Progreso -->
                    <div id="ninja-step-progress" class="step-content" style="display: none;">
                        <div class="text-center py-8">
                            <div class="inline-block">
                                <i class="fas fa-sync-alt fa-spin text-primary text-5xl mb-4"></i>
                            </div>
                            <h3 id="ninja-progress-title" class="text-xl font-semibold mb-2">Escaneando archivos...</h3>
                            <p id="ninja-progress-message" class="text-text-secondary mb-4">Iniciando...</p>
                            
                            <div class="bg-surface-light rounded-full h-3 w-full max-w-md mx-auto overflow-hidden mb-2">
                                <div id="ninja-progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                            </div>
                            
                            <p id="ninja-progress-stats" class="text-sm text-text-secondary">0 / 0</p>
                        </div>
                    </div>

                    <!-- Paso 3: Resultados -->
                    <div id="ninja-step-results" class="step-content" style="display: none;">
                        <div class="text-center py-6">
                            <div class="inline-block w-20 h-20 rounded-full bg-primary bg-opacity-20 flex items-center justify-center mb-4">
                                <i class="fas fa-check text-primary text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">¬°Sincronizaci√≥n Completada!</h3>
                            
                            <div class="grid grid-cols-2 gap-4 max-w-md mx-auto my-6">
                                <div class="bg-surface-light rounded-lg p-4">
                                    <div class="text-3xl font-bold text-primary" id="ninja-result-trades">0</div>
                                    <div class="text-sm text-text-secondary">Trades Importados</div>
                                </div>
                                <div class="bg-surface-light rounded-lg p-4">
                                    <div class="text-3xl font-bold text-accent" id="ninja-result-accounts">0</div>
                                    <div class="text-sm text-text-secondary">Cuentas Detectadas</div>
                                </div>
                            </div>

                            <div id="ninja-accounts-list" class="text-left bg-surface-light rounded-lg p-4 max-w-md mx-auto mb-4">
                                <!-- Se llenar√° din√°micamente -->
                            </div>

                            <button id="ninja-view-operations-btn" class="btn-primary">
                                <i class="fas fa-chart-line mr-2"></i>Ver Operaciones
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Event Listeners
        document.getElementById('close-ninja-sync-modal').addEventListener('click', () => {
            modal.remove();
        });
        
        document.getElementById('ninja-select-folder-btn').addEventListener('click', async () => {
            try {
                const folderHandle = await ninjaSync.selectFolder();
                
                if (folderHandle) {
                    // Iniciar sincronizaci√≥n
                    document.getElementById('ninja-step-select').style.display = 'none';
                    document.getElementById('ninja-step-progress').style.display = 'block';
                    
                    const result = await ninjaSync.sync((progress) => {
                        updateNinjaProgress(progress);
                    });
                    
                    if (result.success) {
                        showNinjaResults(result);
                    }
                }
            } catch (error) {
                console.error('Error en sincronizaci√≥n:', error);
                alert('Error: ' + error.message);
                modal.remove();
            }
        });
        
        document.getElementById('ninja-view-operations-btn')?.addEventListener('click', () => {
            modal.remove();
            // Ir a la secci√≥n de operaciones
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.target === 'operations') {
                    item.click();
                }
            });
        });
    }

    function updateNinjaProgress(progress) {
        const title = document.getElementById('ninja-progress-title');
        const message = document.getElementById('ninja-progress-message');
        const progressBar = document.getElementById('ninja-progress-bar');
        const stats = document.getElementById('ninja-progress-stats');
        
        if (title) title.textContent = progress.message || 'Procesando...';
        if (message) message.textContent = progress.status || '';
        
        if (progress.current && progress.total) {
            const percentage = (progress.current / progress.total) * 100;
            if (progressBar) progressBar.style.width = percentage + '%';
            if (stats) stats.textContent = `${progress.current} / ${progress.total}`;
        }
    }

    function showNinjaResults(result) {
        document.getElementById('ninja-step-progress').style.display = 'none';
        document.getElementById('ninja-step-results').style.display = 'block';
        
        document.getElementById('ninja-result-trades').textContent = result.imported || 0;
        document.getElementById('ninja-result-accounts').textContent = result.accounts?.length || 0;
        
        const accountsList = document.getElementById('ninja-accounts-list');
        if (accountsList && result.accounts) {
            accountsList.innerHTML = `
                <div class="text-sm font-semibold mb-2">Cuentas detectadas:</div>
                ${result.accounts.map(account => `
                    <div class="flex items-center gap-2 py-1">
                        <i class="fas fa-check-circle text-primary text-xs"></i>
                        <span class="text-sm">${account}</span>
                    </div>
                `).join('')}
            `;
        }
        
        // Mostrar notificaci√≥n
        if (typeof showToast === 'function') {
            showToast('Sincronizaci√≥n completada', `${result.imported} trades importados`, 'success');
        }
        
        // Actualizar indicador en la tarjeta
        const statusIndicator = document.getElementById('ninjatrader-status-indicator');
        if (statusIndicator) {
            statusIndicator.textContent = 'Conectado';
            statusIndicator.className = 'text-primary';
        }
        
        const lastSync = document.getElementById('ninjatrader-last-sync');
        if (lastSync) {
            lastSync.textContent = 'Hace unos segundos';
        }
        
        // Actualizar vista detallada si est√° abierta
        const detailStatus = document.getElementById('ninjatrader-detail-status');
        if (detailStatus) {
            detailStatus.textContent = 'Configurado';
        }
        
        const detailIndicator = document.getElementById('ninjatrader-detail-indicator');
        if (detailIndicator) {
            detailIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
        }
        
        const lastSyncDetail = document.getElementById('ninjatrader-last-sync-detail');
        if (lastSyncDetail) {
            lastSyncDetail.textContent = 'Hace unos segundos';
        }
        
        // Mostrar secci√≥n de carpeta configurada
        const folderSelected = document.getElementById('ninja-folder-selected');
        if (folderSelected) {
            folderSelected.classList.remove('hidden');
        }
        
        // Mostrar y actualizar secci√≥n de cuentas
        const accountsSection = document.getElementById('ninja-accounts-section');
        const accountsGrid = document.getElementById('ninja-accounts-grid');
        if (accountsSection && accountsGrid && result.accounts && result.accounts.length > 0) {
            accountsSection.classList.remove('hidden');
            accountsGrid.innerHTML = result.accounts.map(account => `
                <div class="p-3 bg-surface-light rounded-lg border border-border">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-user-circle text-accent"></i>
                        <span class="font-medium text-sm">${account}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Mostrar y actualizar estad√≠sticas
        const statsSection = document.getElementById('ninja-stats-section');
        if (statsSection) {
            statsSection.classList.remove('hidden');
            
            const statTrades = document.getElementById('ninja-stat-trades');
            const statAccounts = document.getElementById('ninja-stat-accounts');
            const statFiles = document.getElementById('ninja-stat-files');
            
            if (statTrades) statTrades.textContent = result.imported || 0;
            if (statAccounts) statAccounts.textContent = result.accounts?.length || 0;
            if (statFiles) statFiles.textContent = result.total || 0;
        }
    }
    
    // ============================================
    // TRADOVATE CSV IMPORT
    // ============================================
    
    let tradovateFileSync = null;

    window.importTradovateCSV = function() {
        console.log('üöÄ Iniciando importaci√≥n CSV de Tradovate...');
        
        // Verificar que NinjaTraderFileSync est√© disponible
        if (!window.NinjaTraderFileSync) {
            console.error('‚ùå NinjaTraderFileSync no est√° disponible');
            alert('Error: Sistema de importaci√≥n no cargado. Recarga la p√°gina.');
            return;
        }
        
        // Crear input file
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) {
                console.log('‚ö†Ô∏è No se seleccion√≥ archivo');
                return;
            }

            console.log(`üìÑ Archivo seleccionado: ${file.name}`);

            try {
                const csvText = await file.text();
                console.log(`‚úÖ Archivo le√≠do: ${csvText.length} caracteres`);
                
                // Detectar si es Position History de Tradovate
                if (!csvText.includes('Position ID') || !csvText.includes('Buy Price') || !csvText.includes('Sell Price')) {
                    console.error('‚ùå Formato incorrecto: No es Position History de Tradovate');
                    alert('‚ö†Ô∏è Este archivo no parece ser un Position History de Tradovate.\\n\\nAseg√∫rate de exportar el archivo "Position History" desde Tradovate.');
                    return;
                }
                
                console.log('‚úÖ Formato detectado: Tradovate Position History');
                
                // Crear modal de progreso
                const modal = createTradovateImportModal();
                document.body.appendChild(modal);

                // Crear importador de Tradovate si no existe
                if (!tradovateFileSync) {
                    console.log('üìù Creando instancia de NinjaTraderFileSync...');
                    tradovateFileSync = new window.NinjaTraderFileSync();
                }

                // Parsear CSV de Tradovate
                updateTradovateImportProgress({ 
                    status: 'parsing', 
                    message: 'Parseando Position History de Tradovate...' 
                });
                
                console.log('üîÑ Parseando CSV...');
                const trades = tradovateFileSync.parseCSV(csvText);
                
                if (!trades || trades.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron trades');
                    alert('‚ö†Ô∏è No se encontraron trades en el archivo CSV');
                    modal.remove();
                    return;
                }

                console.log(`üìä Trades de Tradovate parseados: ${trades.length}`);

                // Calcular balance por cuenta
                const accountBalances = new Map();
                trades.forEach(trade => {
                    const accountName = trade.account_id;
                    if (!accountBalances.has(accountName)) {
                        accountBalances.set(accountName, 0);
                    }
                    accountBalances.set(accountName, accountBalances.get(accountName) + (trade.pnl || 0));
                });

                console.log('üí∞ Balances calculados por cuenta:', Object.fromEntries(accountBalances));

                // Importar trades
                updateTradovateImportProgress({ 
                    status: 'importing', 
                    message: `Importando ${trades.length} trades...`,
                    total: trades.length
                });

                let imported = 0;
                const accounts = new Set();
                const errors = [];
                const createdAccounts = new Set();

                for (let i = 0; i < trades.length; i++) {
                    try {
                        // Crear cuenta con balance solo la primera vez
                        const accountName = trades[i].account_id;
                        if (!createdAccounts.has(accountName)) {
                            const balance = accountBalances.get(accountName) || 0;
                            
                            console.log(`üè¶ Creando cuenta: ${accountName} con balance: $${balance}`);
                            
                            // Obtener usuario
                            const { data: { user } } = await window.supabase.auth.getUser();
                            if (user) {
                                await tradovateFileSync.ensureAccountExists(
                                    user.id, 
                                    accountName, 
                                    trades[i].platform,
                                    balance
                                );
                                createdAccounts.add(accountName);
                            }
                        }
                        
                        await tradovateFileSync.importTrade(trades[i]);
                        imported++;
                        accounts.add(accountName);
                        
                        updateTradovateImportProgress({
                            status: 'importing',
                            current: i + 1,
                            total: trades.length,
                            message: `Importando ${i + 1} de ${trades.length}...`
                        });
                    } catch (error) {
                        console.error(`‚ùå Error importando trade ${i + 1}:`, error);
                        errors.push({ trade: trades[i], error: error.message });
                    }
                }

                const result = {
                    success: true,
                    imported,
                    total: trades.length,
                    accounts: Array.from(accounts),
                    errors
                };

                console.log('‚úÖ Importaci√≥n completada:', result);
                showTradovateImportResults(result);
                
                // Recargar operaciones desde Supabase
                console.log('üîÑ Recargando operaciones despu√©s de importar...');
                
                setTimeout(async () => {
                    if (typeof loadOperationsFromSupabase === 'function') {
                        await loadOperationsFromSupabase();
                    }
                    
                    if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Error importando CSV de Tradovate:', error);
                alert('Error: ' + error.message);
            }
        };

        console.log('üìÇ Abriendo selector de archivos...');
        input.click();
    }

    window.createTradovateImportModal = function() {
        const modal = document.createElement('div');
        modal.id = 'tradovate-import-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.backgroundColor = 'rgba(0,0,0,0.95)';
        
        modal.innerHTML = `
            <div class="relative bg-surface border border-border rounded-lg shadow-lg p-8 w-full max-w-2xl">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center">
                            <i class="fas fa-file-csv text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Importar CSV de Tradovate</h2>
                    </div>
                    <p class="text-text-secondary text-sm">Importando Position History...</p>
                </div>

                <div id="tradovate-import-progress" class="text-center py-8">
                    <div class="inline-block">
                        <i class="fas fa-spinner fa-spin text-primary text-5xl mb-4"></i>
                    </div>
                    <h3 id="tradovate-import-title" class="text-xl font-semibold mb-2">Procesando...</h3>
                    <p id="tradovate-import-message" class="text-text-secondary mb-4">Iniciando...</p>
                    
                    <div class="bg-surface-light rounded-full h-3 w-full max-w-md mx-auto overflow-hidden mb-2">
                        <div id="tradovate-import-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <p id="tradovate-import-stats" class="text-sm text-text-secondary">0 / 0</p>
                </div>

                <div id="tradovate-import-results" class="hidden text-center py-6">
                    <div class="inline-block w-20 h-20 rounded-full bg-primary bg-opacity-20 flex items-center justify-center mb-4">
                        <i class="fas fa-check text-primary text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">¬°Importaci√≥n Completada!</h3>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto my-6">
                        <div class="bg-surface-light rounded-lg p-4">
                            <div class="text-3xl font-bold text-primary" id="tradovate-import-result-trades">0</div>
                            <div class="text-sm text-text-secondary">Trades Importados</div>
                        </div>
                        <div class="bg-surface-light rounded-lg p-4">
                            <div class="text-3xl font-bold text-accent" id="tradovate-import-result-accounts">0</div>
                            <div class="text-sm text-text-secondary">Cuentas Detectadas</div>
                        </div>
                    </div>

                    <div id="tradovate-import-accounts-list" class="text-left bg-surface-light rounded-lg p-4 max-w-md mx-auto mb-4">
                        <!-- Se llenar√° din√°micamente -->
                    </div>

                    <button id="tradovate-import-close-btn" class="btn-primary">
                        <i class="fas fa-check mr-2"></i>Cerrar
                    </button>
                </div>
            </div>
        `;

        // Event listener para cerrar
        setTimeout(() => {
            const closeBtn = document.getElementById('tradovate-import-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.remove());
            }
        }, 100);

        return modal;
    }

    window.updateTradovateImportProgress = function(progress) {
        const title = document.getElementById('tradovate-import-title');
        const message = document.getElementById('tradovate-import-message');
        const progressBar = document.getElementById('tradovate-import-bar');
        const stats = document.getElementById('tradovate-import-stats');
        
        if (title) title.textContent = progress.message || 'Procesando...';
        if (message) message.textContent = progress.status || '';
        
        if (progress.current && progress.total) {
            const percentage = (progress.current / progress.total) * 100;
            if (progressBar) progressBar.style.width = percentage + '%';
            if (stats) stats.textContent = `${progress.current} / ${progress.total}`;
        }
    }

    window.showTradovateImportResults = function(result) {
        document.getElementById('tradovate-import-progress').style.display = 'none';
        document.getElementById('tradovate-import-results').classList.remove('hidden');
        
        document.getElementById('tradovate-import-result-trades').textContent = result.imported || 0;
        document.getElementById('tradovate-import-result-accounts').textContent = result.accounts?.length || 0;
        
        const accountsList = document.getElementById('tradovate-import-accounts-list');
        if (accountsList && result.accounts) {
            accountsList.innerHTML = `
                <div class="text-sm font-semibold mb-2">Cuentas detectadas:</div>
                ${result.accounts.map(account => `
                    <div class="flex items-center gap-2 py-1">
                        <i class="fas fa-check-circle text-primary text-xs"></i>
                        <span class="text-sm">${account}</span>
                    </div>
                `).join('')}
            `;
        }

        // Mostrar notificaci√≥n
        if (typeof showToast === 'function') {
            showToast('Importaci√≥n completada', `${result.imported} trades de Tradovate importados`, 'success');
        }

        // Actualizar indicadores
        const statusIndicator = document.getElementById('tradovate-status-indicator');
        if (statusIndicator) {
            statusIndicator.textContent = 'Conectado';
            statusIndicator.className = 'text-primary';
        }

        const lastSync = document.getElementById('tradovate-last-sync');
        if (lastSync) {
            lastSync.textContent = 'Hace unos segundos';
        }
    }
    
    // ============================================
    // NINJATRADER EVENT LISTENERS
    // ============================================
    
    // Back button
    const backBtnNinjaTrader = document.getElementById('back-to-platforms-ninjatrader');
    if (backBtnNinjaTrader) {
        backBtnNinjaTrader.addEventListener('click', () => {
            showSection('platforms');
        });
    }
    
    // Main sync button in detail view
    const ninjaSyncMainBtn = document.getElementById('ninjatrader-sync-main');
    if (ninjaSyncMainBtn) {
        ninjaSyncMainBtn.addEventListener('click', () => {
            showNinjaTraderSyncModal();
        });
    }
    
    // ============================================
    // TRADOVATE EVENT LISTENERS
    // ============================================
    
    // Back button
    const backBtnTradovate = document.getElementById('back-to-platforms-tradovate');
    if (backBtnTradovate) {
        backBtnTradovate.addEventListener('click', () => {
            showSection('platforms');
        });
    }
    
    // File dropzone click
    const dropzone = document.getElementById('tradovate-csv-dropzone');
    const fileInput = document.getElementById('tradovate-csv-input');
    
    if (dropzone && fileInput) {
        dropzone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selected
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                tradovateSelectedFile = file;
                
                // Show file info
                document.getElementById('tradovate-file-name').textContent = file.name;
                document.getElementById('tradovate-file-size').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('tradovate-file-info').classList.remove('hidden');
                document.getElementById('tradovate-import-btn').disabled = false;
            }
        });
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-primary');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-primary');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-primary');
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                tradovateSelectedFile = file;
                
                // Show file info
                document.getElementById('tradovate-file-name').textContent = file.name;
                document.getElementById('tradovate-file-size').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('tradovate-file-info').classList.remove('hidden');
                document.getElementById('tradovate-import-btn').disabled = false;
            }
        });
    }
    
    // Remove file
    const removeFileBtn = document.getElementById('tradovate-remove-file');
    if (removeFileBtn) {
        removeFileBtn.addEventListener('click', () => {
            tradovateSelectedFile = null;
            document.getElementById('tradovate-csv-input').value = '';
            document.getElementById('tradovate-file-info').classList.add('hidden');
            document.getElementById('tradovate-import-btn').disabled = true;
        });
    }
    
    // Import button
    const importBtn = document.getElementById('tradovate-import-btn');
    if (importBtn) {
        importBtn.addEventListener('click', importTradovateCSV);
    }
});

// ============================================
// FUNCIONES PARA cTrader
// ============================================

// Funci√≥n de importaci√≥n directa - Como MT5
function importCTraderHTML() {
    console.log('üéØ IMPORTACI√ìN DIRECTA CTRADER INICIADA');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.html,.htm';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log('üìÅ Archivo seleccionado:', file.name);

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const htmlContent = e.target.result;
                console.log('üìÑ Contenido le√≠do, parseando...');
                
                await parseCTraderHTMLDirect(htmlContent);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// Parser directo - SIN VISTA PREVIA
async function parseCTraderHTMLDirect(htmlContent) {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üîç PARSEANDO CTRADER HTML STATEMENT');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    
    // Extraer informaci√≥n de la cuenta
    let accountNumber = '';
    let accountCurrency = 'USD';
    
    const allTables = doc.querySelectorAll('table');
    for (const table of allTables) {
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 2) {
                const label = cells[0]?.textContent.trim() || '';
                const value = cells[1]?.textContent.trim() || '';
                
                if (label.toLowerCase().includes('cuenta') || label.toLowerCase().includes('account')) {
                    // Extraer solo n√∫meros del valor
                    const numberMatch = value.match(/\d{7,}/);
                    if (numberMatch) {
                        accountNumber = numberMatch[0];
                        console.log('‚úÖ N√∫mero de cuenta detectado:', accountNumber);
                    }
                }
                if (label.toLowerCase().includes('divisa') || label.toLowerCase().includes('currency')) {
                    accountCurrency = value;
                    console.log('‚úÖ Divisa detectada:', accountCurrency);
                }
            }
        }
    }
    
    // Buscar la tabla de operaciones - M√âTODO MEJORADO
    let historyTable = null;
    
    // Buscar tabla con clase espec√≠fica de cTrader
    for (const table of allTables) {
        // Buscar por strong/th que contenga "Historial"
        const titleCells = table.querySelectorAll('td strong, th strong, td b, th b');
        for (const cell of titleCells) {
            const text = cell.textContent.toLowerCase();
            if (text.includes('historial') || text.includes('history')) {
                historyTable = table;
                console.log('‚úÖ Tabla de historial encontrada por t√≠tulo');
                break;
            }
        }
        if (historyTable) break;
    }
    
    // M√©todo alternativo: buscar por contenido
    if (!historyTable) {
        for (const table of allTables) {
            const text = table.textContent.toLowerCase();
            if ((text.includes('s√≠mbolo') || text.includes('symbol')) && 
                (text.includes('direcci√≥n') || text.includes('side')) &&
                (text.includes('cantidad') || text.includes('volume'))) {
                historyTable = table;
                console.log('‚úÖ Tabla de historial encontrada por contenido');
                break;
            }
        }
    }
    
    if (!historyTable) {
        throw new Error('No se encontr√≥ la tabla de operaciones en el HTML');
    }
    
    console.log('üîç Buscando operaciones en la tabla...');
    
    const allRows = historyTable.querySelectorAll('tr');
    console.log(`üìä Total filas: ${allRows.length}`);
    
    const operations = [];
    
    // Buscar filas que tengan exactamente 9 celdas (formato cTrader)
    const dataRows = Array.from(allRows).filter(row => {
        const cells = row.querySelectorAll('td');
        return cells.length === 9;
    });
    
    console.log(`‚úÖ Filas con 9 celdas encontradas: ${dataRows.length}`);
    
    if (dataRows.length === 0) {
        throw new Error('No se encontraron filas de datos en la tabla');
    }
    
    // Debug: Mostrar primeras 3 filas para confirmar estructura
    for (let i = 0; i < Math.min(3, dataRows.length); i++) {
        const row = dataRows[i];
        const cells = row.querySelectorAll('td');
        const cellTexts = Array.from(cells).map(c => c.textContent.trim());
        console.log(`üîç Fila ${i}:`, cellTexts.join(' | '));
    }
    
    for (const row of dataRows) {
        const cells = row.querySelectorAll('td');
        const cellTexts = Array.from(cells).map(c => c.textContent.trim());
        
        // Saltar fila de header (contiene "S√≠mbolo")
        if (cellTexts.some(c => c.includes('S√≠mbolo') || c.includes('Symbol'))) {
            continue;
        }
        
        // Columna 1: S√≠mbolo (EURUSD, XAUUSD, etc.) - ¬°columna 0 est√° vac√≠a!
        const symbol = cellTexts[1];
        
        // Validar que sea un s√≠mbolo v√°lido
        if (!symbol || symbol.length < 5 || !/^[A-Z0-9]+$/.test(symbol)) {
            continue;
        }
        
        // Columna 2: Direcci√≥n (Sell/Buy)
        const side = cellTexts[2];
        
        // Columna 3: Hora de cierre
        const closeTime = cellTexts[3];
        
        // Columna 4: Precio de entrada
        const entryPrice = parseFloat(cellTexts[4].replace(/,/g, ''));
        
        // Columna 5: Precio de cierre  
        const closePrice = parseFloat(cellTexts[5].replace(/,/g, ''));
        
        // Columna 6: Cantidad (Lotes)
        const volumeText = cellTexts[6].replace(/[^0-9.]/g, '');
        const volume = parseFloat(volumeText);
        
        // Columna 7: USD neto (P&L)
        const plText = cellTexts[7].replace(/,/g, '').replace(/\s/g, '');
        const pl = parseFloat(plText);
        
        // Parsear fecha: "12/11/2025 07:34:53.531"
        let date = '';
        let exitTime = '';
        if (closeTime && closeTime.includes('/')) {
            const parts = closeTime.split(' ');
            if (parts.length >= 2) {
                const dateParts = parts[0].split('/');
                if (dateParts.length === 3) {
                    date = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                }
                const timeParts = parts[1].split(':');
                if (timeParts.length >= 2) {
                    exitTime = `${timeParts[0].padStart(2,'0')}:${timeParts[1].padStart(2,'0')}`;
                }
            }
        }
        
        const type = side.toLowerCase().includes('buy') ? 'buy' : 'sell';
        
        operations.push({
            instrument: symbol,
            type: type,
            date: date,
            entryTime: exitTime,
            exitTime: exitTime,
            entry: entryPrice,
            exit: closePrice,
            volume: volume,
            pl: pl,
            currency: accountCurrency,
            commission: 0,
            notes: `Importado de cTrader - ${side}`
        });
        
        if (operations.length <= 2) {
            console.log(`‚úÖ Op ${operations.length}:`, symbol, type, date, 'P&L:', pl);
        }
    }
    
    console.log(`‚úÖ ${operations.length} operaciones parseadas`);
    
    if (operations.length === 0) {
        throw new Error('No se encontraron operaciones en el archivo');
    }
    
    // BUSCAR O CREAR CUENTA
    let ctraderAccount = null;
    
    // 1. Buscar por n√∫mero de cuenta
    if (accountNumber) {
        ctraderAccount = DB.accounts.find(acc => acc.name.includes(accountNumber));
        if (ctraderAccount) {
            console.log(`‚úÖ Cuenta encontrada por n√∫mero: ${ctraderAccount.name}`);
        }
    }
    
    // 2. Buscar cualquier cuenta cTrader
    if (!ctraderAccount) {
        ctraderAccount = DB.accounts.find(acc => acc.platform === 'ctrader');
        if (ctraderAccount) {
            console.log(`‚úÖ Cuenta cTrader encontrada: ${ctraderAccount.name}`);
        }
    }
    
    // 3. CREAR CUENTA SI NO EXISTE
    if (!ctraderAccount) {
        const accountName = accountNumber ? `cTrader ${accountNumber}` : 'cTrader Account';
        console.log(`‚ö†Ô∏è No existe cuenta. Creando: "${accountName}"`);
        
        ctraderAccount = {
            id: generateId(),
            name: accountName,
            balance: 0,
            currency: accountCurrency,
            platform: 'ctrader'
        };
        
        DB.accounts.push(ctraderAccount);
        await dexieDB.accounts.add(ctraderAccount);
        
        if (currentUser) {
            try {
                await saveAccountToSupabase(ctraderAccount);
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo sincronizar cuenta:', error);
            }
        }
        
        console.log(`‚úÖ Nueva cuenta creada: "${ctraderAccount.name}"`);
    }
    
    // IMPORTAR OPERACIONES
    let imported = 0;
    let duplicates = 0;
    
    for (const op of operations) {
        const isDuplicate = DB.operations.some(existing => 
            existing.instrument === op.instrument &&
            existing.date === op.date &&
            existing.exitTime === op.exitTime &&
            existing.pl === op.pl &&
            existing.accountId === ctraderAccount.id
        );
        
        if (isDuplicate) {
            duplicates++;
            continue;
        }
        
        const newOp = {
            id: generateId(),
            accountId: ctraderAccount.id,
            accountName: ctraderAccount.name,
            date: op.date,
            instrument: op.instrument,
            type: op.type,
            entry: op.entry,
            exit: op.exit,
            entryTime: op.entryTime,
            exitTime: op.exitTime,
            volume: op.volume,
            pl: op.pl,
            manualPL: op.pl,
            currency: op.currency,
            commission: op.commission,
            notes: op.notes,
            source: 'ctrader',
            importDate: new Date().toISOString()
        };
        
        DB.operations.push(newOp);
        await dexieDB.operations.add(newOp);
        
        if (currentUser) {
            try {
                await saveOperationToSupabase(newOp);
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo sincronizar operaci√≥n:', error);
            }
        }
        
        imported++;
    }
    
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`‚úÖ IMPORTACI√ìN COMPLETADA`);
    console.log(`   üìä Nuevas: ${imported}`);
    console.log(`   ‚ö†Ô∏è  Duplicadas: ${duplicates}`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
    showSyncNotification(`‚úÖ ${imported} operaciones importadas${duplicates > 0 ? `, ${duplicates} duplicadas omitidas` : ''}`, 'success');
    
    // Refrescar dashboard
    if (typeof refreshDashboard === 'function') {
        refreshDashboard();
    }
    if (typeof refreshOperationsTable === 'function') {
        refreshOperationsTable();
    }
}

function populateCTraderAccountSelect() {
    const accountSelect = document.getElementById('ctrader-account-select');
    if (!accountSelect) {
        console.log('‚ö†Ô∏è Select de cuentas cTrader no encontrado');
        return;
    }

    accountSelect.innerHTML = '<option value="">Seleccionar cuenta...</option>';

    DB.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} (${account.currency})`;
        accountSelect.appendChild(option);
    });

    // Si solo hay una cuenta, seleccionarla autom√°ticamente
    if (DB.accounts.length === 1) {
        accountSelect.value = DB.accounts[0].id;
        console.log('‚úÖ Cuenta cTrader seleccionada autom√°ticamente:', DB.accounts[0].name, 'ID:', DB.accounts[0].id);
    } else if (DB.accounts.length > 1) {
        console.log('üìã Cuentas disponibles para cTrader:', DB.accounts.length);
        DB.accounts.forEach(acc => {
            console.log(`  - ${acc.name} (${acc.currency}) - ID: ${acc.id}`);
        });
    }

    console.log('‚úÖ Cuentas cargadas en select de cTrader:', DB.accounts.length);
}

// Funci√≥n para parsear HTML Statement de cTrader
function parseCTraderHTML(htmlContent) {
    console.log('üîç Iniciando parseo de cTrader HTML Statement...');
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    
    // Extraer informaci√≥n de la cuenta del header
    let accountNumber = '';
    let accountCurrency = 'USD';
    
    console.log('üìã Buscando informaci√≥n de cuenta...');
    // Buscar n√∫mero de cuenta y divisa en todas las tablas
    const allTables = doc.querySelectorAll('table');
    for (const table of allTables) {
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 2) {
                const label = cells[0]?.textContent.trim() || '';
                const value = cells[1]?.textContent.trim() || '';
                
                if (label.toLowerCase().includes('cuenta') || label.toLowerCase().includes('account')) {
                    accountNumber = value;
                    console.log('‚úÖ N√∫mero de cuenta detectado:', accountNumber);
                }
                if (label.toLowerCase().includes('divisa') || label.toLowerCase().includes('currency')) {
                    accountCurrency = value;
                    console.log('‚úÖ Divisa detectada:', accountCurrency);
                }
            }
        }
    }
    
    console.log('üîç Buscando tabla de operaciones...');
    // Buscar la tabla de Historial (History) - B√∫squeda m√°s flexible
    let historyTable = null;
    
    // M√©todo 1: Buscar por clase dataTable
    const dataTables = doc.querySelectorAll('table.dataTable');
    for (const table of dataTables) {
        const titleCell = table.querySelector('td strong, th strong, td.title-style strong');
        if (titleCell) {
            const title = titleCell.textContent.toLowerCase();
            if (title.includes('historial') || title.includes('history') || title.includes('closed positions')) {
                historyTable = table;
                console.log('‚úÖ Tabla de historial encontrada (m√©todo 1)');
                break;
            }
        }
    }
    
    // M√©todo 2: Buscar por contenido de texto en headers
    if (!historyTable) {
        console.log('‚ö†Ô∏è M√©todo 1 fall√≥, intentando m√©todo 2...');
        for (const table of allTables) {
            const text = table.textContent.toLowerCase();
            // Buscar keywords que indican que es la tabla de operaciones
            if ((text.includes('s√≠mbolo') || text.includes('symbol')) && 
                (text.includes('direcci√≥n') || text.includes('side') || text.includes('buy') || text.includes('sell')) &&
                (text.includes('cantidad') || text.includes('volume') || text.includes('lotes'))) {
                historyTable = table;
                console.log('‚úÖ Tabla de historial encontrada (m√©todo 2)');
                break;
            }
        }
    }
    
    if (!historyTable) {
        console.error('‚ùå No se encontr√≥ la tabla de Historial');
        throw new Error('No se encontr√≥ la tabla de operaciones en el archivo HTML. Aseg√∫rate de exportar el HTML Statement desde cTrader.');
    }
    
    console.log('üìä Procesando filas de operaciones...');
    const operations = [];
    const rows = historyTable.querySelectorAll('tr');
    
    // Buscar la fila de encabezados de manera flexible
    let headerRowIndex = -1;
    let headerMap = {}; // Mapa de columnas: {symbol: 0, side: 1, ...}
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.querySelectorAll('td, th');
        
        // Verificar si esta fila contiene encabezados
        let hasHeaders = false;
        const cellsText = Array.from(cells).map(c => c.textContent.toLowerCase().trim());
        
        if (cellsText.some(t => t.includes('s√≠mbolo') || t.includes('symbol')) &&
            cellsText.some(t => t.includes('direcci√≥n') || t.includes('side'))) {
            headerRowIndex = i;
            hasHeaders = true;
            
            // Crear mapa de columnas
            cellsText.forEach((text, idx) => {
                if (text.includes('s√≠mbolo') || text.includes('symbol')) headerMap.symbol = idx;
                if (text.includes('direcci√≥n') || text.includes('side') || text.includes('tipo')) headerMap.side = idx;
                if (text.includes('hora de cierre') || text.includes('close time') || text.includes('fecha')) headerMap.closeTime = idx;
                if (text.includes('precio de entrada') || text.includes('entry price') || text.includes('open price')) headerMap.entryPrice = idx;
                if (text.includes('precio de cierre') || text.includes('close price') || text.includes('exit price')) headerMap.closePrice = idx;
                if (text.includes('cantidad') || text.includes('volume') || text.includes('lotes')) headerMap.volume = idx;
                if (text.includes('neto') || text.includes('p&l') || text.includes('profit') || text.includes('ganancia')) headerMap.pl = idx;
            });
            
            console.log('‚úÖ Encabezados encontrados en fila', i);
            console.log('üìã Mapa de columnas:', headerMap);
            break;
        }
    }
    
    if (headerRowIndex === -1) {
        console.error('‚ùå No se encontraron encabezados');
        throw new Error('No se encontraron encabezados en la tabla de operaciones');
    }
    
    // Procesar filas de datos
    let processedCount = 0;
    for (let i = headerRowIndex + 1; i < rows.length; i++) {
        const row = rows[i];
        
        // Saltar filas de totales o resumen
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes('total') || rowText.includes('suma') || 
            row.style.background === '#000' || row.style.background === 'rgb(0, 0, 0)' ||
            row.querySelector('.totals-title')) {
            console.log('‚ö†Ô∏è Fila de totales detectada, finalizando parseo');
            break;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < Math.max(...Object.values(headerMap))) {
            console.log(`‚ö†Ô∏è Fila ${i} ignorada (c√©lulas insuficientes)`);
            continue;
        }
        
        // Extraer datos usando el mapa de columnas
        const symbolCell = cells[headerMap.symbol]?.textContent.trim() || '';
        const sideCell = cells[headerMap.side]?.textContent.trim() || '';
        const closeTimeCell = cells[headerMap.closeTime]?.textContent.trim() || '';
        const entryPriceCell = cells[headerMap.entryPrice]?.textContent.trim() || '0';
        const closePriceCell = cells[headerMap.closePrice]?.textContent.trim() || '0';
        const volumeCell = cells[headerMap.volume]?.textContent.trim() || '0';
        const plCell = cells[headerMap.pl]?.textContent.trim() || '0';
        
        // Validar que tenga datos m√≠nimos
        if (!symbolCell || !closeTimeCell) {
            console.log(`‚ö†Ô∏è Fila ${i} ignorada (datos incompletos)`);
            continue;
        }
        
        // Parsear valores num√©ricos
        const entryPrice = parseFloat(entryPriceCell.replace(/[^0-9.-]/g, '')) || 0;
        const exitPrice = parseFloat(closePriceCell.replace(/[^0-9.-]/g, '')) || 0;
        const volume = parseFloat(volumeCell.replace(/[^0-9.-]/g, '')) || 0;
        const pl = parseFloat(plCell.replace(/[^0-9.-]/g, '')) || 0;
        
        // Parsear fecha y hora - Soportar m√∫ltiples formatos
        let date = '';
        let exitTime = '';
        
        // Formato 1: "12/11/2025 07:34:53.531"
        // Formato 2: "2025-11-12 07:34:53"
        // Formato 3: "12-Nov-2025 07:34"
        const dateTimeParts = closeTimeCell.split(' ');
        if (dateTimeParts.length >= 2) {
            const datePart = dateTimeParts[0];
            const timePart = dateTimeParts[1];
            
            // Intentar parsear fecha
            if (datePart.includes('/')) {
                // Formato DD/MM/YYYY
                const pieces = datePart.split('/');
                if (pieces.length === 3) {
                    const [day, month, year] = pieces;
                    date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            } else if (datePart.includes('-')) {
                const pieces = datePart.split('-');
                if (pieces.length === 3 && pieces[0].length === 4) {
                    // Ya est√° en formato YYYY-MM-DD
                    date = datePart;
                } else if (pieces.length === 3) {
                    // Formato DD-MM-YYYY
                    const [day, month, year] = pieces;
                    if (month.match(/[a-z]/i)) {
                        // Mes en texto, convertir
                        const monthMap = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,ene:1,abr:4,ago:8,dic:12};
                        const monthNum = monthMap[month.toLowerCase().slice(0,3)] || month;
                        date = `${year}-${String(monthNum).padStart(2,'0')}-${day.padStart(2,'0')}`;
                    } else {
                        date = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                    }
                }
            }
            
            // Parsear hora HH:MM
            const timePieces = timePart.split(':');
            if (timePieces.length >= 2) {
                exitTime = `${timePieces[0].padStart(2,'0')}:${timePieces[1].padStart(2,'0')}`;
            }
        }
        
        // Determinar tipo (buy/sell)
        const sideLower = sideCell.toLowerCase();
        const type = sideLower.includes('buy') || sideLower.includes('comprar') || sideLower.includes('long') ? 'buy' : 'sell';
        
        const operation = {
            instrument: symbolCell,
            type: type,
            date: date,
            entryTime: exitTime,
            exitTime: exitTime,
            entry: entryPrice,
            exit: exitPrice,
            volume: volume,
            pl: pl,
            currency: accountCurrency,
            commission: 0,
            notes: `Importado de cTrader - ${sideCell}`
        };
        
        operations.push(operation);
        processedCount++;
        
        if (processedCount <= 3) {
            console.log(`‚úÖ Operaci√≥n ${processedCount} procesada:`, {
                symbol: symbolCell,
                type,
                date,
                pl
            });
        }
    }
    
    console.log(`‚úÖ Parseo completado: ${operations.length} operaciones extra√≠das`);
    
    if (operations.length === 0) {
        throw new Error('No se encontraron operaciones en el archivo HTML. Verifica que el archivo contenga operaciones cerradas.');
    }
    
    return {
        operations: operations,
        accountInfo: {
            number: accountNumber,
            currency: accountCurrency
        }
    };
}

// Event listener para importar CSV/HTML de cTrader
// Variables globales para cTrader
let ctraderPendingOperations = [];
let ctraderSelectedAccountId = '';

function showCTraderPreview(operations, accountId) {
    console.log('üëÅÔ∏è Mostrando vista previa de cTrader');
    console.log('üìä Operaciones a previsualizar:', operations.length);
    console.log('üë§ Account ID recibido:', accountId);
    
    // Verificar que la cuenta existe
    const account = DB.accounts.find(acc => acc.id === accountId);
    if (!account) {
        console.error('‚ùå Cuenta no encontrada en DB.accounts:', accountId);
        console.log('üìã Cuentas disponibles:');
        DB.accounts.forEach(acc => {
            console.log(`  - ${acc.name} (${acc.id})`);
        });
        showSyncNotification('‚ùå Cuenta no encontrada. Por favor selecciona una cuenta v√°lida.', 'error');
        return;
    }
    
    console.log('‚úÖ Cuenta encontrada:', account.name, '(', account.currency, ')');
    
    ctraderPendingOperations = operations;
    ctraderSelectedAccountId = accountId;
    
    console.log('üíæ Variables globales actualizadas:');
    console.log('  - ctraderPendingOperations:', ctraderPendingOperations.length, 'ops');
    console.log('  - ctraderSelectedAccountId:', ctraderSelectedAccountId);
    
    const previewContainer = document.getElementById('ctrader-preview-container');
    const tbody = document.getElementById('ctrader-preview-tbody');
    const countEl = document.getElementById('ctrader-preview-count');
    
    if (!previewContainer || !tbody || !countEl) {
        console.error('‚ùå Elementos de vista previa no encontrados');
        return;
    }
    
    tbody.innerHTML = '';
    
    operations.forEach(op => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border';
        
        const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
        
        row.innerHTML = `
            <td class="px-3 py-2">${op.instrument}</td>
            <td class="px-3 py-2">${op.type === 'buy' ? 'Long' : 'Short'}</td>
            <td class="px-3 py-2">${op.date}</td>
            <td class="px-3 py-2 text-right">${op.entry.toFixed(5)}</td>
            <td class="px-3 py-2 text-right">${op.exit.toFixed(5)}</td>
            <td class="px-3 py-2 text-right">${op.volume.toFixed(2)}</td>
            <td class="px-3 py-2 text-right ${plClass}">${op.pl >= 0 ? '+' : ''}${op.pl.toFixed(2)}</td>
        `;
        
        tbody.appendChild(row);
    });
    
    countEl.textContent = operations.length;
    previewContainer.style.display = 'block';
    
    console.log('‚úÖ Vista previa renderizada exitosamente');
    showSyncNotification(`‚úÖ ${operations.length} operaciones detectadas. Revisa la vista previa.`, 'success');
}

function confirmCTraderImport() {
    console.log('üîÑ Iniciando confirmaci√≥n de importaci√≥n cTrader...');
    console.log('üìä Operaciones pendientes:', ctraderPendingOperations.length);
    console.log('üë§ Cuenta seleccionada:', ctraderSelectedAccountId);
    
    if (ctraderPendingOperations.length === 0) {
        showSyncNotification('‚ö†Ô∏è No hay operaciones para importar', 'warning');
        return;
    }
    
    const account = DB.accounts.find(acc => acc.id === ctraderSelectedAccountId);
    if (!account) {
        console.error('‚ùå Cuenta no encontrada:', ctraderSelectedAccountId);
        showSyncNotification('‚ùå Cuenta no encontrada', 'error');
        return;
    }
    
    console.log('‚úÖ Cuenta encontrada:', account.name);
    
    let imported = 0;
    let duplicates = 0;
    
    ctraderPendingOperations.forEach((op, index) => {
        console.log(`üìù Procesando operaci√≥n ${index + 1}/${ctraderPendingOperations.length}:`, op.instrument);
        
        // Verificar duplicados (mismo instrumento, fecha, hora y P&L)
        const isDuplicate = DB.operations.some(existing => 
            existing.instrument === op.instrument &&
            existing.date === op.date &&
            existing.exitTime === op.exitTime &&
            existing.pl === op.pl &&
            existing.accountId === ctraderSelectedAccountId
        );
        
        if (isDuplicate) {
            console.log(`‚ö†Ô∏è Operaci√≥n duplicada detectada: ${op.instrument} ${op.date}`);
            duplicates++;
            return;
        }
        
        // Crear operaci√≥n
        const newOperation = {
            id: generateId(),
            accountId: ctraderSelectedAccountId,
            accountName: account.name,
            date: op.date,
            instrument: op.instrument,
            type: op.type,
            entry: op.entry,
            exit: op.exit,
            entryTime: op.entryTime,
            exitTime: op.exitTime,
            volume: op.volume,
            pl: op.pl,
            manualPL: op.pl,
            currency: op.currency || account.currency,
            commission: op.commission || 0,
            notes: op.notes || '',
            source: 'ctrader',
            importDate: new Date().toISOString()
        };
        
        console.log('‚úÖ Creando nueva operaci√≥n:', newOperation.id, newOperation.instrument);
        DB.operations.push(newOperation);
        imported++;
    });
    
    console.log('üíæ Guardando base de datos...');
    console.log('üìä Total operaciones en DB antes de guardar:', DB.operations.length);
    saveDB();
    console.log('‚úÖ Base de datos guardada');
    
    // Actualizar historial de importaciones
    updateCTraderImportHistory(imported, duplicates);
    
    // Limpiar vista previa
    const previewContainer = document.getElementById('ctrader-preview-container');
    if (previewContainer) {
        previewContainer.style.display = 'none';
    }
    
    const fileInput = document.getElementById('ctrader-csv-file-input');
    if (fileInput) {
        fileInput.value = '';
    }
    
    ctraderPendingOperations = [];
    
    console.log(`‚úÖ Importaci√≥n completada: ${imported} nuevas, ${duplicates} duplicadas`);
    showSyncNotification(`‚úÖ Importaci√≥n completada: ${imported} operaciones nuevas${duplicates > 0 ? `, ${duplicates} duplicadas omitidas` : ''}`, 'success');
    
    // Refrescar la vista de operaciones
    console.log('üîÑ Refrescando vista de operaciones...');
    if (typeof refreshOperationsTable === 'function') {
        refreshOperationsTable();
    }
    
    // Refrescar dashboard si est√° activo
    if (document.getElementById('dashboard')?.classList.contains('active')) {
        console.log('üîÑ Refrescando dashboard...');
        refreshDashboard();
    }
}

function updateCTraderImportHistory(imported, duplicates) {
    const historyContainer = document.getElementById('ctrader-import-history');
    if (!historyContainer) return;
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('es-ES');
    const timeStr = now.toLocaleTimeString('es-ES');
    
    const historyItem = document.createElement('div');
    historyItem.className = 'p-3 bg-surface-light rounded border border-border';
    historyItem.innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <p class="font-semibold text-sm">
                    <i class="fas fa-file-import mr-2 text-primary"></i>
                    Importaci√≥n cTrader
                </p>
                <p class="text-xs text-text-secondary mt-1">${dateStr} ${timeStr}</p>
            </div>
            <div class="text-right">
                <p class="text-sm">
                    <span class="text-success font-semibold">${imported}</span> nuevas
                </p>
                ${duplicates > 0 ? `<p class="text-xs text-text-secondary">${duplicates} duplicadas</p>` : ''}
            </div>
        </div>
    `;
    
    // Remover mensaje de "no hay importaciones"
    const emptyMsg = historyContainer.querySelector('p.text-text-secondary');
    if (emptyMsg) {
        emptyMsg.remove();
    }
    
    // Agregar al inicio
    historyContainer.insertBefore(historyItem, historyContainer.firstChild);
    
    // Mantener solo las √∫ltimas 10 importaciones
    while (historyContainer.children.length > 10) {
        historyContainer.removeChild(historyContainer.lastChild);
    }
}

// ============================================
// FUNCIONES PARA METATRADER 5
// ============================================

function importMT5HTMLReport() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.html,.htm';
    input.style.display = 'none';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const html = e.target.result;
                await parseMT5HTMLReport(html);
            } catch (error) {
                console.error('Error procesando informe MT5:', error);
                showSyncNotification('‚ùå Error procesando informe HTML de MT5', 'error');
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

async function parseMT5HTMLReport(htmlContent) {
    console.log('üìÑ Procesando informe HTML de MetaTrader 5...');

    try {
        // Parsear HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        // Extraer nombre de cuenta del informe
        const accountNameElement = doc.querySelector('th b');
        const defaultAccountName = accountNameElement ? accountNameElement.textContent.trim() : 'MT5 Account';

        // Buscar la tabla de Posiciones o √ìrdenes (closed trades)
        let positionsTable = null;
        let tableType = null; // 'positions' o 'orders'
        const tables = doc.querySelectorAll('table');

        console.log(`üîç Buscando tablas en el informe... Total tablas encontradas: ${tables.length}`);

        for (const table of tables) {
            // Buscar por el header espec√≠fico de la tabla de Posiciones u √ìrdenes
            const headers = table.querySelectorAll('th');
            
            for (const header of headers) {
                const text = header.textContent.trim();
                console.log(`üìã Header encontrado: "${text}"`);
                
                // Buscar tabla de Posiciones (closed positions)
                if (text === 'Posiciones' || text === 'Positions' || text === 'Closed Positions') {
                    const dataRows = table.querySelectorAll('tr[bgcolor]');
                    if (dataRows.length > 0) {
                        positionsTable = table;
                        tableType = 'positions';
                        console.log('‚úÖ Tabla de Posiciones encontrada con', dataRows.length, 'filas');
                        break;
                    }
                }
                
                // Buscar tabla de √ìrdenes (orders history)
                if (text === '√ìrdenes' || text === 'Orders' || text === 'Order History' || text === 'Historial de √≥rdenes') {
                    const dataRows = table.querySelectorAll('tr[bgcolor]');
                    if (dataRows.length > 0) {
                        positionsTable = table;
                        tableType = 'orders';
                        console.log('‚úÖ Tabla de √ìrdenes encontrada con', dataRows.length, 'filas');
                        break;
                    }
                }
            }
            
            if (positionsTable) break;
        }

        if (!positionsTable) {
            console.error('‚ùå No se encontr√≥ tabla de Posiciones ni √ìrdenes');
            showSyncNotification('‚ùå No se encontr√≥ la tabla de Posiciones u √ìrdenes en el informe', 'error');
            return;
        }
        
        console.log(`üìä Procesando tabla de tipo: ${tableType}`);

        // Extraer filas de datos (las que tienen bgcolor - son las operaciones)
        const rows = positionsTable.querySelectorAll('tr[bgcolor]');
        console.log(`üìä Encontradas ${rows.length} filas en la tabla`);

        if (rows.length === 0) {
            showSyncNotification('‚ÑπÔ∏è El informe no contiene datos', 'info');
            return;
        }

        const newOperations = [];
        let skippedCount = 0;
        
        // Debug: Mostrar headers de la tabla
        const headers = positionsTable.querySelectorAll('th');
        console.log(`üìã Headers de la tabla (${headers.length}):`, 
            Array.from(headers).map((h, i) => `[${i}]="${h.textContent.trim()}"`).join(' | '));

        // SIMPLIFICADO: Extraer n√∫mero de cuenta del nombre del informe
        const accountNumberMatch = defaultAccountName.match(/\d{7,}/);
        const accountNumber = accountNumberMatch ? accountNumberMatch[0] : null;
        
        console.log(`üîç Nombre de cuenta del informe: "${defaultAccountName}"`);
        console.log(`üîç N√∫mero de cuenta extra√≠do: ${accountNumber}`);
        console.log(`üîç Cuentas disponibles:`, DB.accounts.map(a => `${a.name} (${a.platform})`));
        
        // Buscar cuenta existente - SIMPLE Y DIRECTO
        let mt5Account = null;
        
        // 1. Buscar por n√∫mero de cuenta (ej: 10009163)
        if (accountNumber) {
            mt5Account = DB.accounts.find(acc => acc.name.includes(accountNumber));
            if (mt5Account) {
                console.log(`‚úÖ Cuenta encontrada por n√∫mero ${accountNumber}: "${mt5Account.name}"`);
            }
        }
        
        // 2. Si no encontr√≥, buscar por nombre exacto
        if (!mt5Account) {
            mt5Account = DB.accounts.find(acc => acc.name === defaultAccountName);
            if (mt5Account) {
                console.log(`‚úÖ Cuenta encontrada por nombre exacto: "${mt5Account.name}"`);
            }
        }
        
        // 3. Si a√∫n no encontr√≥, buscar cualquier cuenta MT5
        if (!mt5Account) {
            mt5Account = DB.accounts.find(acc => 
                acc.platform === 'meta-trader-5' || acc.platform === 'meta-trader-4'
            );
            if (mt5Account) {
                console.log(`‚úÖ Cuenta MT5 encontrada: "${mt5Account.name}"`);
            }
        }
        
        // 4. Si NO existe ninguna cuenta MT5, crear autom√°ticamente
        if (!mt5Account) {
            console.log(`‚ö†Ô∏è No existe ninguna cuenta. Creando: "${defaultAccountName}"`);
            
            mt5Account = {
                id: generateId(),
                name: defaultAccountName,
                balance: 0,
                currency: 'USD',
                platform: 'meta-trader-5'
            };
            
            DB.accounts.push(mt5Account);
            await dexieDB.accounts.add(mt5Account);
            
            // Sincronizar con Supabase si hay usuario
            if (currentUser) {
                try {
                    await saveAccountToSupabase(mt5Account);
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo sincronizar cuenta con Supabase:', error);
                }
            }
            
            console.log(`‚úÖ Nueva cuenta creada: "${mt5Account.name}"`);
        }
        
        console.log(`‚úÖ CUENTA SELECCIONADA: "${mt5Account.name}" (ID: ${mt5Account.id})`);

        // Procesar seg√∫n tipo de tabla
        if (tableType === 'orders') {
            // PROCESAMIENTO DE TABLA DE √ìRDENES (Orders History)
            console.log('üìã Procesando tabla de √ìrdenes...');
            console.log(`üìä Total de filas a procesar: ${rows.length}`);
            
            // En tabla de √≥rdenes, necesitamos agrupar pares buy/sell
            const ordersBySymbol = {};
            let processedRows = 0;
            
            for (const row of rows) {
                processedRows++;
                try {
                    const cells = row.querySelectorAll('td');
                    
                    // Debug: mostrar primeras 3 filas completas
                    if (processedRows <= 3) {
                        console.log(`üîç Fila ${processedRows} - ${cells.length} celdas:`, 
                            Array.from(cells).map((c, i) => `[${i}]="${c.textContent.trim()}"`).join(' | '));
                    }
                    
                    if (cells.length < 9) {
                        console.log(`‚è≠Ô∏è Fila ${processedRows}: solo ${cells.length} celdas, omitiendo`);
                        skippedCount++;
                        continue;
                    }
                    
                    const openDateTime = cells[0].textContent.trim();
                    const orderId = cells[1].textContent.trim();
                    const symbol = cells[2].textContent.trim();
                    const typeRaw = cells[3].textContent.trim().toLowerCase();
                    const volumeRaw = cells[4].textContent.trim();
                    const priceRaw = cells[5].textContent.trim();
                    
                    // Buscar el estado en las columnas 9, 10, 11
                    let stateRaw = '';
                    let stateColumnIndex = -1;
                    for (let i = 9; i <= Math.min(cells.length - 1, 11); i++) {
                        const cellText = cells[i]?.textContent.trim().toLowerCase() || '';
                        if (cellText.includes('filled') || cellText.includes('ejecutado') || cellText.includes('completado')) {
                            stateRaw = cellText;
                            stateColumnIndex = i;
                            break;
                        }
                    }
                    
                    // Debug: mostrar estado encontrado en primeras 3 filas
                    if (processedRows <= 3) {
                        console.log(`   Estado en columna ${stateColumnIndex}: "${stateRaw}"`);
                    }
                    
                    // Solo procesar √≥rdenes filled (ejecutadas)
                    if (!stateRaw.includes('filled') && !stateRaw.includes('ejecutado') && !stateRaw.includes('completado')) {
                        if (processedRows <= 10) {
                            console.log(`‚è≠Ô∏è Fila ${processedRows} - Orden ${orderId}: estado no es "filled": col[9]="${cells[9]?.textContent.trim()}" col[10]="${cells[10]?.textContent.trim() || 'N/A'}"`);
                        }
                        skippedCount++;
                        continue;
                    }
                    
                    // Detectar tipo de operaci√≥n (buy o sell)
                    if (!typeRaw.includes('buy') && !typeRaw.includes('sell') && !typeRaw.includes('compra') && !typeRaw.includes('venta')) {
                        console.log(`‚è≠Ô∏è Tipo de orden no v√°lido: "${typeRaw}"`);
                        skippedCount++;
                        continue;
                    }
                    
                    const type = (typeRaw.includes('buy') || typeRaw.includes('compra')) ? 'buy' : 'sell';
                    
                    // Parsear volumen y precio
                    const volume = parseFloat(volumeRaw.split('/')[0].trim().replace(',', '.')) || 0;
                    let price = parseFloat(priceRaw.replace(/\s/g, '').replace(',', '.')) || 0;
                    
                    // Si el precio es 0 o inv√°lido, buscar en columnas siguientes
                    if (price === 0 || priceRaw.toLowerCase().includes('market')) {
                        // Para √≥rdenes market, el precio puede estar en otra columna
                        for (let i = 5; i < 9; i++) {
                            const testPrice = parseFloat(cells[i]?.textContent.replace(/\s/g, '').replace(',', '.')) || 0;
                            if (testPrice > 0 && testPrice < 1000000) {
                                price = testPrice;
                                break;
                            }
                        }
                    }
                    
                    // Validar que tengamos datos m√≠nimos
                    if (!symbol || volume === 0 || price === 0) {
                        console.log(`‚è≠Ô∏è Datos incompletos: symbol="${symbol}", vol=${volume}, price=${price}`);
                        skippedCount++;
                        continue;
                    }
                    
                    // Parsear fecha
                    const [dateStr, timeStr] = openDateTime.split(' ');
                    const operationDate = dateStr.replace(/\./g, '-');
                    
                    console.log(`‚úÖ Orden ${orderId}: ${symbol} ${type} ${volume} @ ${price} | ${operationDate} ${timeStr || 'sin hora'}`);
                    
                    // Agrupar por s√≠mbolo para emparejar
                    if (!ordersBySymbol[symbol]) {
                        ordersBySymbol[symbol] = [];
                    }
                    
                    ordersBySymbol[symbol].push({
                        orderId,
                        type,
                        volume,
                        price,
                        date: operationDate,
                        time: timeStr,
                        datetime: openDateTime
                    });
                    
                } catch (error) {
                    console.error(`Error procesando fila ${processedRows}:`, error);
                    skippedCount++;
                }
            }
            
            console.log(`üìä Resumen de procesamiento: ${processedRows} filas procesadas, ${Object.keys(ordersBySymbol).length} s√≠mbolos encontrados`);
            
            // Ahora emparejar √≥rdenes para crear operaciones completas
            for (const symbol in ordersBySymbol) {
                const orders = ordersBySymbol[symbol].sort((a, b) => {
                    // Ordenar por fecha/hora
                    return a.datetime.localeCompare(b.datetime);
                });
                
                const buys = orders.filter(o => o.type === 'buy');
                const sells = orders.filter(o => o.type === 'sell');
                
                console.log(`üîÑ ${symbol}: ${buys.length} compras, ${sells.length} ventas`);
                
                // Emparejar FIFO (First In First Out)
                const minPairs = Math.min(buys.length, sells.length);
                
                if (minPairs === 0) {
                    console.warn(`‚ö†Ô∏è ${symbol}: No se pueden emparejar (${buys.length} buys, ${sells.length} sells)`);
                    skippedCount += orders.length;
                    continue;
                }
                
                for (let i = 0; i < minPairs; i++) {
                    const buyOrder = buys[i];
                    const sellOrder = sells[i];
                    
                    // Usar la fecha de cierre (sell) como fecha de operaci√≥n
                    const closeDate = sellOrder.date;
                    
                    // Calcular P&L basado en la direcci√≥n
                    // Si abrimos con BUY y cerramos con SELL = operaci√≥n LONG
                    let profit = (sellOrder.price - buyOrder.price) * buyOrder.volume;
                    
                    // Redondear a 2 decimales
                    profit = Math.round(profit * 100) / 100;
                    
                    // Determinar resultado
                    let result;
                    if (profit > 0.01) result = 'win';
                    else if (profit < -0.01) result = 'loss';
                    else result = 'breakeven';
                    
                    const operation = {
                        id: `mt5_${buyOrder.orderId}_${sellOrder.orderId}`,
                        date: closeDate,
                        accountId: mt5Account.id,
                        instrument: symbol,
                        type: 'buy', // La direcci√≥n de la operaci√≥n (LONG)
                        entry: buyOrder.price,
                        exit: sellOrder.price,
                        entryTime: buyOrder.time || null,
                        exitTime: sellOrder.time || null,
                        volume: buyOrder.volume,
                        result: result,
                        pl: profit,
                        currency: mt5Account.currency,
                        notes: `Importado de MT5 - √ìrdenes #${buyOrder.orderId}/#${sellOrder.orderId}`,
                        imageDatas: [],
                        fees: 0,
                        manualPL: profit,
                        session: 'No especificado'
                    };
                    
                    // Verificar duplicados
                    if (DB.operations.some(op => op.id === operation.id)) {
                        console.log(`‚è≠Ô∏è Operaci√≥n ${operation.id} ya existe`);
                        skippedCount++;
                        continue;
                    }
                    
                    console.log(`‚úÖ Operaci√≥n ${symbol}: BUY@${buyOrder.price} ‚Üí SELL@${sellOrder.price} = $${profit.toFixed(2)}`);
                    newOperations.push(operation);
                }
                
                // Reportar √≥rdenes no emparejadas
                const unpaired = orders.length - (minPairs * 2);
                if (unpaired > 0) {
                    console.warn(`‚ö†Ô∏è ${symbol}: ${unpaired} √≥rdenes sin emparejar`);
                    skippedCount += unpaired;
                }
            }
            
        } else {
            // PROCESAMIENTO DE TABLA DE POSICIONES (Closed Positions)
            console.log('üìã Procesando tabla de Posiciones...');
            
            for (const row of rows) {
                try {
                    const allCells = row.querySelectorAll('td');
                    const cells = Array.from(allCells).filter(cell => {
                        return !cell.classList.contains('hidden') && !cell.hasAttribute('class') || cell.className !== 'hidden';
                    });

                    console.log(`üîç Fila con ${allCells.length} celdas totales, ${cells.length} visibles`);

                    if (cells.length < 12) {
                        console.warn(`‚ö†Ô∏è Fila con solo ${cells.length} celdas visibles, omitiendo`);
                        skippedCount++;
                        continue;
                    }

                    const openDateTime = cells[0].textContent.trim();
                    const positionId = cells[1].textContent.trim();
                    const symbol = cells[2].textContent.trim();
                    const type = cells[3].textContent.trim().toLowerCase();

                    console.log(`üìù Pos#${positionId}: ${symbol} ${type}`);

                    if (!symbol || symbol === '' || !type || type === '') {
                        console.log(`‚è≠Ô∏è Omitiendo fila sin s√≠mbolo o tipo`);
                        skippedCount++;
                        continue;
                    }

                    if (type !== 'buy' && type !== 'sell') {
                        console.log(`‚è≠Ô∏è Omitiendo operaci√≥n tipo "${type}"`);
                        skippedCount++;
                        continue;
                    }

                    const volume = parseFloat(cells[4].textContent.replace(/\s/g, '').replace(',', '.')) || 0;
                    const entryPrice = parseFloat(cells[5].textContent.replace(/\s/g, '').replace(',', '.')) || 0;
                    const exitPrice = parseFloat(cells[9].textContent.replace(/\s/g, '').replace(',', '.')) || 0;
                    const closeDateTime = cells[8].textContent.trim();

                    const commissionRaw = parseFloat(cells[10].textContent.replace(/\s/g, '').replace(',', '.')) || 0;
                    const swapRaw = parseFloat(cells[11].textContent.replace(/\s/g, '').replace(',', '.')) || 0;

                    let profit = 0;
                    for (let i = cells.length - 1; i >= 12; i--) {
                        const text = cells[i].textContent.replace(/\s/g, '').replace(',', '.');
                        const value = parseFloat(text);
                        if (!isNaN(value)) {
                            profit = value;
                            break;
                        }
                    }

                    console.log(`üí∞ Vol=${volume}, Entry=${entryPrice}, Exit=${exitPrice}, P&L=${profit}, Comm=${commissionRaw}, Swap=${swapRaw}`);

                    if (profit === 0 || entryPrice === 0 || exitPrice === 0) {
                        console.log(`‚è≠Ô∏è Omitiendo: P&L=${profit}, Entry=${entryPrice}, Exit=${exitPrice}`);
                        skippedCount++;
                        continue;
                    }

                    // Parsear fechas y horas
                    const [openDateStr, openTimeStr] = openDateTime.split(' ');
                    const [closeDateStr, closeTimeStr] = closeDateTime.split(' ');

                    // Convertir fecha de MT5 (YYYY.MM.DD) a formato est√°ndar (YYYY-MM-DD)
                    const operationDate = closeDateStr ? closeDateStr.replace(/\./g, '-') : null;

                    // Validar que las fechas sean v√°lidas
                    if (!operationDate || operationDate.includes('NaN') || operationDate === '--') {
                        console.error(`‚ùå Fecha inv√°lida para operaci√≥n #${positionId}: closeDateStr="${closeDateStr}", operationDate="${operationDate}"`);
                        skippedCount++;
                        continue;
                    }

                    // Validar formato YYYY-MM-DD
                    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                    if (!datePattern.test(operationDate)) {
                        console.error(`‚ùå Formato de fecha incorrecto para operaci√≥n #${positionId}: "${operationDate}"`);
                        skippedCount++;
                        continue;
                    }

                    // Calcular fees total - validar que sean valores razonables
                    let totalFees = 0;

                    if (Math.abs(commissionRaw) < 100) {
                        totalFees += Math.abs(commissionRaw);
                    } else {
                        console.warn(`‚ö†Ô∏è Comisi√≥n sospechosa ($${commissionRaw}) en operaci√≥n #${positionId}, ignorando`);
                    }

                    if (Math.abs(swapRaw) < 100) {
                        totalFees += Math.abs(swapRaw);
                    } else {
                        console.warn(`‚ö†Ô∏è Swap sospechoso ($${swapRaw}) en operaci√≥n #${positionId}, ignorando`);
                    }

                    // Determinar resultado
                    let result;
                    if (profit > 0) result = 'win';
                    else if (profit < 0) result = 'loss';
                    else result = 'breakeven';

                    // Crear operaci√≥n
                    const operation = {
                        id: `mt5_${positionId}`,
                        date: operationDate,
                        accountId: mt5Account.id,
                        instrument: symbol,
                        type: type,
                        entry: entryPrice,
                        exit: exitPrice,
                        entryTime: openTimeStr || null,
                        exitTime: closeTimeStr || null,
                        volume: volume,
                        result: result,
                        pl: profit,
                        currency: mt5Account.currency,
                        notes: `Importado de MT5 - Posici√≥n #${positionId}`,
                        imageDatas: [],
                        fees: totalFees,
                        manualPL: profit,
                        session: 'No especificado'
                    };

                    console.log(`‚úÖ Operaci√≥n procesada: ${symbol} ${type} | Date: ${operationDate} | P&L: $${profit} | Fees: $${totalFees}`);

                    // Verificar si ya existe esta operaci√≥n (evitar duplicados)
                    const exists = DB.operations.some(op => op.id === operation.id);
                    if (exists) {
                        console.log(`‚è≠Ô∏è Operaci√≥n #${positionId} ya existe, omitiendo`);
                        skippedCount++;
                        continue;
                    }

                    newOperations.push(operation);

                } catch (error) {
                    console.error('Error procesando fila:', error);
                    skippedCount++;
                }
            }
        }

        if (newOperations.length === 0) {
            showSyncNotification('‚ùå No se pudieron procesar las operaciones del informe', 'error');
            return;
        }

        // Guardar operaciones en DB local primero
        try {
            // Guardar en Dexie (base de datos local)
            await dexieDB.operations.bulkAdd(newOperations);
            DB.operations.push(...newOperations);
            
            console.log(`‚úÖ ${newOperations.length} operaciones guardadas localmente`);

            // Sincronizar con Supabase en segundo plano (sin bloquear)
            if (currentUser) {
                console.log('ÔøΩ Sincronizando con Supabase en segundo plano...');
                
                // Hacer la sincronizaci√≥n de forma as√≠ncrona sin esperar
                setTimeout(async () => {
                    let successCount = 0;
                    let errorCount = 0;

                    for (const operation of newOperations) {
                        try {
                            await saveOperationToSupabase(operation);
                            successCount++;
                        } catch (error) {
                            // Encolar para reintento posterior
                            if (!error.message?.includes('duplicate')) {
                                addToSyncQueue(operation, 'operation');
                                errorCount++;
                            }
                        }
                    }

                    if (successCount > 0) {
                        console.log(`‚úÖ ${successCount} operaciones sincronizadas con Supabase`);
                    }
                    if (errorCount > 0) {
                        console.log(`‚ö†Ô∏è ${errorCount} operaciones encoladas para sincronizaci√≥n posterior`);
                    }
                }, 100);
            }

            // Actualizar vistas inmediatamente con datos locales
            console.log('üìä Actualizando vistas...');
            updateAccountBalances();
            
            // Forzar actualizaci√≥n de todas las vistas
            refreshAllViews();
            
            // Actualizar tambi√©n la vista de operaciones si est√° activa
            if (document.querySelector('.nav-tab.active')?.dataset.target === 'operations') {
                refreshOperationsTable();
            }
            
            // Actualizar dashboard si est√° activo
            if (document.querySelector('.nav-tab.active')?.dataset.target === 'dashboard') {
                refreshDashboard();
            }

            const message = `‚úÖ ${newOperations.length} operaciones importadas a cuenta "${mt5Account.name}"${skippedCount > 0 ? ` (${skippedCount} omitidas)` : ''}`;
            
            showSyncNotification(message, 'success');
            
            console.log(`‚úÖ Importaci√≥n completada: ${newOperations.length} operaciones guardadas en cuenta ${mt5Account.id}, ${skippedCount} omitidas`);
            console.log(`üìç Cuenta: ${mt5Account.name} | Total operaciones en DB: ${DB.operations.length}`);

        } catch (error) {
            console.error('Error guardando operaciones:', error);
            showSyncNotification('‚ùå Error guardando operaciones: ' + error.message, 'error');
        }

    } catch (error) {
        console.error('Error parseando informe MT5:', error);
        showSyncNotification('‚ùå Error procesando informe HTML', 'error');
    }
}

// Funci√≥n para limpiar operaciones MT5 con errores (P&L=0 o comisiones incorrectas)
async function cleanMT5Operations() {
    try {
        console.log('üßπ Iniciando limpieza de operaciones MT5...');

        // Buscar todas las operaciones MT5 (id comienza con mt5_)
        const mt5Operations = DB.operations.filter(op => op.id && op.id.startsWith('mt5_'));

        if (mt5Operations.length === 0) {
            showSyncNotification('‚ÑπÔ∏è No hay operaciones MT5 para limpiar', 'info');
            return;
        }

        console.log(`üìä Encontradas ${mt5Operations.length} operaciones MT5`);

        // Identificar operaciones con problemas
        const problematicOps = mt5Operations.filter(op => {
            // Operaciones con P&L = 0
            const hasZeroPL = op.pl === 0 || op.manualPL === 0;

            // Operaciones con comisiones sospechosamente altas (m√°s del 50% del P&L)
            const hasSuspiciousFees = op.fees && Math.abs(op.pl) > 0 && (op.fees / Math.abs(op.pl)) > 0.5;

            return hasZeroPL || hasSuspiciousFees;
        });

        if (problematicOps.length === 0) {
            showSyncNotification('‚úÖ No se encontraron operaciones MT5 con problemas', 'success');
            return;
        }

        console.log(`‚ùå Encontradas ${problematicOps.length} operaciones con problemas:`, problematicOps);

        // Confirmar con el usuario
        const confirmed = confirm(
            `Se encontraron ${problematicOps.length} operaciones MT5 con problemas:\n\n` +
            `- Operaciones con P&L = 0\n` +
            `- Operaciones con comisiones incorrectas\n\n` +
            `¬øDeseas eliminarlas? Esta acci√≥n no se puede deshacer.`
        );

        if (!confirmed) {
            showSyncNotification('‚ÑπÔ∏è Limpieza cancelada', 'info');
            return;
        }

        // Eliminar operaciones problem√°ticas
        let deletedCount = 0;

        for (const op of problematicOps) {
            try {
                // Eliminar de IndexedDB
                await dexieDB.operations.delete(op.id);

                // Eliminar de Supabase si hay usuario autenticado
                if (currentUser) {
                    await deleteOperationFromSupabase(op.id);
                }

                // Eliminar del array en memoria
                const index = DB.operations.findIndex(o => o.id === op.id);
                if (index !== -1) {
                    DB.operations.splice(index, 1);
                }

                deletedCount++;

            } catch (error) {
                console.error(`Error eliminando operaci√≥n ${op.id}:`, error);
            }
        }

        // Actualizar vistas
        updateAccountBalances();
        refreshAllViews();

        showSyncNotification(
            `‚úÖ Limpieza completada: ${deletedCount} operaciones eliminadas`,
            'success'
        );

        console.log(`‚úÖ Limpieza completada: ${deletedCount} operaciones eliminadas`);

    } catch (error) {
        console.error('Error en limpieza MT5:', error);
        showSyncNotification('‚ùå Error en limpieza: ' + error.message, 'error');
    }
}

// Funci√≥n para convertir trade de BingX al formato de la aplicaci√≥n
function convertBingXTradeToAppFormat(bingxTrade, accountId) {
    // Determinar si fue ganancia o p√©rdida
    const pnl = parseFloat(bingxTrade.profit || 0);
    const result = pnl > 0 ? 'win' : (pnl < 0 ? 'loss' : 'breakeven');

    // Convertir timestamp a fecha usando zona horaria local
    const tradeDateObj = new Date(parseInt(bingxTrade.time));
    const tradeDate = getLocalDateString(tradeDateObj);

    // Extraer hora de entrada y salida
    const entryTime = new Date(parseInt(bingxTrade.time)).toTimeString().split(' ')[0];
    const exitTime = bingxTrade.updateTime ?
        new Date(parseInt(bingxTrade.updateTime)).toTimeString().split(' ')[0] : entryTime;

    return {
        id: `bingx_${bingxTrade.orderId}`,
        date: tradeDate,
        accountId: accountId,
        instrument: bingxTrade.symbol,
        type: bingxTrade.side.toLowerCase(), // 'BUY' -> 'buy', 'SELL' -> 'sell'
        entry: parseFloat(bingxTrade.avgPrice || bingxTrade.price),
        exit: parseFloat(bingxTrade.avgPrice || bingxTrade.price), // Para √≥rdenes ejecutadas
        entryTime: entryTime,
        exitTime: exitTime,
        volume: parseFloat(bingxTrade.origQty),
        result: result,
        pl: pnl,
        fees: Math.abs(parseFloat(bingxTrade.commission || 0)), // Extraer fees de BingX
        currency: 'USDT', // BingX generalmente usa USDT
        notes: `Importado de BingX - Order ID: ${bingxTrade.orderId}`,
        imageDatas: [],
        manualPL: null,
        session: 'No especificado'
    };
}

// Funci√≥n para sincronizar trades desde BingX
async function syncBingXTrades() {
    // 1. Verificar si hay credenciales guardadas en Supabase
    if (!bingxAPI && currentUser) {
        console.log('üîÑ bingxAPI no inicializada, cargando credenciales desde Supabase...');
        const savedCreds = await loadBingXCredentialsFromSupabase();
        
        if (savedCreds && savedCreds.key && savedCreds.secret) {
            console.log('‚úÖ Credenciales encontradas, inicializando bingxAPI...');
            bingxAPI = new BingXAPI(savedCreds.key, savedCreds.secret);
        }
    }

    // 2. Si a√∫n no hay API, mostrar error
    if (!bingxAPI) {
        showSyncNotification('‚ùå Primero debes configurar y guardar tus credenciales de BingX', 'error');
        updateBingXStatus('error', 'No configurado', false);
        return;
    }

    // Buscar cuenta seleccionada en cualquiera de las interfaces
    let selectedAccount = null;
    const accountSelect = document.getElementById('bingx-account');
    const accountDetailSelect = document.getElementById('bingx-account-detail');

    if (accountDetailSelect && accountDetailSelect.value) {
        selectedAccount = accountDetailSelect.value;
    } else if (accountSelect && accountSelect.value) {
        selectedAccount = accountSelect.value;
    } else if (DB.apiKeys.bingx && DB.apiKeys.bingx.accountId) {
        selectedAccount = DB.apiKeys.bingx.accountId;
    }

    if (!selectedAccount) {
        // showSyncNotification('‚ùå Selecciona una cuenta para sincronizar', 'error');
        return;
    }

    showLoading(true);
    updateBingXStatus('syncing', 'Sincronizando...', false);

    try {
        // showSyncNotification('üîÑ Sincronizando trades desde BingX...', 'info');

        // Primero probar con informaci√≥n de cuenta para verificar autenticaci√≥n
        console.log('üîç Verificando autenticaci√≥n con BingX...');
        const accountResponse = await bingxAPI.getAccountInfo();
        console.log('üìä Respuesta de cuenta:', JSON.stringify(accountResponse, null, 2));

        if (accountResponse.code !== 0) {
            throw new Error(`Error de autenticaci√≥n: ${accountResponse.msg}`);
        }

        // Obtener historial de trades
        console.log('üìà Obteniendo historial de trades...');
        const tradesResponse = await bingxAPI.getTradeHistory('', 100); // Reducir a 100 trades
        console.log('üìä Respuesta de trades:', JSON.stringify(tradesResponse, null, 2));

        if (tradesResponse.code !== 0) {
            throw new Error(tradesResponse.msg || 'Error obteniendo trades');
        }

        const bingxTrades = tradesResponse.data?.orders || [];

        // Filtrar solo trades ejecutados
        const executedTrades = bingxTrades.filter(trade =>
            trade.status === 'FILLED' && trade.profit !== undefined
        );

        // Buscar cuenta de BingX en la aplicaci√≥n
        let bingxAccount = DB.accounts.find(acc => acc.platform === 'bingx');

        if (!bingxAccount) {
            // Crear cuenta de BingX autom√°ticamente
            bingxAccount = {
                id: generateId(),
                name: 'BingX - Cuenta Principal',
                currency: 'USDT',
                platform: 'bingx',
                initialBalance: 0,
                balance: 0
            };

            DB.accounts.push(bingxAccount);
            await dexieDB.accounts.add(bingxAccount);

            // Sincronizar con Supabase si est√° conectado
            if (currentUser) {
                await saveAccountToSupabase(bingxAccount);
            }
        }

        // Convertir trades al formato de la aplicaci√≥n
        let newTrades = 0;
        let skippedTrades = 0;

        for (const bingxTrade of executedTrades) {
            const appTrade = convertBingXTradeToAppFormat(bingxTrade, bingxAccount.id);

            // Verificar si el trade ya existe
            const existingTrade = DB.operations.find(op => op.id === appTrade.id);

            if (!existingTrade) {
                // Guardar localmente
                DB.operations.push(appTrade);
                await dexieDB.operations.add(appTrade);

                // Sincronizar con Supabase si est√° conectado
                if (currentUser) {
                    await saveOperationToSupabase(appTrade);
                }

                newTrades++;
            } else {
                skippedTrades++;
            }
        }

        // Actualizar balance de la cuenta si se encontraron nuevos trades
        if (newTrades > 0) {
            updateAccountBalances();
            refreshAllViews();
        }

        const message = `‚úÖ Sincronizaci√≥n completa: ${newTrades} trades nuevos, ${skippedTrades} ya exist√≠an`;
        // showSyncNotification(message, 'success');
        updateBingXStatus('sync', 'Conectado', true);

    } catch (error) {
        console.error('Error sincronizando trades BingX:', error);
        const errorMessage = `‚ùå Error sincronizando: ${error.message}`;
        // showSyncNotification(errorMessage, 'error');
        updateBingXStatus('error', 'Error de sincronizaci√≥n', false);
    } finally {
        showLoading(false);
    }
}

// Funci√≥n para cargar credenciales guardadas
function loadBingXCredentials() {
    console.log('üîç Cargando credenciales BingX...');

    // Primero intentar cargar desde localStorage
    const savedApiKey = localStorage.getItem('bingx-api-key');
    const savedSecretKey = localStorage.getItem('bingx-secret-key');
    const savedAccountId = localStorage.getItem('bingx-account-id');

    console.log('üìÅ Credenciales en localStorage:', {
        apiKey: savedApiKey ? `${savedApiKey.substring(0, 10)}...` : 'No encontrada',
        secretKey: savedSecretKey ? `${savedSecretKey.substring(0, 10)}...` : 'No encontrada',
        accountId: savedAccountId || 'No encontrada'
    });

    // Configurar credenciales proporcionadas por el usuario como respaldo
    const providedApiKey = 'sw8hglph1M6HWzoqswDdjX7YTh3mcruPKynFi1ZBz8zDXCHxnEchw7oRWgYysFVLFuD7bkYomRHxSh8gdtNBg';
    const providedSecretKey = '7hUYF1GhJ6QixdE2mfDEdDMovcKVpUc3OnqbAfiAcbrT6XzFfMF4ywd0K06JgJCt0Zsa6MYxuSslDKr5XJfYA';

    // Verificar si existen los elementos antes de actualizar
    const bingxApiKeyEl = document.getElementById('bingx-api-key');
    const bingxSecretEl = document.getElementById('bingx-api-secret');

    // Usar credenciales guardadas o las proporcionadas
    const apiKeyToUse = savedApiKey || providedApiKey;
    const secretKeyToUse = savedSecretKey || providedSecretKey;
    const accountIdToUse = savedAccountId || 'main';

    console.log('üíæ Cargando credenciales en campos...');

    if (bingxApiKeyEl) {
        bingxApiKeyEl.value = apiKeyToUse;
        console.log('‚úÖ API Key cargada en campo b√°sico');
    }
    if (bingxSecretEl) {
        bingxSecretEl.value = secretKeyToUse;
        console.log('‚úÖ Secret Key cargada en campo b√°sico');
    }

    // Actualizar DB
    DB.apiKeys.bingx = {
        key: apiKeyToUse,
        secret: secretKeyToUse,
        mode: 'real',
    };

    // Intentar reconectar autom√°ticamente
    if (DB.apiKeys.bingx && DB.apiKeys.bingx.key && DB.apiKeys.bingx.secret) {
        bingxAPI = new BingXAPI(DB.apiKeys.bingx.key, DB.apiKeys.bingx.secret);
        console.log('üîó BingX API reconectada autom√°ticamente');

        // Poblar cuentas cuando se reconecta
        populateBingXAccounts();

        // Actualizar estado visual
        setTimeout(() => {
            updateBingXStatus('connected', 'Credenciales cargadas', true);
        }, 500);
    }
}

// Funci√≥n para verificar el estado del proxy
async function checkProxyStatus() {
    try {
        const proxyCheckUrl = window.PROXY_URL || 'http://127.0.0.1:8003';
        const response = await fetch(`${proxyCheckUrl}/health`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            console.log('‚úÖ Servidor proxy BingX funcionando correctamente');
            return true;
        } else {
            console.warn('‚ö†Ô∏è Servidor proxy BingX no responde correctamente');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error conectando al servidor proxy BingX:', error);
        // Notificaci√≥n eliminada - no molestar al usuario
        return false;
    }
}

// Event listeners para BingX
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando BingX - DOMContentLoaded');

    // CARGAR CREDENCIALES INMEDIATAMENTE
    loadBingXCredentials();
    loadBingXCredentialsInDetail();

    // Verificar proxy y cargar credenciales al inicio
    setTimeout(async () => {
        console.log('üîÑ Verificando proxy y recargando credenciales...');
        const proxyOk = await checkProxyStatus();

        // VOLVER A CARGAR CREDENCIALES DESPU√âS DE VERIFICAR PROXY
        loadBingXCredentials();
        loadBingXCredentialsInDetail();
        loadLastSyncInfo();
        updateBingXDetailStatus();

        if (proxyOk) {
            console.log('BingX: Sistema inicializado correctamente');
        }
        // No mostrar mensaje si el proxy no est√° disponible

        // TERCER INTENTO DE CARGA DESPU√âS DE 2 SEGUNDOS M√ÅS
        setTimeout(() => {
            console.log('üîÑ Carga final de credenciales...');
            loadBingXCredentials();
            loadBingXCredentialsInDetail();
        }, 2000);

    }, 1000);

    // Event listeners (verificar si existen los elementos)
    const bingxTestBtn = document.getElementById('test-bingx-connection-detail');
    const bingxConnectBtn = document.getElementById('connect-bingx-detail');
    const bingxSyncBtn = document.getElementById('sync-bingx-trades-detail');

    // Event listeners para campos de credenciales - guardar autom√°ticamente
    const apiKeyDetail = document.getElementById('bingx-api-key-detail');
    const secretKeyDetail = document.getElementById('bingx-secret-key-detail');
    const apiKeyOld = document.getElementById('bingx-api-key');
    const secretKeyOld = document.getElementById('bingx-api-secret');

    // Funci√≥n para guardar credenciales autom√°ticamente
    const saveCredentialsAuto = async () => {
        const apiKey = (apiKeyDetail?.value || apiKeyOld?.value || '').trim();
        const secretKey = (secretKeyDetail?.value || secretKeyOld?.value || '').trim();

        if (apiKey && secretKey) {
            console.log('üíæ Auto-guardando credenciales...');
            try {
                // Guardar en localStorage inmediatamente
                localStorage.setItem('bingx-api-key', apiKey);
                localStorage.setItem('bingx-secret-key', secretKey);
                localStorage.setItem('bingx-account-id', 'main');
                localStorage.setItem('bingx-last-auto-save', Date.now().toString());

                // Guardar en DB tambi√©n
                DB.apiKeys.bingx = { key: apiKey, secret: secretKey, mode: 'real', accountId: 'main' };
                await dexieDB.generalData.put({ key: 'apiKeys', value: DB.apiKeys });

                console.log('‚úÖ Credenciales auto-guardadas');
            } catch (error) {
                console.error('‚ùå Error auto-guardando:', error);
            }
        }
    };

    // Agregar listeners a todos los campos de credenciales
    if (apiKeyDetail) {
        apiKeyDetail.addEventListener('input', saveCredentialsAuto);
        apiKeyDetail.addEventListener('blur', saveCredentialsAuto);
    }
    if (secretKeyDetail) {
        secretKeyDetail.addEventListener('input', saveCredentialsAuto);
        secretKeyDetail.addEventListener('blur', saveCredentialsAuto);
    }
    if (apiKeyOld) {
        apiKeyOld.addEventListener('input', saveCredentialsAuto);
        apiKeyOld.addEventListener('blur', saveCredentialsAuto);
    }
    if (secretKeyOld) {
        secretKeyOld.addEventListener('input', saveCredentialsAuto);
        secretKeyOld.addEventListener('blur', saveCredentialsAuto);
    }

    if (bingxTestBtn) bingxTestBtn.addEventListener('click', testBingXConnection);
    if (bingxConnectBtn) bingxConnectBtn.addEventListener('click', connectBingX);
    if (bingxSyncBtn) bingxSyncBtn.addEventListener('click', syncBingXTrades);

    // Event listener for quick sync button on platform card
    const bingxQuickSyncBtn = document.getElementById('bingx-quick-sync');
    if (bingxQuickSyncBtn) {
        bingxQuickSyncBtn.addEventListener('click', async (e) => {
            e.stopPropagation(); // Prevent card click event
            console.log('üöÄ Quick sync iniciado desde plataforma');

            // Disable button and show loading state
            const originalText = bingxQuickSyncBtn.innerHTML;
            bingxQuickSyncBtn.disabled = true;
            bingxQuickSyncBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span>Sync...</span>';
            bingxQuickSyncBtn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                await syncBingXTrades();
            } finally {
                // Restore button state
                setTimeout(() => {
                    bingxQuickSyncBtn.disabled = false;
                    bingxQuickSyncBtn.innerHTML = originalText;
                    bingxQuickSyncBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 1000);
            }
        });
    }

    // Event listener for CSV import button
    const bingxImportCsvBtn = document.getElementById('bingx-import-csv');
    if (bingxImportCsvBtn) {
        bingxImportCsvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importBingXCSV();
        });
    }

    // Event listener for MEXC quick sync button
    const mexcQuickSyncBtn = document.getElementById('mexc-quick-sync');
    if (mexcQuickSyncBtn) {
        mexcQuickSyncBtn.addEventListener('click', async (e) => {
            e.stopPropagation(); // Prevent card click event
            console.log('üöÄ Quick sync MEXC iniciado desde plataforma');

            // Check if connected
            if (!mexcAPI) {
                showSyncNotification('‚ùå Primero configura las credenciales API de MEXC', 'error');
                showPlatformDetail('mexc'); // Open MEXC panel to configure
                return;
            }

            // Disable button and show loading state
            const originalText = mexcQuickSyncBtn.innerHTML;
            mexcQuickSyncBtn.disabled = true;
            mexcQuickSyncBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span>Sync...</span>';
            mexcQuickSyncBtn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                await syncMEXCTrades();
            } finally {
                // Restore button state
                setTimeout(() => {
                    mexcQuickSyncBtn.disabled = false;
                    mexcQuickSyncBtn.innerHTML = originalText;
                    mexcQuickSyncBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 1000);
            }
        });
    }

    // Event listener para bot√≥n CSV de MEXC en tarjeta
    const mexcImportCsvCardBtn = document.getElementById('mexc-import-csv');
    if (mexcImportCsvCardBtn) {
        mexcImportCsvCardBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importMEXCCSV(); // Usar la funci√≥n espec√≠fica de MEXC
        });
    }

    // Event listener for NinjaTrader CSV import button
    const ninjaImportCsvBtn = document.getElementById('ninjatrader-import-csv');
    if (ninjaImportCsvBtn) {
        ninjaImportCsvBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            console.log('üì• Importaci√≥n CSV de NinjaTrader iniciada');
            importNinjaTraderCSV();
        });
    }

    // Event listener for NinjaTrader quick sync button
    const ninjaQuickSyncBtn = document.getElementById('ninjatrader-quick-sync');
    if (ninjaQuickSyncBtn) {
        ninjaQuickSyncBtn.addEventListener('click', async (e) => {
            e.stopPropagation(); // Prevent card click event
            console.log('üöÄ Sincronizaci√≥n de NinjaTrader iniciada');
            showNinjaTraderSyncModal();
        });
    }

    // Event listener for Tradovate CSV import button
    const tradovateImportCsvBtn = document.getElementById('tradovate-import-csv');
    if (tradovateImportCsvBtn) {
        tradovateImportCsvBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            console.log('üì• Importaci√≥n CSV de Tradovate iniciada');
            importTradovateCSV();
        });
    }

    // Event listener para bot√≥n CSV de PrimeXBT
    const primexbtImportCsvBtn = document.getElementById('primexbt-import-csv');
    if (primexbtImportCsvBtn) {
        primexbtImportCsvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importPrimeXBTCSV();
        });
    }

    // Event listeners para botones CSV de PrimeXBT Crypto y CFDs
    const primexbtCryptoImportCsvBtn = document.getElementById('primexbt-crypto-import-csv');
    if (primexbtCryptoImportCsvBtn) {
        primexbtCryptoImportCsvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importPrimeXBTCSV();
        });
    }

    // Event listener para bot√≥n de importar desde interfaz de PrimeXBT Crypto
    const primexbtCryptoImportInterfaceBtn = document.getElementById('primexbt-crypto-import-interface');
    if (primexbtCryptoImportInterfaceBtn) {
        primexbtCryptoImportInterfaceBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openPrimeXBTInterfaceModal();
        });
    }

    const primexbtCfdsImportCsvBtn = document.getElementById('primexbt-cfds-import-csv');
    if (primexbtCfdsImportCsvBtn) {
        primexbtCfdsImportCsvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importPrimeXBTCFDsCSV(); // Usar funci√≥n espec√≠fica para CFDs
        });
    }

    // Event listener para bot√≥n HTML de MetaTrader 5
    const mt5ImportHtmlBtn = document.getElementById('mt5-import-html');
    if (mt5ImportHtmlBtn) {
        mt5ImportHtmlBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importMT5HTMLReport();
        });
    }

    // Event listener para bot√≥n de limpieza MT5
    const mt5CleanBtn = document.getElementById('mt5-clean-operations');
    if (mt5CleanBtn) {
        mt5CleanBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            cleanMT5Operations();
        });
    }

    // Event listener para bot√≥n HTML de MetaTrader 4
    const mt4ImportHtmlBtn = document.getElementById('mt4-import-html');
    if (mt4ImportHtmlBtn) {
        mt4ImportHtmlBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importMT5HTMLReport(); // Usar la misma funci√≥n que MT5
        });
    }

    // Event listener para bot√≥n de limpieza MT4
    const mt4CleanBtn = document.getElementById('mt4-clean-operations');
    if (mt4CleanBtn) {
        mt4CleanBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            cleanMT5Operations(); // Usar la misma funci√≥n que MT5
        });
    }

    // Event listener para bot√≥n HTML de cTrader
    const ctraderImportHtmlBtn = document.getElementById('ctrader-import-html');
    if (ctraderImportHtmlBtn) {
        ctraderImportHtmlBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importCTraderHTML();
        });
    }

    // ============================================
    // EVENT LISTENERS PARA cTrader
    // ============================================
    
    console.log('üîß Inicializando event listeners de cTrader con delegaci√≥n...');
    
    // Usar delegaci√≥n de eventos en el document para que funcione incluso si el elemento no existe a√∫n
    document.addEventListener('click', (e) => {
        // Importar archivo HTML
        if (e.target.id === 'ctrader-import-csv-btn' || e.target.closest('#ctrader-import-csv-btn')) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üéØ IMPORTACI√ìN CTRADER HTML INICIADA');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            const ctraderFileInput = document.getElementById('ctrader-csv-file-input');
            const file = ctraderFileInput?.files[0];
            
            if (!file) {
                console.error('‚ùå PASO 1 FALLIDO: No se seleccion√≥ ning√∫n archivo');
                showSyncNotification('‚ö†Ô∏è Por favor selecciona un archivo HTML primero', 'warning');
                return;
            }
            
            console.log('‚úÖ PASO 1: Archivo seleccionado');
            console.log('   üìÅ Nombre:', file.name);
            console.log('   üìä Tama√±o:', (file.size / 1024).toFixed(2), 'KB');
            console.log('   üìù Tipo:', file.type || 'desconocido');
            
            const accountSelect = document.getElementById('ctrader-account-select');
            const selectedAccountId = accountSelect?.value;
            
            if (!selectedAccountId) {
                console.error('‚ùå PASO 2 FALLIDO: No se seleccion√≥ cuenta');
                showSyncNotification('‚ö†Ô∏è Por favor selecciona una cuenta destino', 'warning');
                return;
            }
            
            const account = DB.accounts.find(acc => acc.id === selectedAccountId);
            if (!account) {
                console.error('‚ùå PASO 2 FALLIDO: Cuenta no encontrada en DB');
                console.error('   ID buscado:', selectedAccountId);
                console.error('   Cuentas disponibles:', DB.accounts.map(a => ({id: a.id, name: a.name})));
                showSyncNotification('‚ùå La cuenta seleccionada no existe', 'error');
                return;
            }
            
            console.log('‚úÖ PASO 2: Cuenta destino validada');
            console.log('   üë§ ID:', selectedAccountId);
            console.log('   üìù Nombre:', account.name);
            console.log('   üí± Divisa:', account.currency);
            
            console.log('üîÑ PASO 3: Leyendo archivo...');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    console.log('‚úÖ Archivo le√≠do exitosamente');
                    console.log('   üìÑ Caracteres:', content.length);
                    console.log('   üìù Primeros 100 caracteres:', content.substring(0, 100));
                    
                    const isHTML = file.name.toLowerCase().endsWith('.html') || 
                                   file.name.toLowerCase().endsWith('.htm') ||
                                   content.trim().startsWith('<!DOCTYPE') ||
                                   content.trim().startsWith('<html');
                    
                    if (!isHTML) {
                        console.error('‚ùå PASO 4 FALLIDO: No es un archivo HTML v√°lido');
                        console.error('   Extensi√≥n del archivo:', file.name.split('.').pop());
                        console.error('   Inicio del contenido:', content.substring(0, 50));
                        showSyncNotification('‚ö†Ô∏è Solo se aceptan archivos HTML Statement de cTrader (.html o .htm)', 'warning');
                        return;
                    }
                    
                    console.log('‚úÖ PASO 4: Archivo HTML v√°lido');
                    console.log('üîÑ PASO 5: Parseando operaciones...');
                    
                    const result = parseCTraderHTML(content);
                    
                    console.log('‚úÖ PASO 5: Parseo completado');
                    console.log('   üìä Operaciones extra√≠das:', result.operations.length);
                    console.log('   üí± Divisa detectada:', result.accountInfo.currency);
                    console.log('   üÜî N√∫mero de cuenta:', result.accountInfo.number);
                    
                    if (result.operations.length > 0) {
                        console.log('   üîç Primera operaci√≥n:', result.operations[0]);
                    }
                    
                    if (result.operations.length === 0) {
                        console.warn('‚ö†Ô∏è ADVERTENCIA: No se encontraron operaciones');
                        showSyncNotification('‚ö†Ô∏è No se encontraron operaciones en el archivo HTML', 'warning');
                        return;
                    }
                    
                    console.log('üîÑ PASO 6: Mostrando vista previa...');
                    showCTraderPreview(result.operations, selectedAccountId);
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                } catch (error) {
                    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.error('‚ùå ERROR EN EL PARSEO');
                    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.error('Mensaje:', error.message);
                    console.error('Stack:', error.stack);
                    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = (error) => {
                console.error('‚ùå Error al leer el archivo:', error);
                showSyncNotification('‚ùå Error al leer el archivo', 'error');
            };
            
            reader.readAsText(file);
        }
        
        // Confirmar importaci√≥n
        if (e.target.id === 'ctrader-confirm-import-btn' || e.target.closest('#ctrader-confirm-import-btn')) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('‚úÖ Click en confirmar importaci√≥n cTrader (delegaci√≥n)');
            confirmCTraderImport();
        }
    });
    
    console.log('‚úÖ Event listeners de cTrader configurados con delegaci√≥n de eventos');

    // ============================================
    // EVENT LISTENERS PARA MODAL DE INTERFAZ PRIMEXBT
    // ============================================

    // Funci√≥n para abrir el modal de importaci√≥n desde interfaz
    function openPrimeXBTInterfaceModal() {
        const modal = document.getElementById('primexbt-interface-import-modal');
        const accountSelect = document.getElementById('primexbt-interface-account');
        const dataTextarea = document.getElementById('primexbt-interface-data');
        const statusDiv = document.getElementById('primexbt-interface-status');
        
        // Limpiar campos
        dataTextarea.value = '';
        statusDiv.textContent = '';
        statusDiv.className = 'text-sm text-center';
        
        // Cargar cuentas de PrimeXBT Crypto
        accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';
        const primexbtAccounts = DB.accounts.filter(acc => 
            acc.platform === 'primexbt-crypto' || acc.platform === 'primexbt'
        );
        
        if (primexbtAccounts.length === 0) {
            accountSelect.innerHTML += '<option value="" disabled>No hay cuentas de PrimeXBT disponibles</option>';
        } else {
            primexbtAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (${acc.currency})`;
                accountSelect.appendChild(option);
            });
        }
        
        // Mostrar modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Focus en el textarea
        setTimeout(() => dataTextarea.focus(), 100);
    }

    // Event listener para cerrar el modal (bot√≥n X)
    const primexbtInterfaceCloseBtn = document.getElementById('primexbt-interface-close-btn');
    if (primexbtInterfaceCloseBtn) {
        primexbtInterfaceCloseBtn.addEventListener('click', () => {
            const modal = document.getElementById('primexbt-interface-import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    }

    // Event listener para bot√≥n Cancelar
    const primexbtInterfaceCancelBtn = document.getElementById('primexbt-interface-cancel-btn');
    if (primexbtInterfaceCancelBtn) {
        primexbtInterfaceCancelBtn.addEventListener('click', () => {
            const modal = document.getElementById('primexbt-interface-import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    }

    // Event listener para bot√≥n Importar
    console.log('üîç Configurando bot√≥n de importar PrimeXBT Interface...');
    
    // Usar delegaci√≥n de eventos en el contenedor del modal
    const primexbtModal = document.getElementById('primexbt-interface-import-modal');
    if (primexbtModal) {
        primexbtModal.addEventListener('click', async (e) => {
            // Verificar si el click fue en el bot√≥n de importar o sus hijos
            const importBtn = e.target.closest('#primexbt-interface-import-btn');
            if (importBtn) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üñ±Ô∏è Click detectado en bot√≥n importar PrimeXBT Interface');
                
                if (typeof window.handlePrimeXBTInterfaceImport === 'function') {
                    await window.handlePrimeXBTInterfaceImport();
                } else {
                    console.error('‚ùå handlePrimeXBTInterfaceImport no est√° definida');
                    alert('Error: La funci√≥n de importaci√≥n no est√° disponible. Recarga la p√°gina (Ctrl+F5)');
                }
            }
        });
        console.log('‚úÖ Event listener bot√≥n importar PrimeXBT Interface agregado con delegaci√≥n');
    } else {
        console.warn('‚ö†Ô∏è Modal primexbt-interface-import-modal no encontrado');
    }

    // ============================================
    // EVENT LISTENERS PARA BITGET
    // ============================================

    // Funci√≥n para abrir el modal de importaci√≥n desde interfaz de Bitget
    function openBitgetInterfaceModal() {
        const modal = document.getElementById('bitget-interface-import-modal');
        const accountSelect = document.getElementById('bitget-interface-account');
        const dataTextarea = document.getElementById('bitget-interface-data');
        const statusDiv = document.getElementById('bitget-interface-status');
        
        // Limpiar campos
        dataTextarea.value = '';
        statusDiv.textContent = '';
        statusDiv.className = 'text-sm text-center';
        
        // Cargar cuentas de Bitget
        accountSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>';
        const bitgetAccounts = DB.accounts.filter(acc => 
            acc.platform === 'bitget' || acc.broker === 'Bitget'
        );
        
        if (bitgetAccounts.length === 0) {
            accountSelect.innerHTML += '<option value="" disabled>No hay cuentas de Bitget disponibles</option>';
        } else {
            bitgetAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (${acc.currency})`;
                accountSelect.appendChild(option);
            });
        }
        
        // Mostrar modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Focus en el textarea
        setTimeout(() => dataTextarea.focus(), 100);
    }

    // Event listener para bot√≥n que abre el modal
    const bitgetInterfaceOpenBtn = document.getElementById('bitget-interface-import-btn');
    if (bitgetInterfaceOpenBtn) {
        bitgetInterfaceOpenBtn.addEventListener('click', () => {
            openBitgetInterfaceModal();
        });
    }

    // Event listener para cerrar el modal (bot√≥n X)
    const bitgetInterfaceCloseBtn = document.getElementById('bitget-interface-close-btn');
    if (bitgetInterfaceCloseBtn) {
        bitgetInterfaceCloseBtn.addEventListener('click', () => {
            const modal = document.getElementById('bitget-interface-import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    }

    // Event listener para bot√≥n Cancelar
    const bitgetInterfaceCancelBtn = document.getElementById('bitget-interface-cancel-btn');
    if (bitgetInterfaceCancelBtn) {
        bitgetInterfaceCancelBtn.addEventListener('click', () => {
            const modal = document.getElementById('bitget-interface-import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    }

    // Event listener para bot√≥n Importar
    const bitgetInterfaceImportBtn = document.getElementById('bitget-interface-import-btn-modal');
    if (bitgetInterfaceImportBtn) {
        bitgetInterfaceImportBtn.addEventListener('click', async () => {
            const accountSelect = document.getElementById('bitget-interface-account');
            const dataTextarea = document.getElementById('bitget-interface-data');
            const statusDiv = document.getElementById('bitget-interface-status');
            
            const accountId = accountSelect.value;
            const rawData = dataTextarea.value.trim();
            
            // Validar datos
            if (!accountId) {
                statusDiv.textContent = '‚ùå Debes seleccionar una cuenta destino';
                statusDiv.className = 'text-sm text-center text-red';
                return;
            }
            
            if (!rawData) {
                statusDiv.textContent = '‚ùå Debes pegar los datos de las operaciones';
                statusDiv.className = 'text-sm text-center text-red';
                return;
            }
            
            // Mostrar indicador de procesamiento
            statusDiv.textContent = '‚è≥ Procesando operaciones...';
            statusDiv.className = 'text-sm text-center text-yellow';
            bitgetInterfaceImportBtn.disabled = true;
            bitgetInterfaceImportBtn.textContent = 'Procesando...';
            
            try {
                // Procesar los datos
                await processBitgetInterfaceData(rawData, accountId);
                
                // Restablecer bot√≥n
                bitgetInterfaceImportBtn.disabled = false;
                bitgetInterfaceImportBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Importar Operaciones';
                
            } catch (error) {
                console.error('Error al importar:', error);
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'text-sm text-center text-red';
                
                // Restablecer bot√≥n
                bitgetInterfaceImportBtn.disabled = false;
                bitgetInterfaceImportBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Importar Operaciones';
            }
        });
    }

    // Cerrar modal al hacer clic fuera de √©l
    const bitgetInterfaceModal = document.getElementById('bitget-interface-import-modal');
    if (bitgetInterfaceModal) {
        bitgetInterfaceModal.addEventListener('click', (e) => {
            if (e.target === bitgetInterfaceModal) {
                bitgetInterfaceModal.classList.add('hidden');
                bitgetInterfaceModal.classList.remove('flex');
            }
        });
    }

    // Event listener para bot√≥n CSV de Bitget (en tarjeta)
    const bitgetImportCsvBtn = document.getElementById('bitget-import-csv');
    if (bitgetImportCsvBtn) {
        bitgetImportCsvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            importBitgetCSV();
        });
    }

    // Event listener para bot√≥n de sincronizaci√≥n API de Bitget (en tarjeta)
    const bitgetQuickSyncBtn = document.getElementById('bitget-quick-sync');
    if (bitgetQuickSyncBtn) {
        bitgetQuickSyncBtn.addEventListener('click', async (e) => {
            e.stopPropagation();

            if (!bitgetAPI) {
                showSyncNotification('‚ùå Primero debes configurar las credenciales API en el panel de Bitget', 'error');
                // Abrir panel de detalles de Bitget
                showPlatformDetail('bitget');
                return;
            }

            await syncBitgetTrades();
        });
    }

    // Event listener para bot√≥n GUARDAR CREDENCIALES en panel de detalles
    const saveBitgetCredentialsBtn = document.getElementById('save-bitget-credentials');
    if (saveBitgetCredentialsBtn) {
        saveBitgetCredentialsBtn.addEventListener('click', async () => {
            const apiKeyInput = document.getElementById('bitget-api-key-detail');
            const secretKeyInput = document.getElementById('bitget-secret-key-detail');
            const passphraseInput = document.getElementById('bitget-passphrase-detail');
            const accountSelect = document.getElementById('bitget-account-detail');

            const apiKey = apiKeyInput?.value.trim();
            const secretKey = secretKeyInput?.value.trim();
            const passphrase = passphraseInput?.value.trim();
            const accountId = accountSelect?.value;

            if (!apiKey || !secretKey || !passphrase) {
                showSyncNotification('‚ùå Ingresa API Key, Secret y Passphrase', 'error');
                return;
            }

            if (!accountId) {
                showSyncNotification('‚ùå Selecciona una cuenta', 'error');
                return;
            }

            try {
                // 1. Guardar en Supabase PRIMERO (persistencia en la nube)
                if (currentUser) {
                    try {
                        console.log('üíæ Guardando credenciales Bitget en Supabase...');
                        await saveBitgetCredentialsToSupabase(apiKey, secretKey, passphrase, accountId);
                        console.log('‚úÖ Credenciales Bitget guardadas en Supabase');
                    } catch (error) {
                        console.error('‚ö†Ô∏è Error guardando credenciales en Supabase:', error);
                        showSyncNotification('‚ö†Ô∏è Error guardando en Supabase: ' + error.message, 'error');
                        return; // No continuar si falla Supabase
                    }
                } else {
                    showSyncNotification('‚ö†Ô∏è Debes iniciar sesi√≥n para guardar credenciales', 'error');
                    return;
                }

                // 2. Guardar en localStorage (cache local)
                localStorage.setItem('bitget_api_key', apiKey);
                localStorage.setItem('bitget_secret_key', secretKey);
                localStorage.setItem('bitget_passphrase', passphrase);
                localStorage.setItem('bitget_account_id', accountId);

                // 3. Guardar en IndexedDB
                const credentials = {
                    id: 'bitget',
                    key: apiKey,
                    secret: secretKey,
                    passphrase: passphrase,
                    accountId: accountId,
                    platform: 'bitget'
                };
                DB.apiKeys.bitget = credentials;
                await dexieDB.apiKeys.put(credentials);

                // 4. Crear instancia de la API con las credenciales guardadas
                if (window.FORCE_OFFLINE_BITGET) {
                    bitgetAPI = new MockBitgetAPI();
                } else {
                    bitgetAPI = new BitgetAPI(apiKey, secretKey, passphrase);
                }

                // 5. Probar conexi√≥n autom√°ticamente
                try {
                    console.log('üîå Probando conexi√≥n con Bitget...');
                    await bitgetAPI.testConnection();
                    showSyncNotification('‚úÖ Credenciales guardadas y conexi√≥n verificada', 'success');
                    updateBitgetStatus('connected', 'Conectado ‚úì', false);
                } catch (testError) {
                    console.error('‚ö†Ô∏è Error probando conexi√≥n:', testError);
                    showSyncNotification('‚ö†Ô∏è Credenciales guardadas pero conexi√≥n fall√≥: ' + testError.message, 'warning');
                    updateBitgetStatus('warning', 'Guardado - Conexi√≥n fallida', false);
                }
            } catch (error) {
                console.error('Error guardando credenciales:', error);
                showSyncNotification('‚ùå Error: ' + error.message, 'error');
            }
        });
    }

    // Event listener para bot√≥n Probar Conexi√≥n
    const testBitgetConnectionBtn = document.getElementById('test-bitget-connection-detail');
    if (testBitgetConnectionBtn) {
        testBitgetConnectionBtn.addEventListener('click', async () => {
            const apiKeyInput = document.getElementById('bitget-api-key-detail');
            const secretKeyInput = document.getElementById('bitget-secret-key-detail');
            const passphraseInput = document.getElementById('bitget-passphrase-detail');

            const apiKey = apiKeyInput?.value.trim();
            const secretKey = secretKeyInput?.value.trim();
            const passphrase = passphraseInput?.value.trim();

            if (!apiKey || !secretKey || !passphrase) {
                showSyncNotification('‚ùå Ingresa todas las credenciales', 'error');
                return;
            }

            try {
                const testAPI = window.FORCE_OFFLINE_BITGET ? new MockBitgetAPI() : new BitgetAPI(apiKey, secretKey, passphrase);
                const result = await testAPI.testConnection();

                showSyncNotification('‚úÖ Conexi√≥n exitosa a Bitget', 'success');
                console.log('Test de conexi√≥n exitoso:', result);
            } catch (error) {
                console.error('Error en test de conexi√≥n:', error);
                showSyncNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        });
    }

    // Event listener para bot√≥n Sincronizar Trades
    const syncBitgetTradesBtn = document.getElementById('sync-bitget-trades-detail');
    if (syncBitgetTradesBtn) {
        syncBitgetTradesBtn.addEventListener('click', async () => {
            await syncBitgetTrades();
        });
    }

    // Event listener para importar CSV desde panel de detalles
    const bitgetCsvBtn = document.getElementById('bitget-import-csv-btn');
    if (bitgetCsvBtn) {
        bitgetCsvBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('bitget-csv-file-input');
            const file = fileInput?.files[0];

            if (!file) {
                showSyncNotification('‚ùå Selecciona un archivo CSV primero', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await processBitgetCSV(e.target.result);
                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    showSyncNotification('‚ùå Error procesando CSV', 'error');
                }
            };
            reader.readAsText(file);
        });
    }

    // Event listener para bot√≥n Volver de BingX
    const bingxBackBtn = document.getElementById('back-to-platforms-bingx');
    if (bingxBackBtn) {
        bingxBackBtn.addEventListener('click', () => {
            showSection('platforms');
        });
    }

    // Event listener para bot√≥n Volver de Bitget
    const bitgetBackBtn = document.getElementById('back-to-platforms-bitget');
    if (bitgetBackBtn) {
        bitgetBackBtn.addEventListener('click', () => {
            showSection('platforms');
        });
    }

    // ============================================
    // BINGX - EVENT LISTENER GUARDAR CREDENCIALES
    // ============================================
    
    const saveBingXCredentialsBtn = document.getElementById('save-bingx-credentials');
    if (saveBingXCredentialsBtn) {
        saveBingXCredentialsBtn.addEventListener('click', async () => {
            const apiKeyInput = document.getElementById('bingx-api-key-detail');
            const secretKeyInput = document.getElementById('bingx-secret-key-detail');
            const accountSelect = document.getElementById('bingx-account-detail');

            const apiKey = apiKeyInput?.value.trim();
            const secretKey = secretKeyInput?.value.trim();
            const accountId = accountSelect?.value;

            if (!apiKey || !secretKey) {
                showSyncNotification('‚ùå Ingresa API Key y Secret', 'error');
                return;
            }

            if (!accountId) {
                showSyncNotification('‚ùå Selecciona una cuenta', 'error');
                return;
            }

            try {
                // 1. Guardar en Supabase PRIMERO
                if (currentUser) {
                    try {
                        console.log('üíæ Guardando credenciales BingX en Supabase...');
                        await saveBingXCredentialsToSupabase(apiKey, secretKey, accountId);
                        console.log('‚úÖ Credenciales BingX guardadas en Supabase');
                    } catch (error) {
                        console.error('‚ö†Ô∏è Error guardando credenciales en Supabase:', error);
                        showSyncNotification('‚ö†Ô∏è Error guardando en Supabase: ' + error.message, 'error');
                        return;
                    }
                } else {
                    showSyncNotification('‚ö†Ô∏è Debes iniciar sesi√≥n para guardar credenciales', 'error');
                    return;
                }

                // 2. Guardar en localStorage
                localStorage.setItem('bingx_api_key', apiKey);
                localStorage.setItem('bingx_api_secret', secretKey);
                localStorage.setItem('bingx_account_id', accountId);

                // 3. Guardar en IndexedDB
                const credentials = {
                    id: 'bingx',
                    key: apiKey,
                    secret: secretKey,
                    accountId: accountId,
                    platform: 'bingx'
                };
                DB.apiKeys.bingx = credentials;
                await dexieDB.apiKeys.put(credentials);

                // 4. Crear instancia de la API
                bingxAPI = new BingXAPI(apiKey, secretKey);

                // 5. Probar conexi√≥n autom√°ticamente
                try {
                    console.log('üîå Probando conexi√≥n con BingX...');
                    await bingxAPI.testConnection();
                    showSyncNotification('‚úÖ Credenciales guardadas y conexi√≥n verificada', 'success');
                    updateBingXStatus('connected', 'Conectado ‚úì', false);
                } catch (testError) {
                    console.error('‚ö†Ô∏è Error probando conexi√≥n:', testError);
                    showSyncNotification('‚ö†Ô∏è Credenciales guardadas pero conexi√≥n fall√≥: ' + testError.message, 'warning');
                    updateBingXStatus('warning', 'Guardado - Conexi√≥n fallida', false);
                }
            } catch (error) {
                console.error('Error guardando credenciales:', error);
                showSyncNotification('‚ùå Error: ' + error.message, 'error');
            }
        });
    }

    // ============================================
    // MEXC - EVENT LISTENER GUARDAR CREDENCIALES
    // ============================================
    
    const saveMEXCCredentialsBtn = document.getElementById('save-mexc-credentials');
    if (saveMEXCCredentialsBtn) {
        saveMEXCCredentialsBtn.addEventListener('click', async () => {
            const apiKeyInput = document.getElementById('mexc-api-key-detail');
            const secretKeyInput = document.getElementById('mexc-secret-key-detail');
            const accountSelect = document.getElementById('mexc-account-detail');

            const apiKey = apiKeyInput?.value.trim();
            const secretKey = secretKeyInput?.value.trim();
            const accountId = accountSelect?.value;

            if (!apiKey || !secretKey) {
                showSyncNotification('‚ùå Ingresa API Key y Secret', 'error');
                return;
            }

            if (!accountId) {
                showSyncNotification('‚ùå Selecciona una cuenta', 'error');
                return;
            }

            try {
                // 1. Guardar en Supabase PRIMERO
                if (currentUser) {
                    try {
                        console.log('üíæ Guardando credenciales MEXC en Supabase...');
                        await saveMEXCCredentialsToSupabase(apiKey, secretKey, accountId);
                        console.log('‚úÖ Credenciales MEXC guardadas en Supabase');
                    } catch (error) {
                        console.error('‚ö†Ô∏è Error guardando credenciales en Supabase:', error);
                        showSyncNotification('‚ö†Ô∏è Error guardando en Supabase: ' + error.message, 'error');
                        return;
                    }
                } else {
                    showSyncNotification('‚ö†Ô∏è Debes iniciar sesi√≥n para guardar credenciales', 'error');
                    return;
                }

                // 2. Guardar en localStorage
                localStorage.setItem('mexc_api_key', apiKey);
                localStorage.setItem('mexc_api_secret', secretKey);
                localStorage.setItem('mexc_account_id', accountId);

                // 3. Guardar en IndexedDB
                const credentials = {
                    id: 'mexc',
                    key: apiKey,
                    secret: secretKey,
                    accountId: accountId,
                    platform: 'mexc'
                };
                DB.apiKeys.mexc = credentials;
                await dexieDB.apiKeys.put(credentials);

                // 4. Crear instancia de la API
                mexcAPI = new MEXCAPI(apiKey, secretKey);

                // 5. Probar conexi√≥n autom√°ticamente
                try {
                    console.log('üîå Probando conexi√≥n con MEXC...');
                    await mexcAPI.testConnection();
                    showSyncNotification('‚úÖ Credenciales guardadas y conexi√≥n verificada', 'success');
                    updateMEXCStatus('connected', 'Conectado ‚úì', false);
                } catch (testError) {
                    console.error('‚ö†Ô∏è Error probando conexi√≥n:', testError);
                    showSyncNotification('‚ö†Ô∏è Credenciales guardadas pero conexi√≥n fall√≥: ' + testError.message, 'warning');
                    updateMEXCStatus('warning', 'Guardado - Conexi√≥n fallida', false);
                }
            } catch (error) {
                console.error('Error guardando credenciales:', error);
                showSyncNotification('‚ùå Error: ' + error.message, 'error');
            }
        });
    }

    // ============================================
    // MEXC API Event Listeners (CONSOLIDADO)
    // ============================================

    // Inicializar MEXC
    console.log('üîç Inicializando MEXC...');

    // Cargar credenciales de MEXC con delay para asegurar que DB est√© lista
    setTimeout(() => {
        loadMEXCCredentials().catch(err => {
            console.warn('No se pudieron cargar credenciales de MEXC:', err);
        });
        populateMEXCAccountSelect();
    }, 1000);

    // Event listeners para MEXC
    const testMexcBtn = document.getElementById('test-mexc-connection-detail');
    const connectMexcBtn = document.getElementById('connect-mexc-detail');
    const syncMexcBtn = document.getElementById('sync-mexc-trades-detail');
    const disconnectMexcBtn = document.getElementById('disconnect-mexc-detail');

    console.log('üîç Botones MEXC encontrados:', {
        test: !!testMexcBtn,
        connect: !!connectMexcBtn,
        sync: !!syncMexcBtn,
        disconnect: !!disconnectMexcBtn
    });

    if (testMexcBtn) {
        testMexcBtn.addEventListener('click', async () => {
            console.log('üîò Click en Test MEXC');
            await testMEXCConnection();
        });
    }
    
    if (connectMexcBtn) {
        connectMexcBtn.addEventListener('click', async () => {
            console.log('üîò Click en Connect MEXC');
            await connectMEXC();
        });
    }
    
    if (syncMexcBtn) {
        syncMexcBtn.addEventListener('click', async () => {
            console.log('üîò Click en Sync MEXC');
            await syncMEXCTrades();
        });
    }
    
    if (disconnectMexcBtn) {
        disconnectMexcBtn.addEventListener('click', () => {
            console.log('üîò Click en Disconnect MEXC');
            disconnectMEXC();
        });
    }
    // MEXC CSV Import
    const mexcCsvBtn = document.getElementById('mexc-import-csv-btn');
    if (mexcCsvBtn) {
        mexcCsvBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('mexc-csv-file-input');
            const statusDiv = document.getElementById('mexc-csv-import-status');

            if (!fileInput.files[0]) {
                statusDiv.textContent = 'Por favor selecciona un archivo CSV';
                statusDiv.className = 'text-sm text-negative';
                return;
            }

            try {
                statusDiv.textContent = 'Procesando archivo...';
                statusDiv.className = 'text-sm text-blue-400';

                const file = fileInput.files[0];
                const csvContent = await file.text();
                await processMEXCCSV(csvContent);

                statusDiv.textContent = '‚úÖ CSV importado exitosamente';
                statusDiv.className = 'text-sm text-positive';
                fileInput.value = '';

                // Actualizar historial
                updateMEXCImportHistory();

            } catch (error) {
                console.error('Error procesando CSV de MEXC:', error);
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'text-sm text-negative';
            }
        });
    }

    // Bot√≥n back de MEXC
    const mexcBackBtn = document.getElementById('back-to-platforms-mexc');
    if (mexcBackBtn) {
        mexcBackBtn.addEventListener('click', () => {
            showSection('platforms');
        });
    }

    const ctraderBackBtn = document.getElementById('back-to-platforms-ctrader');
    if (ctraderBackBtn) {
        ctraderBackBtn.addEventListener('click', () => {
            showSection('platforms');
        });
    }

    // ============================================
    // MEXC API Event Listeners
    // ============================================

    // Cargar credenciales al inicio
    console.log('üîÑ Cargando credenciales de Bitget al iniciar...');
    loadBitgetCredentials();

    // Sincronizaci√≥n autom√°tica cada 5 minutos si BingX est√° conectado
    setInterval(async () => {
        if (bingxAPI && DB.apiKeys.bingx && DB.apiKeys.bingx.key) {
            try {
                console.log('üîÑ Sincronizaci√≥n autom√°tica BingX iniciada...');
                await syncBingXTrades();
                console.log('‚úÖ Sincronizaci√≥n autom√°tica BingX completada');
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n autom√°tica BingX:', error);
            }
        }
    }, 5 * 60 * 1000); // 5 minutos

    // OBSERVER PARA RECARGAR CREDENCIALES CUANDO LOS CAMPOS SE HAGAN VISIBLES
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' || mutation.type === 'childList') {
                // Verificar si alg√∫n campo de BingX se hizo visible
                const bingxFields = [
                    'bingx-api-key-detail',
                    'bingx-secret-key-detail',
                    'bingx-api-key',
                    'bingx-api-secret'
                ];

                bingxFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.offsetParent !== null && !field.value) {
                        console.log(`üîÑ Campo ${fieldId} visible y vac√≠o, recargando credenciales`);
                        setTimeout(() => {
                            loadBingXCredentials();
                            loadBingXCredentialsInDetail();
                        }, 100);
                    }
                });
            }
        });
    });

    // Observar cambios en todo el documento
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
    });
});

// FUNCI√ìN ADICIONAL: Recargar credenciales cada 10 segundos como fallback
setInterval(() => {
    const anyFieldEmpty = [
        'bingx-api-key-detail',
        'bingx-secret-key-detail',
        'bingx-api-key',
        'bingx-api-secret'
    ].some(fieldId => {
        const field = document.getElementById(fieldId);
        return field && field.offsetParent !== null && !field.value;
    });

    if (anyFieldEmpty) {
        console.log('üîÑ Fallback: recargando credenciales por campos vac√≠os');
        loadBingXCredentials();
        loadBingXCredentialsInDetail();
    }
}, 10000); // Cada 10 segundos

// Funci√≥n para configurar sincronizaci√≥n autom√°tica manual
function startBingXAutoSync(intervalMinutes = 5) {
    if (window.bingxAutoSyncInterval) {
        clearInterval(window.bingxAutoSyncInterval);
    }

    window.bingxAutoSyncInterval = setInterval(async () => {
        if (bingxAPI && DB.apiKeys.bingx && DB.apiKeys.bingx.key) {
            console.log('üîÑ Sincronizaci√≥n autom√°tica BingX...');
            await syncBingXTrades();
        }
    }, intervalMinutes * 60 * 1000);

    showSyncNotification(`‚úÖ Sincronizaci√≥n autom√°tica activada cada ${intervalMinutes} minutos`, 'success');
}

function stopBingXAutoSync() {
    if (window.bingxAutoSyncInterval) {
        clearInterval(window.bingxAutoSyncInterval);
        window.bingxAutoSyncInterval = null;
        showSyncNotification('‚è∏Ô∏è Sincronizaci√≥n autom√°tica desactivada', 'info');
    }
}

// =====================================================
// GESTI√ìN DE PLATAFORMAS
// =====================================================

function initPlatforms() {
    console.log('üöÄ Iniciando initPlatforms...');
    
    // Event listeners para las tarjetas de plataformas
    const platformCards = document.querySelectorAll('.platform-card:not(.disabled)');
    console.log('üì± Tarjetas encontradas:', platformCards.length);
    
    platformCards.forEach(card => {
        const platform = card.dataset.platform;
        console.log('üîó Agregando listener a:', platform);
        
        card.addEventListener('click', function() {
            console.log('üéØ Click en plataforma:', platform);
            
            if (platform === 'bingx') {
                showPlatformDetail('bingx');
            } else if (platform === 'bitget') {
                showPlatformDetail('bitget');
            } else if (platform === 'mexc') {
                showPlatformDetail('mexc');
            } else if (platform === 'tradingview') {
                showPlatformDetail('tradingview');
            } else if (platform === 'ninjatrader') {
                showPlatformDetail('ninjatrader');
            } else if (platform === 'tradovate') {
                showPlatformDetail('tradovate');
            } else if (platform === 'ctrader') {
                // showPlatformDetail('ctrader'); // DESHABILITADO - Ahora se usa bot√≥n HTML directo
                showSyncNotification('‚úÖ cTrader: Usa el bot√≥n HTML para importar operaciones', 'info');
            } else if (platform === 'primexbtcrypto') {
                showSyncNotification('PrimeXBT Crypto: Usa los botones CSV o Interfaz para importar operaciones', 'info');
            } else if (platform === 'primexbtcfds') {
                showSyncNotification('PrimeXBT CFDs: Usa el bot√≥n CSV para importar operaciones', 'info');
            } else if (platform === 'metatrader5') {
                showSyncNotification('MetaTrader 5: Usa el bot√≥n HTML para importar operaciones', 'info');
            } else {
                showSyncNotification('Esta plataforma estar√° disponible pr√≥ximamente', 'info');
            }
        });
    });

    console.log('‚úÖ initPlatforms completado');
    
    // Inicializar tabs de plataformas
    initPlatformTabs();

    // Bot√≥n de regreso a plataformas (funciona para todas las plataformas)
    const backButtons = document.querySelectorAll('[id^="back-to-platforms"]');
    backButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            showSection('platforms');
        });
    });

    // Duplicar funcionalidad de BingX para la nueva interfaz
    updateAccountSelect('bingx-account-detail');

    // Event listeners para botones de BingX en la nueva interfaz
    const testBtn = document.getElementById('test-bingx-connection-detail');
    const testAuthBtn = document.getElementById('test-auth-only');
    const connectBtn = document.getElementById('connect-bingx-detail');
    const syncBtn = document.getElementById('sync-bingx-trades-detail');

    if (testBtn) testBtn.addEventListener('click', testBingXConnection);
    if (testAuthBtn) testAuthBtn.addEventListener('click', testBingXAuth);
    if (connectBtn) connectBtn.addEventListener('click', connectBingX);
    if (syncBtn) syncBtn.addEventListener('click', syncBingXTrades);

    // Event listener para el bot√≥n CSV en la p√°gina de configuraci√≥n
    const bingxCsvBtn = document.getElementById('bingx-import-csv-btn');
    if (bingxCsvBtn) {
        bingxCsvBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('bingx-csv-file-input');
            const statusDiv = document.getElementById('bingx-csv-import-status');

            if (!fileInput.files[0]) {
                statusDiv.textContent = 'Por favor selecciona un archivo CSV';
                statusDiv.className = 'text-sm text-negative';
                return;
            }

            try {
                statusDiv.textContent = 'Procesando archivo...';
                statusDiv.className = 'text-sm text-blue-400';

                const file = fileInput.files[0];
                await processCSVFile(file, statusDiv);

                statusDiv.textContent = 'CSV importado exitosamente';
                statusDiv.className = 'text-sm text-positive';
                fileInput.value = '';
            } catch (error) {
                console.error('Error procesando CSV:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'text-sm text-negative';
            }
        });
    }

    // Cargar credenciales en la nueva interfaz
    loadBingXCredentialsInDetail();

    // Sincronizar datos entre las dos interfaces
    syncBingXData();

    // Event listener para CSV de MEXC
    const mexcCsvBtn = document.getElementById('mexc-import-csv-btn');
    if (mexcCsvBtn) {
        mexcCsvBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('mexc-csv-file-input');
            const statusDiv = document.getElementById('mexc-csv-import-status');

            if (!fileInput.files[0]) {
                statusDiv.textContent = 'Por favor selecciona un archivo CSV';
                statusDiv.className = 'text-sm text-negative';
                return;
            }

            try {
                statusDiv.textContent = 'Procesando archivo...';
                statusDiv.className = 'text-sm text-blue-400';

                const file = fileInput.files[0];
                await processCSVFile(file, statusDiv);

                statusDiv.textContent = 'CSV importado exitosamente';
                statusDiv.className = 'text-sm text-positive';
                fileInput.value = '';
            } catch (error) {
                console.error('Error procesando CSV:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'text-sm text-negative';
            }
        });
    }

    console.log('‚úÖ MEXC inicializado');
}

// Inicializar tabs de plataformas
function initPlatformTabs() {
    // Obtener todos los botones de tab
    const tabButtons = document.querySelectorAll('.platform-tab');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Obtener el tab actual
            const targetTab = this.dataset.tab;
            
            // Obtener la plataforma del contenedor padre
            const section = this.closest('section');
            const platformId = section.id.replace('platform-', '');
            
            // Remover clase active de todos los tabs de esta plataforma
            section.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Agregar clase active al tab clickeado
            this.classList.add('active');
            
            // Ocultar todo el contenido de tabs de esta plataforma
            section.querySelectorAll('.platform-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Mostrar el contenido del tab seleccionado
            const targetContent = section.querySelector(`#${platformId}-tab-${targetTab}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });
}

function loadBingXCredentialsInDetail() {
    console.log('üîç Cargando credenciales BingX en campos detallados...');

    // Primero intentar cargar desde localStorage
    const savedApiKey = localStorage.getItem('bingx-api-key');
    const savedSecretKey = localStorage.getItem('bingx-secret-key');
    const savedAccountId = localStorage.getItem('bingx-account-id');

    console.log('üìÅ Credenciales para campos detallados:', {
        apiKey: savedApiKey ? `${savedApiKey.substring(0, 10)}...` : 'No encontrada',
        secretKey: savedSecretKey ? `${savedSecretKey.substring(0, 10)}...` : 'No encontrada',
        accountId: savedAccountId || 'No encontrada'
    });

    // Configurar credenciales proporcionadas por el usuario como respaldo
    const providedApiKey = 'sw8hglph1M6HWzoqswDdjX7YTh3mcruPKynFi1ZBz8zDXCHxnEchw7oRWgYysFVLFuD7bkYomRHxSh8gdtNBg';
    const providedSecretKey = '7hUYF1GhJ6QixdE2mfDEdDMovcKVpUc3OnqbAfiAcbrT6XzFfMF4ywd0K06JgJCt0Zsa6MYxuSslDKr5XJfYA';

    const apiKeyDetailEl = document.getElementById('bingx-api-key-detail');
    const secretDetailEl = document.getElementById('bingx-secret-key-detail');
    const accountDetailEl = document.getElementById('bingx-account-detail');

    // Usar credenciales guardadas o las proporcionadas
    const apiKeyToUse = savedApiKey || providedApiKey;
    const secretKeyToUse = savedSecretKey || providedSecretKey;
    const accountIdToUse = savedAccountId || 'main';

    console.log('üíæ Cargando credenciales en campos detallados...');

    if (apiKeyDetailEl) {
        apiKeyDetailEl.value = apiKeyToUse;
        apiKeyDetailEl.type = 'text'; // Hacer visible para edici√≥n si es necesario
        console.log('‚úÖ API Key cargada en campo detallado');
    }
    if (secretDetailEl) {
        secretDetailEl.value = secretKeyToUse;
        secretDetailEl.type = 'text'; // Hacer visible para edici√≥n si es necesario
        console.log('‚úÖ Secret Key cargada en campo detallado');
    }
    if (accountDetailEl) {
        accountDetailEl.value = accountIdToUse;
        console.log('‚úÖ Account ID cargada en campo detallado');
    }

    // Actualizar DB
    DB.apiKeys.bingx = {
        key: apiKeyToUse,
        secret: secretKeyToUse,
        mode: 'real',
        accountId: accountIdToUse
    };

    // Tambi√©n actualizar los campos b√°sicos si existen
    const bingxApiKeyEl = document.getElementById('bingx-api-key');
    const bingxSecretEl = document.getElementById('bingx-api-secret');

    if (bingxApiKeyEl && !bingxApiKeyEl.value) {
        bingxApiKeyEl.value = apiKeyToUse;
        console.log('‚úÖ API Key sincronizada con campo b√°sico');
    }
    if (bingxSecretEl && !bingxSecretEl.value) {
        bingxSecretEl.value = secretKeyToUse;
        console.log('‚úÖ Secret Key sincronizada con campo b√°sico');
    }

    // Inicializar API autom√°ticamente si hay credenciales
    if (apiKeyToUse && secretKeyToUse) {
        try {
            // Verificar que la clase BingXAPI est√© definida
            if (typeof BingXAPI !== 'undefined') {
                bingxAPI = new BingXAPI(apiKeyToUse, secretKeyToUse);
                console.log('‚úÖ BingX API inicializada autom√°ticamente');
                // Poblar las cuentas cuando se inicializa la API
                populateBingXAccounts();
            } else {
                console.warn('‚ö†Ô∏è BingXAPI no est√° definida a√∫n. Se inicializar√° m√°s tarde.');
            }
        } catch (error) {
            console.error('‚ùå Error inicializando BingX API:', error);
        }
    }
}

function showPlatformDetail(platform) {
    // Ocultar TODAS las secciones primero
    document.querySelectorAll('.section-container').forEach(s => {
        s.classList.remove('active');
    });

    if (platform === 'bingx') {
        console.log('üéØ Abriendo secci√≥n BingX - recargando credenciales');

        // Cargar credenciales antes de mostrar la interfaz
        loadBingXCredentials();
        loadBingXCredentialsInDetail();

        // Poblar cuentas de BingX
        populateBingXAccounts();

        // Recargar credenciales despu√©s de un breve delay para asegurar que los campos est√©n listos
        setTimeout(() => {
            console.log('üîÑ Recarga adicional de credenciales en BingX');
            loadBingXCredentials();
            loadBingXCredentialsInDetail();
        }, 500);

        // Sincronizar datos actuales
        syncBingXData();

        // Mostrar SOLO la secci√≥n de BingX
        document.getElementById('platform-bingx').classList.add('active');

        // Actualizar estado de la conexi√≥n despu√©s de cargar credenciales
        setTimeout(() => {
            updateBingXDetailStatus();
        }, 500);

    } else if (platform === 'bitget') {
        console.log('üéØ Abriendo secci√≥n Bitget - recargando credenciales');

        // Cargar credenciales antes de mostrar la interfaz y esperar a que termine
        loadBitgetCredentials()
            .then(() => {
                // Poblar cuentas de Bitget DESPU√âS de cargar credenciales
                console.log('‚úÖ loadBitgetCredentials completado, poblando selector...');
                populateBitgetAccountSelect();
                console.log('‚úÖ Credenciales y cuentas Bitget cargadas');
            })
            .catch((error) => {
                console.error('‚ùå Error en loadBitgetCredentials:', error);
            });

        // Recargar credenciales despu√©s de un breve delay para asegurar que los campos est√©n listos
        setTimeout(async () => {
            console.log('üîÑ Recarga adicional de credenciales en Bitget (timeout 500ms)');
            try {
                await loadBitgetCredentials();
                console.log('‚úÖ Recarga completada, poblando selector de nuevo...');
                populateBitgetAccountSelect();
            } catch (error) {
                console.error('‚ùå Error en recarga:', error);
            }
        }, 500);

        // Mostrar SOLO la secci√≥n de Bitget
        document.getElementById('platform-bitget').classList.add('active');

        console.log('‚úÖ Panel de Bitget cargado');
    } else if (platform === 'mexc') {
        console.log('üéØ Abriendo secci√≥n MEXC');

        // Cargar credenciales de forma as√≠ncrona
        loadMEXCCredentials().catch(err => {
            console.error('Error cargando credenciales MEXC:', err);
        });

        // Poblar cuentas
        populateMEXCAccountSelect();

        // Mostrar SOLO la secci√≥n de MEXC
        document.getElementById('platform-mexc').classList.add('active');

        console.log('‚úÖ Panel de MEXC cargado');
    } else if (platform === 'tradingview') {
        console.log('üéØ Abriendo secci√≥n TradingView');

        // Cargar configuraci√≥n de TradingView
        loadTradingViewConfig();

        // Poblar select de cuentas
        populateTradingViewAccountSelect();

        // Mostrar SOLO la secci√≥n de TradingView
        document.getElementById('platform-tradingview').classList.add('active');

        console.log('‚úÖ Panel de TradingView cargado');
    } else if (platform === 'ninjatrader') {
        console.log('üéØ Abriendo secci√≥n NinjaTrader');

        // Cargar configuraci√≥n de NinjaTrader
        loadNinjaTraderConfig();

        // Poblar select de cuentas
        populateNinjaTraderAccountSelect();

        // Mostrar SOLO la secci√≥n de NinjaTrader
        document.getElementById('platform-ninjatrader').classList.add('active');

        console.log('‚úÖ Panel de NinjaTrader cargado');
    } else if (platform === 'tradovate') {
        console.log('üéØ Abriendo secci√≥n Tradovate');

        // Cargar configuraci√≥n de Tradovate
        loadTradovateConfig();

        // Poblar select de cuentas
        populateTradovateAccountSelect();

        // Mostrar SOLO la secci√≥n de Tradovate
        document.getElementById('platform-tradovate').classList.add('active');

        console.log('‚úÖ Panel de Tradovate cargado');
    } else if (platform === 'ctrader') {
        console.log('üéØ Abriendo secci√≥n cTrader');

        // Poblar select de cuentas
        populateCTraderAccountSelect();

        // Mostrar SOLO la secci√≥n de cTrader
        document.getElementById('platform-ctrader').classList.add('active');

        console.log('‚úÖ Panel de cTrader cargado');
    }
}

function syncBingXData() {
    // Sincronizar claves API
    const apiKey = document.getElementById('bingx-api-key')?.value || '';
    const secretKey = document.getElementById('bingx-api-secret')?.value || '';
    const selectedAccount = document.getElementById('bingx-account')?.value || '';

    if (document.getElementById('bingx-api-key-detail')) {
        document.getElementById('bingx-api-key-detail').value = apiKey;
    }
    if (document.getElementById('bingx-secret-key-detail')) {
        document.getElementById('bingx-secret-key-detail').value = secretKey;
    }
    if (document.getElementById('bingx-account-detail')) {
        document.getElementById('bingx-account-detail').value = selectedAccount;
    }
}

function updateBingXDetailStatus() {
    const statusElement = document.getElementById('bingx-connection-status');
    const proxyElement = document.getElementById('bingx-proxy-status-detail');

    // Verificar si hay credenciales guardadas
    const hasLocalCredentials = localStorage.getItem('bingx-api-key') && localStorage.getItem('bingx-secret-key');
    const hasDbCredentials = DB.apiKeys.bingx && DB.apiKeys.bingx.key && DB.apiKeys.bingx.secret;

    if ((bingxAPI && bingxAPI.apiKey) || hasLocalCredentials || hasDbCredentials) {
        // Conectado (banner oculto por CSS)

        // Actualizar indicadores en la tarjeta de plataforma
        const statusIndicator = document.getElementById('bingx-status-indicator');
        const progressBar = document.getElementById('bingx-progress-bar');

        if (statusIndicator) {
            statusIndicator.textContent = 'Conectado';
            statusIndicator.className = 'text-green-400';
        }
        if (progressBar) {
            progressBar.style.width = '100%';
        }

        // Mostrar botones de sincronizaci√≥n
        const syncBtn = document.getElementById('bingx-sync');
        if (syncBtn) syncBtn.style.display = 'inline-block';

    } else {
        // No conectado
        // Not connected (banner is hidden)

        // Actualizar indicadores en la tarjeta de plataforma
        const statusIndicator = document.getElementById('bingx-status-indicator');
        const progressBar = document.getElementById('bingx-progress-bar');

        if (statusIndicator) {
            statusIndicator.textContent = 'No conectado';
            statusIndicator.className = 'text-yellow-400';
        }
        if (progressBar) {
            progressBar.style.width = '0%';
        }

        // Ocultar bot√≥n de sincronizaci√≥n
        const syncBtn = document.getElementById('bingx-sync');
        if (syncBtn) syncBtn.style.display = 'none';
    }
}

// Funci√≥n personalizada para conectar BingX desde la nueva interfaz
// FUNCI√ìN DUPLICADA - COMENTADA (ya existe versi√≥n async en l√≠nea 31770)
/*
function connectBingX() {
    let apiKey, secretKey, selectedAccount;

    // Verificar desde qu√© interfaz se est√° llamando
    const detailApiKey = document.getElementById('bingx-api-key-detail');
    const oldApiKey = document.getElementById('bingx-api-key');

    if (detailApiKey && detailApiKey.value) {
        // Llamada desde la nueva interfaz de plataformas
        apiKey = detailApiKey.value;
        secretKey = document.getElementById('bingx-secret-key-detail').value;
        selectedAccount = document.getElementById('bingx-account-detail').value;
    } else if (oldApiKey && oldApiKey.value) {
        // Llamada desde la interfaz antigua de configuraci√≥n
        apiKey = oldApiKey.value;
        secretKey = document.getElementById('bingx-api-secret').value;
        selectedAccount = document.getElementById('bingx-account').value;
    }

    if (!apiKey || !secretKey) {
        alert('Por favor, introduce tanto la clave API como el secret de BingX.');
        return;
    }

    if (!selectedAccount) {
        alert('Por favor, selecciona una cuenta para sincronizar.');
        return;
    }

    // Sincronizar valores entre ambas interfaces
    if (detailApiKey) {
        detailApiKey.value = apiKey;
        document.getElementById('bingx-secret-key-detail').value = secretKey;
        document.getElementById('bingx-account-detail').value = selectedAccount;
    }
    if (oldApiKey) {
        oldApiKey.value = apiKey;
        document.getElementById('bingx-api-secret').value = secretKey;
        document.getElementById('bingx-account').value = selectedAccount;
    }

    // Inicializar BingX API
    bingxAPI = new BingXAPI(apiKey, secretKey);
    DB.apiKeys.bingx = { key: apiKey, secret: secretKey, mode: 'real', accountId: selectedAccount };

    // Actualizar estado
    updateBingXDetailStatus();

    // showSyncNotification('‚úÖ BingX conectado exitosamente', 'success');
}
*/

console.log('‚úÖ Sistema de autenticaci√≥n inicializado');
console.log('‚úÖ Integraci√≥n BingX inicializada');

// =============================================
// GR√ÅFICOS - Gr√°ficas adicionales del informe
// =============================================
let graficosCharts = {};

function destroyGraficosCharts() {
    Object.values(graficosCharts).forEach(chart => { if (chart) chart.destroy(); });
    graficosCharts = {};
}

window.refreshGraficosCharts = function() {
        console.log("--- Refreshing Graficos Charts ---");
        destroyGraficosCharts();

        let operations = applyDateFilterToData(DB.operations);
        const selectedAccountEl = document.getElementById('informe-account-select');
        const selectedAccount = selectedAccountEl ? selectedAccountEl.value : 'all';

        console.log(`[Graficos] Total operations after date filter: ${operations.length}`);
        console.log(`[Graficos] Selected account: '${selectedAccount}'`);

        if (selectedAccount !== 'all') {
            operations = operations.filter(op => op.accountId === selectedAccount);
            console.log(`[Graficos] After account filter: ${operations.length}`);
        }
        operations = applyInformeFilters(operations);

        console.log(`[Graficos] Final operations for calculation: ${operations.length}`);
        if(operations.length > 0) {
            console.log("[Graficos] First 3 operations:", operations.slice(0,3).map(op => ({
                date: op.date,
                instrument: op.instrument,
                pl: op.pl,
                plType: typeof op.pl
            })));
        }

        // Preparar datos de semanas y meses
        const weekMap = {};
        const monthMap = {};
        
        operations.forEach(op => {
            // Asegurar que pl sea un n√∫mero
            const plValue = parseFloat(op.pl) || 0;
            
            // Semanas
            const d = new Date(op.date + 'T00:00:00');
            const week = getWeekNumber(d);
            const year = d.getUTCFullYear();
            const weekKey = `${year}-W${week}`;
            if (!weekMap[weekKey]) weekMap[weekKey] = { pl: 0, count: 0 };
            weekMap[weekKey].pl += plValue;
            weekMap[weekKey].count++;
            
            // Meses
            const monthKey = op.date.substring(0, 7); // YYYY-MM
            if (!monthMap[monthKey]) monthMap[monthKey] = 0;
            monthMap[monthKey] += plValue;
        });
        
        const sortedWeeks = Object.keys(weekMap).sort();
        const weekLabels = sortedWeeks;
        const weekData = sortedWeeks.map(key => weekMap[key].pl);
        const sortedMonths = Object.keys(monthMap).sort();
        const monthLabels = sortedMonths;
        const monthData = sortedMonths.map(key => monthMap[key]);
        const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));

        console.log(`[Graficos] Week data:`, weekData);
        console.log(`[Graficos] Month data:`, monthData);

        // 1. Ganancias por Semana
        const bestWeek = weekData.length > 0 ? Math.max(...weekData) : 0;
        const worstWeek = weekData.length > 0 ? Math.min(...weekData) : 0;
        const bestWeekEl = document.getElementById('best-week-value');
        const worstWeekEl = document.getElementById('worst-week-value');
        if (bestWeekEl) {
            bestWeekEl.textContent = `$${bestWeek.toFixed(2)}`;
            bestWeekEl.className = bestWeek >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        }
        if (worstWeekEl) {
            worstWeekEl.textContent = `$${worstWeek.toFixed(2)}`;
            worstWeekEl.className = worstWeek >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        }
        
        const gananciasSemanaCanvas = document.getElementById('ganancias-semana-chart');
        console.log('[Graficos] Ganancias Semana Canvas:', gananciasSemanaCanvas ? 'Found' : 'NOT FOUND');
        if (gananciasSemanaCanvas) {
            const gananciasSemanaCtx = gananciasSemanaCanvas.getContext('2d');
            if (gananciasSemanaCtx) {
                graficosCharts.gananciasSemana = new Chart(gananciasSemanaCtx, {
                type: 'bar',
                data: { labels: weekLabels, datasets: [{ label: 'Ganancia Semanal', data: weekData, backgroundColor: weekData.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'), borderColor: weekData.map(v => v >= 0 ? 'rgba(57, 255, 20, 1)' : 'rgba(255, 65, 54, 1)'), borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }, x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } } } }
            });
                console.log('[Graficos] ‚úÖ Ganancias Semana chart created');
            }
        }

        // 2. Ganancias por Mes
        const bestMonth = monthData.length > 0 ? Math.max(...monthData) : 0;
        const worstMonth = monthData.length > 0 ? Math.min(...monthData) : 0;
        const bestMonthEl = document.getElementById('best-month-value');
        const worstMonthEl = document.getElementById('worst-month-value');
        if (bestMonthEl) {
            bestMonthEl.textContent = `$${bestMonth.toFixed(2)}`;
            bestMonthEl.className = bestMonth >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        }
        if (worstMonthEl) {
            worstMonthEl.textContent = `$${worstMonth.toFixed(2)}`;
            worstMonthEl.className = worstMonth >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        }
        
        const gananciasMesCanvas = document.getElementById('ganancias-mes-chart');
        console.log('[Graficos] Ganancias Mes Canvas:', gananciasMesCanvas ? 'Found' : 'NOT FOUND');
        if (gananciasMesCanvas) {
            const gananciasMesCtx = gananciasMesCanvas.getContext('2d');
            if (gananciasMesCtx) {
                graficosCharts.gananciasMes = new Chart(gananciasMesCtx, {
                type: 'bar',
                data: { labels: monthLabels, datasets: [{ label: 'Ganancia Mensual', data: monthData, backgroundColor: monthData.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'), borderColor: monthData.map(v => v >= 0 ? 'rgba(57, 255, 20, 1)' : 'rgba(255, 65, 54, 1)'), borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }, x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } } } }
            });
                console.log('[Graficos] ‚úÖ Ganancias Mes chart created');
            }
        }

        // 3. Posici√≥n (Largo vs Corto)
        let longTrades = 0, shortTrades = 0;
        operations.forEach(op => {
            if (op.type === 'buy') longTrades++;
            else if (op.type === 'sell') shortTrades++;
        });
        
        // Actualizar valores de resumen para posiciones
        const longCountEl = document.getElementById('long-count');
        const shortCountEl = document.getElementById('short-count');
        if (longCountEl) longCountEl.textContent = longTrades;
        if (shortCountEl) shortCountEl.textContent = shortTrades;
        
        const posicionCtx = document.getElementById('posicion-chart')?.getContext('2d');
        if (posicionCtx) {
            graficosCharts.posicion = new Chart(posicionCtx, {
                type: 'doughnut',
                data: { labels: ['Largo', 'Corto'], datasets: [{ data: [longTrades, shortTrades], backgroundColor: ['rgba(57,255,20,0.7)', 'rgba(255,65,54,0.7)'], borderColor: '#0a0a0a', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#ffffff', padding: 15, font: { size: 12 } } } } }
            });
        }

        // 5. Operaciones por Hora del D√≠a
        const horas = Array(24).fill(0);
        operations.forEach(op => {
            if (op.entryTime) {
                try {
                    const hour = parseInt(op.entryTime.split(':')[0], 10);
                    if (!isNaN(hour)) horas[hour]++;
                } catch(e) {}
            }
        });
        
        // Actualizar valores de resumen para horarios
        const maxHourValue = Math.max(...horas);
        const mostActiveHourIndex = horas.indexOf(maxHourValue);
        const mostActiveHourEl = document.getElementById('most-active-hour');
        const hourlyTotalOpsEl = document.getElementById('hourly-total-ops');
        if (mostActiveHourEl) mostActiveHourEl.textContent = maxHourValue > 0 ? `${mostActiveHourIndex}:00` : '--:--';
        if (hourlyTotalOpsEl) hourlyTotalOpsEl.textContent = operations.length;
        
        const horaDiaCtx = document.getElementById('hora-dia-chart')?.getContext('2d');
        if (horaDiaCtx) {
            graficosCharts.horaDia = new Chart(horaDiaCtx, {
                type: 'bar',
                data: { labels: horas.map((_, i) => i + ':00'), datasets: [{ label: 'Operaciones por Hora', data: horas, backgroundColor: 'rgba(57,152,219,0.7)', borderColor: 'rgba(57,152,219,1)', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0a0a0', stepSize: 1 }, grid: { color: '#2a2a2a' } }, x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } } } }
            });
        }

        // 6. Drawdown M√°ximo (acumulado)
        let maxDrawdown = 0, peak = 0, equity = 0;
        const drawdownArr = [];
        sortedOps.forEach(op => {
            const plValue = parseFloat(op.pl) || 0;
            equity += plValue;
            if (equity > peak) peak = equity;
            const dd = equity - peak;
            if (dd < maxDrawdown) maxDrawdown = dd;
            drawdownArr.push(dd);
        });
        
        // Actualizar valores de resumen para drawdown
        const recoveryPct = peak > 0 ? ((equity / peak) * 100) : 100;
        const maxDrawdownEl = document.getElementById('max-drawdown-value');
        const drawdownRecoveryEl = document.getElementById('drawdown-recovery');
        if (maxDrawdownEl) maxDrawdownEl.textContent = `$${maxDrawdown.toFixed(2)}`;
        if (drawdownRecoveryEl) drawdownRecoveryEl.textContent = `${recoveryPct.toFixed(1)}%`;
        
        const drawdownCtx = document.getElementById('drawdown-chart')?.getContext('2d');
        if (drawdownCtx) {
            graficosCharts.drawdown = new Chart(drawdownCtx, {
                type: 'line',
                data: { labels: sortedOps.map(op => op.date), datasets: [{ label: 'Drawdown', data: drawdownArr, borderColor: 'rgba(255,65,54,1)', backgroundColor: 'rgba(255,65,54,0.2)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }, x: { ticks: { color: '#a0a0a0', display: false }, grid: { color: '#2a2a2a' } } } }
            });
        }

        // 5. Evoluci√≥n del Balance (Equity Curve)
        let runningBalance = 0;
        const balanceEvolution = sortedOps.map(op => {
            const plValue = parseFloat(op.pl) || 0;
            runningBalance += plValue;
            return runningBalance;
        });
        const balanceLabels = sortedOps.map(op => op.date);
        
        // Actualizar valores de resumen para balance
        const initialBalance = 0; // Siempre empieza en 0 para P&L acumulado
        const currentBalance = balanceEvolution.length > 0 ? balanceEvolution[balanceEvolution.length - 1] : 0;
        const initialBalanceEl = document.getElementById('initial-balance-value');
        const currentBalanceEl = document.getElementById('current-balance-value');
        if (initialBalanceEl) initialBalanceEl.textContent = `$${initialBalance.toFixed(2)}`;
        if (currentBalanceEl) {
            currentBalanceEl.textContent = `$${currentBalance.toFixed(2)}`;
            currentBalanceEl.className = currentBalance >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        }
        
        const balanceEvolutionCtx = document.getElementById('balance-evolution-chart')?.getContext('2d');
        if (balanceEvolutionCtx) {
            graficosCharts.balanceEvolution = new Chart(balanceEvolutionCtx, {
                type: 'line',
                data: {
                    labels: balanceLabels,
                    datasets: [{
                        label: 'Balance Acumulado',
                        data: balanceEvolution,
                        borderColor: 'rgba(57, 255, 20, 1)',
                        backgroundColor: 'rgba(57, 255, 20, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 1,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Balance: $${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#2a2a2a' }
                        },
                        x: {
                            ticks: { color: '#a0a0a0', display: false },
                            grid: { color: '#2a2a2a' }
                        }
                    }
                }
            });
        }
        
        // ===== NUEVAS M√âTRICAS: CONSISTENCIA Y VOLATILIDAD =====
        
        // 10. Volatilidad de Retornos Mensuales
        const monthlyVolatilityCtx = document.getElementById('graficos-monthly-volatility-chart')?.getContext('2d');
        if (monthlyVolatilityCtx) {
            if (monthData.length > 0) {
                const avgMonthlyReturn = monthData.reduce((a,b) => a+b, 0) / monthData.length;
                const variance = monthData.reduce((sum, ret) => sum + Math.pow(ret - avgMonthlyReturn, 2), 0) / monthData.length;
                const stdDev = Math.sqrt(variance);
                
                const deviations = monthData.map(ret => Math.abs(ret - avgMonthlyReturn));
                
                // Actualizar valores de las m√©tricas en el DOM
                const volatilityValueEl = document.getElementById('volatility-value');
                const volatilityAvgEl = document.getElementById('volatility-avg');
                if (volatilityValueEl) volatilityValueEl.textContent = `$${stdDev.toFixed(2)}`;
                if (volatilityAvgEl) volatilityAvgEl.textContent = `$${avgMonthlyReturn.toFixed(2)}`;
                
                graficosCharts.monthlyVolatility = new Chart(monthlyVolatilityCtx, {
                    type: 'bar',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'Desviaci√≥n del Promedio',
                            data: deviations,
                            backgroundColor: 'rgba(57,152,219,0.7)',
                            borderColor: 'rgba(57,152,219,1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { color: '#a0a0a0' },
                                grid: { color: '#2a2a2a' }
                            },
                            x: {
                                ticks: { color: '#a0a0a0' },
                                grid: { color: '#2a2a2a' }
                            }
                        }
                    }
                });
            } else {
                // Sin datos mensuales
                graficosCharts.monthlyVolatility = new Chart(monthlyVolatilityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Sin datos'],
                        datasets: [{
                            label: 'Volatilidad',
                            data: [0],
                            backgroundColor: 'rgba(100,100,100,0.5)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Sin suficientes datos mensuales',
                                color: '#a0a0a0',
                                font: { size: 12 }
                            }
                        },
                        scales: {
                            y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } },
                            x: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a2a' } }
                        }
                    }
                });
            }
        }
        
        // 11. Resultado Final vs Stop Loss (Distribuci√≥n de Salidas)
        const resultVsSlCtx = document.getElementById('graficos-result-vs-sl-chart')?.getContext('2d');
        if (resultVsSlCtx) {
            const exitTypes = {
                'TP Hit': 0,
                'SL Hit': 0,
                'Manual Win': 0,
                'Manual Loss': 0
            };
            
            operations.forEach(op => {
                const pl = parseFloat(op.pl) || 0;
                const hasTP = op.takeProfit && parseFloat(op.takeProfit) > 0;
                const hasSL = op.stopLoss && parseFloat(op.stopLoss) > 0;
                
                if (pl > 0) {
                    if (hasTP) exitTypes['TP Hit']++;
                    else exitTypes['Manual Win']++;
                } else {
                    if (hasSL) exitTypes['SL Hit']++;
                    else exitTypes['Manual Loss']++;
                }
            });
            
            // Actualizar contadores en el DOM
            const tpHitEl = document.getElementById('tp-hit-count');
            const slHitEl = document.getElementById('sl-hit-count');
            const manualCloseEl = document.getElementById('manual-close-count');
            if (tpHitEl) tpHitEl.textContent = exitTypes['TP Hit'];
            if (slHitEl) slHitEl.textContent = exitTypes['SL Hit'];
            if (manualCloseEl) manualCloseEl.textContent = exitTypes['Manual Win'] + exitTypes['Manual Loss'];
            
            graficosCharts.resultVsSl = new Chart(resultVsSlCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(exitTypes),
                    datasets: [{
                        data: Object.values(exitTypes),
                        backgroundColor: [
                            'rgba(57,255,20,0.7)',    // TP Hit - verde
                            'rgba(255,65,54,0.7)',    // SL Hit - rojo
                            'rgba(57,152,219,0.7)',   // Manual Win - azul
                            'rgba(150,150,150,0.7)'   // Manual Loss - gris
                        ],
                        borderColor: '#0a0a0a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#ffffff', padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const total = Object.values(exitTypes).reduce((a,b) => a+b, 0);
                                    const pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                    return `${ctx.label}: ${ctx.parsed} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 12. Evoluci√≥n de Win Rate (Rolling Average)
        const winrateEvolutionCtx = document.getElementById('graficos-winrate-evolution-chart')?.getContext('2d');
        if (winrateEvolutionCtx && sortedOps.length > 0) {
            const windowSize = Math.min(20, Math.floor(sortedOps.length / 5)) || 10;
            const winRates = [];
            const labels = [];
            
            for (let i = windowSize - 1; i < sortedOps.length; i++) {
                const window = sortedOps.slice(i - windowSize + 1, i + 1);
                const wins = window.filter(op => op.result === 'win').length;
                const winRate = (wins / windowSize) * 100;
                winRates.push(winRate);
                labels.push(sortedOps[i].date);
            }
            
            graficosCharts.winrateEvolution = new Chart(winrateEvolutionCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Win Rate (${windowSize} trades)`,
                        data: winRates,
                        borderColor: 'rgba(57,255,20,1)',
                        backgroundColor: 'rgba(57,255,20,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    }, {
                        label: '50% L√≠nea',
                        data: Array(winRates.length).fill(50),
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                color: '#a0a0a0',
                                callback: (value) => value + '%'
                            },
                            grid: { color: '#2a2a2a' }
                        },
                        x: {
                            ticks: { color: '#a0a0a0', display: false },
                            grid: { color: '#2a2a2a' }
                        }
                    }
                }
            });
        }
    };

console.log('‚úÖ refreshGraficosCharts definida y disponible globalmente');

// ===== EXPORTAR FUNCIONES AL √ÅMBITO GLOBAL =====
// Esto permite que el segundo bloque <script> y el resto del c√≥digo acceda a estas funciones
window.initializeSupabase = initializeSupabase;
window.supabase = supabase;
window.currentUser = null;

// Funciones de operaciones
window.saveOperationToSupabase = saveOperationToSupabase;
window.loadOperationsFromSupabase = loadOperationsFromSupabase;
window.deleteOperationFromSupabase = deleteOperationFromSupabase;
window.addToSyncQueue = addToSyncQueue;

// Funciones de cuentas
window.saveAccountToSupabase = saveAccountToSupabase;
window.loadAccountsFromSupabase = loadAccountsFromSupabase;
window.deleteAccountFromSupabase = deleteAccountFromSupabase;

// Funciones de funded accounts
window.saveFundedAccountToSupabase = saveFundedAccountToSupabase;
window.loadFundedAccountsFromSupabase = loadFundedAccountsFromSupabase;
window.deleteFundedAccountFromSupabase = deleteFundedAccountFromSupabase;

// Funciones de setups
window.saveSetupToSupabase = saveSetupToSupabase;
window.loadSetupsFromSupabase = loadSetupsFromSupabase;
window.deleteSetupFromSupabase = deleteSetupFromSupabase;

// Funciones de finanzas
window.saveFinanceToSupabase = saveFinanceToSupabase;
window.updateFinanceInSupabase = updateFinanceInSupabase;
window.loadFinancesFromSupabase = loadFinancesFromSupabase;
window.deleteFinanceFromSupabase = deleteFinanceFromSupabase;

// Funciones de configuraci√≥n
window.saveUserSettingsToSupabase = saveUserSettingsToSupabase;
window.loadUserSettingsFromSupabase = loadUserSettingsFromSupabase;
window.syncDataFromSupabase = syncDataFromSupabase;
window.toggleUserMenu = toggleUserMenu;

// ===== NUEVAS FUNCIONES: CHARTBOOK =====
async function saveChartbookImageToSupabase(imageData) {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return null;
    }

    try {
        const dataToSave = {
            id: imageData.id || `chartbook-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            user_id: currentUser.id,
            account_id: imageData.accountId || null,
            date: imageData.date,
            image_data: imageData.imageData,
            notes: imageData.notes || '',
            tags: imageData.tags || []
        };

        const { data, error } = await supabase
            .from('chartbook_images')
            .upsert(dataToSave, { onConflict: 'id' });

        if (error) throw error;
        console.log('‚úÖ Imagen de Chartbook guardada en Supabase');
        return data;
    } catch (error) {
        console.error('‚ùå Error guardando imagen de Chartbook:', error);
        throw error;
    }
}

async function loadChartbookImagesFromSupabase() {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return [];
    }

    try {
        const { data, error } = await supabase
            .from('chartbook_images')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });

        if (error) throw error;
        console.log(`‚úÖ ${data.length} im√°genes de Chartbook cargadas desde Supabase`);
        return data.map(img => ({
            id: img.id,
            accountId: img.account_id,
            date: img.date,
            imageData: img.image_data,
            notes: img.notes,
            tags: img.tags || []
        }));
    } catch (error) {
        console.error('‚ùå Error cargando im√°genes de Chartbook:', error);
        return [];
    }
}

async function deleteChartbookImageFromSupabase(imageId) {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return false;
    }

    try {
        const { error } = await supabase
            .from('chartbook_images')
            .delete()
            .eq('id', imageId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
        console.log('‚úÖ Imagen de Chartbook eliminada de Supabase');
        return true;
    } catch (error) {
        console.error('‚ùå Error eliminando imagen de Chartbook:', error);
        return false;
    }
}

// ===== NUEVAS FUNCIONES: DAILY JOURNAL =====
async function saveJournalEntryToSupabase(entryData) {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return null;
    }

    try {
        const dataToSave = {
            id: entryData.id || `journal-${entryData.date}-${currentUser.id}`,
            user_id: currentUser.id,
            account_id: entryData.accountId || null,
            date: entryData.date,
            mood: entryData.mood || null,
            emotions: entryData.emotions || [],
            pre_trading_note: entryData.preTradingNote || '',
            post_trading_note: entryData.postTradingNote || '',
            lessons_learned: entryData.lessonsLearned || '',
            image_data: entryData.imageData || null,
            daily_pnl: parseFloat(entryData.dailyPnl) || 0,
            trades_count: parseInt(entryData.tradesCount) || 0,
            win_rate: parseFloat(entryData.winRate) || 0
        };

        const { data, error } = await supabase
            .from('daily_journal_entries')
            .upsert(dataToSave, { onConflict: 'id' });

        if (error) throw error;
        console.log('‚úÖ Entrada de Daily Journal guardada en Supabase');
        return data;
    } catch (error) {
        console.error('‚ùå Error guardando entrada de Daily Journal:', error);
        throw error;
    }
}

async function loadJournalEntriesFromSupabase() {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return [];
    }

    try {
        const { data, error } = await supabase
            .from('daily_journal_entries')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });

        if (error) throw error;
        console.log(`‚úÖ ${data.length} entradas de Daily Journal cargadas desde Supabase`);
        return data.map(entry => ({
            id: entry.id,
            accountId: entry.account_id,
            date: entry.date,
            mood: entry.mood,
            emotions: entry.emotions || [],
            preTradingNote: entry.pre_trading_note,
            postTradingNote: entry.post_trading_note,
            lessonsLearned: entry.lessons_learned,
            imageData: entry.image_data,
            dailyPnl: entry.daily_pnl,
            tradesCount: entry.trades_count,
            winRate: entry.win_rate
        }));
    } catch (error) {
        console.error('‚ùå Error cargando entradas de Daily Journal:', error);
        return [];
    }
}

async function deleteJournalEntryFromSupabase(entryId) {
    if (!currentUser) {
        console.error('‚ùå No hay usuario autenticado');
        return false;
    }

    try {
        const { error } = await supabase
            .from('daily_journal_entries')
            .delete()
            .eq('id', entryId)
            .eq('user_id', currentUser.id);

        if (error) throw error;
        console.log('‚úÖ Entrada de Daily Journal eliminada de Supabase');
        return true;
    } catch (error) {
        console.error('‚ùå Error eliminando entrada de Daily Journal:', error);
        return false;
    }
}

// Exportar nuevas funciones
window.saveChartbookImageToSupabase = saveChartbookImageToSupabase;
window.loadChartbookImagesFromSupabase = loadChartbookImagesFromSupabase;
window.deleteChartbookImageFromSupabase = deleteChartbookImageFromSupabase;
window.saveJournalEntryToSupabase = saveJournalEntryToSupabase;
window.loadJournalEntriesFromSupabase = loadJournalEntriesFromSupabase;
window.deleteJournalEntryFromSupabase = deleteJournalEntryFromSupabase;

console.log('‚úÖ Todas las funciones de Supabase exportadas al √°mbito global');

</script>

<script>
// =============================================
// COMISIONES - AN√ÅLISIS DE COSTOS
// =============================================
let comisionesCharts = {};

function destroyComisionesCharts() {
    Object.values(comisionesCharts).forEach(chart => { if (chart) chart.destroy(); });
    comisionesCharts = {};
}

function refreshComisiones() {
    console.log("--- Refreshing Comisiones ---");
    destroyComisionesCharts();
    
    let operations = applyDateFilterToData(DB.operations);
    const selectedAccount = document.getElementById('informe-account-select')?.value;
    const displayCurrency = DB.settings.defaultCurrency;

        if (selectedAccount !== 'all') {
            operations = operations.filter(op => op.accountId === selectedAccount);
        }
        operations = applyInformeFilters(operations);

        console.log(`[Comisiones] Processing ${operations.length} operations for account: ${selectedAccount}`);

        // Calcular m√©tricas de comisiones
        let totalCommissions = 0;
        let totalPL = 0;
        let commissionsBySymbol = {};
        let commissionsByMonth = {};
        let commissionsArray = [];
        let tradesImpacted = 0; // Trades que pasaron de ganancia a p√©rdida por comisiones

        operations.forEach(op => {
            // Calcular comisi√≥n: Usar el campo 'fees' que es el est√°ndar en el sistema
            let commission = 0;
            
            if (op.fees && op.fees !== 0) {
                // Si existe fees guardado, usarlo
                commission = Math.abs(op.fees);
            } else if (op.commission && op.commission !== 0) {
                // Fallback a commission si existe
                commission = Math.abs(op.commission);
            } else {
                // Estimar comisi√≥n basada en volumen y precio de entrada como √∫ltimo recurso
                // Tasa t√≠pica: 0.04% del valor nominal para futuros (puede variar)
                const volume = op.volume || 0;
                const entry = op.entry || 0;
                const nominalValue = volume * entry;
                commission = nominalValue * 0.0004; // 0.04% promedio para futuros
            }
            
            const commissionUSD = convertCurrency(commission, op.currency, displayCurrency);
            const pl = convertCurrency(op.pl, op.currency, displayCurrency);
            
            totalCommissions += commissionUSD;
            totalPL += pl;
            commissionsArray.push(commissionUSD);

            // Por s√≠mbolo
            const symbol = (op.instrument || 'UNKNOWN').toUpperCase();
            if (!commissionsBySymbol[symbol]) {
                commissionsBySymbol[symbol] = { total: 0, pl: 0, count: 0 };
            }
            commissionsBySymbol[symbol].total += commissionUSD;
            commissionsBySymbol[symbol].pl += pl;
            commissionsBySymbol[symbol].count++;

            // Por mes
            const month = op.date.substring(0, 7); // YYYY-MM
            if (!commissionsByMonth[month]) {
                commissionsByMonth[month] = { commissions: 0, pl: 0 };
            }
            commissionsByMonth[month].commissions += commissionUSD;
            commissionsByMonth[month].pl += pl;

            // Detectar impacto en winrate (trade que sin fees ser√≠a ganancia)
            if ((pl + commissionUSD) > 0 && pl <= 0) {
                tradesImpacted++;
            }
        });

        const avgCommission = operations.length > 0 ? totalCommissions / operations.length : 0;
        const ratioCommissionPL = totalPL > 0 ? (totalCommissions / Math.abs(totalPL)) * 100 : 0;
        const maxCommission = commissionsArray.length > 0 ? Math.max(...commissionsArray) : 0;
        const minCommission = commissionsArray.length > 0 ? Math.min(...commissionsArray) : 0;

        console.log(`üìä [Comisiones] Total: $${totalCommissions.toFixed(2)}, Avg: $${avgCommission.toFixed(2)}, Ratio: ${ratioCommissionPL.toFixed(2)}%`);

        // Calcular promedios diarios y mensuales
        const uniqueDays = [...new Set(operations.map(op => op.date))].length;
        const uniqueMonths = Object.keys(commissionsByMonth).length;
        const commissionsPerDay = uniqueDays > 0 ? totalCommissions / uniqueDays : 0;
        const commissionsPerMonth = uniqueMonths > 0 ? totalCommissions / uniqueMonths : 0;

        // Actualizar m√©tricas escritas (con validaci√≥n)
        const updateElement = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
            else console.warn(`[Comisiones] Elemento no encontrado: ${id}`);
        };
        
        updateElement('comisiones-total', `$${totalCommissions.toFixed(2)}`);
        updateElement('comisiones-avg-trade', `$${avgCommission.toFixed(2)}`);
        updateElement('comisiones-avg-trade-inline', `$${avgCommission.toFixed(2)}`);
        updateElement('comisiones-ratio-total', `${ratioCommissionPL.toFixed(2)}%`);
        updateElement('comisiones-impact-winrate', tradesImpacted);
        updateElement('comisiones-per-day', `$${commissionsPerDay.toFixed(2)}`);
        updateElement('comisiones-per-month', `$${commissionsPerMonth.toFixed(2)}`);
        updateElement('comisiones-max', `$${maxCommission.toFixed(2)}`);
        updateElement('comisiones-min', `$${minCommission.toFixed(2)}`);
        updateElement('comisiones-total-trades', operations.length);
        updateElement('comisiones-symbols-count', Object.keys(commissionsBySymbol).length);
        
        console.log(`‚úÖ [Comisiones] M√©tricas actualizadas: Total=$${totalCommissions.toFixed(2)}, Avg=$${avgCommission.toFixed(2)}, Trades=${operations.length}`);

        // Gr√°fica 1: Comisiones por S√≠mbolo
        const ctx1 = document.getElementById('comisiones-by-symbol-chart')?.getContext('2d');
        if (ctx1) {
            const sortedSymbols = Object.entries(commissionsBySymbol)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 15);

            comisionesCharts.bySymbol = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedSymbols.map(([symbol]) => symbol),
                    datasets: [{
                        label: 'Comisiones Totales',
                        data: sortedSymbols.map(([, data]) => data.total),
                        backgroundColor: 'rgba(255,193,7,0.7)',
                        borderColor: 'rgba(255,193,7,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Comisiones: $${ctx.parsed.x.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                    }
                }
            });
        }

        // Gr√°fica 2: Ratio Comisi√≥n/P/L por S√≠mbolo
        const ctx2 = document.getElementById('comisiones-ratio-symbol-chart')?.getContext('2d');
        if (ctx2) {
            const ratios = {};
            Object.entries(commissionsBySymbol).forEach(([symbol, data]) => {
                if (Math.abs(data.pl) > 0) {
                    ratios[symbol] = (data.total / Math.abs(data.pl)) * 100;
                }
            });

            const sortedRatios = Object.entries(ratios)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15);

            comisionesCharts.ratioSymbol = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sortedRatios.map(([symbol]) => symbol),
                    datasets: [{
                        label: 'Ratio %',
                        data: sortedRatios.map(([, ratio]) => ratio),
                        backgroundColor: sortedRatios.map(([, ratio]) =>
                            ratio > 30 ? 'rgba(239,68,68,0.7)' :
                            ratio > 15 ? 'rgba(255,193,7,0.7)' :
                            'rgba(57,255,20,0.7)'
                        )
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.parsed.x.toFixed(1)}% de P/L en comisiones`
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', callback: (v) => v + '%' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                    }
                }
            });
        }

        // Gr√°fica 3: Comisiones por Mes
        const ctx3 = document.getElementById('comisiones-monthly-chart')?.getContext('2d');
        if (ctx3) {
            const sortedMonths = Object.keys(commissionsByMonth).sort();
            const monthlyCommissions = sortedMonths.map(month => commissionsByMonth[month].commissions);

            comisionesCharts.monthly = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Comisiones Mensuales',
                        data: monthlyCommissions,
                        borderColor: 'rgba(255,193,7,1)',
                        backgroundColor: 'rgba(255,193,7,0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Comisiones: $${ctx.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
        }

        // Gr√°fica 4: Comisiones vs P/L Neto
        const ctx4 = document.getElementById('comisiones-vs-pl-chart')?.getContext('2d');
        if (ctx4) {
            const sortedMonths = Object.keys(commissionsByMonth).sort();
            const monthlyPL = sortedMonths.map(month => commissionsByMonth[month].pl);
            const monthlyComm = sortedMonths.map(month => commissionsByMonth[month].commissions);

            comisionesCharts.vsPL = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'P/L Bruto',
                            data: monthlyPL,
                            backgroundColor: 'rgba(57,255,20,0.5)',
                            borderColor: 'rgba(57,255,20,1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Comisiones',
                            data: monthlyComm,
                            backgroundColor: 'rgba(255,193,7,0.5)',
                            borderColor: 'rgba(255,193,7,1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#ffffff' } }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
                    }
                }
            });
        }

        // Gr√°fica 5: Distribuci√≥n de Comisiones
        const ctx5 = document.getElementById('comisiones-distribution-chart')?.getContext('2d');
        if (ctx5) {
            const ranges = {
                '< $1': 0,
                '$1-5': 0,
                '$5-10': 0,
                '$10-25': 0,
                '> $25': 0
            };

            commissionsArray.forEach(comm => {
                if (comm < 1) ranges['< $1']++;
                else if (comm < 5) ranges['$1-5']++;
                else if (comm < 10) ranges['$5-10']++;
                else if (comm < 25) ranges['$10-25']++;
                else ranges['> $25']++;
            });

            comisionesCharts.distribution = new Chart(ctx5, {
                type: 'pie',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(57,255,20,0.7)',
                            'rgba(135,206,250,0.7)',
                            'rgba(255,193,7,0.7)',
                            'rgba(255,140,0,0.7)',
                            'rgba(255,65,54,0.7)'
                        ],
                        borderColor: '#0a0a0a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#ffffff' } }
                    }
                }
            });
        }

        // Gr√°fica 6: P/L Neto por S√≠mbolo (despu√©s de comisiones)
        const ctx6 = document.getElementById('comisiones-net-pl-symbol-chart')?.getContext('2d');
        if (ctx6) {
            const netPL = {};
            Object.entries(commissionsBySymbol).forEach(([symbol, data]) => {
                netPL[symbol] = data.pl - data.total;
            });

            const sortedNetPL = Object.entries(netPL)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15);

            comisionesCharts.netPL = new Chart(ctx6, {
                type: 'bar',
                data: {
                    labels: sortedNetPL.map(([symbol]) => symbol),
                    datasets: [{
                        label: 'P/L Neto',
                        data: sortedNetPL.map(([, pl]) => pl),
                        backgroundColor: sortedNetPL.map(([, pl]) => pl >= 0 ? 'rgba(57,255,20,0.7)' : 'rgba(255,65,54,0.7)')
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `P/L Neto: $${ctx.parsed.x.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0', font: { size: 9 } } }
                    }
                }
            });
        }
        
        // Gr√°fica 7: Commission Impact (Barras apiladas)
        const ctx7 = document.getElementById('commission-impact-chart')?.getContext('2d');
        if (ctx7) {
            // Agrupar por mes
            const monthlyData = {};
            
            operations.forEach(op => {
                if (!op.date) return;
                const monthKey = op.date.substring(0, 7); // YYYY-MM
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        grossPL: 0,
                        commissions: 0,
                        netPL: 0
                    };
                }
                
                const pl = op.pl || 0;
                const fee = op.fee || op.fees || 0;
                
                monthlyData[monthKey].grossPL += pl;
                monthlyData[monthKey].commissions += fee;
                monthlyData[monthKey].netPL += (pl - fee);
            });
            
            // Ordenar por fecha
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            
            const grossPLData = sortedMonths.map(m => monthlyData[m].grossPL);
            const netPLData = sortedMonths.map(m => monthlyData[m].netPL);
            const commissionsData = sortedMonths.map(m => -monthlyData[m].commissions); // Negativo para mostrar como p√©rdida
            
            comisionesCharts.impact = new Chart(ctx7, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'P/L Bruto',
                            data: grossPLData,
                            backgroundColor: 'rgba(57,255,20,0.7)',
                            borderColor: 'rgba(57,255,20,1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Comisiones',
                            data: commissionsData,
                            backgroundColor: 'rgba(255,65,54,0.7)',
                            borderColor: 'rgba(255,65,54,1)',
                            borderWidth: 1
                        },
                        {
                            label: 'P/L Neto',
                            data: netPLData,
                            backgroundColor: 'rgba(135,206,250,0.7)',
                            borderColor: 'rgba(135,206,250,1)',
                            borderWidth: 1,
                            type: 'line',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#ffffff', font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += '$' + Math.abs(context.parsed.y).toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#a0a0a0',
                                callback: (value) => '$' + value.toFixed(0)
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0', maxRotation: 45, minRotation: 0 }
                        }
                    }
                }
            });
        }
}

// Hook into tab switching cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    const informeSubTabs = document.querySelectorAll('.informe-sub-tab');
    informeSubTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            if (tab.dataset.target === 'informe-comisiones-content') {
                setTimeout(refreshComisiones, 50);
            }
        });
    });
});

// =============================================
// CHARTBOOK - GALER√çA DE TRADES CON IM√ÅGENES
// =============================================
(function() {
    console.log('üìä INICIANDO CHARTBOOK...');
    
    function refreshChartbook() {
        console.log('--- Refreshing Chartbook ---');
        
        const selectedAccount = document.getElementById('chartbook-account-select')?.value || 'all';
        const filter = document.getElementById('chartbook-filter')?.value || 'all';
        
        let operations = [...DB.operations];
        
        // Filtrar por cuenta
        if (selectedAccount !== 'all') {
            operations = operations.filter(op => op.accountId === selectedAccount);
        }
        
        // Filtrar por tipo
        if (filter === 'wins') {
            operations = operations.filter(op => op.result === 'win');
        } else if (filter === 'losses') {
            operations = operations.filter(op => op.result === 'loss');
        } else if (filter === 'with-images') {
            operations = operations.filter(op => op.imageDatas && op.imageDatas.length > 0);
        }
        
        // Ordenar por fecha descendente
        operations.sort((a, b) => new Date(b.date + 'T' + (b.entryTime || '00:00')) - new Date(a.date + 'T' + (a.entryTime || '00:00')));
        
        // Actualizar estad√≠sticas
        const totalTrades = operations.length;
        const withImages = operations.filter(op => op.imageDatas && op.imageDatas.length > 0).length;
        const wins = operations.filter(op => op.result === 'win').length;
        const losses = operations.filter(op => op.result === 'loss').length;
        
        document.getElementById('chartbook-total-trades').textContent = totalTrades;
        document.getElementById('chartbook-with-images').textContent = withImages;
        document.getElementById('chartbook-wins').textContent = wins;
        document.getElementById('chartbook-losses').textContent = losses;
        
        // Renderizar galer√≠a
        const container = document.getElementById('chartbook-container');
        if (!container) return;
        
        if (operations.length === 0) {
            container.innerHTML = `
                <div class="metric-card p-8 text-center">
                    <p class="text-gray-400">No hay trades para mostrar</p>
                    <p class="text-sm text-gray-500 mt-2">Agrega screenshots a tus trades en la secci√≥n de Operaciones</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = operations.map(op => {
            const hasImages = op.imageDatas && op.imageDatas.length > 0;
            const plColor = op.pl >= 0 ? 'text-positive' : 'text-negative';
            const resultBadge = op.result === 'win' 
                ? '<span class="px-2 py-1 bg-green-900 text-green-300 rounded text-xs">WIN</span>'
                : '<span class="px-2 py-1 bg-red-900 text-red-300 rounded text-xs">LOSS</span>';
            
            return `
                <div class="metric-card p-4 hover:bg-surface-hover transition-colors">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="text-lg font-semibold">${op.instrument || 'N/A'}</h3>
                                ${resultBadge}
                                <span class="px-2 py-1 bg-gray-800 text-gray-300 rounded text-xs">${op.type === 'buy' ? 'LONG' : 'SHORT'}</span>
                            </div>
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-calendar mr-1"></i>${op.date} ${op.entryTime || ''}
                            </p>
                            ${op.setup ? `<p class="text-xs text-primary mt-1"><i class="fas fa-tag mr-1"></i>${op.setup}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold ${plColor}">
                                ${op.pl >= 0 ? '+' : ''}${op.pl?.toFixed(2) || '0.00'} ${op.currency || 'USD'}
                            </p>
                            <p class="text-xs text-gray-400">ID: ${op.id.substring(0, 8)}</p>
                        </div>
                    </div>

                    <!-- Prices destacados -->
                    <div class="grid grid-cols-3 gap-3 mb-3 p-3 bg-surface rounded-lg border border-border">
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1"><i class="fas fa-sign-in-alt mr-1"></i>Entry</p>
                            <p class="font-bold text-green-400 text-lg">${op.entry || op.entryPrice || '-'}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1"><i class="fas fa-sign-out-alt mr-1"></i>Exit</p>
                            <p class="font-bold text-red-400 text-lg">${op.exit || op.exitPrice || '-'}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400 mb-1"><i class="fas fa-chart-bar mr-1"></i>Volume</p>
                            <p class="font-semibold text-white">${op.volume || '-'}</p>
                        </div>
                    </div>
                    
                    ${hasImages ? `
                        <div class="grid grid-cols-${op.imageDatas.length >= 3 ? '3' : op.imageDatas.length} gap-2 mb-3">
                            ${op.imageDatas.map((imgData, idx) => {
                                const imgSrc = typeof imgData === 'string' ? imgData : (imgData.data || imgData.url || imgData.src || '');
                                return `
                                    <img src="${imgSrc}" 
                                         class="w-full h-48 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity border-2 border-transparent hover:border-primary"
                                         data-op-id="${op.id}"
                                         data-img-index="${idx}"
                                         alt="Trade screenshot ${idx + 1}">
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="bg-gray-900 h-48 rounded flex items-center justify-center mb-3">
                            <p class="text-gray-600"><i class="fas fa-image mr-2"></i>Sin im√°genes</p>
                        </div>
                    `}
                    
                    ${op.notes ? `
                        <div class="bg-gray-900 p-3 rounded text-sm text-gray-300 mb-3">
                            <i class="fas fa-sticky-note mr-2"></i>${op.notes}
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end gap-2">
                        <button class="text-xs px-3 py-1 bg-blue-900 text-blue-300 rounded hover:bg-blue-800" 
                                onclick="editTrade('${op.id}')">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button class="text-xs px-3 py-1 bg-gray-800 text-gray-300 rounded hover:bg-gray-700" 
                                onclick="viewTradeDetails('${op.id}')">
                            <i class="fas fa-eye mr-1"></i>Ver Detalles
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Agregar event listeners a las im√°genes despu√©s de renderizar
        setTimeout(() => {
            container.querySelectorAll('img[data-op-id]').forEach(img => {
                img.addEventListener('click', function() {
                    const opId = this.dataset.opId;
                    const imgIndex = parseInt(this.dataset.imgIndex);
                    const operation = DB.operations.find(op => op.id === opId);
                    
                    if (operation && operation.imageDatas) {
                        const imageUrls = operation.imageDatas.map(imgData => 
                            typeof imgData === 'string' ? imgData : (imgData.data || imgData.url || imgData.src || '')
                        ).filter(url => url && url.length > 0);
                        
                        console.log('üñºÔ∏è [Chartbook] Abriendo modal con', imageUrls.length, 'im√°genes, √≠ndice', imgIndex);
                        openImageModal(imageUrls, imgIndex);
                    }
                });
            });
        }, 100);
    }
    
    // Event listeners
    document.getElementById('chartbook-account-select')?.addEventListener('change', (e) => {
        const selectedAccount = e.target.value;
        syncAccountSelection(selectedAccount);
        refreshChartbook();
    });
    document.getElementById('chartbook-filter')?.addEventListener('change', refreshChartbook);
    
    // Inicializar selector de cuentas
    console.log('üìä Inicializando selector de cuentas Chartbook...');
    if (typeof updateAccountSelect === 'function') {
        updateAccountSelect('chartbook-account-select');
        console.log('‚úÖ Selector de cuentas Chartbook inicializado');
    } else {
        console.error('‚ùå updateAccountSelect no est√° definida');
    }
    
    // Funci√≥n para abrir modal de imagen (NO USAR - usar la global openImageModal en su lugar)
    // window.openImageModal ya est√° definida globalmente con mejor funcionalidad
    
    // Funciones auxiliares para editar y ver detalles
    window.editTrade = function(opId) {
        const op = DB.operations.find(o => o.id === opId);
        if (!op) return;
        
        // Navegar a Operaciones y abrir editor
        const operationsNav = document.querySelector('[data-target="operations"]');
        if (operationsNav) {
            operationsNav.click();
            setTimeout(() => {
                if (typeof toggleAddOperationForm === 'function') {
                    toggleAddOperationForm(op);
                }
            }, 200);
        }
    };
    
    window.viewTradeDetails = function(opId) {
        const op = DB.operations.find(o => o.id === opId);
        if (!op) return;
        
        // Navegar a Operaciones y mostrar en tabla
        const operationsNav = document.querySelector('[data-target="operations"]');
        if (operationsNav) {
            operationsNav.click();
        }
    };
    
    // Inicializar al cargar la secci√≥n
    const chartbookNav = document.querySelector('[data-target="chartbook"]');
    if (chartbookNav) {
        chartbookNav.addEventListener('click', () => {
            setTimeout(() => {
                if (typeof updateAccountSelect === 'function') {
                    updateAccountSelect('chartbook-account-select');
                }
                refreshChartbook();
            }, 100);
        });
    }
    
    // Inicializaci√≥n inicial
    console.log('üîÑ Inicializando Chartbook...');
    setTimeout(() => {
        if (typeof updateAccountSelect === 'function') {
            updateAccountSelect('chartbook-account-select');
            console.log('‚úÖ Selector de cuentas poblado');
        }
        if (typeof updateSelectorLogo === 'function') {
            updateSelectorLogo('chartbook-account-select');
        }
        refreshChartbook();
        console.log('‚úÖ Chartbook inicializado');
    }, 500);
    
    window.refreshChartbook = refreshChartbook;
})();

// =============================================
// EQUITY GRAPH - GR√ÅFICO DE EQUITY
// =============================================
(function() {
    console.log('üìà INICIANDO EQUITY GRAPH...');
    let equityChart = null;

    // Funci√≥n para aplicar filtros a las operaciones
    function applyEquityFilters(operations) {
        let filtered = [...operations];

        // Filtro de Per√≠odo
        const periodFilter = document.getElementById('equity-period-filter')?.value || 'all';
        if (periodFilter !== 'all') {
            const now = new Date();
            let cutoffDate = null;

            switch (periodFilter) {
                case '1w':
                    cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '1m':
                    cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '3m':
                    cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case '6m':
                    cutoffDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case '1y':
                    cutoffDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'custom':
                    const dateFrom = document.getElementById('equity-date-from')?.value;
                    const dateTo = document.getElementById('equity-date-to')?.value;
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        filtered = filtered.filter(op => new Date(op.date) >= fromDate);
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        filtered = filtered.filter(op => new Date(op.date) <= toDate);
                    }
                    return filtered; // Retornar temprano para rango personalizado
            }

            if (cutoffDate) {
                filtered = filtered.filter(op => new Date(op.date) >= cutoffDate);
            }
        }

        // Filtro de Instrumento
        const instrumentFilter = document.getElementById('equity-instrument-filter')?.value;
        if (instrumentFilter && instrumentFilter !== 'all') {
            filtered = filtered.filter(op => op.instrument === instrumentFilter);
        }

        // Filtro de Resultado
        const outcomeFilter = document.getElementById('equity-outcome-filter')?.value || 'all';
        if (outcomeFilter !== 'all') {
            filtered = filtered.filter(op => op.result === outcomeFilter);
        }

        // Filtro de Direcci√≥n
        const directionFilter = document.getElementById('equity-direction-filter')?.value || 'all';
        if (directionFilter !== 'all') {
            filtered = filtered.filter(op => op.direction?.toLowerCase() === directionFilter);
        }

        // Filtro de Setup
        const setupFilter = document.getElementById('equity-setup-filter')?.value;
        if (setupFilter && setupFilter !== 'all') {
            filtered = filtered.filter(op => op.setup === setupFilter);
        }

        // Filtro de RRR
        const rrrFilter = parseFloat(document.getElementById('equity-rrr-filter')?.value || 0);
        if (rrrFilter > 0) {
            filtered = filtered.filter(op => (op.rrr || 0) >= rrrFilter);
        }

        // Filtro de Marcadas
        const starredFilter = document.getElementById('equity-starred-filter')?.value || 'all';
        if (starredFilter === 'starred') {
            filtered = filtered.filter(op => op.isStarred === true);
        } else if (starredFilter === 'not-starred') {
            filtered = filtered.filter(op => !op.isStarred);
        }

        // Filtro de √öltimas N Operaciones
        const lastTradesFilter = document.getElementById('equity-last-trades-filter')?.value;
        if (lastTradesFilter && lastTradesFilter !== 'all') {
            const limit = parseInt(lastTradesFilter);
            filtered = filtered.slice(-limit);
        }

        return filtered;
    }

    // Funci√≥n para popular selectores de filtros
    function populateEquityFilters() {
        // Popular Instrumentos
        const instrumentFilter = document.getElementById('equity-instrument-filter');
        if (instrumentFilter) {
            const instruments = [...new Set(DB.operations.map(op => op.instrument))].filter(Boolean).sort();
            instrumentFilter.innerHTML = '<option value="all">Todos</option>';
            instruments.forEach(inst => {
                const option = document.createElement('option');
                option.value = inst;
                option.textContent = inst;
                instrumentFilter.appendChild(option);
            });
        }

        // Popular Setups
        const setupFilter = document.getElementById('equity-setup-filter');
        if (setupFilter) {
            const setups = [...new Set(DB.operations.map(op => op.setup))].filter(Boolean).sort();
            setupFilter.innerHTML = '<option value="all">Todos</option>';
            setups.forEach(setup => {
                const option = document.createElement('option');
                option.value = setup;
                option.textContent = setup;
                setupFilter.appendChild(option);
            });
        }
    }

    function refreshEquityGraph() {
        console.log('--- Refreshing Equity Graph ---');
        
        if (!document.getElementById('equity-graph').classList.contains('active')) {
            console.log('Equity Graph tab not active, skipping refresh.');
            return;
        }

        const accountSelect = document.getElementById('equity-account-select');
        if (!accountSelect) return;
        
        const selectedAccount = accountSelect.value;
        let operations = [...DB.operations].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (selectedAccount !== 'all') {
            operations = operations.filter(op => op.accountId === selectedAccount);
        }

        // Aplicar filtros
        operations = applyEquityFilters(operations);

        // Actualizar contador de operaciones filtradas
        const filteredCount = document.getElementById('equity-filtered-count');
        if (filteredCount) {
            filteredCount.textContent = operations.length;
        }

        // Calcular balance inicial
        let initialBalance = 0;
        if (selectedAccount === 'all') {
            initialBalance = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency), 0);
        } else {
            const account = DB.accounts.find(a => a.id === selectedAccount);
            if (account) {
                initialBalance = convertCurrency(account.initialBalance, account.currency, DB.settings.defaultCurrency);
            }
        }

        // Obtener modo de visualizaci√≥n
        const displayMode = document.getElementById('equity-display-mode')?.value || 'return';
        const groupBy = document.getElementById('equity-group-by')?.value || 'trades';

        // Construir datos de equity
        let cumulativePL = 0;
        const labels = [0];
        const equityData = [displayMode === 'balance' ? initialBalance : 0];
        const positiveData = [null];
        const negativeData = [null];

        operations.forEach((op, index) => {
            const pl = convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
            cumulativePL += pl;
            
            labels.push(index + 1);
            
            let dataValue = 0;
            switch (displayMode) {
                case 'balance':
                    dataValue = initialBalance + cumulativePL;
                    break;
                case 'return-pct':
                    dataValue = initialBalance > 0 ? (cumulativePL / initialBalance) * 100 : 0;
                    break;
                case 'roi':
                    dataValue = initialBalance > 0 ? (cumulativePL / initialBalance) * 100 : 0;
                    break;
                case 'r-multiple':
                    dataValue = op.rrr || 0;
                    break;
                default: // return
                    dataValue = cumulativePL;
            }
            
            equityData.push(dataValue);
            
            if (dataValue >= (displayMode === 'balance' ? initialBalance : 0)) {
                positiveData.push(dataValue);
                negativeData.push(null);
            } else {
                positiveData.push(null);
                negativeData.push(dataValue);
            }
        });

        // Actualizar m√©tricas
        const totalTrades = operations.length;
        const winners = operations.filter(op => op.result === 'win').length;
        const losers = operations.filter(op => op.result === 'loss').length;
        const winrate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
        
        const totalWinPL = operations.filter(op => op.result === 'win').reduce((sum, op) => sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency), 0);
        const totalLossPL = Math.abs(operations.filter(op => op.result === 'loss').reduce((sum, op) => sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency), 0));
        const profitFactor = totalLossPL > 0 ? totalWinPL / totalLossPL : (totalWinPL > 0 ? 999 : 0);
        
        const avgPL = totalTrades > 0 ? cumulativePL / totalTrades : 0;
        const returnPercent = initialBalance > 0 ? (cumulativePL / initialBalance) * 100 : 0;
        const currentBalance = initialBalance + cumulativePL;
        
        const biggestWinner = operations.length > 0 ? Math.max(...operations.map(op => convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency))) : 0;
        const biggestLoser = operations.length > 0 ? Math.min(...operations.map(op => convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency))) : 0;

        document.getElementById('equity-account-balance').textContent = `$${currentBalance.toFixed(2)}`;
        document.getElementById('equity-total-trades').textContent = totalTrades;
        document.getElementById('equity-winners').textContent = winners;
        document.getElementById('equity-losers').textContent = losers;
        document.getElementById('equity-winrate').textContent = `${winrate.toFixed(2)}%`;
        document.getElementById('equity-avg-pl').textContent = `$${avgPL.toFixed(2)}`;
        document.getElementById('equity-profit-factor').textContent = profitFactor.toFixed(2);
        document.getElementById('equity-return-percent').textContent = `${returnPercent.toFixed(1)}%`;
        document.getElementById('equity-profit-loss').textContent = `$${cumulativePL.toFixed(2)}`;
        document.getElementById('equity-biggest-winner').textContent = `$${biggestWinner.toFixed(2)}`;
        document.getElementById('equity-biggest-loser').textContent = `$${biggestLoser.toFixed(2)}`;

        // Aplicar colores a las m√©tricas
        const plElement = document.getElementById('equity-profit-loss');
        if (plElement) {
            plElement.classList.remove('text-green', 'text-red', 'text-white');
            plElement.classList.add(cumulativePL >= 0 ? 'text-green' : 'text-red');
        }
        
        const balanceElement = document.getElementById('equity-account-balance');
        if (balanceElement) {
            balanceElement.classList.remove('text-green', 'text-red', 'text-white');
            balanceElement.classList.add(cumulativePL >= 0 ? 'text-green' : cumulativePL < 0 ? 'text-red' : 'text-white');
        }

        // Determinar etiqueta del eje Y seg√∫n modo de visualizaci√≥n
        let yAxisLabel = 'Return ($)';
        let yAxisCallback = (value) => '$' + value.toFixed(0);
        
        switch (displayMode) {
            case 'balance':
                yAxisLabel = 'Account Balance ($)';
                yAxisCallback = (value) => '$' + value.toFixed(0);
                break;
            case 'return-pct':
            case 'roi':
                yAxisLabel = 'Return (%)';
                yAxisCallback = (value) => value.toFixed(1) + '%';
                break;
            case 'r-multiple':
                yAxisLabel = 'R Multiple';
                yAxisCallback = (value) => value.toFixed(1) + 'R';
                break;
        }

        // Crear gr√°fico
        const canvas = document.getElementById('equity-main-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        if (equityChart) {
            equityChart.destroy();
        }

        const baselineValue = displayMode === 'balance' ? initialBalance : 0;

        equityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Profit',
                        data: positiveData,
                        borderColor: '#39ff14',
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        fill: 'origin',
                        borderWidth: 3,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        segment: {
                            borderColor: (ctx) => {
                                const value = ctx.p1.parsed.y;
                                return value >= baselineValue ? '#39ff14' : 'transparent';
                            }
                        }
                    },
                    {
                        label: 'Loss',
                        data: negativeData,
                        borderColor: '#ff4136',
                        backgroundColor: 'rgba(255, 65, 54, 0.2)',
                        fill: 'origin',
                        borderWidth: 3,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        segment: {
                            borderColor: (ctx) => {
                                const value = ctx.p1.parsed.y;
                                return value < baselineValue ? '#ff4136' : 'transparent';
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: (items) => `Trade ${items[0].label}`,
                            label: (item) => {
                                if (item.parsed.y === null) return '';
                                return yAxisLabel + ': ' + yAxisCallback(item.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Trades',
                            color: '#ffffff',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#a0a0a0',
                            maxTicksLimit: 20
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisLabel,
                            color: '#ffffff',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#a0a0a0',
                            callback: yAxisCallback
                        }
                    }
                }
            }
        });
    }

    // Inicializaci√≥n de Event Listeners para Filtros
    function initEquityFiltersListeners() {
        // Toggle panel de filtros
        const toggleFiltersBtn = document.getElementById('equity-toggle-filters-btn');
        const filtersPanel = document.getElementById('equity-filters-panel');
        
        if (toggleFiltersBtn && filtersPanel) {
            toggleFiltersBtn.addEventListener('click', () => {
                const isVisible = filtersPanel.style.display !== 'none';
                filtersPanel.style.display = isVisible ? 'none' : 'block';
                toggleFiltersBtn.classList.toggle('active', !isVisible);
            });
        }

        // Mostrar/ocultar rango de fechas personalizado
        const periodFilter = document.getElementById('equity-period-filter');
        const customDateRange = document.getElementById('equity-custom-date-range');
        
        if (periodFilter && customDateRange) {
            periodFilter.addEventListener('change', () => {
                customDateRange.style.display = periodFilter.value === 'custom' ? 'block' : 'none';
            });
        }

        // Aplicar filtros
        const applyFiltersBtn = document.getElementById('equity-apply-filters-btn');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                populateEquityFilters();
                refreshEquityGraph();
            });
        }

        // Limpiar filtros
        const clearFiltersBtn = document.getElementById('equity-clear-filters-btn');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                const periodFilterEl = document.getElementById('equity-period-filter');
                const instrumentFilterEl = document.getElementById('equity-instrument-filter');
                const outcomeFilterEl = document.getElementById('equity-outcome-filter');
                const directionFilterEl = document.getElementById('equity-direction-filter');
                const setupFilterEl = document.getElementById('equity-setup-filter');
                const rrrFilterEl = document.getElementById('equity-rrr-filter');
                const starredFilterEl = document.getElementById('equity-starred-filter');
                const displayModeEl = document.getElementById('equity-display-mode');
                const groupByEl = document.getElementById('equity-group-by');
                const lastTradesFilterEl = document.getElementById('equity-last-trades-filter');
                const dateFromEl = document.getElementById('equity-date-from');
                const dateToEl = document.getElementById('equity-date-to');
                const customDateRangeEl = document.getElementById('equity-custom-date-range');

                if (periodFilterEl) periodFilterEl.value = 'all';
                if (instrumentFilterEl) instrumentFilterEl.value = 'all';
                if (outcomeFilterEl) outcomeFilterEl.value = 'all';
                if (directionFilterEl) directionFilterEl.value = 'all';
                if (setupFilterEl) setupFilterEl.value = 'all';
                if (rrrFilterEl) rrrFilterEl.value = '0';
                if (starredFilterEl) starredFilterEl.value = 'all';
                if (displayModeEl) displayModeEl.value = 'return';
                if (groupByEl) groupByEl.value = 'trades';
                if (lastTradesFilterEl) lastTradesFilterEl.value = 'all';
                if (dateFromEl) dateFromEl.value = '';
                if (dateToEl) dateToEl.value = '';
                if (customDateRangeEl) customDateRangeEl.style.display = 'none';
                
                refreshEquityGraph();
            });
        }

        // Auto-refresh cuando cambian los filtros
        const autoRefreshFilters = [
            'equity-display-mode',
            'equity-group-by'
        ];
        
        autoRefreshFilters.forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) {
                filter.addEventListener('change', () => {
                    if (document.getElementById('equity-graph').classList.contains('active')) {
                        refreshEquityGraph();
                    }
                });
            }
        });
    }

    // Event listeners
    const accountSelect = document.getElementById('equity-account-select');
    if (accountSelect) {
        accountSelect.addEventListener('change', () => {
            updateSelectorLogo('equity-account-select');
            refreshEquityGraph();
        });
    }

    // Inicializaci√≥n con delay
    console.log('üîÑ Inicializando Equity Graph...');
    setTimeout(() => {
        if (typeof updateAccountSelect === 'function') {
            updateAccountSelect('equity-account-select');
            console.log('‚úÖ Selector de cuentas Equity Graph poblado');
        }
        if (typeof updateSelectorLogo === 'function') {
            updateSelectorLogo('equity-account-select');
        }
        populateEquityFilters();
        initEquityFiltersListeners();
        if (document.getElementById('equity-graph').classList.contains('active')) {
            refreshEquityGraph();
        }
        console.log('‚úÖ Equity Graph inicializado');
    }, 500);
    
    window.refreshEquityGraph = refreshEquityGraph;
})();

// =============================================
// DAILY JOURNAL - DIARIO DE TRADING DIARIO
// =============================================
(function() {
    console.log('üìî INICIANDO DAILY JOURNAL...');
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let dayCharts = {}; // Almacenar instancias de gr√°ficos por d√≠a
    
    // Almacenamiento de notas diarias
    if (!DB.dailyNotes) {
        DB.dailyNotes = {};
    }
    
    function refreshDailyJournal() {
        console.log('--- Refreshing Daily Journal ---');
        
        if (!document.getElementById('daily-journal').classList.contains('active')) {
            console.log('Daily Journal tab not active, skipping refresh.');
            return;
        }
        
        const accountSelect = document.getElementById('daily-journal-account-select');
        if (!accountSelect) return;
        
        const selectedAccount = accountSelect.value;
        let operations = [...DB.operations];
        
        // Filtrar por cuenta
        if (selectedAccount !== 'all') {
            operations = operations.filter(op => op.accountId === selectedAccount);
        }
        
        // Agrupar operaciones por d√≠a
        const dayGroups = {};
        operations.forEach(op => {
            const date = op.date;
            if (!dayGroups[date]) {
                dayGroups[date] = [];
            }
            dayGroups[date].push(op);
        });
        
        // Ordenar d√≠as por fecha descendente (m√°s reciente primero)
        const sortedDates = Object.keys(dayGroups).sort((a, b) => new Date(b) - new Date(a));
        
        // Renderizar lista de d√≠as
        const listContainer = document.getElementById('daily-journal-list');
        if (!listContainer) return;
        
        if (sortedDates.length === 0) {
            listContainer.innerHTML = `
                <div class="metric-card text-center py-12">
                    <i class="fas fa-book text-6xl text-text-secondary mb-4"></i>
                    <p class="text-text-secondary">No hay operaciones registradas</p>
                </div>
            `;
        } else {
            listContainer.innerHTML = sortedDates.map(date => {
                const dayOps = dayGroups[date];
                return renderDayCard(date, dayOps);
            }).join('');
            
            // Inicializar gr√°ficos para cada d√≠a
            setTimeout(() => {
                sortedDates.forEach(date => {
                    createDayChart(date, dayGroups[date]);
                });
            }, 100);
        }
        
        // Renderizar calendario mini
        renderMiniCalendar(dayGroups);
    }
    
    function renderDayCard(date, operations) {
        // Calcular m√©tricas del d√≠a
        const totalTrades = operations.length;
        const winners = operations.filter(op => op.result === 'win').length;
        const losers = operations.filter(op => op.result === 'loss').length;
        const winrate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
        
        const grossPL = operations.reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const commissions = operations.reduce((sum, op) => {
            return sum + convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const netPL = grossPL - commissions;
        
        const volume = operations.reduce((sum, op) => sum + (op.volume || 0), 0);
        
        const totalWinPL = operations.filter(op => op.result === 'win').reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const totalLossPL = Math.abs(operations.filter(op => op.result === 'loss').reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0));
        
        const profitFactor = totalLossPL > 0 ? totalWinPL / totalLossPL : (totalWinPL > 0 ? 999 : 0);
        
        // Formatear fecha al estilo "Wed, Jun 26, 2024"
        const dateObj = new Date(date + 'T12:00:00');
        const formattedDate = dateObj.toLocaleDateString('es-ES', { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        
        // Formatear fecha completa para el modal de an√°lisis
        const dayFullName = dateObj.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        });
        
        const plClass = netPL >= 0 ? 'positive' : 'negative';
        const hasNote = DB.dailyNotes && DB.dailyNotes[date];
        
        return `
            <div class="daily-journal-day-card" data-date="${date}">
                <div class="daily-journal-header" onclick="toggleDayExpansion('${date}')">
                    <div>
                        <div class="daily-journal-date">${formattedDate}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="daily-journal-pl ${plClass}">
                            Net P&L $${netPL.toFixed(2)}
                        </div>
                        <i class="fas fa-chevron-down transition-transform" id="chevron-${date}"></i>
                    </div>
                </div>
                
                <div id="day-content-${date}" class="day-content" style="display: block;">
                    <!-- Gr√°fico de √°rea del d√≠a -->
                    <div class="daily-journal-chart-container">
                        <canvas id="day-chart-${date}"></canvas>
                    </div>
                    
                    <!-- M√©tricas del d√≠a -->
                    <div class="daily-journal-metrics">
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Total Trades</div>
                            <div class="daily-journal-metric-value">${totalTrades}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Winners</div>
                            <div class="daily-journal-metric-value" style="color: var(--success);">${winners}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Losers</div>
                            <div class="daily-journal-metric-value" style="color: var(--danger);">${losers}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Winrate</div>
                            <div class="daily-journal-metric-value">${winrate.toFixed(1)}%</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Gross P&L</div>
                            <div class="daily-journal-metric-value">$${grossPL.toFixed(2)}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Volumen</div>
                            <div class="daily-journal-metric-value">${volume.toFixed(2)}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Comisiones</div>
                            <div class="daily-journal-metric-value">$${commissions.toFixed(2)}</div>
                        </div>
                        <div class="daily-journal-metric">
                            <div class="daily-journal-metric-label">Profit Factor</div>
                            <div class="daily-journal-metric-value">${profitFactor.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="mt-4 flex justify-end gap-2">
                        <button class="daily-journal-note-btn" onclick="openDayAnalysis('${date}')">
                            <i class="fas fa-book-open"></i>
                            <span>Notebook</span>
                        </button>
                        <button class="daily-journal-note-btn has-note" onclick="openAnalyticsDetailModal('date', '${date}', 'D√≠a: ${dayFullName}')">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Abrir</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createDayChart(date, operations) {
        const canvas = document.getElementById(`day-chart-${date}`);
        if (!canvas) return;
        
        // Destruir gr√°fico existente si lo hay
        if (dayCharts[date]) {
            dayCharts[date].destroy();
        }
        
        // Ordenar operaciones por hora
        const sortedOps = [...operations].sort((a, b) => {
            const timeA = a.entryTime || '00:00';
            const timeB = b.entryTime || '00:00';
            return timeA.localeCompare(timeB);
        });
        
        // Calcular P&L acumulado
        let cumulative = 0;
        const labels = [];
        const data = [];
        const positiveData = [];
        const negativeData = [];
        
        sortedOps.forEach((op, index) => {
            const pl = convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
            cumulative += pl;
            
            labels.push(`#${index + 1}`);
            data.push(cumulative);
            
            if (cumulative >= 0) {
                positiveData.push(cumulative);
                negativeData.push(null);
            } else {
                positiveData.push(null);
                negativeData.push(cumulative);
            }
        });
        
        const ctx = canvas.getContext('2d');
        
        dayCharts[date] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Profit',
                        data: positiveData,
                        borderColor: '#39ff14',
                        backgroundColor: 'rgba(57, 255, 20, 0.3)',
                        fill: 'origin',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Loss',
                        data: negativeData,
                        borderColor: '#ff4136',
                        backgroundColor: 'rgba(255, 65, 54, 0.3)',
                        fill: 'origin',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 26, 26, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#39ff14',
                        borderWidth: 1,
                        callbacks: {
                            label: (item) => {
                                if (item.parsed.y === null) return '';
                                return `P&L Acumulado: $${item.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#a0a0a0',
                            font: { size: 10 }
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#a0a0a0',
                            font: { size: 10 },
                            callback: (value) => '$' + value.toFixed(0)
                        }
                    }
                }
            }
        });
    }
    
    function renderMiniCalendar(dayGroups) {
        const calendarContainer = document.getElementById('daily-journal-calendar-mini');
        if (!calendarContainer) return;
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        let calendarHTML = `
            <div class="daily-journal-calendar-header">
                <button class="daily-journal-calendar-nav" onclick="changeCalendarMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="daily-journal-calendar-month">${monthNames[currentMonth]} ${currentYear}</div>
                <button class="daily-journal-calendar-nav" onclick="changeCalendarMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="daily-journal-calendar-grid">
                <div class="daily-journal-calendar-day-header">D</div>
                <div class="daily-journal-calendar-day-header">L</div>
                <div class="daily-journal-calendar-day-header">M</div>
                <div class="daily-journal-calendar-day-header">X</div>
                <div class="daily-journal-calendar-day-header">J</div>
                <div class="daily-journal-calendar-day-header">V</div>
                <div class="daily-journal-calendar-day-header">S</div>
        `;
        
        // D√≠as vac√≠os al inicio
        for (let i = 0; i < startingDayOfWeek; i++) {
            calendarHTML += '<div class="daily-journal-calendar-day empty"></div>';
        }
        
        // D√≠as del mes
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getDate() === day && today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            let dayClass = 'daily-journal-calendar-day';
            if (isToday) dayClass += ' today';
            
            if (dayGroups[dateStr]) {
                const dayOps = dayGroups[dateStr];
                const netPL = dayOps.reduce((sum, op) => {
                    return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
                }, 0);
                
                dayClass += netPL >= 0 ? ' has-data positive' : ' has-data negative';
            }
            
            calendarHTML += `<div class="${dayClass}" onclick="scrollToDay('${dateStr}')">${day}</div>`;
        }
        
        calendarHTML += '</div>';
        calendarContainer.innerHTML = calendarHTML;
    }
    
    // Funciones globales
    window.toggleDayExpansion = function(date) {
        const content = document.getElementById(`day-content-${date}`);
        const chevron = document.getElementById(`chevron-${date}`);
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            chevron.style.transform = 'rotate(0deg)';
        } else {
            content.style.display = 'none';
            chevron.style.transform = 'rotate(-90deg)';
        }
    };
    
    window.scrollToDay = function(date) {
        const card = document.querySelector(`[data-date="${date}"]`);
        if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.style.borderColor = 'var(--primary)';
            setTimeout(() => {
                card.style.borderColor = '';
            }, 2000);
        }
    };
    
    window.changeCalendarMonth = function(delta) {
        currentMonth += delta;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        refreshDailyJournal();
    };
    
    // Nueva funci√≥n para abrir el an√°lisis del d√≠a
    window.openDayAnalysis = function(date, openImagesTab = false) {
        const modal = document.getElementById('day-analysis-modal');
        if (!modal) return;
        
        // Obtener operaciones del d√≠a
        const accountSelect = document.getElementById('daily-journal-account-select');
        const selectedAccount = accountSelect ? accountSelect.value : 'all';
        
        let dayOps = DB.operations.filter(op => op.date === date);
        if (selectedAccount !== 'all') {
            dayOps = dayOps.filter(op => op.accountId === selectedAccount);
        }
        
        // Calcular m√©tricas
        const totalTrades = dayOps.length;
        const winners = dayOps.filter(op => op.result === 'win').length;
        const losers = dayOps.filter(op => op.result === 'loss').length;
        const winrate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
        
        const grossPL = dayOps.reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const commissions = dayOps.reduce((sum, op) => {
            return sum + convertCurrency(op.fee || op.fees || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const netPL = grossPL - commissions;
        
        const totalWinPL = dayOps.filter(op => op.result === 'win').reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0);
        
        const totalLossPL = Math.abs(dayOps.filter(op => op.result === 'loss').reduce((sum, op) => {
            return sum + convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
        }, 0));
        
        const profitFactor = totalLossPL > 0 ? totalWinPL / totalLossPL : (totalWinPL > 0 ? 999 : 0);
        
        // Formatear fecha
        const dateObj = new Date(date + 'T12:00:00');
        const formattedDate = dateObj.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Actualizar modal
        document.getElementById('day-analysis-date').textContent = formattedDate;
        document.getElementById('day-analysis-net-pl').textContent = `$${netPL.toFixed(2)}`;
        document.getElementById('day-analysis-net-pl').className = netPL >= 0 ? 'text-xl font-bold text-green' : 'text-xl font-bold text-red';
        document.getElementById('day-analysis-trades').textContent = totalTrades;
        document.getElementById('day-analysis-winners').textContent = winners;
        document.getElementById('day-analysis-losers').textContent = losers;
        document.getElementById('day-analysis-winrate').textContent = `${winrate.toFixed(1)}%`;
        document.getElementById('day-analysis-gross-pl').textContent = `$${grossPL.toFixed(2)}`;
        document.getElementById('day-analysis-commissions').textContent = `$${commissions.toFixed(2)}`;
        document.getElementById('day-analysis-pf').textContent = profitFactor.toFixed(2);
        
        // Cargar notas e im√°genes del d√≠a
        loadDayAnalysisData(date);
        
        // Abrir pesta√±a correspondiente (im√°genes si openImagesTab es true, sino notas)
        if (openImagesTab) {
            switchDayAnalysisTab('images');
        } else {
            switchDayAnalysisTab('notes');
        }
        
        // Mostrar modal
        modal.style.display = 'flex';
        modal.dataset.currentDate = date;
    };
    
    function loadDayAnalysisData(date) {
        // Cargar notas
        const notes = (DB.dayAnalysisData && DB.dayAnalysisData[date] && DB.dayAnalysisData[date].notes) || '';
        const notesView = document.getElementById('day-analysis-notes-view');
        if (notes) {
            notesView.innerHTML = notes;
        } else {
            notesView.innerHTML = '<p class="text-text-secondary italic">Sin notas agregadas para este d√≠a.</p>';
        }
        
        // Cargar im√°genes
        const images = (DB.dayAnalysisData && DB.dayAnalysisData[date] && DB.dayAnalysisData[date].images) || [];
        renderDayAnalysisImages(images);
    }
    
    function renderDayAnalysisImages(images) {
        const imagesView = document.getElementById('day-analysis-images-view');
        if (!images || images.length === 0) {
            imagesView.innerHTML = '<p class="col-span-full text-center text-text-secondary italic py-8">Sin im√°genes agregadas para este d√≠a.</p>';
        } else {
            imagesView.innerHTML = images.map((img, index) => `
                <div class="relative group">
                    <img src="${img}" alt="Imagen ${index + 1}" class="w-full h-48 object-cover rounded border border-border cursor-pointer hover:opacity-80 transition" onclick="viewImageFullscreen('${img}')">
                    <button class="absolute top-2 right-2 bg-red text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition" onclick="deleteDayAnalysisImage(${index})" title="Eliminar">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }
    }
    
    window.viewImageFullscreen = function(src) {
        const viewer = document.createElement('div');
        viewer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
        viewer.innerHTML = `<img src="${src}" style="max-width:90%;max-height:90%;object-fit:contain;">`;
        viewer.onclick = () => viewer.remove();
        document.body.appendChild(viewer);
    };
    
    window.deleteDayAnalysisImage = function(index) {
        if (!confirm('¬øEliminar esta imagen?')) return;
        
        const modal = document.getElementById('day-analysis-modal');
        const date = modal.dataset.currentDate;
        
        if (!DB.dayAnalysisData) DB.dayAnalysisData = {};
        if (!DB.dayAnalysisData[date]) DB.dayAnalysisData[date] = {};
        if (!DB.dayAnalysisData[date].images) DB.dayAnalysisData[date].images = [];
        
        DB.dayAnalysisData[date].images.splice(index, 1);
        
        // Guardar en Dexie
        dexieDB.generalData.put({ id: 'dayAnalysisData', data: DB.dayAnalysisData });
        
        renderDayAnalysisImages(DB.dayAnalysisData[date].images);
    };
    
    function switchDayAnalysisTab(tab) {
        // Actualizar botones
        document.querySelectorAll('.day-analysis-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-primary', 'text-black');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active', 'bg-primary', 'text-black');
            }
        });
        
        // Mostrar/ocultar contenido
        document.querySelectorAll('.day-analysis-tab-content').forEach(content => {
            content.classList.add('hidden');
            content.classList.remove('active');
        });
        
        if (tab === 'notes') {
            document.getElementById('day-analysis-notes-content').classList.remove('hidden');
            document.getElementById('day-analysis-notes-content').classList.add('active');
        } else if (tab === 'images') {
            document.getElementById('day-analysis-images-content').classList.remove('hidden');
            document.getElementById('day-analysis-images-content').classList.add('active');
        }
    }
    
    // Event listeners
    const accountSelect = document.getElementById('daily-journal-account-select');
    if (accountSelect) {
        accountSelect.addEventListener('change', () => {
            updateSelectorLogo('daily-journal-account-select');
            refreshDailyJournal();
        });
    }
    
    // Inicializaci√≥n
    console.log('üîÑ Inicializando Daily Journal...');
    setTimeout(async () => {
        if (typeof updateAccountSelect === 'function') {
            updateAccountSelect('daily-journal-account-select');
            console.log('‚úÖ Selector de cuentas Daily Journal poblado');
        }
        if (typeof updateSelectorLogo === 'function') {
            updateSelectorLogo('daily-journal-account-select');
        }
        
        // Cargar datos de an√°lisis diario desde Dexie (local)
        const localData = await dexieDB.generalData.get('dayAnalysisData');
        if (localData && localData.data) {
            DB.dayAnalysisData = localData.data;
        } else {
            DB.dayAnalysisData = {};
        }
        
        // Cargar datos desde Supabase y fusionar con datos locales
        if (currentUser && typeof loadJournalEntriesFromSupabase === 'function') {
            try {
                const supabaseEntries = await loadJournalEntriesFromSupabase();
                console.log('üì• Cargadas', supabaseEntries.length, 'entradas del journal desde Supabase');
                
                // Fusionar con datos locales (Supabase tiene prioridad)
                supabaseEntries.forEach(entry => {
                    if (!DB.dayAnalysisData[entry.date]) {
                        DB.dayAnalysisData[entry.date] = {};
                    }
                    
                    DB.dayAnalysisData[entry.date].notes = entry.pre_trading_note || '';
                    DB.dayAnalysisData[entry.date].post_notes = entry.post_trading_note || '';
                    DB.dayAnalysisData[entry.date].lessons = entry.lessons_learned || '';
                    
                    if (entry.image_data) {
                        if (!DB.dayAnalysisData[entry.date].images) {
                            DB.dayAnalysisData[entry.date].images = [];
                        }
                        if (!DB.dayAnalysisData[entry.date].images.includes(entry.image_data)) {
                            DB.dayAnalysisData[entry.date].images.push(entry.image_data);
                        }
                    }
                });
                
                // Guardar datos fusionados localmente
                await dexieDB.generalData.put({ id: 'dayAnalysisData', data: DB.dayAnalysisData });
                console.log('‚úÖ Datos del journal fusionados y guardados localmente');
            } catch (error) {
                console.error('‚ùå Error cargando entradas del journal desde Supabase:', error);
            }
        }
        
        // Inicializar event listeners del modal de an√°lisis del d√≠a
        initializeDayAnalysisModal();
        
        if (document.getElementById('daily-journal').classList.contains('active')) {
            refreshDailyJournal();
        }
        console.log('‚úÖ Daily Journal inicializado');
    }, 500);
    
    // Funci√≥n para inicializar el modal de an√°lisis del d√≠a
    function initializeDayAnalysisModal() {
        let dayAnalysisRichEditor = null;
        
        // Cerrar modal
        document.getElementById('close-day-analysis-modal')?.addEventListener('click', () => {
            document.getElementById('day-analysis-modal').style.display = 'none';
        });
        
        // Tabs
        document.querySelectorAll('.day-analysis-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchDayAnalysisTab(btn.dataset.tab);
            });
        });
        
        // Editar notas
        document.getElementById('day-analysis-edit-notes-btn')?.addEventListener('click', () => {
            document.getElementById('day-analysis-notes-view').classList.add('hidden');
            document.getElementById('day-analysis-notes-edit').classList.remove('hidden');
            
            // Inicializar Rich Text Editor si no existe
            if (!dayAnalysisRichEditor) {
                const container = document.getElementById('day-analysis-rich-editor-container');
                if (container) {
                    dayAnalysisRichEditor = new RichTextEditor(container, {
                        placeholder: 'Escribe las notas del d√≠a...',
                        minHeight: '300px',
                        maxHeight: '500px',
                        showVoiceRecorder: true,
                        showDownload: true,
                        showCharCount: true
                    });
                }
            }
            
            // Cargar contenido actual
            const modal = document.getElementById('day-analysis-modal');
            const date = modal.dataset.currentDate;
            const notes = (DB.dayAnalysisData && DB.dayAnalysisData[date] && DB.dayAnalysisData[date].notes) || '';
            
            if (dayAnalysisRichEditor) {
                dayAnalysisRichEditor.setContent(notes, 'html');
            }
        });
        
        // Guardar notas
        document.getElementById('day-analysis-save-notes-btn')?.addEventListener('click', async () => {
            const modal = document.getElementById('day-analysis-modal');
            const date = modal.dataset.currentDate;
            const notes = dayAnalysisRichEditor ? dayAnalysisRichEditor.getContent('html') : '';
            
            if (!DB.dayAnalysisData) DB.dayAnalysisData = {};
            if (!DB.dayAnalysisData[date]) DB.dayAnalysisData[date] = {};
            
            DB.dayAnalysisData[date].notes = notes;
            
            // Guardar en Dexie (local)
            await dexieDB.generalData.put({ id: 'dayAnalysisData', data: DB.dayAnalysisData });
            
            // Guardar en Supabase
            if (currentUser && typeof saveJournalEntryToSupabase === 'function') {
                const accountSelect = document.getElementById('daily-journal-account-select');
                const accountId = accountSelect ? accountSelect.value : 'all';
                
                // Obtener m√©tricas del d√≠a
                let dayOps = DB.operations.filter(op => op.date === date);
                if (accountId !== 'all') {
                    dayOps = dayOps.filter(op => op.accountId === accountId);
                }
                
                const totalTrades = dayOps.length;
                const winners = dayOps.filter(op => op.result === 'win').length;
                const winrate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
                const dailyPnl = dayOps.reduce((sum, op) => sum + (op.pl || 0), 0);
                
                const entryData = {
                    date: date,
                    account_id: accountId !== 'all' ? accountId : null,
                    pre_trading_note: notes,
                    post_trading_note: DB.dayAnalysisData[date].post_notes || '',
                    lessons_learned: DB.dayAnalysisData[date].lessons || '',
                    image_data: (DB.dayAnalysisData[date].images && DB.dayAnalysisData[date].images[0]) || null,
                    daily_pnl: dailyPnl,
                    trades_count: totalTrades,
                    win_rate: winrate
                };
                
                saveJournalEntryToSupabase(entryData).catch(err => {
                    console.error('Error guardando entrada en Supabase:', err);
                });
            }
            
            // Actualizar vista
            document.getElementById('day-analysis-notes-view').innerHTML = notes || '<p class="text-text-secondary italic">Sin notas agregadas para este d√≠a.</p>';
            document.getElementById('day-analysis-notes-view').classList.remove('hidden');
            document.getElementById('day-analysis-notes-edit').classList.add('hidden');
        });
        
        // Cancelar edici√≥n de notas
        document.getElementById('day-analysis-cancel-notes-btn')?.addEventListener('click', () => {
            document.getElementById('day-analysis-notes-view').classList.remove('hidden');
            document.getElementById('day-analysis-notes-edit').classList.add('hidden');
        });
        
        // Agregar im√°genes
        document.getElementById('day-analysis-add-images-btn')?.addEventListener('click', () => {
            document.getElementById('day-analysis-images-view').classList.add('hidden');
            document.getElementById('day-analysis-images-upload').classList.remove('hidden');
        });
        
        // Preview de im√°genes
        document.getElementById('day-analysis-image-input')?.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const previewContainer = document.getElementById('day-analysis-image-preview');
            previewContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-32 object-cover rounded border border-border">
                        <button type="button" class="absolute top-1 right-1 bg-red text-white p-1 rounded-full text-xs" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });
        
        // Subir im√°genes
        document.getElementById('day-analysis-upload-images-btn')?.addEventListener('click', async () => {
            const modal = document.getElementById('day-analysis-modal');
            const date = modal.dataset.currentDate;
            const input = document.getElementById('day-analysis-image-input');
            const files = Array.from(input.files);
            
            if (files.length === 0) {
                alert('Por favor selecciona al menos una imagen');
                return;
            }
            
            if (!DB.dayAnalysisData) DB.dayAnalysisData = {};
            if (!DB.dayAnalysisData[date]) DB.dayAnalysisData[date] = {};
            if (!DB.dayAnalysisData[date].images) DB.dayAnalysisData[date].images = [];
            
            let processed = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    DB.dayAnalysisData[date].images.push(e.target.result);
                    processed++;
                    
                    if (processed === files.length) {
                        // Guardar en Dexie (local)
                        await dexieDB.generalData.put({ id: 'dayAnalysisData', data: DB.dayAnalysisData });
                        
                        // Guardar en Supabase
                        if (currentUser && typeof saveJournalEntryToSupabase === 'function') {
                            const accountSelect = document.getElementById('daily-journal-account-select');
                            const accountId = accountSelect ? accountSelect.value : 'all';
                            
                            // Obtener m√©tricas del d√≠a
                            let dayOps = DB.operations.filter(op => op.date === date);
                            if (accountId !== 'all') {
                                dayOps = dayOps.filter(op => op.accountId === accountId);
                            }
                            
                            const totalTrades = dayOps.length;
                            const winners = dayOps.filter(op => op.result === 'win').length;
                            const winrate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
                            const dailyPnl = dayOps.reduce((sum, op) => sum + (op.pl || 0), 0);
                            
                            const entryData = {
                                date: date,
                                account_id: accountId !== 'all' ? accountId : null,
                                pre_trading_note: DB.dayAnalysisData[date].notes || '',
                                post_trading_note: DB.dayAnalysisData[date].post_notes || '',
                                lessons_learned: DB.dayAnalysisData[date].lessons || '',
                                image_data: DB.dayAnalysisData[date].images[0] || null,
                                daily_pnl: dailyPnl,
                                trades_count: totalTrades,
                                win_rate: winrate
                            };
                            
                            saveJournalEntryToSupabase(entryData).catch(err => {
                                console.error('Error guardando entrada en Supabase:', err);
                            });
                        }
                        
                        // Actualizar vista
                        renderDayAnalysisImages(DB.dayAnalysisData[date].images);
                        document.getElementById('day-analysis-images-view').classList.remove('hidden');
                        document.getElementById('day-analysis-images-upload').classList.add('hidden');
                        document.getElementById('day-analysis-image-input').value = '';
                        document.getElementById('day-analysis-image-preview').innerHTML = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        });
        
        // Cancelar subida de im√°genes
        document.getElementById('day-analysis-cancel-images-btn')?.addEventListener('click', () => {
            const modal = document.getElementById('day-analysis-modal');
            const date = modal.dataset.currentDate;
            const images = (DB.dayAnalysisData && DB.dayAnalysisData[date] && DB.dayAnalysisData[date].images) || [];
            
            renderDayAnalysisImages(images);
            document.getElementById('day-analysis-images-view').classList.remove('hidden');
            document.getElementById('day-analysis-images-upload').classList.add('hidden');
            document.getElementById('day-analysis-image-input').value = '';
            document.getElementById('day-analysis-image-preview').innerHTML = '';
        });
    }
    
    window.refreshDailyJournal = refreshDailyJournal;
})();

// =============================================
// RICH TEXT EDITOR - EDITOR DE TEXTO ENRIQUECIDO
// =============================================
class RichTextEditor {
    constructor(container, options = {}) {
        this.container = container;
        this.options = {
            placeholder: options.placeholder || 'Escribe aqu√≠...',
            minHeight: options.minHeight || '150px',
            maxHeight: options.maxHeight || '400px',
            showVoiceRecorder: options.showVoiceRecorder !== false,
            showDownload: options.showDownload !== false,
            showCharCount: options.showCharCount !== false,
            onChange: options.onChange || null,
            ...options
        };
        
        this.editor = null;
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.isRecording = false;
        
        this.init();
    }
    
    init() {
        const editorHTML = `
            <div class="rich-text-editor">
                <!-- Toolbar -->
                <div class="rte-toolbar">
                    <!-- Formato de texto -->
                    <div class="rte-toolbar-group">
                        <button type="button" class="rte-btn" data-command="bold" title="Negrita (Ctrl+B)">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="italic" title="Cursiva (Ctrl+I)">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="underline" title="Subrayado (Ctrl+U)">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="strikeThrough" title="Tachado">
                            <i class="fas fa-strikethrough"></i>
                        </button>
                    </div>
                    
                    <!-- Alineaci√≥n -->
                    <div class="rte-toolbar-group">
                        <button type="button" class="rte-btn" data-command="justifyLeft" title="Alinear izquierda">
                            <i class="fas fa-align-left"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="justifyCenter" title="Alinear centro">
                            <i class="fas fa-align-center"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="justifyRight" title="Alinear derecha">
                            <i class="fas fa-align-right"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="justifyFull" title="Justificar">
                            <i class="fas fa-align-justify"></i>
                        </button>
                    </div>
                    
                    <!-- Listas -->
                    <div class="rte-toolbar-group">
                        <button type="button" class="rte-btn" data-command="insertUnorderedList" title="Lista con vi√±etas">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="insertOrderedList" title="Lista numerada">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="indent" title="Aumentar sangr√≠a">
                            <i class="fas fa-indent"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="outdent" title="Reducir sangr√≠a">
                            <i class="fas fa-outdent"></i>
                        </button>
                    </div>
                    
                    <!-- Tama√±o de fuente -->
                    <div class="rte-toolbar-group">
                        <select class="rte-select" data-command="fontSize" title="Tama√±o de fuente">
                            <option value="1">Muy peque√±o</option>
                            <option value="2">Peque√±o</option>
                            <option value="3" selected>Normal</option>
                            <option value="4">Mediano</option>
                            <option value="5">Grande</option>
                            <option value="6">Muy grande</option>
                            <option value="7">Enorme</option>
                        </select>
                    </div>
                    
                    <!-- Color de texto -->
                    <div class="rte-toolbar-group">
                        <input type="color" class="rte-btn" data-command="foreColor" value="#ffffff" title="Color de texto" style="padding: 2px; width: 40px;">
                        <input type="color" class="rte-btn" data-command="hiliteColor" value="#ffff00" title="Color de resaltado" style="padding: 2px; width: 40px;">
                    </div>
                    
                    <!-- Otros -->
                    <div class="rte-toolbar-group">
                        <button type="button" class="rte-btn" data-command="createLink" title="Insertar enlace">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="insertHorizontalRule" title="Insertar l√≠nea horizontal">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="rte-btn" data-command="removeFormat" title="Limpiar formato">
                            <i class="fas fa-remove-format"></i>
                        </button>
                    </div>
                </div>
                
                <!-- √Årea de contenido editable -->
                <div class="rte-content" 
                     contenteditable="true" 
                     data-placeholder="${this.options.placeholder}"
                     style="min-height: ${this.options.minHeight}; max-height: ${this.options.maxHeight};">
                </div>
                
                <!-- Footer con acciones -->
                <div class="rte-footer">
                    <div class="rte-actions">
                        ${this.options.showVoiceRecorder ? `
                        <button type="button" class="rte-voice-btn" data-action="voice">
                            <i class="fas fa-microphone"></i>
                            <span class="voice-btn-text">Nota de Voz</span>
                        </button>
                        <div class="rte-voice-indicator" style="display: none;">
                            <span>Grabando...</span>
                            <div class="rte-voice-wave"></div>
                            <div class="rte-voice-wave"></div>
                            <div class="rte-voice-wave"></div>
                            <div class="rte-voice-wave"></div>
                        </div>
                        ` : ''}
                        ${this.options.showDownload ? `
                        <button type="button" class="rte-download-btn" data-action="download">
                            <i class="fas fa-download"></i>
                            <span>Descargar Nota</span>
                        </button>
                        ` : ''}
                    </div>
                    ${this.options.showCharCount ? `
                    <div class="rte-char-count">
                        <span class="char-count">0</span> caracteres
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        this.container.innerHTML = editorHTML;
        this.editor = this.container.querySelector('.rte-content');
        
        this.attachEvents();
    }
    
    attachEvents() {
        // Botones de formato
        this.container.querySelectorAll('.rte-btn[data-command]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = btn.dataset.command;
                
                if (command === 'createLink') {
                    const url = prompt('Ingresa la URL:');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else {
                    document.execCommand(command, false, null);
                }
                
                this.editor.focus();
            });
        });
        
        // Select de tama√±o de fuente
        const fontSizeSelect = this.container.querySelector('select[data-command="fontSize"]');
        if (fontSizeSelect) {
            fontSizeSelect.addEventListener('change', (e) => {
                document.execCommand('fontSize', false, e.target.value);
                this.editor.focus();
            });
        }
        
        // Color pickers
        this.container.querySelectorAll('input[type="color"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const command = input.dataset.command;
                document.execCommand(command, false, e.target.value);
                this.editor.focus();
            });
        });
        
        // Contador de caracteres
        if (this.options.showCharCount) {
            this.editor.addEventListener('input', () => {
                const charCount = this.container.querySelector('.char-count');
                if (charCount) {
                    charCount.textContent = this.editor.textContent.length;
                }
                
                if (this.options.onChange) {
                    this.options.onChange(this.getContent());
                }
            });
        }
        
        // Grabaci√≥n de voz
        const voiceBtn = this.container.querySelector('[data-action="voice"]');
        if (voiceBtn) {
            voiceBtn.addEventListener('click', () => this.toggleVoiceRecording());
        }
        
        // Descarga de nota
        const downloadBtn = this.container.querySelector('[data-action="download"]');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => this.downloadNote());
        }
    }
    
    async toggleVoiceRecording() {
        if (!this.isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                
                this.mediaRecorder.addEventListener('dataavailable', (event) => {
                    this.audioChunks.push(event.data);
                });
                
                this.mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Insertar reproductor de audio en el editor
                    const audioHTML = `<div style="margin: 10px 0;"><audio controls src="${audioUrl}" style="max-width: 100%;"></audio></div>`;
                    this.insertHTML(audioHTML);
                    
                    // Opcional: guardar el audio como base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        console.log('Audio grabado (base64):', base64Audio.substring(0, 100) + '...');
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                });
                
                this.mediaRecorder.start();
                this.isRecording = true;
                
                // Actualizar UI
                const voiceBtn = this.container.querySelector('[data-action="voice"]');
                const voiceIndicator = this.container.querySelector('.rte-voice-indicator');
                
                if (voiceBtn) {
                    voiceBtn.classList.add('recording');
                    voiceBtn.querySelector('.voice-btn-text').textContent = 'Detener';
                }
                if (voiceIndicator) {
                    voiceIndicator.style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Error al acceder al micr√≥fono:', error);
                alert('No se pudo acceder al micr√≥fono. Verifica los permisos del navegador.');
            }
        } else {
            // Detener grabaci√≥n
            if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                this.mediaRecorder.stop();
            }
            this.isRecording = false;
            
            // Actualizar UI
            const voiceBtn = this.container.querySelector('[data-action="voice"]');
            const voiceIndicator = this.container.querySelector('.rte-voice-indicator');
            
            if (voiceBtn) {
                voiceBtn.classList.remove('recording');
                voiceBtn.querySelector('.voice-btn-text').textContent = 'Nota de Voz';
            }
            if (voiceIndicator) {
                voiceIndicator.style.display = 'none';
            }
        }
    }
    
    downloadNote() {
        const content = this.getContent('html');
        const plainText = this.getContent('text');
        
        // Crear archivo de texto
        const blob = new Blob([plainText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nota_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    getContent(format = 'html') {
        if (format === 'text') {
            return this.editor.textContent || '';
        }
        return this.editor.innerHTML || '';
    }
    
    setContent(content, format = 'html') {
        if (format === 'text') {
            this.editor.textContent = content;
        } else {
            this.editor.innerHTML = content;
        }
        
        // Actualizar contador
        const charCount = this.container.querySelector('.char-count');
        if (charCount) {
            charCount.textContent = this.editor.textContent.length;
        }
    }
    
    insertHTML(html) {
        this.editor.focus();
        document.execCommand('insertHTML', false, html);
    }
    
    clear() {
        this.editor.innerHTML = '';
        const charCount = this.container.querySelector('.char-count');
        if (charCount) {
            charCount.textContent = '0';
        }
    }
}

// Hacer disponible globalmente
window.RichTextEditor = RichTextEditor;

// =============================================
// PLAYBOOK - GESTI√ìN DE SETUPS DE TRADING
// =============================================
(function() {
    console.log('üìñ INICIANDO PLAYBOOK...');
    let editingSetupId = null;

    function refreshPlaybook() {
        console.log('--- Refreshing Playbook ---');
        
        const categoryFilter = document.getElementById('playbook-category-filter')?.value || 'all';
        const ratingFilter = parseInt(document.getElementById('playbook-rating-filter')?.value || 'all');
        const sort = document.getElementById('playbook-sort')?.value || 'rating-desc';

        let setups = DB.setups || [];
        
        // Calcular estad√≠sticas por setup
        const setupStats = calculateSetupStatistics();
        
        // Actualizar m√©tricas generales
        updatePlaybookMetrics(setups, setupStats);
        
        // Filtrar
        setups = setups.filter(setup => {
            if (categoryFilter !== 'all' && setup.category !== categoryFilter) return false;
            if (!isNaN(ratingFilter) && setup.rating < ratingFilter) return false;
            return true;
        });

        // Ordenar
        setups.sort((a, b) => {
            switch (sort) {
                case 'rating-desc': return (b.rating || 0) - (a.rating || 0);
                case 'rating-asc': return (a.rating || 0) - (b.rating || 0);
                case 'recent': return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                case 'oldest': return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                case 'name': return (a.name || '').localeCompare(b.name || '');
                case 'winrate': return (setupStats[b.id]?.winrate || 0) - (setupStats[a.id]?.winrate || 0);
                case 'trades': return (setupStats[b.id]?.totalTrades || 0) - (setupStats[a.id]?.totalTrades || 0);
                default: return 0;
            }
        });

        const container = document.getElementById('playbook-container');
        if (!container) {
            console.error('‚ùå playbook-container no encontrado');
            return;
        }

        if (setups.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-book text-6xl text-text-secondary mb-4"></i>
                    <p class="text-text-secondary">No hay setups creados todav√≠a</p>
                    <button id="add-setup-empty-btn" class="primary mt-4">
                        <i class="fas fa-plus mr-2"></i>Crear Primer Setup
                    </button>
                </div>
            `;
            // Re-attach event listener para el bot√≥n del empty state
            document.getElementById('add-setup-empty-btn')?.addEventListener('click', () => {
                console.log('‚úÖ Bot√≥n "Crear Primer Setup" clickeado');
                showSetupForm();
            });
            return;
        }

        container.innerHTML = setups.map(setup => {
            const stars = '‚≠ê'.repeat(setup.rating || 0);
            const stats = setupStats[setup.id] || {};
            const hasStats = stats.totalTrades > 0;
            
            return `
                <div class="metric-card p-6 hover:shadow-xl transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold mb-1">${setup.name}</h3>
                            ${setup.category ? `<span class="px-2 py-1 rounded text-xs bg-primary bg-opacity-20 text-primary">${setup.category}</span>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-2xl">${stars}</p>
                            <p class="text-xs text-text-secondary">${setup.rating}/5</p>
                        </div>
                    </div>

                    ${hasStats ? `
                        <div class="bg-surface rounded-lg p-3 mb-4 border border-border">
                            <p class="text-xs text-text-secondary mb-2">üìä Estad√≠sticas de Trading</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <p class="text-text-secondary text-xs">Trades</p>
                                    <p class="font-bold">${stats.totalTrades}</p>
                                </div>
                                <div>
                                    <p class="text-text-secondary text-xs">Winrate</p>
                                    <p class="font-bold ${stats.winrate >= 50 ? 'text-success' : 'text-danger'}">${stats.winrate.toFixed(1)}%</p>
                                </div>
                                <div>
                                    <p class="text-text-secondary text-xs">Profit Factor</p>
                                    <p class="font-bold ${stats.profitFactor >= 1.5 ? 'text-success' : stats.profitFactor >= 1 ? 'text-yellow' : 'text-danger'}">${stats.profitFactor.toFixed(2)}</p>
                                </div>
                                <div>
                                    <p class="text-text-secondary text-xs">P/L Total</p>
                                    <p class="font-bold ${stats.totalPL >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(stats.totalPL)}</p>
                                </div>
                            </div>
                            <p class="text-xs text-text-secondary mt-2">√öltima vez: ${stats.lastUsed || 'Nunca'}</p>
                        </div>
                    ` : `
                        <div class="bg-surface rounded-lg p-3 mb-4 border border-border text-center">
                            <p class="text-xs text-text-secondary">üìä Sin datos de trading</p>
                            <p class="text-xs text-text-secondary mt-1">Vincula operaciones a este setup</p>
                        </div>
                    `}

                    ${setup.description ? `<p class="text-sm text-text-secondary mb-4 line-clamp-3">${setup.description.substring(0, 150)}${setup.description.length > 150 ? '...' : ''}</p>` : ''}

                    ${setup.images && setup.images.length > 0 ? `
                        <div class="grid ${setup.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'} gap-3 mb-4" id="setup-images-${setup.id}">
                            ${setup.images.slice(0, 4).map((img, idx) => `
                                <img src="${img}" alt="Setup example" class="w-full h-48 object-cover rounded-lg border-2 border-border cursor-pointer hover:border-primary hover:shadow-lg transition-all setup-image" data-setup-id="${setup.id}" data-img-index="${idx}">
                            `).join('')}
                        </div>
                    ` : ''}

                    <div class="flex gap-2 mt-4">
                        <button onclick="editSetup('${setup.id}')" class="flex-1 py-2 bg-surface border border-border rounded hover:bg-surface-light transition-colors">
                            <i class="fas fa-edit mr-2"></i>Editar
                        </button>
                        <button onclick="deleteSetup('${setup.id}')" class="px-4 py-2 bg-danger bg-opacity-20 text-danger rounded hover:bg-opacity-30 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Renderizar tabla de performance
        renderSetupPerformanceTable(setupStats);
        
        // Agregar event listeners a las im√°genes despu√©s de renderizar
        setTimeout(() => {
            document.querySelectorAll('.setup-image').forEach(img => {
                img.addEventListener('click', function() {
                    const setupId = this.dataset.setupId;
                    const imgIndex = parseInt(this.dataset.imgIndex);
                    const setup = DB.setups.find(s => s.id === setupId);
                    
                    if (setup && setup.images) {
                        console.log('üñºÔ∏è [Playbook] Abriendo modal con', setup.images.length, 'im√°genes, √≠ndice', imgIndex);
                        openImageModal(setup.images, imgIndex);
                    }
                });
            });
        }, 100);
    }

    // Calcular estad√≠sticas por setup basado en operaciones
    function calculateSetupStatistics() {
        const stats = {};
        const operations = DB.operations || [];
        
        operations.forEach(op => {
            const setupId = op.setupId || op.setupUsed; // Compatibilidad
            if (!setupId) return;
            
            if (!stats[setupId]) {
                stats[setupId] = {
                    totalTrades: 0,
                    wins: 0,
                    losses: 0,
                    breakeven: 0,
                    totalPL: 0,
                    totalWinPL: 0,
                    totalLossPL: 0,
                    winrate: 0,
                    profitFactor: 0,
                    avgWin: 0,
                    avgLoss: 0,
                    lastUsed: null
                };
            }
            
            const s = stats[setupId];
            s.totalTrades++;
            
            const pl = convertCurrency(op.pl || 0, op.currency, DB.settings.defaultCurrency);
            s.totalPL += pl;
            
            if (op.result === 'win') {
                s.wins++;
                s.totalWinPL += pl;
            } else if (op.result === 'loss') {
                s.losses++;
                s.totalLossPL += Math.abs(pl);
            } else {
                s.breakeven++;
            }
            
            // √öltima vez usado
            if (!s.lastUsed || new Date(op.date) > new Date(s.lastUsed)) {
                s.lastUsed = op.date;
            }
        });
        
        // Calcular m√©tricas finales
        Object.keys(stats).forEach(setupId => {
            const s = stats[setupId];
            s.winrate = s.totalTrades > 0 ? (s.wins / s.totalTrades) * 100 : 0;
            s.profitFactor = s.totalLossPL > 0 ? s.totalWinPL / s.totalLossPL : (s.totalWinPL > 0 ? 999 : 0);
            s.avgWin = s.wins > 0 ? s.totalWinPL / s.wins : 0;
            s.avgLoss = s.losses > 0 ? s.totalLossPL / s.losses : 0;
            
            // Formatear √∫ltima vez
            if (s.lastUsed) {
                const lastDate = new Date(s.lastUsed);
                const today = new Date();
                const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) s.lastUsed = 'Hoy';
                else if (diffDays === 1) s.lastUsed = 'Ayer';
                else if (diffDays < 7) s.lastUsed = `Hace ${diffDays} d√≠as`;
                else if (diffDays < 30) s.lastUsed = `Hace ${Math.floor(diffDays / 7)} semanas`;
                else s.lastUsed = lastDate.toLocaleDateString();
            }
        });
        
        return stats;
    }

    // Actualizar m√©tricas del playbook
    function updatePlaybookMetrics(setups, setupStats) {
        // Total setups
        const totalEl = document.getElementById('playbook-total-setups');
        if (totalEl) totalEl.textContent = setups.length;
        
        // Distribuci√≥n por categor√≠a
        const byCatEl = document.getElementById('playbook-by-category');
        if (byCatEl && setups.length > 0) {
            const categories = {};
            setups.forEach(s => {
                categories[s.category] = (categories[s.category] || 0) + 1;
            });
            const catText = Object.entries(categories).slice(0, 2).map(([cat, count]) => `${cat}: ${count}`).join(', ');
            byCatEl.textContent = catText;
        }
        
        // Rating promedio
        const avgRating = setups.length > 0 ? setups.reduce((sum, s) => sum + (s.rating || 0), 0) / setups.length : 0;
        const avgRatingEl = document.getElementById('playbook-avg-rating');
        if (avgRatingEl) avgRatingEl.textContent = avgRating.toFixed(1);
        
        const starsEl = document.getElementById('playbook-rating-stars');
        if (starsEl) {
            const fullStars = Math.floor(avgRating);
            const halfStar = avgRating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            starsEl.textContent = '‚òÖ'.repeat(fullStars) + (halfStar ? '¬Ω' : '') + '‚òÜ'.repeat(emptyStars);
        }
        
        // Setup m√°s usado
        let mostUsed = null;
        let maxTrades = 0;
        Object.entries(setupStats).forEach(([id, stats]) => {
            if (stats.totalTrades > maxTrades) {
                maxTrades = stats.totalTrades;
                mostUsed = setups.find(s => s.id === id);
            }
        });
        
        const mostUsedNameEl = document.getElementById('playbook-most-used-name');
        const mostUsedCountEl = document.getElementById('playbook-most-used-count');
        if (mostUsedNameEl) mostUsedNameEl.textContent = mostUsed?.name || '-';
        if (mostUsedCountEl) mostUsedCountEl.textContent = maxTrades > 0 ? `${maxTrades} veces` : '0 veces';
        
        // Mejor winrate
        let bestWR = null;
        let maxWR = 0;
        Object.entries(setupStats).forEach(([id, stats]) => {
            if (stats.totalTrades >= 5 && stats.winrate > maxWR) { // M√≠nimo 5 trades
                maxWR = stats.winrate;
                bestWR = setups.find(s => s.id === id);
            }
        });
        
        const bestWRNameEl = document.getElementById('playbook-best-wr-name');
        const bestWRValueEl = document.getElementById('playbook-best-wr-value');
        if (bestWRNameEl) bestWRNameEl.textContent = bestWR?.name || '-';
        if (bestWRValueEl) bestWRValueEl.textContent = maxWR > 0 ? `${maxWR.toFixed(1)}%` : '0%';
        
        // Mostrar/ocultar secci√≥n de performance
        const perfSection = document.getElementById('playbook-performance-section');
        if (perfSection) {
            perfSection.style.display = Object.keys(setupStats).length > 0 ? 'block' : 'none';
        }
    }

    // Renderizar tabla de performance
    function renderSetupPerformanceTable(setupStats) {
        const tbody = document.getElementById('playbook-performance-tbody');
        if (!tbody) return;
        
        const setups = DB.setups || [];
        const rows = [];
        
        setups.forEach(setup => {
            const stats = setupStats[setup.id];
            if (!stats || stats.totalTrades === 0) return;
            
            rows.push({
                name: setup.name,
                trades: stats.totalTrades,
                winrate: stats.winrate,
                avgWin: stats.avgWin,
                avgLoss: stats.avgLoss,
                totalPL: stats.totalPL,
                profitFactor: stats.profitFactor,
                lastUsed: stats.lastUsed
            });
        });
        
        // Ordenar por winrate descendente
        rows.sort((a, b) => b.winrate - a.winrate);
        
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-text-secondary">No hay datos de trading</td></tr>';
            return;
        }
        
        tbody.innerHTML = rows.map(row => `
            <tr class="border-b border-border hover:bg-surface transition-colors">
                <td class="p-2 font-medium">${row.name}</td>
                <td class="text-center p-2">${row.trades}</td>
                <td class="text-center p-2">
                    <span class="${row.winrate >= 60 ? 'text-success' : row.winrate >= 50 ? 'text-yellow' : 'text-danger'} font-bold">
                        ${row.winrate.toFixed(1)}%
                    </span>
                </td>
                <td class="text-center p-2 text-success">${formatCurrency(row.avgWin)}</td>
                <td class="text-center p-2 text-danger">${formatCurrency(row.avgLoss)}</td>
                <td class="text-center p-2 ${row.totalPL >= 0 ? 'text-success' : 'text-danger'} font-bold">${formatCurrency(row.totalPL)}</td>
                <td class="text-center p-2">
                    <span class="${row.profitFactor >= 2 ? 'text-success' : row.profitFactor >= 1 ? 'text-yellow' : 'text-danger'}">
                        ${row.profitFactor.toFixed(2)}
                    </span>
                </td>
                <td class="text-center p-2 text-sm text-text-secondary">${row.lastUsed}</td>
            </tr>
        `).join('');
    }

    // Toggle tabla de performance
    document.getElementById('toggle-performance-table')?.addEventListener('click', function() {
        const table = document.getElementById('playbook-performance-table-container');
        if (table) {
            const isHidden = table.style.display === 'none';
            table.style.display = isHidden ? 'block' : 'none';
            this.innerHTML = isHidden 
                ? '<i class="fas fa-chart-bar mr-1"></i>Ocultar Estad√≠sticas' 
                : '<i class="fas fa-chart-bar mr-1"></i>Ver Estad√≠sticas';
        }
    });

    // Inicializar base de datos de setups
    if (!DB.setups) {
        DB.setups = [];
        saveDB();
    }

    // Inicializar Rich Text Editor para setup
    let setupRichEditor = null;
    const setupEditorContainer = document.getElementById('setup-rich-editor-container');
    if (setupEditorContainer) {
        setupRichEditor = new RichTextEditor(setupEditorContainer, {
            placeholder: 'Describe las condiciones de entrada, stop loss, take profit, contexto de mercado, etc.',
            minHeight: '200px',
            maxHeight: '400px',
            showVoiceRecorder: true,
            showDownload: true,
            showCharCount: true
        });
    }

    // Event listeners para formulario
    const setupModal = document.getElementById('setup-modal');
    const addSetupBtn = document.getElementById('add-setup-btn');
    const closeModalBtn = document.getElementById('close-setup-modal');
    const saveSetupBtn = document.getElementById('save-setup-btn');
    const cancelSetupBtn = document.getElementById('cancel-setup-btn');

    function showSetupForm() {
        console.log('üîπ showSetupForm() llamada');
        console.log('üîπ setupModal:', setupModal);
        if (setupModal) {
            setupModal.style.display = 'flex';
            console.log('‚úÖ Modal mostrado con display flex');
        } else {
            console.error('‚ùå setupModal no encontrado');
        }
    }

    function hideSetupForm() {
        if (setupModal) {
            setupModal.style.display = 'none';
        }
        // Limpiar formulario
        document.getElementById('setup-name').value = '';
        document.getElementById('setup-category').value = 'breakout';
        if (setupRichEditor) {
            setupRichEditor.clear();
        }
        document.getElementById('setup-tags').value = '';
        document.getElementById('setup-rating').value = '0';
        const valueEl = document.getElementById('setup-rating-value');
        if (valueEl) valueEl.textContent = '(Selecciona rating)';
        
        document.querySelectorAll('#setup-rating-selector .star').forEach(star => {
            star.style.opacity = '0.3';
        });
        
        const previewEl = document.getElementById('setup-images-preview');
        if (previewEl) previewEl.innerHTML = '';
        
        // Limpiar input de archivos
        const imagesInput = document.getElementById('setup-images');
        if (imagesInput) imagesInput.value = '';
        
        editingSetupId = null;
        const titleEl = document.getElementById('setup-modal-title') || document.getElementById('setup-form-title');
        if (titleEl) titleEl.textContent = 'Nuevo Setup';
    }

    addSetupBtn?.addEventListener('click', () => {
        console.log('‚úÖ Bot√≥n "Nuevo Setup" clickeado');
        showSetupForm();
    });
    
    closeModalBtn?.addEventListener('click', () => {
        console.log('‚úÖ Bot√≥n cerrar modal clickeado');
        hideSetupForm();
    });
    
    cancelSetupBtn?.addEventListener('click', () => {
        console.log('‚úÖ Bot√≥n cancelar clickeado');
        hideSetupForm();
    });
    
    // Cerrar modal al click fuera
    setupModal?.addEventListener('click', function(e) {
        if (e.target === setupModal) {
            hideSetupForm();
        }
    });

    // Sistema de estrellas
    document.querySelectorAll('#setup-rating-selector .star').forEach((star, idx) => {
        star.addEventListener('click', function() {
            const rating = idx + 1;
            document.getElementById('setup-rating').value = rating;
            const valueEl = document.getElementById('setup-rating-value');
            if (valueEl) valueEl.textContent = `${rating} estrella${rating !== 1 ? 's' : ''}`;
            
            document.querySelectorAll('#setup-rating-selector .star').forEach((s, i) => {
                s.style.opacity = i < rating ? '1' : '0.3';
            });
        });
    });

    // Preview de im√°genes (m√°ximo 4)
    document.getElementById('setup-images')?.addEventListener('change', function(e) {
        const files = Array.from(e.target.files).slice(0, 4);
        const container = document.getElementById('setup-images-preview');
        if (!container) return;
        container.innerHTML = '';

        if (files.length > 4) {
            alert('Solo puedes subir hasta 4 im√°genes');
        }

        files.forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-40 object-cover rounded-lg border-2 border-border">
                    <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 bg-danger text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-80 shadow-lg">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    });

    // Guardar setup
    saveSetupBtn?.addEventListener('click', async function() {
        console.log('üíæ Bot√≥n Guardar Setup clickeado');
        
        const name = document.getElementById('setup-name').value.trim();
        const category = document.getElementById('setup-category').value;
        const rating = parseInt(document.getElementById('setup-rating').value);
        const description = setupRichEditor ? setupRichEditor.getContent('html') : '';
        const tags = document.getElementById('setup-tags').value.trim();

        console.log('üìù Datos del formulario:', { name, category, rating, description });

        if (!name) {
            alert('Por favor ingresa un nombre para el setup');
            return;
        }

        if (rating === 0 || isNaN(rating)) {
            alert('Por favor califica el setup (1-5 estrellas)');
            return;
        }

        // Convertir im√°genes a base64
        const imageFiles = document.getElementById('setup-images').files;
        const images = [];
        for (let file of imageFiles) {
            const base64 = await fileToBase64(file);
            images.push(base64);
        }

        console.log(`üì∏ ${images.length} im√°genes procesadas`);

        const setup = {
            id: editingSetupId || Date.now().toString(),
            name,
            category,
            rating,
            description,
            tags,
            images,
            createdAt: editingSetupId ? (DB.setups.find(s => s.id === editingSetupId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        console.log('üì¶ Setup creado:', setup);

        if (editingSetupId) {
            const idx = DB.setups.findIndex(s => s.id === editingSetupId);
            DB.setups[idx] = setup;
            console.log('‚úèÔ∏è Setup actualizado en √≠ndice:', idx);
            await dexieDB.setups.put(setup);
            await saveSetupToSupabase(setup);
        } else {
            DB.setups.push(setup);
            console.log('‚ûï Setup agregado. Total setups:', DB.setups.length);
            await dexieDB.setups.add(setup);
            await saveSetupToSupabase(setup);
        }

        console.log('üíæ Setup guardado en BD');
        
        hideSetupForm();
        refreshPlaybook();
        showNotification(editingSetupId ? 'Setup actualizado' : 'Setup creado exitosamente', 'success');
    });

    function fileToBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
    }

    window.editSetup = function(id) {
        const setup = DB.setups.find(s => s.id === id);
        if (!setup) return;

        editingSetupId = id;
        document.getElementById('setup-modal-title').textContent = 'Editar Setup';
        document.getElementById('setup-name').value = setup.name || '';
        document.getElementById('setup-category').value = setup.category || '';
        if (setupRichEditor) {
            setupRichEditor.setContent(setup.description || '', 'html');
        }
        document.getElementById('setup-tags').value = setup.tags || '';

        // Set rating
        const rating = setup.rating || 0;
        document.getElementById('setup-rating').value = rating;
        const ratingValueEl = document.getElementById('setup-rating-value');
        if (ratingValueEl) ratingValueEl.textContent = `${rating} estrella${rating !== 1 ? 's' : ''}`;
        
        document.querySelectorAll('#setup-rating-selector .star').forEach((s, idx) => {
            s.style.opacity = idx < rating ? '1' : '0.3';
        });

        // Show images
        const container = document.getElementById('setup-images-preview');
        if (container) {
            container.innerHTML = setup.images?.slice(0, 4).map(img => `
                <div class="relative">
                    <img src="${img}" class="w-full h-40 object-cover rounded-lg border-2 border-border">
                </div>
            `).join('') || '';
        }

        showSetupForm();
    };

    window.deleteSetup = async function(id) {
        if (!confirm('¬øEst√°s seguro de eliminar este setup? Esta acci√≥n no se puede deshacer.')) return;
        
        try {
            DB.setups = DB.setups.filter(s => s.id !== id);
            await dexieDB.setups.delete(id);
            await deleteSetupFromSupabase(id);
            refreshPlaybook();
            showNotification('Setup eliminado', 'info');
        } catch (error) {
            console.error('Error eliminando setup:', error);
            showNotification('Error al eliminar setup', 'error');
        }
    };

    // Event listeners
    document.getElementById('playbook-category-filter')?.addEventListener('change', refreshPlaybook);
    document.getElementById('playbook-rating-filter')?.addEventListener('change', refreshPlaybook);
    document.getElementById('playbook-sort')?.addEventListener('change', refreshPlaybook);

    window.refreshPlaybook = refreshPlaybook;

    // Funci√≥n de notificaci√≥n simple
    window.showNotification = function(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `toast-notification ${type === 'success' ? 'bg-green-900' : 'bg-red-900'} text-white px-4 py-3 rounded shadow-lg`;
        notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    };

    // Inicializar vista
    console.log('üîÑ Inicializando Playbook...');
    refreshPlaybook();
})();

// =============================================
// TRADINGVIEW SIMPLE IFRAME (SIEMPRE FUNCIONA)
// =============================================

function loadTradingViewChart(operation) {
    console.log('üìä Cargando gr√°fico avanzado para:', operation.instrument);

    // Guardar operaci√≥n actual
    currentOperationForChart = operation;

    // Actualizar informaci√≥n del panel
    updateChartInfo(operation);

    // Obtener todas las operaciones relacionadas
    let relatedOperations = [];
    if (operation.csvId) {
        relatedOperations = DB.operations.filter(op => op.csvId === operation.csvId);
    } else {
        relatedOperations = [operation];
    }

    // Crear directamente el gr√°fico avanzado
    if (typeof TradingView !== 'undefined') {
        createTradingViewWidget(operation, relatedOperations);
    } else {
        createLightweightChartWithMarkers(operation, relatedOperations);
    }

    // Mostrar panel de informaci√≥n en esquina derecha
    displayTradeMarkers(operation, relatedOperations);
    
    console.log('‚úÖ Gr√°fico avanzado cargado');
}

// Funci√≥n para intentar inyectar marcadores en el iframe
function injectMarkersIntoIframe(iframe, drawingsArray) {
    try {
        // Esta funci√≥n intenta comunicarse con el iframe de TradingView
        // Nota: Esto puede estar limitado por CORS, pero vale la pena intentarlo
        
        const iframeWindow = iframe.contentWindow;
        if (iframeWindow && drawingsArray.length > 0) {
            
            // Enviar mensaje al iframe con los marcadores
            const message = {
                name: 'add-markers',
                data: drawingsArray
            };
            
            iframeWindow.postMessage(message, 'https://s.tradingview.com');
            console.log('üì§ Marcadores enviados al iframe');
            
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è No se pudo inyectar marcadores en iframe (CORS esperado)');
    }
}

// Funci√≥n alternativa para mostrar informaci√≥n de entrada/salida en esquina derecha
function displayTradeMarkers(operation, relatedOperations) {
    const chartInfo = document.querySelector('.chart-info');
    if (!chartInfo) return;
    
    // Crear o actualizar panel de marcadores en esquina derecha
    let markersPanel = document.getElementById('trade-markers-panel');
    if (!markersPanel) {
        markersPanel = document.createElement('div');
        markersPanel.id = 'trade-markers-panel';
        markersPanel.className = 'absolute top-4 right-4 bg-black bg-opacity-90 text-white text-xs p-3 rounded-lg border border-gray-600 max-w-xs z-20 shadow-lg';
        chartInfo.appendChild(markersPanel);
    }
    
    let markersHTML = '<div class="font-semibold mb-3 text-primary">üìç Puntos de Entrada/Salida</div>';
    
    relatedOperations.forEach((op, index) => {
        const precision = getInstrumentPrecision(op.instrument);
        const entryColor = op.type === 'buy' ? '#10B981' : '#EF4444';
        const exitColor = op.pl >= 0 ? '#10B981' : '#EF4444';
        
        markersHTML += `
            <div class="mb-3 p-2 border border-gray-600 rounded bg-black bg-opacity-50">
                <div class="font-medium text-primary mb-2">${index === 0 ? 'Principal' : `Parcial ${index}`}</div>
                <div class="space-y-1">
                    <div class="flex justify-between items-center text-xs">
                        <span style="color: ${entryColor}">‚ñ≤ Entrada:</span>
                        <span class="font-medium">${op.entryTime || '--'}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">Precio:</span>
                        <span class="font-medium">${op.entry ? op.entry.toFixed(precision) : '--'}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span style="color: ${exitColor}">‚ñº Salida:</span>
                        <span class="font-medium">${op.exitTime || '--'}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">Precio:</span>
                        <span class="font-medium">${op.exit ? op.exit.toFixed(precision) : '--'}</span>
                    </div>
                    <div class="text-center text-xs mt-2 p-1 rounded" style="background-color: ${exitColor}20; color: ${exitColor}">
                        <strong>${formatCurrency(op.pl, op.currency, op.currency)}</strong>
                    </div>
                </div>
            </div>
        `;
    });
    
    markersPanel.innerHTML = markersHTML;
}

// Variables globales para gr√°ficos
let tradingViewWidget = null;
let lightweightChart = null;
let currentOperationForChart = null;

// Funci√≥n para crear el widget avanzado de TradingView con marcadores
function createTradingViewWidget(operation, relatedOperations) {
    const widgetContainer = document.getElementById('tradingview-widget');
    if (!widgetContainer) return;
    
    // Limpiar contenedor
    widgetContainer.innerHTML = '';
    
    const tvSymbol = convertToTradingViewSymbol(operation.instrument);
    
    // Verificar si TradingView est√° disponible
    if (typeof TradingView !== 'undefined') {
        try {
            tradingViewWidget = new TradingView.widget({
                width: '100%',
                height: 650,
                symbol: tvSymbol,
                interval: '5',
                timezone: 'Etc/UTC',
                theme: 'dark',
                style: '1',
                locale: 'es',
                toolbar_bg: '#0f0f0f',
                enable_publishing: false,
                hide_side_toolbar: false,
                allow_symbol_change: true,
                container_id: 'tradingview-widget',
                save_image: true,
                studies: [],
                drawings_access: {
                    type: 'black',
                    tools: [
                        { name: 'Trend Line' },
                        { name: 'Arrow Up' },
                        { name: 'Arrow Down' }
                    ]
                },
                overrides: {
                    "mainSeriesProperties.candleStyle.upColor": "#10B981",
                    "mainSeriesProperties.candleStyle.downColor": "#EF4444",
                    "mainSeriesProperties.candleStyle.borderUpColor": "#10B981",
                    "mainSeriesProperties.candleStyle.borderDownColor": "#EF4444",
                    "mainSeriesProperties.candleStyle.wickUpColor": "#10B981",
                    "mainSeriesProperties.candleStyle.wickDownColor": "#EF4444"
                },
                onChartReady: function() {
                    console.log('üìä Widget de TradingView cargado');
                    
                    // Esperar un poco para que el gr√°fico est√© completamente listo
                    setTimeout(() => {
                        addTradeMarkersToChart(operation, relatedOperations);
                    }, 2000);
                }
            });
            
            console.log('‚úÖ Widget de TradingView creado');
        } catch (error) {
            console.error('‚ùå Error creando widget de TradingView:', error);
            showAdvancedChartAlternative(operation, relatedOperations);
        }
    } else {
        console.warn('‚ö†Ô∏è TradingView no est√° disponible');
        showAdvancedChartAlternative(operation, relatedOperations);
    }
}

// Funci√≥n para agregar marcadores directamente al gr√°fico
function addTradeMarkersToChart(operation, relatedOperations) {
    if (!tradingViewWidget || !tradingViewWidget.chart) {
        console.warn('‚ö†Ô∏è Widget no disponible para agregar marcadores');
        return;
    }
    
    try {
        const chart = tradingViewWidget.chart();
        
        relatedOperations.forEach((op, index) => {
            const precision = getInstrumentPrecision(op.instrument);
            
            // Marcador de entrada
            if (op.entryTime && op.date && op.entry) {
                const entryDateTime = new Date(`${op.date}T${op.entryTime}:00`);
                if (!isNaN(entryDateTime.getTime())) {
                    const entryTimestamp = Math.floor(entryDateTime.getTime() / 1000);
                    
                    // Crear shape de flecha hacia arriba para entrada
                    chart.createShape({
                        time: entryTimestamp,
                        price: op.entry,
                        shape: 'arrow_up',
                        text: `ENTRADA ${index > 0 ? 'P' + index : ''}`,
                        overrides: {
                            color: op.type === 'buy' ? '#10B981' : '#EF4444',
                            textcolor: '#FFFFFF',
                            fontsize: 12,
                            transparency: 0
                        }
                    });
                    
                    console.log(`‚úÖ Marcador de entrada agregado: ${op.entryTime} @ ${op.entry}`);
                }
            }
            
            // Marcador de salida
            if (op.exitTime && op.date && op.exit) {
                const exitDateTime = new Date(`${op.date}T${op.exitTime}:00`);
                if (!isNaN(exitDateTime.getTime())) {
                    const exitTimestamp = Math.floor(exitDateTime.getTime() / 1000);
                    
                    // Crear shape de flecha hacia abajo para salida
                    chart.createShape({
                        time: exitTimestamp,
                        price: op.exit,
                        shape: 'arrow_down',
                        text: `SALIDA ${index > 0 ? 'P' + index : ''}\nP&L: ${formatCurrency(op.pl, op.currency, op.currency)}`,
                        overrides: {
                            color: op.pl >= 0 ? '#10B981' : '#EF4444',
                            textcolor: '#FFFFFF',
                            fontsize: 12,
                            transparency: 0
                        }
                    });
                    
                    console.log(`‚úÖ Marcador de salida agregado: ${op.exitTime} @ ${op.exit}`);
                }
            }
        });
        
        // Centrar el gr√°fico en el rango de la operaci√≥n
        if (relatedOperations.length > 0) {
            const firstOp = relatedOperations[0];
            if (firstOp.date && firstOp.entryTime) {
                const centerTime = new Date(`${firstOp.date}T${firstOp.entryTime}:00`);
                const centerTimestamp = Math.floor(centerTime.getTime() / 1000);
                
                // Establecer rango visible alrededor de la operaci√≥n
                chart.setVisibleRange({
                    from: centerTimestamp - (6 * 3600), // 6 horas antes
                    to: centerTimestamp + (6 * 3600)    // 6 horas despu√©s
                });
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error agregando marcadores al gr√°fico:', error);
        console.log('‚ÑπÔ∏è Intentando m√©todo alternativo...');
        
        // M√©todo alternativo usando estudios personalizados
        try {
            addMarkersWithStudies(operation, relatedOperations);
        } catch (altError) {
            console.error('‚ùå M√©todo alternativo tambi√©n fall√≥:', altError);
        }
    }
}

// M√©todo alternativo usando estudios personalizados
function addMarkersWithStudies(operation, relatedOperations) {
    if (!tradingViewWidget || !tradingViewWidget.chart) return;
    
    const chart = tradingViewWidget.chart();
    
    relatedOperations.forEach((op, index) => {
        // Crear estudio de Price Label para entrada
        if (op.entryTime && op.date && op.entry) {
            const entryDateTime = new Date(`${op.date}T${op.entryTime}:00`);
            const entryTimestamp = Math.floor(entryDateTime.getTime() / 1000);
            
            chart.createStudy('Price Note', false, false, {
                text: `üìà ENTRADA ${index > 0 ? 'P' + index : ''}`,
                time: entryTimestamp,
                price: op.entry
            });
        }
        
        // Crear estudio de Price Label para salida
        if (op.exitTime && op.date && op.exit) {
            const exitDateTime = new Date(`${op.date}T${op.exitTime}:00`);
            const exitTimestamp = Math.floor(exitDateTime.getTime() / 1000);
            
            chart.createStudy('Price Note', false, false, {
                text: `üìâ SALIDA ${index > 0 ? 'P' + index : ''} - ${formatCurrency(op.pl, op.currency, op.currency)}`,
                time: exitTimestamp,
                price: op.exit
            });
        }
    });
}

// Funci√≥n alternativa mejorada cuando el widget avanzado no est√° disponible
function showAdvancedChartAlternative(operation, relatedOperations) {
    const widgetContainer = document.getElementById('tradingview-widget');
    if (!widgetContainer) return;
    
    // Crear iframe con par√°metros espec√≠ficos para marcadores
    const tvSymbol = convertToTradingViewSymbol(operation.instrument);
    
    // Construir URL con estudios personalizados
    let studiesParam = '';
    const studies = [];
    
    relatedOperations.forEach((op, index) => {
        if (op.entryTime && op.date && op.entry) {
            const entryDateTime = new Date(`${op.date}T${op.entryTime}:00`);
            const entryTimestamp = Math.floor(entryDateTime.getTime() / 1000);
            studies.push(`PriceNote@tv-basicstudies-${studies.length + 1}=${JSON.stringify({
                time: entryTimestamp,
                price: op.entry,
                text: 'üìà ENTRADA'
            })}`);
        }
        
        if (op.exitTime && op.date && op.exit) {
            const exitDateTime = new Date(`${op.date}T${op.exitTime}:00`);
            const exitTimestamp = Math.floor(exitDateTime.getTime() / 1000);
            studies.push(`PriceNote@tv-basicstudies-${studies.length + 1}=${JSON.stringify({
                time: exitTimestamp,
                price: op.exit,
                text: 'üìâ SALIDA'
            })}`);
        }
    });
    
    if (studies.length > 0) {
        studiesParam = `&studies=${encodeURIComponent(studies.join(','))}`;
    }
    
    const iframeUrl = `https://s.tradingview.com/widgetembed/?frameElementId=tradingview_widget&symbol=${encodeURIComponent(tvSymbol)}&interval=5&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=0f0f0f&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1${studiesParam}&overrides={"mainSeriesProperties.candleStyle.upColor"%3A"%2310B981"%2C"mainSeriesProperties.candleStyle.downColor"%3A"%23EF4444"}&enabled_features=[]&disabled_features=[]&locale=es`;
    
    widgetContainer.innerHTML = `
        <iframe 
            src="${iframeUrl}"
            style="width: 100%; height: 650px; border: none;"
            frameborder="0">
        </iframe>
        <div class="absolute top-4 left-4 bg-black bg-opacity-75 text-white text-xs p-2 rounded">
            ‚ö†Ô∏è Widget avanzado no disponible. Usando modo alternativo.
        </div>
    `;
}

// Funci√≥n para crear gr√°fico con Lightweight Charts y marcadores
async function createLightweightChartWithMarkers(operation, relatedOperations) {
    const widgetContainer = document.getElementById('tradingview-widget');
    if (!widgetContainer) return;
    
    // Limpiar contenedor
    widgetContainer.innerHTML = '';
    
    console.log('üìä Creando gr√°fico con Lightweight Charts...');
    
    try {
        // Crear el gr√°fico
        lightweightChart = LightweightCharts.createChart(widgetContainer, {
            width: widgetContainer.clientWidth,
            height: 650,
            layout: {
                backgroundColor: '#0f0f0f',
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: {
                    color: '#2B2B43',
                },
                horzLines: {
                    color: '#2B2B43',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#485c7b',
            },
            timeScale: {
                borderColor: '#485c7b',
                timeVisible: true,
                secondsVisible: false,
            },
        });
        
        // Crear serie de velas
        const candlestickSeries = lightweightChart.addCandlestickSeries({
            upColor: '#10B981',
            downColor: '#EF4444',
            borderDownColor: '#EF4444',
            borderUpColor: '#10B981',
            wickDownColor: '#EF4444',
            wickUpColor: '#10B981',
        });
        
        // Obtener datos hist√≥ricos (simulados por ahora)
        const tvSymbol = convertToTradingViewSymbol(operation.instrument);
        const chartData = await generateSampleChartData(operation, relatedOperations);
        
        // Establecer datos del gr√°fico
        candlestickSeries.setData(chartData);
        
        // Agregar marcadores de entrada y salida
        const markers = [];
        
        relatedOperations.forEach((op, index) => {
            const precision = getInstrumentPrecision(op.instrument);
            
            // Marcador de entrada
            if (op.entryTime && op.date && op.entry) {
                const entryDateTime = new Date(`${op.date}T${op.entryTime}:00`);
                const entryTimestamp = Math.floor(entryDateTime.getTime() / 1000);
                
                markers.push({
                    time: entryTimestamp,
                    position: 'belowBar',
                    color: op.type === 'buy' ? '#10B981' : '#EF4444',
                    shape: 'arrowUp',
                    text: `ENTRADA ${index > 0 ? 'P' + index : ''}: ${op.entry.toFixed(precision)}`,
                    size: 1
                });
            }
            
            // Marcador de salida
            if (op.exitTime && op.date && op.exit) {
                const exitDateTime = new Date(`${op.date}T${op.exitTime}:00`);
                const exitTimestamp = Math.floor(exitDateTime.getTime() / 1000);
                
                markers.push({
                    time: exitTimestamp,
                    position: 'aboveBar',
                    color: op.pl >= 0 ? '#10B981' : '#EF4444',
                    shape: 'arrowDown',
                    text: `SALIDA ${index > 0 ? 'P' + index : ''}: ${op.exit.toFixed(precision)}\nP&L: ${formatCurrency(op.pl, op.currency, op.currency)}`,
                    size: 1
                });
            }
        });
        
        // Aplicar marcadores
        candlestickSeries.setMarkers(markers);
        
        // Centrar gr√°fico en la operaci√≥n
        if (relatedOperations.length > 0 && relatedOperations[0].entryTime) {
            const firstOp = relatedOperations[0];
            const centerTime = new Date(`${firstOp.date}T${firstOp.entryTime}:00`);
            const centerTimestamp = Math.floor(centerTime.getTime() / 1000);
            
            lightweightChart.timeScale().setVisibleRange({
                from: centerTimestamp - (4 * 3600), // 4 horas antes
                to: centerTimestamp + (4 * 3600)    // 4 horas despu√©s
            });
        }
        
        // Ajustar tama√±o cuando cambie la ventana
        window.addEventListener('resize', () => {
            if (lightweightChart) {
                lightweightChart.applyOptions({ 
                    width: widgetContainer.clientWidth 
                });
            }
        });
        
        console.log('‚úÖ Gr√°fico Lightweight creado con marcadores');
        
    } catch (error) {
        console.error('‚ùå Error creando gr√°fico Lightweight:', error);
        
        // Fallback al mensaje de error
        widgetContainer.innerHTML = `
            <div class="flex items-center justify-center h-full bg-surface">
                <div class="text-center p-8">
                    <div class="text-red-400 text-lg mb-4">‚ùå Error cargando gr√°fico avanzado</div>
                    <div class="text-gray-400 mb-4">Los marcadores est√°n disponibles en el panel lateral</div>
                    <button onclick="toggleChartMode()" class="bg-primary text-black px-4 py-2 rounded">
                        Volver al gr√°fico simple
                    </button>
                </div>
            </div>
        `;
    }
}

// Funci√≥n para generar datos de ejemplo del gr√°fico
async function generateSampleChartData(operation, relatedOperations) {
    // Esta funci√≥n generar√≠a datos reales en una implementaci√≥n completa
    // Por ahora, genera datos de ejemplo basados en la operaci√≥n
    
    const data = [];
    const startTime = new Date(`${operation.date}T00:00:00`);
    const basePrice = operation.entry || 100;
    
    // Generar 24 horas de datos con intervalos de 5 minutos
    for (let i = 0; i < 288; i++) { // 288 intervalos de 5 min = 24h
        const timestamp = Math.floor((startTime.getTime() + (i * 5 * 60 * 1000)) / 1000);
        const randomVariation = (Math.random() - 0.5) * 0.02; // ¬±1% variaci√≥n
        const price = basePrice * (1 + randomVariation);
        
        data.push({
            time: timestamp,
            open: price * 0.999,
            high: price * 1.001,
            low: price * 0.998,
            close: price
        });
    }
    
    return data;
}



function convertToTradingViewSymbol(instrument) {
        if (!instrument) return 'BINANCE:BTCUSDT';

        let symbol = instrument.toUpperCase().trim();

        // Limpiar espacios, guiones, barras y underscores
        symbol = symbol.replace(/[\s\/\-_]/g, '');

        // ELIMINAR SUFIJOS DE BROKERS (MT5, Forex, etc.)
        // Sufijos comunes: .pro, .fs, .i, .m, .raw, .cash, .prousdt, .fsusdt, etc.
        symbol = symbol.replace(/\.PRO(USDT)?$/i, ''); // .pro, .prousdt
        symbol = symbol.replace(/\.FS(USDT)?$/i, '');  // .fs, .fsusdt
        symbol = symbol.replace(/\.I$/i, '');          // .i
        symbol = symbol.replace(/\.M$/i, '');          // .m
        symbol = symbol.replace(/\.RAW$/i, '');        // .raw
        symbol = symbol.replace(/\.CASH$/i, '');       // .cash
        symbol = symbol.replace(/\.E$/i, '');          // .e
        symbol = symbol.replace(/\.C$/i, '');          // .c
        symbol = symbol.replace(/[Pp]$/, '');          // Elimina 'p' o 'P' al final
        symbol = symbol.replace(/D[Pp]$/, '');         // Elimina 'Dp' o 'DP' al final
        
        console.log(`üîÑ S√≠mbolo original: "${instrument}" ‚Üí Limpiado: "${symbol}"`);

        // Mapeo para diferentes tipos de instrumentos
        const symbolMap = {
            // CRIPTOMONEDAS (usar BINANCE)
            'BTC': 'BINANCE:BTCUSDT',
            'BTCUSD': 'BINANCE:BTCUSDT',
            'BTCUSDT': 'BINANCE:BTCUSDT',
            'BITCOIN': 'BINANCE:BTCUSDT',
            'ETH': 'BINANCE:ETHUSDT',
            'ETHUSD': 'BINANCE:ETHUSDT',
            'ETHUSDT': 'BINANCE:ETHUSDT',
            'ETHEREUM': 'BINANCE:ETHUSDT',
            'BNB': 'BINANCE:BNBUSDT',
            'BNBUSDT': 'BINANCE:BNBUSDT',
            'SOL': 'BINANCE:SOLUSDT',
            'SOLUSDT': 'BINANCE:SOLUSDT',
            'XRP': 'BINANCE:XRPUSDT',
            'XRPUSDT': 'BINANCE:XRPUSDT',
            'ADA': 'BINANCE:ADAUSDT',
            'ADAUSDT': 'BINANCE:ADAUSDT',
            'DOGE': 'BINANCE:DOGEUSDT',
            'DOGEUSDT': 'BINANCE:DOGEUSDT',
            'DOT': 'BINANCE:DOTUSDT',
            'DOTUSDT': 'BINANCE:DOTUSDT',
            'MATIC': 'BINANCE:MATICUSDT',
            'MATICUSDT': 'BINANCE:MATICUSDT',
            'AVAX': 'BINANCE:AVAXUSDT',
            'AVAXUSDT': 'BINANCE:AVAXUSDT',
            'LINK': 'BINANCE:LINKUSDT',
            'LINKUSDT': 'BINANCE:LINKUSDT',
            'UNI': 'BINANCE:UNIUSDT',
            'UNIUSDT': 'BINANCE:UNIUSDT',
            'LTC': 'BINANCE:LTCUSDT',
            'LTCUSDT': 'BINANCE:LTCUSDT',

            // FOREX (pares principales)
            'EURUSD': 'FX:EURUSD',
            'GBPUSD': 'FX:GBPUSD',
            'USDJPY': 'FX:USDJPY',
            'AUDUSD': 'FX:AUDUSD',
            'USDCAD': 'FX:USDCAD',
            'NZDUSD': 'FX:NZDUSD',
            'USDCHF': 'FX:USDCHF',
            'EURGBP': 'FX:EURGBP',
            'EURJPY': 'FX:EURJPY',
            'GBPJPY': 'FX:GBPJPY',
            'AUDJPY': 'FX:AUDJPY',
            'EURAUD': 'FX:EURAUD',
            'EURCHF': 'FX:EURCHF',
            'GBPCHF': 'FX:GBPCHF',
            'AUDNZD': 'FX:AUDNZD',

            // √çNDICES
            'SPX': 'SP:SPX',
            'SP500': 'SP:SPX',
            'SPY': 'AMEX:SPY',
            'NQ': 'NASDAQ:NDX',
            'NASDAQ': 'NASDAQ:NDX',
            'DJI': 'DJ:DJI',
            'DOW': 'DJ:DJI',
            'DAX': 'XETR:DAX',
            'FTSE': 'FTSE:FSI',
            'NIKKEI': 'TVC:NI225',
            'HSI': 'HSI:HSI',
            'NAS100': 'NASDAQ:NDX',
            'US30': 'DJ:DJI',
            'US100': 'NASDAQ:NDX',
            'GER30': 'XETR:DAX',

            // COMMODITIES
            'GOLD': 'TVC:GOLD',
            'XAUUSD': 'TVC:GOLD',
            'GC': 'COMEX:GC1!',
            'SILVER': 'TVC:SILVER',
            'XAGUSD': 'TVC:SILVER',
            'SI': 'COMEX:SI1!',
            'OIL': 'TVC:USOIL',
            'CRUDE': 'TVC:USOIL',
            'CL': 'NYMEX:CL1!',
            'WTI': 'TVC:USOIL',
            'BRENT': 'TVC:UKOIL',
            'NG': 'NYMEX:NG1!',
            'NATURALGAS': 'NYMEX:NG1!',

            // METALES
            'COPPER': 'COMEX:HG1!',
            'PLATINUM': 'NYMEX:PL1!',
            'PALLADIUM': 'NYMEX:PA1!'
        };

        // Buscar en el mapeo
        if (symbolMap[symbol]) {
            return symbolMap[symbol];
        }

        // Intentar detectar tipo de instrumento
        if (symbol.endsWith('USD') || symbol.endsWith('USDT')) {
            // Probablemente cripto
            if (symbol.endsWith('USDT')) {
                return 'BINANCE:' + symbol;
            } else {
                return 'BINANCE:' + symbol + 'T';
            }
        }

        // Si parece forex (6 caracteres)
        if (symbol.length === 6 && !symbol.includes('USD')) {
            return 'FX:' + symbol;
        }

        // Si termina con n√∫meros (√≠ndices como NAS100)
        if (/\d+$/.test(symbol)) {
            return 'NASDAQ:' + symbol;
        }

        // Default: intentar como cripto en Binance
        return 'BINANCE:' + symbol + 'USDT';
    }

function updateChartInfo(operation) {
    const precision = getInstrumentPrecision(operation.instrument);

    const elements = {
        entryPrice: document.getElementById('chart-entry-price'),
        exitPrice: document.getElementById('chart-exit-price'),
        entryTime: document.getElementById('chart-entry-time'),
        exitTime: document.getElementById('chart-exit-time'),
        pl: document.getElementById('chart-pl-display')
    };

    if (elements.entryPrice) elements.entryPrice.textContent = operation.entry ? operation.entry.toFixed(precision) : '-';
    if (elements.exitPrice) elements.exitPrice.textContent = operation.exit ? operation.exit.toFixed(precision) : '-';
    if (elements.entryTime) elements.entryTime.textContent = operation.entryTime ? `${operation.date} ${operation.entryTime}` : '-';
    if (elements.exitTime) elements.exitTime.textContent = operation.exitTime ? `${operation.date} ${operation.exitTime}` : '-';

    if (elements.pl) {
        elements.pl.textContent = formatCurrency(operation.pl, operation.currency, operation.currency);
        elements.pl.className = `ml-2 font-bold text-lg ${operation.pl >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }
}
    // Crear panel de informaci√≥n simple
    function createInfoPanel(operation) {
        const container = document.getElementById('candlestick-container');
        if (!container) return;

        // Remover panel anterior
        const existing = document.getElementById('chart-info-panel');
        if (existing) existing.remove();

        const panel = document.createElement('div');
        panel.id = 'chart-info-panel';
        panel.style.cssText = `
            position: absolute; top: 60px; right: 10px; background: rgba(17, 24, 39, 0.95);
            color: white; padding: 12px; border-radius: 8px; font-size: 13px;
            z-index: 1000; border: 1px solid #374151; min-width: 200px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

        const precision = getInstrumentPrecision(operation.instrument);
        const pl = operation.pl || 0;
        const plColor = pl >= 0 ? '#10B981' : '#EF4444';

        panel.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px; color: #F3F4F6; border-bottom: 1px solid #374151; padding-bottom: 8px;">
                üìä Detalles de la Operaci√≥n
            </div>
            <div style="margin-bottom: 8px;">
                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                    <div style="width: 10px; height: 10px; background: #10B981; border-radius: 50%; margin-right: 8px;"></div>
                    <span style="color: #10B981; font-weight: 600;">ENTRADA:</span>
                </div>
                <div style="margin-left: 18px; color: #D1D5DB;">
                    ${operation.entry ? operation.entry.toFixed(precision) : '-'}
                    ${operation.entryTime ? `<br><small style="color: #9CA3AF;">${operation.date} ${operation.entryTime}</small>` : ''}
                </div>
            </div>
            <div style="margin-bottom: 8px;">
                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                    <div style="width: 10px; height: 10px; background: #EF4444; border-radius: 50%; margin-right: 8px;"></div>
                    <span style="color: #EF4444; font-weight: 600;">SALIDA:</span>
                </div>
                <div style="margin-left: 18px; color: #D1D5DB;">
                    ${operation.exit ? operation.exit.toFixed(precision) : '-'}
                    ${operation.exitTime ? `<br><small style="color: #9CA3AF;">${operation.date} ${operation.exitTime}</small>` : ''}
                </div>
            </div>
            <div style="border-top: 1px solid #374151; padding-top: 8px; margin-top: 10px;">
                <div style="display: flex; justify-between; align-items: center;">
                    <span style="color: #F3F4F6; font-weight: 600;">P&L:</span>
                    <span style="color: ${plColor}; font-weight: bold; font-size: 14px;">
                        ${formatCurrency(pl, operation.currency, operation.currency)}
                    </span>
                </div>
            </div>
        `;

        container.appendChild(panel);
    }

    function updateChartInfo(operation) {
        const precision = getInstrumentPrecision(operation.instrument);

        const elements = {
            entryPrice: document.getElementById('chart-entry-price'),
            exitPrice: document.getElementById('chart-exit-price'),
            entryTime: document.getElementById('chart-entry-time'),
            exitTime: document.getElementById('chart-exit-time'),
            pl: document.getElementById('chart-pl-display'),
            duration: document.getElementById('chart-duration-display')
        };

        if (elements.entryPrice) elements.entryPrice.textContent = operation.entry ? operation.entry.toFixed(precision) : '-';
        if (elements.exitPrice) elements.exitPrice.textContent = operation.exit ? operation.exit.toFixed(precision) : '-';
        if (elements.entryTime) elements.entryTime.textContent = operation.entryTime ? `${operation.date} ${operation.entryTime}` : '-';
        if (elements.exitTime) elements.exitTime.textContent = operation.exitTime ? `${operation.date} ${operation.exitTime}` : '-';

        if (elements.pl) {
            elements.pl.textContent = formatCurrency(operation.pl, operation.currency, operation.currency);
            elements.pl.className = `ml-2 font-semibold ${operation.pl >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        // Calcular duraci√≥n
        let duration = '-';
        if (operation.entryTime && operation.exitTime) {
            const entry = new Date(`${operation.date}T${operation.entryTime}`);
            const exit = new Date(`${operation.date}T${operation.exitTime}`);
            const diffMinutes = Math.round((exit - entry) / (1000 * 60));
            duration = diffMinutes < 60 ? `${diffMinutes}min` : `${Math.floor(diffMinutes / 60)}h ${diffMinutes % 60}min`;
        }
        if (elements.duration) elements.duration.textContent = duration;
    }

    // Limpiar gr√°fico (llamado internamente)
    function hideTradingChart() {
        console.log('üîí Limpiando gr√°fico');

        // Limpiar widget de TradingView
        if (tradingViewWidget) {
            try {
                tradingViewWidget.remove();
                tradingViewWidget = null;
            } catch (e) {
                console.log('Widget de TradingView limpiado');
            }
        }
    }

    // Mostrar error
    function showError(message) {
        console.error('‚ùå Error:', message);
        const loading = document.getElementById('tradingview-loading-detail');
        const error = document.getElementById('chart-error-message');

        if (loading) loading.style.display = 'none';
        if (error) {
            const p = error.querySelector('p');
            if (p) p.textContent = message;
            error.style.display = 'block';
        }
    }


console.log('‚úÖ Sistema de gr√°ficos TradingView iframe listo');

// ==================== DETECTOR AUTOM√ÅTICO DE PROXY (SOLO CONSOLA) ====================
(async function checkProxyOnStartup() {
    // Detectar autom√°ticamente si estamos en producci√≥n o desarrollo
    const isProduction = window.location.hostname !== 'localhost' && 
                        window.location.hostname !== '127.0.0.1' &&
                        !window.location.hostname.includes('.local');
    
    // URL del proxy: Vercel en producci√≥n, localhost en desarrollo
    const PROXY_URL = isProduction 
        ? `${window.location.origin}/api`  // Vercel
        : (window.PROXY_URL || 'http://127.0.0.1:8003'); // Local
    
    // Guardar globalmente para que las APIs lo usen
    window.PROXY_URL = PROXY_URL;
    
    console.log(`üåç Modo: ${isProduction ? 'PRODUCCI√ìN' : 'DESARROLLO'}`);
    console.log(`üîó Proxy URL: ${PROXY_URL}`);

    try {
        const response = await fetch(`${PROXY_URL}/health`, {
            method: 'GET',
            cache: 'no-cache',
            signal: AbortSignal.timeout(5000)
        });

        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Proxy server activo:', data);
        } else {
            console.warn('‚ö†Ô∏è Proxy no disponible. Las APIs pueden no funcionar.');
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Proxy no disponible:', error.message);
        console.info('üí° Para usar las APIs, inicia el servidor con: npm start');
    }
})();

// Ejecutar correcci√≥n de IDs al cargar la p√°gina (solo una vez)
(async function initializeApp() {
    // Esperar a que la base de datos est√© lista
    await new Promise(resolve => {
        const checkDB = () => {
            if (DB && DB.operations) {
                resolve();
            } else {
                setTimeout(checkDB, 100);
            }
        };
        checkDB();
    });
    
    // Funci√≥n temporal de diagn√≥stico para verificar datos del 14/10/2025
    const debugDate = '2025-10-14';
    const existingOps = DB.operations.filter(op => op.date === debugDate);
    console.log(`[DEBUG] Operaciones existentes para ${debugDate}:`, existingOps.length);
    
    if (existingOps.length === 0) {
        console.log(`[DEBUG] No hay operaciones para ${debugDate}. Creando datos de prueba temporales...`);
        
        // Verificar si hay alguna cuenta disponible
        if (DB.accounts && DB.accounts.length > 0) {
            const testAccount = DB.accounts[0];
            
            // Crear operaciones de prueba para el 14/10/2025
            const testOperations = [
                {
                    id: `test-${debugDate}-1`,
                    accountId: testAccount.id,
                    date: debugDate,
                    entryTime: '09:00:00',
                    exitTime: '10:30:00',
                    symbol: 'BTCUSDT',
                    type: 'buy',
                    entryPrice: 65000,
                    exitPrice: 66000,
                    volume: 0.1,
                    pl: 100,
                    currency: 'USDT',
                    fees: 2.5,
                    notes: 'Operaci√≥n de prueba para diagn√≥stico'
                },
                {
                    id: `test-${debugDate}-2`,
                    accountId: testAccount.id,
                    date: debugDate,
                    entryTime: '14:00:00',
                    exitTime: '15:45:00',
                    symbol: 'ETHUSDT',
                    type: 'sell',
                    entryPrice: 2500,
                    exitPrice: 2450,
                    volume: 2,
                    pl: -100,
                    currency: 'USDT',
                    fees: 1.5,
                    notes: 'Operaci√≥n de prueba para diagn√≥stico - p√©rdida'
                }
            ];
            
            // Agregar a DB.operations
            DB.operations.push(...testOperations);
            console.log(`[DEBUG] Agregadas ${testOperations.length} operaciones de prueba para ${debugDate}`);
            console.log(`[DEBUG] Total operaciones en DB: ${DB.operations.length}`);
            
            // Tambi√©n agregar a Dexie para persistencia temporal
            if (window.dexieDB && window.dexieDB.operations) {
                try {
                    await window.dexieDB.operations.bulkAdd(testOperations);
                    console.log(`[DEBUG] Operaciones de prueba guardadas en Dexie`);
                } catch (error) {
                    console.log(`[DEBUG] Error guardando en Dexie (puede ser normal si ya existen):`, error.message);
                }
            }
        } else {
            console.log(`[DEBUG] No hay cuentas disponibles para crear operaciones de prueba`);
        }
    }
    
    // Inicializaci√≥n segura de funciones
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // Verificar que todas las funciones cr√≠ticas est√©n definidas
    const criticalFunctions = ['updateAuthStatus', 'updateLast7DaysCalendar', 'updateRecentOperationsList'];
    criticalFunctions.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
            console.warn(`‚ö†Ô∏è Funci√≥n ${funcName} no est√° definida`);
        } else {
            console.log(`‚úÖ Funci√≥n ${funcName} est√° lista`);
        }
    });

    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
})();

// ============================================
// FUNCIONES DE PANTALLA COMPLETA PARA GR√ÅFICOS
// ============================================
let fullscreenChartInstance = null;
let currentFullscreenChartData = null;

window.openFullscreenChart = function(canvasId, title) {
    console.log('Abriendo gr√°fico en pantalla completa:', canvasId);
    const sourceCanvas = document.getElementById(canvasId);
    if (!sourceCanvas) {
        console.error('Canvas no encontrado:', canvasId);
        alert('Error: No se encontr√≥ el gr√°fico');
        return;
    }

    // Obtener el Chart.js instance del canvas original
    const sourceChart = Chart.getChart(sourceCanvas);
    if (!sourceChart) {
        console.error('No hay gr√°fico en el canvas:', canvasId);
        alert('Error: El gr√°fico no est√° listo');
        return;
    }

    console.log('Gr√°fico encontrado, configuraci√≥n:', sourceChart.config);

    // Mostrar modal
    const modal = document.getElementById('fullscreen-chart-modal');
    const titleEl = document.getElementById('fullscreen-chart-title');
    const fullscreenCanvas = document.getElementById('fullscreen-chart-canvas');
    
    if (!modal || !titleEl || !fullscreenCanvas) {
        console.error('Elementos del modal no encontrados');
        alert('Error: Modal no encontrado');
        return;
    }
    
    modal.style.display = 'block';
    titleEl.textContent = title;
    
    // Destruir gr√°fico anterior si existe
    if (fullscreenChartInstance) {
        fullscreenChartInstance.destroy();
        fullscreenChartInstance = null;
    }

    // Crear configuraci√≥n para el nuevo gr√°fico
    try {
        const newConfig = {
            type: sourceChart.config.type,
            data: JSON.parse(JSON.stringify(sourceChart.data)),
            options: JSON.parse(JSON.stringify(sourceChart.options))
        };
        
        // Optimizar opciones para pantalla completa
        newConfig.options.maintainAspectRatio = false;
        newConfig.options.responsive = true;
        
        // Mejorar legibilidad en pantalla completa
        if (newConfig.options.plugins) {
            if (newConfig.options.plugins.legend) {
                newConfig.options.plugins.legend.labels = {
                    ...newConfig.options.plugins.legend.labels,
                    font: { size: 16, weight: 'bold' },
                    color: '#39FF14',
                    padding: 20
                };
            }
            if (newConfig.options.plugins.tooltip) {
                newConfig.options.plugins.tooltip.titleFont = { size: 16, weight: 'bold' };
                newConfig.options.plugins.tooltip.bodyFont = { size: 14 };
                newConfig.options.plugins.tooltip.padding = 15;
            }
        }
        
        // Aumentar tama√±o de fuentes en ejes
        if (newConfig.options.scales) {
            Object.keys(newConfig.options.scales).forEach(axisKey => {
                if (newConfig.options.scales[axisKey].ticks) {
                    newConfig.options.scales[axisKey].ticks.font = { size: 14, weight: 'bold' };
                    newConfig.options.scales[axisKey].ticks.color = '#ffffff';
                }
                if (newConfig.options.scales[axisKey].title) {
                    newConfig.options.scales[axisKey].title.font = { size: 16, weight: 'bold' };
                }
                // Mejorar l√≠neas de grid
                if (newConfig.options.scales[axisKey].grid) {
                    newConfig.options.scales[axisKey].grid.color = 'rgba(57, 255, 20, 0.1)';
                }
            });
        }
        
        console.log('Creando gr√°fico en pantalla completa...');
        
        // Esperar a que el modal se renderice completamente
        setTimeout(() => {
            const container = fullscreenCanvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Establecer dimensiones exactas del canvas
            fullscreenCanvas.width = containerWidth;
            fullscreenCanvas.height = containerHeight;
            fullscreenCanvas.style.width = containerWidth + 'px';
            fullscreenCanvas.style.height = containerHeight + 'px';
            
            fullscreenChartInstance = new Chart(fullscreenCanvas, newConfig);
            console.log('Gr√°fico en pantalla completa creado exitosamente');
        }, 200);
        
    } catch (error) {
        console.error('Error al crear el gr√°fico:', error);
        alert('Error al crear el gr√°fico: ' + error.message);
        modal.style.display = 'none';
    }
}

window.closeFullscreenChart = function() {
    const modal = document.getElementById('fullscreen-chart-modal');
    modal.style.display = 'none';
    
    if (fullscreenChartInstance) {
        fullscreenChartInstance.destroy();
        fullscreenChartInstance = null;
    }
}

// Cerrar modal con tecla ESC
if (!window.fullscreenChartEscListenerAdded) {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            window.closeFullscreenChart();
        }
    });
    window.fullscreenChartEscListenerAdded = true;
}

// ============================================
// === INTEGRACI√ìN TRADOVATE API ===
// ============================================

let tradovateAccessToken = null;
let tradovateTokenExpiry = null;

// URL del proxy para Tradovate
const TRADOVATE_PROXY_URL = 'http://127.0.0.1:8003/tradovate';

// Funci√≥n para autenticar con Tradovate
async function authenticateTradovate(username, password, mode = 'live') {
    try {
        const response = await fetch(`${TRADOVATE_PROXY_URL}/auth/accesstokenrequest?mode=${mode}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Tradovate-Mode': mode
            },
            body: JSON.stringify({
                name: username,
                password: password,
                appId: 'TraderSurvivor',
                appVersion: '1.0.0',
                deviceId: 'TraderSurvivorApp',
                cid: 1,
                sec: 'TraderSurvivorSecret'
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error de autenticaci√≥n: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        
        if (data.accessToken) {
            tradovateAccessToken = data.accessToken;
            tradovateTokenExpiry = Date.now() + (data.expirationTime || 3600) * 1000; // Default 1 hora
            
            console.log('‚úÖ Autenticaci√≥n Tradovate exitosa');
            return { success: true, token: data.accessToken };
        } else {
            throw new Error('No se recibi√≥ token de acceso');
        }
    } catch (error) {
        console.error('‚ùå Error autenticando con Tradovate:', error);
        return { success: false, error: error.message };
    }
}

// Funci√≥n para verificar si el token est√° vigente
function isTradovateTokenValid() {
    if (!tradovateAccessToken || !tradovateTokenExpiry) return false;
    return Date.now() < tradovateTokenExpiry;
}

// Funci√≥n para obtener fills (trades ejecutados) de Tradovate
async function getTradovateFills(accountId, username, password, mode = 'live', startDate = null) {
    try {
        // Autenticar si no hay token v√°lido
        if (!isTradovateTokenValid()) {
            const authResult = await authenticateTradovate(username, password, mode);
            if (!authResult.success) {
                throw new Error('Error de autenticaci√≥n: ' + authResult.error);
            }
        }
        
        // Obtener el ID num√©rico de la cuenta
        const accountResponse = await fetch(`${TRADOVATE_PROXY_URL}/account/list?mode=${mode}`, {
            headers: {
                'Authorization': `Bearer ${tradovateAccessToken}`,
                'Accept': 'application/json',
                'X-Tradovate-Mode': mode
            }
        });

        if (!accountResponse.ok) {
            throw new Error(`Error obteniendo cuentas: ${accountResponse.status}`);
        }

        const accounts = await accountResponse.json();
        const account = accounts.find(acc => acc.name === accountId || acc.id.toString() === accountId);
        
        if (!account) {
            throw new Error(`Cuenta ${accountId} no encontrada`);
        }

        // Obtener fills
        let fillsParams = `mode=${mode}&accountId=${account.id}`;
        
        // Filtrar por fecha si se proporciona
        if (startDate) {
            const startTimestamp = new Date(startDate).toISOString();
            fillsParams += `&startTimestamp=${startTimestamp}`;
        }

        const fillsResponse = await fetch(`${TRADOVATE_PROXY_URL}/fill/list?${fillsParams}`, {
            headers: {
                'Authorization': `Bearer ${tradovateAccessToken}`,
                'Accept': 'application/json',
                'X-Tradovate-Mode': mode
            }
        });

        if (!fillsResponse.ok) {
            throw new Error(`Error obteniendo fills: ${fillsResponse.status}`);
        }

        const fills = await fillsResponse.json();
        console.log(`‚úÖ ${fills.length} fills obtenidos de Tradovate`);
        
        return { success: true, fills: fills };
    } catch (error) {
        console.error('‚ùå Error obteniendo fills de Tradovate:', error);
        return { success: false, error: error.message };
    }
}

// Funci√≥n para convertir fill de Tradovate al formato de la aplicaci√≥n
function convertTradovateFillToAppFormat(fill, contractInfo, accountId) {
    // Determinar direcci√≥n (buy/sell)
    const type = fill.action === 'Buy' ? 'buy' : 'sell';
    
    // Calcular P&L (ya viene en el fill)
    const pnl = parseFloat(fill.netPrice || 0);
    const result = pnl > 0 ? 'win' : (pnl < 0 ? 'loss' : 'breakeven');

    // Convertir timestamp a fecha
    const tradeDateObj = new Date(fill.timestamp);
    const tradeDate = getLocalDateString(tradeDateObj);
    const tradeTime = tradeDateObj.toTimeString().split(' ')[0];

    return {
        id: `tradovate_${fill.id}`,
        date: tradeDate,
        accountId: accountId,
        instrument: contractInfo?.name || fill.contractId.toString(),
        type: type,
        entry: parseFloat(fill.price),
        exit: parseFloat(fill.price), // Para fills individuales
        entryTime: tradeTime,
        exitTime: tradeTime,
        volume: fill.qty,
        result: result,
        pl: pnl,
        fees: Math.abs(parseFloat(fill.commission || 0)),
        currency: 'USD', // Tradovate usa USD
        notes: `Importado de Tradovate - Fill ID: ${fill.id} - Order ID: ${fill.orderId}`,
        imageDatas: [],
        manualPL: null,
        session: 'No especificado'
    };
}

// Funci√≥n para sincronizar trades desde Tradovate
async function syncTradovateTrades(accountId) {
    try {
        // Buscar cuenta de Tradovate
        const tradovateAccount = DB.accounts.find(acc => 
            acc.platform === 'tradovate' && acc.id === accountId
        );

        if (!tradovateAccount) {
            showSyncNotification('‚ùå Cuenta de Tradovate no encontrada', 'error');
            return;
        }

        // Verificar que tenga credenciales
        if (!tradovateAccount.tradovateUsername || !tradovateAccount.tradovatePassword || !tradovateAccount.tradovateAccountId) {
            showSyncNotification('‚ùå Credenciales de Tradovate incompletas', 'error');
            return;
        }

        updateTradovateStatus('syncing', 'Sincronizando...', true);

        // Obtener fills de Tradovate
        const fillsResult = await getTradovateFills(
            tradovateAccount.tradovateAccountId,
            tradovateAccount.tradovateUsername,
            tradovateAccount.tradovatePassword,
            'live' // Por defecto usar live, puedes agregar campo para seleccionar
        );

        if (!fillsResult.success) {
            throw new Error(fillsResult.error);
        }

        const fills = fillsResult.fills || [];
        
        if (fills.length === 0) {
            updateTradovateStatus('success', 'Sin trades nuevos', false);
            showSyncNotification('‚ÑπÔ∏è No hay trades nuevos para importar', 'info');
            return;
        }

        // Convertir fills al formato de la aplicaci√≥n
        let newTrades = 0;
        let skippedTrades = 0;

        for (const fill of fills) {
            const appTrade = convertTradovateFillToAppFormat(fill, null, tradovateAccount.id);

            // Verificar si el trade ya existe
            const existingTrade = DB.operations.find(op => op.id === appTrade.id);

            if (!existingTrade) {
                // Guardar localmente
                DB.operations.push(appTrade);
                await dexieDB.operations.add(appTrade);

                // Sincronizar con Supabase si est√° conectado
                if (currentUser) {
                    await saveOperationToSupabase(appTrade);
                }

                newTrades++;
            } else {
                skippedTrades++;
            }
        }

        // Actualizar balance de la cuenta
        updateAccountBalances();
        refreshAllViews();

        // Guardar √∫ltima sincronizaci√≥n
        localStorage.setItem('tradovate-last-sync', new Date().toISOString());
        
        updateTradovateStatus('success', `${newTrades} trades importados`, false);
        showSyncNotification(
            `‚úÖ Tradovate: ${newTrades} trades importados, ${skippedTrades} ya existentes`,
            'success'
        );

        console.log(`‚úÖ Sincronizaci√≥n Tradovate completada: ${newTrades} nuevos, ${skippedTrades} duplicados`);

    } catch (error) {
        console.error('‚ùå Error sincronizando Tradovate:', error);
        updateTradovateStatus('error', 'Error: ' + error.message, false);
        showSyncNotification('‚ùå Error sincronizando Tradovate: ' + error.message, 'error');
    }
}

// Funci√≥n para actualizar el estado visual de Tradovate
function updateTradovateStatus(status, message, isLoading) {
    const statusIndicator = document.getElementById('tradovate-status-indicator');
    const lastSyncEl = document.getElementById('tradovate-last-sync');
    const progressBar = document.getElementById('tradovate-progress-bar');
    const syncButton = document.getElementById('tradovate-quick-sync');

    if (statusIndicator) {
        if (status === 'success') {
            statusIndicator.className = 'text-green';
            statusIndicator.textContent = 'Conectado';
        } else if (status === 'error') {
            statusIndicator.className = 'text-red';
            statusIndicator.textContent = 'Error';
        } else if (status === 'syncing') {
            statusIndicator.className = 'text-yellow-400';
            statusIndicator.textContent = 'Sincronizando...';
        }
    }

    if (lastSyncEl && message) {
        lastSyncEl.textContent = message;
    }

    if (progressBar) {
        if (isLoading) {
            progressBar.style.width = '100%';
            progressBar.classList.add('animate-pulse');
        } else {
            progressBar.style.width = '0%';
            progressBar.classList.remove('animate-pulse');
        }
    }

    if (syncButton) {
        syncButton.disabled = isLoading;
        if (isLoading) {
            syncButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span>Sincronizando...</span>';
        } else {
            syncButton.innerHTML = '<i class="fas fa-sync-alt text-xs"></i><span>Importar Trades</span>';
        }
    }
}

// Event listener para el bot√≥n de importar trades de Tradovate
document.addEventListener('DOMContentLoaded', function() {
    const tradovateQuickSyncBtn = document.getElementById('tradovate-quick-sync');
    
    if (tradovateQuickSyncBtn) {
        tradovateQuickSyncBtn.addEventListener('click', async function() {
            // Buscar la primera cuenta de Tradovate
            const tradovateAccount = DB.accounts.find(acc => acc.platform === 'tradovate');
            
            if (!tradovateAccount) {
                showSyncNotification('‚ùå Primero crea una cuenta de Tradovate', 'error');
                return;
            }

            await syncTradovateTrades(tradovateAccount.id);
        });
    }
});

// Sincronizaci√≥n autom√°tica de Tradovate (cada 5 minutos)
setInterval(async () => {
    const tradovateAccounts = DB.accounts.filter(acc => 
        acc.platform === 'tradovate' && acc.tradovateAutoSync === true
    );

    for (const account of tradovateAccounts) {
        console.log(`üîÑ Auto-sincronizaci√≥n Tradovate: ${account.name}`);
        await syncTradovateTrades(account.id);
    }
}, 5 * 60 * 1000); // 5 minutos

// ===== AUDICI√ìN P√öBLICA - FUNCIONES =====

// Generar link p√∫blico de audici√≥n
function generatePublicAudicionLink() {
    const modal = document.getElementById('public-link-modal');
    modal.classList.add('active');
}

// Generar el link con las opciones seleccionadas
document.getElementById('generate-public-link-btn')?.addEventListener('click', function() {
    const shareMetrics = document.getElementById('share-metrics').checked;
    const shareTrades = document.getElementById('share-trades').checked;
    const shareCharts = document.getElementById('share-charts').checked;
    const sharePersonalInfo = document.getElementById('share-personal-info').checked;

    // Exportar datos de audici√≥n
    const audicionData = {
        metrics: shareMetrics ? getAudicionMetrics() : null,
        trades: shareTrades ? getAudicionTrades() : null,
        charts: shareCharts ? getAudicionChartsData() : null,
        personalInfo: sharePersonalInfo ? getPersonalInfo() : null,
        timestamp: new Date().toISOString()
    };

    // Codificar datos en base64
    const encodedData = btoa(JSON.stringify(audicionData));
    
    // Generar URL p√∫blica
    const baseUrl = window.location.origin + window.location.pathname;
    const publicLink = `${baseUrl}?audicion=public&data=${encodedData}`;
    
    // Mostrar el link generado
    document.getElementById('generated-public-link').value = publicLink;
    document.getElementById('audicion-public-link').value = publicLink;
    
    showNotification('‚úÖ Link p√∫blico generado correctamente', 'success');
});

// Copiar link p√∫blico al portapapeles
document.getElementById('copy-public-link-btn')?.addEventListener('click', function() {
    const linkInput = document.getElementById('generated-public-link');
    linkInput.select();
    document.execCommand('copy');
    showNotification('‚úÖ Link copiado al portapapeles', 'success');
});

document.getElementById('copy-audicion-link')?.addEventListener('click', function() {
    const linkInput = document.getElementById('audicion-public-link');
    linkInput.select();
    document.execCommand('copy');
    showNotification('‚úÖ Link copiado al portapapeles', 'success');
});

// Abrir modal de link p√∫blico
document.getElementById('share-audicion-btn')?.addEventListener('click', function() {
    generatePublicAudicionLink();
});

// Cerrar modal
document.getElementById('close-public-link-modal')?.addEventListener('click', function() {
    document.getElementById('public-link-modal').classList.remove('active');
});

document.getElementById('cancel-public-link')?.addEventListener('click', function() {
    document.getElementById('public-link-modal').classList.remove('active');
});

// Obtener m√©tricas de audici√≥n
function getAudicionMetrics() {
    const operations = DB.operations || [];
    
    const totalPL = operations.reduce((sum, op) => sum + (op.pnl || 0), 0);
    const winners = operations.filter(op => op.pnl > 0).length;
    const losers = operations.filter(op => op.pnl < 0).length;
    const breakeven = operations.filter(op => op.pnl === 0).length;
    const winRate = operations.length > 0 ? (winners / operations.length * 100) : 0;
    
    const totalWinPL = operations.filter(op => op.pnl > 0).reduce((sum, op) => sum + op.pnl, 0);
    const totalLossPL = Math.abs(operations.filter(op => op.pnl < 0).reduce((sum, op) => sum + op.pnl, 0));
    const profitFactor = totalLossPL > 0 ? (totalWinPL / totalLossPL) : 0;
    
    return {
        totalPL,
        winners,
        losers,
        breakeven,
        winRate: winRate.toFixed(2),
        profitFactor: profitFactor.toFixed(2),
        totalTrades: operations.length
    };
}

// Obtener trades de audici√≥n
function getAudicionTrades() {
    return (DB.operations || []).map(op => ({
        id: op.id,
        date: op.date,
        symbol: op.symbol,
        type: op.type,
        entryPrice: op.entryPrice,
        exitPrice: op.exitPrice,
        pnl: op.pnl,
        volume: op.volume,
        result: op.pnl > 0 ? 'win' : op.pnl < 0 ? 'loss' : 'breakeven'
    }));
}

// Obtener datos de gr√°ficos
function getAudicionChartsData() {
    return {
        profitCurve: generateProfitCurveData(),
        drawdownCurve: generateDrawdownCurveData()
    };
}

// Obtener informaci√≥n personal
function getPersonalInfo() {
    return {
        email: DB.currentUser?.email || 'usuario@example.com',
        memberSince: 'Dic 2024',
        tradingSince: 'Ene 2023'
    };
}

// Generar datos de curva de profit
function generateProfitCurveData() {
    const operations = DB.operations || [];
    let cumulative = 0;
    return operations.map(op => {
        cumulative += op.pnl || 0;
        return { date: op.date, value: cumulative };
    });
}

// Generar datos de curva de drawdown
function generateDrawdownCurveData() {
    const operations = DB.operations || [];
    let peak = 0;
    let cumulative = 0;
    return operations.map(op => {
        cumulative += op.pnl || 0;
        peak = Math.max(peak, cumulative);
        const drawdown = peak - cumulative;
        return { date: op.date, value: -drawdown };
    });
}

// Detectar y cargar vista p√∫blica
window.addEventListener('DOMContentLoaded', function() {
    if (!window.IS_PUBLIC_AUDICION_VIEW) return;
    
    try {
        console.log('üìä Cargando vista p√∫blica de audici√≥n...');
        
        // Decodificar datos (primero URL decode, luego base64 decode)
        const urlDecoded = decodeURIComponent(window.PUBLIC_AUDICION_DATA);
        const decodedData = JSON.parse(atob(urlDecoded));
        console.log('‚úÖ Datos decodificados:', decodedData);
        
        // Ocultar modal de autenticaci√≥n si existe
        const authModal = document.getElementById('auth-modal');
        if (authModal) {
            authModal.style.display = 'none';
        }
        
        // Mostrar solo la secci√≥n de audici√≥n
        setTimeout(() => {
            document.querySelectorAll('.section-container').forEach(section => {
                section.style.display = 'none';
            });
            const audicionSection = document.getElementById('audicion');
            if (audicionSection) {
                audicionSection.style.display = 'block';
                audicionSection.classList.add('active');
            }
            
            // Cargar datos p√∫blicos
            if (decodedData.metrics) {
                loadPublicMetrics(decodedData.metrics);
            }
            if (decodedData.trades) {
                loadPublicTrades(decodedData.trades);
            }
            if (decodedData.personalInfo) {
                loadPublicPersonalInfo(decodedData.personalInfo);
            }
            if (decodedData.charts) {
                loadPublicCharts(decodedData.charts);
            }
            
            console.log('‚úÖ Vista p√∫blica cargada correctamente');
        }, 100);
        
    } catch (error) {
        console.error('Error cargando vista p√∫blica:', error);
    }
});

// Cargar m√©tricas p√∫blicas
function loadPublicMetrics(metrics) {
    // M√©tricas principales
    document.getElementById('audicion-pl-total').textContent = `$${(metrics.totalPL || 0).toFixed(2)}`;
    document.getElementById('audicion-total-wins').textContent = metrics.winners || 0;
    document.getElementById('audicion-total-losses').textContent = metrics.losers || 0;
    document.getElementById('audicion-win-rate').textContent = `${metrics.winRate || '0.00'}%`;
    document.getElementById('audicion-winners').textContent = metrics.winners || 0;
    document.getElementById('audicion-losers').textContent = metrics.losers || 0;
    document.getElementById('audicion-breakeven').textContent = metrics.breakeven || 0;
    document.getElementById('audicion-profit-factor').textContent = metrics.profitFactor || '0.00';
    
    // M√©tricas adicionales si existen
    const dayWinRate = document.getElementById('audicion-day-win-rate');
    if (dayWinRate && metrics.dayWinRate) {
        dayWinRate.textContent = `${metrics.dayWinRate}%`;
    }
    
    const winningDays = document.getElementById('audicion-winning-days');
    if (winningDays && metrics.winningDays !== undefined) {
        winningDays.textContent = metrics.winningDays;
    }
    
    const losingDays = document.getElementById('audicion-losing-days');
    if (losingDays && metrics.losingDays !== undefined) {
        losingDays.textContent = metrics.losingDays;
    }
    
    const pfRatio = document.getElementById('audicion-pf-ratio');
    if (pfRatio && metrics.profitFactor) {
        pfRatio.textContent = `1:${metrics.profitFactor}`;
    }
    
    const bestTrade = document.getElementById('audicion-best-trade');
    if (bestTrade && metrics.bestTrade !== undefined) {
        bestTrade.textContent = `$${metrics.bestTrade.toFixed(2)}`;
    }
    
    const worstTrade = document.getElementById('audicion-worst-trade');
    if (worstTrade && metrics.worstTrade !== undefined) {
        worstTrade.textContent = `$${metrics.worstTrade.toFixed(2)}`;
    }
    
    // Actualizar los gauges circulares si es vista p√∫blica
    if (window.IS_PUBLIC_AUDICION_VIEW) {
        initGaugeCanvases();
        updateAudicionCharts(metrics);
    }
    
    const avgTrade = document.getElementById('audicion-avg-trade');
    if (avgTrade && metrics.avgTrade !== undefined) {
        avgTrade.textContent = `$${metrics.avgTrade.toFixed(2)}`;
    }
}

// Cargar trades p√∫blicos
function loadPublicTrades(trades) {
    const tbody = document.querySelector('#audicion-latest-trades tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!trades || trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-text-secondary">No hay trades disponibles</td></tr>';
        return;
    }
    
    trades.slice(0, 10).forEach(trade => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border hover:bg-surface-light transition-colors';
        
        // Determinar resultado basado en el campo result
        const isWin = trade.result === 'win';
        const resultClass = isWin ? 'bg-primary bg-opacity-20 text-primary' : 'bg-red bg-opacity-20 text-red';
        const resultText = isWin ? 'WIN' : (trade.result === 'loss' ? 'LOSS' : 'BE');
        
        row.innerHTML = `
            <td class="py-3 px-2 text-xs">${trade.date || '-'}</td>
            <td class="py-3 px-2 font-medium">${trade.id || '-'}</td>
            <td class="py-3 px-2 text-center">
                <span class="px-2 py-1 rounded text-xs ${trade.type === 'buy' ? 'bg-primary bg-opacity-20 text-primary' : 'bg-red bg-opacity-20 text-red'}">
                    ${trade.type === 'buy' ? 'LONG' : 'SHORT'}
                </span>
            </td>
            <td class="py-3 px-2 text-center text-xs">${trade.volume || '-'}</td>
            <td class="py-3 px-2 text-center">
                <span class="px-2 py-1 rounded text-xs font-medium ${resultClass}">
                    ${resultText}
                </span>
            </td>
            <td class="py-3 px-2 text-right font-bold ${isWin ? 'text-primary' : 'text-red'}">
                ${trade.pnl ? (trade.pnl >= 0 ? '+' : '') + '$' + trade.pnl.toFixed(2) : '$0.00'}
            </td>
            <td class="py-3 px-2 text-right text-xs">-</td>
        `;
        tbody.appendChild(row);
    });
}

// Cargar informaci√≥n personal p√∫blica
function loadPublicPersonalInfo(info) {
    document.getElementById('audicion-user-email').textContent = info.email;
    document.getElementById('audicion-member-since').textContent = info.memberSince;
    document.getElementById('audicion-trading-since').textContent = info.tradingSince;
}

// Cargar gr√°ficos p√∫blicos
function loadPublicCharts(charts) {
    if (!charts) return;
    
    // Cargar curva de profit
    if (charts.profitCurve && charts.profitCurve.length > 0) {
        const profitCanvas = document.getElementById('audicion-profit-curve');
        if (profitCanvas) {
            const ctx = profitCanvas.getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (window.audicionProfitChart) {
                window.audicionProfitChart.destroy();
            }
            
            window.audicionProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: charts.profitCurve.map(d => d.date),
                    datasets: [{
                        label: 'Profit Acumulado',
                        data: charts.profitCurve.map(d => d.value),
                        borderColor: '#39ff14',
                        backgroundColor: 'rgba(57, 255, 20, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
    }
    
    // Cargar curva de drawdown
    if (charts.drawdownCurve && charts.drawdownCurve.length > 0) {
        const drawdownCanvas = document.getElementById('audicion-drawdown-curve');
        if (drawdownCanvas) {
            const ctx = drawdownCanvas.getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (window.audicionDrawdownChart) {
                window.audicionDrawdownChart.destroy();
            }
            
            window.audicionDrawdownChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: charts.drawdownCurve.map(d => d.date),
                    datasets: [{
                        label: 'Drawdown',
                        data: charts.drawdownCurve.map(d => d.value),
                        borderColor: '#ff4136',
                        backgroundColor: 'rgba(255, 65, 54, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
    }
}

// ===== FIN AUDICI√ìN P√öBLICA =====

</script>

<!-- Panel Lateral de Filtros (estilo Tradervue) -->
<div id="filters-sidebar" class="filters-sidebar">
    <div class="filters-sidebar-header">
        <h3>Filtros personalizados</h3>
        <button id="close-filters-btn" class="close-filters-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="filters-sidebar-content">
        <!-- Filtro por S√≠mbolo -->
        <div class="filter-section">
            <label class="filter-label">S√≠mbolo</label>
            <input type="text" id="sidebar-filter-symbol" class="filter-sidebar-input" placeholder="S√≠mbolo">
        </div>

        <!-- Filtro por Etiquetas (Tipo de Operaci√≥n) -->
        <div class="filter-section">
            <label class="filter-label">Etiquetas</label>
            <select id="sidebar-filter-type" class="filter-sidebar-select">
                <option value="all">Seleccionar</option>
                <option value="buy">Compra (Long)</option>
                <option value="sell">Venta (Short)</option>
            </select>
        </div>

        <!-- Filtro Lateral (Win/Loss) -->
        <div class="filter-section">
            <label class="filter-label">Lateral</label>
            <select id="sidebar-filter-result" class="filter-sidebar-select">
                <option value="all">Todo</option>
                <option value="win">Ganadores</option>
                <option value="loss">Perdedores</option>
                <option value="breakeven">Break Even</option>
            </select>
        </div>

        <!-- Filtro por Duraci√≥n -->
        <div class="filter-section">
            <label class="filter-label">Duraci√≥n</label>
            <select id="sidebar-filter-duration" class="filter-sidebar-select">
                <option value="all">Todo</option>
                <option value="scalping">Scalping (< 5 min)</option>
                <option value="intraday">Intraday (5-60 min)</option>
                <option value="swing">Swing (> 60 min)</option>
            </select>
        </div>

        <!-- Days/Time -->
        <div class="filter-section expandable">
            <div class="filter-section-header" onclick="toggleFilterSection('days-time')">
                <span class="filter-label">Days/Time</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="days-time-content" class="filter-section-content">
                <label class="filter-sublabel">D√≠a de la semana</label>
                <select id="sidebar-filter-day" class="filter-sidebar-select">
                    <option value="all">Todos</option>
                    <option value="1">Lunes</option>
                    <option value="2">Martes</option>
                    <option value="3">Mi√©rcoles</option>
                    <option value="4">Jueves</option>
                    <option value="5">Viernes</option>
                    <option value="6">S√°bado</option>
                    <option value="0">Domingo</option>
                </select>

                <label class="filter-sublabel mt-3">Sesi√≥n de Trading</label>
                <select id="sidebar-filter-session" class="filter-sidebar-select">
                    <option value="all">Todas</option>
                    <option value="asian">Asi√°tica (00:00-08:00)</option>
                    <option value="london">Londres (08:00-16:00)</option>
                    <option value="newyork">Nueva York (13:00-22:00)</option>
                </select>
            </div>
        </div>

        <!-- Price/Volume -->
        <div class="filter-section expandable">
            <div class="filter-section-header" onclick="toggleFilterSection('price-volume')">
                <span class="filter-label">Price/Volume</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="price-volume-content" class="filter-section-content">
                <label class="filter-sublabel">P/L M√≠nimo</label>
                <input type="number" id="sidebar-filter-pl-min" class="filter-sidebar-input" placeholder="Ej: -100">
                
                <label class="filter-sublabel mt-3">P/L M√°ximo</label>
                <input type="number" id="sidebar-filter-pl-max" class="filter-sidebar-input" placeholder="Ej: 500">
            </div>
        </div>

        <!-- Win/Loss Trades -->
        <div class="filter-section expandable">
            <div class="filter-section-header" onclick="toggleFilterSection('winloss-trades')">
                <span class="filter-label">Win/Loss Trades</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="winloss-trades-content" class="filter-section-content">
                <label class="filter-sublabel">Filtrar por resultado</label>
                <div class="filter-checkbox-group">
                    <label class="filter-checkbox">
                        <input type="checkbox" id="sidebar-show-wins" checked>
                        <span>Mostrar ganadores</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="sidebar-show-losses" checked>
                        <span>Mostrar perdedores</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="sidebar-show-breakeven" checked>
                        <span>Mostrar break even</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="filters-sidebar-footer">
        <button id="sidebar-apply-filters-btn" class="sidebar-apply-btn">
            <i class="fas fa-check"></i> Aplicar
        </button>
        <button id="sidebar-clear-filters-btn" class="sidebar-clear-btn">
            Limpiar
        </button>
    </div>
</div>

<!-- Overlay para cerrar el sidebar -->
<div id="filters-overlay" class="filters-overlay"></div>

<!-- Modal para ampliar gr√°ficos -->
<div id="chart-modal" class="chart-modal">
    <div class="chart-modal-content">
        <button id="chart-modal-close" class="chart-modal-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="chart-modal-body">
            <canvas id="chart-modal-canvas"></canvas>
        </div>
    </div>
</div>

<style>
    .chart-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        animation: fadeIn 0.2s;
    }

    .chart-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        background-color: #1a1a2e;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .chart-modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 50%;
        transition: background-color 0.3s;
        z-index: 1;
    }

    .chart-modal-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .chart-modal-body {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #chart-modal-canvas {
        max-width: 100%;
        max-height: 100%;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Cursor pointer para los contenedores de gr√°ficos */
    .chart-container {
        cursor: pointer;
        transition: transform 0.2s;
    }

    .chart-container:hover {
        transform: scale(1.02);
    }
</style>

<script>
    // Sistema de Modal para Gr√°ficos
    (function() {
        const modal = document.getElementById('chart-modal');
        const modalCanvas = document.getElementById('chart-modal-canvas');
        const closeBtn = document.getElementById('chart-modal-close');
        let currentModalChart = null;

        // Funci√≥n para abrir el modal con un gr√°fico
        function openChartModal(sourceCanvas) {
            if (!sourceCanvas) return;

            // Buscar la instancia de Chart.js asociada al canvas
            let chartInstance = null;
            
            // M√©todo 1: Buscar en Chart.instances (Chart.js 3.x)
            if (window.Chart && Chart.instances) {
                for (let i = 0; i < Chart.instances.length; i++) {
                    if (Chart.instances[i].canvas === sourceCanvas) {
                        chartInstance = Chart.instances[i];
                        break;
                    }
                }
            }
            
            // M√©todo 2: Buscar en la propiedad chart del canvas (si existe)
            if (!chartInstance && sourceCanvas.chart) {
                chartInstance = sourceCanvas.chart;
            }
            
            // M√©todo 3: Usar Chart.getChart() si est√° disponible (Chart.js 3.x)
            if (!chartInstance && window.Chart && Chart.getChart) {
                chartInstance = Chart.getChart(sourceCanvas);
            }

            if (!chartInstance) {
                console.warn('No se encontr√≥ instancia de gr√°fico para el canvas');
                return;
            }

            const config = chartInstance.config;

            // Crear una copia profunda del config para el modal
            const modalConfig = {
                type: config.type,
                data: JSON.parse(JSON.stringify(config.data)),
                options: JSON.parse(JSON.stringify(config.options || {}))
            };

            // Ajustar tama√±o y responsive
            if (!modalConfig.options) modalConfig.options = {};
            modalConfig.options.maintainAspectRatio = true;
            modalConfig.options.responsive = true;

            // Destruir gr√°fico anterior si existe
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }

            // Mostrar modal
            modal.classList.add('active');

            // Crear nuevo gr√°fico en el modal
            setTimeout(() => {
                const ctx = modalCanvas.getContext('2d');
                currentModalChart = new Chart(ctx, modalConfig);
            }, 100);
        }

        // Funci√≥n para cerrar el modal
        function closeChartModal() {
            modal.classList.remove('active');
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }
        }

        // Event listeners
        closeBtn.addEventListener('click', closeChartModal);
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeChartModal();
            }
        });

        // Cerrar con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeChartModal();
            }
        });

        // Agregar click listeners a todos los canvas de gr√°ficos
        function initChartClickListeners() {
            // Buscar todos los canvas que contienen gr√°ficos (id termina en 'chart' o contiene 'chart')
            const canvasElements = document.querySelectorAll('canvas[id*="chart"], canvas[id*="-gauge"]');
            
            canvasElements.forEach(canvas => {
                // Evitar duplicados
                if (canvas.hasAttribute('data-chart-modal-ready')) return;
                canvas.setAttribute('data-chart-modal-ready', 'true');
                
                // Buscar el contenedor m√°s apropiado
                let container = canvas.closest('.chart-container');
                if (!container) {
                    container = canvas.closest('.metric-card, .stat-card, .chart-box');
                }
                
                // Si no hay contenedor, usar el canvas directamente
                const clickTarget = container || canvas;
                
                if (!clickTarget.classList.contains('chart-clickable')) {
                    clickTarget.classList.add('chart-clickable');
                    clickTarget.style.cursor = 'pointer';
                    
                    clickTarget.addEventListener('click', function(e) {
                        // Evitar abrir modal si se hace clic en botones dentro del contenedor
                        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                            return;
                        }
                        // Evitar si se hace clic en inputs o selects
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.closest('input, select')) {
                            return;
                        }
                        openChartModal(canvas);
                    });
                }
            });
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChartClickListeners);
        } else {
            initChartClickListeners();
        }

        // Reinicializar cuando se cambien vistas o se creen nuevos gr√°ficos
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length) {
                    initChartClickListeners();
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Exponer funci√≥n globalmente por si se necesita llamar manualmente
        window.openChartModal = openChartModal;
    })();
</script>

<!-- NinjaTrader Integration Scripts -->
<script src="frontend/ninjatrader-csv-importer.js"></script>
<script src="frontend/ninjatrader-file-sync.js"></script>
<script src="frontend/ninjatrader-integration.js"></script>

</body>
</html>
